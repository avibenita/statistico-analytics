<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Regression Analysis - Statistico Analytics</title>
  
  <!-- Font Awesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet">
  
  <!-- Shared Styles -->
  <link rel="stylesheet" href="../../src/shared/css/taskpane-light.css">
  <link rel="stylesheet" href="../../src/shared/css/data-input-panel.css">
</head>

<body>
  <div class="taskpane-container">
    <!-- Header -->
    <div class="module-header">
      <div class="module-header-title">
        <i class="fa-solid fa-chart-line"></i>
        Regression Analysis
      </div>
      <button class="back-btn" onclick="goBack()">
        <i class="fa-solid fa-arrow-left"></i>
        Back
      </button>
    </div>
    
    <!-- Main Content -->
    <div class="taskpane-content">
      
      <!-- Saved Analyses Panel -->
      <div id="savedAnalysesContainer" style="margin-bottom: 16px;"></div>
      
      <!-- Shared Data Range Selection Component -->
      <div id="dataInputPanelContainer"></div>
      
      <!-- Regression-Specific Column Selection Component -->
      <div id="regressionInputPanelContainer"></div>
      
    </div>
  </div>
  
  <!-- Scripts -->
  <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
  
  <!-- Saved Analyses Manager -->
  <script src="../../src/shared/js/core/saved-analyses-manager.js"></script>
  
  <!-- Shared Data Input Panel -->
  <script src="../../src/shared/js/components/DataInputPanel.js"></script>
  
  <!-- Regression Input Panel Logic -->
  <script src="regression-input-panel.js"></script>
  
  <script>
    // Go back to hub
    function goBack() {
      window.location.href = '../hub.html';
    }
    
    // Initialize when Office is ready
    Office.onReady((info) => {
      if (info.host === Office.HostType.Excel) {
        console.log('Regression Analysis Module Loaded');
        
        // Load saved analyses panel HTML
        fetch('../../src/shared/components/saved-analyses-panel.html')
          .then(response => response.text())
          .then(html => {
            document.getElementById('savedAnalysesContainer').innerHTML = html;
            // Initialize saved analyses
            initSavedAnalysesPanel();
          })
          .catch(error => console.error('Error loading saved analyses panel:', error));
        
        // Load shared data input panel HTML
        fetch('../../src/shared/components/data-input-panel.html')
          .then(response => response.text())
          .then(html => {
            document.getElementById('dataInputPanelContainer').innerHTML = html;
            // Initialize the shared data input panel
            initDataInputPanel();
          })
          .catch(error => console.error('Error loading data input panel:', error));
        
        // Load regression input panel HTML
        fetch('regression-input-panel.html')
          .then(response => response.text())
          .then(html => {
            document.getElementById('regressionInputPanelContainer').innerHTML = html;
          })
          .catch(error => console.error('Error loading regression input panel:', error));
      }
    });
    
    // ====================================================================
    // SAVED ANALYSES PANEL FUNCTIONS
    // ====================================================================
    
    function toggleSavedAnalysesPanel() {
      const body = document.getElementById('savedAnalysesBody');
      const icon = document.getElementById('savedAnalysesToggleIcon');
      
      if (body.style.display === 'none') {
        body.style.display = 'block';
        icon.classList.add('open');
      } else {
        body.style.display = 'none';
        icon.classList.remove('open');
      }
    }
    
    async function initSavedAnalysesPanel() {
      try {
        await refreshSavedAnalysesList();
      } catch (error) {
        console.error('Error initializing saved analyses panel:', error);
      }
    }
    
    async function refreshSavedAnalysesList() {
      try {
        const analyses = await SavedAnalysesManager.getAnalysesByModule('regression');
        const listContainer = document.getElementById('savedAnalysesList');
        const countSpan = document.getElementById('savedCount');
        
        // Update count
        countSpan.textContent = `(${analyses.length})`;
        
        // Clear list
        listContainer.innerHTML = '';
        
        if (analyses.length === 0) {
          listContainer.innerHTML = `
            <div class="no-analyses-message">
              <i class="fa-solid fa-info-circle"></i>
              <p>No saved models yet. Run a regression and click "Save Model" to get started.</p>
            </div>
          `;
          return;
        }
        
        // Sort: starred first, then by date
        analyses.sort((a, b) => {
          if (a.starred && !b.starred) return -1;
          if (!a.starred && b.starred) return 1;
          return new Date(b.timestamp) - new Date(a.timestamp);
        });
        
        // Create cards for each analysis
        analyses.forEach(analysis => {
          const card = createAnalysisCard(analysis);
          listContainer.appendChild(card);
        });
        
      } catch (error) {
        console.error('Error refreshing saved analyses:', error);
      }
    }
    
    function createAnalysisCard(analysis) {
      const card = document.createElement('div');
      card.className = `analysis-card${analysis.starred ? ' starred' : ''}`;
      
      const timestamp = new Date(analysis.timestamp).toLocaleString('en-US', {
        month: 'short',
        day: 'numeric',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
      
      const xVars = [...(analysis.config.xn || []), ...(analysis.config.xc || [])];
      const xVarsText = xVars.length > 0 ? xVars.slice(0, 3).join(', ') + (xVars.length > 3 ? '...' : '') : 'None';
      
      card.innerHTML = `
        <div class="analysis-card-header">
          <div class="analysis-name">
            ${analysis.starred ? '<i class="fa-solid fa-star star-icon"></i>' : ''}
            ${analysis.name}
          </div>
        </div>
        
        <div class="analysis-info">
          <div><strong>Y:</strong> ${analysis.config.y || 'Not set'}</div>
          <div><strong>X:</strong> ${xVarsText}</div>
        </div>
        
        ${analysis.lastResults ? `
          <div class="analysis-stats">
            <div class="analysis-stat">
              <span class="analysis-stat-label">R¬≤</span>
              <span class="analysis-stat-value">${analysis.lastResults.rSquared.toFixed(3)}</span>
            </div>
            <div class="analysis-stat">
              <span class="analysis-stat-label">n</span>
              <span class="analysis-stat-value">${analysis.lastResults.observations}</span>
            </div>
            <div class="analysis-stat">
              <span class="analysis-stat-label">RMSE</span>
              <span class="analysis-stat-value">${analysis.lastResults.rmse.toFixed(2)}</span>
            </div>
          </div>
        ` : ''}
        
        <div class="analysis-actions">
          <button class="analysis-btn analysis-btn-load" onclick="loadSavedAnalysis('${analysis.id}')">
            <i class="fa-solid fa-folder-open"></i> Load
          </button>
          <button class="analysis-btn analysis-btn-run" onclick="runSavedAnalysis('${analysis.id}')">
            <i class="fa-solid fa-play"></i> Run
          </button>
          <button class="analysis-btn analysis-btn-delete" onclick="deleteSavedAnalysis('${analysis.id}')">
            <i class="fa-solid fa-trash"></i>
          </button>
        </div>
        
        <div class="analysis-timestamp">
          <i class="fa-solid fa-clock"></i> ${timestamp}
        </div>
      `;
      
      return card;
    }
    
    async function loadSavedAnalysis(analysisId) {
      try {
        const analysis = await SavedAnalysesManager.loadAnalysisById(analysisId);
        if (!analysis || analysis.module !== 'regression') {
          console.error('Invalid analysis');
          return;
        }
        
        console.log('üìÇ Loading saved analysis:', analysis.name);
        console.log('  Config:', analysis.config);
        
        // Save the model spec to sessionStorage so the model builder can restore it
        sessionStorage.setItem('regressionModelSpec', JSON.stringify(analysis.config));
        
        // Open the model builder with the saved configuration
        if (typeof openModelBuilder === 'function') {
          openModelBuilder();
        } else {
          console.warn('‚ö†Ô∏è openModelBuilder function not available. Model config saved to sessionStorage.');
          console.log('üí° The model builder will restore this config when opened.');
        }
        
      } catch (error) {
        console.error('Error loading analysis:', error);
      }
    }
    
    async function runSavedAnalysis(analysisId) {
      try {
        const analysis = await SavedAnalysesManager.loadAnalysisById(analysisId);
        if (!analysis || analysis.module !== 'regression') {
          console.error('Invalid analysis');
          return;
        }
        
        console.log('‚ñ∂Ô∏è Running saved analysis:', analysis.name);
        console.log('üìä Model config:', analysis.config);
        
        // Save the model spec to sessionStorage
        sessionStorage.setItem('regressionModelSpec', JSON.stringify(analysis.config));
        
        // Check if we have the data range available
        if (!regressionRangeData || regressionRangeData.length < 2) {
          console.warn('‚ö†Ô∏è No data range selected. Please select a data range first.');
          console.log('üí° Use "Load" button to open model builder and select data, then run from there.');
          return;
        }
        
        // Directly open the results dialog to run the regression
        if (typeof openRegressionCoefficientsDialog === 'function') {
          console.log('üöÄ Opening regression results dialog...');
          openRegressionCoefficientsDialog();
        } else {
          console.warn('‚ö†Ô∏è openRegressionCoefficientsDialog function not available');
          console.log('üí° Try using the "Load" button instead to open the model builder.');
        }
        
      } catch (error) {
        console.error('Error running analysis:', error);
      }
    }
    
    async function deleteSavedAnalysis(analysisId) {
      try {
        const analysis = await SavedAnalysesManager.loadAnalysisById(analysisId);
        if (!analysis) return;
        
        // Simple confirmation via console and direct delete
        // In a production app, you'd want a custom confirmation UI
        console.log(`üóëÔ∏è Deleting model: "${analysis.name}"`);
        
        await SavedAnalysesManager.deleteAnalysis(analysisId);
        console.log('‚úÖ Model deleted successfully');
        
        // Refresh the list
        await refreshSavedAnalysesList();
        
      } catch (error) {
        console.error('Error deleting analysis:', error);
      }
    }
  </script>
  
</body>
</html>
