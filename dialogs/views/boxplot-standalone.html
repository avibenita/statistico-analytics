<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Box Plot Analysis - Statistico</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <!-- Office.js -->
  <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
  
  <!-- Font Awesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet">
  
  <!-- Highcharts -->
  <script src="https://code.highcharts.com/highcharts.js"></script>
  <script src="https://code.highcharts.com/highcharts-more.js"></script>
  
  <!-- Shared Header -->
  <link rel="stylesheet" href="shared-header.css">
  <script src="shared-header.js"></script>
  
  <!-- Responsive Layout System -->
  <link rel="stylesheet" href="responsive-layout.css">
  <script src="responsive-layout.js"></script>
  
  <style>
    :root {
      --surface-0: #0c1624;
      --surface-1: #1a1f2e;
      --surface-2: #242938;
      --border: #2d3748;
      --accent-1: rgb(255,165,120);
      --accent-2: rgb(120,200,255);
      --text-primary: #ffffff;
      --text-secondary: rgba(255,255,255,0.8);
      --text-muted: rgba(255,255,255,0.6);
      --panel-radius: 10px;
      --panel-shadow: 0px 4px 20px rgba(0, 0, 0, 0.4);
    }

    /* Custom styles for box plot (responsive-layout.css handles base layout) */
    
    .results-container {
      display: none;
    }

    .results-container.show {
      display: flex !important;
      flex-direction: column;
      gap: 2px;
    }
    
    .results-container .responsive-panel-body {
      padding: 2px 6px !important;
    }
    
    .stats-panel .responsive-panel-body {
      padding: 0 6px 2px !important;
    }

    .boxplot-panel {
      flex-shrink: 0;
      padding: 0 !important;
    }
    
    .boxplot-panel .panel-heading {
      padding: 1px 8px;
      font-size: 0.65em;
      line-height: 1.2;
    }

    .panel-heading {
      background: transparent;
      color: var(--accent-1);
      font-weight: 600;
      padding: 1px 8px;
      font-size: 0.65em;
      letter-spacing: .2px;
      text-align: center;
      border-bottom: 1px solid var(--border);
      line-height: 1.2;
    }

    .chart-container {
      padding: 8px;
      height: 290px;
    }

    .stats-panel {
      flex-shrink: 0;
      margin-bottom: 2px;
      padding: 0 !important;
    }
    
    .stats-panel .panel-heading {
      padding: 3px 8px;
      font-size: 0.75em;
      margin: 0;
      line-height: 1.2;
      text-align: center;
      border-bottom: 1px solid var(--border);
    }

    .stats-panel .responsive-panel-body {
      padding: 3px 6px !important;
    }

    .stats-panel table {
      width: 100%;
      text-align: center;
      background: var(--surface-2);
      border-radius: 4px;
      overflow: hidden;
      border: 1px solid var(--border);
      margin-bottom: 3px;
      border-collapse: collapse;
    }

    .stats-panel table:last-child {
      margin-bottom: 0;
    }

    .stats-panel th {
      padding: 3px 6px;
      font-weight: 600;
      font-size: 0.65em;
      color: var(--text-primary);
      background: var(--surface-0);
      border: none;
    }

    .stats-panel th.highlight {
      background: rgba(255, 165, 120, 0.3);
    }

    .stats-panel td {
      padding: 4px 6px;
      font-size: 0.7em;
      font-weight: 500;
      color: var(--text-primary);
      border: none;
    }

    .stats-panel td.highlight {
      color: var(--accent-1);
      font-size: 0.75em;
      font-weight: 700;
      background: rgba(255, 165, 120, 0.1);
    }

    /* Loading state */
    .loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 60px 20px;
      color: var(--text-secondary);
    }

    .loading i {
      font-size: 48px;
      margin-bottom: 16px;
      color: var(--accent-2);
      animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    /* Responsive */
    @media (max-width: 900px) {
      .results-container.show {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <statistico-header view-name="Box Plot Analysis" module-name="Univariate Analysis"></statistico-header>
  
  <!-- Responsive Container -->
  <div class="responsive-container">
    
    <!-- Loading State -->
    

    <!-- RESULTS CONTAINER -->
    <div class="results-container responsive-panel" id="results-container">
      <div class="responsive-panel-body">
        
        <!-- Stats Summary - Table Style -->
        <div class="stats-panel responsive-panel flex-shrink-0">
          <div class="panel-heading">SUMMARY STATISTICS</div>
          <div class="responsive-panel-body">
            <!-- First Table: Key Stats -->
            <table>
              <tr>
                <th class="highlight">MIN</th>
                <th class="highlight">Q1 (25%)</th>
                <th class="highlight">MEDIAN (Q2)</th>
                <th class="highlight">Q3 (75%)</th>
                <th class="highlight">MAX</th>
                <th>IQR</th>
              </tr>
              <tr>
                <td class="highlight" id="stat-min">--</td>
                <td class="highlight" id="stat-q1">--</td>
                <td class="highlight" id="stat-median">--</td>
                <td class="highlight" id="stat-q3">--</td>
                <td class="highlight" id="stat-max">--</td>
                <td id="stat-iqr">--</td>
              </tr>
            </table>
            
            <!-- Second Table: Additional Stats -->
            <table>
              <tr>
                <th>COUNT</th>
                <th>MEAN</th>
                <th>STD DEV</th>
                <th>OUTLIERS</th>
                <th>VARIANCE</th>
                <th>RANGE</th>
              </tr>
              <tr>
                <td id="stat-count">--</td>
                <td id="stat-mean">--</td>
                <td id="stat-stddev">--</td>
                <td id="stat-outliers">--</td>
                <td id="stat-variance">--</td>
                <td id="stat-range">--</td>
              </tr>
            </table>
          </div>
        </div>
       

        <!-- Box Plot With Outliers -->
        <div class="boxplot-panel responsive-panel flex-shrink-0">
          <div class="panel-heading">WITH OUTLIERS</div>
          <div class="chart-container" id="boxWithOutliers"></div>
        </div>

        <!-- Box Plot Without Outliers -->
        <div class="boxplot-panel responsive-panel flex-shrink-0">
          <div class="panel-heading">WITHOUT OUTLIERS + OUTLIER POINTS</div>
          <div class="chart-container" id="boxWithoutOutliers"></div>
        </div>
        
      </div>
    </div>
    
  </div>

  <script>
    // Global variables
    let originalData = [];
    let currentVariableName = 'Variable';
    let currentSampleSize = 0;

    // Office.js initialization
    Office.initialize = function (reason) {
      console.log('‚úÖ Office.js initialized:', reason);
      
      // Listen for messages from parent
      Office.context.ui.addHandlerAsync(
        Office.EventType.DialogParentMessageReceived,
        onMessageReceived
      );
      
      // Send ready message to parent
      setTimeout(() => {
        sendMessageToParent({ status: 'ready' });
      }, 500);
      
      // For testing, load sample data if no parent
      setTimeout(() => {
        const container = document.getElementById('results-container');
        if (!container.classList.contains('show')) {
          console.log('‚è∞ No data received from parent, loading sample data...');
          loadSampleData();
        }
      }, 2000);
    };
    
    // Fallback for browser testing
    window.addEventListener('DOMContentLoaded', function() {
      console.log('üöÄ DOM Content Loaded');
      
      // Initialize shared header
      StatisticoHeader.init('boxplot', 'Variable', 0);
      console.log('‚úÖ Shared header initialized');
      
      setTimeout(() => {
        if (typeof Office === 'undefined' || !Office.context) {
          console.log('‚ö†Ô∏è Office.js not available - loading sample data for browser testing');
          loadSampleData();
        }
      }, 100);
    });

    // Handle messages from parent window
    function onMessageReceived(arg) {
      console.log('üì® Message received:', arg);
      const message = JSON.parse(arg.message);
      
      if (message.action === 'loadData') {
        handleDataReceived(message.data);
      }
    }

    // Send message to parent window
    function sendMessageToParent(message) {
      if (typeof Office !== 'undefined' && Office.context && Office.context.ui) {
        Office.context.ui.messageParent(JSON.stringify(message));
        console.log('üì§ Sent message to parent:', message);
      }
    }

    // Handle data received
    function handleDataReceived(data) {
      try {
        console.log('üìä Data received:', data);
        
        originalData = data.values || data.data || [];
        currentVariableName = data.column || data.variableName || 'Variable';
        currentSampleSize = data.n || originalData.length;
        
        console.log('‚úÖ Data loaded:', { length: originalData.length, variable: currentVariableName });
        
        // Update shared header
        StatisticoHeader.updateVariable(currentVariableName, currentSampleSize);
        
        // Calculate and display
        displayBoxPlot();
        
        // Hide loading, show results
        document.getElementById('loading').style.display = 'none';
        document.getElementById('results-container').classList.add('show');
        
      } catch (error) {
        console.error('‚ùå Error handling data:', error);
      }
    }

    // Load sample data for testing
    function loadSampleData() {
      console.log('üìä Loading sample data...');
      
      // Generate sample data (Horsepower-like)
      const sampleData = [];
      for (let i = 0; i < 369; i++) {
        const u1 = Math.random();
        const u2 = Math.random();
        const z = Math.sqrt(-2 * Math.log(u1)) * Math.cos(2 * Math.PI * u2);
        sampleData.push(201.17 + z * 60.64);
      }
      
      handleDataReceived({
        values: sampleData,
        column: 'Horsepower',
        n: sampleData.length
      });
    }

    // Calculate box plot statistics
    function calculateBoxPlotData(sortedData) {
      const n = sortedData.length;
      const min = sortedData[0];
      const max = sortedData[n - 1];
      
      const median = (sortedData[Math.floor((n - 1) / 2)] + sortedData[Math.ceil((n - 1) / 2)]) / 2;
      const q1 = (sortedData[Math.floor((n - 1) / 4)] + sortedData[Math.ceil((n - 1) / 4)]) / 2;
      const q3 = (sortedData[Math.floor((3 * (n - 1)) / 4)] + sortedData[Math.ceil((3 * (n - 1)) / 4)]) / 2;
      
      const iqr = q3 - q1;
      const lowerFence = q1 - 1.5 * iqr;
      const upperFence = q3 + 1.5 * iqr;
      
      const outliers = sortedData.filter(v => v < lowerFence || v > upperFence);
      
      const adjustedLow = sortedData.find(v => v >= lowerFence) || min;
      const adjustedHigh = [...sortedData].reverse().find(v => v <= upperFence) || max;
      
      return {
        min, max, q1, median, q3, iqr,
        lowerFence, upperFence,
        outliers,
        boxWithOutliers: [min, q1, median, q3, max],
        boxWithoutOutliers: [adjustedLow, q1, median, q3, adjustedHigh]
      };
    }

    // Display box plot
    function displayBoxPlot() {
      const sortedData = [...originalData].sort((a, b) => a - b);
      const boxData = calculateBoxPlotData(sortedData);
      
      console.log('üìà Box plot data:', boxData);
      
      // Display summary statistics
      displaySummaryStats(boxData);
      
      // Create charts
      createBoxPlotCharts(boxData);
    }

    // Display summary statistics
    function displaySummaryStats(boxData) {
      // Populate table cells
      document.getElementById('stat-min').textContent = boxData.min != null ? boxData.min.toFixed(2) : '--';
      document.getElementById('stat-q1').textContent = boxData.q1 != null ? boxData.q1.toFixed(2) : '--';
      document.getElementById('stat-median').textContent = boxData.median != null ? boxData.median.toFixed(2) : '--';
      document.getElementById('stat-q3').textContent = boxData.q3 != null ? boxData.q3.toFixed(2) : '--';
      document.getElementById('stat-max').textContent = boxData.max != null ? boxData.max.toFixed(2) : '--';
      document.getElementById('stat-iqr').textContent = boxData.iqr != null ? boxData.iqr.toFixed(2) : '--';
      
      document.getElementById('stat-count').textContent = boxData.data ? boxData.data.length : '--';
      document.getElementById('stat-mean').textContent = boxData.data ? calculateMean(boxData.data).toFixed(2) : '--';
      document.getElementById('stat-stddev').textContent = boxData.data ? calculateStdDev(boxData.data).toFixed(2) : '--';
      document.getElementById('stat-outliers').textContent = boxData.outliers ? boxData.outliers.length : '0';
      document.getElementById('stat-variance').textContent = boxData.data ? Math.pow(calculateStdDev(boxData.data), 2).toFixed(2) : '--';
      document.getElementById('stat-range').textContent = (boxData.max != null && boxData.min != null) ? (boxData.max - boxData.min).toFixed(2) : '--';
    }
    
    function calculateMean(data) {
      return data.reduce((sum, val) => sum + val, 0) / data.length;
    }
    
    function calculateStdDev(data) {
      const mean = calculateMean(data);
      const variance = data.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / data.length;
      return Math.sqrt(variance);
    }

    // Build stat label series
    function buildStatLabelSeries(boxArray, labelColor) {
      const labels = [
        { key: 'Min', y: boxArray[0], dx: 10 },
        { key: 'Q1', y: boxArray[1], dx: 10 },
        { key: 'Median', y: boxArray[2], dx: -10, align: 'right' },
        { key: 'Q3', y: boxArray[3], dx: 10 },
        { key: 'Max', y: boxArray[4], dx: 10 }
      ];
      
      return labels.map(l => ({
        x: 0,
        y: l.y,
        dataLabels: {
          enabled: true,
          formatter() { 
            return this.y != null ? `${l.key}: ${this.y.toFixed(1)}` : `${l.key}: --`;
          },
          style: { color: labelColor, fontSize: '10px', fontWeight: 600 },
          align: l.align || 'left',
          verticalAlign: 'middle',
          x: l.dx,
          y: 0,
          padding: 2,
          backgroundColor: 'rgba(0,0,0,0.6)',
          borderRadius: 3
        }
      }));
    }

    // Create box plot charts
    function createBoxPlotCharts(boxData) {
      const labelColor = '#ffa578';
      const textColor = '#ffffff';
      const gridColor = 'rgba(255,255,255,0.1)';
      
      const statLabelsWithOutliers = buildStatLabelSeries(boxData.boxWithOutliers, labelColor);
      const statLabelsWithoutOutliers = buildStatLabelSeries(boxData.boxWithoutOutliers, labelColor);
      
      const commonOptions = {
        chart: {
          type: 'boxplot',
          inverted: true,
          backgroundColor: 'transparent',
          height: 220,
          marginTop: 25,
          marginBottom: 35,
          marginLeft: 70,
          marginRight: 20,
          spacingTop: 5,
          spacingBottom: 5
        },
        title: {
          text: null
        },
        xAxis: {
          categories: [currentVariableName],
          labels: { style: { color: textColor, fontSize: '11px' } },
          gridLineColor: gridColor
        },
        yAxis: {
          labels: { style: { color: textColor, fontSize: '10px' } },
          gridLineColor: gridColor,
          title: {
            text: 'Value',
            style: { color: textColor, fontSize: '11px' }
          }
        },
        legend: { enabled: false },
        tooltip: {
          backgroundColor: 'rgba(0, 0, 0, 0.9)',
          style: { color: '#ffffff', fontSize: '11px' },
          borderColor: '#2d3748'
        },
        plotOptions: {
          boxplot: {
            dataLabels: { enabled: false },
            fillColor: 'rgba(255, 255, 255, 0.1)',
            lineWidth: 2,
            medianColor: '#ffa578',
            medianWidth: 3,
            stemColor: '#78c8ff',
            stemWidth: 1,
            whiskerColor: '#78c8ff',
            whiskerLength: '50%',
            whiskerWidth: 2
          }
        },
        credits: { enabled: false }
      };
      
      // Chart 1: With Outliers
      Highcharts.chart('boxWithOutliers', {
        ...commonOptions,
        tooltip: {
          ...commonOptions.tooltip,
          formatter: function() {
            const point = this.point;
            if (!point) return '';
            return `<b>${currentVariableName}</b><br/>` +
                   `Min: ${point.low != null ? point.low.toFixed(2) : '--'}<br/>` +
                   `Q1: ${point.q1 != null ? point.q1.toFixed(2) : '--'}<br/>` +
                   `Median: ${point.median != null ? point.median.toFixed(2) : '--'}<br/>` +
                   `Q3: ${point.q3 != null ? point.q3.toFixed(2) : '--'}<br/>` +
                   `Max: ${point.high != null ? point.high.toFixed(2) : '--'}`;
          }
        },
        series: [
          {
            name: 'Box Plot',
            data: [boxData.boxWithOutliers],
            color: '#e94560'
          },
          {
            name: 'Stats',
            type: 'scatter',
            data: statLabelsWithOutliers,
            marker: { enabled: false },
            enableMouseTracking: false,
            tooltip: { enabled: false }
          }
        ]
      });
      
      // Chart 2: Without Outliers + Outlier Points
      const outlierPoints = boxData.outliers.map(val => ({
        x: 0,
        y: val,
        marker: {
          fillColor: '#ff6b6b',
          lineColor: '#ff3838',
          lineWidth: 2,
          radius: 4
        }
      }));
      
      Highcharts.chart('boxWithoutOutliers', {
        ...commonOptions,
        legend: {
          enabled: boxData.outliers.length > 0,
          align: 'right',
          verticalAlign: 'top',
          layout: 'vertical',
          x: -10,
          y: 10,
          itemStyle: { color: textColor, fontSize: '10px' }
        },
        tooltip: {
          ...commonOptions.tooltip,
          formatter: function() {
            if (this.series.name === 'Outliers') {
              return `<b>Outlier</b><br/>Value: ${this.y != null ? this.y.toFixed(2) : '--'}`;
            }
            const point = this.point;
            if (!point) return '';
            return `<b>${currentVariableName}</b><br/>` +
                   `Adjusted Low: ${point.low != null ? point.low.toFixed(2) : '--'}<br/>` +
                   `Q1: ${point.q1 != null ? point.q1.toFixed(2) : '--'}<br/>` +
                   `Median: ${point.median != null ? point.median.toFixed(2) : '--'}<br/>` +
                   `Q3: ${point.q3 != null ? point.q3.toFixed(2) : '--'}<br/>` +
                   `Adjusted High: ${point.high != null ? point.high.toFixed(2) : '--'}`;
          }
        },
        series: [
          {
            name: 'Box Plot',
            data: [boxData.boxWithoutOutliers],
            color: '#4ea5d9'
          },
          {
            name: 'Stats',
            type: 'scatter',
            data: statLabelsWithoutOutliers,
            marker: { enabled: false },
            enableMouseTracking: false,
            tooltip: { enabled: false },
            showInLegend: false
          },
          {
            name: `Outliers (${boxData.outliers.length})`,
            type: 'scatter',
            data: outlierPoints,
            color: '#ff6b6b'
          }
        ]
      });
      
      console.log('‚úÖ Box plots created');
    }

    // Close view
    function closeView() {
      sendMessageToParent({ action: 'close' });
    }

    console.log('‚úÖ Box Plot view script loaded');
  </script>
</body>
</html>
