<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Repeated Measures Builder</title>
  <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"/>
  <style>
    body{margin:0;background:#1a0a2e;color:#e5e7eb;font-family:Segoe UI,Arial,sans-serif;}
    .wrap{padding:10px;}
    .head{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;}
    .title{font-weight:800;font-size:14px;display:flex;gap:8px;align-items:center;}
    .panel{border:1px solid #4a1d6d;background:#2d1344;border-radius:10px;padding:8px;margin-bottom:8px;}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;}
    label{font-size:12px;color:#c4b5fd;display:block;margin-bottom:4px;}
    select,input{width:100%;padding:8px;border-radius:8px;border:1px solid #6b21a8;background:#1e0d3b;color:#e5e7eb;}
    .row{display:flex;gap:8px;}
    .btn{padding:8px 12px;border-radius:8px;border:1px solid #6b21a8;background:#4c1d95;color:#e5e7eb;cursor:pointer;}
    .btn.primary{background:linear-gradient(135deg,#9333ea,#7e22ce);border-color:#7e22ce;font-weight:700;}
    .meta{font-size:12px;color:#c4b5fd;}
    .checks{max-height:210px;overflow:auto;border:2px solid #9333ea;border-radius:12px;background:#faf5ff;}
    .checks table{width:100%;border-collapse:collapse;font-size:11px;color:#1e0d3b;}
    .checks thead th{position:sticky;top:0;background:#e9d5ff;color:#581c87;padding:5px 7px;border-bottom:1px solid #d8b4fe;text-align:left;text-transform:uppercase;letter-spacing:.25px;font-weight:800;}
    .checks tbody td{padding:5px 7px;border-bottom:1px solid #e9d5ff;}
    .checks tbody tr:last-child td{border-bottom:none;}
    .checks tbody td.center{text-align:center;}
    .checks tbody tr{cursor:grab;user-select:none;}
    .checks tbody tr:hover{background:#f3e8ff;}
    .checks tbody tr.selected{background:#fae8ff;font-weight:600;}
    .checks tbody tr.disabled{opacity:0.4;cursor:not-allowed;background:#faf5ff;}
    .checks tbody tr.disabled:hover{background:#faf5ff;}
    .checks tbody tr.dragging{opacity:.45;}
    .n-num{color:#7e22ce;font-weight:700;}
    .n-str{color:#16a34a;font-weight:700;}
    .n-miss{color:#64748b;font-weight:700;}
    .drag-h{color:#9333ea;}
    .radio-group{display:flex;gap:12px;margin-bottom:8px;}
    .radio-option{flex:1;position:relative;}
    .radio-option input[type="radio"]{position:absolute;opacity:0;cursor:pointer;}
    .radio-label{display:block;padding:14px 16px;border:2px solid #6b21a8;border-radius:10px;background:#1e0d3b;color:#c4b5fd;font-size:13px;font-weight:600;text-align:center;cursor:pointer;transition:all 0.2s;}
    .radio-option input[type="radio"]:checked + .radio-label{border-color:#9333ea;background:#7e22ce;color:#fff;box-shadow:0 0 0 3px rgba(147,51,234,0.2);}
    .radio-label:hover{border-color:#a855f7;background:#6b21a8;}
    .radio-label .radio-icon{font-size:16px;margin-bottom:4px;display:block;}
    .radio-label .radio-text{font-size:12px;display:block;}
    .bucket{border:2px solid #9333ea;border-radius:12px;padding:10px;background:#faf5ff;min-height:60px;max-height:120px;overflow:auto;margin-top:8px;}
    .bucket-title{font-size:12px;color:#581c87;font-weight:700;margin-bottom:6px;}
    .bucket-items{display:flex;gap:6px;flex-wrap:wrap;}
    .bucket-pill{display:inline-flex;align-items:center;gap:6px;background:#7e22ce;color:#fae8ff;padding:4px 7px;border-radius:999px;font-size:11px;}
    .bucket-pill button{border:none;background:transparent;color:#fff;cursor:pointer;font-size:12px;}
    .hint{font-size:10px;color:#a78bfa;margin-top:4px;}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="head">
      <div class="title"><i class="fa-solid fa-repeat"></i> Repeated Measures Builder</div>
      <button class="btn" id="btnRefresh"><i class="fa-solid fa-rotate"></i> Refresh</button>
    </div>

    <div class="panel">
      <div class="meta">Range: <strong id="rangeAddr">-</strong></div>
      <div class="meta">Rows: <strong id="rowCount">0</strong> | Columns: <strong id="colCount">0</strong></div>
    </div>

    <div class="panel">
      <label>Compare</label>
      <div class="radio-group">
        <div class="radio-option">
          <input type="radio" name="dataMode" id="twoTimepoints" value="two-vars" />
          <label for="twoTimepoints" class="radio-label">
            <span class="radio-icon"><i class="fa-solid fa-arrows-left-right"></i></span>
            <span class="radio-text">2 Timepoints</span>
          </label>
        </div>
        <div class="radio-option">
          <input type="radio" name="dataMode" id="kPlusTimepoints" value="k-plus" checked />
          <label for="kPlusTimepoints" class="radio-label">
            <span class="radio-icon"><i class="fa-solid fa-timeline"></i></span>
            <span class="radio-text">3+ Timepoints</span>
          </label>
        </div>
      </div>
      <div class="grid">
        <div>
          <label>Primary framework</label>
          <select id="frameworkMode">
            <option value="parametric">Parametric (means)</option>
            <option value="nonparametric">Nonparametric (ranks)</option>
          </select>
        </div>
      </div>
    </div>

    <div class="panel">
      <label>Available timepoint variables</label>
      <div id="interestChecks" class="checks"></div>
      <div class="hint">Click timepoint variables (e.g., Time1, Time2, Time3) for within-subject comparison.</div>
      <div class="bucket">
        <div class="bucket-title">Timepoints bucket</div>
        <div id="compareBucket" class="bucket-items"></div>
      </div>
      <div class="hint" id="bucketHint">For 2 timepoints: exactly 2. For 3+ timepoints: at least 3.</div>
    </div>

    <div class="row">
      <button class="btn" id="btnCancel">Cancel</button>
      <button class="btn primary" id="btnRun">Open Repeated Measures Dashboard</button>
    </div>
  </div>

  <script>
    var STATE = { headers: [], rows: [], address: "", saved: null, selectedColumns: [], draggingCol: null };
    function qs(id){ return document.getElementById(id); }
    function send(action, data){
      if (Office && Office.context && Office.context.ui && typeof Office.context.ui.messageParent === "function") {
        Office.context.ui.messageParent(JSON.stringify({ action: action, data: data || null }));
      }
    }
    function countKinds(headers, rows){
      return headers.map(function(name, idx){
        var numeric=0,string=0,missing=0;
        rows.forEach(function(r){
          var v=r[idx];
          if(v===null||v===undefined||v===""){ missing++; return; }
          var n=Number(String(v).replace(",","."));
          if(isFinite(n)) numeric++; else string++;
        });
        return { name:name, numeric:numeric, string:string, missing:missing };
      });
    }
    function renderInterestChecks(headers){
      var host = qs("interestChecks");
      if (!host) return;
      var stats = countKinds(headers, STATE.rows || []);
      var html = '<table><thead><tr><th>Variable</th><th class="center">N Numeric</th><th class="center">N String</th><th class="center">N Missing</th><th class="center"></th></tr></thead><tbody>';
      stats.forEach(function(s){
        var isSelected = STATE.selectedColumns.indexOf(s.name) >= 0;
        var rowClass = isSelected ? ' class="disabled"' : '';
        var draggable = isSelected ? 'false' : 'true';
        html += '<tr draggable="' + draggable + '"' + rowClass + ' data-col="' + s.name + '">' +
          '<td>' + s.name + '</td>' +
          '<td class="center n-num">' + s.numeric + '</td>' +
          '<td class="center n-str">' + s.string + '</td>' +
          '<td class="center n-miss">' + s.missing + '</td>' +
          '<td class="center drag-h"><i class="fa-solid fa-grip"></i></td>' +
        '</tr>';
      });
      html += '</tbody></table>';
      host.innerHTML = html;
      host.querySelectorAll("tbody tr").forEach(function(tr){
        var col = tr.getAttribute("data-col");
        var isDisabled = tr.classList.contains("disabled");
        tr.addEventListener("click", function(e){
          if (isDisabled) return;
          var selectedRows = Array.from(host.querySelectorAll("tbody tr.selected"));
          if (selectedRows.length > 0 && !e.ctrlKey && !e.metaKey) {
            selectedRows.forEach(function(selectedTr){
              var selectedCol = selectedTr.getAttribute("data-col");
              addToBucket(selectedCol);
              selectedTr.classList.remove("selected");
            });
          } else {
            addToBucket(col);
          }
        });
      });
    }
    function addToBucket(colName){
      if (!colName) return;
      if (STATE.selectedColumns.indexOf(colName) >= 0) return;
      var mode = document.querySelector('input[name="dataMode"]:checked').value;
      var maxVars = mode === "two-vars" ? 2 : 99;
      if (STATE.selectedColumns.length >= maxVars && mode === "two-vars") {
        STATE.selectedColumns.shift();
      } else if (STATE.selectedColumns.length >= maxVars) {
        return;
      }
      STATE.selectedColumns.push(colName);
      renderBucket();
      renderInterestChecks(STATE.headers);
      validateBucket();
    }
    function removeFromBucket(colName){
      STATE.selectedColumns = STATE.selectedColumns.filter(function(c){ return c !== colName; });
      renderBucket();
      renderInterestChecks(STATE.headers);
      validateBucket();
    }
    function renderBucket(){
      var container = qs("compareBucket");
      if (!container) return;
      if (STATE.selectedColumns.length === 0) {
        container.innerHTML = '<span style="color:#a78bfa;font-size:11px;">No timepoints selected</span>';
        return;
      }
      var html = '';
      STATE.selectedColumns.forEach(function(col){
        html += '<div class="bucket-pill">' + col + ' <button onclick="removeFromBucket(\'' + col + '\')">Ã—</button></div>';
      });
      container.innerHTML = html;
    }
    function validateBucket(){
      var mode = document.querySelector('input[name="dataMode"]:checked').value;
      var count = STATE.selectedColumns.length;
      var btn = qs("btnRun");
      if (btn) {
        if (mode === "two-vars") {
          btn.disabled = count !== 2;
        } else {
          btn.disabled = count < 3;
        }
      }
    }
    function applyPayload(p){
      if (!p || !p.headers) return;
      STATE.headers = p.headers || [];
      STATE.rows = p.rows || [];
      STATE.address = p.address || "";
      STATE.saved = p.savedModelSpec || null;
      qs("rangeAddr").textContent = STATE.address || "-";
      qs("rowCount").textContent = STATE.rows.length;
      qs("colCount").textContent = STATE.headers.length;
      if (STATE.saved) {
        if (STATE.saved.compareMode) {
          var radio = qs(STATE.saved.compareMode === "k-plus" ? "kPlusTimepoints" : "twoTimepoints");
          if (radio) radio.checked = true;
        }
        if (STATE.saved.primaryFramework) {
          var fwSelect = qs("frameworkMode");
          if (fwSelect) fwSelect.value = STATE.saved.primaryFramework;
        }
        if (Array.isArray(STATE.saved.selectedColumns)) {
          STATE.selectedColumns = STATE.saved.selectedColumns.slice();
        }
      }
      renderInterestChecks(STATE.headers);
      renderBucket();
      validateBucket();
    }
    Office.onReady(function(){
      qs("btnRefresh").addEventListener("click", function(){ send("requestData"); });
      qs("btnCancel").addEventListener("click", function(){ send("close"); });
      qs("btnRun").addEventListener("click", function(){
        var mode = document.querySelector('input[name="dataMode"]:checked').value;
        var framework = qs("frameworkMode").value;
        var groupA = STATE.selectedColumns[0] || "";
        var groupB = STATE.selectedColumns[1] || "";
        send("dependentModel", {
          compareMode: mode,
          primaryFramework: framework,
          selectedColumns: STATE.selectedColumns.slice(),
          groupA: groupA,
          groupB: groupB,
          confidence: 0.95,
          hypothesis: "two-sided"
        });
      });
      document.querySelectorAll('input[name="dataMode"]').forEach(function(radio){
        radio.addEventListener("change", function(){
          validateBucket();
          renderInterestChecks(STATE.headers);
        });
      });
      send("ready");
    });
    Office.context.ui.addHandlerAsync(Office.EventType.DialogParentMessageReceived, function(arg){
      try {
        var msg = JSON.parse(arg.message || "{}");
        if (msg.type === "DEPENDENT_DATA" && msg.payload) {
          applyPayload(msg.payload);
        }
      } catch(_e){}
    });
  </script>
</body>
</html>
