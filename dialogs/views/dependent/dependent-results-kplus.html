<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dependent (Repeated Measures) Results (3+ Timepoints)</title>
  <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
  <script src="https://code.highcharts.com/highcharts.js"></script>
  <script src="https://code.highcharts.com/highcharts-more.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet"/>
  <script>
    // AI API Key configuration (Groq)
    window.AI_API_KEY = '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';
    console.log('üîë AI API Key set:', window.AI_API_KEY && window.AI_API_KEY !== 'YOUR_API_KEY_PLACEHOLDER' ? 'YES (***' + window.AI_API_KEY.slice(-4) + ')' : 'NO - Key not configured');
  </script>
  <style>
    :root{--surface-0:#0c1624;--surface-1:#1a1f2e;--surface-2:#242938;--border:#2d3748;--accent-1:rgb(255,165,120);--accent-2:rgb(120,200,255);--text-primary:#fff;--text-secondary:rgba(255,255,255,.82);--text-muted:rgba(255,255,255,.62);--panel-radius:8px;--panel-shadow:0 2px 10px rgba(0,0,0,.3);}
    html,body{height:100%;margin:0;background:var(--surface-0);color:var(--text-primary);font-family:Segoe UI,Tahoma,sans-serif;}
    .wrap{display:flex;justify-content:center;padding:4px 8px 12px;}
    .card{min-height:680px;border-radius:var(--panel-radius);box-shadow:var(--panel-shadow);border:1px solid var(--border);display:flex;flex-direction:column;}
    .hero-section{background:linear-gradient(180deg,#0a1118,#0c1620);border-bottom:1px solid rgba(255,255,255,.06);padding:10px 14px;border-radius:var(--panel-radius) var(--panel-radius) 0 0;}
    .hero-content{display:flex;justify-content:space-between;align-items:center;gap:8px;}
    .hero-title{display:flex;align-items:center;font-size:1.1rem;font-weight:800;letter-spacing:.3px;text-transform:uppercase;}
    .hero-controls{display:flex;align-items:center;gap:8px;}
    .hero-action-btn{border-radius:6px;border:1px solid rgba(148,163,184,.45);background:linear-gradient(145deg,rgba(148,163,184,.18),rgba(100,116,139,.16));color:#fff;padding:6px 12px;font-size:11px;font-weight:650;cursor:pointer;display:flex;align-items:center;gap:6px;position:relative;}
    .hero-action-btn:hover::after{content:attr(title);position:absolute;bottom:100%;left:50%;transform:translateX(-50%);margin-bottom:6px;padding:6px 10px;background:#283593;color:#fff;font-size:10px;font-weight:600;white-space:nowrap;border-radius:6px;box-shadow:0 3px 10px rgba(0,0,0,0.3);z-index:1000;pointer-events:none;}
    .hero-action-btn:hover::before{content:'';position:absolute;bottom:100%;left:50%;transform:translateX(-50%);margin-bottom:1px;border:5px solid transparent;border-top-color:#283593;z-index:1000;pointer-events:none;}
    .tab-navigation{display:flex;align-items:flex-end;gap:12px;background:transparent;padding:8px 0 0;border-bottom:1px solid rgba(255,255,255,.08);overflow-x:auto;scrollbar-width:none;margin-top:6px;}
    .tab-button{height:30px;padding:0 3px;background:transparent;border:none;color:rgba(255,255,255,.55);font-size:11px;font-weight:600;cursor:pointer;display:flex;align-items:center;gap:5px;position:relative;}
    .tab-button.active{color:#fff;font-weight:700;}
    .tab-button.active::before{content:'';position:absolute;left:0;right:0;bottom:-7px;height:2px;background:linear-gradient(90deg,var(--accent-1),var(--accent-2));}
    .tab-controls-right{margin-left:auto;display:inline-flex;align-items:center;gap:6px;padding-bottom:6px;}
    .tab-decimal-select{height:30px;padding:0 8px;border-radius:6px;border:1px solid rgba(148,163,184,.45);background:rgba(15,23,42,.82);color:#fff;font-size:11px;}
    .view-container{padding:10px 12px;}
    .tab-panel{display:none;} .tab-panel.active{display:block;}
    .stats-container{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:10px;}
    .stat-panel{background:rgba(255,255,255,.04);border:1px solid var(--border);border-radius:8px;overflow:hidden;}
    .stat-panel.secondary{opacity:0.7;transform:scale(0.95);border-color:rgba(45,55,72,0.4);}
    .stat-panel.secondary .stat-panel-heading{background:#37474f;font-size:10px;padding:6px 8px;border-bottom:1px solid rgba(255,165,120,.4);}
    .stat-panel.secondary .stat-field{padding:5px 0;}
    .stat-panel.secondary .stat-label{font-size:12px;opacity:0.85;}
    .stat-panel.secondary .stat-value{font-size:12px;padding:4px 6px;min-width:90px;opacity:0.9;}
    .stat-panel-heading{padding:7px 10px;background:#164e8d;color:#fff;font-weight:800;text-transform:uppercase;letter-spacing:.5px;border-bottom:2px solid rgba(255,165,120,.7);font-size:13px;}
    .stat-panel-heading.parametric{background:#2e5f8a;border-bottom-color:#4a90e2;}
    .stat-panel-heading.nonparametric{background:#00695c;border-bottom-color:#26a69a;}
    .stat-panel-body{padding:6px 10px;}
    .stat-field{display:grid;grid-template-columns:1fr auto;align-items:center;gap:10px;padding:6px 0;border-bottom:1px solid rgba(255,255,255,.06);}
    .stat-field:last-child{border-bottom:none;}
    .stat-label{color:var(--text-secondary);font-weight:600;font-size:12px;}
    .stat-value{font-variant-numeric:tabular-nums;color:var(--accent-2);font-weight:700;background:rgba(120,200,255,.12);border:1px solid rgba(120,200,255,.32);padding:5px 8px;border-radius:6px;min-width:90px;text-align:center;font-size:12px;}
    .table-container{margin-top:8px;overflow:auto;max-height:350px;}
    .analysis-table{width:100%;border-collapse:collapse;}
    .analysis-table th{background:#164e8d;color:#fff;padding:6px;border:1px solid rgba(255,255,255,.2);font-size:11px;}
    .analysis-table td{padding:6px;border:1px solid rgba(255,255,255,.14);color:var(--text-secondary);font-size:11px;}
    .section-note{margin-top:8px;padding:7px;border-left:3px solid var(--accent-1);background:rgba(255,165,120,.1);color:var(--text-muted);font-size:11px;}
    .framework-select{height:28px;padding:0 8px;border-radius:6px;border:1px solid rgba(148,163,184,.45);background:rgba(15,23,42,.82);color:#fff;font-size:11px;}
    .agreement-good{color:#4ade80;font-weight:700;}
    .agreement-warn{color:#fbbf24;font-weight:700;}
    .settings-bar{margin-top:6px;background:linear-gradient(135deg, #e8eaf6 0%, #c5cae9 100%);border:2px solid #5c6bc0;border-radius:0;padding:6px 8px;box-shadow:0 2px 6px rgba(92,107,192,0.15);}
    .settings-panel-title{font-size:10px;font-weight:800;text-transform:uppercase;letter-spacing:1px;color:#283593;margin-bottom:6px;padding-bottom:3px;border-bottom:2px solid #5c6bc0;}
    .settings-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:5px;}
    .settings-grid>div{display:flex;flex-direction:column;}
    .settings-grid label{font-size:10px;color:#37474f;margin-bottom:2px;font-weight:700;text-transform:uppercase;}
    .settings-grid select,.settings-grid input{width:100%;height:28px;border-radius:0;border:2px solid #5c6bc0;background:#ffffff;color:#263238;padding:0 6px;font-weight:600;font-size:11px;}
    #setPosthocWrap,#setCorrectionWrap{min-width:160px;max-width:200px;display:flex;flex-direction:column;align-items:flex-start;gap:3px;}
    #setPosthocWrap label,#setCorrectionWrap label{white-space:nowrap;line-height:1;margin-bottom:0;font-size:10px;}
    .inference-row{display:flex;align-items:center;justify-content:flex-start;gap:10px;flex-wrap:nowrap;min-width:max-content;}
    .inference-card{display:flex;align-items:center;gap:6px;flex-wrap:nowrap;justify-content:flex-start;padding:0;border:0;border-radius:0;background:transparent;min-width:max-content;}
    .inference-card#primaryTestWrap{flex:0 0 auto;min-width:180px;max-width:200px;}
    .inference-title{display:none;}
    .fw-radio-group{display:flex;border:0;border-radius:0;overflow:hidden;min-width:320px;gap:5px;}
    .fw-radio-group input{display:none;}
    .fw-radio{padding:8px 14px;color:#fff;font-size:13px;font-weight:800;cursor:pointer;user-select:none;border:3px solid transparent;box-shadow:0 2px 6px rgba(0,0,0,0.1);text-transform:uppercase;letter-spacing:0.4px;opacity:0.6;flex:1;text-align:center;position:relative;}
    .fw-radio:last-of-type{border-right:3px solid transparent;}
    .fw-radio.active{opacity:1;box-shadow:0 3px 10px rgba(0,0,0,0.3);transform:translateY(-2px);transition:all 0.2s ease;border-color:currentColor;}
    .fw-radio.active::before{content:'‚úì';position:absolute;left:6px;top:50%;transform:translateY(-50%);font-size:16px;font-weight:900;}
    .fw-radio#setFrameworkParam{background:#4a90e2;color:#fff;}
    .fw-radio#setFrameworkParam.active{background:#2e5f8a;border-color:#4a90e2;}
    .fw-radio#setFrameworkNon{background:#26a69a;color:#fff;}
    .fw-radio#setFrameworkNon.active{background:#00695c;border-color:#26a69a;}
    .primary-test-wrap{display:flex;align-items:center;gap:6px;min-width:240px;}
    .test-now{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:6px;border:1px solid rgba(16,185,129,.45);background:rgba(16,185,129,.14);color:#d1fae5;font-size:11px;font-weight:800;}
    .primary-test-wrap label{font-size:10px;color:var(--text-muted);font-weight:800;text-transform:uppercase;}
    .primary-test-wrap select{height:32px;width:100%;border-radius:0;border:3px solid transparent;background:#2e5f8a;color:#ffffff;padding:0 10px;font-weight:700;font-size:13px;box-shadow:0 2px 6px rgba(0,0,0,0.15);text-align:center;text-align-last:center;}
    .primary-test-wrap select.parametric{background:#2e5f8a;border-color:#4a90e2;color:#ffffff;box-shadow:0 3px 10px rgba(46,95,138,0.4);}
    .primary-test-wrap select.nonparametric{background:#00695c;border-color:#26a69a;color:#ffffff;box-shadow:0 3px 10px rgba(0,105,92,0.4);}
    #setPrimaryTest:disabled{appearance:none;-webkit-appearance:none;-moz-appearance:none;background-image:none !important;cursor:default;padding-right:8px !important;}
    select:disabled{appearance:none;-webkit-appearance:none;-moz-appearance:none;}
    .hbox{border:1px solid rgba(148,163,184,.38);border-radius:8px;padding:6px;background:rgba(6,16,30,.55);}
    .hbox-title{font-size:10px;color:var(--text-muted);text-transform:uppercase;font-weight:700;margin-bottom:5px;}
    .hbox-row{display:flex;align-items:center;gap:8px;flex-wrap:nowrap;color:#e5eefc;}
    .h-radio{display:inline-flex;align-items:center;gap:4px;font-size:11px;color:#263238;text-transform:none !important;white-space:nowrap;font-weight:600;}
    .h-radio input{transform:scale(0.85);}
    .hdr-row{display:flex;justify-content:flex-start;align-items:center;gap:8px;flex-wrap:nowrap;overflow-x:auto;overflow-y:hidden;padding-bottom:2px;scrollbar-width:thin;}
    #compareStatsRow{flex-wrap:wrap;overflow:visible;scrollbar-width:auto;}
    .stat-chip{display:inline-flex;align-items:center;justify-content:center;gap:3px;background:#e3f2fd;border:2px solid #1976d2;border-radius:0;padding:3px 6px;font-size:10px;color:#0d47a1;font-weight:700;min-width:190px;box-sizing:border-box;}
    .test-chip{display:inline-flex;align-items:center;background:rgba(16,185,129,.16);border:1px solid rgba(16,185,129,.55);color:#d1fae5;border-radius:6px;padding:6px 10px;font-size:11px;font-weight:700;}
    .hyp-card{border:2px solid #5c6bc0;border-radius:0;padding:6px 8px;background:#ffffff;}
    .hyp-row{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;}

.hyp-main{font-size:13px;font-weight:700;color:#283593;white-space:nowrap;min-width:200px;}
.hyp-block{display:flex;align-items:center;gap:8px;white-space:nowrap;}
.hyp-h1-label{font-size:10px;color:#37474f;font-weight:800;text-transform:uppercase;letter-spacing:.2px;margin-bottom:3px;}
.hyp-options{display:flex;align-items:center;gap:10px;white-space:nowrap;}
.hyp-delta{font-weight:800;color:#93c5fd;}
.alpha-wrap{min-width:240px;max-width:300px;}
.alpha-wrap label{font-size:10px;color:#37474f;font-weight:800;text-transform:uppercase;}
#setAlpha{height:3px;opacity:.78;accent-color:#3949ab;max-width:190px;}
/* Descriptive Stats Tab Styles */
.desc-table-wrap{max-height:240px;overflow:auto;border:1px solid var(--border);border-radius:6px;background:var(--surface-2);margin-bottom:12px;}
#desc-stats-table{width:100%;min-width:820px;border-collapse:collapse;table-layout:auto;}
#desc-stats-table th,#desc-stats-table td{padding:6px 8px;border:1px solid rgba(255,255,255,.18);box-sizing:border-box;text-align:right;font-size:10px;line-height:16px;height:30px;white-space:nowrap;}
#desc-stats-table th:first-child,#desc-stats-table td:first-child{text-align:left;min-width:120px;max-width:180px;overflow:hidden;text-overflow:ellipsis;}
#desc-stats-table thead th{background:#003366cc;color:#fff;z-index:2;cursor:pointer;}
#desc-stats-table tbody tr:nth-child(even) td{background:rgba(255,255,255,.05)}
#desc-stats-table tbody tr:hover td{background:rgba(255,221,87,.18)}
#desc-stats-table tbody tr.selected td{background:rgba(255,165,120,.3)}
#histogram-container-kplus{height:240px;margin-top:12px;}
.histogram-bar{fill:#74b9ff;stroke:#0984e3;stroke-width:1px;}
.histogram-bar:hover{fill:#0984e3;}
.normal-curve{fill:none;stroke:yellow;stroke-width:2px;stroke-dasharray:5,5;}
.axis text{fill:white;font-size:10px;}
.axis path,.axis line{stroke:#999;}
.grid line{stroke:#555;stroke-opacity:0.7;shape-rendering:crispEdges;}
.grid path{stroke-width:0;}
.desc-summary-stats{display:grid;grid-template-columns:1fr 1fr;gap:6px;padding:10px;background:rgba(255,255,255,.04);border:1px solid var(--border);border-radius:6px;font-size:11px;}
.desc-summary-stats div{display:flex;justify-content:space-between;padding:3px 0;border-bottom:1px solid rgba(255,255,255,.08);}
.desc-summary-stats div:last-child{border-bottom:none;}
.desc-summary-stats strong{color:var(--text-secondary);}
.desc-summary-stats span{color:var(--accent-2);font-weight:700;}
.modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(0,0,0,0.7);z-index:1000;backdrop-filter:blur(3px);}
.normality-button:hover{background:linear-gradient(to right,rgb(255,160,160),rgb(255,192,192));transform:translateY(-2px);}

  </style>
</head>
<body>
  <div class="wrap">
    <section class="card">
      <div class="hero-section">
        <div class="hero-content">
          <div class="hero-title"><span>Repeated Measures Module (3+ Timepoints)</span></div>
          <div class="hero-controls">
            <button class="hero-action-btn" onclick="saveCurrentModel()" title="Save model configuration to Excel workbook">
              <i class="fa-solid fa-floppy-disk"></i> Model
            </button>
            </button>
            <button class="hero-action-btn" onclick="exportHtml()" title="Export complete report as standalone HTML file">
              <i class="fa-solid fa-floppy-disk"></i> HTML
            </button>
          </div>
        </div>
        <div class="tab-navigation">
          <button class="tab-button active" data-tab="explore"><i class="fa-solid fa-chart-column"></i> Explore</button>
          <button class="tab-button" data-tab="assumptions"><i class="fa-solid fa-shield-halved"></i> Assumptions</button>
          <button class="tab-button" data-tab="results"><i class="fa-solid fa-square-poll-vertical"></i> Results</button>
          <button class="tab-button" data-tab="posthoc"><i class="fa-solid fa-table-cells"></i> Post-hoc</button>
          <button class="tab-button" data-tab="effects"><i class="fa-solid fa-wave-square"></i> Effects</button>
          <button class="tab-button" data-tab="power"><i class="fa-solid fa-bolt"></i> Power</button>
          <button class="tab-button" data-tab="report"><i class="fa-solid fa-file-lines"></i> Report</button>
          <div class="tab-controls-right">
            <label for="decimalSelect">Decimals:</label>
            <select id="decimalSelect" class="tab-decimal-select" onchange="setDecimalPrecision()">
              <option value="auto">Auto</option><option value="0">0</option><option value="1">1</option><option value="2" selected>2</option><option value="3">3</option><option value="4">4</option>
            </select>
          </div>
        </div>

        <div class="settings-bar">
  <div class="settings-panel-title">Test Configuration Panel (>2 Timepoints)</div>
  <div class="settings-grid">








    <!-- Comparison chips (no design message) -->
    <div style="grid-column:1/-1;">
      <div class="hdr-row" id="compareStatsRow"></div>
    </div>

    <!-- Inference + Test method (side by side, clearly separated) -->
    <div style="grid-column:1/-1;">
      <div class="hdr-row">
        <div class="inference-row">

          <!-- Inference Type (left) -->
          <div class="inference-card" style="flex:0 0 auto;">
            <div class="inference-title">Inference type</div>
            <div class="fw-radio-group" role="radiogroup" aria-label="Inference type">
              <input id="fwParametric" type="radio" name="frameworkMode" value="parametric" checked/>
              <label for="fwParametric" id="setFrameworkParam" class="fw-radio active">Parametric (means)</label>
              <input id="fwNonparametric" type="radio" name="frameworkMode" value="nonparametric"/>
              <label for="fwNonparametric" id="setFrameworkNon" class="fw-radio">Non-parametric (ranks)</label>
            </div>
          </div>

          <!-- Test Method (right) -->
          <div class="inference-card" id="primaryTestWrap" style="flex:1 1 auto;min-width:280px;">
            <div class="inference-title">Test method</div>
            <select id="setPrimaryTest" style="width:100%;height:42px;font-size:14px;padding:0 12px;border-radius:10px;border:1px solid rgba(120,200,255,.45);background:rgba(15,23,42,.95);color:#fff;font-weight:600;">
              <option value="rm-anova">RM-ANOVA (recommended)</option>
              <option value="friedman">Friedman test</option>
            </select>
          </div>

          <!-- Post-hoc controls (visible only for k+ groups) -->
          <div id="setPosthocWrap" style="display:none;flex:0 0 auto;">
            <label for="setPosthocMethod">Post-hoc</label>
            <select id="setPosthocMethod">
              <option value="games-howell">Games-Howell</option>
              <option value="tukey">Tukey HSD</option>
              <option value="dunn">Dunn</option>
              <option value="conover">Conover</option>
            </select>
          </div>

          <div id="setCorrectionWrap" style="display:none;flex:0 0 auto;">
            <label for="setPosthocCorrection">p Correction</label>
            <select id="setPosthocCorrection">
              <option value="holm">Holm</option>
              <option value="bh">Benjamini-Hochberg</option>
              <option value="bonferroni">Bonferroni</option>
              <option value="none">None</option>
            </select>
          </div>

        </div>
      </div>
    </div>

    <!-- (Removed from original position) -->

    <!-- Hypothesis + alpha (compact, less clutter) -->
    <div id="setHypWrap" style="grid-column:1/-1;">
      <div class="hyp-card">
        <div class="hyp-row">

          <div class="hyp-block hyp-main">
            <strong>H0:</strong> <span id="h0Text">All timepoint means equal</span>
          </div>

          <div class="hyp-block">

  <div class="hyp-h1-label">Alternative (H1)</div>

  <div class="hbox-row hyp-options" id="h1Row">
    <label class="h-radio">
      <input type="radio" name="h1Orientation" value="less"/>
      Difference &lt; 0
    </label>

    <label class="h-radio">
      <input type="radio" name="h1Orientation" value="two-sided" checked/>
      Difference ‚â† 0
    </label>

    <label class="h-radio">
      <input type="radio" name="h1Orientation" value="greater"/>
      Difference &gt; 0
    </label>
  </div>

</div>



          <div class="alpha-wrap">
            <label for="setAlpha" style="font-size:10px;opacity:0.75;">
              Significance: <span id="alphaVal">0.050</span>
            </label>
            <input id="setAlpha" type="range" min="0.001" max="0.2" step="0.001" value="0.05" style="height:3px;"/>
          </div>

        </div>
      </div>
    </div>

  </div>
</div>


        
      <div class="view-container">
        <section id="tab-explore" class="tab-panel active">
          <!-- Descriptive Statistics with integrated summary info -->
          <div class="stat-panel">
            <div class="stat-panel-heading">Descriptive Statistics</div>
            <div style="padding:6px 10px;background:rgba(255,165,120,.08);border-bottom:1px solid var(--border);display:flex;flex-wrap:wrap;gap:8px;font-size:11px;align-items:center;">
              <span style="color:var(--text-secondary);"><strong>Variables:</strong> <span id="expVarCount" style="color:var(--accent-2);font-weight:700;">...</span></span>
              <span style="color:var(--text-secondary);"><strong>Total Rows:</strong> <span id="expTotalRows" style="color:var(--accent-2);font-weight:700;">...</span></span>
              <span style="color:var(--text-secondary);"><strong>Complete Cases:</strong> <span id="expTotalN" style="color:var(--accent-2);font-weight:700;">...</span></span>
              <span style="color:var(--text-secondary);"><strong>Overall xÃÑ:</strong> <span id="expOverallMean" style="color:var(--accent-2);font-weight:700;">...</span></span>
              <span style="color:var(--text-secondary);"><strong>Framework:</strong> <span id="expFramework" style="color:var(--accent-2);font-weight:700;">...</span></span>
            </div>
            <div id="missingDataWarning" style="display:none;padding:8px 10px;background:rgba(251,191,36,.12);border-left:3px solid #fbbf24;margin:0 10px 10px;font-size:11px;">
              <strong style="color:#fbbf24;"><i class="fa-solid fa-triangle-exclamation"></i> Missing Data:</strong>
              <span style="color:var(--text-secondary);"> <span id="missingCount" style="font-weight:700;">0</span> rows (<span id="missingPct">0</span>%) excluded due to incomplete timepoint data. RM-ANOVA requires <strong>complete cases</strong> (valid data at all timepoints).</span>
            </div>
            <div class="stat-panel-body">
              <div class="desc-table-wrap">
                <table id="desc-stats-table">
                  <colgroup>
                    <col style="min-width: 140px; max-width: 200px;">
                    <col style="min-width: 70px;">
                    <col style="min-width: 90px;">
                    <col style="min-width: 90px;">
                    <col style="min-width: 90px;">
                    <col style="min-width: 90px;">
                    <col style="min-width: 90px;">
                    <col style="min-width: 80px;">
                    <col style="min-width: 80px;">
                  </colgroup>
                  <thead>
                    <tr>
                      <th data-key="Variable" style="text-align:left">Variable <i class="fa fa-sort"></i></th>
                      <th data-key="N">N <i class="fa fa-sort"></i></th>
                      <th data-key="Mean">Mean <i class="fa fa-sort"></i></th>
                      <th data-key="StdDev">StdDev <i class="fa fa-sort"></i></th>
                      <th data-key="Min">Min <i class="fa fa-sort"></i></th>
                      <th data-key="Median">Median <i class="fa fa-sort"></i></th>
                      <th data-key="Max">Max <i class="fa fa-sort"></i></th>
                      <th data-key="Skew">Skew <i class="fa fa-sort"></i></th>
                      <th data-key="Kurt">Kurt <i class="fa fa-sort"></i></th>
                    </tr>
                  </thead>
                  <tbody id="desc-stats-body"></tbody>
                </table>
              </div>
              
              <div style="display:none;" id="desc-histogram-panel">
                <div style="font-weight:700;margin:16px 0 8px;color:var(--accent-1);display:flex;justify-content:space-between;align-items:center;">
                  <span>Histogram: <span id="desc-histogram-title">Select a variable</span></span>
                  <button class="normality-button" onclick="openNormalityModal()" style="background:linear-gradient(to right, rgb(255,192,192), rgb(255,160,160));color:black;border:none;border-radius:6px;padding:8px 16px;cursor:pointer;font-weight:bold;transition:all 0.3s ease;">
                    Normality Tests
                  </button>
                </div>
                <div style="display:grid;grid-template-columns:2fr 1fr;gap:16px;">
                  <div id="histogram-container-kplus"></div>
                  <div>
                    <div class="desc-summary-stats" id="desc-summary-table"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>
        <section id="tab-assumptions" class="tab-panel">
          <div class="stat-panel">
            <div class="stat-panel-heading">Assumption Testing</div>
            <div class="stat-panel-body" style="padding:12px;">
              
              <!-- Design Balance Indicator -->
              <div id="designBalanceInfo" style="margin-bottom:16px;padding:8px 12px;background:rgba(120,200,255,.08);border-left:3px solid var(--accent-2);border-radius:4px;">
                <span style="font-size:12px;color:var(--text-secondary);"><strong>Design:</strong> <span id="balanceText">...</span></span>
              </div>
              
              <!-- Sphericity -->
              <div style="margin-bottom:20px;">
                <h4 style="color:var(--accent-1);margin:0 0 8px 0;font-size:13px;font-weight:700;">1. Sphericity (Mauchly's Test)</h4>
                <p style="margin:0 0 8px 0;color:var(--text-secondary);font-size:12px;line-height:1.5;">
                  <strong>Assumption:</strong> Variances of differences between all pairs of timepoints should be equal.<br/>
                  <strong>H‚ÇÄ:</strong> Sphericity assumption is met &nbsp;|&nbsp; <strong>H‚ÇÅ:</strong> Sphericity is violated
                </p>
                <div style="display:flex;align-items:center;gap:12px;margin-bottom:6px;">
                  <span style="font-size:12px;color:var(--text-muted);">Mauchly's W:</span>
                  <span class="stat-value" id="asMauchlyW" style="min-width:80px;">...</span>
                  <span style="font-size:12px;color:var(--text-muted);">p-value:</span>
                  <span class="stat-value" id="asMauchlyP" style="min-width:80px;">...</span>
                  <span id="asMauchlyVerdict" style="font-size:12px;font-weight:600;"></span>
                </div>
                <div style="margin-top:12px;padding:10px;background:#f8f9fa;border-radius:6px;">
                  <div style="font-size:12px;color:var(--text-secondary);margin-bottom:4px;"><strong>Corrections (if violated):</strong></div>
                  <div style="display:flex;gap:20px;font-size:12px;">
                    <div>
                      <span style="color:var(--text-muted);">Greenhouse-Geisser Œµ:</span>
                      <span class="stat-value" id="asEpsilonGG" style="margin-left:6px;">...</span>
                    </div>
                    <div>
                      <span style="color:var(--text-muted);">Huynh-Feldt Œµ:</span>
                      <span class="stat-value" id="asEpsilonHF" style="margin-left:6px;">...</span>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Design Balance (Optional) -->
              <div style="margin-bottom:20px;">
                <h4 style="color:var(--accent-1);margin:0 0 8px 0;font-size:13px;font-weight:700;">2. Missing Data</h4>
                <p style="margin:0 0 8px 0;color:var(--text-secondary);font-size:12px;line-height:1.5;">
                  Repeated measures ANOVA uses <strong>listwise deletion</strong>. Only subjects with complete data across all timepoints are included.
                </p>
                <div style="display:flex;align-items:center;gap:12px;">
                  <span style="font-size:12px;color:var(--text-muted);">Complete cases:</span>
                  <span class="stat-value" id="asCompleteCases">...</span>
                </div>
              </div>

              <!-- Final Recommendation -->
              <div style="background:rgba(255,165,120,.08);border-left:4px solid var(--accent-1);padding:12px;border-radius:6px;">
                <h4 style="color:var(--accent-1);margin:0 0 8px 0;font-size:13px;font-weight:700;">üìã Recommendation & Conclusion</h4>
                <p id="asRecoText" style="margin:0;color:var(--text-primary);font-size:12px;line-height:1.6;font-weight:600;"></p>
              </div>

            </div>
          </div>
        </section>
        <section id="tab-results" class="tab-panel">
          <div class="stat-panel">
            <div class="stat-panel-heading">dependent Measures ANOVA</div>
            <div class="stat-panel-body" style="padding:10px;">
              <div class="table-container" style="margin:0;max-height:none;">
                <table class="analysis-table">
                  <thead>
                    <tr><th>Source</th><th>SS</th><th>df</th><th>MS</th><th>F</th><th>p-value</th></tr>
                  </thead>
                  <tbody id="anovaSummaryBody">
                    <tr><td>Treatments</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td></tr>
                    <tr><td>Within groups</td><td>...</td><td>...</td><td>...</td><td></td><td></td></tr>
                    <tr><td>Total</td><td>...</td><td>...</td><td></td><td></td><td></td></tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <div class="stats-container" style="margin-top:12px;">
            <div class="stat-panel">
              <div class="stat-panel-heading">
                Timepoint Visualization
                <div style="float:right;display:inline-flex;gap:12px;font-size:11px;font-weight:600;">
                  <label style="display:inline-flex;align-items:center;gap:4px;cursor:pointer;">
                    <input type="radio" name="chartMetric" value="means" checked onchange="updateGroupChart()"> Means
                  </label>
                  <label style="display:inline-flex;align-items:center;gap:4px;cursor:pointer;">
                    <input type="radio" name="chartMetric" value="variances" onchange="updateGroupChart()"> Variances
                  </label>
                </div>
              </div>
              <div class="stat-panel-body" style="padding:8px;">
                <div id="groupChartContainer" style="width:100%;height:280px;"></div>
              </div>
            </div>
            <div class="stat-panel secondary">
              <div class="stat-panel-heading">Robustness Test of Equality of Means</div>
              <div class="stat-panel-body">
                <div class="table-container" style="margin:0;max-height:none;">
                  <table class="analysis-table">
                    <thead>
                      <tr><th>Equality of Variance Test</th><th>F Statistic</th><th>df1</th><th>df2</th><th>p-value</th></tr>
                    </thead>
                    <tbody id="varianceTestBody">
                      <tr><td>Levene test</td><td>...</td><td>...</td><td>...</td><td>...</td></tr>
                      <tr><td>Brown-Forsythe</td><td>...</td><td>...</td><td>...</td><td>...</td></tr>
                    </tbody>
                  </table>
                </div>
                <div class="table-container" style="margin-top:10px;max-height:none;">
                  <table class="analysis-table">
                    <thead>
                      <tr><th>Welch ANOVA</th><th>df1</th><th>df2</th><th>F Statistic</th><th>p-value</th></tr>
                    </thead>
                    <tbody id="welchAnovaBody">
                      <tr><td>Welch</td><td>...</td><td>...</td><td>...</td><td>...</td></tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- ===== POST-HOC TAB ===== -->
        <section id="tab-posthoc" class="tab-panel">
          <div class="stat-panel">
            <div class="stat-panel-heading parametric" id="posthocHeading">
              Post-hoc Pairwise Comparisons (Paired t-tests)
              <div style="float:right;display:inline-flex;gap:8px;align-items:center;font-size:11px;font-weight:600;text-transform:none;">
                <span style="opacity:0.8;">Filter:</span>
                <label style="display:inline-flex;align-items:center;gap:4px;cursor:pointer;">
                  <input type="radio" name="posthocGrouping" value="all" checked onchange="updatePosthocDisplay()"> All pairs
                </label>
                <label style="display:inline-flex;align-items:center;gap:4px;cursor:pointer;">
                  <input type="radio" name="posthocGrouping" value="ref" onchange="updatePosthocDisplay()"> vs Reference
                </label>
                <select id="posthocRefGroup" style="height:24px;padding:0 6px;border-radius:4px;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);color:#fff;font-size:11px;display:none;" onchange="updatePosthocDisplay()">
                  <option value="">Select timepoint...</option>
                </select>
              </div>
            </div>
            <div class="stat-panel-body" style="padding:8px;">
              <!-- Omnibus Warning -->
              <div id="posthocWarning" style="display:none;padding:8px 12px;margin-bottom:12px;background:rgba(251,191,36,.15);border-left:3px solid #fbbf24;border-radius:4px;">
                <span style="font-size:12px;color:#fbbf24;font-weight:600;">‚ö† Omnibus test not significant (p > Œ±). Interpret post-hoc comparisons with caution.</span>
              </div>
              
              <div class="table-container" style="margin:0;">
                <table class="analysis-table" id="posthocTable">
                  <thead>
                    <tr>
                      <th style="cursor:pointer;" onclick="sortPosthocTable('comparison')">Comparison ‚Üï</th>
                      <th style="cursor:pointer;" onclick="sortPosthocTable('statistic')">Statistic ‚Üï</th>
                      <th style="cursor:pointer;" onclick="sortPosthocTable('rawp')">Raw p ‚Üï</th>
                      <th style="cursor:pointer;" onclick="sortPosthocTable('adjp')">Adj p ‚Üï</th>
                      <th style="cursor:pointer;" onclick="sortPosthocTable('estimate')">Estimate ‚Üï</th>
                      <th style="cursor:pointer;" onclick="sortPosthocTable('ci')">95% CI ‚Üï</th>
                      <th style="text-align:center;">Sig</th>
                    </tr>
                  </thead>
                  <tbody id="posthocBody">
                    <tr><td colspan="7">No post-hoc comparisons available</td></tr>
                  </tbody>
                </table>
              </div>
              
              <div style="margin-top:12px;padding:8px;background:rgba(120,200,255,.08);border-radius:4px;font-size:11px;color:var(--text-secondary);">
                <strong>Note:</strong> <span id="posthocMethodNote">...</span>
              </div>
            </div>
          </div>
        </section>

        <section id="tab-effects" class="tab-panel">
          <div class="stats-container"><div class="stat-panel"><div class="stat-panel-heading">Effect Sizes</div><div class="stat-panel-body">
            <div class="stat-field"><span class="stat-label">Eta squared</span><span class="stat-value" id="efEta">...</span></div>
            <div class="stat-field"><span class="stat-label">Cohen's f</span><span class="stat-value" id="efCohenF">...</span></div>
            <div class="stat-field"><span class="stat-label">ANOVA F</span><span class="stat-value" id="efAnovaF">...</span></div>
            <div class="stat-field"><span class="stat-label">Kruskal H</span><span class="stat-value" id="efKwH">...</span></div>
          </div></div></div>
        </section>
        <section id="tab-power" class="tab-panel">
          <div class="stats-container"><div class="stat-panel"><div class="stat-panel-heading">Power & Sample Size (Python)</div><div class="stat-panel-body">
            <div class="stat-field"><span class="stat-label">Status</span><span class="stat-value" id="powNote">...</span></div>
            <div class="stat-field"><span class="stat-label">Endpoint</span><span class="stat-value" id="powEndpoint">...</span></div>
            <div class="stat-field"><span class="stat-label">Placeholder Power</span><span class="stat-value" id="powVal">...</span></div>
          </div></div></div>
          <div class="section-note">Power is designed to call a Python service endpoint with exact/simulation routines.</div>
        </section>
        <section id="tab-report" class="tab-panel">
          <div class="stat-panel">
            <div class="stat-panel-heading">Parametric vs Nonparametric Summary</div>
            <div class="stat-panel-body" style="padding:0;">
              <div class="table-container" style="margin:0;max-height:none;">
                <table class="analysis-table">
                  <thead><tr><th>Parametric</th><th>Nonparametric</th></tr></thead>
                  <tbody id="methodComparisonBodyReport">
                    <tr><td>ANOVA F: ...</td><td>Kruskal H: ...</td></tr>
                    <tr><td>Means: ...</td><td>Mean ranks: ...</td></tr>
                    <tr><td>Œ∑¬≤ / œâ¬≤: ... / ...</td><td>Œµ¬≤ / Œ∑¬≤(H): ... / ...</td></tr>
                    <tr><td>Post-hoc: Tukey / Games-Howell</td><td>Post-hoc: Dunn / Conover</td></tr>
                    <tr><td>Levene p: ...</td><td>Tie/normality info: rank-based robust</td></tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <div class="stat-panel" style="margin-top:12px;">
            <div class="stat-panel-heading">APA-ready Report</div>
            <div class="stat-panel-body">
              <div id="repAnova"></div><br/><div id="repKw"></div><br/><div id="repCons"></div>
            </div>
          </div>
        </section>
      </div>
    </section>
  </div>
  
  <!-- Normality Tests Modal -->
  <div class="modal-overlay" id="normality-modal" style="display:none;">
    <div class="modal-content" style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:90%;max-width:900px;max-height:90vh;background-color:var(--surface-1);border-radius:10px;box-shadow:0 4px 20px rgba(0,0,0,.4);border:1px solid var(--border);overflow-y:auto;">
      <div class="modal-header" style="background-color:var(--surface-0);padding:15px 20px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;">
        <div class="modal-title" style="color:var(--accent-1);font-size:1.2rem;font-weight:600;">
          Normality Tests - <span id="modal-variable-name">Variable</span> <span id="modal-sample-size">(n=‚Äî)</span>
        </div>
        <button class="close-btn" onclick="closeNormalityModal()" style="background:none;border:none;color:var(--text-secondary);font-size:1.5rem;cursor:pointer;padding:0;width:30px;height:30px;display:flex;align-items:center;justify-content:center;">&times;</button>
      </div>
      <div class="modal-body" style="padding:20px;">
        <div style="text-align:center;padding:10px;font-size:14px;font-weight:bold;">
          Normality testing placeholder (can be wired to Python service if needed)
        </div>
        <div style="padding:20px;background:rgba(255,165,120,.1);border-left:3px solid var(--accent-1);margin-top:10px;">
          <strong>Selected Variable:</strong> <span id="modal-variable-detail">‚Äî</span><br/>
          <strong>Sample Size:</strong> <span id="modal-n-detail">‚Äî</span><br/>
          <strong>Mean:</strong> <span id="modal-mean-detail">‚Äî</span><br/>
          <strong>StdDev:</strong> <span id="modal-sd-detail">‚Äî</span>
        </div>
      </div>
    </div>
  </div>
  
  <script>
    let globalDecimalPrecision = "auto";
    let lastBundle = null;
    let primaryFramework = "parametric";
    let availableHeaders = [];
    let currentCompareMode = "k-plus";
    let currentHypothesis = "two-sided";
    let currentPrimaryTest = "welch";
    let persistedColumns = { groupA: "", groupB: "", valueColumn: "", groupColumn: "" };
    function parseMaybeNumber(v){ if(v===undefined||v===null) return NaN; const n=Number(String(v).replace(",",".")); return isFinite(n)?n:NaN; }
    function fmt(v){ const n=parseMaybeNumber(v); if(!isFinite(n)) return v==null?"...":String(v); if(globalDecimalPrecision==="auto"){ if(Math.abs(n)<1&&n!==0) return n.toFixed(4); return n.toFixed(2);} return n.toFixed(parseInt(globalDecimalPrecision,10)); }
    function fmtP(v){ const n=parseMaybeNumber(v); if(!isFinite(n)) return v==null?"...":String(v); if(n < 0.001) return "< 0.001"; return globalDecimalPrecision === "auto" ? n.toFixed(4) : n.toFixed(Math.max(3, parseInt(globalDecimalPrecision,10))); }
    function setDecimalPrecision(){ globalDecimalPrecision=(document.getElementById("decimalSelect")||{value:"auto"}).value; if(lastBundle) populateBundle(lastBundle); }
    function setText(id,val){ const el=document.getElementById(id); if(el) el.textContent = (val!==undefined&&val!==null&&val!=="")?val:"..."; }
    let activeTab = "explore";
    function switchTab(tab){
      if (!tab || tab === activeTab) return;
      const prevBtn = document.querySelector('.tab-button[data-tab="' + activeTab + '"]');
      const nextBtn = document.querySelector('.tab-button[data-tab="' + tab + '"]');
      const prevPanel = document.getElementById("tab-" + activeTab);
      const nextPanel = document.getElementById("tab-" + tab);
      if (prevBtn) prevBtn.classList.remove("active");
      if (nextBtn) nextBtn.classList.add("active");
      if (prevPanel) prevPanel.classList.remove("active");
      if (nextPanel) nextPanel.classList.add("active");
      activeTab = tab;
    }
    function sendToHost(cmd,data){ if(Office&&Office.context&&Office.context.ui&&Office.context.ui.messageParent) Office.context.ui.messageParent(JSON.stringify({action:"HOST_EVENT",cmd:cmd,data:data||{}})); }
    function fillSelect(id, options, selected){
      const el = document.getElementById(id);
      if (!el) return;
      el.innerHTML = (options || []).map(function(v){ return '<option value="' + v + '">' + v + '</option>'; }).join("");
      if (selected !== undefined && selected !== null && String(selected) !== "") el.value = String(selected);
    }
    function currentSettingsSpec(){
      var hChecked = document.querySelector('input[name="h1Orientation"]:checked');
      var h = hChecked ? hChecked.value : "two-sided";
      currentHypothesis = h;
      var alpha = Number((document.getElementById("setAlpha") || { value: "0.05" }).value || 0.05);
      if (!isFinite(alpha) || alpha <= 0 || alpha >= 1) alpha = 0.05;
      return {
        compareMode: currentCompareMode,
        primaryFramework: primaryFramework,
        hypothesis: h,
        confidence: 1 - alpha,
        groupA: persistedColumns.groupA || "",
        groupB: persistedColumns.groupB || "",
        valueColumn: persistedColumns.valueColumn || "",
        groupColumn: persistedColumns.groupColumn || "",
        primaryTest: (document.getElementById("setPrimaryTest") || {}).value || currentPrimaryTest || "welch",
        posthocMethod: (document.getElementById("setPosthocMethod") || {}).value || "games-howell",
        posthocCorrection: (document.getElementById("setPosthocCorrection") || {}).value || "holm"
      };
    }
    function refreshHypothesisFrames(){
      var h0 = document.getElementById("h0Text");
      var h1Row = document.getElementById("h1Row");
      if (!h0 || !h1Row) return;
      h0.textContent = "All timepoint means equal";
      h1Row.innerHTML = '<span style="color:#1f2937;font-weight:800;">At least one timepoint differs.</span>';
    }
    function refreshSettingsVisibility(){
      const setDisplay = (id, show) => { const el = document.getElementById(id); if (el) el.style.display = show ? "flex" : "none"; };
      setDisplay("setPosthocWrap", true); setDisplay("setCorrectionWrap", true);
      setDisplay("setHypWrap", true);
      refreshHypothesisFrames();
    }
    function updatePosthocOptions(){
      var sel = document.getElementById("setPosthocMethod");
      if (!sel) return;
      var isNonParam = primaryFramework === "nonparametric" || currentPrimaryTest === "kruskal";
      var options = isNonParam
        ? [
            { v: "dunn", t: "Dunn" },
            { v: "conover", t: "Conover" }
          ]
        : [
            { v: "games-howell", t: "Games-Howell" },
            { v: "tukey", t: "Tukey HSD" }
          ];
      var current = sel.value;
      sel.innerHTML = options.map(function(o){ return '<option value="' + o.v + '">' + o.t + '</option>'; }).join("");
      var keep = options.some(function(o){ return o.v === current; });
      sel.value = keep ? current : options[0].v;
    }
    function setFrameworkButtons(mode){
      primaryFramework = mode === "nonparametric" ? "nonparametric" : "parametric";
      var p = document.getElementById("setFrameworkParam");
      var n = document.getElementById("setFrameworkNon");
      if (p) p.classList.toggle("active", primaryFramework === "parametric");
      if (n) n.classList.toggle("active", primaryFramework === "nonparametric");
      var rp = document.getElementById("fwParametric");
      var rn = document.getElementById("fwNonparametric");
      if (rp) rp.checked = primaryFramework === "parametric";
      if (rn) rn.checked = primaryFramework === "nonparametric";
      var primaryTestWrap = document.getElementById("primaryTestWrap");
      if (primaryTestWrap) primaryTestWrap.style.display = "flex";
      var testSel = document.getElementById("setPrimaryTest");
      if (testSel) testSel.className = primaryFramework === "nonparametric" ? "nonparametric" : "parametric";
      document.querySelectorAll(".stat-panel-heading").forEach(function(h){
        h.classList.remove("parametric", "nonparametric");
        h.classList.add(primaryFramework);
      });
      if (testSel) {
        var options = primaryFramework === "nonparametric"
          ? [{ v: "friedman", t: "Friedman test" }]
          : [{ v: "rm-anova", t: "Repeated Measures ANOVA" }];
        testSel.innerHTML = options.map(function(o){ return '<option value="' + o.v + '">' + o.t + '</option>'; }).join("");
        currentPrimaryTest = options[0].v;
        testSel.value = currentPrimaryTest;
        testSel.disabled = true;
      }
      updatePosthocOptions();
      refreshHypothesisFrames();
    }
    function notifySettingsChanged(){
      const spec = currentSettingsSpec();
      refreshSettingsVisibility();
      var alphaVal = document.getElementById("alphaVal");
      if (alphaVal) alphaVal.textContent = (1 - (spec.confidence || 0.95)).toFixed(3);
      sendToHost("dependentSettingsChanged", spec);
    }
    function renderCompareStatsRow(s, e){
      var host = document.getElementById("compareStatsRow");
      var msgHost = document.getElementById("designMessageRow");
      if (!host) return;
      host.innerHTML = "";
      if (msgHost) { msgHost.textContent = ""; msgHost.style.display = "none"; }
      var ksum = e.kplusSummary || {};
      var ob = (lastBundle && lastBundle.results && lastBundle.results.omnibus) ? lastBundle.results.omnibus : {};
      
      var groupDescriptives = Array.isArray(ob.groupDescriptives) ? ob.groupDescriptives.filter(function(cs){
        return isFinite(parseMaybeNumber(cs && cs.n)) && parseMaybeNumber(cs.n) > 0;
      }).slice(0, 8) : [];
      if (groupDescriptives.length) {
        groupDescriptives.forEach(function(cs){
          var n = parseMaybeNumber(cs.n);
          var m = parseMaybeNumber(cs.mean);
          var chip = document.createElement("span");
          chip.className = "stat-chip";
          chip.textContent = (cs.name || "Variable") + " (n=" + (isFinite(n) ? Math.round(n) : "?") + ", xÃÑ=" + (isFinite(m) ? fmt(m) : "?") + ")";
          chip.style.fontSize = "11px";
          host.appendChild(chip);
        });
      } else {
        var names = Array.isArray(s.selectedColumns) ? s.selectedColumns.slice(0, 8) : [];
        names.forEach(function(nm){
          var nChip = document.createElement("span");
          nChip.className = "stat-chip";
          nChip.textContent = nm;
          nChip.style.fontSize = "11px";
          host.appendChild(nChip);
        });
        if (Array.isArray(s.selectedColumns) && s.selectedColumns.length > 8) {
          var moreChip = document.createElement("span");
          moreChip.className = "stat-chip";
          moreChip.textContent = "+" + (s.selectedColumns.length - 8) + " more";
          moreChip.style.opacity = "0.85";
          host.appendChild(moreChip);
        }
      }
      var design = s.designValidation || {};
      if (msgHost) {
        if (design.message) {
          msgHost.textContent = design.message;
          msgHost.style.display = "block";
        } else {
          msgHost.textContent = "";
          msgHost.style.display = "none";
        }
      }
    }
    function updateResultsPanels(r, fx, s, a){
      setText("resPrimaryFramework", primaryFramework === "nonparametric" ? "Nonparametric (ranks)" : "Parametric (means)");
      const alpha = isFinite(parseMaybeNumber(a)) ? parseMaybeNumber(a) : (1 - (parseMaybeNumber(s && s.confidence) || 0.95));
      if (r && r.omnibus) {
        const ob = r.omnibus;
        const paramPrimary = primaryFramework !== "nonparametric";
        if (paramPrimary) {
          setText("resPrimaryTest", "Repeated Measures ANOVA");
          setText("resPrimaryStat", "F(" + Math.round(ob.anovaDf1) + ", " + Math.round(ob.anovaDf2) + ") = " + fmt(ob.anovaF));
          setText("resPrimaryP", fmtP(ob.anovaP));
          setText("resPrimaryEstimate", "Omnibus effect across " + fmt(ob.levels ? ob.levels.length : 0) + " timepoints");
          setText("resSecondaryTest", "Friedman test");
          setText("resSecondaryStat", "œá¬≤(" + Math.round(ob.kwDf) + ") = " + fmt(ob.kwH));
          setText("resSecondaryP", fmtP(ob.kwP));
        } else {
          setText("resPrimaryTest", "Friedman test");
          setText("resPrimaryStat", "œá¬≤(" + Math.round(ob.kwDf) + ") = " + fmt(ob.kwH));
          setText("resPrimaryP", fmtP(ob.kwP));
          setText("resPrimaryEstimate", "Rank-based comparison across " + fmt(ob.levels ? ob.levels.length : 0) + " timepoints");
          setText("resSecondaryTest", "Repeated Measures ANOVA");
          setText("resSecondaryStat", "F(" + Math.round(ob.anovaDf1) + ", " + Math.round(ob.anovaDf2) + ") = " + fmt(ob.anovaF));
          setText("resSecondaryP", fmtP(ob.anovaP));
        }
        const agreeElK = document.getElementById("resAgreement");
        const aSig = parseMaybeNumber(ob.anovaP) < alpha;
        const kSig = parseMaybeNumber(ob.kwP) < alpha;
        if (aSig === kSig) {
          setText("resAgreement", "Agree at alpha");
          if (agreeElK) agreeElK.className = "stat-value agreement-good";
          setText("resHint", "Omnibus conclusions are consistent across frameworks.");
        } else {
          setText("resAgreement", "Disagree at alpha");
          if (agreeElK) agreeElK.className = "stat-value agreement-warn";
          setText("resHint", "Consider non-normality/heteroscedasticity and run post-hoc with correction.");
        }

        // ANOVA summary block
        const anovaBody = document.getElementById("anovaSummaryBody");
        if (anovaBody) {
          const totalDf = Math.max(0, parseMaybeNumber(ob.anovaDf1) + parseMaybeNumber(ob.anovaDf2));
          anovaBody.innerHTML = ''
            + '<tr><td>Treatments</td><td>' + fmt(ob.anovaSSBetween) + '</td><td>' + Math.round(ob.anovaDf1) + '</td><td>' + fmt(ob.anovaMSBetween) + '</td><td>' + fmt(ob.anovaF) + '</td><td>' + fmtP(ob.anovaP) + '</td></tr>'
            + '<tr><td>Within groups</td><td>' + fmt(ob.anovaSSWithin) + '</td><td>' + Math.round(ob.anovaDf2) + '</td><td>' + fmt(ob.anovaMSWithin) + '</td><td></td><td></td></tr>'
            + '<tr><td>Total</td><td>' + fmt(ob.anovaSSTotal) + '</td><td>' + Math.round(totalDf) + '</td><td></td><td></td><td></td></tr>';
        }
        // Update group visualization chart
        updateGroupChart();

        const varBody = document.getElementById("varianceTestBody");
        if (varBody) {
          const lv = ob.levene || {};
          const bf = ob.brownForsythe || {};
          varBody.innerHTML = ''
            + '<tr><td>Levene test</td><td>' + fmt(lv.f) + '</td><td>' + fmt(lv.df1) + '</td><td>' + fmt(lv.df2) + '</td><td>' + fmtP(lv.p) + '</td></tr>'
            + '<tr><td>Brown-Forsythe</td><td>' + fmt(bf.f) + '</td><td>' + fmt(bf.df1) + '</td><td>' + fmt(bf.df2) + '</td><td>' + fmtP(bf.p) + '</td></tr>';
        }

        const welchBody = document.getElementById("welchAnovaBody");
        if (welchBody) {
          const wa = ob.welchAnova || {};
          welchBody.innerHTML = '<tr><td>Welch</td><td>' + fmt(wa.df1) + '</td><td>' + fmt(wa.df2) + '</td><td>' + fmt(wa.f) + '</td><td>' + fmtP(wa.p) + '</td></tr>';
        }

        const compareBodyReport = document.getElementById("methodComparisonBodyReport");
        if (compareBodyReport) {
          const explore = (lastBundle && lastBundle.explore) ? lastBundle.explore : {};
          const colStats = Array.isArray(explore.selectedColumnStats) ? explore.selectedColumnStats.filter(function(cs){
            return isFinite(parseMaybeNumber(cs && cs.n)) && parseMaybeNumber(cs.n) > 0;
          }) : [];
          const meansSummary = colStats.slice(0, 3).map(function(cs){
            return (cs.name || "Var") + "=" + fmt(cs.mean);
          }).join(" | ") || "...";
          const meanRanks = ob.meanRanks || {};
          const rankKeys = Object.keys(meanRanks || {}).slice(0, 3);
          const meanRankSummary = rankKeys.length
            ? rankKeys.map(function(k){ return k + "=" + fmt(meanRanks[k]); }).join(" | ")
            : "...";
          compareBodyReport.innerHTML = ''
            + '<tr><td>ANOVA F: ' + fmt(ob.anovaF) + '</td><td>Kruskal H: ' + fmt(ob.kwH) + '</td></tr>'
            + '<tr><td>Means: ' + meansSummary + '</td><td>Mean ranks: ' + meanRankSummary + '</td></tr>'
            + '<tr><td>Œ∑¬≤ / œâ¬≤: ' + fmt(ob.etaSquared) + ' / ' + fmt(ob.omegaSquared) + '</td><td>Œµ¬≤ / Œ∑¬≤(H): ' + fmt(ob.epsilonSquared) + ' / ' + fmt(ob.etaSquaredH) + '</td></tr>'
            + '<tr><td>Post-hoc: Tukey / Games-Howell</td><td>Post-hoc: Dunn / Conover</td></tr>'
            + '<tr><td>Levene p: ' + fmtP((ob.levene || {}).p) + '</td><td>Tie/normality info: rank-based robust</td></tr>';
        }
      }
    }
    function updateGroupChart() {
      console.log("updateGroupChart called");
      console.log("lastBundle:", lastBundle);
      
      const container = document.getElementById('groupChartContainer');
      if (!container) {
        console.log("Container not found");
        return;
      }
      
      if (!lastBundle) {
        console.log('No lastBundle available for chart');
        container.innerHTML = '<div style="text-align:center;padding:80px 20px;color:var(--text-muted);font-size:12px;">No data available for visualization</div>';
        return;
      }
      
      // Try to get group data from multiple sources
      let groupData = [];
      
      // Source 1: explore.selectedColumnStats
      if (lastBundle.explore && Array.isArray(lastBundle.explore.selectedColumnStats)) {
        console.log("Found explore.selectedColumnStats:", lastBundle.explore.selectedColumnStats);
        groupData = lastBundle.explore.selectedColumnStats.filter(function(cs){
          return cs && isFinite(parseMaybeNumber(cs.n)) && parseMaybeNumber(cs.n) > 0;
        }).map(function(cs) {
          // Calculate variance if not provided (using stdDev or sd)
          let variance = cs.variance;
          if (!isFinite(parseMaybeNumber(variance))) {
            const sd = parseMaybeNumber(cs.stdDev || cs.sd || cs.stdev);
            if (isFinite(sd)) {
              variance = sd * sd; // variance = stdDev¬≤
            }
          }
          return {
            name: cs.name,
            mean: cs.mean,
            variance: variance,
            n: cs.n
          };
        });
      }
      
      // Source 2: If no explore data, try to build from groupDescriptives
      if (groupData.length === 0 && lastBundle.groupDescriptives && Array.isArray(lastBundle.groupDescriptives)) {
        console.log("Using groupDescriptives:", lastBundle.groupDescriptives);
        groupData = lastBundle.groupDescriptives.map(function(gd) {
          return {
            name: gd.name || gd.groupName || 'Group',
            mean: gd.mean,
            variance: gd.variance,
            n: gd.n
          };
        });
      }
      
      // Source 3: Try results.omnibus.levels with means
      if (groupData.length === 0 && lastBundle.results && lastBundle.results.omnibus) {
        console.log("Trying results.omnibus");
        const ob = lastBundle.results.omnibus;
        if (Array.isArray(ob.levels)) {
          console.log("Found levels:", ob.levels);
          groupData = ob.levels.map(function(level) {
            return {
              name: level.name || level.group || 'Group',
              mean: level.mean,
              variance: level.variance || level.var,
              n: level.n
            };
          });
        }
      }
      
      console.log("Final groupData:", groupData);
      
      if (groupData.length === 0) {
        console.log('No group data available for chart');
        container.innerHTML = '<div style="text-align:center;padding:80px 20px;color:var(--text-muted);font-size:12px;">No data available for visualization</div>';
        return;
      }
      
      const metricType = document.querySelector('input[name="chartMetric"]:checked')?.value || 'means';
      console.log("Metric type:", metricType);
      
      const categories = groupData.map(cs => cs.name || 'Group');
      console.log("Categories:", categories);
      
      const data = groupData.map(cs => {
        const val = metricType === 'means' ? parseMaybeNumber(cs.mean) : parseMaybeNumber(cs.variance);
        console.log("Group:", cs.name, "Value:", val, "Mean:", cs.mean, "Variance:", cs.variance);
        return isFinite(val) ? val : 0;
      });
      console.log("Chart data:", data);
      
      // Check if Highcharts is available
      if (typeof Highcharts === 'undefined') {
        console.error("Highcharts is not loaded!");
        container.innerHTML = '<div style="text-align:center;padding:80px 20px;color:#ff5555;font-size:12px;">Highcharts library not loaded</div>';
        return;
      }
      console.log("Highcharts version:", Highcharts.version);
      
      const chartTitle = metricType === 'means' ? 'Timepoint Means' : 'Timepoint Variances';
      const yAxisTitle = metricType === 'means' ? 'Mean' : 'Variance';
      
      console.log("About to create chart...");
      try {
        const isVariance = metricType === 'variances';
        
        // Calculate grand mean and standard errors for error bars
        let grandMean = null;
        const chartData = [];
        const errorData = [];
        
        if (metricType === 'means') {
          // Calculate grand mean (weighted by sample size if available)
          let totalWeighted = 0;
          let totalN = 0;
          groupData.forEach(function(g) {
            if (isFinite(g.mean) && isFinite(g.n)) {
              totalWeighted += g.mean * g.n;
              totalN += g.n;
            }
          });
          grandMean = totalN > 0 ? totalWeighted / totalN : null;
          
          // Prepare data with error bars (95% CI)
          groupData.forEach(function(g, idx) {
            const mean = g.mean;
            const sd = Math.sqrt(g.variance);
            const n = g.n || 1;
            const se = sd / Math.sqrt(n); // Standard error
            const ci95 = 1.96 * se; // Approximate 95% CI
            
            chartData.push({
              y: mean,
              name: g.name,
              n: n,
              sd: sd,
              se: se,
              color: null // Will be set based on significance
            });
            
            errorData.push({
              low: mean - ci95,
              high: mean + ci95
            });
          });
        } else {
          // For variance chart (no error bars)
          groupData.forEach(function(g) {
            chartData.push(g.variance);
          });
        }
        
        Highcharts.chart('groupChartContainer', {
          chart: {
            type: isVariance ? 'column' : 'column',
            backgroundColor: 'transparent',
            style: { fontFamily: 'Segoe UI, Tahoma, sans-serif' }
          },
          title: {
            text: chartTitle,
            style: { color: '#fff', fontSize: '13px', fontWeight: '700' }
          },
          xAxis: {
            categories: categories,
            labels: { style: { color: '#e5eefc', fontSize: '11px' } },
            lineColor: '#2d3748',
            tickColor: '#2d3748'
          },
          yAxis: {
            title: {
              text: yAxisTitle,
              style: { color: '#e5eefc', fontSize: '11px', fontWeight: '600' }
            },
            labels: { style: { color: '#e5eefc', fontSize: '10px' } },
            gridLineColor: '#2d3748',
            plotLines: metricType === 'means' && grandMean !== null ? [{
              value: grandMean,
              color: '#ffb74d',
              width: 2,
              dashStyle: 'Dash',
              zIndex: 5,
              label: {
                text: 'Grand Mean: ' + grandMean.toFixed(2),
                style: { color: '#ffb74d', fontSize: '10px', fontWeight: '600' }
              }
            }] : []
          },
          legend: { enabled: false },
          plotOptions: {
            column: {
              borderWidth: isVariance ? 2 : 0,
              borderColor: isVariance ? '#ffffff' : 'transparent',
              dataLabels: {
                enabled: true,
                format: '{y:.2f}',
                style: { 
                  color: '#fff', 
                  fontSize: '10px', 
                  fontWeight: '600', 
                  textOutline: 'none'
                }
              },
              colorByPoint: !isVariance, // Only use different colors for means
              colors: isVariance 
                ? ['#e57373', '#ba68c8', '#4fc3f7', '#81c784', '#ffb74d', '#f06292', '#7986cb', '#aed581']
                : ['#4a90e2', '#26a69a', '#ff9800', '#e91e63', '#9c27b0', '#3f51b5', '#00bcd4', '#4caf50'],
              opacity: isVariance ? 0.7 : 1,
              groupPadding: isVariance ? 0.15 : 0.2
            },
            errorbar: {
              color: 'rgba(255, 255, 255, 0.4)',
              whiskerLength: '60%',
              stemWidth: 1,
              whiskerWidth: 1.5,
              lineWidth: 1
            }
          },
          tooltip: {
            backgroundColor: '#1a1f2e',
            borderColor: '#2d3748',
            style: { color: '#fff', fontSize: '11px' },
            shared: metricType === 'means',
            formatter: function() {
              if (metricType === 'means' && this.points) {
                const point = this.points[0].point;
                let tooltip = '<b>' + point.name + '</b><br/>';
                tooltip += 'Mean: <b>' + point.y.toFixed(2) + '</b><br/>';
                tooltip += 'n = <b>' + point.n + '</b><br/>';
                tooltip += 'SD = <b>' + point.sd.toFixed(2) + '</b><br/>';
                tooltip += 'SE = <b>' + point.se.toFixed(3) + '</b><br/>';
                tooltip += '95% CI: [' + errorData[point.index].low.toFixed(2) + ', ' + errorData[point.index].high.toFixed(2) + ']';
                return tooltip;
              } else {
                return '<b>' + this.x + '</b><br/>' + yAxisTitle + ': <b>' + this.y.toFixed(2) + '</b>';
              }
            }
          },
          series: metricType === 'means' ? [
            {
              name: yAxisTitle,
              data: chartData,
              type: 'column'
            },
            {
              name: '95% CI',
              data: errorData,
              type: 'errorbar',
              tooltip: {
                pointFormat: '95% CI: {point.low:.2f} - {point.high:.2f}<br/>'
              }
            }
          ] : [{
            name: yAxisTitle,
            data: data,
            type: 'column'
          }],
          credits: { enabled: false }
        });
        console.log("Chart created successfully!");
      } catch (err) {
        console.error("Error creating chart:", err);
        container.innerHTML = '<div style="text-align:center;padding:80px 20px;color:#ff5555;font-size:12px;">Error creating chart: ' + err.message + '</div>';
      }
    }
    
    let posthocData = [];
    let posthocSortColumn = 'adjp';
    let posthocSortAsc = true;
    
    function renderPosthoc(posthoc, compareMode){
      const body = document.getElementById("posthocBody");
      const heading = document.getElementById("posthocHeading");
      const warningEl = document.getElementById("posthocWarning");
      const noteEl = document.getElementById("posthocMethodNote");
      const refSelect = document.getElementById("posthocRefGroup");
      
      if (!body) return;
      
      // Update heading color based on framework
      if (heading) {
        heading.className = "stat-panel-heading " + (primaryFramework === "nonparametric" ? "nonparametric" : "parametric");
      }
      
      if (compareMode !== "k-plus" || !posthoc || !posthoc.enabled) {
        body.innerHTML = '<tr><td colspan="7">No post-hoc comparisons available</td></tr>';
        return;
      }
      
      // Check omnibus significance and show warning
      if (warningEl && lastBundle && lastBundle.results && lastBundle.results.omnibus) {
        const ob = lastBundle.results.omnibus;
        const anovaP = parseMaybeNumber(ob.anovaP);
        const alpha = 0.05;
        if (anovaP > alpha) {
          warningEl.style.display = 'block';
        } else {
          warningEl.style.display = 'none';
        }
      }
      
      // Update method note
      const method = posthoc.method || "Games-Howell";
      const correction = posthoc.correction || "Holm";
      if (noteEl) {
        let methodDesc = "";
        if (method === "gameshowell" || method === "Games-Howell") {
          methodDesc = "Welch-type t (Games‚ÄìHowell) without equal variance assumption";
        } else if (method === "tukey" || method === "Tukey") {
          methodDesc = "Studentized range q (Tukey HSD) assuming equal variances";
        } else if (method === "dunn" || method === "Dunn") {
          methodDesc = "Rank-based z (Dunn) for nonparametric comparisons";
        } else {
          methodDesc = method + " test";
        }
        noteEl.textContent = methodDesc + " | p-value correction: " + correction;
      }
      
      const rows = posthoc.rows || [];
      if (!rows.length) {
        body.innerHTML = '<tr><td colspan="7">No post-hoc comparisons available</td></tr>';
        return;
      }
      
      // Store data globally for sorting/filtering
      posthocData = rows.map(function(r) {
        // Calculate CI if not provided (using standard error approximation)
        let ciLower = parseMaybeNumber(r.ciLower);
        let ciUpper = parseMaybeNumber(r.ciUpper);
        if (!isFinite(ciLower) || !isFinite(ciUpper)) {
          // Approximate CI from estimate and t-statistic
          const est = parseMaybeNumber(r.estimate);
          const t = Math.abs(parseMaybeNumber(r.statistic));
          if (isFinite(est) && isFinite(t) && t > 0) {
            const se = Math.abs(est / t);
            const tCrit = 2.0; // Approximate 95% t-critical
            ciLower = est - tCrit * se;
            ciUpper = est + tCrit * se;
          }
        }
        
        return {
          comparison: r.comparison || "",
          statistic: r.statistic,
          rawP: parseMaybeNumber(r.rawP),
          adjP: parseMaybeNumber(r.adjP),
          estimate: parseMaybeNumber(r.estimate),
          ciLower: ciLower,
          ciUpper: ciUpper,
          significant: parseMaybeNumber(r.adjP) < 0.05
        };
      });
      
      // Populate reference group dropdown
      if (refSelect) {
        const groups = [];
        posthocData.forEach(function(r) {
          const parts = r.comparison.split(/\s*vs\.?\s*/i);
          if (parts.length === 2) {
            const g1 = parts[0].trim();
            const g2 = parts[1].trim();
            if (g1 && groups.indexOf(g1) === -1) groups.push(g1);
            if (g2 && groups.indexOf(g2) === -1) groups.push(g2);
          }
        });
        
        if (groups.length > 0) {
          refSelect.innerHTML = '<option value="">All groups</option>' + 
            groups.map(g => '<option value="' + g + '">' + g + '</option>').join('');
          // Auto-select first group for better UX
          if (groups.length > 0) refSelect.value = groups[0];
        } else {
          refSelect.innerHTML = '<option value="">No groups available</option>';
        }
      }
      
      updatePosthocDisplay();
    }
    
    function updatePosthocDisplay() {
      const body = document.getElementById("posthocBody");
      const refSelect = document.getElementById("posthocRefGroup");
      if (!body || !posthocData.length) return;
      
      // Get grouping mode
      const grouping = document.querySelector('input[name="posthocGrouping"]:checked')?.value || 'all';
      const refGroup = refSelect ? refSelect.value : '';
      
      // Show/hide reference dropdown
      if (refSelect) {
        refSelect.style.display = (grouping === 'ref') ? 'inline-block' : 'none';
      }
      
      // Filter data
      let displayData = posthocData;
      if (grouping === 'ref' && refGroup) {
        displayData = posthocData.filter(function(r) {
          // Match if refGroup appears in the comparison
          const parts = r.comparison.split(/\s*vs\.?\s*/i);
          return parts.some(p => p.trim().toLowerCase() === refGroup.toLowerCase());
        });
      }
      
      // Sort data
      displayData.sort(function(a, b) {
        let valA, valB;
        if (posthocSortColumn === 'comparison') {
          return posthocSortAsc ? a.comparison.localeCompare(b.comparison) : b.comparison.localeCompare(a.comparison);
        } else if (posthocSortColumn === 'statistic') {
          valA = a.statistic; valB = b.statistic;
        } else if (posthocSortColumn === 'rawp') {
          valA = a.rawP; valB = b.rawP;
        } else if (posthocSortColumn === 'adjp') {
          valA = a.adjP; valB = b.adjP;
        } else if (posthocSortColumn === 'estimate') {
          valA = Math.abs(a.estimate); valB = Math.abs(b.estimate);
        } else if (posthocSortColumn === 'ci') {
          valA = a.ciUpper - a.ciLower; valB = b.ciUpper - b.ciLower;
        }
        return posthocSortAsc ? (valA - valB) : (valB - valA);
      });
      
      // Render table
      body.innerHTML = "";
      const MAX_RENDER = 200;
      const rowsToRender = displayData.slice(0, MAX_RENDER);
      
      rowsToRender.forEach(function(r){
        const tr = document.createElement("tr");
        
        // Comparison
        let td = document.createElement("td");
        td.textContent = r.comparison;
        tr.appendChild(td);
        
        // Statistic
        td = document.createElement("td");
        td.textContent = fmt(r.statistic);
        td.style.fontFamily = "monospace";
        tr.appendChild(td);
        
        // Raw p
        td = document.createElement("td");
        td.textContent = fmtP(r.rawP);
        td.style.fontFamily = "monospace";
        tr.appendChild(td);
        
        // Adj p
        td = document.createElement("td");
        td.textContent = fmtP(r.adjP);
        td.style.fontFamily = "monospace";
        tr.appendChild(td);
        
        // Estimate
        td = document.createElement("td");
        td.textContent = fmt(r.estimate);
        td.style.fontFamily = "monospace";
        tr.appendChild(td);
        
        // 95% CI
        td = document.createElement("td");
        if (isFinite(r.ciLower) && isFinite(r.ciUpper)) {
          td.textContent = "[" + fmt(r.ciLower) + ", " + fmt(r.ciUpper) + "]";
        } else {
          td.textContent = "‚Äî";
        }
        td.style.fontFamily = "monospace";
        td.style.fontSize = "10px";
        tr.appendChild(td);
        
        // Significance indicator
        td = document.createElement("td");
        td.style.textAlign = "center";
        if (r.significant) {
          td.innerHTML = '<span style="color:#4ade80;font-weight:800;font-size:14px;">‚úî</span>';
        } else {
          td.innerHTML = '<span style="color:#64748b;font-weight:400;font-size:14px;">‚úñ</span>';
        }
        tr.appendChild(td);
        
        body.appendChild(tr);
      });
      
      if (displayData.length > MAX_RENDER) {
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 7;
        td.textContent = "... " + (displayData.length - MAX_RENDER) + " more rows (table capped at " + MAX_RENDER + ")";
        td.style.textAlign = "center";
        td.style.fontStyle = "italic";
        td.style.color = "var(--text-muted)";
        tr.appendChild(td);
        body.appendChild(tr);
      }
    }
    
    function sortPosthocTable(column) {
      if (posthocSortColumn === column) {
        posthocSortAsc = !posthocSortAsc;
      } else {
        posthocSortColumn = column;
        posthocSortAsc = (column === 'adjp' || column === 'rawp'); // Ascending for p-values
      }
      updatePosthocDisplay();
    }

    
    // === Descriptive Stats Functions ===
    let descSelectedRow = null;
    let descData = [];
    
    function populateDescriptiveStats(headers, rows) {
      if (!Array.isArray(headers) || !Array.isArray(rows)) return;
      
      descData = headers.map(varName => {
        const values = rows
          .map(row => row[varName])
          .map(v => typeof v === 'number' ? v : parseFloat(v))
          .filter(v => isFinite(v));
        
        if (values.length === 0) return null;
        
        const sorted = values.slice().sort((a, b) => a - b);
        const n = values.length;
        const mean = values.reduce((sum, v) => sum + v, 0) / n;
        const median = n % 2 === 0 
          ? (sorted[n/2 - 1] + sorted[n/2]) / 2 
          : sorted[Math.floor(n/2)];
        
        const variance = values.reduce((sum, v) => sum + Math.pow(v - mean, 2), 0) / n;
        const stdDev = Math.sqrt(variance);
        const skew = values.reduce((sum, v) => sum + Math.pow((v - mean) / stdDev, 3), 0) / n;
        const kurt = values.reduce((sum, v) => sum + Math.pow((v - mean) / stdDev, 4), 0) / n - 3;
        
        return {
          Variable: varName,
          N: n,
          Mean: mean,
          StdDev: stdDev,
          Min: Math.min(...values),
          Median: median,
          Max: Math.max(...values),
          Skew: skew,
          Kurt: kurt,
          vector: values
        };
      }).filter(stat => stat !== null);
      
      renderDescriptiveTable();
      if (descData.length > 0) {
        selectDescRow(descData[0]);
      }
    }
    
    function renderDescriptiveTable() {
      const tbody = document.getElementById('desc-stats-body');
      if (!tbody) return;
      tbody.innerHTML = '';
      
      descData.forEach(row => {
        const tr = document.createElement('tr');
        if (descSelectedRow && row.Variable === descSelectedRow.Variable) {
          tr.className = 'selected';
        }
        
        const tdVariable = document.createElement('td');
        tdVariable.textContent = row.Variable;
        tdVariable.style.textAlign = 'left';
        tr.appendChild(tdVariable);
        
        ['N', 'Mean', 'StdDev', 'Min', 'Median', 'Max', 'Skew', 'Kurt'].forEach(field => {
          const td = document.createElement('td');
          td.textContent = field === 'N' ? row[field] : fmt(row[field]);
          tr.appendChild(td);
        });
        
        tr.addEventListener('click', () => selectDescRow(row));
        tbody.appendChild(tr);
      });
    }
    
    function selectDescRow(row) {
      descSelectedRow = row;
      renderDescriptiveTable();
      
      document.getElementById('desc-histogram-title').textContent = row.Variable;
      document.getElementById('desc-histogram-panel').style.display = 'block';
      
      renderDescHistogram();
      updateDescSummary();
    }
    
    function updateDescSummary() {
      if (!descSelectedRow) return;
      const summaryTable = document.getElementById('desc-summary-table');
      if (!summaryTable) return;
      
      summaryTable.innerHTML = `
        <div><strong>N:</strong><span>${descSelectedRow.N}</span></div>
        <div><strong>Mean:</strong><span>${fmt(descSelectedRow.Mean)}</span></div>
        <div><strong>StdDev:</strong><span>${fmt(descSelectedRow.StdDev)}</span></div>
        <div><strong>Min:</strong><span>${fmt(descSelectedRow.Min)}</span></div>
        <div><strong>Median:</strong><span>${fmt(descSelectedRow.Median)}</span></div>
        <div><strong>Max:</strong><span>${fmt(descSelectedRow.Max)}</span></div>
        <div><strong>Skew:</strong><span>${fmt(descSelectedRow.Skew)}</span></div>
        <div><strong>Kurt:</strong><span>${fmt(descSelectedRow.Kurt)}</span></div>
      `;
    }
    
    function renderDescHistogram() {
      if (!descSelectedRow || !descSelectedRow.vector) return;
      
      const container = document.getElementById('histogram-container-kplus');
      if (!container) return;
      
      const width = container.clientWidth || 600;
      const height = 280;
      
      d3.select('#histogram-container-kplus').selectAll('*').remove();
      
      const svg = d3.select('#histogram-container-kplus')
        .append('svg')
        .attr('width', width)
        .attr('height', height);
      
      const margin = { top: 15, right: 25, bottom: 40, left: 40 };
      const innerWidth = width - margin.left - margin.right;
      const innerHeight = height - margin.top - margin.bottom;
      
      const g = svg.append('g')
        .attr('transform', `translate(${margin.left},${margin.top})`);
      
      const numBins = 10;
      const values = descSelectedRow.vector;
      const min = Math.min(...values);
      const max = Math.max(...values);
      const range = max - min;
      const binWidth = range / numBins;
      
      const histData = Array.from({ length: numBins }, (_, i) => {
        const start = min + i * binWidth;
        const end = min + (i + 1) * binWidth;
        const bin = `${start.toFixed(1)}-${end.toFixed(1)}`;
        let count = 0;
        values.forEach(v => {
          if (v >= start && (i === numBins - 1 ? v <= end : v < end)) count++;
        });
        return { bin, start, end, count };
      });
      
      const x = d3.scaleBand()
        .domain(histData.map(d => d.bin))
        .range([0, innerWidth])
        .padding(0.1);
      
      const maxCount = d3.max(histData, d => d.count);
      const y = d3.scaleLinear()
        .domain([0, maxCount + (maxCount * 0.1)])
        .range([innerHeight, 0]);
      
      g.append('g')
        .attr('class', 'axis')
        .attr('transform', `translate(0,${innerHeight})`)
        .call(d3.axisBottom(x).tickValues(x.domain().filter((d, i) => i % 2 === 0)))
        .selectAll('text')
        .style('text-anchor', 'end')
        .attr('dx', '-.8em')
        .attr('dy', '.15em')
        .attr('font-size', '8px')
        .attr('transform', 'rotate(-45)');
      
      g.append('g')
        .attr('class', 'axis')
        .call(d3.axisLeft(y).ticks(5));
      
      g.append('g')
        .attr('class', 'grid')
        .call(d3.axisLeft(y).ticks(5).tickSize(-innerWidth).tickFormat(''));
      
      g.selectAll('.histogram-bar')
        .data(histData)
        .enter().append('rect')
        .attr('class', 'histogram-bar')
        .attr('x', d => x(d.bin))
        .attr('width', x.bandwidth())
        .attr('y', d => y(d.count))
        .attr('height', d => innerHeight - y(d.count));
      
      // Add normal curve
      const mean = descSelectedRow.Mean;
      const stdDev = descSelectedRow.StdDev;
      const normalData = [];
      const step = range / 50;
      for (let x_val = min - range * 0.1; x_val <= max + range * 0.1; x_val += step) {
        const exponent = -Math.pow(x_val - mean, 2) / (2 * Math.pow(stdDev, 2));
        const y_val = (1 / (stdDev * Math.sqrt(2 * Math.PI))) * Math.exp(exponent);
        normalData.push({ x: x_val, y: y_val });
      }
      
      const maxNormalY = d3.max(normalData, d => d.y);
      const normalScale = maxCount / maxNormalY * 0.8;
      
      const xScale = d3.scaleLinear()
        .domain([min, max])
        .range([0, innerWidth]);
      
      const line = d3.line()
        .x(d => xScale(d.x))
        .y(d => y(d.y * normalScale))
        .curve(d3.curveCardinal);
      
      g.append('path')
        .datum(normalData)
        .attr('class', 'normal-curve')
        .attr('d', line);
    }
    
    function openNormalityModal() {
      if (!descSelectedRow) {
        alert('Please select a variable first');
        return;
      }
      
      document.getElementById('modal-variable-name').textContent = descSelectedRow.Variable;
      document.getElementById('modal-sample-size').textContent = `(n=${descSelectedRow.N})`;
      document.getElementById('modal-variable-detail').textContent = descSelectedRow.Variable;
      document.getElementById('modal-n-detail').textContent = descSelectedRow.N;
      document.getElementById('modal-mean-detail').textContent = fmt(descSelectedRow.Mean);
      document.getElementById('modal-sd-detail').textContent = fmt(descSelectedRow.StdDev);
      
      document.getElementById('normality-modal').style.display = 'block';
      document.body.style.overflow = 'hidden';
    }
    
    function closeNormalityModal() {
      document.getElementById('normality-modal').style.display = 'none';
      document.body.style.overflow = 'auto';
    }
    
    function populateBundle(b){
      console.log("populateBundle called with:", b);
      lastBundle = b || {};
      const s=b.setup||{}, e=b.explore||{}, a=b.assumptions||{}, r=b.results||{}, fx=b.effects||{}, p=b.power||{}, rep=b.report||{};
      console.log("Results object:", r);
      console.log("Explore object:", e);
      availableHeaders = Array.isArray(s.headers) ? s.headers.slice() : availableHeaders;
      persistedColumns.groupA = s.groupA || persistedColumns.groupA;
      persistedColumns.groupB = s.groupB || persistedColumns.groupB;
      persistedColumns.valueColumn = s.valueColumn || persistedColumns.valueColumn;
      persistedColumns.groupColumn = s.groupColumn || persistedColumns.groupColumn;
      currentCompareMode = "k-plus";
      currentPrimaryTest = s.primaryTest || currentPrimaryTest || "welch";
      
      // Populate descriptive stats with selected columns data
      if (window.dependentRangeData && Array.isArray(s.selectedColumns)) {
        const headers = window.dependentRangeData[0] || [];
        const dataRows = window.dependentRangeData.slice(1);
        
        // Convert array-of-arrays to array-of-objects
        const rowObjects = dataRows.map(row => {
          const obj = {};
          headers.forEach((header, idx) => {
            obj[header] = row[idx];
          });
          return obj;
        });
        
        populateDescriptiveStats(s.selectedColumns, rowObjects);
      }
      
      var testSel = document.getElementById("setPrimaryTest");
      if (testSel) testSel.value = currentPrimaryTest;
      setFrameworkButtons(s.primaryFramework || primaryFramework);
      var alphaEl = document.getElementById("setAlpha");
      if (alphaEl) alphaEl.value = String(1 - (parseMaybeNumber(s.confidence) || 0.95));
      var orientation = s.hypothesis || "two-sided";
      currentHypothesis = orientation;
      var radio = document.querySelector('input[name="h1Orientation"][value="' + orientation + '"]');
      if (radio) radio.checked = true;
      const phm = document.getElementById("setPosthocMethod"); if (phm) phm.value = s.posthocMethod || "games-howell";
      const phc = document.getElementById("setPosthocCorrection"); if (phc) phc.value = s.posthocCorrection || "holm";
      renderCompareStatsRow(s, e);
      refreshSettingsVisibility();
      updatePosthocOptions();
      const ksum = e.kplusSummary || {};
      const ob = r.omnibus || {};
      const groupCount = isFinite(parseMaybeNumber(ksum.variableCount)) 
        ? parseMaybeNumber(ksum.variableCount) 
        : (Array.isArray(ob.groupDescriptives) ? ob.groupDescriptives.length : (Array.isArray(s.selectedColumns) ? s.selectedColumns.length : "..."));
      setText("expVarCount", Math.round(groupCount));
      
      // Display missing data information
      const totalRows = parseMaybeNumber(e.totalRows) || 0;
      const completeCases = isFinite(parseMaybeNumber(ksum.totalN)) ? Math.round(parseMaybeNumber(ksum.totalN)) : (isFinite(ob.N) ? Math.round(ob.N) : 0);
      const missingCount = parseMaybeNumber(e.missingCount) || 0;
      const missingPct = parseMaybeNumber(e.missingPct) || 0;
      
      setText("expTotalRows", totalRows);
      setText("expTotalN", completeCases);
      
      const warningEl = document.getElementById("missingDataWarning");
      if (warningEl && missingCount > 0) {
        warningEl.style.display = "block";
        setText("missingCount", missingCount);
        setText("missingPct", missingPct.toFixed(1));
      } else if (warningEl) {
        warningEl.style.display = "none";
      }
      
      setText("expLevels", isFinite(parseMaybeNumber(ksum.levelsCount)) ? Math.round(parseMaybeNumber(ksum.levelsCount)) : "...");
      setText("expOverallMean", isFinite(parseMaybeNumber(ksum.meanOverall)) ? fmt(ksum.meanOverall) : "...");
      setText("expFramework", primaryFramework === "nonparametric" ? "Nonparametric (ranks)" : "Parametric (means)");
      const alpha = 0.05;
      const leveneP = parseMaybeNumber((ob.levene || {}).p);
      const bfP = parseMaybeNumber((ob.brownForsythe || {}).p);
      const welchP = parseMaybeNumber((ob.welchAnova || {}).p);
      const anovaP = parseMaybeNumber(ob.anovaP);
      
      // Design Balance Indicator
      const balanceEl = document.getElementById("balanceText");
      if (balanceEl && lastBundle && lastBundle.explore && lastBundle.explore.selectedColumnStats) {
        const stats = lastBundle.explore.selectedColumnStats;
        const nValues = stats.map(cs => parseMaybeNumber(cs.n)).filter(n => isFinite(n) && n > 0);
        if (nValues.length > 0) {
          const maxN = Math.max(...nValues);
          const minN = Math.min(...nValues);
          const ratio = maxN / minN;
          let balanceText = "";
          if (ratio === 1) {
            balanceText = "‚úì Perfectly balanced (all n = " + Math.round(minN) + ")";
          } else if (ratio < 1.2) {
            balanceText = "‚úì Well balanced (max/min n = " + ratio.toFixed(2) + ")";
          } else if (ratio < 1.5) {
            balanceText = "‚ö† Mildly unbalanced (max/min n = " + ratio.toFixed(2) + ")";
          } else {
            balanceText = "‚ö† Substantially unbalanced (max/min n = " + ratio.toFixed(2) + ")";
          }
          balanceEl.textContent = balanceText;
        }
      }
      
      // Sphericity Test (Mauchly)
      const sphericity = ob.sphericity || {};
      const mauchlyW = parseMaybeNumber(sphericity.W);
      const mauchlyP = parseMaybeNumber(sphericity.p);
      const epsilonGG = parseMaybeNumber(sphericity.epsilonGG);
      const epsilonHF = parseMaybeNumber(sphericity.epsilonHF);
      const sphericityMet = sphericity.sphericityMet !== false;
      
      setText("asMauchlyW", fmt(mauchlyW));
      setText("asMauchlyP", fmtP(mauchlyP));
      setText("asEpsilonGG", fmt(epsilonGG));
      setText("asEpsilonHF", fmt(epsilonHF));
      setText("asCompleteCases", lastBundle.results.totalN || 0);
      
      // Mauchly verdict
      const mauchlyEl = document.getElementById("asMauchlyVerdict");
      if (mauchlyEl) {
        if (sphericityMet) {
          mauchlyEl.textContent = "‚úì Sphericity assumption met (p > 0.05)";
          mauchlyEl.style.color = "#4ade80";
        } else {
          mauchlyEl.textContent = "‚ö† Sphericity violated (p < 0.05) - Corrections applied";
          mauchlyEl.style.color = "#fbbf24";
        }
      }
      
      // Recommendation text for repeated measures
      const recoEl = document.getElementById("asRecoText");
      if (recoEl) {
        let recoText = "";
        const anovaSig = anovaP < alpha;
        const friedmanP = parseMaybeNumber(ob.kwP);
        const friedmanSig = friedmanP < alpha;
        
        if (sphericityMet) {
          recoText = "‚úì <strong>Repeated Measures ANOVA is appropriate.</strong> The sphericity assumption is met (Mauchly's W = " + fmt(mauchlyW) + ", p = " + fmtP(mauchlyP) + "). ";
          if (anovaSig) {
            recoText += "The RM-ANOVA shows <strong>significant differences</strong> across timepoints (p " + fmtP(anovaP) + "). Proceed with <strong>paired post-hoc tests</strong> with Holm-Bonferroni correction.";
          } else {
            recoText += "The RM-ANOVA shows <strong>no significant differences</strong> across timepoints (p = " + fmtP(anovaP) + ").";
          }
        } else {
          recoText = "‚ö† <strong>Sphericity assumption violated - Corrections applied.</strong> ";
          recoText += "Greenhouse-Geisser Œµ = " + fmt(epsilonGG) + ", Huynh-Feldt Œµ = " + fmt(epsilonHF) + ". ";
          
          const pValueGG = parseMaybeNumber(ob.anovaPGG);
          const pValueHF = parseMaybeNumber(ob.anovaPHF);
          
          if (pValueGG < alpha) {
            recoText += "Even with correction, differences are <strong>significant</strong> (GG-corrected p " + fmtP(pValueGG) + "). ";
            recoText += "Proceed with <strong>paired post-hoc tests</strong> with Holm-Bonferroni correction.";
          } else {
            recoText += "With correction applied, no significant differences detected (GG-corrected p = " + fmtP(pValueGG) + ").";
          }
        }
        
        // Add Friedman note if parametric assumptions are questionable
        if (friedmanSig === anovaSig) {
          recoText += " <em>Note: Friedman test (nonparametric alternative) confirms the " + (anovaSig ? "significant" : "non-significant") + " result.</em>";
        }
        
        recoEl.innerHTML = recoText;
      }
      
      // Auto-select post-hoc method based on recommendation (paired tests for RM)
      const posthocSelect = document.getElementById("setPosthocMethod");
      if (posthocSelect) {
        posthocSelect.value = "paired"; // Always use paired for RM
      }
      updateResultsPanels(r, fx, s, 1 - (parseMaybeNumber(s.confidence) || 0.95));
      renderPosthoc(r.posthoc || {}, "k-plus");
      setText("efEta", fmt(ob.etaSquared)); setText("efCohenF", fmt(ob.cohenF)); setText("efAnovaF", fmt(ob.anovaF)); setText("efKwH", fmt(ob.kwH));
      setText("powNote", p.note); setText("powEndpoint", p.suggestedEndpoint); setText("powVal", fmt(p.placeholderPower));
      setText("repAnova", "RM-ANOVA: F(" + Math.round(ob.anovaDf1) + ", " + Math.round(ob.anovaDf2) + ") = " + fmt(ob.anovaF) + ", p " + fmtP(ob.anovaP) + ".");
      setText("repKw", "Friedman: œá¬≤(" + Math.round(ob.kwDf) + ") = " + fmt(ob.kwH) + ", p " + fmtP(ob.kwP) + ".");
      setText("repCons", rep.consistency);
    }
    function saveCurrentModel(){ sendToHost("savedependentModel", lastBundle||{}); }
    function exportHtml(){
      const blob = new Blob([document.documentElement.outerHTML], {type:"text/html"});
      const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = "dependent-means-report.html"; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),500);
    }
    document.addEventListener("DOMContentLoaded", function(){
      document.querySelectorAll(".tab-button").forEach(btn=>btn.addEventListener("click",()=>switchTab(btn.getAttribute("data-tab"))));
      ["setAlpha","setPosthocMethod","setPosthocCorrection","setPrimaryTest"].forEach(function(id){
        const el = document.getElementById(id);
        if (el) el.addEventListener("change", function(){
          if (id === "setPrimaryTest") {
            currentPrimaryTest = el.value || "welch";
            setFrameworkButtons(primaryFramework);
          }
          notifySettingsChanged();
        });
      });
      document.querySelectorAll('input[name="h1Orientation"]').forEach(function(el){ el.addEventListener("change", notifySettingsChanged); });
      var rp = document.getElementById("fwParametric");
      var rn = document.getElementById("fwNonparametric");
      if (rp) rp.addEventListener("change", function(){ if (rp.checked) { setFrameworkButtons("parametric"); notifySettingsChanged(); } });
      if (rn) rn.addEventListener("change", function(){ if (rn.checked) { setFrameworkButtons("nonparametric"); notifySettingsChanged(); } });
      setFrameworkButtons(primaryFramework);
      refreshSettingsVisibility();
      Office.onReady(function(){
        // Close modal when clicking outside
        document.addEventListener('click', function(event) {
          const modal = document.getElementById('normality-modal');
          if (event.target === modal) {
            closeNormalityModal();
          }
        });
        
        // Close modal with Escape key
        document.addEventListener('keydown', function(event) {
          if (event.key === 'Escape') {
            closeNormalityModal();
          }
        });
        
        Office.context.ui.addHandlerAsync(Office.EventType.DialogParentMessageReceived, function(arg){
          const msg = JSON.parse(arg.message||"{}");
          if(msg.type==="DEPENDENT_BUNDLE"){
            // Store raw data for descriptive stats
            if (msg.rawData) {
              window.dependentRangeData = msg.rawData;
            }
            populateBundle(msg.payload||{});
          }
        });
        if(Office&&Office.context&&Office.context.ui&&Office.context.ui.messageParent) {
          Office.context.ui.messageParent(JSON.stringify({action:"ready"}));
          setTimeout(()=>Office.context.ui.messageParent(JSON.stringify({action:"ready"})),500);
        }
      });
    });
    
  </script>
</body>
</html>
