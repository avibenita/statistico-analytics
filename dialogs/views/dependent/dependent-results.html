<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dependent (Paired Samples) Results</title>
  <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
  <script src="https://code.highcharts.com/highcharts.js"></script>
  <script src="https://code.highcharts.com/highcharts-more.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet"/>
  <script>
    // AI API Key configuration (Groq)
    window.AI_API_KEY = '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';
    console.log('ðŸ”‘ AI API Key set:', window.AI_API_KEY && window.AI_API_KEY !== 'YOUR_API_KEY_PLACEHOLDER' ? 'YES (***' + window.AI_API_KEY.slice(-4) + ')' : 'NO - Key not configured');
  </script>
  <style>
    :root{--surface-0:#0c1624;--surface-1:#1a1f2e;--surface-2:#242938;--border:#2d3748;--accent-1:rgb(255,165,120);--accent-2:rgb(120,200,255);--text-primary:#fff;--text-secondary:rgba(255,255,255,.82);--text-muted:rgba(255,255,255,.62);--panel-radius:10px;--panel-shadow:0 4px 20px rgba(0,0,0,.4);}
    html,body{height:100%;margin:0;background:var(--surface-0);color:var(--text-primary);font-family:Segoe UI,Tahoma,sans-serif;}
    .wrap{display:flex;justify-content:center;padding:8px 12px 20px;}
    .card{/* width:min(1600px,99%); *//* background:var(--surface-1); */min-height:760px;border-radius:var(--panel-radius);box-shadow:var(--panel-shadow);border:1px solid var(--border);display:flex;flex-direction:column;}
    .hero-section{background:linear-gradient(180deg,#0a1118,#0c1620);border-bottom:1px solid rgba(255,255,255,.06);padding:16px 20px;border-radius:var(--panel-radius) var(--panel-radius) 0 0;}
    .hero-content{display:flex;justify-content:space-between;align-items:center;gap:12px;}
    .hero-title{display:flex;align-items:center;/* gap:12px; */font-size:1.28rem;font-weight:800;letter-spacing:.4px;text-transform:uppercase;}
    .hero-controls{display:flex;align-items:center;gap:10px;}
    .hero-action-btn{border-radius:8px;border:1px solid rgba(148,163,184,.45);background:linear-gradient(145deg,rgba(148,163,184,.18),rgba(100,116,139,.16));color:#fff;padding:10px 16px;font-size:12px;font-weight:650;cursor:pointer;display:flex;align-items:center;gap:8px;position:relative;}
    .hero-action-btn:hover::after{content:attr(title);position:absolute;bottom:100%;left:50%;transform:translateX(-50%);margin-bottom:8px;padding:8px 12px;background:#283593;color:#fff;font-size:11px;font-weight:600;white-space:nowrap;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.3);z-index:1000;pointer-events:none;}
    .hero-action-btn:hover::before{content:'';position:absolute;bottom:100%;left:50%;transform:translateX(-50%);margin-bottom:2px;border:6px solid transparent;border-top-color:#283593;z-index:1000;pointer-events:none;}
    .design-warning{margin-top:8px;padding:8px 16px;background:transparent;border-left:4px solid #ff9800;color:#e65100;font-size:12px;font-weight:600;text-align:center;}
    .tab-navigation{display:flex;align-items:flex-end;gap:16px;background:transparent;padding:12px 0 0;border-bottom:1px solid rgba(255,255,255,.08);overflow-x:auto;scrollbar-width:none;margin-top:10px;}
    .tab-button{height:36px;padding:0 4px;background:transparent;border:none;color:rgba(255,255,255,.55);font-size:12px;font-weight:600;cursor:pointer;display:flex;align-items:center;gap:7px;position:relative;}
    .tab-button.active{color:#fff;font-weight:700;}
    .tab-button.active::before{content:'';position:absolute;left:0;right:0;bottom:-9px;height:2px;background:linear-gradient(90deg,var(--accent-1),var(--accent-2));}
    .tab-controls-right{margin-left:auto;display:inline-flex;align-items:center;gap:8px;padding-bottom:8px;}
    .tab-decimal-select{height:36px;padding:0 10px;border-radius:8px;border:1px solid rgba(148,163,184,.45);background:rgba(15,23,42,.82);color:#fff;}
    .view-container{padding:14px 16px;}
    .tab-panel{display:none;} .tab-panel.active{display:block;}
    .stats-container{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:12px;}
    .stat-panel{background:rgba(255,255,255,.04);border:1px solid var(--border);border-radius:10px;overflow:hidden;}
    .stat-panel.secondary{opacity:0.7;transform:scale(0.95);border-color:rgba(45,55,72,0.4);}
    .stat-panel.secondary .stat-panel-heading{background:#37474f;font-size:11px;padding:7px 10px;border-bottom:1px solid rgba(255,165,120,.4);}
    .stat-panel.secondary .stat-field{padding:6px 0;}
    .stat-panel.secondary .stat-label{font-size:13px;opacity:0.85;}
    .stat-panel.secondary .stat-value{font-size:13px;padding:5px 8px;min-width:100px;opacity:0.9;}
    .stat-panel-heading{padding:9px 12px;background:#164e8d;color:#fff;font-weight:700;text-transform:uppercase;letter-spacing:.3px;border-bottom:2px solid rgba(255,165,120,.7);}
    .stat-panel-heading.parametric{background:#2e5f8a;border-bottom-color:#4a90e2;}
    .stat-panel-heading.nonparametric{background:#00695c;border-bottom-color:#26a69a;}
    .stat-panel-body{padding:8px 12px;}
    .stat-field{display:grid;grid-template-columns:1fr auto;align-items:center;gap:12px;padding:8px 0;border-bottom:1px solid rgba(255,255,255,.06);}
    .stat-field:last-child{border-bottom:none;}
    .stat-label{color:var(--text-secondary);font-weight:600;}
    .stat-value{font-variant-numeric:tabular-nums;color:var(--accent-2);font-weight:700;background:rgba(120,200,255,.12);border:1px solid rgba(120,200,255,.32);padding:6px 10px;border-radius:8px;min-width:110px;text-align:center;}
    .table-container{margin-top:10px;overflow:auto;max-height:420px;}
    .analysis-table{width:100%;border-collapse:collapse;}
    .analysis-table th{position:sticky;top:0;background:#164e8d;color:#fff;padding:8px;border:1px solid rgba(255,255,255,.2);}
    .analysis-table td{padding:8px;border:1px solid rgba(255,255,255,.14);color:var(--text-secondary);}
    .section-note{margin-top:10px;padding:9px;border-left:3px solid var(--accent-1);background:rgba(255,165,120,.1);color:var(--text-muted);}
    .framework-select{height:34px;padding:0 10px;border-radius:8px;border:1px solid rgba(148,163,184,.45);background:rgba(15,23,42,.82);color:#fff;}
    .agreement-good{color:#4ade80;font-weight:700;}
    .agreement-warn{color:#fbbf24;font-weight:700;}
    .settings-bar{margin-top:8px;background:linear-gradient(135deg, #e8eaf6 0%, #c5cae9 100%);border:2px solid #5c6bc0;border-radius:0;padding:8px 10px;box-shadow:0 2px 8px rgba(92,107,192,0.15);}
    .settings-panel-title{font-size:11px;font-weight:800;text-transform:uppercase;letter-spacing:1px;color:#283593;margin-bottom:8px;padding-bottom:4px;border-bottom:2px solid #5c6bc0;}
    .settings-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(170px,1fr));gap:6px;}
    .settings-grid>div{display:flex;flex-direction:column;}
    .settings-grid label{font-size:11px;color:#37474f;margin-bottom:2px;font-weight:700;text-transform:uppercase;}
    .settings-grid select,.settings-grid input{width:100%;height:32px;border-radius:0;border:2px solid #5c6bc0;background:#ffffff;color:#263238;padding:0 8px;font-weight:600;}
    #setPosthocWrap,#setCorrectionWrap{min-width:160px;max-width:200px;}
    .inference-row{display:flex;align-items:center;justify-content:center;gap:16px;flex-wrap:wrap;}
    .inference-card{display:flex;align-items:center;gap:8px;flex-wrap:nowrap;justify-content:center;padding:0;border:0;border-radius:0;background:transparent;}
    .inference-card#primaryTestWrap{flex:0 0 auto;min-width:200px;max-width:220px;}
    .inference-title{display:none;}
    .fw-radio-group{display:flex;border:0;border-radius:0;overflow:hidden;min-width:360px;gap:6px;}
    .fw-radio-group input{display:none;}
    .fw-radio{padding:10px 16px;color:#fff;font-size:14px;font-weight:800;cursor:pointer;user-select:none;border:3px solid transparent;box-shadow:0 2px 8px rgba(0,0,0,0.1);text-transform:uppercase;letter-spacing:0.5px;opacity:0.6;flex:1;text-align:center;position:relative;}
    .fw-radio:last-of-type{border-right:3px solid transparent;}
    .fw-radio.active{opacity:1;box-shadow:0 4px 12px rgba(0,0,0,0.3);transform:translateY(-2px);transition:all 0.2s ease;border-color:currentColor;}
    .fw-radio.active::before{content:'âœ“';position:absolute;left:8px;top:50%;transform:translateY(-50%);font-size:18px;font-weight:900;}
    .fw-radio#setFrameworkParam{background:#4a90e2;color:#fff;}
    .fw-radio#setFrameworkParam.active{background:#2e5f8a;border-color:#4a90e2;}
    .fw-radio#setFrameworkNon{background:#26a69a;color:#fff;}
    .fw-radio#setFrameworkNon.active{background:#00695c;border-color:#26a69a;}
    .primary-test-wrap{display:flex;align-items:center;gap:8px;min-width:280px;}
    .test-now{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:8px;border:1px solid rgba(16,185,129,.45);background:rgba(16,185,129,.14);color:#d1fae5;font-size:12px;font-weight:800;}
    .primary-test-wrap label{font-size:11px;color:var(--text-muted);font-weight:800;text-transform:uppercase;}
    .primary-test-wrap select{height:38px;width:100%;border-radius:0;border:3px solid transparent;background:#2e5f8a;color:#ffffff;padding:0 12px;font-weight:700;font-size:14px;box-shadow:0 2px 8px rgba(0,0,0,0.15);}
    .primary-test-wrap select.parametric{background:#2e5f8a;border-color:#4a90e2;color:#ffffff;box-shadow:0 3px 10px rgba(46,95,138,0.4);}
    .primary-test-wrap select.nonparametric{background:#00695c;border-color:#26a69a;color:#ffffff;box-shadow:0 3px 10px rgba(0,105,92,0.4);}
    #setPrimaryTest:disabled{appearance:none;-webkit-appearance:none;-moz-appearance:none;background-image:none !important;cursor:default;padding-right:8px !important;}
    select:disabled{appearance:none;-webkit-appearance:none;-moz-appearance:none;}
    .hbox{border:1px solid rgba(148,163,184,.38);border-radius:10px;padding:8px;background:rgba(6,16,30,.55);}
    .hbox-title{font-size:11px;color:var(--text-muted);text-transform:uppercase;font-weight:700;margin-bottom:6px;}
    .hbox-row{display:flex;align-items:center;gap:10px;flex-wrap:nowrap;color:#e5eefc;}
    .h-radio{display:inline-flex;align-items:center;gap:5px;font-size:12px;color:#263238;text-transform:none !important;white-space:nowrap;font-weight:600;}
    .h-radio input{transform:scale(0.9);}
    .hdr-row{display:flex;justify-content:center;align-items:center;gap:10px;flex-wrap:wrap;}
    .stat-chip{display:inline-flex;align-items:center;gap:4px;background:#e3f2fd;border:2px solid #1976d2;border-radius:0;padding:4px 8px;font-size:11px;color:#0d47a1;font-weight:700;}
    .test-chip{display:inline-flex;align-items:center;background:rgba(16,185,129,.16);border:1px solid rgba(16,185,129,.55);color:#d1fae5;border-radius:8px;padding:8px 12px;font-size:12px;font-weight:700;}
    .hyp-card{border:2px solid #5c6bc0;border-radius:0;padding:8px 10px;background:#ffffff;}
    .hyp-row{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;}

    .hyp-main{font-size:15px;font-weight:700;color:#283593;white-space:nowrap;min-width:240px;}
    .hyp-block{display:flex;align-items:center;gap:10px;white-space:nowrap;}
    .hyp-h1-label{font-size:12px;color:#37474f;font-weight:800;text-transform:uppercase;letter-spacing:.2px;}
    .hyp-options{display:flex;align-items:center;gap:12px;white-space:nowrap;}
    .hyp-delta{font-weight:800;color:#93c5fd;}
    .alpha-wrap{min-width:280px;max-width:340px;}
    .alpha-wrap label{font-size:11px;color:#37474f;font-weight:800;text-transform:uppercase;}
    #setAlpha{height:4px;opacity:.78;accent-color:#3949ab;max-width:211px;}
    .hyp-h1-label{
  font-size:11px;
  color:#37474f;
  font-weight:800;
  text-transform:uppercase;
  letter-spacing:.3px;
  margin-bottom:4px;
}
/* Descriptive Stats Tab Styles */
.desc-table-wrap{max-height:240px;overflow:auto;border:1px solid var(--border);border-radius:6px;background:var(--surface-2);margin-bottom:12px;}
#desc-stats-table{width:100%;min-width:820px;border-collapse:collapse;table-layout:auto;}
#desc-stats-table th,#desc-stats-table td{padding:6px 8px;border:1px solid rgba(255,255,255,.18);box-sizing:border-box;text-align:right;font-size:10px;line-height:16px;height:30px;white-space:nowrap;}
#desc-stats-table th:first-child,#desc-stats-table td:first-child{text-align:left;min-width:120px;max-width:180px;overflow:hidden;text-overflow:ellipsis;}
#desc-stats-table thead th{background:#003366cc;color:#fff;z-index:2;cursor:pointer;}
#desc-stats-table tbody tr:nth-child(even) td{background:rgba(255,255,255,.05)}
#desc-stats-table tbody tr:hover td{background:rgba(255,221,87,.18)}
#desc-stats-table tbody tr.selected td{background:rgba(255,165,120,.3)}
#histogram-container-two{height:240px;margin-top:12px;}
.histogram-bar{fill:#74b9ff;stroke:#0984e3;stroke-width:1px;}
.histogram-bar:hover{fill:#0984e3;}
.normal-curve{fill:none;stroke:yellow;stroke-width:2px;stroke-dasharray:5,5;}
.axis text{fill:white;font-size:10px;}
.axis path,.axis line{stroke:#999;}
.grid line{stroke:#555;stroke-opacity:0.7;shape-rendering:crispEdges;}
.grid path{stroke-width:0;}
.desc-summary-stats{display:grid;grid-template-columns:1fr 1fr;gap:6px;padding:10px;background:rgba(255,255,255,.04);border:1px solid var(--border);border-radius:6px;font-size:11px;}
.desc-summary-stats div{display:flex;justify-content:space-between;padding:3px 0;border-bottom:1px solid rgba(255,255,255,.08);}
.desc-summary-stats div:last-child{border-bottom:none;}
.desc-summary-stats strong{color:var(--text-secondary);}
.desc-summary-stats span{color:var(--accent-2);font-weight:700;}
.modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(0,0,0,0.8);z-index:1000;backdrop-filter:blur(3px);display:flex;align-items:center;justify-content:center;}
.modal-content{background:var(--surface-1);border:2px solid var(--border);border-radius:8px;padding:20px;max-width:800px;max-height:80vh;overflow-y:auto;box-shadow:0 8px 32px rgba(0,0,0,0.5);}
.modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;border-bottom:2px solid var(--accent-1);padding-bottom:10px;}
.modal-title{font-size:18px;font-weight:700;color:var(--accent-1);}
.modal-close{background:none;border:none;color:#fff;font-size:24px;cursor:pointer;padding:0;width:30px;height:30px;}
.modal-close:hover{color:var(--accent-1);}
.modal-body{color:var(--text-secondary);line-height:1.8;font-size:13px;white-space:pre-wrap;}

  </style>
</head>
<body>
  <div class="wrap">
    <section class="card">
      <div class="hero-section">
        <div class="hero-content">
          <div class="hero-title"><span>Paired Samples Module</span></div>
          <div class="hero-controls">
            <button class="hero-action-btn" onclick="generateAISummary()" title="Generate AI statistical summary from all results" id="aiSummaryBtn">
              <i class="fa-solid fa-brain"></i> AI Summary
            </button>
            <button class="hero-action-btn" onclick="saveCurrentModel()" title="Save model configuration to Excel workbook">
              <i class="fa-solid fa-floppy-disk"></i> Model
            </button>
            <button class="hero-action-btn" onclick="exportHtml()" title="Export complete report as standalone HTML file">
              <i class="fa-solid fa-floppy-disk"></i> HTML
            </button>
          </div>
        </div>
        <div class="tab-navigation">
          <button class="tab-button active" data-tab="explore"><i class="fa-solid fa-chart-column"></i> Explore</button>
          <button class="tab-button" data-tab="assumptions"><i class="fa-solid fa-shield-halved"></i> Assumptions</button>
          <button class="tab-button" data-tab="results"><i class="fa-solid fa-square-poll-vertical"></i> Results</button>
          <button class="tab-button" data-tab="effects"><i class="fa-solid fa-wave-square"></i> Effects</button>
          <button class="tab-button" data-tab="power"><i class="fa-solid fa-bolt"></i> Power</button>
          <button class="tab-button" data-tab="report"><i class="fa-solid fa-file-lines"></i> Report</button>
          <div class="tab-controls-right">
            <label for="decimalSelect">Decimals:</label>
            <select id="decimalSelect" class="tab-decimal-select" onchange="setDecimalPrecision()">
              <option value="auto">Auto</option><option value="0">0</option><option value="1">1</option><option value="2" selected>2</option><option value="3">3</option><option value="4">4</option>
            </select>
          </div>
        </div>

        <div class="settings-bar">
  <div class="settings-panel-title">Test Configuration Panel</div>
  <div class="settings-grid">








    <!-- Comparison chips + design message -->
    <div style="grid-column:1/-1;">
      <div class="hdr-row" id="compareStatsRow"></div>
      <div id="designMessageRow" class="design-warning" style="display:none;"></div>
    </div>

    <!-- Inference + Test method (side by side, clearly separated) -->
    <div style="grid-column:1/-1;">
      <div class="hdr-row">
        <div class="inference-row" style="gap:28px;">

          <!-- Inference Type (left) -->
          <div class="inference-card" style="flex:0 0 auto;">
            <div class="inference-title">Inference type</div>
            <div class="fw-radio-group" role="radiogroup" aria-label="Inference type">
              <input id="fwParametric" type="radio" name="frameworkMode" value="parametric" checked/>
              <label for="fwParametric" id="setFrameworkParam" class="fw-radio active">Parametric (means)</label>
              <input id="fwNonparametric" type="radio" name="frameworkMode" value="nonparametric"/>
              <label for="fwNonparametric" id="setFrameworkNon" class="fw-radio">Non-parametric (ranks)</label>
            </div>
          </div>

          <!-- Test Method (right) -->
          <div class="inference-card" id="primaryTestWrap" style="flex:1 1 auto;min-width:280px;">
            <div class="inference-title">Test method</div>
            <select id="setPrimaryTest" style="width:100%;height:42px;font-size:14px;padding:0 12px;border-radius:10px;border:1px solid rgba(120,200,255,.45);background:rgba(15,23,42,.95);color:#fff;font-weight:600;">
              <option value="paired">Paired t-test (recommended)</option>
              <option value="wilcoxon">Wilcoxon signed-rank test</option>
            </select>
          </div>

          <!-- Post-hoc controls (visible only for k+ groups) -->
          <div id="setPosthocWrap" style="display:none;flex:0 0 auto;">
            <label for="setPosthocMethod">Post-hoc</label>
            <select id="setPosthocMethod">
              <option value="games-howell">Games-Howell</option>
              <option value="tukey">Tukey HSD</option>
              <option value="dunn">Dunn</option>
              <option value="conover">Conover</option>
            </select>
          </div>

          <div id="setCorrectionWrap" style="display:none;flex:0 0 auto;">
            <label for="setPosthocCorrection">p Correction</label>
            <select id="setPosthocCorrection">
              <option value="holm">Holm</option>
              <option value="bh">Benjamini-Hochberg</option>
              <option value="bonferroni">Bonferroni</option>
              <option value="none">None</option>
            </select>
          </div>

        </div>
      </div>
    </div>

    <!-- (Removed from original position) -->

    <!-- Hypothesis + alpha (compact, less clutter) -->
    <div id="setHypWrap" style="grid-column:1/-1;">
      <div class="hyp-card">
        <div class="hyp-row">

          <div class="hyp-block hyp-main">
            <strong>H0:</strong> <span id="h0Text">Mean change = 0</span>
          </div>

          <div class="hyp-block">

  <div class="hyp-h1-label">Alternative (H1)</div>

  <div class="hbox-row hyp-options" id="h1Row">
    <label class="h-radio">
      <input type="radio" name="h1Orientation" value="less"/>
      Change &lt; 0
    </label>

    <label class="h-radio">
      <input type="radio" name="h1Orientation" value="two-sided" checked/>
      Change â‰  0
    </label>

    <label class="h-radio">
      <input type="radio" name="h1Orientation" value="greater"/>
      Change &gt; 0
    </label>
  </div>

</div>



          <div class="alpha-wrap">
            <label for="setAlpha" style="font-size:10px;opacity:0.75;">
              Significance: <span id="alphaVal">0.050</span>
            </label>
            <input id="setAlpha" type="range" min="0.001" max="0.2" step="0.001" value="0.05" style="height:3px;"/>
          </div>

        </div>
      </div>
    </div>

  </div>
</div>


        
      <div class="view-container">
        <section id="tab-setup" class="tab-panel">
          <div class="stats-container">
            <div class="stat-panel"><div class="stat-panel-heading">Model Setup</div><div class="stat-panel-body">
              <div class="stat-field"><span class="stat-label">Mode</span><span class="stat-value" id="setupMode">...</span></div>
              <div class="stat-field"><span class="stat-label">Hypothesis</span><span class="stat-value" id="setupHypothesis">...</span></div>
              <div class="stat-field"><span class="stat-label">Confidence</span><span class="stat-value" id="setupConfidence">...</span></div>
            </div></div>
          </div>
        </section>
        <section id="tab-explore" class="tab-panel active">
          <!-- Descriptive Statistics with integrated summary info -->
          <div class="stat-panel">
            <div class="stat-panel-heading">Descriptive Statistics</div>
            <div style="padding:6px 10px;background:rgba(255,165,120,.08);border-bottom:1px solid var(--border);display:flex;flex-wrap:wrap;gap:8px;font-size:11px;align-items:center;">
              <span style="color:var(--text-secondary);"><strong>Variables:</strong> <span id="expVarCount" style="color:var(--accent-2);font-weight:700;">2</span></span>
              <span style="color:var(--text-secondary);"><strong>Total N:</strong> <span id="expTotalN" style="color:var(--accent-2);font-weight:700;">...</span></span>
              <span style="color:var(--text-secondary);"><strong>Overall xÌ„:</strong> <span id="expOverallMean" style="color:var(--accent-2);font-weight:700;">...</span></span>
              <span style="color:var(--text-secondary);"><strong>Framework:</strong> <span id="expFramework" style="color:var(--accent-2);font-weight:700;">...</span></span>
            </div>
            <div class="stat-panel-body">
              <div class="desc-table-wrap">
                <table id="desc-stats-table">
                  <colgroup>
                    <col style="min-width: 140px; max-width: 200px;">
                    <col style="min-width: 70px;">
                    <col style="min-width: 90px;">
                    <col style="min-width: 90px;">
                    <col style="min-width: 90px;">
                    <col style="min-width: 90px;">
                    <col style="min-width: 90px;">
                    <col style="min-width: 80px;">
                    <col style="min-width: 80px;">
                  </colgroup>
                  <thead>
                    <tr>
                      <th style="text-align:left;cursor:pointer">Variable</th>
                      <th>N</th>
                      <th>Mean</th>
                      <th>StdDev</th>
                      <th>Min</th>
                      <th>Median</th>
                      <th>Max</th>
                      <th>Skew</th>
                      <th>Kurt</th>
                    </tr>
                  </thead>
                  <tbody id="desc-stats-body"></tbody>
                </table>
              </div>
              
              <div style="display:none;" id="desc-histogram-panel">
                <div style="font-weight:700;margin:16px 0 8px;color:var(--accent-1);display:flex;justify-content:space-between;align-items:center;">
                  <span>Distribution: <span id="desc-histogram-title">Select a variable</span></span>
                </div>
                <div style="display:grid;grid-template-columns:2fr 1fr;gap:16px;">
                  <div id="histogram-container-two"></div>
                  <div>
                    <div class="desc-summary-stats" id="desc-summary-table"></div>
                    <div style="margin-top:12px;padding:8px;background:rgba(255,165,120,.08);border:1px solid rgba(255,165,120,.3);border-radius:6px;">
                      <div style="font-size:10px;font-weight:700;color:var(--accent-1);margin-bottom:6px;">Normality Assessment</div>
                      <div id="normalityInfo" style="font-size:10px;color:var(--text-secondary);line-height:1.6;"></div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>
        <section id="tab-assumptions" class="tab-panel">
          <div class="stats-container"><div class="stat-panel"><div class="stat-panel-heading">Diagnostics</div><div class="stat-panel-body">
            <div class="stat-field"><span class="stat-label">Normality A</span><span class="stat-value" id="asNormA">...</span></div>
            <div class="stat-field"><span class="stat-label">Normality B</span><span class="stat-value" id="asNormB">...</span></div>
            <div class="stat-field"><span class="stat-label">Equal Variance</span><span class="stat-value" id="asEqVar">...</span></div>
            <div class="stat-field"><span class="stat-label">Recommendation</span><span class="stat-value" id="asReco">...</span></div>
          </div></div></div>
        </section>
        <section id="tab-results" class="tab-panel">
          <div class="stats-container">
            <div class="stat-panel"><div class="stat-panel-heading">Primary Results</div><div class="stat-panel-body">
              <div class="stat-field">
                <span class="stat-label">Primary Framework</span><span class="stat-value" id="resPrimaryFramework">...</span>
              </div>
              <div class="stat-field"><span class="stat-label">Primary Test</span><span class="stat-value" id="resPrimaryTest">...</span></div>
              <div class="stat-field"><span class="stat-label">Test Rationale</span><span class="stat-value" id="resTestRationale" style="font-size:10px;background:rgba(255,165,120,.08);border-color:rgba(255,165,120,.3);">...</span></div>
              <div class="stat-field"><span class="stat-label">Statistic</span><span class="stat-value" id="resPrimaryStat">...</span></div>
              <div class="stat-field"><span class="stat-label">p-value</span><span class="stat-value" id="resPrimaryP">...</span></div>
              <div class="stat-field"><span class="stat-label">Decision</span><span class="stat-value" id="resDecision" style="font-weight:800;font-size:13px;">...</span></div>
              <div class="stat-field"><span class="stat-label">Mean Difference + 95% CI</span><span class="stat-value" id="resPrimaryEstimate">...</span></div>
              <div class="stat-field"><span class="stat-label">Effect Size (Hedges g)</span><span class="stat-value" id="resEffectSize" style="background:rgba(120,200,255,.15);border-color:rgba(120,200,255,.4);">...</span></div>
            </div></div>
            <div class="stat-panel secondary"><div class="stat-panel-heading">Robustness & Sensitivity Analysis</div><div class="stat-panel-body">
              <div class="stat-field"><span class="stat-label">Secondary Test</span><span class="stat-value" id="resSecondaryTest">...</span></div>
              <div class="stat-field"><span class="stat-label">Statistic</span><span class="stat-value" id="resSecondaryStat">...</span></div>
              <div class="stat-field"><span class="stat-label">p-value</span><span class="stat-value" id="resSecondaryP">...</span></div>
              <div class="stat-field"><span class="stat-label">Rank-biserial r</span><span class="stat-value" id="resRankBiserial">...</span></div>
              <div class="stat-field"><span class="stat-label">Agreement</span><span class="stat-value" id="resAgreement">...</span></div>
              <div class="stat-field"><span class="stat-label">Interpretation</span><span class="stat-value" id="resHint" style="font-size:10px;">...</span></div>
            </div></div>
          </div>
          <div class="stat-panel" style="margin-top:12px;">
            <div class="stat-panel-heading" style="display:flex;justify-content:space-between;align-items:center;">
              <span>Comparison of Means</span>
              <label style="display:flex;align-items:center;gap:6px;font-size:11px;font-weight:600;cursor:pointer;text-transform:none;">
                <input type="checkbox" id="showVarianceToggle" style="cursor:pointer;"/>
                <span>Assume Equal Variance</span>
              </label>
            </div>
            <div class="stat-panel-body">
              <div id="groupChart" style="height:300px;"></div>
            </div>
          </div>
          <div class="stat-panel" id="posthocPanel" style="margin-top:12px; display:none;">
            <div class="stat-panel-heading">Post-hoc Pairwise</div>
            <div class="stat-panel-body" style="padding:0;">
              <div class="table-container" style="margin:0;">
                <table class="analysis-table">
                  <thead><tr><th>Comparison</th><th>Statistic</th><th>Raw p</th><th>Adj p</th><th>Estimate</th></tr></thead>
                  <tbody id="posthocBody"><tr><td colspan="5">No post-hoc rows</td></tr></tbody>
                </table>
              </div>
            </div>
          </div>
        </section>
        <section id="tab-effects" class="tab-panel">
          <div class="stats-container"><div class="stat-panel"><div class="stat-panel-heading">Effect Sizes</div><div class="stat-panel-body">
            <div class="stat-field"><span class="stat-label">Hedges g</span><span class="stat-value" id="efG">...</span></div>
            <div class="stat-field"><span class="stat-label">Cliff's delta</span><span class="stat-value" id="efDelta">...</span></div>
            <div class="stat-field"><span class="stat-label">Rank-biserial</span><span class="stat-value" id="efRrb">...</span></div>
            <div class="stat-field"><span class="stat-label">P(X>Y)</span><span class="stat-value" id="efPs">...</span></div>
          </div></div></div>
        </section>
        <section id="tab-power" class="tab-panel">
          <div class="stats-container"><div class="stat-panel"><div class="stat-panel-heading">Power & Sample Size (Python)</div><div class="stat-panel-body">
            <div class="stat-field"><span class="stat-label">Status</span><span class="stat-value" id="powNote">...</span></div>
            <div class="stat-field"><span class="stat-label">Endpoint</span><span class="stat-value" id="powEndpoint">...</span></div>
            <div class="stat-field"><span class="stat-label">Placeholder Power</span><span class="stat-value" id="powVal">...</span></div>
          </div></div></div>
          <div class="section-note">Power is designed to call a Python service endpoint with exact/simulation routines.</div>
        </section>
        <section id="tab-report" class="tab-panel">
          <div class="stat-panel"><div class="stat-panel-heading">APA-ready Report</div><div class="stat-panel-body">
            <div id="repWelch"></div><br/><div id="repMw"></div><br/><div id="repCons"></div>
          </div></div>
        </section>
      </div>
    </section>
  </div>
  <script>
    let globalDecimalPrecision = "auto";
    let lastBundle = null;
    let primaryFramework = "parametric";
    let availableHeaders = [];
    let currentCompareMode = "two-vars";
    let currentHypothesis = "two-sided";
    let currentPrimaryTest = "welch";
    let persistedColumns = { groupA: "", groupB: "", valueColumn: "", groupColumn: "" };
    function parseMaybeNumber(v){ if(v===undefined||v===null) return NaN; const n=Number(String(v).replace(",",".")); return isFinite(n)?n:NaN; }
    function fmt(v){ const n=parseMaybeNumber(v); if(!isFinite(n)) return v==null?"...":String(v); if(globalDecimalPrecision==="auto"){ if(Math.abs(n)<1&&n!==0) return n.toFixed(4); return n.toFixed(2);} return n.toFixed(parseInt(globalDecimalPrecision,10)); }
    function fmtP(v){ const n=parseMaybeNumber(v); if(!isFinite(n)) return v==null?"...":String(v); if(n < 0.001) return "< 0.001"; return globalDecimalPrecision === "auto" ? n.toFixed(4) : n.toFixed(Math.max(3, parseInt(globalDecimalPrecision,10))); }
    function setDecimalPrecision(){ globalDecimalPrecision=(document.getElementById("decimalSelect")||{value:"auto"}).value; if(lastBundle) populateBundle(lastBundle); }
    function setText(id,val){ const el=document.getElementById(id); if(el) el.textContent = (val!==undefined&&val!==null&&val!=="")?val:"..."; }
    function switchTab(tab){ document.querySelectorAll(".tab-button").forEach(b=>b.classList.toggle("active",b.getAttribute("data-tab")===tab)); document.querySelectorAll(".tab-panel").forEach(p=>p.classList.toggle("active",p.id==="tab-"+tab)); }
    function sendToHost(cmd,data){ if(Office&&Office.context&&Office.context.ui&&Office.context.ui.messageParent) Office.context.ui.messageParent(JSON.stringify({action:"HOST_EVENT",cmd:cmd,data:data||{}})); }
    function fillSelect(id, options, selected){
      const el = document.getElementById(id);
      if (!el) return;
      el.innerHTML = (options || []).map(function(v){ return '<option value="' + v + '">' + v + '</option>'; }).join("");
      if (selected !== undefined && selected !== null && String(selected) !== "") el.value = String(selected);
    }
    function currentSettingsSpec(){
      var hChecked = document.querySelector('input[name="h1Orientation"]:checked');
      var h = hChecked ? hChecked.value : "two-sided";
      currentHypothesis = h;
      var alpha = Number((document.getElementById("setAlpha") || { value: "0.05" }).value || 0.05);
      if (!isFinite(alpha) || alpha <= 0 || alpha >= 1) alpha = 0.05;
      return {
        compareMode: currentCompareMode,
        primaryFramework: primaryFramework,
        hypothesis: h,
        confidence: 1 - alpha,
        groupA: persistedColumns.groupA || "",
        groupB: persistedColumns.groupB || "",
        valueColumn: persistedColumns.valueColumn || "",
        groupColumn: persistedColumns.groupColumn || "",
        primaryTest: (document.getElementById("setPrimaryTest") || {}).value || currentPrimaryTest || "welch",
        posthocMethod: (document.getElementById("setPosthocMethod") || {}).value || "games-howell",
        posthocCorrection: (document.getElementById("setPosthocCorrection") || {}).value || "holm"
      };
    }
    function refreshHypothesisFrames(){
      var h0 = document.getElementById("h0Text");
      var h1Row = document.getElementById("h1Row");
      var deltaToken = document.getElementById("deltaToken");
      if (!h0 || !h1Row) return;
      if (currentCompareMode === "k-plus") {
        h0.textContent = "All groups are equal";
        if (deltaToken) deltaToken.textContent = "Omnibus";
        h1Row.innerHTML = '<span style="color:#e5eefc;font-weight:700;">At least one group differs.</span>';
      } else {
        h0.textContent = "Difference = 0";
        if (deltaToken) deltaToken.textContent = "Î¼2-Î¼1";
        h1Row.innerHTML = '' +
          '<label class="h-radio"><input type="radio" name="h1Orientation" value="less"/> &lt; 0</label>' +
          '<label class="h-radio"><input type="radio" name="h1Orientation" value="two-sided" checked/> != 0</label>' +
          '<label class="h-radio"><input type="radio" name="h1Orientation" value="greater"/> &gt; 0</label>';
        var checkedVal = currentHypothesis || "two-sided";
        var checked = h1Row.querySelector('input[name="h1Orientation"][value="' + checkedVal + '"]');
        if (checked) checked.checked = true;
        h1Row.querySelectorAll('input[name="h1Orientation"]').forEach(function(el){ el.addEventListener("change", notifySettingsChanged); });
      }
    }
    function refreshSettingsVisibility(){
      const mode = currentCompareMode || "two-vars";
      const two = mode === "two-vars";
      const setDisplay = (id, show) => { const el = document.getElementById(id); if (el) el.style.display = show ? "flex" : "none"; };
      setDisplay("setPosthocWrap", !two); setDisplay("setCorrectionWrap", !two);
      setDisplay("setHypWrap", true);
      refreshHypothesisFrames();
    }
    function setFrameworkButtons(mode){
      primaryFramework = mode === "nonparametric" ? "nonparametric" : "parametric";
      var p = document.getElementById("setFrameworkParam");
      var n = document.getElementById("setFrameworkNon");
      if (p) p.classList.toggle("active", primaryFramework === "parametric");
      if (n) n.classList.toggle("active", primaryFramework === "nonparametric");
      var rp = document.getElementById("fwParametric");
      var rn = document.getElementById("fwNonparametric");
      if (rp) rp.checked = primaryFramework === "parametric";
      if (rn) rn.checked = primaryFramework === "nonparametric";
      var primaryTestWrap = document.getElementById("primaryTestWrap");
      if (primaryTestWrap) primaryTestWrap.style.display = "flex";
      var testSel = document.getElementById("setPrimaryTest");
      testSel.className = primaryFramework === "nonparametric" ? "nonparametric" : "parametric";
      document.querySelectorAll(".stat-panel-heading").forEach(function(h){
        h.classList.remove("parametric", "nonparametric");
        h.classList.add(primaryFramework);
      });
      var testBadge = document.getElementById("currentTestBadge");
      var compareMode = currentCompareMode || "two-vars";
      if (testSel) {
        var options = [];
        if (compareMode === "k-plus") {
          options = primaryFramework === "nonparametric"
            ? [{ v: "kruskal", t: "Kruskal-Wallis" }]
            : [{ v: "anova", t: "One-way ANOVA" }];
        } else if (primaryFramework === "nonparametric") {
          options = [{ v: "wilcoxon", t: "Wilcoxon signed-rank" }];
        } else {
          options = [
            { v: "paired", t: "Paired t-test" }
          ];
        }
        testSel.innerHTML = options.map(function(o){ return '<option value="' + o.v + '">' + o.t + '</option>'; }).join("");
        var hasCurrent = options.some(function(o){ return o.v === currentPrimaryTest; });
        currentPrimaryTest = hasCurrent ? currentPrimaryTest : options[0].v;
        testSel.value = currentPrimaryTest;
        testSel.disabled = options.length === 1;
      }
      if (testBadge) {
        var text = "Paired t-test";
        if (compareMode === "k-plus") {
          text = primaryFramework === "nonparametric" ? "Friedman test" : "Repeated Measures ANOVA";
        } else if (primaryFramework === "nonparametric") {
          text = "Wilcoxon signed-rank";
        } else if (currentPrimaryTest === "paired") {
          text = "Paired t-test";
        }
        testBadge.textContent = "Test: " + text;
      }
      refreshHypothesisFrames();
    }
    function notifySettingsChanged(){
      const spec = currentSettingsSpec();
      refreshSettingsVisibility();
      var alphaVal = document.getElementById("alphaVal");
      if (alphaVal) alphaVal.textContent = (1 - (spec.confidence || 0.95)).toFixed(3);
      sendToHost("dependentSettingsChanged", spec);
    }
    function renderCompareStatsRow(s, e){
      var host = document.getElementById("compareStatsRow");
      var msgHost = document.getElementById("designMessageRow");
      if (!host) return;
      host.innerHTML = "";
      if (msgHost) { msgHost.textContent = ""; msgHost.style.display = "none"; }
      var mode = s.compareMode || "two-vars";
      if (mode === "two-vars") {
        var aName = s.groupA || "u1";
        var bName = s.groupB || "u2";
        var chips = [
          "Group A: " + aName + " (n=" + (e.n1 || 0) + ", Î¼=" + fmt(e.mean1) + ")",
          "Group B: " + bName + " (n=" + (e.n2 || 0) + ", Î¼=" + fmt(e.mean2) + ")"
        ];
        chips.forEach(function(txt){
          var sp = document.createElement("span");
          sp.className = "stat-chip";
          sp.textContent = txt;
          host.appendChild(sp);
        });
      } else {
        var ksum = e.kplusSummary || {};
        var valueName = ksum.valueColumn || s.valueColumn || "Value";
        var groupName = ksum.groupColumn || s.groupColumn || "Group";
        var totalN = isFinite(parseMaybeNumber(ksum.totalN)) ? parseMaybeNumber(ksum.totalN) : "?";
        var meanOverall = isFinite(parseMaybeNumber(ksum.meanOverall)) ? fmt(ksum.meanOverall) : "?";
        var levelsCount = isFinite(parseMaybeNumber(ksum.levelsCount)) ? parseMaybeNumber(ksum.levelsCount) : ((s.groupLevels || []).length || "?");

        var valueChip = document.createElement("span");
        valueChip.className = "stat-chip";
        valueChip.textContent = valueName + " (n=" + totalN + ", Î¼=" + meanOverall + ")";
        valueChip.style.fontSize = "11px";
        host.appendChild(valueChip);

        var groupChip = document.createElement("span");
        groupChip.className = "stat-chip";
        groupChip.textContent = groupName + " (levels=" + levelsCount + ")";
        groupChip.style.fontSize = "11px";
        host.appendChild(groupChip);
      }
      var design = s.designValidation || {};
      if (msgHost) {
        if (design.message) {
          msgHost.textContent = design.message;
          msgHost.style.display = "block";
        } else {
          msgHost.textContent = "";
          msgHost.style.display = "none";
        }
      }
    }
    function updateResultsPanels(r, fx, s, a){
      setText("resPrimaryFramework", primaryFramework === "nonparametric" ? "Nonparametric (ranks)" : "Parametric (means)");
      const alpha = isFinite(parseMaybeNumber(a)) ? parseMaybeNumber(a) : (1 - (parseMaybeNumber(s && s.confidence) || 0.95));
      if (s && s.compareMode === "k-plus" && r && r.omnibus) {
        const ob = r.omnibus;
        const paramPrimary = primaryFramework !== "nonparametric";
        if (paramPrimary) {
          setText("resPrimaryTest", "One-way ANOVA");
          setText("resPrimaryStat", "F(" + fmt(ob.anovaDf1) + ", " + fmt(ob.anovaDf2) + ") = " + fmt(ob.anovaF));
          setText("resPrimaryP", fmtP(ob.anovaP));
          setText("resPrimaryEstimate", "Omnibus effect across " + fmt(ob.levels ? ob.levels.length : 0) + " groups");
          setText("resSecondaryTest", "Kruskal-Wallis");
          setText("resSecondaryStat", "H(" + fmt(ob.kwDf) + ") = " + fmt(ob.kwH));
          setText("resSecondaryP", fmtP(ob.kwP));
        } else {
          setText("resPrimaryTest", "Kruskal-Wallis");
          setText("resPrimaryStat", "H(" + fmt(ob.kwDf) + ") = " + fmt(ob.kwH));
          setText("resPrimaryP", fmtP(ob.kwP));
          setText("resPrimaryEstimate", "Distribution shift across " + fmt(ob.levels ? ob.levels.length : 0) + " groups");
          setText("resSecondaryTest", "One-way ANOVA");
          setText("resSecondaryStat", "F(" + fmt(ob.anovaDf1) + ", " + fmt(ob.anovaDf2) + ") = " + fmt(ob.anovaF));
          setText("resSecondaryP", fmtP(ob.anovaP));
        }
        const agreeElK = document.getElementById("resAgreement");
        const aSig = parseMaybeNumber(ob.anovaP) < alpha;
        const kSig = parseMaybeNumber(ob.kwP) < alpha;
        if (aSig === kSig) {
          setText("resAgreement", "Agree at alpha");
          if (agreeElK) agreeElK.className = "stat-value agreement-good";
          setText("resHint", "Omnibus conclusions are consistent across frameworks.");
        } else {
          setText("resAgreement", "Disagree at alpha");
          if (agreeElK) agreeElK.className = "stat-value agreement-warn";
          setText("resHint", "Consider non-normality/heteroscedasticity and run post-hoc with correction.");
        }
        return;
      }
      const welchSig = parseMaybeNumber(r.welchP) < alpha;
      const mwSig = parseMaybeNumber(r.mwP) < alpha;
      const primaryParametric = primaryFramework !== "nonparametric";

      // Determine primary p-value and decision
      let primaryP = 0;
      if (primaryParametric) {
        const chosen = currentPrimaryTest || "welch";
        primaryP = chosen === "student" ? r.studentP : (chosen === "permutation" ? r.permutationP : r.welchP);
      } else {
        primaryP = r.mwP;
      }
      
      // Set decision
      const pVal = parseMaybeNumber(primaryP);
      const decisionEl = document.getElementById("resDecision");
      if (isFinite(pVal)) {
        if (pVal < alpha) {
          setText("resDecision", "âœ“ Reject Hâ‚€ (significant difference)");
          if (decisionEl) {
            decisionEl.style.color = "#4ade80";
            decisionEl.style.background = "rgba(74,222,128,.12)";
            decisionEl.style.borderColor = "rgba(74,222,128,.32)";
          }
        } else {
          setText("resDecision", "âœ— Fail to reject Hâ‚€ (no significant difference)");
          if (decisionEl) {
            decisionEl.style.color = "#fbbf24";
            decisionEl.style.background = "rgba(251,191,36,.12)";
            decisionEl.style.borderColor = "rgba(251,191,36,.32)";
          }
        }
      } else {
        setText("resDecision", "...");
      }

      if (primaryParametric) {
        const chosen = currentPrimaryTest || "paired";
        
        // Set test rationale
        if (chosen === "paired") {
          setText("resTestRationale", "Parametric test for within-subject differences");
        } else {
          setText("resTestRationale", "Non-parametric test for paired ordinal/skewed data");
        }
        
        setText("resPrimaryTest", "Paired t-test");
        setText("resPrimaryStat", "t(" + fmt(r.pairedDf || r.welchDf) + ") = " + fmt(r.pairedT || r.welchT));
        setText("resPrimaryP", fmtP(r.pairedP || r.welchP));
        setText("resPrimaryEstimate", fmt(r.meanDiff) + " [" + fmt(r.ciLow) + ", " + fmt(r.ciHigh) + "]");
        
        // Effect size
        const hedgesG = parseMaybeNumber(fx.hedgesG);
        let effectLabel = "";
        if (isFinite(hedgesG)) {
          const absG = Math.abs(hedgesG);
          if (absG < 0.2) effectLabel = " (negligible)";
          else if (absG < 0.5) effectLabel = " (small)";
          else if (absG < 0.8) effectLabel = " (medium)";
          else effectLabel = " (large)";
        }
        setText("resEffectSize", fmt(fx.hedgesG) + effectLabel);
        
        setText("resSecondaryTest", "Wilcoxon signed-rank (rank-based)");
        setText("resSecondaryStat", "W = " + fmt(r.wilcoxonW || r.u));
        setText("resSecondaryP", fmtP(r.wilcoxonP || r.mwP));
        setText("resRankBiserial", fmt(fx.rankBiserial));
      } else {
        setText("resTestRationale", "Non-parametric test for paired ordinal/skewed data");
        setText("resPrimaryTest", "Wilcoxon signed-rank");
        setText("resPrimaryStat", "W = " + fmt(r.wilcoxonW || r.u));
        setText("resPrimaryP", fmtP(r.wilcoxonP || r.mwP));
        setText("resPrimaryEstimate", "Median change = " + fmt(r.medianDiff || 0));
        const rankBis = parseMaybeNumber(fx.rankBiserial);
        let rbLabel = "";
        if (isFinite(rankBis)) {
          const absRb = Math.abs(rankBis);
          if (absRb < 0.1) rbLabel = " (negligible)";
          else if (absRb < 0.3) rbLabel = " (small)";
          else if (absRb < 0.5) rbLabel = " (medium)";
          else rbLabel = " (large)";
        }
        setText("resEffectSize", fmt(fx.rankBiserial) + rbLabel);
        setText("resSecondaryTest", "Paired t-test (parametric)");
        setText("resSecondaryStat", "t(" + fmt(r.pairedDf || r.welchDf) + ") = " + fmt(r.pairedT || r.welchT));
        setText("resSecondaryP", fmtP(r.pairedP || r.welchP));
        setText("resRankBiserial", fmt(fx.rankBiserial) + rbLabel);
      }

      const agreeEl = document.getElementById("resAgreement");
      if (welchSig === mwSig) {
        setText("resAgreement", "âœ“ Consistent");
        if (agreeEl) agreeEl.className = "stat-value agreement-good";
        setText("resHint", "Robust conclusion: both parametric and non-parametric tests agree.");
      } else {
        setText("resAgreement", "âš  Divergent");
        if (agreeEl) agreeEl.className = "stat-value agreement-warn";
        setText("resHint", "Tests disagree. Check assumptions (normality, outliers, equal variance).");
      }
    }
    function renderPosthoc(posthoc, compareMode){
      const panel = document.getElementById("posthocPanel");
      const body = document.getElementById("posthocBody");
      if (!panel || !body) return;
      if (compareMode !== "k-plus" || !posthoc || !posthoc.enabled) {
        panel.style.display = "none";
        body.innerHTML = '<tr><td colspan="5">No post-hoc rows</td></tr>';
        return;
      }
      panel.style.display = "block";
      const rows = posthoc.rows || [];
      if (!rows.length) {
        body.innerHTML = '<tr><td colspan="5">No post-hoc rows</td></tr>';
        return;
      }
      body.innerHTML = "";
      rows.forEach(function(r){
        const tr = document.createElement("tr");
        [r.comparison, r.statistic, fmtP(r.rawP), fmtP(r.adjP), fmt(r.estimate)].forEach(function(v){
          const td = document.createElement("td");
          td.textContent = v;
          tr.appendChild(td);
        });
        body.appendChild(tr);
      });
    }

    function populateBundle(b){
      lastBundle = b || {};
      const s=b.setup||{}, e=b.explore||{}, a=b.assumptions||{}, r=b.results||{}, fx=b.effects||{}, p=b.power||{}, rep=b.report||{};
      if ((s.compareMode === "k-plus" || s.mode === "k-plus") && window.location.pathname.indexOf("dependent-results-kplus.html") === -1) {
        var next = window.location.href.replace("dependent-results.html", "dependent-results-kplus.html");
        window.location.replace(next);
        return;
      }
      availableHeaders = Array.isArray(s.headers) ? s.headers.slice() : availableHeaders;
      persistedColumns.groupA = s.groupA || persistedColumns.groupA;
      persistedColumns.groupB = s.groupB || persistedColumns.groupB;
      persistedColumns.valueColumn = s.valueColumn || persistedColumns.valueColumn;
      persistedColumns.groupColumn = s.groupColumn || persistedColumns.groupColumn;
      currentCompareMode = s.compareMode || currentCompareMode || "two-vars";
      currentPrimaryTest = s.primaryTest || currentPrimaryTest || "welch";
      var testSel = document.getElementById("setPrimaryTest");
      if (testSel) testSel.value = currentPrimaryTest;
      setFrameworkButtons(s.primaryFramework || primaryFramework);
      var alphaEl = document.getElementById("setAlpha");
      if (alphaEl) alphaEl.value = String(1 - (parseMaybeNumber(s.confidence) || 0.95));
      var orientation = s.hypothesis || "two-sided";
      currentHypothesis = orientation;
      var radio = document.querySelector('input[name="h1Orientation"][value="' + orientation + '"]');
      if (radio) radio.checked = true;
      const phm = document.getElementById("setPosthocMethod"); if (phm) phm.value = s.posthocMethod || "games-howell";
      const phc = document.getElementById("setPosthocCorrection"); if (phc) phc.value = s.posthocCorrection || "holm";
      renderCompareStatsRow(s, e);
      refreshSettingsVisibility();
      setText("setupMode", s.mode); setText("setupHypothesis", s.hypothesis); setText("setupConfidence", (s.confidence?fmt(100*s.confidence):"...")+"%");
      setText("expN", `${e.n1||0} / ${e.n2||0}`); setText("expMean", `${fmt(e.mean1)} / ${fmt(e.mean2)}`); setText("expMed", `${fmt(e.med1)} / ${fmt(e.med2)}`); setText("expSd", `${fmt(e.sd1)} / ${fmt(e.sd2)}`); setText("expIqr", `${fmt(e.iqr1)} / ${fmt(e.iqr2)}`);
      setText("asNormA", a.normalityA); setText("asNormB", a.normalityB); setText("asEqVar", a.equalVariance); setText("asReco", a.recommendation);
      updateResultsPanels(r, fx, s, 1 - (parseMaybeNumber(s.confidence) || 0.95));
      renderPosthoc(r.posthoc || {}, s.compareMode || "two-vars");
      setText("efG", fmt(fx.hedgesG)); setText("efDelta", fmt(fx.cliffsDelta)); setText("efRrb", fmt(fx.rankBiserial)); setText("efPs", fmt(fx.probabilitySuperiority));
      setText("powNote", p.note); setText("powEndpoint", p.suggestedEndpoint); setText("powVal", fmt(p.placeholderPower));
      setText("repWelch", "Welch: t(" + fmt(r.welchDf) + ")=" + fmt(r.welchT) + ", p " + fmtP(r.welchP) + ", mean diff " + fmt(r.meanDiff) + " [" + fmt(r.ciLow) + ", " + fmt(r.ciHigh) + "].");
      setText("repMw", "Mann-Whitney: U=" + fmt(r.u) + ", p " + fmtP(r.mwP) + ", rank-biserial " + fmt(fx.rankBiserial) + ".");
      setText("repCons", rep.consistency);
      
      // Update descriptive stats table
      populateDescriptiveStats(s, e);
      
      // Update chart
      updateGroupChart();
    }
    
    function populateDescriptiveStats(s, e) {
      const body = document.getElementById('desc-stats-body');
      if (!body) return;
      
      body.innerHTML = '';
      
      const groupAName = s.groupA || 'Group A';
      const groupBName = s.groupB || 'Group B';
      
      // Calculate skewness and kurtosis (basic estimators)
      function calcSkew(mean, sd, n) {
        // Placeholder - would need raw data for accurate calculation
        return '...';
      }
      
      function calcKurt(mean, sd, n) {
        // Placeholder - would need raw data for accurate calculation
        return '...';
      }
      
      // Create rows for each group
      const groups = [
        {
          name: groupAName,
          n: e.n1 || 0,
          mean: e.mean1,
          sd: e.sd1,
          min: e.min1,
          median: e.med1,
          max: e.max1
        },
        {
          name: groupBName,
          n: e.n2 || 0,
          mean: e.mean2,
          sd: e.sd2,
          min: e.min2,
          median: e.med2,
          max: e.max2
        }
      ];
      
      let descSelectedRow = null;
      
      groups.forEach(function(grp, idx) {
        const tr = document.createElement('tr');
        tr.style.cursor = 'pointer';
        
        const cells = [
          grp.name,
          grp.n,
          fmt(grp.mean),
          fmt(grp.sd),
          fmt(grp.min),
          fmt(grp.median),
          fmt(grp.max),
          calcSkew(grp.mean, grp.sd, grp.n),
          calcKurt(grp.mean, grp.sd, grp.n)
        ];
        
        cells.forEach(function(val, cellIdx) {
          const td = document.createElement('td');
          td.textContent = val;
          if (cellIdx === 0) td.style.textAlign = 'left';
          tr.appendChild(td);
        });
        
        // Add click handler for histogram
        tr.addEventListener('click', function() {
          document.querySelectorAll('#desc-stats-body tr').forEach(function(r) {
            r.classList.remove('selected');
          });
          tr.classList.add('selected');
          selectDescRow(grp);
        });
        
        body.appendChild(tr);
      });
      
      // Update summary info
      const totalN = (e.n1 || 0) + (e.n2 || 0);
      const mean1 = parseMaybeNumber(e.mean1) || 0;
      const mean2 = parseMaybeNumber(e.mean2) || 0;
      const n1 = parseMaybeNumber(e.n1) || 0;
      const n2 = parseMaybeNumber(e.n2) || 0;
      const overallMean = totalN > 0 ? (mean1 * n1 + mean2 * n2) / totalN : 0;
      
      setText('expTotalN', totalN);
      setText('expOverallMean', fmt(overallMean));
      setText('expFramework', primaryFramework === 'nonparametric' ? 'Non-parametric (ranks)' : 'Parametric (means)');
    }
    
    function selectDescRow(grp) {
      const panel = document.getElementById('desc-histogram-panel');
      const title = document.getElementById('desc-histogram-title');
      const summaryTable = document.getElementById('desc-summary-table');
      const normalityInfo = document.getElementById('normalityInfo');
      
      if (panel) panel.style.display = 'block';
      if (title) title.textContent = grp.name;
      
      // Update summary table
      if (summaryTable) {
        summaryTable.innerHTML = `
          <div><strong>N:</strong><span>${grp.n}</span></div>
          <div><strong>Mean:</strong><span>${fmt(grp.mean)}</span></div>
          <div><strong>StdDev:</strong><span>${fmt(grp.sd)}</span></div>
          <div><strong>Min:</strong><span>${fmt(grp.min)}</span></div>
          <div><strong>Median:</strong><span>${fmt(grp.median)}</span></div>
          <div><strong>Max:</strong><span>${fmt(grp.max)}</span></div>
        `;
      }
      
      // Normality assessment based on sample size and available info
      if (normalityInfo) {
        const n = grp.n || 0;
        let assessment = '';
        
        if (n < 20) {
          assessment = `<strong>âš  Small sample (n=${n})</strong><br/>` +
                      `â€¢ Normality tests have low power<br/>` +
                      `â€¢ Visual inspection recommended<br/>` +
                      `â€¢ Consider non-parametric tests`;
        } else if (n < 30) {
          assessment = `<strong>âš  Moderate sample (n=${n})</strong><br/>` +
                      `â€¢ Visual inspection important<br/>` +
                      `â€¢ Check for outliers and skewness<br/>` +
                      `â€¢ Parametric tests reasonably robust`;
        } else if (n < 50) {
          assessment = `<strong>âœ“ Good sample size (n=${n})</strong><br/>` +
                      `â€¢ Central Limit Theorem applies<br/>` +
                      `â€¢ Parametric tests robust to mild violations<br/>` +
                      `â€¢ Check for extreme outliers`;
        } else {
          assessment = `<strong>âœ“ Large sample (n=${n})</strong><br/>` +
                      `â€¢ Parametric tests very robust<br/>` +
                      `â€¢ Normality assumption less critical<br/>` +
                      `â€¢ Focus on homogeneity of variance`;
        }
        
        normalityInfo.innerHTML = assessment;
      }
      
      // Render histogram (placeholder - would need raw data)
      renderDescHistogram(grp);
    }
    
    function renderDescHistogram(grp) {
      if (typeof d3 === 'undefined') return;
      
      const container = document.getElementById('histogram-container-two');
      if (!container) return;
      
      const width = container.clientWidth || 600;
      const height = 240;
      
      d3.select('#histogram-container-two').selectAll('*').remove();
      
      const svg = d3.select('#histogram-container-two')
        .append('svg')
        .attr('width', width)
        .attr('height', height);
      
      const margin = { top: 20, right: 25, bottom: 40, left: 50 };
      const innerWidth = width - margin.left - margin.right;
      const innerHeight = height - margin.top - margin.bottom;
      
      const g = svg.append('g')
        .attr('transform', `translate(${margin.left},${margin.top})`);
      
      // Get stats
      const mean = parseMaybeNumber(grp.mean);
      const sd = parseMaybeNumber(grp.sd);
      const min = parseMaybeNumber(grp.min);
      const max = parseMaybeNumber(grp.max);
      const median = parseMaybeNumber(grp.median);
      const n = grp.n || 0;
      
      if (!isFinite(mean) || !isFinite(sd) || sd <= 0 || !isFinite(min) || !isFinite(max)) {
        g.append('text')
          .attr('x', innerWidth / 2)
          .attr('y', innerHeight / 2)
          .attr('text-anchor', 'middle')
          .attr('fill', '#999')
          .style('font-size', '12px')
          .text('Insufficient data for distribution visualization');
        return;
      }
      
      // Create simulated histogram bins using normal distribution
      const xMin = Math.min(min, mean - 3.5 * sd);
      const xMax = Math.max(max, mean + 3.5 * sd);
      
      if (!isFinite(xMin) || !isFinite(xMax) || xMin >= xMax) return;
      
      const xScale = d3.scaleLinear()
        .domain([xMin, xMax])
        .range([0, innerWidth]);
      
      // Generate histogram bins (simulated from normal distribution)
      const numBins = 12;
      const binWidth = (xMax - xMin) / numBins;
      const histBins = [];
      
      for (let i = 0; i < numBins; i++) {
        const binStart = xMin + i * binWidth;
        const binEnd = binStart + binWidth;
        
        // Calculate expected frequency in this bin using normal CDF
        const zStart = (binStart - mean) / sd;
        const zEnd = (binEnd - mean) / sd;
        
        // Approximate CDF using error function approximation
        const cdf = (z) => 0.5 * (1 + Math.tanh(z * Math.sqrt(2 / Math.PI) * 0.7));
        const prob = cdf(zEnd) - cdf(zStart);
        const expectedCount = prob * n;
        
        if (isFinite(expectedCount)) {
          histBins.push({
            x: binStart,
            width: binWidth,
            height: expectedCount
          });
        }
      }
      
      if (histBins.length === 0) return;
      
      const yMax = d3.max(histBins, d => d.height);
      if (!isFinite(yMax) || yMax <= 0) return;
      
      const yScale = d3.scaleLinear()
        .domain([0, yMax * 1.15])
        .range([innerHeight, 0]);
      
      // Add grid
      g.append('g')
        .attr('class', 'grid')
        .attr('opacity', 0.1)
        .call(d3.axisLeft(yScale)
          .tickSize(-innerWidth)
          .tickFormat(''));
      
      // Draw histogram bars
      g.selectAll('.histogram-bar')
        .data(histBins)
        .enter()
        .append('rect')
        .attr('class', 'histogram-bar')
        .attr('x', d => xScale(d.x))
        .attr('y', d => yScale(d.height))
        .attr('width', d => Math.max(0, xScale(d.x + d.width) - xScale(d.x) - 1))
        .attr('height', d => Math.max(0, innerHeight - yScale(d.height)))
        .attr('fill', '#74b9ff')
        .attr('stroke', '#0984e3')
        .attr('stroke-width', 1);
      
      // Generate smooth normal curve points for overlay
      const curvePoints = [];
      const numPoints = 100;
      for (let i = 0; i <= numPoints; i++) {
        const x = xMin + (xMax - xMin) * i / numPoints;
        const z = (x - mean) / sd;
        const density = Math.exp(-0.5 * z * z) / (sd * Math.sqrt(2 * Math.PI));
        // Scale to match histogram height
        const scaledHeight = density * n * binWidth;
        if (isFinite(scaledHeight)) {
          curvePoints.push({ x, y: scaledHeight });
        }
      }
      
      if (curvePoints.length > 0) {
        // Draw normal curve overlay
        const line = d3.line()
          .x(d => xScale(d.x))
          .y(d => yScale(d.y))
          .curve(d3.curveBasis);
        
        g.append('path')
          .datum(curvePoints)
          .attr('fill', 'none')
          .attr('stroke', '#ffd700')
          .attr('stroke-width', 2.5)
          .attr('d', line);
      }
      
      // Mark mean
      g.append('line')
        .attr('x1', xScale(mean))
        .attr('x2', xScale(mean))
        .attr('y1', 0)
        .attr('y2', innerHeight)
        .attr('stroke', '#fbbf24')
        .attr('stroke-width', 2)
        .attr('stroke-dasharray', '5,5');
      
      g.append('text')
        .attr('x', xScale(mean))
        .attr('y', -5)
        .attr('text-anchor', 'middle')
        .attr('fill', '#fbbf24')
        .style('font-size', '11px')
        .style('font-weight', 'bold')
        .text('Î¼');
      
      // Mark median if different from mean
      if (isFinite(median) && Math.abs(median - mean) > 0.01) {
        g.append('line')
          .attr('x1', xScale(median))
          .attr('x2', xScale(median))
          .attr('y1', 0)
          .attr('y2', innerHeight)
          .attr('stroke', '#4ade80')
          .attr('stroke-width', 2)
          .attr('stroke-dasharray', '3,3');
        
        g.append('text')
          .attr('x', xScale(median))
          .attr('y', -5)
          .attr('text-anchor', 'middle')
          .attr('fill', '#4ade80')
          .style('font-size', '11px')
          .style('font-weight', 'bold')
          .text('M');
      }
      
      // X axis
      g.append('g')
        .attr('class', 'axis')
        .attr('transform', `translate(0,${innerHeight})`)
        .call(d3.axisBottom(xScale).ticks(6))
        .selectAll('text')
        .attr('fill', 'white');
      
      // Y axis
      g.append('g')
        .attr('class', 'axis')
        .call(d3.axisLeft(yScale).ticks(5))
        .selectAll('text')
        .attr('fill', 'white');
      
      // Labels
      g.append('text')
        .attr('x', innerWidth / 2)
        .attr('y', innerHeight + 35)
        .attr('text-anchor', 'middle')
        .attr('fill', 'white')
        .style('font-size', '11px')
        .text('Value');
      
      g.append('text')
        .attr('x', -innerHeight / 2)
        .attr('y', -35)
        .attr('text-anchor', 'middle')
        .attr('transform', 'rotate(-90)')
        .attr('fill', 'white')
        .style('font-size', '11px')
        .text('Frequency');
      
      // Add annotation
      g.append('text')
        .attr('x', innerWidth / 2)
        .attr('y', 15)
        .attr('text-anchor', 'middle')
        .attr('fill', 'rgba(255,255,255,0.5)')
        .style('font-size', '10px')
        .style('font-style', 'italic')
        .text('Expected distribution from normal model (Î¼, Ïƒ)');
    }
    
    function updateGroupChart() {
      if (typeof Highcharts === 'undefined') return;
      if (!lastBundle || !lastBundle.explore) return;
      
      const e = lastBundle.explore;
      const s = lastBundle.setup || {};
      const groupAName = s.groupA || 'Time 1';
      const groupBName = s.groupB || 'Time 2';
      
      const n1 = parseMaybeNumber(e.n1) || 0;
      const n2 = parseMaybeNumber(e.n2) || 0;
      const mean1 = parseMaybeNumber(e.mean1);
      const mean2 = parseMaybeNumber(e.mean2);
      const sd1 = parseMaybeNumber(e.sd1);
      const sd2 = parseMaybeNumber(e.sd2);
      
      if (!isFinite(mean1) || !isFinite(mean2)) return;
      
      // Check if equal variance is assumed
      const varianceToggle = document.getElementById('showVarianceToggle');
      const assumeEqualVar = varianceToggle && varianceToggle.checked;
      
      // Calculate SE and 95% CI for each group
      let se1, se2, ci1, ci2;
      
      if (assumeEqualVar) {
        // Pooled standard error
        const pooledVar = ((n1 - 1) * sd1 * sd1 + (n2 - 1) * sd2 * sd2) / (n1 + n2 - 2);
        const pooledSE = Math.sqrt(pooledVar * (1/n1 + 1/n2));
        se1 = Math.sqrt(pooledVar / n1);
        se2 = Math.sqrt(pooledVar / n2);
        ci1 = 1.96 * se1;
        ci2 = 1.96 * se2;
      } else {
        // Separate variance (Welch)
        se1 = isFinite(sd1) && n1 > 0 ? sd1 / Math.sqrt(n1) : 0;
        se2 = isFinite(sd2) && n2 > 0 ? sd2 / Math.sqrt(n2) : 0;
        ci1 = 1.96 * se1;
        ci2 = 1.96 * se2;
      }
      
      // Calculate grand mean
      const grandMean = (mean1 * n1 + mean2 * n2) / (n1 + n2);
      
      Highcharts.chart('groupChart', {
        chart: { type: 'column', backgroundColor: 'transparent' },
        title: { 
          text: assumeEqualVar ? 'Equal Variance Assumed (Pooled)' : 'Unequal Variance (Welch)',
          style: { color: '#fff', fontSize: '12px', fontWeight: '600' }
        },
        xAxis: {
          categories: [groupAName, groupBName],
          labels: { style: { color: '#fff', fontSize: '12px' } }
        },
        yAxis: {
          title: { text: 'Mean', style: { color: '#fff' } },
          labels: { style: { color: '#fff' } },
          gridLineColor: 'rgba(255,255,255,0.1)',
          plotLines: [{
            value: grandMean,
            color: '#fbbf24',
            width: 2,
            dashStyle: 'Dash',
            zIndex: 5,
            label: {
              text: 'Grand Mean',
              style: { color: '#fbbf24', fontSize: '10px', fontWeight: 'bold' },
              align: 'right'
            }
          }]
        },
        legend: { enabled: false },
        plotOptions: {
          column: {
            dataLabels: {
              enabled: true,
              format: '{y:.2f}',
              style: { color: '#fff', textOutline: 'none' }
            }
          }
        },
        tooltip: {
          shared: true,
          backgroundColor: '#1a1f2e',
          style: { color: '#fff' },
          useHTML: true,
          formatter: function() {
            const pointIndex = this.point.index;
            const n = pointIndex === 0 ? n1 : n2;
            const mean = pointIndex === 0 ? mean1 : mean2;
            const sd = pointIndex === 0 ? sd1 : sd2;
            const se = pointIndex === 0 ? se1 : se2;
            const ci = pointIndex === 0 ? ci1 : ci2;
            return `<b>${this.x}</b><br/>` +
                   `n: ${n}<br/>` +
                   `Mean: ${mean.toFixed(2)}<br/>` +
                   `SD: ${sd.toFixed(2)}<br/>` +
                   `SE: ${se.toFixed(3)}${assumeEqualVar ? ' (pooled)' : ''}<br/>` +
                   `95% CI: [${(mean - ci).toFixed(2)}, ${(mean + ci).toFixed(2)}]`;
          }
        },
        series: [{
          name: 'Mean',
          data: [mean1, mean2],
          color: '#74b9ff'
        }, {
          name: '95% CI',
          type: 'errorbar',
          data: [
            [mean1 - ci1, mean1 + ci1],
            [mean2 - ci2, mean2 + ci2]
          ],
          color: assumeEqualVar ? 'rgba(120,200,255,0.6)' : 'rgba(255,255,255,0.4)',
          lineWidth: assumeEqualVar ? 2 : 1.5,
          whiskerLength: '80%'
        }]
      });
    }

    async function generateAISummary() {
      console.log('ðŸ¤– AI Summary button clicked');
      const btn = document.getElementById('aiSummaryBtn');
      if (!btn) {
        console.error('âŒ AI button not found');
        return;
      }
      
      console.log('ðŸ”‘ Checking API key...', window.AI_API_KEY ? 'Present' : 'Missing');
      if (!window.AI_API_KEY || window.AI_API_KEY === 'YOUR_API_KEY_PLACEHOLDER') {
        showAISummary('AI API key not configured. Please set up your Groq API key.');
        return;
      }
      
      console.log('ðŸ“¦ Checking lastBundle...', lastBundle ? 'Present' : 'Missing');
      if (!lastBundle) {
        showAISummary('No analysis results available to summarize. Please run an analysis first.');
        return;
      }
      
      btn.disabled = true;
      btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Generating...';
      
      try {
        const payload = buildAIPayload();
        console.log('ðŸ“¦ AI Payload:', payload);
        
        const systemPrompt = `You are a statistical expert. Provide a concise, professional summary of the paired samples t-test/Wilcoxon signed-rank analysis results. Format p-values as "p < .001" when p < 0.001. Include means for both time points and the mean change. Include assumption test results (normality of differences). Use APA style where appropriate.`;
        
        const userPrompt = `Summarize this 2-group comparison analysis:\n\n${JSON.stringify(payload, null, 2)}\n\nProvide a brief, clear summary highlighting: 1) group descriptives, 2) assumption tests, 3) primary test result, 4) effect size, 5) interpretation.`;
        
        console.log('ðŸŒ Calling Groq API...');
        const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${window.AI_API_KEY}`
          },
          body: JSON.stringify({
            model: 'llama-3.3-70b-versatile',
            messages: [
              { role: 'system', content: systemPrompt },
              { role: 'user', content: userPrompt }
            ],
            temperature: 0.3,
            max_tokens: 1000
          })
        });
        
        console.log('ðŸ“¥ Response status:', response.status);
        if (!response.ok) {
          const errorText = await response.text();
          console.error('âŒ API error:', errorText);
          throw new Error(`API error ${response.status}: ${errorText}`);
        }
        
        const data = await response.json();
        console.log('âœ… API response received');
        const summary = data.choices[0].message.content;
        
        // Display in modal
        showAISummary(summary);
        
      } catch (error) {
        console.error('âŒ AI Summary error:', error);
        showAISummary(`Error generating AI summary:\n\n${error.message}`);
      } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="fa-solid fa-brain"></i> AI Summary';
      }
    }
    
    function showAISummary(content) {
      const modal = document.getElementById('aiSummaryModal');
      const contentEl = document.getElementById('aiSummaryContent');
      if (modal && contentEl) {
        contentEl.textContent = content;
        modal.style.display = 'flex';
      }
    }
    
    function closeAISummaryModal() {
      const modal = document.getElementById('aiSummaryModal');
      if (modal) modal.style.display = 'none';
    }
    
    function buildAIPayload() {
      const b = lastBundle || {};
      const s = b.setup || {};
      const e = b.explore || {};
      const a = b.assumptions || {};
      const r = b.results || {};
      const fx = b.effects || {};
      
      return {
        design: {
          compareMode: s.compareMode || 'two-vars',
          hypothesis: s.hypothesis,
          confidence: s.confidence,
          primaryFramework: s.primaryFramework || primaryFramework
        },
        groups: {
          time1: {
            name: s.groupA || 'Time 1',
            n: e.n1,
            mean: e.mean1,
            sd: e.sd1,
            median: e.med1,
            iqr: e.iqr1
          },
          time2: {
            name: s.groupB || 'Time 2',
            n: e.n2,
            mean: e.mean2,
            sd: e.sd2,
            median: e.med2,
            iqr: e.iqr2
          }
        },
        assumptions: {
          normalityDifferences: a.normalityA, // For paired data, we check normality of differences
          recommendation: a.recommendation
        },
        results: {
          parametric: {
            paired: {
              t: r.pairedT || r.welchT,
              df: r.pairedDf || r.welchDf,
              p: r.pairedP || r.welchP
            },
            meanDiff: r.meanDiff,
            ciLow: r.ciLow,
            ciHigh: r.ciHigh
          },
          nonparametric: {
            wilcoxon: {
              w: r.wilcoxonW || r.u,
              p: r.wilcoxonP || r.mwP
            }
          }
        },
        effects: {
          hedgesG: fx.hedgesG,
          cliffsDelta: fx.cliffsDelta,
          rankBiserial: fx.rankBiserial,
          probabilitySuperiority: fx.probabilitySuperiority
        }
      };
    }

    function saveCurrentModel(){ sendToHost("savedependentModel", lastBundle||{}); }
    function exportHtml(){
      const blob = new Blob([document.documentElement.outerHTML], {type:"text/html"});
      const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = "dependent-means-report.html"; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),500);
    }
    document.addEventListener("DOMContentLoaded", function(){
      document.querySelectorAll(".tab-button").forEach(btn=>btn.addEventListener("click",()=>switchTab(btn.getAttribute("data-tab"))));
      ["setAlpha","setPosthocMethod","setPosthocCorrection","setPrimaryTest"].forEach(function(id){
        const el = document.getElementById(id);
        if (el) el.addEventListener("change", function(){
          if (id === "setPrimaryTest") {
            currentPrimaryTest = el.value || "welch";
            setFrameworkButtons(primaryFramework);
          }
          notifySettingsChanged();
        });
      });
      document.querySelectorAll('input[name="h1Orientation"]').forEach(function(el){ el.addEventListener("change", notifySettingsChanged); });
      var rp = document.getElementById("fwParametric");
      var rn = document.getElementById("fwNonparametric");
      if (rp) rp.addEventListener("change", function(){ if (rp.checked) { setFrameworkButtons("parametric"); notifySettingsChanged(); } });
      if (rn) rn.addEventListener("change", function(){ if (rn.checked) { setFrameworkButtons("nonparametric"); notifySettingsChanged(); } });
      
      // Variance toggle handler
      const varianceToggle = document.getElementById("showVarianceToggle");
      if (varianceToggle) {
        varianceToggle.addEventListener("change", function() {
          updateGroupChart();
        });
      }
      
      setFrameworkButtons(primaryFramework);
      refreshSettingsVisibility();
      Office.onReady(function(){
        Office.context.ui.addHandlerAsync(Office.EventType.DialogParentMessageReceived, function(arg){
          const msg = JSON.parse(arg.message||"{}");
          if(msg.type==="dependent_BUNDLE") populateBundle(msg.payload||{});
        });
        sendToHost("dependentDashboardReady",{});
        setTimeout(()=>sendToHost("dependentDashboardReady",{}),500);
      });
    });
  </script>
  
  <!-- AI Summary Modal -->
  <div id="aiSummaryModal" style="display:none;" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">ðŸ¤– AI Statistical Summary</div>
        <button class="modal-close" onclick="closeAISummaryModal()">Ã—</button>
      </div>
      <div class="modal-body" id="aiSummaryContent"></div>
    </div>
  </div>
</body>
</html>
