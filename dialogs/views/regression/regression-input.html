<!DOCTYPE html>
<html lang="en">
<head>
  <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mixed Regression Model (ANCOVA) ‚Äî Input Panel</title>
  <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
  <style>
    :root{
      --surface-0: #f3f4f6;
      --surface-1: #ffffff;
      --surface-2: #f9fafb;
      --border: #e5e7eb;
      --accent-1: #2563eb;
      --accent-2: #1d4ed8;
      --accent-3: #16a34a;
      --text-primary: #111827;
      --text-secondary: #4b5563;
      --text-muted: #6b7280;
      --panel-radius: 10px;
      --panel-shadow: 0px 4px 20px rgba(0, 0, 0, 0.08);
      --pad:10px;
    }
    *{ box-sizing:border-box }
    html,body{height:100%;margin:0;padding:0}
    body{background:var(--surface-0);color:var(--text-primary);font:14px/1.45 'Segoe UI',Arial,sans-serif}
    
    .wrap{ 
      display:flex; 
      justify-content:center; 
      padding:8px;
      height:100vh;
    }
    
    .card{
      width:min(520px, 100%);
      background:var(--surface-1);
      border-radius:var(--panel-radius);
      box-shadow:var(--panel-shadow);
      border: 1px solid var(--border);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      height:100%;
    }
    
    .card-head{ 
      background: transparent; 
      color:var(--accent-1); 
      padding:10px 12px; 
      font-weight:600; 
      font-size:1.1rem; 
      letter-spacing:.3px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink:0;
    }
    
    .card-body{ 
      flex: 1;
      overflow: hidden;
      display: flex; 
      flex-direction: column;
      padding: 0;
    }
    
    .divider{ height:2px; background:var(--border); margin:0; flex-shrink:0 }
    
    /* Three-Panel Layout */
    .split-container {
      display: flex;
      flex-direction: column;
      flex: 1;
      overflow: hidden;
      height: 100%;
    }
    
    /* Panel 1: Range Selection - Fixed height */
    .range-panel {
      flex: 0 0 60px;
      background: var(--surface-2);
      border-bottom: 2px solid var(--border);
      padding: 8px;
      overflow: hidden;
    }
    
    /* Panel 2: Variables List - Fixed height */
    .variables-panel {
      flex: 0 0 200px;
      background: var(--surface-1);
      border-bottom: 2px solid var(--border);
      padding: 8px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }
    
    /* Panel 3: Model Assignment - Fixed height */
    .model-panel {
      flex: 0 0 210px;
      background: var(--surface-2);
      border-bottom: 2px solid var(--border);
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    
    .model-panel .tabs {
      flex-shrink: 0;
    }
    
    .model-panel .tab-panel {
      flex: 1;
      min-height: 0;
    }
    
    /* Fields */
    input[type=text], select{
      width:100%; 
      background:var(--surface-0); 
      color:var(--text-primary);
      border:1px solid var(--border); 
      border-radius:6px; 
      padding:6px 10px; 
      min-height:32px;
      transition: border-color 0.3s ease;
      font-size: 13px;
    }
    input[type=text]:focus, select:focus{
      outline:none; 
      border-color:var(--accent-1); 
      box-shadow:0 0 0 2px rgba(255,165,120,0.2);
    }
    
    .btn{ 
      background:linear-gradient(135deg, var(--accent-1), #e67e22); 
      border:0; 
      border-radius:6px; 
      color:var(--surface-0); 
      padding:6px 12px; 
      font-weight:600; 
      cursor:pointer; 
      min-height:32px; 
      transition:all 0.3s ease;
      font-size: 12px;
    }
    .btn:hover{ 
      transform:translateY(-1px); 
      box-shadow:0 4px 12px rgba(255,165,120,0.3); 
    }
    .btn.alt{ 
      background:var(--surface-2); 
      color:var(--text-primary); 
      border:1px solid var(--border); 
    }
    .btn.alt:hover{ 
      background:var(--surface-0); 
      border-color:var(--accent-1); 
    }
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    
    /* Variables Table */
    .variables-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
      table-layout: fixed;
    }
    
    .variables-table thead {
      background: var(--surface-0);
      position: sticky;
      top: 0;
      z-index: 1;
    }
    
    .variables-table th {
      padding: 4px 8px !important;
      text-align: left;
      color: var(--text-secondary);
      font-weight: 700;
      border-bottom: 2px solid var(--border);
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.3px;
      line-height: 1.2 !important;
    }
    
    .variables-table th.center {
      text-align: center;
    }
    
    .variables-table tbody tr {
      cursor: grab;
      transition: all 0.2s ease;
      user-select: none;
      height: auto !important;
    }
    
    .variables-table tbody tr:hover:not(.variable-row-disabled) {
      background: var(--surface-1);
      transform: scale(1.01);
    }
    
    .variables-table tbody tr:active:not(.variable-row-disabled) {
      cursor: grabbing;
    }
    
    .variables-table tbody tr.dragging {
      opacity: 0.5;
      cursor: grabbing;
    }
    
    .variables-table tbody tr.variable-row-disabled {
      opacity: 0.4;
      cursor: not-allowed;
      pointer-events: none;
    }
    
    .variables-table tbody tr.variable-row-disabled:hover {
      background: transparent;
      transform: none;
    }
    
    .variables-table td {
      padding: 4px 8px !important;
      border-bottom: 1px solid var(--border);
      color: var(--text-primary);
      line-height: 1.2 !important;
    }
    
    .variables-table td.var-name {
      font-weight: 600;
      font-size: 13px;
    }
    
    .variables-table td.center {
      text-align: center;
      font-weight: 600;
    }
    
    .variables-table td.numeric-col {
      color: var(--accent-2);
    }
    
    .variables-table td.string-col {
      color: var(--accent-3);
    }
    
    .variables-table td.missing-col {
      color: var(--text-muted);
    }
    
    .variables-table .grip-icon {
      color: var(--text-muted);
      font-size: 11px;
    }
    
    /* Tabs */
    .tabs {
      display: flex;
      gap: 6px;
      background: var(--surface-0);
      border-bottom: 2px solid var(--border);
      flex-shrink:0;
      padding: 6px;
    }
    
    .tabs button {
      flex: 1;
      background: var(--surface-1);
      color: var(--text-secondary);

      border-radius: 6px;
      padding: 8px 10px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }
    
    .tabs button:hover {
      background: var(--surface-2);
      color: var(--text-primary);
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
    
    .tabs button.active {
      background: var(--surface-2);
      color: var(--text-primary);
      border-width: 2px;
    }
    
    .tabs button.y-tab.active { 
      background: rgba(255, 165, 120, 0.2);
      border-color: var(--accent-1);
      color: var(--accent-1); 
      box-shadow: 0 0 0 2px rgba(255, 165, 120, 0.3);
    }
    .tabs button.xn-tab.active { 
      background: rgba(79, 195, 247, 0.2);
      border-color: var(--accent-2);
      color: var(--accent-2); 
      box-shadow: 0 0 0 2px rgba(79, 195, 247, 0.3);
    }
    .tabs button.xc-tab.active { 
      background: rgba(129, 199, 132, 0.2);
      border-color: var(--accent-3);
      color: var(--accent-3); 
      box-shadow: 0 0 0 2px rgba(129, 199, 132, 0.3);
    }
    
    .tabs button span {
      font-size: 13px;
      font-weight: 700;
    }
    
    /* Tab Content */
    .tab-panel {
      display: none;
      flex: 1;
      min-height: 0;
      padding: 6px;
      overflow-y: auto;
    }
    
    .tab-panel.active {
      display: flex;
      flex-direction: column;
    }
    
    #panelY {
      background: rgba(255, 165, 120, 0.05);
    }
    
    #panelXn {
      background: rgba(79, 195, 247, 0.05);
    }
    
    #panelXc {
      background: rgba(129, 199, 132, 0.05);
    }
    
    .drop-zone {
      background: var(--surface-0);
      border: 2px dashed var(--border);
      border-radius: 6px;
      padding: 4px;
      transition: all 0.3s ease;
      display: flex;
      flex-direction: column;
      gap: 4px;
      flex: 1;
      min-height: 60px;
      max-height: 100px;
      max-width: 360px;
      width: 85%;
      overflow-y: auto;
      align-self: flex-start;
    }
    .model-equation-header {
      margin-top: 4px;
      font-size: 12px;
      color: var(--text-secondary);
      font-weight: 600;
      text-transform: none;
    }
    .y-zone { align-self: flex-start; }
    .xn-zone { align-self: center; }
    .xc-zone { align-self: flex-end; }
    
    .drop-zone.y-zone {
      background: rgba(255, 165, 120, 0.08);
      border-color: rgba(255, 165, 120, 0.4);
    }
    
    .drop-zone.xn-zone {
      background: rgba(79, 195, 247, 0.08);
      border-color: rgba(79, 195, 247, 0.4);
    }
    
    .drop-zone.xc-zone {
      background: rgba(129, 199, 132, 0.08);
      border-color: rgba(129, 199, 132, 0.4);
    }
    
    .drop-zone.drag-over {
      box-shadow: 0 0 0 3px rgba(255,255,255,0.2);
    }
    
    .drop-zone.y-zone.drag-over {
      border-color: var(--accent-1);
      background: rgba(255,165,120,0.2);
      box-shadow: 0 0 0 3px rgba(255,165,120,0.3);
    }
    
    .drop-zone.xn-zone.drag-over {
      border-color: var(--accent-2);
      background: rgba(79,195,247,0.2);
      box-shadow: 0 0 0 3px rgba(79,195,247,0.3);
    }
    
    .drop-zone.xc-zone.drag-over {
      border-color: var(--accent-3);
      background: rgba(129,199,132,0.2);
      box-shadow: 0 0 0 3px rgba(129,199,132,0.3);
    }
    
    .drop-zone-info {
      color: var(--text-primary);
      font-size: 10px;
      text-align: center;
      padding: 4px 8px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 4px;
      margin-bottom: 4px;
      flex-shrink: 0;
    }
    .drag-hint {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 8px;
      background: #eef2ff;
      border: 1px solid #c7d2fe;
      color: #3730a3;
      border-radius: 6px;
      font-size: 12px;
      margin-bottom: 6px;
    }
    .model-equation {
      background: var(--surface-0);
      border: 1px dashed var(--border);
      border-radius: 6px;
      padding: 6px 8px;
      font-size: 12px;
      color: var(--text-secondary);
      margin: 6px;
    }
    
    .y-zone .drop-zone-info {
      background: rgba(255, 165, 120, 0.25);
      color: #fff;
    }
    
    .xn-zone .drop-zone-info {
      background: rgba(79, 195, 247, 0.25);
      color: #fff;
    }
    
    .xc-zone .drop-zone-info {
      background: rgba(129, 199, 132, 0.25);
      color: #fff;
    }
    
    .drop-zone-placeholder {
      color: var(--text-secondary);
      font-style: italic;
      font-size: 11px;
      text-align: center;
      padding: 12px 8px;
      opacity: 0.7;
    }
    
    .y-zone .drop-zone-placeholder {
      color: rgba(255, 165, 120, 0.6);
    }
    
    .xn-zone .drop-zone-placeholder {
      color: rgba(79, 195, 247, 0.6);
    }
    
    .xc-zone .drop-zone-placeholder {
      color: rgba(129, 199, 132, 0.6);
    }
    
    /* Toast Notifications */
    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 10000;
      display: flex;
      flex-direction: column;
      gap: 10px;
      max-width: 400px;
    }
    
    .toast {
      background: #ffffff;
      border: 2px solid var(--border);
      border-radius: 8px;
      padding: 14px 18px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      display: flex;
      align-items: flex-start;
      gap: 12px;
      animation: slideIn 0.3s ease;
      min-width: 300px;
    }
    
    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    
    .toast.toast-success {
      border-color: #28a745;
      background: #e8f5e9;
      border-width: 2px;
    }
    
    .toast.toast-error {
      border-color: #dc3545;
      background: #ffebee;
      border-width: 2px;
    }
    
    .toast.toast-warning {
      border-color: #ffc107;
      background: #fff8e1;
      border-width: 2px;
    }
    
    .toast.toast-info {
      border-color: #17a2b8;
      background: #e0f7fa;
      border-width: 2px;
    }
    
    .toast-icon {
      font-size: 20px;
      flex-shrink: 0;
    }
    
    .toast-success .toast-icon { color: #28a745; }
    .toast-error .toast-icon { color: #dc3545; }
    .toast-warning .toast-icon { color: #ffc107; }
    .toast-info .toast-icon { color: #17a2b8; }
    
    .toast-content {
      flex: 1;
    }
    
    .toast-title {
      font-weight: 700;
      color: #333;
      margin-bottom: 4px;
      font-size: 14px;
    }
    
    .toast-message {
      color: #555;
      font-size: 13px;
      line-height: 1.4;
    }
    
    .toast-close {
      background: transparent;
      border: none;
      color: #666;
      cursor: pointer;
      font-size: 18px;
      padding: 0;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 4px;
      transition: all 0.2s ease;
    }
    
    .toast-close:hover {
      background: rgba(0, 0, 0, 0.1);
      color: #333;
    }
    
    /* Category Modal */
    .category-modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      backdrop-filter: blur(4px);
    }
    
    .category-modal-overlay.active {
      display: flex;
    }
    
    .category-modal {
      background: var(--surface-0);
      border: 2px solid var(--accent-3);
      border-radius: 8px;
      width: 90%;
      max-width: 500px;
      max-height: 80vh;
      display: flex;
      flex-direction: column;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
    }
    
    .category-modal-header {
      background: rgba(129, 199, 132, 0.2);
      border-bottom: 2px solid var(--accent-3);
      padding: 12px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .category-modal-header h3 {
      margin: 0;
      color: var(--accent-3);
      font-size: 16px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .category-modal-body {
      padding: 16px;
      overflow-y: auto;
      flex: 1;
    }
    
    .category-info {
      background: var(--surface-1);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 12px;
      margin-bottom: 12px;
    }
    
    .category-info-row {
      display: flex;
      justify-content: space-between;
      padding: 4px 0;
      color: var(--text-secondary);
      font-size: 13px;
    }
    
    .category-info-value {
      color: var(--accent-3);
      font-weight: 700;
    }
    
    .category-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }
    
    .category-table thead {
      background: var(--surface-1);
      position: sticky;
      top: 0;
    }
    
    .category-table th {
      padding: 8px;
      text-align: left;
      color: var(--text-secondary);
      font-weight: 700;
      border-bottom: 2px solid var(--border);
      font-size: 12px;
    }
    
    .category-table th:last-child {
      text-align: center;
    }
    
    .category-table tbody tr {
      border-bottom: 1px solid var(--border);
    }
    
    .category-table tbody tr:hover {
      background: var(--surface-1);
    }
    
    .category-table td {
      padding: 8px;
      color: var(--text-primary);
    }
    
    .category-table td:last-child {
      text-align: center;
      font-weight: 700;
      color: var(--accent-3);
    }
    
    .category-modal-footer {
      border-top: 1px solid var(--border);
      padding: 12px 16px;
      display: flex;
      gap: 8px;
      justify-content: flex-end;
    }
    
    .dropped-variable {
      background: var(--surface-2);
      padding: 3px 6px !important;
      border-radius: 4px;
      border: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      transition: all 0.2s ease;
      font-size: 10px;
      flex-shrink:0;
      line-height: 1.2 !important;
      min-height: auto !important;
    }
    
    .dropped-variable:hover {
      background: var(--surface-1);
      border-color: var(--accent-1);
    }
    
    .dropped-variable .var-name {
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 3px;
      line-height: 1.2 !important;
    }
    
    .dropped-variable .remove-btn {
      background: transparent;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      padding: 2px 4px !important;
      border-radius: 3px;
      transition: all 0.2s ease;
      font-size: 12px;
      line-height: 1 !important;
    }
    
    .dropped-variable .remove-btn:hover {
      background: rgba(255,107,107,0.2);
      color: #ff6b6b;
    }
    
    .y-zone .dropped-variable { border-left: 3px solid var(--accent-1); }
    .xn-zone .dropped-variable { border-left: 3px solid var(--accent-2); }
    .xc-zone .dropped-variable { border-left: 3px solid var(--accent-3); }
    
    /* Action buttons */
    .actions {
      flex: 0 0 50px;
      display: flex;
      gap: 6px;
      padding: 8px;
      justify-content: flex-end;
      align-items: center;
      background: var(--surface-0);
      border-top: 2px solid var(--border);
      flex-shrink:0;
    }
    
    /* Responsive */
    @media (max-width: 920px){
      .split-container {
        gap:8px;
      }
    }
    
    @media (max-width: 740px){
      .card{
        width: 100%;
      }
      .btn {
        font-size: 11px;
        padding: 5px 10px;
      }
      .top-section {
        flex: 0 0 50%;
      }
      .bottom-section {
        flex: 0 0 calc(50% - 8px);
      }
      .tabs button {
        font-size: 11px;
        padding: 6px 8px;
      }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <section class="card" role="main">
      <div class="card-head">
        <span><i class="fa-solid fa-chart-line"></i> Multiple Regression (ANCOVA)</span>
        <div style="display: flex; align-items: center; gap: 8px;">
          <div style="display: flex; align-items: center; gap: 6px; background: var(--surface-0); border: 1px solid var(--border); border-radius: 6px; padding: 4px 8px;">
            <input type="checkbox" id="chkIncludeIntercept" checked style="cursor: pointer; width: 16px; height: 16px;" />
            <label for="chkIncludeIntercept" style="cursor: pointer; color: var(--text-secondary); font-weight: 600; font-size: 12px; margin: 0; white-space: nowrap;">
              Intercept
            </label>
          </div>
          <button id="btnValidate" class="btn alt" style="
            width: auto;
            height: 32px;
            padding: 0 12px;
            display: flex;
            align-items: center;
            gap: 6px;
            min-height:32px;
            font-size: 12px;
          " title="Validate Model">
            <i class="fa-solid fa-check-circle"></i> Validate
          </button>
          <button id="btnHelp" class="btn alt" style="
            width: 32px;
            height: 32px;
            padding: 0;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height:32px;
          " title="Help & Documentation">
            <i class="fa-solid fa-question"></i>
          </button>
        </div>
      </div>
      
      <div class="card-body">
        <div class="split-container">
          
          <!-- PANEL 1: RANGE SELECTION -->
          <div class="range-panel">
            <div style="background: #eef2ff; border: 1px solid #c7d2fe; border-radius: 6px; padding: 8px; display:flex; align-items:center; gap:8px;">
              <i class="fa-solid fa-database" style="color: var(--accent-1);"></i>
              <div style="font-size: 0.85rem; color: var(--text-secondary);">
                Data selected: <strong id="tbRange">No range loaded yet</strong>
              </div>
            </div>
          </div>
          
          <!-- PANEL 2: VARIABLES LIST -->
          <div class="variables-panel">
            <div style="background: var(--surface-0); border: 1px solid var(--border); border-radius: 6px; padding: 6px 8px; margin-bottom: 6px; flex-shrink:0;">
              <h5 style="color: var(--accent-1); margin: 0 0 4px 0; font-size: 0.75em; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Available Variables</h5>
              
            </div>
            
            <div id="variablesListBox" style="
              border: 2px solid var(--accent-1);
              border-radius: 6px;
              background: var(--surface-2);
              flex:1;
              min-height:0;
              overflow-y: auto;
              overflow-x: hidden;
              box-shadow: 0 2px 8px rgba(255, 165, 120, 0.2);
            ">
              <div style="color: var(--text-muted); font-style: italic; font-size: 12px; text-align: center; padding: 20px 10px;">
                No data loaded yet. Select a range in the taskpane.
              </div>
            </div>
          </div>
          
          <!-- PANEL 3: MODEL ASSIGNMENT -->
          <div class="model-panel">
            
            <!-- Regression Model Header -->
            <div style="background: var(--surface-0); padding: 8px 12px; border-bottom: 2px solid var(--border); flex-shrink: 0; display:flex; align-items:center; justify-content:space-between; gap:8px;">
              <h3 style="margin: 0; color: var(--accent-1); font-size: 1rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;">
                <i class="fa-solid fa-chart-line"></i> Model
              </h3>
              <div class="model-equation-header" id="modelEquation">Model: Y = Œ≤0 + ‚Ä¶</div>
            </div>
              
              <!-- Tabs -->
              <div class="tabs">
                <button class="y-tab active" data-tab="y">
                  <span id="badgeY">Y (Response)</span>
                </button>
                <button class="xn-tab" data-tab="xn">
                  <span id="badgeXn">X (numeric)</span>
                </button>
                <button class="xc-tab" data-tab="xc">
                  <span id="badgeXc">X (Categ.)</span>
                </button>
              </div>
              
            <!-- Tab Panels -->
              
              <!-- Y Panel -->
              <div class="tab-panel active" id="panelY">

                <div class="drop-zone y-zone" data-zone="y" id="zoneY">
                  <div class="drop-zone-placeholder">
                    Drag a numeric variable here
                  </div>
                </div>
              </div>
              
              <!-- Xn Panel -->
              <div class="tab-panel" id="panelXn">

                <div class="drop-zone xn-zone" data-zone="xn" id="zoneXn">
                  <div class="drop-zone-placeholder">
                    Drag numeric variables here
                  </div>
                </div>
              </div>
              
              <!-- Xc Panel -->
              <div class="tab-panel" id="panelXc">

                <div class="drop-zone xc-zone" data-zone="xc" id="zoneXc">
                  <div class="drop-zone-placeholder">
                    Drag categorical variables here
                  </div>
                </div>
              </div>
              
          </div>
          
        </div>
        
        <div class="divider"></div>
        
        <!-- Action Buttons: Only Run Regression -->
        <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 6px; flex-wrap: wrap; justify-content: flex-end;">
          <button id="btnRunAnalysis" class="btn" disabled style="margin: 0; white-space: nowrap; padding: 10px 20px;">
            <i class="fa-solid fa-play"></i> Run Regression
          </button>
        </div>

        <!-- Observation Monitor -->
       
        
      </div>
    </section>
    
    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>
    
    <!-- Category Modal -->
    <div class="category-modal-overlay" id="categoryModal">
      <div class="category-modal">
        <div class="category-modal-header">
          <h3>
            <i class="fa-solid fa-tags"></i>
            <span id="categoryModalTitle">Category Distribution</span>
          </h3>
        </div>
        <div class="category-modal-body">
          <div class="category-info">
            <div class="category-info-row">
              <span>Variable:</span>
              <span class="category-info-value" id="categoryVarName">‚Äî</span>
            </div>
            <div class="category-info-row">
              <span>Total Observations:</span>
              <span class="category-info-value" id="categoryTotalObs">‚Äî</span>
            </div>
            <div class="category-info-row">
              <span>Included Observations:</span>
              <span class="category-info-value" id="categoryIncludedObs" style="color: var(--accent-2);">‚Äî</span>
            </div>
            <div class="category-info-row">
              <span>Selected Categories:</span>
              <span class="category-info-value" id="categorySelectedCount">‚Äî</span>
            </div>
            <div class="category-info-row">
              <span>Total Categories:</span>
              <span class="category-info-value" id="categoryUniqueCount">‚Äî</span>
            </div>
          </div>
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
            <span style="color: var(--text-secondary); font-size: 12px; font-weight: 600;">Select Categories to Include:</span>
            <div style="display: flex; gap: 8px;">
              <button id="btnSelectAllCat" class="btn alt" style="font-size: 11px; padding: 4px 8px;">
                <i class="fa-solid fa-check-square"></i> Select All
              </button>
              <button id="btnDeselectAllCat" class="btn alt" style="font-size: 11px; padding: 4px 8px;">
                <i class="fa-solid fa-square"></i> Deselect All
              </button>
            </div>
          </div>
          <table class="category-table">
            <thead>
              <tr>
                <th style="width: 40px; text-align: center;">Include</th>
                <th>Category</th>
                <th style="text-align: center;">Frequency</th>
              </tr>
            </thead>
            <tbody id="categoryTableBody">
            </tbody>
          </table>
        </div>
        <div class="category-modal-footer">
          <button id="btnCategoryCancel" class="btn alt">
            <i class="fa-solid fa-times"></i> Cancel
          </button>
          <button id="btnCategoryConfirm" class="btn" style="background: var(--accent-3);">
            <i class="fa-solid fa-check"></i> Assign to Xc
          </button>
        </div>
      </div>
    </div>
    
  </div>

  <script>
    // ============================================================================
    // GLOBAL STATE
    // ============================================================================
    var STATE = {
      variables: [],
      data: {},
      variableStats: {},  // Stores variable metadata from Excel
      assignments: {
        y: null,
        xn: [],
        xc: []
      }
    };
    
    // ============================================================================
    // UTILITY FUNCTIONS
    // ============================================================================
    function qs(id){ return document.getElementById(id); }
    
    // Toast Notification System
    function showToast(message, type, duration) {
      type = type || 'info'; // success, error, warning, info
      duration = duration || 4000;
      
      var container = qs('toastContainer');
      var toast = document.createElement('div');
      toast.className = 'toast toast-' + type;
      
      var icon = '';
      var title = '';
      switch(type) {
        case 'success':
          icon = 'fa-check-circle';
          title = 'Success';
          break;
        case 'error':
          icon = 'fa-exclamation-circle';
          title = 'Error';
          break;
        case 'warning':
          icon = 'fa-exclamation-triangle';
          title = 'Warning';
          break;
        case 'info':
          icon = 'fa-info-circle';
          title = 'Info';
          break;
      }
      
      toast.innerHTML = 
        '<div class="toast-icon"><i class="fa-solid ' + icon + '"></i></div>' +
        '<div class="toast-content">' +
          '<div class="toast-title">' + title + '</div>' +
          '<div class="toast-message">' + message + '</div>' +
        '</div>' +
        '<button class="toast-close"><i class="fa-solid fa-times"></i></button>';
      
      container.appendChild(toast);
      
      // Close button handler
      toast.querySelector('.toast-close').addEventListener('click', function() {
        removeToast(toast);
      });
      
      // Auto-remove after duration
      setTimeout(function() {
        removeToast(toast);
      }, duration);
    }
    
    function removeToast(toast) {
      toast.style.animation = 'slideIn 0.3s ease reverse';
      setTimeout(function() {
        if (toast.parentNode) {
          toast.parentNode.removeChild(toast);
        }
      }, 300);
    }
    
    function sendToHost(cmd, data) {
      try {
        if (Office && Office.context && Office.context.ui) {
          var payload = { action: cmd, data: data || null };
          Office.context.ui.messageParent(JSON.stringify(payload));
          console.log('üì§ Sent to parent:', cmd);
        }
      } catch(e) {
        console.error('‚ùå Error sending to parent:', e);
      }
    }
    
    // ============================================================================
    // DATA LOADING
    // ============================================================================
    
    window.populateNamedRanges = function() {
      console.log('‚ÑπÔ∏è Named ranges not used in dialog mode');
    };
    
    // Function called by VBA to load data (multi-column format like InputXL)
    window.populateVariableSelectionTable = function(varStats) {
      console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
      console.log('üìä populateVariableSelectionTable CALLED');
      console.log('üìä varStats:', varStats);
      
      try {
        // varStats format: { "VarName": { count: 100, excelColumn: 3, rangeAddress: "C2:C21" }, ... }
        var headers = [];
        for (var varName in varStats) {
          if (varStats.hasOwnProperty(varName)) {
            headers.push(varName);
          }
        }
        
        console.log('‚úÖ Found ' + headers.length + ' variables:', headers);
        
        // Store variable stats for later use
        STATE.variableStats = varStats;
        
        // Build variable list
        STATE.variables = [];
        for (var i = 0; i < headers.length; i++) {
          var varName = headers[i];
          var stats = varStats[varName];
          
          // Try to detect if numeric or categorical based on data
          // For now, assume all are available for assignment
          STATE.variables.push({
            name: varName,
            type: 'unknown', // Will be determined when user tries to drop
            validCount: stats.count || 0,
            numeric: stats.numeric || 0,
            string: stats.string || 0,
            missing: stats.missing || 0,
            categories: stats.categories || [],
            rangeAddress: stats.rangeAddress || ''
          });
        }
        
        STATE.data = {}; // Will be populated on demand
        STATE.assignments = { y: null, xn: [], xc: [] };
        
        renderVariables();
        clearAssignments();
        
        console.log('‚úÖ Variables loaded successfully');
      } catch(e) {
        console.error('‚ùå Error in populateVariableSelectionTable:', e);
        showToast('Error loading variables: ' + e.message, 'error');
      }
    };
    
    window.loadRegressionData = function(jsonString) {
      console.log('üì• loadRegressionData called');
      try {
        var data = typeof jsonString === 'string' ? JSON.parse(jsonString) : jsonString;
        console.log('‚úÖ Data loaded:', data);
        applyRegressionPayload(data);
      } catch(e) {
        console.error('‚ùå Error loading data:', e);
        showToast('Error loading data: ' + e.message, 'error');
      }
    };

    function applyRegressionPayload(data) {
      if (!data || !data.headers || !data.rows) {
        showToast('Invalid data format', 'error');
        return;
      }

      console.log('üìä Processing loaded data...');
      var headers = data.headers;
      var rows = data.rows;
      var address = data.address || '';

      if (qs('tbRange')) {
        qs('tbRange').textContent = address || 'Selection';
      }

      var stats = buildVariableStats(headers, rows, address);
      STATE.variableStats = stats;

      STATE.variables = [];
      STATE.data = {};
      STATE.assignments = { y: null, xn: [], xc: [] };

      for (var i = 0; i < headers.length; i++) {
        var name = headers[i];
        var s = stats[name] || {};
        var isNumeric = (s.numeric || 0) > (s.string || 0);
        STATE.variables.push({
          name: name,
          type: isNumeric ? 'numeric' : 'categorical',
          validCount: (s.numeric || 0) + (s.string || 0),
          numeric: s.numeric || 0,
          string: s.string || 0,
          missing: s.missing || 0
        });
        STATE.data[name] = [];
      }

      console.log('‚úÖ Processed variables:', STATE.variables);
      renderVariables();
      clearAssignments();
    }

    function buildVariableStats(headers, rows, address) {
      var stats = {};
      var parsed = parseRangeAddress(address);

      for (var colIdx = 0; colIdx < headers.length; colIdx++) {
        var name = headers[colIdx];
        var numericCnt = 0;
        var stringCnt = 0;
        var missingCnt = 0;
        var categories = {};

        for (var rowIdx = 0; rowIdx < rows.length; rowIdx++) {
          var value = rows[rowIdx][colIdx];
          if (value === null || value === undefined || value === '') {
            missingCnt++;
            continue;
          }

          var numVal = parseFloat(value);
          if (!isNaN(numVal) && isFinite(numVal)) {
            numericCnt++;
          } else {
            stringCnt++;
          }

          var key = String(value);
          categories[key] = (categories[key] || 0) + 1;
        }

        var catList = [];
        for (var key in categories) {
          if (categories.hasOwnProperty(key)) {
            catList.push({ value: key, freq: categories[key] });
          }
        }

        stats[name] = {
          numeric: numericCnt,
          string: stringCnt,
          missing: missingCnt,
          categories: catList,
          rangeAddress: parsed ? parsed.sheet + parsed.col(colIdx) + parsed.startRow + ':' + parsed.sheet + parsed.col(colIdx) + parsed.endRow : ''
        };
      }

      return stats;
    }

    function parseRangeAddress(address) {
      if (!address) return null;
      var match = address.match(/^(.*!)?([A-Za-z]+)(\\d+):([A-Za-z]+)(\\d+)$/);
      if (!match) return null;
      var sheet = match[1] || '';
      var startCol = match[2].toUpperCase();
      var startRow = parseInt(match[3], 10) + 1;
      var endRow = parseInt(match[5], 10);

      function colToNumber(col) {
        var num = 0;
        for (var i = 0; i < col.length; i++) {
          num = num * 26 + (col.charCodeAt(i) - 64);
        }
        return num;
      }

      function numberToCol(num) {
        var col = '';
        while (num > 0) {
          var rem = (num - 1) % 26;
          col = String.fromCharCode(65 + rem) + col;
          num = Math.floor((num - 1) / 26);
        }
        return col;
      }

      var startColNum = colToNumber(startCol);

      return {
        sheet: sheet,
        startRow: startRow,
        endRow: endRow,
        col: function(offset) {
          return numberToCol(startColNum + offset);
        }
      };
    }
    
    function detectNumericColumn(data) {
      if (data.length === 0) return false;
      
      var numericCount = 0;
      var totalCount = 0;
      
      for (var i = 0; i < Math.min(data.length, 100); i++) {
        var val = data[i];
        if (val !== null && val !== undefined && val !== '') {
          totalCount++;
          if (!isNaN(parseFloat(val)) && isFinite(val)) {
            numericCount++;
          }
        }
      }
      
      return totalCount > 0 && (numericCount / totalCount) >= 0.8;
    }
    
    function renderVariables() {
      var container = qs('variablesListBox');
      container.innerHTML = '';
      
      if (STATE.variables.length === 0) {
        container.innerHTML = '<div style="color: var(--text-muted); font-style: italic; font-size: 12px; text-align: center; padding: 20px 10px;">No variables loaded</div>';
        return;
      }
      
      // Build table
      var table = document.createElement('table');
      table.className = 'variables-table';
      
      // Table header
      var thead = document.createElement('thead');
      thead.innerHTML = 
        '<tr>' +
          '<th>Variable</th>' +
          '<th class="center">n Numeric</th>' +
          '<th class="center">n String</th>' +
          '<th class="center">n Missing</th>' +
          '<th style="width: 30px;"></th>' +
        '</tr>';
      table.appendChild(thead);
      
      // Table body
      var tbody = document.createElement('tbody');
      STATE.variables.forEach(function(variable) {
        var tr = document.createElement('tr');
        var isAssigned = isVariableAssigned(variable.name);
        
        // Set draggable only if not assigned
        tr.draggable = !isAssigned;
        tr.dataset.varName = variable.name;
        tr.dataset.varType = variable.type;
        
        // Add disabled class if assigned
        if (isAssigned) {
          tr.classList.add('variable-row-disabled');
          tr.style.opacity = '0.4';
          tr.style.cursor = 'not-allowed';
        }
        
        var numericCount = variable.numeric || 0;
        var stringCount = variable.string || 0;
        var missingCount = variable.missing || 0;
        var nonMissingCount = numericCount + stringCount;
        
        // Determine eligibility
        var eligibleForY = numericCount >= 5;
        var eligibleForXn = numericCount >= 5;
        var eligibleForXc = nonMissingCount >= 5;
        
        // Build eligibility badges or assignment indicator
        var eligibilityHTML = '';
        if (isAssigned) {
          // Show where it's assigned
          var assignedTo = '';
          if (STATE.assignments.y === variable.name) {
            assignedTo = '<span style="color: var(--accent-1); font-size: 10px; font-weight: 700;"><i class="fa-solid fa-check-circle"></i> Assigned to Y</span>';
          } else if (STATE.assignments.xn.indexOf(variable.name) >= 0) {
            assignedTo = '<span style="color: var(--accent-2); font-size: 10px; font-weight: 700;"><i class="fa-solid fa-check-circle"></i> Assigned to Xn</span>';
          } else if (STATE.assignments.xc.indexOf(variable.name) >= 0) {
            assignedTo = '<span style="color: var(--accent-3); font-size: 10px; font-weight: 700;"><i class="fa-solid fa-check-circle"></i> Assigned to Xc</span>';
          }
          eligibilityHTML = '<div style="display: flex; gap: 2px; justify-content: center;">' + assignedTo + '</div>';
        } else {
          // Show eligibility
          eligibilityHTML = '<div style="display: flex; gap: 2px; justify-content: center;">';
          if (eligibleForY) {
            eligibilityHTML += '<span style="color: var(--accent-1); font-size: 10px; font-weight: 700;" title="Eligible for Y (Response)">Y</span>';
          }
          if (eligibleForXn) {
            eligibilityHTML += '<span style="color: var(--accent-2); font-size: 10px; font-weight: 700;" title="Eligible for Xn (Numeric)">Xn</span>';
          }
          if (eligibleForXc) {
            eligibilityHTML += '<span style="color: var(--accent-3); font-size: 10px; font-weight: 700;" title="Eligible for Xc (Categorical)">Xc</span>';
          }
          if (!eligibleForY && !eligibleForXn && !eligibleForXc) {
            eligibilityHTML += '<span style="color: var(--text-muted); font-size: 10px;">‚Äî</span>';
          }
          eligibilityHTML += '</div>';
        }
        
        var gripIcon = isAssigned ? '' : '<i class="fa-solid fa-grip-vertical grip-icon"></i>';
        
        tr.innerHTML = 
          '<td class="var-name">' + variable.name + '</td>' +
          '<td class="center numeric-col">' + numericCount + '</td>' +
          '<td class="center string-col">' + stringCount + '</td>' +
          '<td class="center missing-col">' + missingCount + '</td>' +
          '<td style="text-align: center;">' + gripIcon + '</td>';
        
        if (!isAssigned) {
          tr.addEventListener('dragstart', handleDragStart);
          tr.addEventListener('dragend', handleDragEnd);
        }
        
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);
      
      container.appendChild(table);
    }
    
    function loadSampleData() {
      console.log('üß™ Loading sample data...');
      
      var sampleData = {
        headers: ['Salary', 'Age', 'Experience', 'Education', 'Department', 'Gender', 'Performance', 'Hours_Worked'],
        rows: [
          [65000, 28, 3, 'Bachelor', 'Sales', 'M', 85, 42],
          [72000, 32, 6, 'Master', 'Engineering', 'F', 92, 45],
          [58000, 25, 2, 'Bachelor', 'Marketing', 'M', 78, 40],
          [85000, 38, 12, 'PhD', 'Engineering', 'M', 95, 48],
          [62000, 29, 4, 'Bachelor', 'Sales', 'F', 88, 41],
          [78000, 35, 9, 'Master', 'Marketing', 'F', 90, 44],
          [55000, 24, 1, 'Bachelor', 'Sales', 'M', 75, 38],
          [95000, 42, 15, 'PhD', 'Engineering', 'M', 98, 50],
          [68000, 30, 5, 'Master', 'Marketing', 'F', 87, 43],
          [70000, 31, 7, 'Bachelor', 'Engineering', 'M', 89, 42],
          [60000, 27, 3, 'Bachelor', 'Sales', 'F', 82, 40],
          [88000, 39, 13, 'Master', 'Engineering', 'M', 94, 47],
          [63000, 28, 4, 'Bachelor', 'Marketing', 'M', 84, 41],
          [75000, 34, 8, 'Master', 'Sales', 'F', 91, 44],
          [58000, 26, 2, 'Bachelor', 'Marketing', 'F', 79, 39]
        ]
      };
      
      processLoadedData(sampleData);
      
      setTimeout(function() {
        showToast('Sample Data Loaded!<br><br>15 rows √ó 8 variables<br><br><strong>Numeric:</strong> Salary, Age, Experience, Performance, Hours_Worked<br><strong>Categorical:</strong> Education, Department, Gender<br><br>üí° Drag variables to zones below!', 'success', 6000);
      }, 200);
    }
    
    // ============================================================================
    // DRAG & DROP
    // ============================================================================
    var draggedElement = null;
    
    function handleDragStart(e) {
      draggedElement = e.target;
      e.target.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/html', e.target.innerHTML);
    }
    
    function handleDragEnd(e) {
      e.target.classList.remove('dragging');
    }
    
    function handleDragOver(e) {
      if (e.preventDefault) {
        e.preventDefault();
      }
      e.dataTransfer.dropEffect = 'move';
      return false;
    }
    
    function handleDragEnter(e) {
      var zone = e.target.closest('.drop-zone');
      if (zone) {
        zone.classList.add('drag-over');
      }
    }
    
    function handleDragLeave(e) {
      var zone = e.target.closest('.drop-zone');
      if (zone && !zone.contains(e.relatedTarget)) {
        zone.classList.remove('drag-over');
      }
    }
    
    function handleDrop(e) {
      if (e.stopPropagation) {
        e.stopPropagation();
      }
      e.preventDefault();
      
      var zone = e.target.closest('.drop-zone');
      if (!zone || !draggedElement) return false;
      
      zone.classList.remove('drag-over');
      
      var varName = draggedElement.dataset.varName;
      var varType = draggedElement.dataset.varType;
      var zoneType = zone.dataset.zone;
      
      // Check if already assigned first
      if (isVariableAssigned(varName)) {
        showToast('Variable "' + varName + '" is already assigned to the model.', 'warning');
        return false;
      }
      
      // Get variable statistics
      var stats = STATE.variableStats[varName];
      if (!stats) {
        showToast('Cannot find statistics for variable "' + varName + '".', 'error');
        return false;
      }
      
      // Validate minimum data requirements based on zone type
      var numericCount = stats.numeric || 0;
      var stringCount = stats.string || 0;
      var missingCount = stats.missing || 0;
      var nonMissingCount = numericCount + stringCount;
      var totalCount = numericCount + stringCount + missingCount;
      
      if (zoneType === 'y' || zoneType === 'xn') {
        // Y and Xn require at least 5 numerical values
        if (numericCount < 5) {
          showToast('Variable "' + varName + '" has only ' + numericCount + ' numeric values. ' +
                (zoneType === 'y' ? 'Response variable' : 'Numeric predictors') + 
                ' require at least 5 numeric values.', 'error');
          return false;
        }
      } else if (zoneType === 'xc') {
        // Xc requires at least 5 non-missing values
        if (nonMissingCount < 5) {
          showToast('Variable "' + varName + '" has only ' + nonMissingCount + ' non-missing values. ' +
                'Categorical predictors require at least 5 non-missing values.', 'error');
          return false;
        }
        
        // Show category distribution modal for Xc variables
        showCategoryModal(varName, stats);
        return false; // Stop here - assignment will happen after modal confirmation
      }
      
      // For sample data, type is already set
      if (varType !== 'unknown') {
        // Validation
        if (zoneType === 'y') {
          if (varType !== 'numeric') {
            showToast('Response variable (Y) must be numeric.', 'error');
            return false;
          }
          if (STATE.assignments.y !== null) {
            showToast('Only ONE response variable allowed. Remove the existing variable first.', 'warning');
            return false;
          }
        } else if (zoneType === 'xn') {
          if (varType !== 'numeric') {
            showToast('Numeric predictors (Xn) must be numeric variables.', 'error');
            return false;
          }
        } else if (zoneType === 'xc') {
          if (varType !== 'categorical') {
            showToast('Categorical predictors (Xc) must be categorical variables.', 'error');
            return false;
          }
        }
        
        addVariableToZone(varName, varType, zoneType);
      } else {
        // For real Excel data, type is unknown - allow any zone and let user decide
        // We'll validate when running the analysis
        
        if (zoneType === 'y' && STATE.assignments.y !== null) {
          showToast('Only ONE response variable allowed. Remove the existing variable first.', 'warning');
          return false;
        }
        
        // Determine type based on zone
        var assignedType = (zoneType === 'xc') ? 'categorical' : 'numeric';
        
        // Update the variable type
        for (var i = 0; i < STATE.variables.length; i++) {
          if (STATE.variables[i].name === varName) {
            STATE.variables[i].type = assignedType;
            break;
          }
        }
        
        addVariableToZone(varName, assignedType, zoneType);
      }
      
      return false;
    }
    
    function isVariableAssigned(varName) {
      return STATE.assignments.y === varName ||
             STATE.assignments.xn.indexOf(varName) >= 0 ||
             STATE.assignments.xc.indexOf(varName) >= 0;
    }
    
    function addVariableToZone(varName, varType, zoneType) {
      if (zoneType === 'y') {
        STATE.assignments.y = varName;
      } else if (zoneType === 'xn') {
        STATE.assignments.xn.push(varName);
      } else if (zoneType === 'xc') {
        STATE.assignments.xc.push(varName);
      }
      
      // Force immediate re-render
      setTimeout(function() {
        renderVariables(); // Update variables list to show disabled state
        renderAssignments(); // Update drop zones
        validateModel();
      }, 0);
    }
    
    function removeVariableFromZone(varName, zoneType) {
      if (zoneType === 'y') {
        STATE.assignments.y = null;
      } else if (zoneType === 'xn') {
        var idx = STATE.assignments.xn.indexOf(varName);
        if (idx >= 0) STATE.assignments.xn.splice(idx, 1);
      } else if (zoneType === 'xc') {
        var idx = STATE.assignments.xc.indexOf(varName);
        if (idx >= 0) STATE.assignments.xc.splice(idx, 1);
      }
      
      renderAssignments();
      renderVariables(); // Add back to available list
      validateModel();
    }
    
    function renderAssignments() {
      // Y zone
      var zoneY = qs('zoneY');
      zoneY.innerHTML = '';
      if (STATE.assignments.y) {
        zoneY.appendChild(createDroppedVariable(STATE.assignments.y, 'y'));
        qs('badgeY').textContent = 'Y (Response) ‚Ä¢ 1';
      } else {
        zoneY.innerHTML = '<div class="drop-zone-placeholder">Drag a numeric variable here</div>';
        qs('badgeY').textContent = 'Y (Response)';
      }
      
      // Xn zone
      var zoneXn = qs('zoneXn');
      zoneXn.innerHTML = '';
      if (STATE.assignments.xn.length > 0) {
        STATE.assignments.xn.forEach(function(varName) {
          zoneXn.appendChild(createDroppedVariable(varName, 'xn'));
        });
        qs('badgeXn').textContent = 'X (numeric)  x ' + STATE.assignments.xn.length;
      } else {
        zoneXn.innerHTML = '<div class="drop-zone-placeholder">Drag numeric variables here</div>';
        qs('badgeXn').textContent = 'X (numeric)';
      }
      
      // Xc zone
      var zoneXc = qs('zoneXc');
      zoneXc.innerHTML = '';
      if (STATE.assignments.xc.length > 0) {
        STATE.assignments.xc.forEach(function(varName) {
          zoneXc.appendChild(createDroppedVariable(varName, 'xc'));
        });
        qs('badgeXc').textContent = 'X (Categ)  x ' + STATE.assignments.xc.length;
      } else {
        zoneXc.innerHTML = '<div class="drop-zone-placeholder">Drag categorical variables here</div>';
        qs('badgeXc').textContent = 'X (Categ)';
      }
      
      // Update observation monitor
      updateObservationMonitor();
      updateModelEquation();
    }
    
    function updateObservationMonitor() {
      var monitor = qs('obsMonitor');
      
      // Get all assigned variables
      var allVars = [];
      if (STATE.assignments.y) allVars.push(STATE.assignments.y);
      allVars = allVars.concat(STATE.assignments.xn);
      allVars = allVars.concat(STATE.assignments.xc);
      
      // If no variables assigned, hide monitor
      if (allVars.length === 0) {
        monitor.style.display = 'none';
        return;
      }
      
      // Show monitor
      monitor.style.display = 'block';
      
      // Calculate eligible observations as the MINIMUM valid count across all assigned variables
      // This gives a conservative estimate of complete cases
      var eligibleCount = Infinity;
      var totalRows = 0;
      
      // Y variable (if assigned)
      if (STATE.assignments.y) {
        var yStats = STATE.variableStats[STATE.assignments.y];
        if (yStats) {
          var yValid = yStats.numeric || 0;
          eligibleCount = Math.min(eligibleCount, yValid);
          totalRows = (yStats.numeric || 0) + (yStats.string || 0) + (yStats.missing || 0);
        }
      }
      
      // Xn variables (numeric predictors)
      for (var i = 0; i < STATE.assignments.xn.length; i++) {
        var xnStats = STATE.variableStats[STATE.assignments.xn[i]];
        if (xnStats) {
          var xnValid = xnStats.numeric || 0;
          eligibleCount = Math.min(eligibleCount, xnValid);
          if (totalRows === 0) {
            totalRows = (xnStats.numeric || 0) + (xnStats.string || 0) + (xnStats.missing || 0);
          }
        }
      }
      
      // Xc variables (categorical predictors - use selected category observations)
      for (var j = 0; j < STATE.assignments.xc.length; j++) {
        var xcStats = STATE.variableStats[STATE.assignments.xc[j]];
        if (xcStats) {
          // Use includedObs if categories were selected, otherwise use all non-missing
          var xcValid = xcStats.includedObs || ((xcStats.numeric || 0) + (xcStats.string || 0));
          eligibleCount = Math.min(eligibleCount, xcValid);
          if (totalRows === 0) {
            totalRows = (xcStats.numeric || 0) + (xcStats.string || 0) + (xcStats.missing || 0);
          }
        }
      }
      
      // If no valid variables, set to 0
      if (eligibleCount === Infinity) eligibleCount = 0;
      
      // Calculate percentage
      var percentage = totalRows > 0 ? Math.round((eligibleCount / totalRows) * 100) : 0;
      
      // Update display
      qs('obsCount').textContent = eligibleCount;
      qs('obsPct').textContent = '(' + percentage + '% of ' + totalRows + ' total)';
      
      // Update detail text (if element exists)
      var obsDetailElem = qs('obsDetail');
      if (obsDetailElem) {
        var detailText = 'Minimum valid observations across ' + allVars.length + ' variable' + (allVars.length === 1 ? '' : 's');
        if (allVars.length > 3) {
          detailText += ': ' + allVars.slice(0, 3).join(', ') + ', +' + (allVars.length - 3) + ' more';
        } else if (allVars.length > 0) {
          detailText += ': ' + allVars.join(', ');
        }
        obsDetailElem.textContent = detailText;
      }
      
      // Color code based on percentage
      var countElem = qs('obsCount');
      if (percentage >= 80) {
        countElem.style.color = 'var(--accent-2)'; // Green
      } else if (percentage >= 50) {
        countElem.style.color = '#ffa500'; // Orange
      } else {
        countElem.style.color = '#ff4444'; // Red
      }
    }
    
    // Category Modal Functions
    var pendingCategoryAssignment = null;
    
    function showCategoryModal(varName, stats) {
      console.log('üìä Showing category modal for:', varName);
      
      // Calculate category frequencies first
      var categoryData = calculateCategoryFrequencies(varName);
      
      // Check if too many levels (reasonable max is 20 for ANCOVA)
      var maxLevels = 20;
      if (categoryData.categories && categoryData.categories.length > maxLevels) {
        showToast('Variable "' + varName + '" has ' + categoryData.categories.length + ' levels, which is too many for a categorical predictor. ' +
              'Maximum recommended: ' + maxLevels + ' levels. Consider using a different variable or grouping the categories.', 'error', 8000);
        return;
      }
      
      // Store pending assignment
      pendingCategoryAssignment = { varName: varName, stats: stats };
      
      // Update modal header
      qs('categoryModalTitle').textContent = 'Category Distribution: ' + varName;
      qs('categoryVarName').textContent = varName;
      
      // Populate modal
      populateCategoryModal(categoryData);
      
      // Show modal
      qs('categoryModal').classList.add('active');
    }
    
    function calculateCategoryFrequencies(varName) {
      console.log('üìä Calculating category frequencies for:', varName);
      
      // Check if we have categories pre-calculated from VBA
      var stats = STATE.variableStats[varName];
      if (stats && stats.categories && stats.categories.length > 0) {
        console.log('‚úÖ Using pre-calculated categories from VBA');
        var totalObs = (stats.numeric || 0) + (stats.string || 0);
        return {
          totalObs: totalObs,
          categories: stats.categories
        };
      }
      
      // Fallback: If no pre-calculated categories, return empty
      // (VBA should have calculated them during initial load)
      console.warn('‚ö†Ô∏è No category data available for:', varName);
      return {
        totalObs: 0,
        categories: []
      };
    }
    
    function hideCategoryModal() {
      qs('categoryModal').classList.remove('active');
      pendingCategoryAssignment = null;
    }
    
    function confirmCategoryAssignment() {
      if (pendingCategoryAssignment) {
        var varName = pendingCategoryAssignment.varName;
        
        // Get selected categories
        var checkboxes = document.querySelectorAll('.category-checkbox');
        var selectedCategories = [];
        var includedObs = 0;
        
        for (var i = 0; i < checkboxes.length; i++) {
          if (checkboxes[i].checked) {
            selectedCategories.push(checkboxes[i].dataset.value);
            includedObs += parseInt(checkboxes[i].dataset.freq) || 0;
          }
        }
        
        if (selectedCategories.length === 0) {
          showToast('Please select at least one category to include.', 'warning');
          return;
        }
        
        console.log('‚úÖ Confirming assignment of', varName, 'to Xc with', selectedCategories.length, 'categories');
        console.log('   Selected categories:', selectedCategories);
        console.log('   Included observations:', includedObs);
        
        // Assign to Xc
        var assignedType = 'categorical';
        
        // Update variable type and store selected categories
        for (var i = 0; i < STATE.variables.length; i++) {
          if (STATE.variables[i].name === varName) {
            STATE.variables[i].type = assignedType;
            STATE.variables[i].selectedCategories = selectedCategories;
            STATE.variables[i].includedObs = includedObs;
            break;
          }
        }
        
        // Also store in variableStats
        if (STATE.variableStats[varName]) {
          STATE.variableStats[varName].selectedCategories = selectedCategories;
          STATE.variableStats[varName].includedObs = includedObs;
        }
        
        addVariableToZone(varName, assignedType, 'xc');
        hideCategoryModal();
      }
    }
    
    function populateCategoryModal(categoryData) {
      try {
        console.log('üìä Populating category modal with data:', categoryData);
        
        var totalObs = categoryData.totalObs || 0;
        var categories = categoryData.categories || [];
        var uniqueCount = categories.length;
        
        // Store category data in pending assignment
        if (pendingCategoryAssignment) {
          pendingCategoryAssignment.categories = categories;
          pendingCategoryAssignment.totalObs = totalObs;
        }
        
        qs('categoryTotalObs').textContent = totalObs;
        qs('categoryUniqueCount').textContent = uniqueCount;
        qs('categorySelectedCount').textContent = uniqueCount;
        qs('categoryIncludedObs').textContent = totalObs;
        
        // Populate table
        var tbody = qs('categoryTableBody');
        tbody.innerHTML = '';
        
        if (categories.length === 0) {
          tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 20px; color: var(--text-muted);">No categories found</td></tr>';
          return;
        }
        
        // Sort by frequency descending
        categories.sort(function(a, b) { return b.freq - a.freq; });
        
        for (var i = 0; i < categories.length; i++) {
          var cat = categories[i];
          var tr = document.createElement('tr');
          tr.dataset.freq = cat.freq;
          
          var checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.checked = true;
          checkbox.className = 'category-checkbox';
          checkbox.style.cssText = 'cursor: pointer; width: 16px; height: 16px;';
          checkbox.dataset.value = cat.value;
          checkbox.dataset.freq = cat.freq;
          
          checkbox.addEventListener('change', updateCategoryStats);
          
          var tdCheckbox = document.createElement('td');
          tdCheckbox.style.textAlign = 'center';
          tdCheckbox.appendChild(checkbox);
          
          var tdCategory = document.createElement('td');
          tdCategory.textContent = (cat.value === '' ? '(empty)' : cat.value);
          
          var tdFreq = document.createElement('td');
          tdFreq.style.textAlign = 'center';
          tdFreq.style.fontWeight = '700';
          tdFreq.style.color = 'var(--accent-3)';
          tdFreq.textContent = cat.freq;
          
          tr.appendChild(tdCheckbox);
          tr.appendChild(tdCategory);
          tr.appendChild(tdFreq);
          tbody.appendChild(tr);
        }
      } catch(e) {
        console.error('‚ùå Error populating category modal:', e);
      }
    }
    
    function updateCategoryStats() {
      var checkboxes = document.querySelectorAll('.category-checkbox');
      var selectedCount = 0;
      var includedObs = 0;
      
      for (var i = 0; i < checkboxes.length; i++) {
        if (checkboxes[i].checked) {
          selectedCount++;
          includedObs += parseInt(checkboxes[i].dataset.freq) || 0;
        }
      }
      
      var totalCount = checkboxes.length;
      
      qs('categorySelectedCount').textContent = selectedCount + ' of ' + totalCount;
      qs('categoryIncludedObs').textContent = includedObs;
      
      // Update color based on percentage
      var pct = totalCount > 0 ? (selectedCount / totalCount) * 100 : 0;
      var obsElem = qs('categoryIncludedObs');
      if (pct >= 80) {
        obsElem.style.color = 'var(--accent-2)'; // Green
      } else if (pct >= 50) {
        obsElem.style.color = '#ffa500'; // Orange
      } else {
        obsElem.style.color = '#ff4444'; // Red
      }
      
      // Warn if no categories selected
      var confirmBtn = qs('btnCategoryConfirm');
      if (selectedCount === 0) {
        confirmBtn.disabled = true;
        confirmBtn.style.opacity = '0.5';
      } else {
        confirmBtn.disabled = false;
        confirmBtn.style.opacity = '1';
      }
    }
    
    function createDroppedVariable(varName, zoneType) {
      var div = document.createElement('div');
      div.className = 'dropped-variable';
      
      var iconClass = zoneType === 'y' ? 'fa-bullseye' : 
                      zoneType === 'xn' ? 'fa-calculator' : 'fa-tags';
      
      // Check if this is a categorical variable with selected categories
      var categoryInfo = '';
      if (zoneType === 'xc' && STATE.variableStats[varName]) {
        var stats = STATE.variableStats[varName];
        if (stats.selectedCategories && stats.selectedCategories.length > 0) {
          var totalCats = stats.categories ? stats.categories.length : 0;
          var selCats = stats.selectedCategories.length;
          var includedObs = stats.includedObs || 0;
          categoryInfo = '<div style="font-size: 9px; color: var(--text-muted); margin-top: 2px; line-height: 1.2;">' +
            '<i class="fa-solid fa-check-circle" style="color: var(--accent-3);"></i> ' +
            selCats + '/' + totalCats + ' categories ‚Ä¢ ' + includedObs + ' obs' +
            '</div>';
        }
      }
      
      div.innerHTML = 
        '<div class="var-name">' +
          '<i class="fa-solid ' + iconClass + '" style="font-size: 10px;"></i>' +
          '<span>' + varName + '</span>' +
          categoryInfo +
        '</div>' +
        '<button class="remove-btn" title="Remove"><i class="fa-solid fa-times"></i></button>';
      
      div.querySelector('.remove-btn').addEventListener('click', function() {
        removeVariableFromZone(varName, zoneType);
      });
      
      return div;
    }
    
    function clearAssignments() {
      STATE.assignments = { y: null, xn: [], xc: [] };
      renderVariables(); // Re-enable all variables in the list
      renderAssignments();
      validateModel();
    }

    function updateModelEquation() {
      var eq = qs('modelEquation');
      if (!eq) return;

      var y = STATE.assignments.y || 'Y';
      var xn = STATE.assignments.xn.slice();
      var xc = STATE.assignments.xc.slice();
      var includeIntercept = qs('chkIncludeIntercept') ? qs('chkIncludeIntercept').checked : true;

      // If Y is not assigned, show incomplete message
      if (!STATE.assignments.y) {
        eq.textContent = 'Model: Y = (incomplete)';
        eq.style.color = 'var(--text-muted)';
        return;
      }

      var parts = [];
      if (includeIntercept) {
        parts.push('Œ≤0');
      }
      xn.forEach(function(name, i) {
        parts.push('Œ≤' + (includeIntercept ? i + 1 : i + 1) + '¬∑' + name);
      });
      xc.forEach(function(name) {
        parts.push('Œ≥¬∑' + name);
      });

      var rhs = parts.length > 0 ? parts.join(' + ') : '‚Ä¶';
      eq.textContent = 'Model: ' + y + ' = ' + rhs;
      eq.style.color = 'var(--text-secondary)';
    }
    
    // ============================================================================
    // MODEL VALIDATION
    // ============================================================================
    function validateModel() {
      var isValid = false;
      var messages = [];
      
      if (!STATE.assignments.y) {
        messages.push('‚ö†Ô∏è Response variable (Y) is required');
      }
      
      if (STATE.assignments.xn.length === 0 && STATE.assignments.xc.length === 0) {
        messages.push('‚ö†Ô∏è At least one predictor variable (Xn or Xc) is required');
      }
      
      isValid = STATE.assignments.y && 
                (STATE.assignments.xn.length > 0 || STATE.assignments.xc.length > 0);
      
      qs('btnRunAnalysis').disabled = !isValid;
      
      return { valid: isValid, messages: messages };
    }
    
    // ============================================================================
    // TAB SWITCHING
    // ============================================================================
    function switchTab(tabName) {
      // Update tab buttons
      var tabButtons = document.querySelectorAll('.tabs button');
      for (var i = 0; i < tabButtons.length; i++) {
        tabButtons[i].classList.remove('active');
      }
      document.querySelector('[data-tab="' + tabName + '"]').classList.add('active');
      
      // Update tab panels
      var panels = document.querySelectorAll('.tab-panel');
      for (var j = 0; j < panels.length; j++) {
        panels[j].classList.remove('active');
      }
      qs('panel' + tabName.charAt(0).toUpperCase() + tabName.slice(1)).classList.add('active');
    }
    
    // ============================================================================
    // EVENT HANDLERS
    // ============================================================================
    
    // Tab switching
    var tabButtons = document.querySelectorAll('.tabs button');
    for (var i = 0; i < tabButtons.length; i++) {
      tabButtons[i].addEventListener('click', function() {
        switchTab(this.dataset.tab);
      });
    }
    
    var refreshBtn = qs('btnRefreshData');
    if (refreshBtn) {
      refreshBtn.addEventListener('click', function() {
        sendToHost('requestData', null);
      });
    }
    
    // Load sample data (button removed - uncomment if needed for testing)
    // qs('btnLoadSample').addEventListener('click', function() {
    //   loadSampleData();
    // });
    
    qs('btnValidate').addEventListener('click', function() {
      var result = validateModel();
      
      if (result.valid) {
        var summary = 
          '‚úì Model Specification Valid\n\n' +
          'Response (Y):\n  ' + STATE.assignments.y + '\n\n' +
          'Numeric Predictors (Xn):\n  ' + (STATE.assignments.xn.length > 0 ? STATE.assignments.xn.join(', ') : '(none)') + '\n\n' +
          'Categorical Predictors (Xc):\n  ' + (STATE.assignments.xc.length > 0 ? STATE.assignments.xc.join(', ') : '(none)');
        
        showToast(summary.replace(/\n/g, '<br>'), 'success', 6000);
      } else {
        showToast('Model Incomplete: ' + result.messages.join(', '), 'error', 5000);
      }
    });
    
    qs('btnRunAnalysis').addEventListener('click', function() {
      var result = validateModel();
      
      if (!result.valid) {
        showToast('Model Incomplete. Please assign: Response variable (Y) and at least one predictor (Xn or Xc)', 'error', 5000);
        return;
      }
      
      console.log('üì§ Running regression...');
      
      // Get intercept checkbox value
      var includeIntercept = qs('chkIncludeIntercept').checked ? 1 : 0;
      
      // Build model specification with Excel range addresses
      var modelSpec = {
        y: STATE.assignments.y,
        xn: STATE.assignments.xn,
        xc: STATE.assignments.xc,
        intercept: includeIntercept,
        ranges: {}
      };
      
      console.log('üìä Include Intercept:', includeIntercept === 1 ? 'YES' : 'NO');
      
      // Add range addresses if available (from real Excel data)
      if (STATE.variableStats) {
        // Add Y range
        if (STATE.assignments.y && STATE.variableStats[STATE.assignments.y]) {
          modelSpec.ranges[STATE.assignments.y] = STATE.variableStats[STATE.assignments.y].rangeAddress;
        }
        
        // Add Xn ranges
        for (var i = 0; i < STATE.assignments.xn.length; i++) {
          var varName = STATE.assignments.xn[i];
          if (STATE.variableStats[varName]) {
            modelSpec.ranges[varName] = STATE.variableStats[varName].rangeAddress;
          }
        }
        
        // Add Xc ranges
        for (var j = 0; j < STATE.assignments.xc.length; j++) {
          var varName = STATE.assignments.xc[j];
          if (STATE.variableStats[varName]) {
            modelSpec.ranges[varName] = STATE.variableStats[varName].rangeAddress;
          }
        }
      }
      
      console.log('üìä Model specification:', modelSpec);
      sendToHost('regressionModel', modelSpec);
      
      var xnList = STATE.assignments.xn.length > 0 ? STATE.assignments.xn.join(', ') : '(none)';
      var xcList = STATE.assignments.xc.length > 0 ? STATE.assignments.xc.join(', ') : '(none)';
      
      showToast('Regression Analysis Started<br><br>' +
            '<strong>Response:</strong> ' + STATE.assignments.y + '<br>' +
            '<strong>Numeric:</strong> ' + xnList + '<br>' +
            '<strong>Categorical:</strong> ' + xcList, 'success', 5000);
    });
    
    // Category modal button listeners
    qs('btnCategoryCancel').addEventListener('click', function() {
      console.log('‚ùå Category assignment cancelled');
      hideCategoryModal();
    });
    
    qs('btnCategoryConfirm').addEventListener('click', function() {
      confirmCategoryAssignment();
    });
    
    qs('btnSelectAllCat').addEventListener('click', function() {
      var checkboxes = document.querySelectorAll('.category-checkbox');
      for (var i = 0; i < checkboxes.length; i++) {
        checkboxes[i].checked = true;
      }
      updateCategoryStats();
    });
    
    qs('btnDeselectAllCat').addEventListener('click', function() {
      var checkboxes = document.querySelectorAll('.category-checkbox');
      for (var i = 0; i < checkboxes.length; i++) {
        checkboxes[i].checked = false;
      }
      updateCategoryStats();
    });
    
    // Close modal when clicking overlay
    qs('categoryModal').addEventListener('click', function(e) {
      if (e.target === this) {
        hideCategoryModal();
      }
    });
    
    // Setup drop zones
    var dropZones = document.querySelectorAll('.drop-zone');
    for (var i = 0; i < dropZones.length; i++) {
      dropZones[i].addEventListener('dragover', handleDragOver);
      dropZones[i].addEventListener('dragenter', handleDragEnter);
      dropZones[i].addEventListener('dragleave', handleDragLeave);
      dropZones[i].addEventListener('drop', handleDrop);
    }
    
    qs('btnHelp').addEventListener('click', function() {
      var helpText = 
        'üìä REGRESSION MODEL (ANCOVA) BUILDER\n\n' +
        'WORKFLOW:\n\n' +
        '1. LOAD DATA\n' +
        '   ‚Ä¢ Select a range in the Regression taskpane\n' +
        '   ‚Ä¢ Data must include headers in first row\n\n' +
        '2. ASSIGN VARIABLES\n' +
        '   ‚Ä¢ Drag variables from the list to model tabs:\n' +
        '     - Y (Response): ONE numeric variable (required)\n' +
        '     - Xn (Numeric): Multiple numeric predictors\n' +
        '     - Xc (Categorical): Multiple categorical predictors\n' +
        '   ‚Ä¢ Variables are removed from list when assigned\n' +
        '   ‚Ä¢ Click √ó to remove and return variable to list\n\n' +
        '3. RUN ANALYSIS\n' +
        '   ‚Ä¢ Validate: Check model specification\n' +
        '   ‚Ä¢ Run Regression: Execute analysis\n\n' +
        'üí° At least one predictor (Xn or Xc) is required';
      
      alert(helpText);
    });
    
    // ============================================================================
    // OFFICE DIALOG INITIALIZATION
    // ============================================================================
    function onMessageFromParent(arg) {
      try {
        var message = JSON.parse(arg.message);
        if (message.type === 'REGRESSION_DATA' && message.payload) {
          applyRegressionPayload(message.payload);
        } else if (message.action === 'loadData' && message.data) {
          applyRegressionPayload(message.data);
        }
      } catch (e) {
        console.error('Error parsing message from parent:', e);
      }
    }

    function requestDataFromParent() {
      sendToHost('requestData', null);
    }

    if (typeof Office !== 'undefined') {
      Office.onReady(function() {
        Office.context.ui.addHandlerAsync(
          Office.EventType.DialogParentMessageReceived,
          onMessageFromParent
        );
        requestDataFromParent();
        sendToHost('ready', null);
        var intercept = qs('chkIncludeIntercept');
        if (intercept) {
          intercept.addEventListener('change', updateModelEquation);
        }
      });
    }
    
  </script>
</body>
</html>
