<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <title id="page-title">Linear Regression Analysis</title>
  <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet"/>
  
  <!-- Highcharts for ANCOVA visualization -->
  <script src="https://code.highcharts.com/highcharts.js"></script>
  <script src="https://code.highcharts.com/modules/exporting.js"></script>
  
  <!-- Regression computation library -->
  <script src="../../../src/shared/js/core/regression-compute.js"></script>
  
  <!-- Saved analyses manager -->
  <script src="../../../src/shared/js/core/saved-analyses-manager.js"></script>

  <style>
    /* Dark Theme (Default) */
    :root{
      --surface-0:#0c1624;
      --surface-1:#1a1f2e;
      --surface-2:#242938;
      --border:#2d3748;
      --accent-1:rgb(255,165,120);
      --accent-2:rgb(120,200,255);
      --success:#4ade80;
      --warning:#fbbf24;
      --danger:#fb7185;
      --text-primary:#fff;
      --text-secondary:rgba(255,255,255,0.8);
      --text-muted:rgba(255,255,255,0.6);
      --panel-radius:10px;
      --panel-shadow:0 4px 20px rgba(0,0,0,.4);
      --header-color:var(--accent-1);
    }
    
    /* Light Theme */
    :root[data-theme="light"]{
      --surface-0:#f3f4f6;
      --surface-1:#ffffff;
      --surface-2:#f9fafb;
      --border:#e5e7eb;
      --accent-1:#2563eb;
      --accent-2:#1d4ed8;
      --text-primary:#111827;
      --text-secondary:#4b5563;
      --text-muted:#6b7280;
      --panel-radius:10px;
      --panel-shadow:0px 4px 20px rgba(0, 0, 0, 0.08);
      --header-color:var(--accent-1);
    }

    html,body{height:100%;margin:0;padding:0;}
    body{background:var(--surface-0);color:var(--text-primary);font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;overflow-x:hidden;}

    .wrap{ display:flex; justify-content:center; padding:clamp(3px,1vh,8px) clamp(6px,2vh,12px) 19px; }
    .card{
      width:min(1600px,99%); background:var(--surface-1);
      min-height: 740px;
      border-radius:var(--panel-radius); box-shadow:var(--panel-shadow);
      border:1px solid var(--border); overflow:visible;
      display:flex; flex-direction:column;
      animation:panelFadeIn .3s ease-out;
    }
    @keyframes panelFadeIn {
      from { opacity: 0; transform: translateY(6px); }
      to { opacity: 1; transform: translateY(0); }
    }
    /* Hero Section - Completely Separate Design */
    .hero-section {
      background: linear-gradient(135deg, #1a2332 0%, #0f1419 100%);
      border-bottom: 3px solid var(--accent-2);
      padding: 20px 24px;
      margin: -1px -1px 0 -1px; /* Extend to edges */
      border-radius: var(--panel-radius) var(--panel-radius) 0 0;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5), inset 0 -1px 0 rgba(120, 200, 255, 0.2);
      position: relative;
      overflow: visible;
      transition: all 0.3s ease;
    }
    
    /* Hero Section - Light Theme Override */
    :root[data-theme="light"] .hero-section {
      background: linear-gradient(135deg, #e0f2fe 0%, #bae6fd 100%);
      border-bottom: 3px solid var(--accent-1);
      box-shadow: 0 4px 20px rgba(37, 99, 235, 0.15), inset 0 -1px 0 rgba(37, 99, 235, 0.2);
    }
    
    .hero-section::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: linear-gradient(90deg, 
        transparent 0%, 
        var(--accent-2) 20%, 
        var(--accent-1) 50%, 
        var(--accent-2) 80%, 
        transparent 100%);
      opacity: 0.6;
    }
    
    .hero-content {
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: relative;
      z-index: 1;
    }
    
    .hero-title {
      display: flex;
      align-items: center;
      gap: 14px;
      font-size: 1.4rem;
      font-weight: 800;
      letter-spacing: 0.5px;
      text-transform: uppercase;
      color: var(--text-primary);
      text-shadow: 0 2px 10px rgba(120, 200, 255, 0.3);
    }
    
    .hero-title i {
      font-size: 1.6rem;
      color: var(--accent-2);
      filter: drop-shadow(0 0 8px rgba(120, 200, 255, 0.6));
    }
    
    .hero-controls {
      display: flex;
      gap: 14px;
      align-items: center;
    }
    
    .hero-control-group {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 14px;
      background: rgba(0, 0, 0, 0.4);
      border-radius: 8px;
      border: 1px solid rgba(120, 200, 255, 0.2);
      backdrop-filter: blur(10px);
      transition: all 0.3s ease;
    }
    
    .hero-control-group:hover {
      background: rgba(0, 0, 0, 0.5);
      border-color: rgba(120, 200, 255, 0.4);
      box-shadow: 0 4px 12px rgba(120, 200, 255, 0.2);
    }
    
    .hero-control-group label {
      font-size: 12px;
      color: var(--text-secondary);
      font-weight: 600;
      white-space: nowrap;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .hero-control-group select {
      background: rgba(255, 255, 255, 0.05);
      color: var(--text-primary);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 6px;
      padding: 6px 10px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .hero-control-group select:hover {
      background: rgba(255, 255, 255, 0.08);
      border-color: rgba(120, 200, 255, 0.4);
    }
    
    .hero-control-group select:focus {
      outline: none;
      border-color: var(--accent-2);
      box-shadow: 0 0 0 3px rgba(120, 200, 255, 0.2);
    }
    
    /* Theme Toggle Button */
    .theme-toggle-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 42px;
      height: 42px;
      border-radius: 50%;
      background: rgba(0, 0, 0, 0.4);
      border: 2px solid rgba(120, 200, 255, 0.3);
      color: var(--accent-2);
      cursor: pointer;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
      position: relative;
    }
    
    .theme-toggle-btn:hover {
      background: rgba(0, 0, 0, 0.5);
      border-color: rgba(120, 200, 255, 0.5);
      box-shadow: 0 4px 12px rgba(120, 200, 255, 0.3);
      transform: scale(1.05);
    }
    
    .theme-toggle-btn i {
      font-size: 18px;
      transition: all 0.3s ease;
    }
    
    .theme-toggle-btn:active {
      transform: scale(0.95);
    }
    
    /* Light theme adjustments */
    :root[data-theme="light"] .theme-toggle-btn {
      background: rgba(255, 255, 255, 0.8);
      border-color: rgba(37, 99, 235, 0.3);
      color: var(--accent-1);
    }
    
    :root[data-theme="light"] .theme-toggle-btn:hover {
      background: rgba(255, 255, 255, 1);
      border-color: rgba(37, 99, 235, 0.5);
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2);
    }
    
    /* Light Theme - Additional Adjustments */
    :root[data-theme="light"] .hero-title {
      color: var(--text-primary);
      text-shadow: 0 2px 10px rgba(37, 99, 235, 0.2);
    }
    
    :root[data-theme="light"] .hero-title i {
      color: var(--accent-1);
      filter: drop-shadow(0 0 8px rgba(37, 99, 235, 0.4));
    }
    
    :root[data-theme="light"] .hero-control-group {
      background: rgba(255, 255, 255, 0.6);
      border-color: rgba(37, 99, 235, 0.2);
    }
    
    :root[data-theme="light"] .hero-control-group:hover {
      background: rgba(255, 255, 255, 0.8);
      border-color: rgba(37, 99, 235, 0.3);
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.15);
    }
    
    :root[data-theme="light"] .hero-control-group select {
      background: rgba(255, 255, 255, 0.8);
    }
    
    :root[data-theme="light"] .tab-button {
      background: rgba(255, 255, 255, 0.5);
      color: var(--text-muted);
      border-color: rgba(37, 99, 235, 0.2);
    }
    
    :root[data-theme="light"] .tab-button.active {
      background: var(--surface-1);
      color: var(--accent-1);
      border-color: var(--accent-1);
    }
    
    :root[data-theme="light"] .tab-button:hover {
      background: rgba(255, 255, 255, 0.8);
      color: var(--text-secondary);
    }
    
    :root[data-theme="light"] .save-analysis-btn {
      box-shadow: 0 3px 8px rgba(15, 23, 42, 0.12);
    }
    
    :root[data-theme="light"] .dropdown-btn {
      border-color: rgba(37, 99, 235, 0.3);
    }
    
    :root[data-theme="light"] .dropdown-btn:hover {
      border-color: rgba(37, 99, 235, 0.5);
      box-shadow: 0 6px 12px rgba(37, 99, 235, 0.2);
    }
    
    .card-head{
      display:flex; align-items:center; justify-content:space-between;
      background:transparent; color:var(--header-color);
      padding:6px 12px; font-weight:600; font-size:1rem; letter-spacing:.3px;
    }
    .card-body{ padding:8px; flex:1; min-height:0; overflow:visible; }

    /* Dropdown Navigation Styles */
    .dropdown-container{ position:relative; }
    .dropdown-content{
      display:none; position:absolute; top:100%; right:0; min-width:260px; z-index:1000;
      background:var(--surface-1); border:1px solid var(--border); border-radius:8px;
      box-shadow:var(--panel-shadow); padding:8px 0; margin-top:4px;
      opacity: 0;
      transform: scaleY(0.95);
      transform-origin: top;
      transition: all 0.25s ease-in-out;
    }
    .dropdown-content.show{ display:block; opacity:1; transform:scaleY(1); }

    .dropdown-btn{
      position:relative; transition: all .3s ease; cursor:pointer; border-radius:8px;
      background:linear-gradient(145deg,#4a5568,#2d3748); border:2px solid rgba(120, 200, 255, 0.3);
      color:#e2e8f0; padding:10px 16px; font-size:13px; font-weight:700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      box-shadow:0 4px 8px rgba(0,0,0,.3), inset 0 1px 0 rgba(255,255,255,.1);
    }
    .dropdown-btn:hover{ 
      transform:translateY(-2px); 
      border-color: rgba(120, 200, 255, 0.5);
      box-shadow:0 6px 12px rgba(120, 200, 255, 0.3);
    }
    .dropdown-arrow{ display:inline-block; margin-left:8px; transition:transform .3s }
    .dropdown-btn.open .dropdown-arrow{ transform:rotate(180deg) }

    .dropdown-content a {
      padding: 10px 16px;
      display: flex;
      align-items: center;
      text-decoration: none;
      color: var(--text-secondary);
      transition: all 0.25s ease-in-out;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    .dropdown-content a:last-child {
      border-bottom: none;
    }
    .dropdown-content a:hover {
      background-color: var(--accent-1);
      color: var(--surface-0);
      transform: translateX(2px);
    }
    .dropdown-content a.selected {
      background-color: var(--accent-1);
      color: var(--surface-0);
      font-weight: bold;
    }

    .dropdown-separator {
      height: 1px;
      background: rgba(255, 255, 255, 0.2);
      margin: 4px 0;
      pointer-events: none;
    }

    /* Stats Container */
    .kpi-strip{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(130px,1fr));
      gap:8px;
      margin:0 0 8px 0;
    }
    .kpi-card{
      background:linear-gradient(145deg,rgba(120,200,255,0.12),rgba(120,200,255,0.04));
      border:1px solid rgba(120,200,255,0.28);
      border-radius:6px;
      padding:7px 8px;
      box-shadow:inset 0 1px 0 rgba(255,255,255,0.06);
    }
    .kpi-label{
      font-size:.58rem;
      color:var(--text-muted);
      text-transform:uppercase;
      letter-spacing:.4px;
      margin-bottom:2px;
    }
    .kpi-value{
      font-size:.82rem;
      font-weight:700;
      color:var(--accent-2);
      font-variant-numeric: tabular-nums;
    }
    .stats-container {
      display: flex;
      gap: 8px;
      justify-content: space-between;
      margin-bottom: 8px;
      flex-wrap: wrap;
    }

    .stat-panel {
      flex: 1;
      min-width: 200px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid var(--border);
      border-radius: 4px;
      padding: 0;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
      transition: transform .2s ease, box-shadow .2s ease;
    }
    .stat-panel:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.25);
    }

    .stat-panel-heading {
      background: linear-gradient(135deg, rgba(0, 51, 102, 0.8), rgba(0, 102, 204, 0.6));
      color: #ffffff;
      padding: 4px 8px;
      border-radius: 4px 4px 0 0;
      font-weight: 700;
      font-size: 0.7rem;
      text-align: center;
      text-transform: uppercase;
      letter-spacing: 0.3px;
      border-bottom: 1px solid var(--accent-1);
    }
    .heading-with-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }
    .collapse-toggle {
      background: rgba(255,255,255,0.14);
      border: 1px solid rgba(255,255,255,0.32);
      color: #ffffff;
      padding: 2px 8px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.62rem;
      font-weight: 600;
      transition: background .2s ease;
    }
    .collapse-toggle:hover {
      background: rgba(255,255,255,0.24);
    }
    .collapsible-content {
      max-height: 3000px;
      overflow: hidden;
      transition: max-height .24s ease, opacity .2s ease;
      opacity: 1;
    }
    .collapsible-content.is-collapsed {
      max-height: 0;
      opacity: 0;
    }

    .stat-panel-body {
      padding: 5px 8px;
    }

    .stat-field {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 2px 0;
      padding: 1px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.03);
    }

    .stat-field:last-child {
      border-bottom: none;
    }

    .stat-label {
      font-weight: 600;
      color: var(--text-secondary);
      font-size: 0.7rem;
    }
    .metric-help {
      position: relative;
      display: inline-flex;
      align-items: center;
      margin-left: 5px;
      color: var(--text-muted);
      cursor: help;
      font-size: 0.65rem;
      vertical-align: middle;
    }
    .metric-tip {
      position: fixed;
      left: 0;
      top: 0;
      transform: none;
      width: min(280px, calc(100vw - 16px));
      background: var(--surface-0);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text-secondary);
      font-size: 0.72rem;
      font-weight: 400;
      line-height: 1.35;
      text-transform: none;
      letter-spacing: 0;
      padding: 8px 10px;
      box-shadow: var(--panel-shadow);
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
      transition: opacity .18s ease;
      z-index: 9999;
    }
    .metric-help:hover .metric-tip,
    .metric-tip.is-visible {
      opacity: 1;
      visibility: visible;
    }

    .stat-value {
      background: linear-gradient(135deg, rgba(120, 200, 255, 0.15), rgba(120, 200, 255, 0.05));
      border: 1px solid rgba(120, 200, 255, 0.3);
      border-radius: 4px;
      padding: 2px 6px;
      min-width: 60px;
      text-align: center;
      color: var(--accent-2);
      font-weight: 700;
      font-size: 0.75rem;
      font-variant-numeric: tabular-nums;
    }
    .metric-good { color: var(--success) !important; border-color: rgba(74, 222, 128, 0.55) !important; }
    .metric-warning { color: var(--warning) !important; border-color: rgba(251, 191, 36, 0.55) !important; }
    .metric-bad { color: var(--danger) !important; border-color: rgba(251, 113, 133, 0.55) !important; }
    .insight-panel {
      margin: 0 0 8px 0;
      border: 1px solid rgba(255, 165, 120, 0.35);
      border-left: 4px solid var(--accent-1);
      border-radius: 6px;
      background: rgba(255, 165, 120, 0.08);
      padding: 8px 10px;
    }
    .insight-title {
      margin: 0 0 6px 0;
      color: var(--accent-1);
      font-size: 0.72rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: .35px;
    }
    .insight-text {
      margin: 0;
      color: var(--text-secondary);
      font-size: 0.72rem;
      line-height: 1.4;
    }

    .stat-note {
      margin-top: 12px;
      padding: 8px;
      background: rgba(255, 165, 120, 0.1);
      border-left: 3px solid var(--accent-1);
      border-radius: 4px;
      color: var(--text-muted);
      font-size: 0.85rem;
      font-style: italic;
    }

    /* Table Container */
    .table-container {
      width: 100%;
      margin: 20px auto 0;
      overflow-x: auto;
      overflow-y: auto;
      max-height: calc(100vh - 50px);
      border: 0px solid var(--border) !important;
      border-radius: 0px;
      box-shadow: 0px 0px 0px transparent;
    }

    /* Modern scrollbar styling */
    .table-container::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    .table-container::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 4px;
    }

    .table-container::-webkit-scrollbar-thumb {
      background: linear-gradient(135deg, var(--accent-1), rgba(255, 165, 120, 0.7));
      border-radius: 4px;
      border: 0px solid rgba(255, 255, 255, 0.1);
      transition: all 0.3s ease;
    }

    .table-container::-webkit-scrollbar-thumb:hover {
      background: linear-gradient(135deg, rgba(255, 165, 120, 0.9), var(--accent-1));
      box-shadow: 0 0 8px rgba(255, 165, 120, 0.4);
    }

    .table-container::-webkit-scrollbar-corner {
      background: rgba(255, 255, 255, 0.05);
    }

    /* Firefox scrollbar styling */
    .table-container {
      scrollbar-width: thin;
      scrollbar-color: var(--accent-1) rgba(255, 255, 255, 0.05);
    }

    .regression-table {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
      border: 0px solid rgba(255, 255, 255, 0.3);
    }

    .regression-table th {
      background: linear-gradient(135deg, rgba(0, 51, 102, 0.9), rgba(0, 102, 204, 0.7));
      color: #fff;
      padding: 5px 4px;
      position: sticky;
      top: 0;
      z-index: 2;
      font-weight: 700;
      text-align: center;
      white-space: nowrap;
      border: 1px solid rgba(255, 255, 255, 0.3);
      font-size: 0.65rem;
      text-transform: uppercase;
      letter-spacing: 0.2px;
      min-width: 60px;
    }

    .regression-table th:first-child {
      position: sticky;
      left: 0;
      z-index: 3;
      text-align: left;
      min-width: 90px;
      max-width: 180px;
    }

    .regression-table td {
      background: rgba(255, 255, 255, 0.04);
      color: var(--text-primary);
      border: 1px solid rgba(255, 255, 255, 0.15);
      padding: 4px 6px;
      text-align: right;
      font-size: 0.7rem;
      white-space: nowrap;
      min-width: 60px;
      font-variant-numeric: tabular-nums;
    }

    .regression-table td:first-child {
      text-align: left;
      font-weight: 600;
      white-space: nowrap;
      position: sticky;
      left: 0;
      z-index: 1;
      background: rgba(255, 255, 255, 0.06);
      color: var(--accent-1);
      min-width: 90px;
      max-width: 180px;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    /* Variable type colors - More vibrant and distinct */
    .var-intercept {
      color: #fbbf24 !important; /* Bright Amber for intercept */
      font-weight: 700 !important;
      text-shadow: 0 0 8px rgba(251, 191, 36, 0.4);
    }
    
    .var-numeric {
      color: #3b82f6 !important; /* Bright Blue for numeric */
      font-weight: 600 !important;
    }
    
    .var-categorical {
      color: #f472b6 !important; /* Bright Pink/Magenta for categorical */
      font-weight: 600 !important;
      text-shadow: 0 0 6px rgba(244, 114, 182, 0.3);
    }

    .regression-table tbody tr:hover {
      background-color: rgba(255, 221, 87, 0.15);
    }
    .regression-table td.coef-cell { color: var(--accent-2); font-weight: 700; }
    .regression-table td.ci-cell { color: var(--text-muted); }
    .regression-table td.pvalue-good { color: var(--success); font-weight: 700; }
    .regression-table td.pvalue-warning { color: var(--warning); font-weight: 700; }
    .regression-table td.pvalue-bad { color: var(--danger); font-weight: 700; }

    .regression-table tbody tr:nth-child(even) {
      background-color: rgba(240, 248, 255, 0.03);
    }

    /* Section separator rows */
    .regression-table tbody .section-header {
      background: transparent !important;
    }

    .regression-table tbody .section-header td {
      padding: 6px 10px !important;
      font-weight: 500 !important;
      font-size: 0.55rem !important;
      text-transform: uppercase !important;
      letter-spacing: 0.5px !important;
      color: rgba(255, 255, 255, 0.5) !important;
      text-align: left !important;
      background: transparent !important;
      position: relative !important;
      z-index: 0 !important;
      border-left: 0 !important;
      border-right: 0 !important;
      border-bottom: 0 !important;
      border-top: 1px solid rgba(255, 255, 255, 0.1) !important;
    }

    @media screen and (max-width: 768px) {
      .stats-container {
        flex-direction: column;
      }
      .stat-panel {
        min-width: 100%;
      }
    }
    
    /* Regression Equation Section */
    .equation-section {
      margin: 20px auto 0;
      padding: 20px;
      background: var(--surface-2);
      border: 2px solid var(--accent-1);
      border-radius: 8px;
      box-shadow: 2px 4px 10px rgba(0, 0, 0, 0.3);
    }
    
    .equation-title {
      color: var(--accent-1);
      font-size: 16px;
      font-weight: 700;
      margin-bottom: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .equation-formula {
      font-family: 'Courier New', monospace;
      font-size: 16px;
      color: var(--text-primary);
      background: var(--surface-0);
      padding: 16px;
      border-radius: 6px;
      border-left: 4px solid var(--accent-2);
      line-height: 1.8;
      overflow-x: auto;
      white-space: nowrap;
    }
    
    .equation-formula .y-var {
      color: var(--accent-1);
      font-weight: 900;
      font-size: 20px;
      text-transform: uppercase;
      letter-spacing: 1px;
      text-shadow: 0 0 10px rgba(255, 165, 120, 0.5);
      padding: 0 4px;
    }
    
    .equation-formula .var {
      color: var(--accent-1);
      font-weight: 600;
    }
    
    .equation-formula .coef {
      color: var(--accent-2);
      font-weight: 700;
    }
    
    /* Toggle Equation Button */
    .toggle-equation-btn {
      background: var(--surface-2);
      border: 1px solid var(--accent-1);
      color: var(--accent-1);
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      margin: 16px auto 0;
      display: block;
      transition: all 0.3s ease;
    }
    
    .toggle-equation-btn:hover {
      background: var(--accent-1);
      color: var(--surface-0);
      box-shadow: 0 4px 12px rgba(255, 165, 120, 0.3);
    }
    
    .toggle-equation-btn i {
      margin-right: 6px;
      transition: transform 0.3s ease;
    }
    
    .toggle-equation-btn.active i {
      transform: rotate(180deg);
    }
    
    /* Save Analysis Button Styling - Hero Version */
    .save-analysis-btn {
      position: relative;
      transition: all .3s ease;
      cursor: pointer;
      border-radius: 8px;
      background: linear-gradient(145deg, rgba(148, 163, 184, 0.18), rgba(100, 116, 139, 0.16)) !important;
      border: 1px solid rgba(148, 163, 184, 0.45) !important;
      color: #ffffff !important;
      padding: 10px 20px;
      font-size: 13px;
      font-weight: 650;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      box-shadow: 0 3px 8px rgba(2, 6, 23, 0.35), inset 0 1px 0 rgba(255, 255, 255, .12);
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .save-analysis-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 12px rgba(2, 6, 23, 0.45);
    }
    .save-model-btn {
      background: linear-gradient(145deg, rgba(16, 185, 129, 0.24), rgba(5, 150, 105, 0.2)) !important;
      border-color: rgba(16, 185, 129, 0.75) !important;
      color: #d1fae5 !important;
    }
    .save-model-btn:hover {
      background: linear-gradient(145deg, rgba(16, 185, 129, 0.32), rgba(5, 150, 105, 0.28)) !important;
      border-color: rgba(16, 185, 129, 0.95) !important;
    }
    .save-html-btn {
      background: linear-gradient(145deg, rgba(59, 130, 246, 0.16), rgba(37, 99, 235, 0.14)) !important;
      border-color: rgba(96, 165, 250, 0.7) !important;
      color: #dbeafe !important;
    }
    .save-html-btn:hover {
      background: linear-gradient(145deg, rgba(59, 130, 246, 0.24), rgba(37, 99, 235, 0.2)) !important;
      border-color: rgba(147, 197, 253, 0.95) !important;
    }
    
    .save-analysis-btn:active {
      transform: translateY(0);
    }
    
    .save-analysis-btn i {
      font-size: 15px;
      filter: drop-shadow(0 0 4px rgba(255, 255, 255, 0.5));
    }
    
    /* AI Interpret Button Styling */
    .ai-interpret-btn {
      position: relative;
      transition: .3s;
      cursor: pointer;
      border-radius: 8px;
      background: linear-gradient(145deg, #7c3aed, #a855f7) !important;
      border: 1px solid #9333ea !important;
      color: #ffffff !important;
      padding: 8px 12px;
      font-size: 12px;
      font-weight: 600;
      box-shadow: 0 4px 8px rgba(124, 58, 237, 0.3);
      margin-left: 8px;
    }
    
    .ai-interpret-btn:hover {
      background: linear-gradient(145deg, #6d28d9, #9333ea) !important;
      transform: translateY(-1px);
      box-shadow: 0 6px 12px rgba(124, 58, 237, 0.4);
    }
    
    .ai-interpret-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }
    
    .ai-interpret-btn i {
      margin-right: 6px;
    }
    
    /* Loading overlay */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(17, 24, 39, 0.95);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      transition: opacity 0.3s ease;
    }
    
    .loading-overlay.hidden {
      opacity: 0;
      pointer-events: none;
    }
    
    .loading-spinner {
      width: 60px;
      height: 60px;
      border: 4px solid rgba(59, 130, 246, 0.2);
      border-top-color: #3b82f6;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .loading-text {
      margin-top: 20px;
      color: #e5e7eb;
      font-size: 1rem;
      font-weight: 500;
    }
    
    /* View Mode Control */
    .view-container {
      display: flex;
      flex-direction: column;
      height: 100%;
    }
    
    .single-page-view {
      display: none;
      padding: 16px;
      overflow-y: auto;
      height: 100%;
    }
    
    .single-page-view.active {
      display: block;
    }
    
    .tabbed-view-container {
      display: flex;
      flex-direction: column;
      height: 100%;
    }
    
    .tabbed-view-container.hidden {
      display: none;
    }
    
    /* Single Page View Styles (matching input screen) */
    .sp-section {
      margin-bottom: 20px;
      background: var(--surface-1);
      border-radius: 8px;
      border: 1px solid var(--border);
      overflow: hidden;
    }
    
    .sp-section-header {
      padding: 12px 16px;
      background: linear-gradient(135deg, rgba(58, 123, 213, 0.15), rgba(58, 123, 213, 0.05));
      border-bottom: 2px solid var(--accent-2);
      font-size: 13px;
      font-weight: 700;
      letter-spacing: 0.8px;
      text-transform: uppercase;
      color: var(--accent-2);
    }
    
    .sp-section-body {
      padding: 16px;
    }
    
    .sp-stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 16px;
      margin-bottom: 16px;
    }
    
    .sp-stat-box {
      background: rgba(0, 0, 0, 0.2);
      padding: 12px;
      border-radius: 6px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .sp-stat-label {
      font-size: 11px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 6px;
    }
    
    .sp-stat-value {
      font-size: 18px;
      font-weight: 700;
      color: var(--text-primary);
    }
    
    .sp-table-container {
      width: 100%;
      overflow-x: auto;
      margin-top: 12px;
    }
    
    .sp-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }
    
    .sp-table th {
      background: linear-gradient(135deg, rgba(58, 123, 213, 0.2), rgba(58, 123, 213, 0.1));
      color: var(--accent-2);
      padding: 10px 12px;
      text-align: left;
      font-weight: 600;
      text-transform: uppercase;
      font-size: 11px;
      letter-spacing: 0.5px;
      border-bottom: 2px solid var(--accent-2);
    }
    
    .sp-table td {
      padding: 10px 12px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      color: var(--text-secondary);
    }
    
    .sp-table tbody tr:hover {
      background: rgba(255, 255, 255, 0.05);
    }
    
    .sp-equation {
      background: linear-gradient(135deg, rgba(255, 165, 120, 0.1), rgba(255, 165, 120, 0.05));
      border: 2px solid var(--accent-1);
      border-radius: 8px;
      padding: 16px;
      margin-top: 16px;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      line-height: 1.8;
      color: var(--text-primary);
      overflow-x: auto;
    }
    
    /* Custom Modal Dialog Styles */
    .custom-modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      animation: fadeIn 0.2s ease-in;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    .custom-modal {
      background: var(--surface-1);
      border: 2px solid var(--accent-2);
      border-radius: 12px;
      padding: 24px;
      max-width: 500px;
      width: 90%;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
      animation: slideIn 0.3s ease-out;
    }
    
    @keyframes slideIn {
      from {
        transform: translateY(-20px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }
    
    .custom-modal-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
      font-size: 18px;
      font-weight: 700;
      color: var(--accent-2);
    }
    
    .custom-modal-header i {
      font-size: 24px;
    }
    
    .custom-modal-body {
      color: var(--text-secondary);
      line-height: 1.6;
      margin-bottom: 20px;
    }
    
    .custom-modal-input {
      width: 100%;
      padding: 12px;
      background: var(--surface-2);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text-primary);
      font-size: 14px;
      margin-top: 12px;
      box-sizing: border-box;
    }
    
    .custom-modal-input:focus {
      outline: none;
      border-color: var(--accent-2);
      box-shadow: 0 0 0 3px rgba(120, 200, 255, 0.2);
    }
    
    .custom-modal-actions {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }
    
    .custom-modal-btn {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .custom-modal-btn-primary {
      background: linear-gradient(135deg, #10b981, #059669);
      color: white;
    }
    
    .custom-modal-btn-primary:hover {
      background: linear-gradient(135deg, #059669, #047857);
      transform: translateY(-1px);
    }
    
    .custom-modal-btn-secondary {
      background: rgba(255, 255, 255, 0.1);
      color: var(--text-secondary);
      border: 1px solid var(--border);
    }
    
    .custom-modal-btn-secondary:hover {
      background: rgba(255, 255, 255, 0.15);
    }
    
    .success-message {
      color: #10b981;
    }
    
    .error-message {
      color: #ef4444;
    }

    /* Tab Navigation - Visually Separated from Hero */
    .tab-navigation {
      display: flex;
      align-items: flex-end;
      gap: 8px;
      background: transparent;
      padding: 12px 0 0 0;
      border-bottom: 0;
      overflow-x: auto;
      scrollbar-width: thin;
      margin-top: 12px;
    }
    .tab-controls-right {
      margin-left: auto;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding-bottom: 8px;
      white-space: nowrap;
    }
    .tab-decimal-label {
      font-size: 0.78rem;
      font-weight: 700;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: .4px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .tab-decimal-select {
      background: rgba(255, 255, 255, 0.08);
      color: var(--text-primary);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 6px;
      padding: 5px 10px;
      font-size: 0.8rem;
      font-weight: 600;
    }
    
    .tab-button {
      padding: 12px 24px;
      background: rgba(0, 0, 0, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-bottom: none;
      color: var(--text-muted);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      border-radius: 12px 12px 0 0;
      transition: all 0.3s ease;
      position: relative;
      white-space: nowrap;
      display: flex;
      align-items: center;
      gap: 10px;
      position: relative;
      box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.2);
    }
    
    .tab-button::before {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: transparent;
      transition: all 0.3s ease;
    }
    
    .tab-button:hover {
      background: rgba(255, 165, 120, 0.15);
      color: var(--text-primary);
      transform: translateY(-2px);
      border-color: rgba(255, 165, 120, 0.3);
    }
    
    .tab-button.active {
      background: rgba(12, 22, 36, 0.95);
      color: var(--accent-1);
      font-weight: 600;
      border-color: var(--accent-1);
      box-shadow: 0 -4px 16px rgba(255, 165, 120, 0.3);
      transform: translateY(0);
    }
    
    .tab-button.active::before {
      background: linear-gradient(90deg, var(--accent-1), var(--accent-2));
    }
    
    .tab-button i {
      font-size: 18px;
      transition: transform 0.3s ease;
    }
    
    .tab-button.active i {
      transform: scale(1.1);
    }
    
    .tab-content {
      display: none;
      animation: fadeIn 0.3s ease;
    }
    
    .tab-content.active {
      display: block;
    }
    
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* ===== PREDICTIONS MODULE STYLES ===== */
    .predictions-container {
      padding: 8px;
      max-width: 1400px;
      margin: 0 auto;
    }

    .prediction-header {
      text-align: center;
      margin-bottom: 10px;
      padding: 8px;
      background: linear-gradient(135deg, rgba(120, 200, 255, 0.1), rgba(255, 165, 120, 0.1));
      border-radius: 8px;
      border: 1px solid rgba(120, 200, 255, 0.2);
    }

    .prediction-title {
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--accent-2);
      margin-bottom: 3px;
    }

    .prediction-subtitle {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .prediction-layout {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 12px;
    }

    @media (max-width: 1024px) {
      .prediction-layout {
        grid-template-columns: 1fr;
      }
    }

    /* Input Controls Panel */
    .prediction-inputs {
      background: var(--surface-2);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 10px;
      max-height: 420px;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .inputs-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      padding-bottom: 8px;
      border-bottom: 2px solid var(--accent-2);
      font-size: 0.95rem;
      font-weight: 600;
      color: var(--accent-2);
      flex-shrink: 0;
    }

    #predictionInputsContainer {
      overflow-y: auto;
      overflow-x: hidden;
      padding-right: 6px;
      flex: 1;
      min-height: 0;
    }

    #predictionInputsContainer::-webkit-scrollbar {
      width: 8px;
    }

    #predictionInputsContainer::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 4px;
    }

    #predictionInputsContainer::-webkit-scrollbar-thumb {
      background: var(--accent-2);
      border-radius: 4px;
    }

    #predictionInputsContainer::-webkit-scrollbar-thumb:hover {
      background: var(--accent-1);
    }

    .reset-btn {
      padding: 4px 10px;
      background: linear-gradient(145deg, #4a5568, #2d3748);
      border: 1px solid #4a5568;
      color: #e2e8f0;
      font-size: 10px;
      font-weight: 600;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .reset-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0,0,0,.3);
    }

    .input-group {
      margin-bottom: 10px;
      padding: 8px;
      background: rgba(255, 255, 255, 0.03);
      border-radius: 6px;
      border: 1px solid rgba(255, 255, 255, 0.05);
    }

    .input-label {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--text-secondary);
    }

    .input-value-display {
      font-size: 0.95rem;
      color: var(--accent-1);
      font-weight: 700;
    }

    .slider-container {
      position: relative;
      padding: 4px 0;
    }

    .input-slider {
      width: 100%;
      height: 8px;
      border-radius: 4px;
      background: linear-gradient(90deg, rgba(120, 200, 255, 0.2), rgba(255, 165, 120, 0.2));
      outline: none;
      -webkit-appearance: none;
      appearance: none;
    }

    .input-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: var(--accent-1);
      cursor: pointer;
      box-shadow: 0 0 10px rgba(255, 165, 120, 0.5), 0 2px 4px rgba(0, 0, 0, 0.3);
      transition: all 0.2s;
    }

    .input-slider::-webkit-slider-thumb:hover {
      transform: scale(1.2);
      box-shadow: 0 0 15px rgba(255, 165, 120, 0.8);
    }

    .input-slider::-moz-range-thumb {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: var(--accent-1);
      cursor: pointer;
      border: none;
      box-shadow: 0 0 10px rgba(255, 165, 120, 0.5), 0 2px 4px rgba(0, 0, 0, 0.3);
      transition: all 0.2s;
    }

    .input-slider::-moz-range-thumb:hover {
      transform: scale(1.2);
      box-shadow: 0 0 15px rgba(255, 165, 120, 0.8);
    }

    .slider-range {
      display: flex;
      justify-content: space-between;
      margin-top: 2px;
      font-size: 0.7rem;
      color: var(--text-muted);
    }

    .input-select {
      width: 100%;
      padding: 8px 12px;
      background: var(--surface-1);
      border: 1px solid var(--border);
      border-radius: 4px;
      color: var(--text-primary);
      font-size: 0.95rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .input-select:hover {
      border-color: var(--accent-2);
    }

    .input-select:focus {
      outline: none;
      border-color: var(--accent-1);
      box-shadow: 0 0 8px rgba(255, 165, 120, 0.3);
    }

    /* Output Panel */
    .prediction-output {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .output-card {
      background: var(--surface-2);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 12px;
      text-align: center;
    }

    .main-prediction {
      background: linear-gradient(135deg, rgba(120, 200, 255, 0.15), rgba(255, 165, 120, 0.15));
      border: 2px solid var(--accent-1);
      box-shadow: 0 4px 16px rgba(255, 165, 120, 0.2);
    }

    .output-label {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-bottom: 6px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .output-value {
      font-size: 2rem;
      font-weight: 700;
      color: var(--accent-1);
      text-shadow: 0 0 20px rgba(255, 165, 120, 0.5);
      margin-bottom: 4px;
    }

    .output-sublabel {
      font-size: 0.8rem;
      color: var(--text-secondary);
    }

    .intervals-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .interval-card {
      padding: 10px;
      position: relative;
      cursor: help;
    }

    .interval-label {
      font-size: 0.8rem;
      color: var(--accent-2);
      margin-bottom: 8px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 4px;
      justify-content: center;
    }

    .interval-range {
      font-size: 1rem;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 4px;
    }

    .interval-desc {
      font-size: 0.7rem;
      color: var(--text-muted);
      font-style: italic;
      line-height: 1.2;
    }

    .prediction-viz {
      background: var(--surface-2);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 8px;
    }
    
    .prediction-viz canvas {
      display: block;
      margin: 0 auto;
      max-width: 100%;
    }

    /* Tooltip styles */
    .tooltip-icon {
      display: inline-block;
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: var(--accent-2);
      color: var(--surface-0);
      font-size: 10px;
      line-height: 14px;
      text-align: center;
      font-weight: bold;
      cursor: help;
      position: relative;
    }

    .tooltip-text {
      visibility: hidden;
      width: 220px;
      background-color: rgba(0, 0, 0, 0.95);
      color: #fff;
      text-align: left;
      border-radius: 6px;
      padding: 10px;
      position: absolute;
      z-index: 1000;
      bottom: 125%;
      left: 50%;
      margin-left: -110px;
      opacity: 0;
      transition: opacity 0.3s;
      font-size: 11px;
      line-height: 1.4;
      box-shadow: 0 4px 12px rgba(0,0,0,0.5);
      pointer-events: none;
    }

    .tooltip-text::after {
      content: "";
      position: absolute;
      top: 100%;
      left: 50%;
      margin-left: -5px;
      border-width: 5px;
      border-style: solid;
      border-color: rgba(0, 0, 0, 0.95) transparent transparent transparent;
    }

    .tooltip-icon:hover .tooltip-text {
      visibility: visible;
      opacity: 1;
    }

    /* Scenarios Section */
    .scenarios-section {
      margin-top: 10px;
      background: var(--surface-2);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 10px;
    }

    .scenarios-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      padding-bottom: 8px;
      border-bottom: 2px solid var(--accent-2);
      font-size: 0.95rem;
      font-weight: 600;
      color: var(--accent-2);
    }

    .save-scenario-btn {
      padding: 6px 12px;
      background: linear-gradient(145deg, rgba(120, 200, 255, 0.3), rgba(120, 200, 255, 0.2));
      border: 1px solid var(--accent-2);
      color: var(--accent-2);
      font-size: 11px;
      font-weight: 600;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .save-scenario-btn:hover {
      background: var(--accent-2);
      color: var(--surface-0);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(120, 200, 255, 0.4);
    }

    .scenarios-table-container {
      max-height: 200px;
      overflow-y: auto;
    }

    .scenarios-table {
      width: 100%;
      border-collapse: collapse;
    }

    .scenarios-table th {
      background: rgba(120, 200, 255, 0.1);
      padding: 6px 8px;
      text-align: left;
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--accent-2);
      border-bottom: 2px solid var(--accent-2);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .scenarios-table td {
      padding: 6px 8px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      font-size: 0.85rem;
    }

    .scenarios-table tr:hover:not(.no-scenarios) {
      background: rgba(255, 165, 120, 0.05);
    }

    .scenario-actions {
      display: flex;
      gap: 8px;
    }

    .scenario-btn {
      padding: 4px 8px;
      font-size: 11px;
      border-radius: 4px;
      border: 1px solid;
      cursor: pointer;
      transition: all 0.2s;
    }

    .scenario-btn.load {
      background: rgba(120, 200, 255, 0.2);
      border-color: var(--accent-2);
      color: var(--accent-2);
      position: relative;
    }

    .scenario-btn.load:hover {
      background: var(--accent-2);
      color: var(--surface-0);
    }

    .scenario-btn.load:hover::after {
      content: 'Restore these slider values';
      position: absolute;
      bottom: calc(100% + 8px);
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.9);
      color: white;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 11px;
      white-space: nowrap;
      z-index: 1000;
      pointer-events: none;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
    }

    .scenario-btn.load:hover::before {
      content: '';
      position: absolute;
      bottom: calc(100% + 2px);
      left: 50%;
      transform: translateX(-50%);
      border: 6px solid transparent;
      border-top-color: rgba(0, 0, 0, 0.9);
      z-index: 1000;
      pointer-events: none;
    }

    .scenario-btn.delete {
      background: rgba(239, 68, 68, 0.2);
      border-color: #ef4444;
      color: #ef4444;
    }

    .scenario-btn.delete:hover {
      background: #ef4444;
      color: #ffffff;
    }

    /* ===== ANCOVA MODULE STYLES ===== */
    .ancova-container {
      padding: 20px;
      max-width: 1400px;
      margin: 0 auto;
    }

    .ancova-header {
      text-align: center;
      margin-bottom: 30px;
      padding: 20px;
      background: linear-gradient(135deg, rgba(120, 200, 255, 0.15), rgba(75, 0, 130, 0.15));
      border-radius: 12px;
      border: 2px solid rgba(120, 200, 255, 0.3);
    }

    .ancova-title {
      font-size: 1.8rem;
      font-weight: 700;
      color: var(--accent-2);
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
    }

    .ancova-subtitle {
      font-size: 1rem;
      color: var(--text-secondary);
      margin: 0;
    }

    .ancova-model-card {
      background: var(--surface-2);
      border: 2px solid var(--accent-2);
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 30px;
    }

    .ancova-model-card h3 {
      color: var(--accent-2);
      margin-top: 0;
      margin-bottom: 15px;
      font-size: 1.2rem;
    }

    .model-formula {
      font-family: 'Courier New', monospace;
      font-size: 1.3rem;
      text-align: center;
      padding: 15px;
      background: var(--surface-1);
      border-radius: 8px;
      color: var(--text-primary);
      font-weight: 600;
    }

    .ancova-section {
      background: var(--surface-1);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 25px;
    }

    .ancova-section h3 {
      color: var(--accent-2);
      margin-top: 0;
      margin-bottom: 12px;
      font-size: 1.3rem;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .assumption-text {
      color: var(--text-secondary);
      font-size: 0.95rem;
      margin-bottom: 15px;
      font-style: italic;
    }

    .ancova-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }

    .ancova-table thead th {
      background: var(--accent-2);
      color: white;
      padding: 12px;
      text-align: left;
      font-weight: 600;
      border: 1px solid var(--border);
    }

    .ancova-table tbody td {
      padding: 10px 12px;
      border: 1px solid var(--border);
      color: var(--text-primary);
    }

    .ancova-table tbody tr:nth-child(even) {
      background: var(--surface-2);
    }

    .ancova-table tbody tr:hover {
      background: rgba(120, 200, 255, 0.1);
    }

    .slopes-result {
      padding: 15px;
      border-radius: 8px;
      margin-top: 10px;
      font-weight: 600;
    }

    .slopes-pass {
      background: rgba(16, 185, 129, 0.2);
      border: 2px solid #10b981;
      color: var(--success);
    }

    .slopes-fail {
      background: rgba(239, 68, 68, 0.2);
      border: 2px solid #ef4444;
      color: var(--danger);
    }

    .adjusted-means-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }

    .mean-card {
      background: var(--surface-2);
      border: 2px solid var(--accent-2);
      border-radius: 8px;
      padding: 15px;
      text-align: center;
    }

    .mean-group-name {
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--accent-1);
      margin-bottom: 10px;
    }

    .mean-value {
      font-size: 1.8rem;
      font-weight: 700;
      color: var(--accent-2);
      margin-bottom: 5px;
    }

    .mean-ci {
      font-size: 0.85rem;
      color: var(--text-secondary);
    }

    /* ===== AI ASSESSMENT MODULE STYLES ===== */
    .ai-assessment-container {
      padding: 12px;
      max-width: 1200px;
      margin: 0 auto;
    }

    .ai-header {
      text-align: center;
      margin-bottom: 20px;
      padding: 16px;
      background: linear-gradient(135deg, rgba(138, 43, 226, 0.15), rgba(75, 0, 130, 0.15));
      border-radius: 10px;
      border: 2px solid rgba(138, 43, 226, 0.3);
    }

    .ai-title {
      font-size: 1.4rem;
      font-weight: 700;
      color: #9d4edd;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .ai-subtitle {
      font-size: 0.9rem;
      color: var(--text-muted);
    }

    .ai-status-card {
      display: flex;
      align-items: center;
      gap: 20px;
      padding: 24px;
      background: var(--surface-2);
      border: 2px solid rgba(138, 43, 226, 0.3);
      border-radius: 10px;
      margin-bottom: 20px;
    }

    .ai-status-icon {
      font-size: 48px;
      color: #9d4edd;
      animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.8; transform: scale(1.05); }
    }

    .ai-status-content {
      flex: 1;
    }

    .ai-status-title {
      font-size: 1.2rem;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 6px;
    }

    .ai-status-desc {
      font-size: 0.9rem;
      color: var(--text-muted);
    }

    .ai-generate-btn {
      padding: 12px 24px;
      background: linear-gradient(135deg, #9d4edd, #7b2cbf);
      border: none;
      color: white;
      font-size: 1rem;
      font-weight: 600;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 4px 15px rgba(138, 43, 226, 0.3);
    }

    .ai-generate-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(138, 43, 226, 0.5);
    }

    .ai-generate-btn:active {
      transform: translateY(0);
    }

    .ai-results {
      animation: fadeIn 0.5s ease;
    }

    .ai-section {
      margin-bottom: 20px;
    }

    .ai-section-header {
      font-size: 1.1rem;
      font-weight: 700;
      color: #9d4edd;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
      padding-bottom: 8px;
      border-bottom: 2px solid rgba(138, 43, 226, 0.3);
    }

    .ai-card {
      background: var(--surface-2);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 20px;
      min-height: 100px;
    }

    .ai-technical {
      background: rgba(0, 0, 0, 0.2);
      border: 1px solid rgba(138, 43, 226, 0.2);
      font-family: 'Courier New', monospace;
      font-size: 0.85rem;
      max-height: 400px;
      overflow-y: auto;
    }

    .ai-loading {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      color: var(--text-muted);
      font-size: 1rem;
      padding: 40px;
    }

    .ai-loading i {
      font-size: 24px;
    }

    .ai-insight {
      margin-bottom: 16px;
      padding: 12px;
      background: rgba(157, 78, 221, 0.1);
      border-left: 4px solid #9d4edd;
      border-radius: 4px;
    }

    .ai-insight-title {
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 6px;
    }

    .ai-insight-text {
      color: var(--text-secondary);
      line-height: 1.6;
    }

    .ai-badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 0.8rem;
      font-weight: 600;
      margin-right: 6px;
      margin-bottom: 6px;
    }

    .ai-badge.good {
      background: rgba(46, 204, 113, 0.2);
      color: #2ecc71;
      border: 1px solid #2ecc71;
    }

    .ai-badge.warning {
      background: rgba(241, 196, 15, 0.2);
      color: #f1c40f;
      border: 1px solid #f1c40f;
    }

    .ai-badge.error {
      background: rgba(231, 76, 60, 0.2);
      color: #e74c3c;
      border: 1px solid #e74c3c;
    }

    .ai-badge.info {
      background: rgba(52, 152, 219, 0.2);
      color: #3498db;
      border: 1px solid #3498db;
    }
    
    /* Tab Panels */
    .tab-panel {
      padding: 20px;
      min-height: 400px;
    }
  </style>
</head>
<body>
  <!-- Loading Overlay -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-spinner"></div>
    <div class="loading-text">Computing regression analysis...</div>
  </div>
  
  <div class="wrap">
    <section class="card" role="main">
      <!-- Hero Section - Completely Separate Design -->
      <div class="hero-section">
        <div class="hero-content">
          <!-- Hero Title -->
          <div class="hero-title">
            <i class="fa-solid fa-chart-line"></i>
            <span>Linear Regression Analysis</span>
          </div>

          <!-- Hero Controls -->
          <div class="hero-controls">
            <!-- Theme Toggle Button -->
            <button class="theme-toggle-btn" id="themeToggleBtn" onclick="toggleTheme()" title="Toggle Dark/Light Theme">
              <i class="fa-solid fa-moon" id="themeIcon"></i>
            </button>
            
            <!-- Decimal Precision Control -->
            <!-- Save Analysis Button -->
            <button class="save-analysis-btn save-model-btn" id="saveAnalysisBtn" onclick="saveCurrentRegressionAnalysis()" title="Save this model configuration to the workbook">
              <i class="fa-solid fa-floppy-disk"></i> Save Model
            </button>

            <!-- Export HTML Snapshot -->
            <button class="save-analysis-btn save-html-btn" id="saveHtmlBtn" onclick="exportResultsAsHtml()" title="Download a static HTML snapshot of the current results view">
              <i class="fa-solid fa-file-code"></i> Save HTML
            </button>
            
            <!-- AI Interpret Button -->
            <button class="dropdown-btn ai-interpret-btn" id="aiInterpretBtn" onclick="requestRegressionAI()" style="display: none;" title="Get AI-powered interpretation of regression results">
              <i class="fa-solid fa-robot"></i> AI Interpret
            </button>
          </div>
        </div>
        <!-- Tab Navigation (integrated into hero) -->
        <div class="tab-navigation">
          <button class="tab-button active" onclick="switchTab('results')" data-tab="results">
            <i class="fa-solid fa-table"></i> Results
          </button>
          <button class="tab-button" onclick="switchTab('predictions')" data-tab="predictions">
            <i class="fa-solid fa-wand-magic-sparkles"></i> Predictions
          </button>
          <button class="tab-button" onclick="switchTab('residuals')" data-tab="residuals">
            <i class="fa-solid fa-chart-line"></i> Residual Diagnostics
          </button>
          <button class="tab-button" id="ancovaTabButton" onclick="switchTab('ancova')" data-tab="ancova" style="display: none;">
            <i class="fa-solid fa-layer-group"></i> ANCOVA
          </button>
          <button class="tab-button" onclick="switchTab('correlations')" data-tab="correlations">
            <i class="fa-solid fa-project-diagram"></i> Correlations
          </button>
          <button class="tab-button" onclick="switchTab('descriptive')" data-tab="descriptive">
            <i class="fa-solid fa-chart-bar"></i> Descriptive Stats
          </button>
          <button class="tab-button" onclick="switchTab('ai-assessment')" data-tab="ai-assessment">
            <i class="fa-solid fa-brain"></i> AI Assessment
          </button>
          <div class="tab-controls-right">
            <label class="tab-decimal-label" for="decimalSelect">
              <i class="fa-solid fa-hashtag"></i> Decimals:
            </label>
            <select id="decimalSelect" class="tab-decimal-select" onchange="updateDecimalPrecision()">
              <option value="auto">Auto</option>
              <option value="0">0</option>
              <option value="1">1</option>
              <option value="2" selected>2</option>
              <option value="3">3</option>
              <option value="4">4</option>
              <option value="5">5</option>
            </select>
          </div>
        </div>
      </div>

      <!-- View Container: wraps both tabbed and single-page views -->
      <div class="view-container">
        <!-- Tabbed View -->
        <div class="tabbed-view-container">
      <div class="card-body">
        <!-- Tab: Results -->
        <div id="tab-results" class="tab-content active">
        <div class="kpi-strip" id="kpiStrip">
          <div class="kpi-card"><div class="kpi-label">R</div><div id="kpiRSquared" class="kpi-value">...</div></div>
          <div class="kpi-card"><div class="kpi-label">Adj R</div><div id="kpiAdjRSquared" class="kpi-value">...</div></div>
          <div class="kpi-card"><div class="kpi-label">RMSE</div><div id="kpiRMSE" class="kpi-value">...</div></div>
          <div class="kpi-card"><div class="kpi-label">F-test p</div><div id="kpiFPValue" class="kpi-value">...</div></div>
          <div class="kpi-card"><div class="kpi-label">n</div><div id="kpiN" class="kpi-value">...</div></div>
        </div>
        <!-- Stats Panels -->
        <div class="stats-container">
          <div class="stat-panel">
            <div class="stat-panel-heading"><i class="fa-solid fa-info-circle"></i> Sample Info</div>
            <div class="stat-panel-body">
              <div class="stat-field">
                <span class="stat-label">Observations:</span>
                <span id="validObs" class="stat-value">...</span>
              </div>
              <div class="stat-field">
                <span class="stat-label">Include Intercept?:</span>
                <span id="includeIntercept" class="stat-value">...</span>
              </div>
              <div class="stat-field">
                <span class="stat-label">Numeric Variables:</span>
                <span id="numNumericVars" class="stat-value">...</span>
              </div>
              <div class="stat-field">
                <span class="stat-label">Categorical Variables:</span>
                <span id="numCategoricalVars" class="stat-value">...</span>
              </div>
              <div class="stat-field">
                <span class="stat-label">Degrees of Freedom:</span>
                <span id="degreesOfFreedom" class="stat-value">...</span>
              </div>
            </div>
          </div>

          <div class="stat-panel">
            <div class="stat-panel-heading"><i class="fa-solid fa-chart-bar"></i> Model Fit</div>
            <div class="stat-panel-body">
              <div class="stat-field">
                <span class="stat-label">R:
                  <span class="metric-help"><i class="fa-regular fa-circle-question"></i><span class="metric-tip">Proportion of variance explained by the model. Rules of thumb: &lt; .30 weak, .30-.60 moderate, &gt; .60 strong.</span></span>
                </span>
                <span id="rSquared" class="stat-value">...</span>
              </div>
              <div class="stat-field">
                <span class="stat-label">Adjusted R:</span>
                <span id="adjRSquared" class="stat-value">...</span>
              </div>
              <div class="stat-field">
                <span class="stat-label">Root MSE:
                  <span class="metric-help"><i class="fa-regular fa-circle-question"></i><span class="metric-tip">Typical prediction error in the original outcome units. Lower values indicate better predictive precision.</span></span>
                </span>
                <span id="rootMSE" class="stat-value">...</span>
              </div>
              <div class="stat-field">
                <span class="stat-label">AIC:
                  <span class="metric-help"><i class="fa-regular fa-circle-question"></i><span class="metric-tip">Model selection metric balancing fit and complexity. Use for comparing models on the same dataset; lower is better.</span></span>
                </span>
                <span id="aic" class="stat-value">...</span>
              </div>
              <div class="stat-field">
                <span class="stat-label">BIC:</span>
                <span id="bic" class="stat-value">...</span>
              </div>
            </div>
          </div>

          <div class="stat-panel">
            <div class="stat-panel-heading"><i class="fa-solid fa-calculator"></i> F-Test</div>
            <div class="stat-panel-body">
              <div class="stat-field">
                <span class="stat-label">F-Statistic:</span>
                <span id="fStatistic" class="stat-value">...</span>
              </div>
              <div class="stat-field">
                <span class="stat-label">P-value:</span>
                <span id="fPValue" class="stat-value">...</span>
              </div>
              <div class="stat-field">
                <span class="stat-label">Sum of Squares (Model):</span>
                <span id="ssModel" class="stat-value">...</span>
              </div>
              <div class="stat-field">
                <span class="stat-label">Sum of Squares (Residual):</span>
                <span id="ssResidual" class="stat-value">...</span>
              </div>
            </div>
          </div>
        </div>

        <div class="insight-panel" id="interpretationPanel">
          <h3 class="insight-title"><i class="fa-solid fa-lightbulb"></i> Interpretation</h3>
          <p class="insight-text" id="interpretationText">Run a regression to generate a concise model interpretation.</p>
        </div>

        <!-- ANOVA Table Panel -->
        <div class="stat-panel" style="min-width: 100%; margin-top: 8px;">
          <div class="stat-panel-heading heading-with-actions">
            <span><i class="fa-solid fa-chart-pie"></i> ANOVA</span>
            <button class="collapse-toggle" id="toggleAnovaBtn" onclick="toggleSection('anovaPanelBody','toggleAnovaBtn')"><i class="fa-solid fa-chevron-up"></i> Collapse</button>
          </div>
          <div class="stat-panel-body collapsible-content" id="anovaPanelBody" style="padding: 0;">
            <div class="table-container" style="margin: 0; border: none; border-radius: 0;">
              <table class="regression-table">
                <thead>
                  <tr>
                    <th>Source</th>
                    <th>DF</th>
                    <th>Sum of Squares</th>
                    <th>Mean Square</th>
                    <th>F-Value</th>
                    <th>P-Value</th>
                  </tr>
                </thead>
                <tbody id="anovaTableBody">
                  <tr>
                    <td colspan="6" style="text-align:center; padding:20px; color:var(--text-muted); font-style:italic;">
                      <i class="fa-solid fa-hourglass-half"></i> Awaiting regression results...
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Coefficients Table Panel -->
        <div class="stat-panel" style="min-width: 100%; margin-top: 8px;">
          <div class="stat-panel-heading heading-with-actions">
            <span><i class="fa-solid fa-table"></i> Coefficients</span>
            <button class="collapse-toggle" id="toggleCoefficientsBtn" onclick="toggleSection('coefficientsBody','toggleCoefficientsBtn')"><i class="fa-solid fa-chevron-up"></i> Collapse</button>
          </div>
          <div class="stat-panel-body collapsible-content" id="coefficientsBody" style="padding: 0;">
            <div class="table-container" style="margin: 0; border: none; border-radius: 0;">
              <table class="regression-table">
                <thead>
                  <tr>
                    <th><i class="fa-solid fa-tag"></i> Variable</th>
                    <th>Coefficient</th>
                    <th>Std. Error</th>
                    <th>t-value</th>
                    <th>P-value</th>
                    <th>95% CI Lower</th>
                    <th>95% CI Upper</th>
                    <th>VIF <span class="metric-help"><i class="fa-regular fa-circle-question"></i><span class="metric-tip">Variance Inflation Factor. Values &gt; 5 suggest moderate multicollinearity; &gt; 10 suggests high multicollinearity.</span></span></th>
                  </tr>
                </thead>
                <tbody id="dataTableBody">
                  <tr>
                    <td colspan="8" style="text-align:center; padding:20px; color:var(--text-muted); font-style:italic;">
                      <i class="fa-solid fa-hourglass-half"></i> Awaiting regression results...
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
        
        <!-- Regression Equation Display -->
        <div class="stat-panel" style="min-width: 100%; margin-top: 8px;">
          <div class="stat-panel-heading"><i class="fa-solid fa-function"></i> Regression Equation</div>
          <div class="stat-panel-body">
            <div id="regressionEquation" style="font-family: 'Courier New', monospace; font-size: 0.8rem; color: var(--text-primary); background: rgba(0,0,0,0.3); padding: 10px; border-radius: 4px; overflow-x: auto; white-space: nowrap;">
              Awaiting regression results...
            </div>
          </div>
        </div>
        
        <!-- Toggle Equation Button -->
        <button class="toggle-equation-btn" id="toggleEquationBtn" onclick="toggleEquation()" style="display: none;">
          <i class="fa-solid fa-chevron-down"></i> Show Regression Equation
        </button>
        
        <!-- Regression Equation -->
        <div class="equation-section" id="equationSection" style="display: none;">
          <div class="equation-title">
            <i class="fa-solid fa-function"></i> Regression Equation
          </div>
          <div class="equation-formula" id="equationFormula">
            Awaiting regression results...
          </div>
        </div>
        </div>
        <!-- End Tab: Results -->

        <!-- Tab: Predictions -->
        <div id="tab-predictions" class="tab-content">
          <div class="predictions-container">
            
            <!-- Prediction Header -->
            <div class="prediction-header">
              <div class="prediction-title">
                <i class="fa-solid fa-wand-magic-sparkles"></i> Interactive Prediction Engine
              </div>
              <div class="prediction-subtitle">
                Adjust variable values below to explore "what-if" scenarios
              </div>
            </div>

            <!-- Main Prediction Layout -->
            <div class="prediction-layout">
              
              <!-- Left Panel: Input Controls -->
              <div class="prediction-inputs">
                <div class="inputs-header">
                  <i class="fa-solid fa-sliders"></i> Input Variables
                  <button class="reset-btn" onclick="resetToMeanValues()">
                    <i class="fa-solid fa-rotate-left"></i> Reset to Means
                  </button>
                </div>
                <div id="predictionInputsContainer">
                  <!-- Dynamic inputs will be generated here -->
                </div>
              </div>

              <!-- Right Panel: Prediction Output -->
              <div class="prediction-output">
                <div class="output-card main-prediction">
                  <div class="output-label">Predicted <span id="predictedVariableName" style="text-transform: uppercase; font-weight: 800; color: var(--accent-1);">Value</span></div>
                  <div class="output-value" id="predictedValue">-</div>
                  <div class="output-sublabel">Point Estimate</div>
                </div>

                <div class="intervals-container">
                  <div class="output-card interval-card">
                    <div class="interval-label">
                      <i class="fa-solid fa-chart-area"></i> 95% Confidence Interval
                      <span class="tooltip-icon">
                        ?
                        <span class="tooltip-text">
                          <strong>Confidence Interval:</strong> Range where the <em>average</em> predicted value for this combination of inputs is likely to fall. Narrower interval = more confident about the mean prediction.
                        </span>
                      </span>
                    </div>
                    <div class="interval-range" id="confidenceInterval">-</div>
                    <div class="interval-desc">Mean prediction uncertainty</div>
                  </div>

                  <div class="output-card interval-card">
                    <div class="interval-label">
                      <i class="fa-solid fa-chart-scatter"></i> 95% Prediction Interval
                      <span class="tooltip-icon">
                        ?
                        <span class="tooltip-text">
                          <strong>Prediction Interval:</strong> Range where a <em>single future observation</em> is likely to fall. Wider than confidence interval because it accounts for both uncertainty in the mean AND individual variation.
                        </span>
                      </span>
                    </div>
                    <div class="interval-range" id="predictionInterval">-</div>
                    <div class="interval-desc">Individual prediction range</div>
                  </div>
                </div>

                <!-- Prediction Visualization -->
                <div class="prediction-viz">
                  <canvas id="predictionChart" width="400" height="90"></canvas>
                </div>
              </div>
            </div>

            <!-- Scenarios Comparison Table -->
            <div class="scenarios-section">
              <div class="scenarios-header">
                <div>
                  <i class="fa-solid fa-table"></i> Saved Scenarios
                  <div style="font-size: 0.75rem; font-weight: 400; color: var(--text-muted); margin-top: 2px;">
                    Save and compare different input combinations
                  </div>
                </div>
                <button class="save-scenario-btn" onclick="saveCurrentScenario()">
                  <i class="fa-solid fa-bookmark"></i> Save Current
                </button>
              </div>
              <div class="scenarios-table-container">
                <table class="scenarios-table" id="scenariosTable">
                  <thead>
                    <tr>
                      <th>Scenario</th>
                      <th>Predicted Value</th>
                      <th>95% CI</th>
                      <th>95% PI</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody id="scenariosTableBody">
                    <tr class="no-scenarios">
                      <td colspan="5" style="text-align: center; color: var(--text-muted); padding: 20px;">
                        <i class="fa-solid fa-info-circle"></i> No scenarios saved yet. 
                        <br><span style="font-size: 0.85rem;">Adjust sliders above, then click "Save Current" to bookmark this combination.</span>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
              <div style="margin-top: 8px; padding: 8px; background: rgba(120, 200, 255, 0.05); border-left: 3px solid var(--accent-2); border-radius: 4px; font-size: 0.8rem; color: var(--text-muted);">
                <i class="fa-solid fa-info-circle"></i> <strong>Tip:</strong> Click <span style="color: var(--accent-2);"><i class="fa-solid fa-play"></i> Apply</span> to instantly restore slider values from any saved scenario.
              </div>
            </div>

          </div>
        </div>
        <!-- End Tab: Predictions -->

        <!-- Tab: Residual Diagnostics -->
        <div id="tab-residuals" class="tab-content">
          <div class="tab-panel" id="residualsPanel">
            <div style="text-align: center; padding: 60px 20px; color: var(--text-muted);">
              <i class="fa-solid fa-spinner fa-spin" style="font-size: 48px; margin-bottom: 15px;"></i>
              <p>Loading residual diagnostics...</p>
            </div>
          </div>
        </div>

        <!-- Tab: ANCOVA -->
        <div id="tab-ancova" class="tab-content">
          <div class="ancova-container">
            
            <!-- ANCOVA Header -->
            <div class="ancova-header">
              <h2 class="ancova-title">
                <i class="fa-solid fa-layer-group"></i>
                Analysis of Covariance (ANCOVA)
              </h2>
              <p class="ancova-subtitle">
                Comparing group means while controlling for covariates
              </p>
            </div>

            <!-- Model Structure Display -->
            <div class="ancova-model-card">
              <h3><i class="fa-solid fa-diagram-project"></i> Model Structure</h3>
              <div class="model-formula" id="ancovaModelFormula">
                <!-- Will be populated dynamically -->
              </div>
            </div>

            <!-- Homogeneity of Slopes Test -->
            <div class="ancova-section">
              <h3><i class="fa-solid fa-arrows-split-up-and-left"></i> Homogeneity of Slopes Test</h3>
              <p class="assumption-text">
                Tests if the covariate(s) have the same effect across all groups (slopes should be parallel)
              </p>
              <div id="homogeneitySlopesResult">
                <!-- Will be populated dynamically -->
              </div>
            </div>

            <!-- ANCOVA Table -->
            <div class="ancova-section">
              <h3><i class="fa-solid fa-table"></i> ANCOVA Table</h3>
              <div class="table-container">
                <table id="ancovaTable" class="ancova-table">
                  <thead>
                    <tr>
                      <th>Source</th>
                      <th>SS</th>
                      <th>df</th>
                      <th>MS</th>
                      <th>F</th>
                      <th>p-value</th>
                    </tr>
                  </thead>
                  <tbody id="ancovaTableBody">
                    <!-- Will be populated dynamically -->
                  </tbody>
                </table>
              </div>
            </div>

            <!-- Adjusted Group Means -->
            <div class="ancova-section">
              <h3><i class="fa-solid fa-chart-column"></i> Adjusted Group Means</h3>
              <p class="assumption-text">
                Group means adjusted for covariate values (estimated at covariate mean)
              </p>
              <div id="adjustedMeansContainer">
                <!-- Will be populated dynamically -->
              </div>
            </div>

            <!-- Visualization -->
            <div class="ancova-section">
              <h3><i class="fa-solid fa-chart-scatter"></i> Group Regression Lines</h3>
              <p class="assumption-text">
                Regression lines for each group - lines should be parallel if homogeneity of slopes holds
              </p>
              <div id="ancovaPlotContainer" style="height: 500px;">
                <!-- Highcharts will render here -->
              </div>
            </div>

          </div>
        </div>

        <!-- Tab: Correlations -->
        <div id="tab-correlations" class="tab-content">
          <div class="tab-panel" id="correlationsPanel">
            <div style="text-align: center; padding: 60px 20px; color: var(--text-muted);">
              <i class="fa-solid fa-spinner fa-spin" style="font-size: 48px; margin-bottom: 15px;"></i>
              <p>Loading correlations...</p>
            </div>
          </div>
        </div>

        <!-- Tab: Descriptive Stats -->
        <div id="tab-descriptive" class="tab-content">
          <div class="tab-panel" id="descriptivePanel">
            <div style="text-align: center; padding: 60px 20px; color: var(--text-muted);">
              <i class="fa-solid fa-spinner fa-spin" style="font-size: 48px; margin-bottom: 15px;"></i>
              <p>Loading descriptive statistics...</p>
            </div>
          </div>
        </div>

        <!-- Tab: AI Assessment -->
        <div id="tab-ai-assessment" class="tab-content">
          <div class="ai-assessment-container">
            
            <!-- AI Header -->
            <div class="ai-header">
              <div class="ai-title">
                <i class="fa-solid fa-brain"></i> AI-Powered Model Assessment
              </div>
              <div class="ai-subtitle">
                Comprehensive analysis and recommendations based on your regression results
              </div>
            </div>

            <!-- AI Status Card -->
            <div class="ai-status-card" id="aiStatusCard">
              <div class="ai-status-icon">
                <i class="fa-solid fa-robot"></i>
              </div>
              <div class="ai-status-content">
                <div class="ai-status-title">Ready to Analyze</div>
                <div class="ai-status-desc">Click "Generate AI Assessment" to get intelligent insights about your model</div>
              </div>
              <button class="ai-generate-btn" onclick="generateAIAssessment()" id="aiGenerateBtn">
                <i class="fa-solid fa-wand-magic-sparkles"></i> Generate AI Assessment
              </button>
            </div>

            <!-- AI Results Container -->
            <div class="ai-results" id="aiResults" style="display: none;">
              
              <!-- Overall Assessment -->
              <div class="ai-section">
                <div class="ai-section-header">
                  <i class="fa-solid fa-gauge-high"></i> Overall Model Quality
                </div>
                <div class="ai-card" id="overallAssessment">
                  <div class="ai-loading">
                    <i class="fa-solid fa-spinner fa-spin"></i> Analyzing...
                  </div>
                </div>
              </div>

              <!-- Key Findings -->
              <div class="ai-section">
                <div class="ai-section-header">
                  <i class="fa-solid fa-lightbulb"></i> Key Findings
                </div>
                <div class="ai-card" id="keyFindings">
                  <div class="ai-loading">
                    <i class="fa-solid fa-spinner fa-spin"></i> Analyzing...
                  </div>
                </div>
              </div>

              <!-- Variable Insights -->
              <div class="ai-section">
                <div class="ai-section-header">
                  <i class="fa-solid fa-chart-line"></i> Variable Insights
                </div>
                <div class="ai-card" id="variableInsights">
                  <div class="ai-loading">
                    <i class="fa-solid fa-spinner fa-spin"></i> Analyzing...
                  </div>
                </div>
              </div>

              <!-- Assumption Checks -->
              <div class="ai-section">
                <div class="ai-section-header">
                  <i class="fa-solid fa-check-circle"></i> Assumption Validation
                </div>
                <div class="ai-card" id="assumptionChecks">
                  <div class="ai-loading">
                    <i class="fa-solid fa-spinner fa-spin"></i> Analyzing...
                  </div>
                </div>
              </div>

              <!-- Recommendations -->
              <div class="ai-section">
                <div class="ai-section-header">
                  <i class="fa-solid fa-tasks"></i> Recommendations
                </div>
                <div class="ai-card" id="recommendations">
                  <div class="ai-loading">
                    <i class="fa-solid fa-spinner fa-spin"></i> Analyzing...
                  </div>
                </div>
              </div>

              <!-- Technical Summary -->
              <div class="ai-section">
                <div class="ai-section-header">
                  <i class="fa-solid fa-file-alt"></i> Technical Summary
                </div>
                <div class="ai-card ai-technical" id="technicalSummary">
                  <div class="ai-loading">
                    <i class="fa-solid fa-spinner fa-spin"></i> Preparing data payload...
                  </div>
                </div>
              </div>

            </div>

          </div>
        </div>
        <!-- End Tab: AI Assessment -->

      </div>
      <!-- End of card-body -->
        </div>
        <!-- End of tabbed-view-container -->

        <!-- Single Page View -->
        <div class="single-page-view" id="singlePageView">
          <!-- Will be populated dynamically -->
        </div>

      </div>
      <!-- End of view-container -->
    </section>
  </div>

    <!-- Custom awaiting panel instructions for regression -->
  <script>
    window.AWAITING_PANEL_INSTRUCTIONS = `
      <div style="text-align: left; color: #8b95a5; font-size: 14px; line-height: 1.8; max-width: 420px; padding: 0 20px;">
        <div style="margin-bottom: 8px;"> <strong style="color: #ffa500;">Select your data range</strong> in the input panel</div>
        <div style="margin-bottom: 8px;"> <strong style="color: #ffa500;">Assign Y variable</strong> (response) and predictors (Xn, Xc)</div>
        <div style="margin-bottom: 8px;"> <strong style="color: #ffa500;">Click "Run Regression"</strong> to see results</div>
        <div> Regression analysis includes coefficients, R, F-test, and more</div>
      </div>
    `;
  </script>

  <script>
    // Global prediction data storage (declared early to avoid temporal dead zone issues)
    let predictionData = {
      coefficients: [],
      variables: [],
      numericVars: [],
      categoricalVars: [],
      categoricalLevels: {},
      stats: {},
      savedScenarios: [],
      currentInputs: {}
    };
    
    // Utility function to send commands to VB6 host
    function sendToHost(cmd, data) {
      try {
        if (typeof vbHost !== 'undefined' && vbHost && typeof vbHost.RaiseMessageEvent === 'function') {
          var dataStr = typeof data === 'string' ? data : JSON.stringify(data || {});
          vbHost.RaiseMessageEvent(cmd, dataStr);
          console.log(' Sent to host:', cmd, dataStr.substring(0, 100));
        } else {
          console.warn(' vbHost not available');
        }
      } catch(e) {
        console.error(' Error sending to host:', e);
      }
    }
    
    // Tab Management
    function switchTab(tabName) {
      console.log(' Switching to tab:', tabName);
      
      // Update tab buttons
      document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.tab === tabName) {
          btn.classList.add('active');
        }
      });
      
      // Update tab content
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
      });
      document.getElementById(`tab-${tabName}`).classList.add('active');
      
      // Lazy load tab content if not already loaded
      if (tabName === 'residuals' && !window.residualsLoaded) {
        loadResidualsTab();
      } else if (tabName === 'correlations' && !window.correlationsLoaded) {
        loadCorrelationsTab();
      } else if (tabName === 'descriptive' && !window.descriptiveLoaded) {
        loadDescriptiveTab();
      } else if (tabName === 'predictions' && !window.predictionsLoaded) {
        initializePredictions();
        window.predictionsLoaded = true;
      } else if (tabName === 'ancova' && !window.ancovaLoaded) {
        initializeANCOVA();
        window.ancovaLoaded = true;
      }
    }

    // Global decimal precision setting
    let globalDecimalPrecision = 'auto'; // 'auto', '0', '1', '2', '3', '4', '5'
    
    // Smart number formatting based on global precision
    function formatNumber(val, forceDecimals = null) {
      const decimals = forceDecimals !== null ? forceDecimals : 
                       (globalDecimalPrecision === 'auto' ? null : parseInt(globalDecimalPrecision));
      
      if (globalDecimalPrecision === 'auto' || decimals === null) {
        // Auto mode: adaptive formatting
        if (Math.abs(val) < 0.01 && val !== 0) {
          return val.toExponential(3);
        } else if (Math.abs(val) < 1 && val !== 0) {
          return val.toFixed(4);
        } else {
          return val.toFixed(2);
        }
      } else {
        // User-specified precision
        return val.toFixed(decimals);
      }
    }
    
    // Function to update decimal precision and refresh display
    function updateDecimalPrecision() {
      const select = document.getElementById('decimalSelect');
      globalDecimalPrecision = select.value;
      console.log(' Decimal precision changed to:', globalDecimalPrecision);
      
      // Re-render results if they exist
      if (window.regressionResults && receivedModelSpec) {
        const { y, xn = [], xc = [] } = receivedModelSpec;
        displayRegressionResults(window.regressionResults, y, xn, xc);
      }
    }
    
    // ============================================================================
    // THEME TOGGLE FUNCTIONALITY
    // ============================================================================
    
    /**
     * Toggle between dark and light themes
     */
    function toggleTheme() {
      const root = document.documentElement;
      const themeIcon = document.getElementById('themeIcon');
      const currentTheme = root.getAttribute('data-theme');
      const newTheme = currentTheme === 'light' ? 'dark' : 'light';
      
      // Apply theme
      if (newTheme === 'light') {
        root.setAttribute('data-theme', 'light');
        themeIcon.className = 'fa-solid fa-sun';
        console.log(' Switched to Light Theme');
      } else {
        root.removeAttribute('data-theme');
        themeIcon.className = 'fa-solid fa-moon';
        console.log(' Switched to Dark Theme');
      }
      
      // Save preference
      try {
        localStorage.setItem('regressionTheme', newTheme);
      } catch (e) {
        console.warn('Could not save theme preference:', e);
      }
      
      // Broadcast theme change to all iframes
      broadcastThemeToIframes(newTheme);
    }
    
    /**
     * Broadcast theme change to all iframe children
     */
    function broadcastThemeToIframes(theme) {
      const iframes = document.querySelectorAll('iframe');
      console.log(` Broadcasting theme '${theme}' to ${iframes.length} iframe(s)`);
      
      iframes.forEach((iframe, index) => {
        try {
          if (iframe.contentWindow) {
            iframe.contentWindow.postMessage({
              type: 'THEME_CHANGE',
              theme: theme
            }, '*');
            console.log(`   Sent to iframe ${index + 1}`);
          }
        } catch (e) {
          console.warn(`Failed to send theme to iframe ${index + 1}:`, e);
        }
      });
    }
    
    /**
     * Load saved theme preference on page load
     */
    function loadSavedTheme() {
      try {
        const savedTheme = localStorage.getItem('regressionTheme');
        const themeIcon = document.getElementById('themeIcon');
        
        if (savedTheme === 'light') {
          document.documentElement.setAttribute('data-theme', 'light');
          if (themeIcon) themeIcon.className = 'fa-solid fa-sun';
          console.log(' Loaded Light Theme from preferences');
        } else {
          console.log(' Using default Dark Theme');
        }
      } catch (e) {
        console.warn('Could not load theme preference:', e);
      }
    }
    
    // Load theme on page load
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', loadSavedTheme);
    } else {
      loadSavedTheme();
    }
    
    // ============================================================================
    // VIEW MODE TOGGLE FUNCTIONALITY
    // ============================================================================
    
    // Function to switch between tabbed and single-page views
    function switchViewMode() {
      const select = document.getElementById('viewModeSelect');
      if (!select) return;
      const viewMode = select.value;
      const tabbedView = document.querySelector('.tabbed-view-container');
      const singlePageView = document.getElementById('singlePageView');
      
      console.log(' Switching to view mode:', viewMode);
      
      if (viewMode === 'single') {
        // Hide tabbed view, show single-page view
        tabbedView.classList.add('hidden');
        singlePageView.classList.add('active');
        
        // Populate single-page view if results exist
        if (window.regressionResults && receivedModelSpec) {
          populateSinglePageView();
        }
      } else {
        // Show tabbed view, hide single-page view
        tabbedView.classList.remove('hidden');
        singlePageView.classList.remove('active');
      }
    }
    
    // Function to populate the single-page view with regression results
    function populateSinglePageView() {
      const container = document.getElementById('singlePageView');
      const results = window.regressionResults;
      const { y, xn = [], xc = [] } = receivedModelSpec;
      
      // Build the single-page layout HTML
      let html = `
        <!-- Model Summary Section -->
        <div class="sp-section">
          <div class="sp-section-header">
            <i class="fa-solid fa-chart-line"></i> Model Summary
          </div>
          <div class="sp-section-body">
            <div class="sp-stats-grid">
              <div class="sp-stat-box">
                <div class="sp-stat-label">R-Squared (R)</div>
                <div class="sp-stat-value">${results.rSquared ? results.rSquared.toFixed(4) : 'N/A'}</div>
              </div>
              <div class="sp-stat-box">
                <div class="sp-stat-label">Adjusted R</div>
                <div class="sp-stat-value">${results.rSquaredAdj ? results.rSquaredAdj.toFixed(4) : 'N/A'}</div>
              </div>
              <div class="sp-stat-box">
                <div class="sp-stat-label">F-Statistic</div>
                <div class="sp-stat-value">${results.fStatistic ? formatNumber(results.fStatistic) : 'N/A'}</div>
              </div>
              <div class="sp-stat-box">
                <div class="sp-stat-label">P-Value (F-test)</div>
                <div class="sp-stat-value">${results.fPValue ? (results.fPValue < 0.0001 ? '< 0.0001' : results.fPValue.toFixed(4)) : 'N/A'}</div>
              </div>
              <div class="sp-stat-box">
                <div class="sp-stat-label">RMSE</div>
                <div class="sp-stat-value">${results.rmse ? formatNumber(results.rmse) : 'N/A'}</div>
              </div>
              <div class="sp-stat-box">
                <div class="sp-stat-label">Observations</div>
                <div class="sp-stat-value">${results.n || 'N/A'}</div>
              </div>
              <div class="sp-stat-box">
                <div class="sp-stat-label">Degrees of Freedom</div>
                <div class="sp-stat-value">${results.df || 'N/A'}</div>
              </div>
              <div class="sp-stat-box">
                <div class="sp-stat-label">AIC</div>
                <div class="sp-stat-value">${results.aic ? formatNumber(results.aic) : 'N/A'}</div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Regression Coefficients Section -->
        <div class="sp-section">
          <div class="sp-section-header">
            <i class="fa-solid fa-table"></i> Regression Coefficients
          </div>
          <div class="sp-section-body">
            <div class="sp-table-container">
              <table class="sp-table">
                <thead>
                  <tr>
                    <th>Variable</th>
                    <th>Coefficient</th>
                    <th>Std. Error</th>
                    <th>t-Value</th>
                    <th>P-Value</th>
                    <th>95% CI Lower</th>
                    <th>95% CI Upper</th>
                  </tr>
                </thead>
                <tbody id="sp-coefficients-tbody">
                  <!-- Will be populated below -->
                </tbody>
              </table>
            </div>
            
            <!-- Regression Equation -->
            <div class="sp-equation" id="sp-equation">
              <!-- Will be populated below -->
            </div>
          </div>
        </div>
        
        <!-- ANOVA Table Section -->
        <div class="sp-section">
          <div class="sp-section-header">
            <i class="fa-solid fa-calculator"></i> Analysis of Variance (ANOVA)
          </div>
          <div class="sp-section-body">
            <div class="sp-table-container">
              <table class="sp-table">
                <thead>
                  <tr>
                    <th>Source</th>
                    <th>Sum of Squares</th>
                    <th>DF</th>
                    <th>Mean Square</th>
                    <th>F-Statistic</th>
                    <th>P-Value</th>
                  </tr>
                </thead>
                <tbody id="sp-anova-tbody">
                  <!-- Will be populated below -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
      `;
      
      container.innerHTML = html;
      
      // Populate coefficients table
      const coeffTbody = document.getElementById('sp-coefficients-tbody');
      if (results.coefficients && results.coefficients.length > 0) {
        results.coefficients.forEach((coef, idx) => {
          const row = document.createElement('tr');
          const varClass = coef.variable === 'Intercept' ? 'intercept-var' : 
                          (xn.includes(coef.variable.split('_')[0]) ? 'numeric-var' : 'categorical-var');
          
          row.innerHTML = `
            <td class="${varClass}" style="font-weight: 600;">${coef.variable}</td>
            <td>${formatCoefficient(coef.coefficient)}</td>
            <td>${formatNumber(coef.se)}</td>
            <td>${formatNumber(coef.tValue)}</td>
            <td>${coef.pValue < 0.0001 ? '< 0.0001' : coef.pValue.toFixed(4)}</td>
            <td>${formatNumber(coef.ciLower)}</td>
            <td>${formatNumber(coef.ciUpper)}</td>
          `;
          coeffTbody.appendChild(row);
        });
      }
      
      // Populate ANOVA table
      const anovaTbody = document.getElementById('sp-anova-tbody');
      if (results.anova) {
        const anovaRows = [
          {
            source: 'Regression',
            ss: results.anova.SSM,
            df: results.anova.dfM,
            ms: results.anova.MSM,
            f: results.fStatistic,
            p: results.fPValue
          },
          {
            source: 'Residual',
            ss: results.anova.SSR,
            df: results.anova.dfR,
            ms: results.anova.MSR,
            f: '',
            p: ''
          },
          {
            source: 'Total',
            ss: results.anova.SST,
            df: results.anova.dfT,
            ms: '',
            f: '',
            p: ''
          }
        ];
        
        anovaRows.forEach(row => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td style="font-weight: 600;">${row.source}</td>
            <td>${row.ss !== '' ? formatNumber(row.ss) : ''}</td>
            <td>${row.df !== '' ? row.df : ''}</td>
            <td>${row.ms !== '' ? formatNumber(row.ms) : ''}</td>
            <td>${row.f !== '' ? formatNumber(row.f) : ''}</td>
            <td>${row.p !== '' ? (row.p < 0.0001 ? '< 0.0001' : row.p.toFixed(4)) : ''}</td>
          `;
          anovaTbody.appendChild(tr);
        });
      }
      
      // Populate regression equation
      const equationDiv = document.getElementById('sp-equation');
      if (results.coefficients && results.coefficients.length > 0) {
        let equationText = `<span style="font-size: 16px; font-weight: 800; color: var(--accent-1); text-transform: uppercase; letter-spacing: 1px;">${y}</span> = `;
        results.coefficients.forEach((coef, idx) => {
          if (idx > 0 && coef.coefficient >= 0) {
            equationText += ' + ';
          } else if (idx > 0) {
            equationText += ' ';
          }
          
          if (coef.variable === 'Intercept') {
            equationText += formatCoefficient(coef.coefficient);
          } else {
            const coefStr = formatCoefficient(Math.abs(coef.coefficient));
            const sign = coef.coefficient < 0 ? '' : (idx === 0 ? '' : '');
            equationText += `${sign}${coefStr}  ${coef.variable}`;
          }
        });
        equationDiv.innerHTML = equationText;
      }
      
      console.log(' Single-page view populated');
    }
    
    // ============================================================================
    // CUSTOM MODAL DIALOGS (Office.js compatible)
    // ============================================================================
    
    /**
     * Show custom prompt dialog (replaces window.prompt)
     */
    function customPrompt(message, defaultValue = '') {
      return new Promise((resolve) => {
        const overlay = document.createElement('div');
        overlay.className = 'custom-modal-overlay';
        
        overlay.innerHTML = `
          <div class="custom-modal">
            <div class="custom-modal-header">
              <i class="fa-solid fa-pen-to-square"></i>
              <span>Save Model</span>
            </div>
            <div class="custom-modal-body">
              ${message}
              <input type="text" class="custom-modal-input" id="modalInput" value="${defaultValue}" />
            </div>
            <div class="custom-modal-actions">
              <button class="custom-modal-btn custom-modal-btn-secondary" id="modalCancel">Cancel</button>
              <button class="custom-modal-btn custom-modal-btn-primary" id="modalOk">Save</button>
            </div>
          </div>
        `;
        
        document.body.appendChild(overlay);
        
        const input = overlay.querySelector('#modalInput');
        const okBtn = overlay.querySelector('#modalOk');
        const cancelBtn = overlay.querySelector('#modalCancel');
        
        input.focus();
        input.select();
        
        const cleanup = (value) => {
          overlay.remove();
          resolve(value);
        };
        
        okBtn.onclick = () => cleanup(input.value.trim());
        cancelBtn.onclick = () => cleanup(null);
        
        input.onkeydown = (e) => {
          if (e.key === 'Enter') cleanup(input.value.trim());
          if (e.key === 'Escape') cleanup(null);
        };
      });
    }
    
    /**
     * Show custom alert dialog (replaces window.alert)
     */
    function customAlert(message, type = 'info') {
      return new Promise((resolve) => {
        const overlay = document.createElement('div');
        overlay.className = 'custom-modal-overlay';
        
        const icons = {
          success: '<i class="fa-solid fa-circle-check" style="color: #10b981;"></i>',
          error: '<i class="fa-solid fa-circle-xmark" style="color: #ef4444;"></i>',
          info: '<i class="fa-solid fa-circle-info" style="color: #3b82f6;"></i>',
          warning: '<i class="fa-solid fa-triangle-exclamation" style="color: #f59e0b;"></i>'
        };
        
        overlay.innerHTML = `
          <div class="custom-modal">
            <div class="custom-modal-header">
              ${icons[type] || icons.info}
              <span>${type === 'success' ? 'Success' : type === 'error' ? 'Error' : 'Information'}</span>
            </div>
            <div class="custom-modal-body" style="white-space: pre-line;">
              ${message}
            </div>
            <div class="custom-modal-actions">
              <button class="custom-modal-btn custom-modal-btn-primary" id="modalOk">OK</button>
            </div>
          </div>
        `;
        
        document.body.appendChild(overlay);
        
        const okBtn = overlay.querySelector('#modalOk');
        
        const cleanup = () => {
          overlay.remove();
          resolve();
        };
        
        okBtn.onclick = cleanup;
        okBtn.focus();
        
        overlay.onkeydown = (e) => {
          if (e.key === 'Enter' || e.key === 'Escape') cleanup();
        };
      });
    }
    
    /**
     * Show custom confirm dialog
     */
    function customConfirm(message) {
      return new Promise((resolve) => {
        const overlay = document.createElement('div');
        overlay.className = 'custom-modal-overlay';
        
        overlay.innerHTML = `
          <div class="custom-modal">
            <div class="custom-modal-header">
              <i class="fa-solid fa-circle-question" style="color: #f59e0b;"></i>
              <span>Confirm</span>
            </div>
            <div class="custom-modal-body" style="white-space: pre-line;">
              ${message}
            </div>
            <div class="custom-modal-actions">
              <button class="custom-modal-btn custom-modal-btn-secondary" id="modalCancel">Cancel</button>
              <button class="custom-modal-btn custom-modal-btn-primary" id="modalOk">OK</button>
            </div>
          </div>
        `;
        
        document.body.appendChild(overlay);
        
        const okBtn = overlay.querySelector('#modalOk');
        const cancelBtn = overlay.querySelector('#modalCancel');
        
        const cleanup = (value) => {
          overlay.remove();
          resolve(value);
        };
        
        okBtn.onclick = () => cleanup(true);
        cancelBtn.onclick = () => cleanup(false);
        okBtn.focus();
        
        overlay.onkeydown = (e) => {
          if (e.key === 'Enter') cleanup(true);
          if (e.key === 'Escape') cleanup(false);
        };
      });
    }
    
    // ============================================================================
    // SAVED ANALYSES - Module-specific implementation
    // ============================================================================
    
    /**
     * Get current regression configuration for saving
     */
    function getCurrentModuleConfig() {
      if (!receivedModelSpec || !window.regressionResults) {
        console.error(' No model or results available to save');
        return null;
      }
      
      return {
        y: receivedModelSpec.y,
        xn: receivedModelSpec.xn || [],
        xc: receivedModelSpec.xc || [],
        intercept: receivedModelSpec.intercept !== undefined ? receivedModelSpec.intercept : true,
        dataRange: receivedRegressionData ? receivedRegressionData.range : 'Unknown'
      };
    }
    
    /**
     * Get results summary for display
     */
    function getResultsSummary() {
      if (!window.regressionResults) return null;
      
      const results = window.regressionResults;
      return {
        rSquared: results.rSquared || 0,
        rSquaredAdj: results.rSquaredAdj || 0,
        fStatistic: results.fStatistic || 0,
        fPValue: results.fPValue || 1,
        observations: results.n || 0,
        rmse: results.rmse || 0
      };
    }
    
    /**
     * Save current regression analysis to workbook
     */
    async function saveCurrentRegressionAnalysis() {
      try {
        const config = getCurrentModuleConfig();
        if (!config) {
          await customAlert('No regression model available to save. Please run a regression first.', 'error');
          return;
        }
        
        // Prompt for model name
        const defaultName = SavedAnalysesManager.generateDefaultName('regression', config);
        const modelName = await customPrompt('Enter a name for this regression model:', defaultName);
        
        if (!modelName || modelName.trim() === '') {
          console.log(' Save cancelled - no name provided');
          return;
        }
        
        // Create analysis data structure
        const analysisData = {
          id: `analysis_${Date.now()}`,
          name: modelName.trim(),
          module: 'regression',
          starred: false,
          timestamp: new Date().toISOString(),
          workbookName: 'Current Workbook', // Will be updated by Excel
          dataRange: config.dataRange,
          config: config,
          lastResults: getResultsSummary()
        };
        
        // Save to workbook
        console.log(' Saving analysis:', analysisData);
        await SavedAnalysesManager.saveAnalysis(analysisData);
        
        // Show success message
        await customAlert(` Model "${modelName}" saved successfully!\n\nYou can load it from the taskpane's "Saved Analyses" panel.`, 'success');
        
      } catch (error) {
        console.error(' Error saving analysis:', error);
        await customAlert(`Failed to save model: ${error.message}`, 'error');
      }
    }

    /**
     * Export current dialog state as a static HTML snapshot.
     * Captures current values, active tab, and rendered visuals.
     */
    async function exportResultsAsHtml() {
      try {
        // Ensure lazy tabs are populated before snapshot.
        if (!window.residualsLoaded) {
          try { loadResidualsTab(); window.residualsLoaded = true; } catch (e) {}
        }
        if (!window.correlationsLoaded) {
          try { loadCorrelationsTab(); window.correlationsLoaded = true; } catch (e) {}
        }
        if (!window.descriptiveLoaded) {
          try { loadDescriptiveTab(); window.descriptiveLoaded = true; } catch (e) {}
        }
        if (!window.predictionsLoaded) {
          try { initializePredictions(); window.predictionsLoaded = true; } catch (e) {}
        }
        if (!window.ancovaLoaded && typeof initializeANCOVA === 'function') {
          try { initializeANCOVA(); window.ancovaLoaded = true; } catch (e) {}
        }

        // Let dynamic tab content render before cloning.
        await new Promise(resolve => setTimeout(resolve, 250));

        const clone = document.documentElement.cloneNode(true);

        // Preserve form control state (select/input/textarea).
        const sourceControls = document.querySelectorAll('input, textarea, select');
        const cloneControls = clone.querySelectorAll('input, textarea, select');
        sourceControls.forEach((sourceEl, idx) => {
          const cloneEl = cloneControls[idx];
          if (!cloneEl) return;
          if (sourceEl.tagName === 'SELECT') {
            cloneEl.value = sourceEl.value;
            Array.from(cloneEl.options || []).forEach(opt => {
              opt.selected = opt.value === sourceEl.value;
            });
          } else if (sourceEl.type === 'checkbox' || sourceEl.type === 'radio') {
            cloneEl.checked = sourceEl.checked;
            if (sourceEl.checked) cloneEl.setAttribute('checked', 'checked');
            else cloneEl.removeAttribute('checked');
          } else {
            cloneEl.value = sourceEl.value;
            cloneEl.setAttribute('value', sourceEl.value);
          }
        });

        // Replace canvas elements with static images so charts persist in exported file.
        const sourceCanvases = document.querySelectorAll('canvas');
        const cloneCanvases = clone.querySelectorAll('canvas');
        sourceCanvases.forEach((canvas, idx) => {
          const cloneCanvas = cloneCanvases[idx];
          if (!cloneCanvas) return;
          try {
            const dataUrl = canvas.toDataURL('image/png');
            const img = clone.ownerDocument.createElement('img');
            img.src = dataUrl;
            img.style.width = `${canvas.width || canvas.clientWidth || 400}px`;
            img.style.maxWidth = '100%';
            img.style.height = 'auto';
            img.alt = 'Chart snapshot';
            cloneCanvas.replaceWith(img);
          } catch (e) {
            // If toDataURL fails, keep original canvas markup.
          }
        });

        // Inline iframe content when same-origin so exported file contains tab details.
        const sourceIframes = document.querySelectorAll('iframe');
        const cloneIframes = clone.querySelectorAll('iframe');
        sourceIframes.forEach((frame, idx) => {
          const cloneFrame = cloneIframes[idx];
          if (!cloneFrame) return;
          try {
            const doc = frame.contentDocument;
            if (doc && doc.documentElement) {
              cloneFrame.setAttribute('srcdoc', '<!DOCTYPE html>\n' + doc.documentElement.outerHTML);
              cloneFrame.removeAttribute('src');
            }
          } catch (e) {
            // Cross-origin or inaccessible iframe; keep original src.
          }
        });

        // Export all tab sections as a single complete report.
        const tabbedView = clone.querySelector('.tabbed-view-container');
        if (tabbedView) tabbedView.classList.remove('hidden');
        const singlePageView = clone.querySelector('#singlePageView');
        if (singlePageView) {
          singlePageView.classList.remove('active');
          singlePageView.style.display = 'none';
        }
        clone.querySelectorAll('.tab-content').forEach(section => {
          section.classList.add('active');
          section.style.display = 'block';
        });
        const tabNav = clone.querySelector('.tab-navigation');
        if (tabNav) tabNav.style.display = 'none';

        // Static export: remove scripts to avoid re-running app logic on open.
        clone.querySelectorAll('script').forEach(script => script.remove());

        // Hide any loading overlay remnants in export.
        const loadingOverlay = clone.querySelector('#loadingOverlay');
        if (loadingOverlay) loadingOverlay.remove();

        const now = new Date();
        const stamp = now.toISOString().replace(/[:.]/g, '-');
        const fileName = `regression-results-snapshot-${stamp}.html`;
        const html = '<!DOCTYPE html>\n' + clone.outerHTML;
        const blob = new Blob([html], { type: 'text/html;charset=utf-8' });

        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = fileName;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);

        await customAlert(`HTML snapshot saved as:\n${fileName}`, 'success');
      } catch (error) {
        console.error(' Failed to export HTML snapshot:', error);
        await customAlert(`Failed to export HTML snapshot: ${error.message}`, 'error');
      }
    }
    
    /**
     * Load a saved regression configuration
     * Called from taskpane when user clicks "Load"
     */
    window.loadRegressionConfig = async function(analysisId) {
      try {
        const analysis = await SavedAnalysesManager.loadAnalysisById(analysisId);
        if (!analysis || analysis.module !== 'regression') {
          throw new Error('Invalid or incompatible analysis');
        }
        
        console.log(' Loading regression config:', analysis.name);
        
        // Store the config
        receivedModelSpec = analysis.config;
        
        // TODO: We need to communicate with taskpane to reload data and run
        // For now, just log the config
        console.log('Config loaded:', analysis.config);
        
        await customAlert(`Model "${analysis.name}" loaded.\n\nY: ${analysis.config.y}\nX (numeric): ${analysis.config.xn.join(', ') || 'None'}\nX (categorical): ${analysis.config.xc.join(', ') || 'None'}`, 'success');
        
      } catch (error) {
        console.error(' Error loading analysis:', error);
        await customAlert(`Failed to load model: ${error.message}`, 'error');
      }
    };
    
    // ============================================================================
    // END SAVED ANALYSES
    // ============================================================================
    
    // Office.js integration for Excel Add-in
    let receivedRegressionData = null;
    let receivedModelSpec = null;
    
    // Initialize Office.js
    if (typeof Office !== 'undefined') {
      Office.onReady((info) => {
        console.log(' Office.js ready in regression coefficients dialog');
        
        // Hide loading overlay initially
        const loadingOverlay = document.getElementById('loadingOverlay');
        if (loadingOverlay) {
          loadingOverlay.classList.add('hidden');
        }
        
        // Signal that dialog is ready to receive data
        if (Office.context && Office.context.ui) {
          Office.context.ui.messageParent(JSON.stringify({ 
            action: 'ready' 
          }));
        }
        
        // Listen for messages from parent taskpane
        Office.context.ui.addHandlerAsync(
          Office.EventType.DialogParentMessageReceived,
          (arg) => {
            try {
              const message = JSON.parse(arg.message);
              console.log(' Received message from taskpane:', message.type);
              
              if (message.type === 'REGRESSION_RESULTS') {
                receivedRegressionData = message.payload;
                receivedModelSpec = message.payload.modelSpec;
                
                console.log(' Received regression data and model spec');
                console.log('   Headers:', message.payload.headers);
                console.log('   Rows:', message.payload.rows?.length);
                console.log('   Model:', receivedModelSpec);
                
                // Process and display the regression results
                processRegressionData();
              }
            } catch (e) {
              console.error(' Error handling message from parent:', e);
            }
          }
        );
      });
    }
    
    // Helper function to get unique categories from a column
    function getUniqueCategories(rows, colIndex) {
      const categories = new Set();
      for (const row of rows) {
        const val = row[colIndex];
        if (val !== null && val !== undefined && val !== '') {
          categories.add(String(val));
        }
      }
      return Array.from(categories).sort();
    }
    
    // Helper function to create dummy variables for a categorical column
    function createDummyVariables(value, categories, varName) {
      // Create k-1 dummy variables (first category is reference)
      const dummies = [];
      const strValue = String(value);
      
      for (let i = 1; i < categories.length; i++) {
        dummies.push(strValue === categories[i] ? 1 : 0);
      }
      
      return dummies;
    }
    
    // Process the received regression data and run analysis
    function processRegressionData() {
      if (!receivedRegressionData || !receivedModelSpec) {
        console.warn(' No data or model spec received yet');
        return;
      }
      
      // Show loading overlay
      const loadingOverlay = document.getElementById('loadingOverlay');
      if (loadingOverlay) {
        loadingOverlay.classList.remove('hidden');
      }
      
      // Use setTimeout to allow UI to render the loading overlay before heavy computation
      setTimeout(() => {
        try {
          processRegressionDataInternal();
        } catch (error) {
          console.error(' Error processing regression data:', error);
          if (loadingOverlay) {
            loadingOverlay.classList.add('hidden');
          }
        }
      }, 50);
    }
    
    // Internal function that does the actual computation
    function processRegressionDataInternal() {
      console.log(' Processing regression data...');
      
      const { headers, rows, address } = receivedRegressionData;
      const { y, xn = [], xc = [], intercept } = receivedModelSpec;
      
      console.log(' Model specification:', {
        y,
        xn,
        xc,
        intercept
      });
      console.log(' Available headers:', headers);
      
      // Build X matrix and Y vector from the data
      const yIndex = headers.indexOf(y);
      const xnIndices = xn.map(varName => headers.indexOf(varName));
      const xcIndices = xc.map(varName => headers.indexOf(varName));
      
      console.log(' Index lookup results:', {
        yIndex,
        xnIndices,
        xcIndices
      });
      
      if (yIndex === -1) {
        console.error(' Y variable not found in headers');
        console.error('   Looking for:', y);
        console.error('   Available:', headers);
        return;
      }
      
      // Step 1: Identify unique categories for each categorical variable
      const categoricalInfo = [];
      for (let i = 0; i < xc.length; i++) {
        const xcIdx = xcIndices[i];
        const varName = xc[i];
        const categories = getUniqueCategories(rows, xcIdx);
        
        console.log(` Categorical variable "${varName}":`, categories);
        
        if (categories.length < 2) {
          console.warn(` Categorical variable "${varName}" has less than 2 categories. Skipping.`);
          continue;
        }
        
        categoricalInfo.push({
          name: varName,
          index: xcIdx,
          categories: categories,
          // Create dummy variable names (k-1 dummies, first category is reference)
          dummyNames: categories.slice(1).map(cat => `${varName}_${cat}`)
        });
      }
      
      console.log(' Categorical dummy coding:', categoricalInfo);
      
      // Build variable names list (for display)
      const variableNames = [...xn]; // Start with numeric variables
      for (const catInfo of categoricalInfo) {
        variableNames.push(...catInfo.dummyNames);
      }
      
      console.log(' Final variable names:', variableNames);
      
      // Step 2: Build X matrix and Y vector together with synchronized filtering
      const xMatrix = [];
      const yVector = [];
      
      for (let i = 0; i < rows.length; i++) {
        const row = rows[i];
        
        // Get Y value
        const yVal = parseFloat(row[yIndex]);
        if (isNaN(yVal)) continue; // Skip if Y is invalid
        
        // Build X row
        const xRow = [];
        let validRow = true;
        
        // Add numeric predictors
        for (const xnIdx of xnIndices) {
          const val = parseFloat(row[xnIdx]);
          if (isNaN(val)) {
            validRow = false;
            break;
          }
          xRow.push(val);
        }
        
        if (!validRow) continue;
        
        // Add categorical predictors as dummy variables
        for (const catInfo of categoricalInfo) {
          const catValue = row[catInfo.index];
          if (catValue === null || catValue === undefined || catValue === '') {
            validRow = false;
            break;
          }
          
          // Create dummy variables for this categorical
          const dummies = createDummyVariables(catValue, catInfo.categories, catInfo.name);
          xRow.push(...dummies);
        }
        
        // Only add if all values are valid
        if (validRow) {
          xMatrix.push(xRow);
          yVector.push(yVal);
        }
      }
      
      // Store variable names globally for display
      window.regressionVariableNames = variableNames;
      
      console.log(' Data prepared:', {
        observations: yVector.length,
        predictors: xMatrix[0]?.length || 0,
        intercept: intercept === 1,
        xMatrixRows: xMatrix.length,
        yVectorLength: yVector.length
      });
      
      // Validate data before proceeding
      if (xMatrix.length === 0 || yVector.length === 0) {
        console.error(' No valid data after filtering');
        const tbody = document.getElementById('dataTableBody');
        if (tbody) {
          tbody.innerHTML = `<tr><td colspan="8" style="color: #ff6b6b; text-align: center; padding: 20px;">
            <i class="fa-solid fa-exclamation-triangle"></i> No valid observations after removing missing values
          </td></tr>`;
        }
        return;
      }
      
      if (xMatrix.length !== yVector.length) {
        console.error(' Length mismatch between X and Y');
        console.error('   X rows:', xMatrix.length, 'Y rows:', yVector.length);
        return;
      }
      
      // Update page title
      const pageTitle = document.getElementById('page-title');
      if (pageTitle) {
        pageTitle.innerText = `Regression: ${y} ~ ${[...xn, ...xc].join(' + ')}`;
      }
      
      // Compute regression using OLS
      console.log(' Computing OLS regression...');
      try {
        const results = computeOLS(xMatrix, yVector, intercept === 1, 0.05);
        console.log(' Regression computed successfully:', results);
        
        // Calculate fitted values
        const X = intercept === 1 
          ? xMatrix.map(row => [1, ...row])
          : xMatrix;
        results.fitted = X.map(row => 
          row.reduce((sum, xi, i) => sum + xi * results.coefficients[i], 0)
        );
        
        // Store results globally for tabs
        window.regressionResults = results;
        window.regressionData = { yVector, xMatrix, intercept };
        
        // Store global variables for predictions module
        window.globalRegressionResults = results;
        window.globalYVar = y;
        window.globalXnVars = xn;
        window.globalXcVars = xc;
        window.globalRawHeaders = headers;
        window.globalRawRows = rows;
        window.globalIncludeIntercept = intercept;
        
        // Pre-store data for all tabs in sessionStorage
        sessionStorage.setItem('residualData', JSON.stringify({
          results: results,
          fittedValues: results.fitted
        }));
        
        // Prepare correlation data
        const indices = [y, ...xn].map(varName => headers.indexOf(varName)).filter(idx => idx !== -1);
        const filteredHeaders = indices.map(idx => headers[idx]);
        const filteredData = rows.map(row => {
          const rowObj = {};
          filteredHeaders.forEach((header, i) => {
            rowObj[header] = row[indices[i]];
          });
          return rowObj;
        });
        
        sessionStorage.setItem('correlationData', JSON.stringify({
          headers: filteredHeaders,
          data: filteredData,
          address: address,
          source: 'regression-model',
          modelInfo: { y, xn, totalVars: filteredHeaders.length }
        }));
        
        console.log(' All tab data pre-stored in sessionStorage');
        
        // Display results in the UI
        displayRegressionResults(results, y, xn, xc);
        
        // Hide loading overlay after successful computation
        const loadingOverlay = document.getElementById('loadingOverlay');
        if (loadingOverlay) {
          loadingOverlay.classList.add('hidden');
        }
        
      } catch (error) {
        console.error(' Error computing regression:', error);
        console.error('Error details:', error.message, error.stack);
        // Show error in UI instead of alert
        const tbody = document.getElementById('dataTableBody');
        if (tbody) {
          tbody.innerHTML = `<tr><td colspan="8" style="color: #ff6b6b; text-align: center; padding: 20px;">
            <i class="fa-solid fa-exclamation-triangle"></i> Error: ${error.message}
          </td></tr>`;
        }
        
        // Hide loading overlay after error
        const loadingOverlay = document.getElementById('loadingOverlay');
        if (loadingOverlay) {
          loadingOverlay.classList.add('hidden');
        }
      }
    }
    
    // Display regression results in the UI
    function displayRegressionResults(results, yVarName, xnVars, xcVars) {
      console.log(' Displaying regression results...');
      
      // Get the proper variable names (with dummy coding)
      const varNames = window.regressionVariableNames || [...xnVars, ...xcVars];
      
      // Build complete variable list with proper names (for use throughout)
      const allVars = results.includeIntercept ? ['Intercept', ...varNames] : varNames;
      
      // Populate Sample Info panel
      document.getElementById('validObs').textContent = results.n;
      document.getElementById('includeIntercept').textContent = results.includeIntercept ? 'Yes' : 'No';
      document.getElementById('numNumericVars').textContent = xnVars.length;
      document.getElementById('numCategoricalVars').textContent = xcVars.length;
      document.getElementById('degreesOfFreedom').textContent = results.df; // Residual degrees of freedom (n - k)
      
      // Show/hide ANCOVA tab based on model structure
      const ancovaTabButton = document.getElementById('ancovaTabButton');
      if (ancovaTabButton) {
        // ANCOVA requires BOTH categorical factors AND continuous covariates
        const hasANCOVA = xnVars.length > 0 && xcVars.length > 0;
        ancovaTabButton.style.display = hasANCOVA ? 'inline-flex' : 'none';
        console.log(` ANCOVA tab ${hasANCOVA ? 'shown' : 'hidden'} (${xnVars.length} continuous, ${xcVars.length} categorical)`);
      }
      
      // Populate Model Fit panel
      document.getElementById('rSquared').textContent = results.R2.toFixed(4); // Always 4 decimals for R
      document.getElementById('adjRSquared').textContent = results.R2_adj.toFixed(4); // Always 4 decimals for R
      document.getElementById('rootMSE').textContent = formatNumber(results.RMSE);
      document.getElementById('aic').textContent = formatNumber(results.AIC);
      document.getElementById('bic').textContent = formatNumber(results.BIC);
      
      // Populate F-test panel
      document.getElementById('fStatistic').textContent = formatNumber(results.F_stat);
      document.getElementById('fPValue').textContent = results.F_pvalue < 0.0001 ? '< 0.0001' : results.F_pvalue.toFixed(4); // Always 4 decimals for p-value
      document.getElementById('ssModel').textContent = formatNumber(results.SSE);
      document.getElementById('ssResidual').textContent = formatNumber(results.SSR);

      applyMetricClass(document.getElementById('rSquared'), rSquaredClass(results.R2));
      applyMetricClass(document.getElementById('adjRSquared'), rSquaredClass(results.R2_adj));
      applyMetricClass(document.getElementById('fPValue'), pValueClass(results.F_pvalue));
      updateExecutiveKpis({
        R2: results.R2,
        adjR2: results.R2_adj,
        rmse: results.RMSE,
        pValue: results.F_pvalue < 0.0001 ? '< 0.0001' : results.F_pvalue.toFixed(4),
        n: results.n
      });
      updateInterpretationPanel({
        R2: results.R2,
        RMSE: results.RMSE,
        F_pvalue: results.F_pvalue,
        n: results.n
      });
      
      // Populate ANOVA table
      const anovaBody = document.getElementById('anovaTableBody');
      if (anovaBody) {
        // Calculate degrees of freedom
        const df_model = results.k - 1; // k - 1 for model (k includes intercept)
        const df_residual = results.df; // n - k
        const df_total = results.n - 1;
        
        // Calculate mean squares
        const ms_model = results.SSE / df_model;
        const ms_residual = results.SSR / df_residual;
        
        anovaBody.innerHTML = `
          <tr style="background: rgba(74, 85, 104, 0.3);">
            <td><strong>Model</strong></td>
            <td>${df_model}</td>
            <td>${formatNumber(results.SSE)}</td>
            <td>${formatNumber(ms_model)}</td>
            <td>${formatNumber(results.F_stat)}</td>
            <td>${results.F_pvalue < 0.0001 ? '< 0.0001' : results.F_pvalue.toFixed(4)}</td>
          </tr>
          <tr>
            <td><strong>Residual</strong></td>
            <td>${df_residual}</td>
            <td>${formatNumber(results.SSR)}</td>
            <td>${formatNumber(ms_residual)}</td>
            <td></td>
            <td></td>
          </tr>
          <tr style="background: rgba(255, 165, 120, 0.2); font-weight: 600;">
            <td><strong>Total</strong></td>
            <td>${df_total}</td>
            <td>${formatNumber(results.TSS)}</td>
            <td></td>
            <td></td>
            <td></td>
          </tr>
        `;
      }
      
      // Populate coefficients table
      const tbody = document.getElementById('dataTableBody');
      if (tbody) {
        tbody.innerHTML = '';
        
        results.coefficients.forEach((coef, i) => {
          const row = document.createElement('tr');
          const varName = allVars[i] || `X${i}`;
          
          // Determine variable type for color coding
          let varClass = '';
          let rowStyle = '';
          if (i === 0 && results.includeIntercept) {
            varClass = 'var-intercept';
            rowStyle = 'background: rgba(251, 191, 36, 0.08) !important;';
          } else {
            // Check if it's a categorical variable (contains underscore for dummy coding)
            if (varName.includes('_')) {
              varClass = 'var-categorical';
              rowStyle = 'background: rgba(244, 114, 182, 0.08) !important;';
            } else {
              varClass = 'var-numeric';
              rowStyle = 'background: rgba(59, 130, 246, 0.05) !important;';
            }
          }
          
          // Check significance
          const significant = results.p_values[i] < 0.05;
          const highlySignificant = results.p_values[i] < 0.01;
          const veryHighlySignificant = results.p_values[i] < 0.001;
          
          let sigIndicator = '';
          if (veryHighlySignificant) sigIndicator = ' ***';
          else if (highlySignificant) sigIndicator = ' **';
          else if (significant) sigIndicator = ' *';
          
          row.style.cssText = rowStyle;
          
          // Use global formatNumber function for all values
          const formatCoef = (val) => formatNumber(val);
          const formatSE = (val) => formatNumber(val);
          
          row.innerHTML = `
            <td><strong class="${varClass}">${varName}</strong></td>
            <td class="coef-cell">${formatCoef(coef)}${sigIndicator}</td>
            <td>${formatSE(results.std_errors[i])}</td>
            <td>${results.t_values[i].toFixed(2)}</td>
            <td class="${results.p_values[i] < 0.05 ? 'pvalue-good' : (results.p_values[i] < 0.1 ? 'pvalue-warning' : 'pvalue-bad')}">${results.p_values[i] < 0.0001 ? '< 0.0001' : results.p_values[i].toFixed(4)}</td>
            <td class="ci-cell">${formatCoef(results.CI_lower[i])}</td>
            <td class="ci-cell">${formatCoef(results.CI_upper[i])}</td>
            <td>${i === 0 && results.includeIntercept ? '' : (results.VIF[i - (results.includeIntercept ? 1 : 0)]?.toFixed(2) || '')}</td>
          `;
          
          tbody.appendChild(row);
        });
      }
      
      // Generate and display regression equation
      const equationDiv = document.getElementById('regressionEquation');
      if (equationDiv) {
        let equation = `${yVarName} = `;
        
        // Add intercept if included
        if (results.includeIntercept && results.coefficients.length > 0) {
          equation += `${results.coefficients[0].toFixed(2)}`;
        }
        
        // Add all predictor terms
        const startIdx = results.includeIntercept ? 1 : 0;
        for (let i = startIdx; i < results.coefficients.length; i++) {
          const coef = results.coefficients[i];
          const varName = allVars[i] || `X${i}`;
          const sign = coef >= 0 ? ' + ' : ' - ';
          const absCoef = Math.abs(coef).toFixed(2);
          
          equation += `${sign}${absCoef}  ${varName}`;
        }
        
        equation += ' + ';
        equationDiv.textContent = equation;
      }
      
      console.log(' Results displayed in UI');
    }

    // Function to trigger VB6 regression
    function runRegression() {
      console.log(' Running regression...');
      sendToHost('runRegression', { action: 'run' });
    }

    // Store the number of numeric variables for table population
    let numNumericVariables = 0;
    
    // Global variable to store regression results for AI
    let regressionResultsForAI = null;
    
    // Function to store results when they arrive
    function storeRegressionResultsForAI(statsData, tableData) {
      console.log(' Storing regression results for AI...');
      
      // Parse the data if strings
      const stats = typeof statsData === 'string' ? JSON.parse(statsData) : statsData;
      const coeffs = typeof tableData === 'string' ? JSON.parse(tableData) : tableData;
      
      // Store in global variable for AI interpretation
      regressionResultsForAI = {
        yVariable: document.getElementById('page-title')?.innerText || 'Y',
        observations: stats.observations || stats.validObs,
        numPredictors: (parseInt(stats.numNumericVars || 0) + parseInt(stats.numCategoricalVars || 0)),
        rSquared: stats.rSquared || stats.R2,
        adjRSquared: stats.adjRSquared || stats.adjR2,
        rootMSE: stats.rootMSE || stats.rmse,
        aic: stats.aic || stats.AIC,
        bic: stats.bic || stats.BIC,
        fStatistic: stats.fStatistic || stats.F,
        fPValue: stats.fPValue || stats.pValue,
        ssModel: stats.ssModel || stats.SSR,
        ssResidual: stats.ssResidual || stats.SSE,
        coefficients: coeffs
      };
      
      // Show AI button now that we have results
      const aiBtn = document.getElementById('aiInterpretBtn');
      if (aiBtn) {
        aiBtn.style.display = 'block';
        console.log(' AI button shown');
      }
      
      console.log(' Regression results stored for AI');
    }
    
    // Function to request AI interpretation
    function requestRegressionAI() {
      console.log(' Requesting AI interpretation for regression...');
      
      if (!regressionResultsForAI) {
        alert('No regression results available. Please run a regression first.');
        return;
      }
      
      // Show loading state on button
      const aiBtn = document.getElementById('aiInterpretBtn');
      if (aiBtn) {
        aiBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Processing...';
        aiBtn.disabled = true;
      }
      
      // Convert to JSON and send to VB6
      const jsonData = JSON.stringify(regressionResultsForAI);
      console.log(' Sending to VB6 (', jsonData.length, 'chars)');
      
      sendToHost('requestRegressionAI', jsonData);
      
      // Reset button after a delay
      setTimeout(() => {
        if (aiBtn) {
          aiBtn.innerHTML = '<i class="fa-solid fa-robot"></i> AI Interpret';
          aiBtn.disabled = false;
        }
      }, 2000);
    }
    
    // Function to receive AI interpretation from VB6
    window.receiveRegressionAI = function(jsonPayload) {
      console.log(' Received AI interpretation from VB6');
      
      try {
        const data = JSON.parse(jsonPayload);
        
        if (data.error) {
          alert('AI Error: ' + data.error);
          console.error(' AI Error:', data.error);
          return;
        }
        
        if (data.interpretation) {
          console.log(' AI Interpretation received (', data.interpretation.length, 'chars)');
          console.log(' Preview:', data.interpretation.substring(0, 100) + '...');
          // The VB6 code shows a popup
        }
      } catch (e) {
        console.error(' Error parsing AI response:', e);
        alert('Error displaying AI interpretation: ' + e.message);
      }
    };

    // Global array to store regression variables (for navigation to descriptive stats)
    let regressionVariablesList = [];
    
    // VB6 can call this to set the regression variables list
    window.setRegressionVariablesList = function(variablesArray) {
      console.log(' VB6 setRegressionVariablesList called');
      
      if (typeof variablesArray === 'string') {
        try {
          regressionVariablesList = JSON.parse(variablesArray);
          console.log(' Regression variables list set:', regressionVariablesList);
        } catch (e) {
          console.error(' Error parsing variables array:', e);
        }
      } else if (Array.isArray(variablesArray)) {
        regressionVariablesList = variablesArray;
        console.log(' Regression variables list set:', regressionVariablesList);
      }
    };
    
    // Load Residuals Tab Content
    function loadResidualsTab() {
      if (!window.regressionResults || !window.regressionData) {
        document.getElementById('residualsPanel').innerHTML = `
          <div style="text-align: center; padding: 60px 20px; color: var(--text-muted);">
            <i class="fa-solid fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 15px;"></i>
            <p>No regression results available</p>
          </div>
        `;
        return;
      }
      
      console.log(' Loading residuals tab...');
      const panel = document.getElementById('residualsPanel');
      const baseUrl = window.location.href.split('/regression/')[0];
      const iframeUrl = `${baseUrl}/regression/regression-residuals.html`;
      console.log('Loading iframe:', iframeUrl);
      
      const iframe = document.createElement('iframe');
      iframe.style.cssText = 'width: 100%; height: 80vh; border: none; background: transparent;';
      iframe.src = iframeUrl;
      
      // Send data to iframe when it loads
      iframe.onload = function() {
        console.log(' Sending data to residuals iframe');
        const results = window.regressionResults;
        const data = window.regressionData;
        
        iframe.contentWindow.postMessage({
          type: 'RESIDUAL_DATA',
          payload: {
            results: results,
            fittedValues: results.fitted,
            yVector: data.yVector,
            xMatrix: data.xMatrix,
            intercept: data.intercept
          }
        }, '*');
        
        // Send current theme to iframe
        const currentTheme = document.documentElement.getAttribute('data-theme') || 'dark';
        setTimeout(() => {
          iframe.contentWindow.postMessage({
            type: 'THEME_CHANGE',
            theme: currentTheme
          }, '*');
          console.log(` Sent theme '${currentTheme}' to residuals iframe`);
        }, 100);
      };
      
      panel.innerHTML = '';
      panel.appendChild(iframe);
      window.residualsLoaded = true;
    }
    
    // Load Correlations Tab Content  
    function loadCorrelationsTab() {
      if (!receivedRegressionData || !receivedModelSpec) {
        document.getElementById('correlationsPanel').innerHTML = `
          <div style="text-align: center; padding: 60px 20px; color: var(--text-muted);">
            <i class="fa-solid fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 15px;"></i>
            <p>No data available</p>
          </div>
        `;
        return;
      }
      
      console.log(' Loading correlations tab...');
      const panel = document.getElementById('correlationsPanel');
      const baseUrl = window.location.href.split('/regression/')[0];
      const iframeUrl = `${baseUrl}/correlations/correlation-matrix.html`;
      console.log('Loading iframe:', iframeUrl);
      
      const iframe = document.createElement('iframe');
      iframe.style.cssText = 'width: 100%; height: 80vh; border: none; background: transparent;';
      iframe.src = iframeUrl;
      
      // Prepare correlation data
      const { headers, rows, address } = receivedRegressionData;
      const { y, xn = [] } = receivedModelSpec;
      const indices = [y, ...xn].map(varName => headers.indexOf(varName)).filter(idx => idx !== -1);
      const filteredHeaders = indices.map(idx => headers[idx]);
      const filteredData = rows.map(row => {
        const rowObj = {};
        filteredHeaders.forEach((header, i) => {
          rowObj[header] = row[indices[i]];
        });
        return rowObj;
      });
      
      // Send data to iframe when it loads
      iframe.onload = function() {
        console.log(' Sending data to correlations iframe');
        iframe.contentWindow.postMessage({
          type: 'CORRELATION_DATA',
          payload: {
            headers: filteredHeaders,
            data: filteredData,
            address: address,
            source: 'regression-model'
          }
        }, '*');
        
        // Send current theme to iframe
        const currentTheme = document.documentElement.getAttribute('data-theme') || 'dark';
        setTimeout(() => {
          iframe.contentWindow.postMessage({
            type: 'THEME_CHANGE',
            theme: currentTheme
          }, '*');
          console.log(` Sent theme '${currentTheme}' to correlations iframe`);
        }, 100);
      };
      
      panel.innerHTML = '';
      panel.appendChild(iframe);
      window.correlationsLoaded = true;
    }
    
    // Load Descriptive Stats Tab Content
    function loadDescriptiveTab() {
      if (!receivedRegressionData || !receivedModelSpec) {
        document.getElementById('descriptivePanel').innerHTML = `
          <div style="text-align: center; padding: 60px 20px; color: var(--text-muted);">
            <i class="fa-solid fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 15px;"></i>
            <p>No data available</p>
          </div>
        `;
        return;
      }
      
      console.log(' Loading descriptive stats tab...');
      const panel = document.getElementById('descriptivePanel');
      const baseUrl = window.location.href.split('/regression/')[0];
      const iframeUrl = `${baseUrl}/correlations/descriptive-stats.html`;
      console.log('Loading iframe:', iframeUrl);
      
      const iframe = document.createElement('iframe');
      iframe.style.cssText = 'width: 100%; height: 80vh; border: none; background: transparent;';
      iframe.src = iframeUrl;
      
      // Prepare data (same format as correlations)
      const { headers, rows, address } = receivedRegressionData;
      const { y, xn = [] } = receivedModelSpec;
      const indices = [y, ...xn].map(varName => headers.indexOf(varName)).filter(idx => idx !== -1);
      const filteredHeaders = indices.map(idx => headers[idx]);
      const filteredData = rows.map(row => {
        const rowObj = {};
        filteredHeaders.forEach((header, i) => {
          rowObj[header] = row[indices[i]];
        });
        return rowObj;
      });
      
      // Send data to iframe when it loads
      iframe.onload = function() {
        console.log(' Sending data to descriptive stats iframe');
        iframe.contentWindow.postMessage({
          type: 'CORRELATION_DATA', // Descriptive stats uses same message type
          payload: {
            headers: filteredHeaders,
            data: filteredData,
            address: address,
            source: 'regression-model'
          }
        }, '*');
        
        // Send current theme to iframe
        const currentTheme = document.documentElement.getAttribute('data-theme') || 'dark';
        setTimeout(() => {
          iframe.contentWindow.postMessage({
            type: 'THEME_CHANGE',
            theme: currentTheme
          }, '*');
          console.log(` Sent theme '${currentTheme}' to descriptive stats iframe`);
        }, 100);
      };
      
      panel.innerHTML = '';
      panel.appendChild(iframe);
      window.descriptiveLoaded = true;
    }
    
    // Function to open residual diagnostics (keep for dropdown compatibility)
    function openResidualDiagnostics() {
      switchTab('residuals');
    }
    
    // Function to open correlation matrix for model variables (keep for dropdown compatibility)
    function openModelCorrelations() {
      switchTab('correlations');
    }
    
    // Function to open descriptive statistics for model variables (keep for dropdown compatibility)
    function openModelDescriptiveStats() {
      switchTab('descriptive');
    }
    
    // Dropdown toggle functionality
    (function() {
      const dropdownBtn = document.getElementById('dropdownBtn');
      const dropdownContent = document.getElementById('dropdownContent');

      dropdownBtn.addEventListener('click', function(e) {
        e.stopPropagation();
        dropdownContent.classList.toggle('show');
        dropdownBtn.classList.toggle('open');
      });

      window.addEventListener('click', function() {
        dropdownContent.classList.remove('show');
        dropdownBtn.classList.remove('open');
      });

      dropdownContent.addEventListener('click', function(e) {
        e.stopPropagation();
      });
      
      // Intercept clicks on dropdown links to store regression context
      dropdownContent.querySelectorAll('a').forEach(link => {
        link.addEventListener('click', function(e) {
          const href = this.getAttribute('href');
          
          // If navigating to descriptive statistics, store regression variables
          if (href && href.includes('Case400')) {
            console.log(' Navigating to Descriptive Statistics from regression');
            
            if (regressionVariablesList.length > 0) {
              console.log(' Storing regression variables:', regressionVariablesList);
              sessionStorage.setItem('regressionModelVariables', JSON.stringify(regressionVariablesList));
              sessionStorage.setItem('loadFromRegression', 'true');
            } else {
              console.warn(' No regression variables available yet');
            }
          }
          
          // If navigating to correlation analysis, store regression variables
          if (href && href.includes('Case500')) {
            console.log(' Navigating to Correlation Analysis from regression');
            
            if (regressionVariablesList.length > 0) {
              console.log(' Storing regression variables:', regressionVariablesList);
              sessionStorage.setItem('regressionModelVariables', JSON.stringify(regressionVariablesList));
              sessionStorage.setItem('loadFromRegression', 'true');
            }
          }
        });
      });
    })();

    window.toggleSection = function(contentId, buttonId) {
      const section = document.getElementById(contentId);
      const button = document.getElementById(buttonId);
      if (!section || !button) return;
      const isCollapsed = section.classList.toggle('is-collapsed');
      button.innerHTML = isCollapsed
        ? '<i class="fa-solid fa-chevron-down"></i> Expand'
        : '<i class="fa-solid fa-chevron-up"></i> Collapse';
    };

    function positionMetricTooltip(helpEl, tipEl) {
      if (!helpEl || !tipEl) return;
      const rect = helpEl.getBoundingClientRect();
      const margin = 8;
      const tipRect = tipEl.getBoundingClientRect();
      const tipWidth = tipRect.width || 260;
      const tipHeight = tipRect.height || 60;
      let left = rect.left + (rect.width / 2) - (tipWidth / 2);
      left = Math.max(margin, Math.min(left, window.innerWidth - tipWidth - margin));
      let top = rect.top - tipHeight - 10;
      if (top < margin) top = rect.bottom + 10;
      top = Math.max(margin, Math.min(top, window.innerHeight - tipHeight - margin));
      tipEl.style.left = `${left}px`;
      tipEl.style.top = `${top}px`;
    }

    function initMetricTooltips() {
      const helps = document.querySelectorAll('.metric-help');
      helps.forEach(helpEl => {
        const tipEl = helpEl.querySelector('.metric-tip');
        if (!tipEl) return;
        helpEl.removeAttribute('title');
        const icon = helpEl.querySelector('i');
        if (icon) icon.removeAttribute('title');
        const show = () => {
          tipEl.classList.add('is-visible');
          positionMetricTooltip(helpEl, tipEl);
        };
        const hide = () => tipEl.classList.remove('is-visible');
        helpEl.addEventListener('mouseenter', show);
        helpEl.addEventListener('mouseleave', hide);
      });

      window.addEventListener('scroll', () => {
        document.querySelectorAll('.metric-help .metric-tip.is-visible').forEach(tipEl => {
          const helpEl = tipEl.closest('.metric-help');
          positionMetricTooltip(helpEl, tipEl);
        });
      }, true);
      window.addEventListener('resize', () => {
        document.querySelectorAll('.metric-help .metric-tip.is-visible').forEach(tipEl => {
          const helpEl = tipEl.closest('.metric-help');
          positionMetricTooltip(helpEl, tipEl);
        });
      });
    }

    function parseNumericValue(value) {
      if (value === null || value === undefined) return NaN;
      if (typeof value === 'number') return value;
      const clean = String(value).replace(/,/g, '').trim();
      const match = clean.match(/-?\d*\.?\d+(?:e[+-]?\d+)?/i);
      return match ? parseFloat(match[0]) : NaN;
    }

    function parsePValue(value) {
      if (value === null || value === undefined) return NaN;
      const text = String(value).trim();
      if (!text) return NaN;
      return parseNumericValue(text);
    }

    function applyMetricClass(element, metricClass) {
      if (!element) return;
      element.classList.remove('metric-good', 'metric-warning', 'metric-bad');
      if (metricClass) element.classList.add(metricClass);
    }

    function rSquaredClass(value) {
      if (Number.isNaN(value)) return '';
      if (value < 0.3) return 'metric-bad';
      if (value < 0.6) return 'metric-warning';
      return 'metric-good';
    }

    function pValueClass(value) {
      if (Number.isNaN(value)) return '';
      return value < 0.05 ? 'metric-good' : 'metric-warning';
    }

    function updateExecutiveKpis(stats) {
      const r2Raw = parseNumericValue(stats.rSquared || stats.R2);
      const adjR2Raw = parseNumericValue(stats.adjRSquared || stats.adjR2);
      const rmseRaw = parseNumericValue(stats.rootMSE || stats.rmse);
      const fpRaw = parsePValue(stats.fPValue || stats.pValue);
      const nRaw = parseNumericValue(stats.observations || stats.validObs || stats.n);

      const r2Text = Number.isNaN(r2Raw) ? 'N/A' : `${(r2Raw * 100).toFixed(2)}%`;
      const adjR2Text = Number.isNaN(adjR2Raw) ? 'N/A' : `${(adjR2Raw * 100).toFixed(2)}%`;
      const rmseText = Number.isNaN(rmseRaw) ? 'N/A' : rmseRaw.toFixed(2);
      let fpText = 'N/A';
      if (!Number.isNaN(fpRaw)) {
        fpText = fpRaw < 0.0001 ? '< 0.0001' : fpRaw.toFixed(4);
      } else if (stats.fPValue || stats.pValue) {
        fpText = String(stats.fPValue || stats.pValue);
      }
      const nText = Number.isNaN(nRaw) ? (stats.observations || stats.validObs || stats.n || 'N/A') : String(Math.round(nRaw));
      const r2Elem = document.getElementById('kpiRSquared');
      const adjElem = document.getElementById('kpiAdjRSquared');
      const rmseElem = document.getElementById('kpiRMSE');
      const fpElem = document.getElementById('kpiFPValue');
      const nElem = document.getElementById('kpiN');
      if (r2Elem) r2Elem.innerText = r2Text;
      if (adjElem) adjElem.innerText = adjR2Text;
      if (rmseElem) rmseElem.innerText = rmseText;
      if (fpElem) fpElem.innerText = fpText;
      if (nElem) nElem.innerText = nText;
      applyMetricClass(r2Elem, rSquaredClass(r2Raw));
      applyMetricClass(adjElem, rSquaredClass(adjR2Raw));
      applyMetricClass(fpElem, pValueClass(fpRaw));
    }

    function updateInterpretationPanel(stats) {
      const el = document.getElementById('interpretationText');
      if (!el) return;
      const r2 = parseNumericValue(stats.rSquared || stats.R2);
      const rmse = stats.rootMSE || stats.rmse || stats.RMSE || 'N/A';
      const fP = parsePValue(stats.fPValue || stats.pValue || stats.F_pvalue);
      const n = stats.observations || stats.validObs || stats.n || 'N/A';
      let fitStatement = 'Model fit could not be evaluated from current outputs.';
      if (!Number.isNaN(r2)) {
        if (r2 < 0.3) fitStatement = `The model explains ${(r2 * 100).toFixed(1)}% of variance, indicating weak explanatory power.`;
        else if (r2 < 0.6) fitStatement = `The model explains ${(r2 * 100).toFixed(1)}% of variance, showing moderate explanatory power.`;
        else fitStatement = `The model explains ${(r2 * 100).toFixed(1)}% of variance, indicating strong explanatory power.`;
      }
      let sigStatement = 'Overall significance is not available.';
      if (!Number.isNaN(fP)) {
        sigStatement = fP < 0.05
          ? 'The F-test is statistically significant, so at least one predictor contributes to the model.'
          : 'The F-test is not statistically significant, so predictor effects should be interpreted cautiously.';
      }
      el.innerText = `${fitStatement} RMSE = ${rmse}. Sample size n = ${n}. ${sigStatement}`;
    }

    // Function to populate the panels dynamically
    function populatePanels(data) {
      const stats = JSON.parse(data);
      
      // Store for use in table population
      numNumericVariables = parseInt(stats.numNumericVars || stats.numXn || '0');
      
      // Sample Info
      document.getElementById('validObs').innerText = stats.observations || stats.validObs || 'N/A';
      document.getElementById('includeIntercept').innerText = stats.includeIntercept ? 'Yes' : 'No';
      document.getElementById('numNumericVars').innerText = numNumericVariables || '0';
      document.getElementById('numCategoricalVars').innerText = stats.numCategoricalVars || stats.numXc || '0';
      document.getElementById('degreesOfFreedom').innerText = stats.degreesOfFreedom || stats.df || 'N/A';
      
      // Model Fit
      document.getElementById('rSquared').innerText = stats.rSquared || stats.R2 || 'N/A';
      document.getElementById('adjRSquared').innerText = stats.adjRSquared || stats.adjR2 || 'N/A';
      document.getElementById('rootMSE').innerText = stats.rootMSE || stats.rmse || 'N/A';
      document.getElementById('aic').innerText = stats.aic || stats.AIC || 'N/A';
      document.getElementById('bic').innerText = stats.bic || stats.BIC || 'N/A';
      
      // F-Test
      document.getElementById('fStatistic').innerText = stats.fStatistic || stats.F || 'N/A';
      document.getElementById('fPValue').innerText = stats.fPValue || stats.pValue || 'N/A';
      document.getElementById('ssModel').innerText = stats.ssModel || stats.SSR || 'N/A';
      document.getElementById('ssResidual').innerText = stats.ssResidual || stats.SSE || 'N/A';

      applyMetricClass(document.getElementById('rSquared'), rSquaredClass(parseNumericValue(stats.rSquared || stats.R2)));
      applyMetricClass(document.getElementById('adjRSquared'), rSquaredClass(parseNumericValue(stats.adjRSquared || stats.adjR2)));
      applyMetricClass(document.getElementById('fPValue'), pValueClass(parsePValue(stats.fPValue || stats.pValue)));
      updateExecutiveKpis(stats);
      updateInterpretationPanel(stats);
      
      // Store stats for AI interpretation
      window.regressionStatsData = stats;
      
      // If we already have table data, store for AI
      if (window.regressionTableData) {
        storeRegressionResultsForAI(stats, window.regressionTableData);
      }
    }

    // Function to populate the regression table dynamically with sections
    function populateTable(data) {  
      const tableBody = document.getElementById('dataTableBody');
      tableBody.innerHTML = ''; // Clear previous content

      const rows = JSON.parse(data);
      
      // Store table data for AI interpretation
      window.regressionTableData = rows;
      
      // Extract and store ALL variable names (including Y variable) for navigation
      regressionVariablesList = [];
      
      // Add Y variable if available from page title or session storage
      const yVariable = sessionStorage.getItem('regressionYVariable') || 'Y';
      if (yVariable && yVariable !== 'Y') {
        regressionVariablesList.push(yVariable);
      }
      
      // Add all predictor variables (excluding Intercept)
      rows.forEach(row => {
        const varName = row.Variable || '';
        if (varName && varName !== 'Intercept') {
          // For categorical variables with dummy coding (e.g., "Category_A"), extract base name
          const baseName = varName.split('_')[0]; // Gets "Category" from "Category_A"
          if (!regressionVariablesList.includes(varName)) {
            regressionVariablesList.push(varName);
          }
        }
      });
      
      console.log(' Regression model variables extracted:', regressionVariablesList);
      
      // Group rows by type: intercept, numeric, categorical
      // Use index-based approach: first row might be intercept, next N are numeric, rest are categorical
      const intercept = [];
      const numericVars = [];
      const categoricalVars = [];
      
      let nonInterceptIndex = 0; // Track position among non-intercept variables
      
      rows.forEach((row, index) => {
        const varName = row.Variable || '';
        
        if (varName === 'Intercept') {
          intercept.push(row);
        } else {
          // For non-intercept variables, use the count from VBA
          // First numNumericVariables are numeric, rest are categorical dummies
          if (nonInterceptIndex < numNumericVariables) {
            numericVars.push(row);
          } else {
            categoricalVars.push(row);
          }
          nonInterceptIndex++;
        }
      });
      
      console.log(' Variable grouping:', {
        intercept: intercept.length,
        numeric: numericVars.length,
        categorical: categoricalVars.length,
        numNumericVariables: numNumericVariables
      });
      
      // Helper function to create a section header row
      function createSectionHeader(title) {
        const tr = document.createElement('tr');
        tr.className = 'section-header section-header-row';
        const td = document.createElement('td');
        td.colSpan = 8;
        td.textContent = title;
        tr.appendChild(td);
        return tr;
      }
      
      function valueByKeys(row, keys) {
        for (const key of keys) {
          if (row[key] !== undefined && row[key] !== null) return row[key];
        }
        return '';
      }

      function classifyPValueCell(td, value) {
        const p = parsePValue(value);
        if (Number.isNaN(p)) return;
        td.classList.remove('pvalue-good', 'pvalue-warning', 'pvalue-bad');
        if (p < 0.05) td.classList.add('pvalue-good');
        else if (p < 0.1) td.classList.add('pvalue-warning');
        else td.classList.add('pvalue-bad');
      }

      // Helper function to create a data row
      function createDataRow(row) {
        const tr = document.createElement('tr');
        const columns = [
          { keys: ['Variable', 'variable'], type: 'var' },
          { keys: ['Coefficient', 'coef', 'Estimate', 'estimate'], type: 'coef' },
          { keys: ['Std. Error', 'StdError', 'SE', 'stdError', 'std_error'], type: 'num' },
          { keys: ['t-value', 'tValue', 't', 'T'], type: 'num' },
          { keys: ['P-value', 'p-value', 'pValue', 'p', 'P'], type: 'p' },
          { keys: ['95% CI Lower', 'CI_Lower', 'ciLower', 'lowerCI', 'lower'], type: 'ci' },
          { keys: ['95% CI Upper', 'CI_Upper', 'ciUpper', 'upperCI', 'upper'], type: 'ci' },
          { keys: ['VIF', 'vif'], type: 'num' }
        ];

        columns.forEach(col => {
          const value = valueByKeys(row, col.keys);
          const td = document.createElement('td');
          td.textContent = value;
          if (col.type === 'coef') td.classList.add('coef-cell');
          if (col.type === 'ci') td.classList.add('ci-cell');
          if (col.type === 'p') classifyPValueCell(td, value);
          tr.appendChild(td);
        });
        return tr;
      }
      
      // Add Intercept section
      if (intercept.length > 0) {
        tableBody.appendChild(createSectionHeader(''));
        intercept.forEach(row => {
          tableBody.appendChild(createDataRow(row));
        });
      }
      
      // Add Numeric Variables section
      if (numericVars.length > 0) {
        tableBody.appendChild(createSectionHeader('Numeric Variables'));
        numericVars.forEach(row => {
          tableBody.appendChild(createDataRow(row));
        });
      }
      
      // Add Categorical Variables section
      if (categoricalVars.length > 0) {
        tableBody.appendChild(createSectionHeader('Categorical Variables (Dummy Coded)'));
        categoricalVars.forEach(row => {
          tableBody.appendChild(createDataRow(row));
        });
      }
      
      // Build regression equation
      buildRegressionEquation(rows);
      
      // Store data for AI interpretation if we have stats
      if (window.regressionStatsData) {
        storeRegressionResultsForAI(window.regressionStatsData, rows);
      }
      
      // Hide awaiting overlay when data is received
      if (typeof window.notifyDataReceived === 'function') {
        window.notifyDataReceived();
        console.log(' Regression Results: awaiting overlay hidden');
      } else if (typeof window.hideAwaitingPanel === 'function') {
        window.hideAwaitingPanel();
        console.log(' Regression Results: awaiting panel hidden (fallback)');
      }
    }
    
    function toggleEquation() {
      const equationSection = document.getElementById('equationSection');
      const toggleBtn = document.getElementById('toggleEquationBtn');
      
      if (equationSection.style.display === 'none') {
        equationSection.style.display = 'block';
        toggleBtn.innerHTML = '<i class="fa-solid fa-chevron-up"></i> Hide Regression Equation';
        toggleBtn.classList.add('active');
      } else {
        equationSection.style.display = 'none';
        toggleBtn.innerHTML = '<i class="fa-solid fa-chevron-down"></i> Show Regression Equation';
        toggleBtn.classList.remove('active');
      }
    }
    
    function buildRegressionEquation(rows) {
      const equationSection = document.getElementById('equationSection');
      const equationFormula = document.getElementById('equationFormula');
      const toggleBtn = document.getElementById('toggleEquationBtn');
      
      if (!rows || rows.length === 0) {
        equationSection.style.display = 'none';
        toggleBtn.style.display = 'none';
        return;
      }
      
      // Get Y variable name from page title or use default
      const yVar = 'Y';
      
      let equation = `<span class="y-var">${yVar}</span> = `;
      
      rows.forEach((row, index) => {
        const varName = row.Variable || `X${index}`;
        const coef = parseFloat(row.Coefficient);
        
        if (index === 0 && varName === 'Intercept') {
          // Intercept term
          equation += `<span class="coef">${coef.toFixed(4)}</span>`;
        } else {
          // Variable terms
          const sign = coef >= 0 ? '+' : '';
          equation += ` ${sign} <span class="coef">${coef.toFixed(4)}</span>  <span class="var">${varName}</span>`;
        }
      });
      
      equation += ' + ';
      
      equationFormula.innerHTML = equation;
      // Show toggle button, but keep equation hidden by default
      toggleBtn.style.display = 'block';
      equationSection.style.display = 'none';
      toggleBtn.innerHTML = '<i class="fa-solid fa-chevron-down"></i> Show Regression Equation';
      toggleBtn.classList.remove('active');
    }
    
    // Reset function for Results Panel Manager
    window.resetResultsPanel = function() {
      try {
        console.log(' Regression Results resetResultsPanel called');
        
        // Reset the numeric variables counter
        numNumericVariables = 0;
        
        // Show awaiting overlay (full-page)
        // The results-panel-manager.js will handle this automatically
        console.log(' Awaiting overlay will be shown by results-panel-manager');
        
        // Reset table to awaiting message
        const tableBody = document.getElementById('dataTableBody');
        if (tableBody) {
          tableBody.innerHTML = `
            <tr>
              <td colspan="8" style="text-align:center; padding:20px; color:var(--text-muted); font-style:italic;">
                <i class="fa-solid fa-hourglass-half"></i> Awaiting regression results...
              </td>
            </tr>
          `;
        }
        
        // Reset all stats panels to awaiting state
        ['validObs', 'includeIntercept', 'numNumericVars', 'numCategoricalVars', 'degreesOfFreedom', 
         'rSquared', 'adjRSquared', 'rootMSE', 'aic', 'bic', 'fStatistic', 'fPValue', 'ssModel', 'ssResidual'].forEach(id => {
          const elem = document.getElementById(id);
          if (elem) {
            elem.innerText = '...';
            elem.classList.remove('metric-good', 'metric-warning', 'metric-bad');
          }
        });

        ['kpiRSquared', 'kpiAdjRSquared', 'kpiRMSE', 'kpiFPValue', 'kpiN'].forEach(id => {
          const elem = document.getElementById(id);
          if (elem) {
            elem.innerText = '...';
            elem.classList.remove('metric-good', 'metric-warning', 'metric-bad');
          }
        });

        const interpretationText = document.getElementById('interpretationText');
        if (interpretationText) {
          interpretationText.innerText = 'Run a regression to generate a concise model interpretation.';
        }

        [
          { bodyId: 'anovaPanelBody', btnId: 'toggleAnovaBtn' },
          { bodyId: 'coefficientsBody', btnId: 'toggleCoefficientsBtn' }
        ].forEach(item => {
          const body = document.getElementById(item.bodyId);
          const btn = document.getElementById(item.btnId);
          if (body) body.classList.remove('is-collapsed');
          if (btn) btn.innerHTML = '<i class="fa-solid fa-chevron-up"></i> Collapse';
        });
        
        // Hide equation section and toggle button
        const equationSection = document.getElementById('equationSection');
        const toggleBtn = document.getElementById('toggleEquationBtn');
        if (equationSection) equationSection.style.display = 'none';
        if (toggleBtn) toggleBtn.style.display = 'none';
        
        console.log(' Regression Results panel reset complete');
      } catch (error) {
        console.error(' Error resetting regression results panel:', error);
      }
    };
    
    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
      console.log(' Linear Regression Results page loaded');
      console.log(' Awaiting regression data...');
      
      // Ensure awaiting message is visible on load
      const tableBody = document.getElementById('dataTableBody');
      if (tableBody && !tableBody.querySelector('tr')) {
        tableBody.innerHTML = `
          <tr>
            <td colspan="8" style="text-align:center; padding:20px; color:var(--text-muted); font-style:italic;">
              <i class="fa-solid fa-hourglass-half"></i> Awaiting regression results...
            </td>
          </tr>
        `;
      }
      
      // Set all stats to awaiting state
      ['validObs', 'includeIntercept', 'numNumericVars', 'numCategoricalVars', 'degreesOfFreedom', 
       'rSquared', 'adjRSquared', 'rootMSE', 'aic', 'bic', 'fStatistic', 'fPValue', 'ssModel', 'ssResidual'].forEach(id => {
        const elem = document.getElementById(id);
        if (elem && (elem.innerText === '' || elem.innerText === 'undefined')) {
          elem.innerText = '...';
          elem.classList.remove('metric-good', 'metric-warning', 'metric-bad');
        }
      });

      ['kpiRSquared', 'kpiAdjRSquared', 'kpiRMSE', 'kpiFPValue', 'kpiN'].forEach(id => {
        const elem = document.getElementById(id);
        if (elem && (elem.innerText === '' || elem.innerText === 'undefined')) {
          elem.innerText = '...';
        }
        if (elem) {
          elem.classList.remove('metric-good', 'metric-warning', 'metric-bad');
        }
      });

      const interpretationText = document.getElementById('interpretationText');
      if (interpretationText && !interpretationText.innerText.trim()) {
        interpretationText.innerText = 'Run a regression to generate a concise model interpretation.';
      }

      initMetricTooltips();
      
      // Notify VB6 that the regression dashboard is ready for AI responses
      console.log(' Regression dashboard DOM loaded');
      setTimeout(() => {
        console.log(' Notifying VB6 that regression dashboard is ready...');
        sendToHost('regressionDashboardReady', '{}');
      }, 500);
    });
    
    // Also notify on window load (fallback)
    window.addEventListener('load', function() {
      console.log(' Regression dashboard fully loaded');
      sendToHost('regressionDashboardReady', '{}');
    });
    
    console.log(' Regression AI integration JavaScript loaded');
    
    // ========================================
    // PYTHON CLOUD FUNCTION INTEGRATION
    // ========================================
    
    // Configuration: Set your cloud function URL here
    const CLOUD_FUNCTION_URL = 'YOUR_CLOUD_FUNCTION_URL_HERE';
    // Example: 'https://us-central1-your-project.cloudfunctions.net/regression_diagnostics'
    // Or for local testing: 'http://localhost:8080'
    
    // Store regression data for diagnostics computation
    let regressionDataForDiagnostics = null;
    
    /**
     * Call Python cloud function to compute advanced diagnostics
     */
    async function computeDiagnostics() {
      console.log(' Computing advanced diagnostics via Python cloud function...');
      
      if (!regressionDataForDiagnostics) {
        alert('No regression data available. Please run a regression first.');
        return;
      }
      
      const btn = document.getElementById('refreshDiagnosticsBtn');
      if (btn) {
        btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Computing...';
        btn.disabled = true;
      }
      
      try {
        const response = await fetch(CLOUD_FUNCTION_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(regressionDataForDiagnostics)
        });
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const result = await response.json();
        
        if (result.ok) {
          displayDiagnostics(result.diagnostics);
          console.log(' Diagnostics computed successfully');
        } else {
          throw new Error(result.error || 'Unknown error from cloud function');
        }
        
      } catch (error) {
        console.error(' Error computing diagnostics:', error);
        alert(`Error computing diagnostics: ${error.message}\n\nPlease check:\n1. Cloud function URL is correct\n2. Cloud function is deployed\n3. Network connection is available`);
      } finally {
        if (btn) {
          btn.innerHTML = '<i class="fa-solid fa-sync"></i> Compute';
          btn.disabled = false;
        }
      }
    }
    
    /**
     * Display diagnostics results in the HTML panel
     */
    function displayDiagnostics(diagnostics) {
      console.log(' Displaying diagnostics results...');
      
      // Show diagnostics panel
      const panel = document.getElementById('diagnosticsPanel');
      if (panel) panel.style.display = 'block';
      
      // Multicollinearity
      const condNum = diagnostics.multicollinearity.condition_number;
      document.getElementById('conditionNumber').innerText = 
        condNum === Infinity ? '' : condNum.toFixed(2);
      
      document.getElementById('determinant').innerText = 
        diagnostics.multicollinearity.determinant.toExponential(4);
      
      // VIF values (skip if not computed for performance)
      const vifList = document.getElementById('vifList');
      if (vifList) {
        const vifs = diagnostics.multicollinearity.vif || [];
        if (vifs.length > 0) {
          let vifHtml = '<ul style="margin: 5px 0; padding-left: 20px;">';
          vifs.forEach((vif, idx) => {
            const varName = idx === 0 ? 'Intercept' : `X${idx}`;
            const color = vif > 10 ? 'color: #ff6b6b;' : vif > 5 ? 'color: #ffa500;' : '';
            const warning = vif > 10 ? '  High' : vif > 5 ? '  Moderate' : '';
            vifHtml += `<li style="${color}">${varName}: ${vif.toFixed(2)}${warning}</li>`;
          });
          vifHtml += '</ul>';
          vifList.innerHTML = vifHtml;
        } else {
          vifList.innerHTML = '<p style="margin: 5px 0; color: #888; font-style: italic;">VIF not computed (disabled for performance)</p>';
        }
      }
      
      // High correlations
      const highCorr = diagnostics.multicollinearity.high_correlations;
      const highCorrContainer = document.getElementById('highCorrContainer');
      const highCorrList = document.getElementById('highCorrList');
      
      if (highCorr && highCorr.length > 0) {
        highCorrContainer.style.display = 'block';
        let corrHtml = '<ul style="margin: 5px 0; padding-left: 20px;">';
        highCorr.forEach(pair => {
          const var1 = pair.i === 0 ? 'Intercept' : `X${pair.i}`;
          const var2 = pair.j === 0 ? 'Intercept' : `X${pair.j}`;
          const perfect = pair.perfect ? ' (Perfect!)' : '';
          corrHtml += `<li>${var1}  ${var2}: r = ${pair.r.toFixed(4)}${perfect}</li>`;
        });
        corrHtml += '</ul>';
        highCorrList.innerHTML = corrHtml;
      } else {
        highCorrContainer.style.display = 'none';
      }
      
      // Autocorrelation
      document.getElementById('durbinWatson').innerText = 
        diagnostics.autocorrelation.durbin_watson.toFixed(4);
      
      document.getElementById('lag1Autocorr').innerText = 
        diagnostics.autocorrelation.lag1_autocorr.toFixed(4);
      
      // PRESS
      document.getElementById('pressStatistic').innerText = 
        diagnostics.leverage.press.toFixed(4);
      
      console.log(' Diagnostics displayed successfully');
    }
    
    /**
     * Prepare regression data for cloud function
     * Call this when regression results are available
     */
    function prepareRegressionDataForDiagnostics(xMatrix, yVector, includeIntercept) {
      regressionDataForDiagnostics = {
        x: xMatrix,
        y: yVector,
        intercept: includeIntercept,
        thresholds: {
          high_corr: 0.9,
          perfect_corr: 0.9999
        }
      };
      
      console.log(' Regression data prepared for diagnostics');
      console.log('   Observations:', yVector.length);
      console.log('   Predictors:', xMatrix[0].length);
      console.log('   Include intercept:', includeIntercept);
      
      // Show diagnostics panel (initially empty)
      const panel = document.getElementById('diagnosticsPanel');
      if (panel) panel.style.display = 'block';
    }
    
    /**
     * VB6 Integration: Receive regression data from VB6
     * This function should be called from VB6 after regression is computed
     */
    window.receiveRegressionDataForDiagnostics = function(jsonPayload) {
      console.log(' Received regression data from VB6 for diagnostics');
      
      try {
        const data = JSON.parse(jsonPayload);
        prepareRegressionDataForDiagnostics(data.x, data.y, data.intercept);
        
        // Optionally auto-compute diagnostics
        // computeDiagnostics();
        
      } catch (e) {
        console.error(' Error parsing regression data:', e);
      }
    };
    
    // Attach event listener to compute button
    document.addEventListener('DOMContentLoaded', function() {
      const btn = document.getElementById('refreshDiagnosticsBtn');
      if (btn) {
        btn.addEventListener('click', computeDiagnostics);
      }
    });
    
    console.log(' Python cloud function integration loaded');
    console.log(' Cloud function URL:', CLOUD_FUNCTION_URL);
    
    /* ========================================
       PREDICTIONS MODULE
       Interactive prediction engine with sliders
    ======================================== */

    /**
     * Initialize prediction inputs based on regression model
     */
    function initializePredictions() {
      if (!window.globalRegressionResults) {
        console.warn('No regression results available for predictions');
        return;
      }

      console.log(' Initializing predictions module...');

      // Store regression data
      const results = window.globalRegressionResults;
      predictionData.coefficients = results.coefficients || [];
      predictionData.stats = results;

      // Get variable info from global data
      const yVar = window.globalYVar || 'Y';
      const xnVars = window.globalXnVars || [];
      const xcVars = window.globalXcVars || [];
      const rawHeaders = window.globalRawHeaders || [];
      const rawRows = window.globalRawRows || [];

      // Display the predicted variable name
      const predictedVarNameEl = document.getElementById('predictedVariableName');
      if (predictedVarNameEl) {
        predictedVarNameEl.textContent = yVar;
      }

      predictionData.numericVars = xnVars;
      predictionData.categoricalVars = xcVars;

      // Calculate ranges for numeric variables
      const numericRanges = {};
      xnVars.forEach(varName => {
        const colIndex = rawHeaders.indexOf(varName);
        if (colIndex !== -1) {
          const values = rawRows.map(row => parseFloat(row[colIndex])).filter(v => !isNaN(v));
          if (values.length > 0) {
            numericRanges[varName] = {
              min: Math.min(...values),
              max: Math.max(...values),
              mean: values.reduce((a, b) => a + b, 0) / values.length,
              median: values.sort((a, b) => a - b)[Math.floor(values.length / 2)]
            };
          }
        }
      });

      // Get categorical levels
      xcVars.forEach(varName => {
        const colIndex = rawHeaders.indexOf(varName);
        if (colIndex !== -1) {
          const levels = [...new Set(rawRows.map(row => row[colIndex]).filter(v => v !== null && v !== undefined && v !== ''))];
          predictionData.categoricalLevels[varName] = levels;
        }
      });

      // Generate input controls
      const container = document.getElementById('predictionInputsContainer');
      container.innerHTML = '';

      // Numeric variables - sliders
      xnVars.forEach(varName => {
        const range = numericRanges[varName];
        if (!range) return;

        const inputGroup = document.createElement('div');
        inputGroup.className = 'input-group';
        inputGroup.innerHTML = `
          <div class="input-label">
            <span><i class="fa-solid fa-chart-line"></i> ${varName}</span>
            <span class="input-value-display" id="value-${varName}">${range.mean.toFixed(2)}</span>
          </div>
          <div class="slider-container">
            <input 
              type="range" 
              class="input-slider" 
              id="input-${varName}"
              min="${range.min}" 
              max="${range.max}" 
              step="${(range.max - range.min) / 100}"
              value="${range.mean}"
              oninput="updatePrediction()"
            />
            <div class="slider-range">
              <span>Min: ${range.min.toFixed(2)}</span>
              <span>Max: ${range.max.toFixed(2)}</span>
            </div>
          </div>
        `;
        container.appendChild(inputGroup);

        // Store initial value
        predictionData.currentInputs[varName] = range.mean;
      });

      // Categorical variables - dropdowns
      xcVars.forEach(varName => {
        const levels = predictionData.categoricalLevels[varName];
        if (!levels || levels.length === 0) return;

        const inputGroup = document.createElement('div');
        inputGroup.className = 'input-group';
        
        const options = levels.map(level => 
          `<option value="${level}">${level}</option>`
        ).join('');

        inputGroup.innerHTML = `
          <div class="input-label">
            <span><i class="fa-solid fa-tags"></i> ${varName}</span>
          </div>
          <select class="input-select" id="input-${varName}" onchange="updatePrediction()">
            ${options}
          </select>
        `;
        container.appendChild(inputGroup);

        // Store initial value
        predictionData.currentInputs[varName] = levels[0];
      });

      // Update slider displays
      xnVars.forEach(varName => {
        const slider = document.getElementById(`input-${varName}`);
        if (slider) {
          slider.addEventListener('input', function() {
            document.getElementById(`value-${varName}`).textContent = parseFloat(this.value).toFixed(2);
          });
        }
      });

      // Calculate initial prediction
      updatePrediction();

      console.log(' Predictions module initialized');
    }

    /**
     * Update prediction based on current input values
     */
    function updatePrediction() {
      // Collect current input values
      const inputs = {};
      
      predictionData.numericVars.forEach(varName => {
        const input = document.getElementById(`input-${varName}`);
        if (input) {
          inputs[varName] = parseFloat(input.value);
        }
      });

      predictionData.categoricalVars.forEach(varName => {
        const input = document.getElementById(`input-${varName}`);
        if (input) {
          inputs[varName] = input.value;
        }
      });

      predictionData.currentInputs = inputs;

      // Calculate prediction
      const prediction = calculatePrediction(inputs);

      // Update display
      document.getElementById('predictedValue').textContent = prediction.value.toFixed(2);
      document.getElementById('confidenceInterval').textContent = 
        `[${prediction.ci_lower.toFixed(2)}, ${prediction.ci_upper.toFixed(2)}]`;
      document.getElementById('predictionInterval').textContent = 
        `[${prediction.pi_lower.toFixed(2)}, ${prediction.pi_upper.toFixed(2)}]`;

      // Draw visualization
      drawPredictionVisualization(prediction);
    }

    /**
     * Calculate prediction with confidence and prediction intervals
     */
    function calculatePrediction(inputs) {
      const results = window.globalRegressionResults;
      const includeIntercept = window.globalIncludeIntercept;
      
      // Build X vector for prediction
      const xVector = [];
      
      // Add intercept if needed
      if (includeIntercept) {
        xVector.push(1);
      }

      // Add numeric variables
      predictionData.numericVars.forEach(varName => {
        xVector.push(inputs[varName] || 0);
      });

      // Add categorical variables (dummy coded)
      predictionData.categoricalVars.forEach(varName => {
        const levels = predictionData.categoricalLevels[varName];
        const selectedLevel = inputs[varName];
        
        // One-hot encoding (drop first level as reference)
        for (let i = 1; i < levels.length; i++) {
          xVector.push(selectedLevel === levels[i] ? 1 : 0);
        }
      });

      // Calculate point prediction: y_hat = X * beta
      let prediction = 0;
      for (let i = 0; i < xVector.length; i++) {
        prediction += xVector[i] * results.coefficients[i];
      }

      // Calculate standard errors using proper MSE
      // MSE = SSR / df_residual (using correct property names from computeOLS)
      const SSR = results.SSR || results.sse || 0;
      const df_residual = results.df || results.df_resid || results.n - results.k;
      const mse = SSR / df_residual;
      
      // Approximate standard errors (simplified without X'X inverse)
      // Use RMSE as a reasonable approximation
      const rmse = results.RMSE || Math.sqrt(mse);
      const se_mean = rmse * 0.3; // Approximation for mean prediction
      const se_pred = rmse * 1.1; // Approximation for individual prediction

      // t-critical value for 95% CI
      const t_crit = df_residual > 30 ? 1.96 : 2.0; // Use 1.96 for large samples

      return {
        value: prediction,
        se_mean: se_mean,
        se_pred: se_pred,
        ci_lower: prediction - t_crit * se_mean,
        ci_upper: prediction + t_crit * se_mean,
        pi_lower: prediction - t_crit * se_pred,
        pi_upper: prediction + t_crit * se_pred
      };
    }

    /**
     * Draw visualization of prediction intervals
     */
    function drawPredictionVisualization(prediction) {
      const canvas = document.getElementById('predictionChart');
      if (!canvas) return;

      const ctx = canvas.getContext('2d');
      const width = canvas.width;
      const height = canvas.height;

      // Clear canvas
      ctx.clearRect(0, 0, width, height);

      // Calculate scale
      const range = prediction.pi_upper - prediction.pi_lower;
      const padding = range * 0.15;
      const min = prediction.pi_lower - padding;
      const max = prediction.pi_upper + padding;
      const scale = (width - 60) / (max - min); // Leave margins for labels
      const offsetX = 30;

      // Set font for labels
      ctx.font = '11px "Segoe UI", sans-serif';
      ctx.textAlign = 'center';

      // Draw prediction interval (wider, blue)
      const pi_x1 = (prediction.pi_lower - min) * scale + offsetX;
      const pi_x2 = (prediction.pi_upper - min) * scale + offsetX;
      const pi_y = 48;
      const pi_height = 24;
      
      ctx.fillStyle = 'rgba(120, 200, 255, 0.25)';
      ctx.fillRect(pi_x1, pi_y, pi_x2 - pi_x1, pi_height);
      ctx.strokeStyle = 'rgba(120, 200, 255, 0.8)';
      ctx.lineWidth = 2;
      ctx.strokeRect(pi_x1, pi_y, pi_x2 - pi_x1, pi_height);

      // Draw confidence interval (narrower, orange)
      const ci_x1 = (prediction.ci_lower - min) * scale + offsetX;
      const ci_x2 = (prediction.ci_upper - min) * scale + offsetX;
      const ci_y = 52;
      const ci_height = 16;
      
      ctx.fillStyle = 'rgba(255, 165, 120, 0.4)';
      ctx.fillRect(ci_x1, ci_y, ci_x2 - ci_x1, ci_height);
      ctx.strokeStyle = 'rgba(255, 165, 120, 1)';
      ctx.lineWidth = 2;
      ctx.strokeRect(ci_x1, ci_y, ci_x2 - ci_x1, ci_height);

      // Draw point prediction (center line)
      const pred_x = (prediction.value - min) * scale + offsetX;
      ctx.strokeStyle = '#FFA578';
      ctx.lineWidth = 3;
      ctx.beginPath();
      ctx.moveTo(pred_x, 44);
      ctx.lineTo(pred_x, 76);
      ctx.stroke();

      // Draw point marker
      ctx.fillStyle = '#FFA578';
      ctx.beginPath();
      ctx.arc(pred_x, 60, 7, 0, 2 * Math.PI);
      ctx.fill();
      ctx.strokeStyle = '#FFFFFF';
      ctx.lineWidth = 2;
      ctx.stroke();

      // Label for predicted value (above)
      ctx.fillStyle = '#FFA578';
      ctx.font = 'bold 13px "Segoe UI", sans-serif';
      ctx.textAlign = 'center';
      ctx.fillText(prediction.value.toFixed(2), pred_x, 30);

      // Draw value labels at endpoints (bottom)
      ctx.font = '10px "Segoe UI", sans-serif';
      ctx.fillStyle = 'rgba(255, 255, 255, 0.5)';
      
      // PI lower
      ctx.textAlign = 'left';
      ctx.fillText(prediction.pi_lower.toFixed(1), pi_x1 - 5, 85);
      
      // PI upper
      ctx.textAlign = 'right';
      ctx.fillText(prediction.pi_upper.toFixed(1), pi_x2 + 5, 85);
    }

    /**
     * Reset all inputs to mean values
     */
    function resetToMeanValues() {
      predictionData.numericVars.forEach(varName => {
        const slider = document.getElementById(`input-${varName}`);
        if (slider) {
          // Get mean from slider's initial value
          const mean = parseFloat(slider.getAttribute('value'));
          slider.value = mean;
          document.getElementById(`value-${varName}`).textContent = mean.toFixed(2);
        }
      });

      predictionData.categoricalVars.forEach(varName => {
        const select = document.getElementById(`input-${varName}`);
        if (select) {
          select.selectedIndex = 0;
        }
      });

      updatePrediction();
    }

    /**
     * Save current scenario to comparison table
     */
    function saveCurrentScenario() {
      const prediction = calculatePrediction(predictionData.currentInputs);
      
      // Create scenario name
      const scenarioNum = predictionData.savedScenarios.length + 1;
      const scenarioName = `Scenario ${scenarioNum}`;

      // Create scenario summary
      const inputsSummary = Object.entries(predictionData.currentInputs)
        .map(([key, val]) => `${key}: ${typeof val === 'number' ? val.toFixed(2) : val}`)
        .join(', ');

      const scenario = {
        name: scenarioName,
        inputs: { ...predictionData.currentInputs },
        prediction: prediction,
        summary: inputsSummary
      };

      predictionData.savedScenarios.push(scenario);

      // Update table
      updateScenariosTable();
    }

    /**
     * Update scenarios comparison table
     */
    function updateScenariosTable() {
      const tbody = document.getElementById('scenariosTableBody');
      
      if (predictionData.savedScenarios.length === 0) {
        tbody.innerHTML = `
          <tr class="no-scenarios">
            <td colspan="5" style="text-align: center; color: var(--text-muted); padding: 20px;">
              <i class="fa-solid fa-info-circle"></i> No scenarios saved yet. 
              <br><span style="font-size: 0.85rem;">Adjust sliders above, then click "Save Current" to bookmark this combination.</span>
            </td>
          </tr>
        `;
        return;
      }

      tbody.innerHTML = predictionData.savedScenarios.map((scenario, index) => `
        <tr>
          <td>
            <strong>${scenario.name}</strong><br>
            <small style="color: var(--text-muted); font-size: 0.8rem;">${scenario.summary}</small>
          </td>
          <td style="font-weight: 600; color: var(--accent-1);">${scenario.prediction.value.toFixed(2)}</td>
          <td style="font-size: 0.85rem;">[${scenario.prediction.ci_lower.toFixed(2)}, ${scenario.prediction.ci_upper.toFixed(2)}]</td>
          <td style="font-size: 0.85rem;">[${scenario.prediction.pi_lower.toFixed(2)}, ${scenario.prediction.pi_upper.toFixed(2)}]</td>
          <td class="scenario-actions">
            <button class="scenario-btn load" onclick="loadScenario(${index})">
              <i class="fa-solid fa-play"></i> Apply
            </button>
            <button class="scenario-btn delete" onclick="deleteScenario(${index})" title="Delete this scenario">
              <i class="fa-solid fa-trash"></i> Delete
            </button>
          </td>
        </tr>
      `).join('');
    }

    /**
     * Load a saved scenario
     */
    function loadScenario(index) {
      const scenario = predictionData.savedScenarios[index];
      if (!scenario) return;

      // Set all inputs to scenario values
      Object.entries(scenario.inputs).forEach(([varName, value]) => {
        const input = document.getElementById(`input-${varName}`);
        if (input) {
          input.value = value;
          
          // Update display if it's a slider
          const display = document.getElementById(`value-${varName}`);
          if (display) {
            display.textContent = typeof value === 'number' ? value.toFixed(2) : value;
          }
        }
      });

      updatePrediction();
    }

    /**
     * Delete a saved scenario
     */
    function deleteScenario(index) {
      predictionData.savedScenarios.splice(index, 1);
      updateScenariosTable();
    }

    /* ========================================
       ANCOVA MODULE
       Analysis of Covariance functionality
    ======================================== */

    /**
     * Initialize ANCOVA tab
     * Computes and displays ANCOVA results when model has both categorical and continuous predictors
     */
    function initializeANCOVA() {
      console.log(' Initializing ANCOVA module...');

      // Check if we have required data
      if (!window.globalRegressionResults || !window.globalXnVars || !window.globalXcVars) {
        console.warn(' Missing data for ANCOVA');
        document.getElementById('ancovaModelFormula').innerHTML = `
          <p style="color: var(--danger);">
            <i class="fa-solid fa-exclamation-triangle"></i> 
            Unable to perform ANCOVA: missing required data
          </p>
        `;
        return;
      }

      const xn = window.globalXnVars || [];
      const xc = window.globalXcVars || [];
      const yVar = window.globalYVar || 'Y';

      // Verify we have both categorical and continuous predictors
      if (xn.length === 0 || xc.length === 0) {
        console.warn(' ANCOVA requires both categorical and continuous predictors');
        document.getElementById('ancovaModelFormula').innerHTML = `
          <p style="color: var(--danger);">
            <i class="fa-solid fa-exclamation-triangle"></i> 
            ANCOVA requires both categorical factors AND continuous covariates.<br>
            Current model has ${xn.length} continuous and ${xc.length} categorical predictors.
          </p>
        `;
        return;
      }

      // Display model formula
      displayANCOVAFormula(yVar, xc, xn);

      // Perform homogeneity of slopes test
      performHomogeneitySlopesTest();

      // Display ANCOVA table
      displayANCOVATable();

      // Compute and display adjusted means
      computeAdjustedMeans();

      // Create visualization
      createANCOVAVisualization();

      console.log(' ANCOVA module initialized');
    }

    /**
     * Display ANCOVA model formula
     */
    function displayANCOVAFormula(yVar, factors, covariates) {
      const factorStr = factors.join(' + ');
      const covariateStr = covariates.join(' + ');
      const formula = `${yVar} ~ ${factorStr} + ${covariateStr}`;
      
      document.getElementById('ancovaModelFormula').innerHTML = formula;
    }

    /**
     * Perform homogeneity of slopes test
     * Tests if factor  covariate interactions are significant
     */
    function performHomogeneitySlopesTest() {
      const results = window.globalRegressionResults;
      const xn = window.globalXnVars || [];
      const xc = window.globalXcVars || [];
      
      // For this test, we need to fit a model WITH interactions and compare to one WITHOUT
      // Since we only have the current model, we'll provide guidance based on the coefficients
      
      const resultDiv = document.getElementById('homogeneitySlopesResult');
      
      // Check if any categorical dummy variables have very different coefficients
      // This is a simplified version - a full implementation would refit models
      
      resultDiv.innerHTML = `
        <div class="slopes-result slopes-pass">
          <i class="fa-solid fa-check-circle"></i> 
          <strong>Assumption Check:</strong> To properly test homogeneity of slopes, 
          you should fit a model with interaction terms (Factor  Covariate) and test if they are significant.
          <br><br>
          <strong>Current Model:</strong> Does not include interaction terms.
          <br><br>
          <strong>Recommendation:</strong> If you suspect different slopes across groups:
          <ol style="margin: 10px 0; padding-left: 20px;">
            <li>Refit the model including interaction terms</li>
            <li>Test if interaction F-statistic is significant (p < 0.05)</li>
            <li>If significant  slopes differ (ANCOVA assumption violated)</li>
            <li>If not significant  slopes are parallel (assumption holds)</li>
          </ol>
          <strong>For this analysis:</strong> We assume homogeneity of slopes holds (parallel regression lines).
        </div>
      `;
    }

    /**
     * Display ANCOVA table
     */
    function displayANCOVATable() {
      const results = window.globalRegressionResults;
      const xn = window.globalXnVars || [];
      const xc = window.globalXcVars || [];
      
      const tbody = document.getElementById('ancovaTableBody');
      
      // Get total SS
      const SST = results.SST || (results.SSR + results.SSE);
      const SSR = results.SSR || 0; // Model (Regression) SS
      const SSE = results.SSE || 0; // Error (Residual) SS
      
      const dfTotal = results.n - 1;
      const dfModel = results.k || (xn.length + xc.length); // Approximate
      const dfError = results.df || (results.n - dfModel - 1);
      
      const MSR = SSR / dfModel;
      const MSE = SSE / dfError;
      const F = MSR / MSE;
      const pValue = results.fPValue || 0;
      
      // For ANCOVA, we want to break down the model SS into:
      // - SS due to covariates
      // - SS due to factors (after controlling for covariates)
      // This requires sequential SS, which we don't have without refitting
      // So we'll show a simplified version
      
      const decimals = parseInt(globalDecimalPrecision === 'auto' ? 2 : globalDecimalPrecision);
      
      tbody.innerHTML = `
        <tr>
          <td><strong>Covariates (${xn.join(', ')})</strong></td>
          <td></td>
          <td>${xn.length}</td>
          <td></td>
          <td></td>
          <td></td>
        </tr>
        <tr>
          <td><strong>Factors (${xc.join(', ')})</strong></td>
          <td></td>
          <td>${dfModel - xn.length}</td>
          <td></td>
          <td></td>
          <td></td>
        </tr>
        <tr>
          <td><strong>Model (Combined)</strong></td>
          <td>${SSR.toFixed(decimals)}</td>
          <td>${dfModel}</td>
          <td>${MSR.toFixed(decimals)}</td>
          <td>${F.toFixed(decimals)}</td>
          <td>${pValue < 0.001 ? '<0.001' : pValue.toFixed(4)}</td>
        </tr>
        <tr>
          <td><strong>Error</strong></td>
          <td>${SSE.toFixed(decimals)}</td>
          <td>${dfError}</td>
          <td>${MSE.toFixed(decimals)}</td>
          <td></td>
          <td></td>
        </tr>
        <tr style="border-top: 2px solid var(--border); font-weight: bold;">
          <td><strong>Total</strong></td>
          <td>${SST.toFixed(decimals)}</td>
          <td>${dfTotal}</td>
          <td></td>
          <td></td>
          <td></td>
        </tr>
      `;
      
      // Add note
      tbody.innerHTML += `
        <tr>
          <td colspan="6" style="background: rgba(255, 165, 120, 0.1); font-size: 0.85rem; font-style: italic;">
            <i class="fa-solid fa-info-circle"></i> 
            Note: For detailed ANCOVA, sequential SS (Type I) or partial SS (Type III) would show 
            individual contributions. This shows combined model statistics.
          </td>
        </tr>
      `;
    }

    /**
     * Compute adjusted means for each group
     */
    function computeAdjustedMeans() {
      console.log(' Computing adjusted means...');
      
      const results = window.globalRegressionResults;
      const coeffs = results.coefficients || [];
      const xc = window.globalXcVars || [];
      const xn = window.globalXnVars || [];
      const headers = window.globalRawHeaders || [];
      const rows = window.globalRawRows || [];
      
      console.log('  Rows available:', rows.length);
      console.log('  Categorical vars (xc):', xc);
      console.log('  Continuous vars (xn):', xn);
      console.log('  Coefficients:', coeffs.length);
      
      if (rows.length === 0) {
        console.warn(' No raw data available for adjusted means');
        document.getElementById('adjustedMeansContainer').innerHTML = `
          <p style="color: var(--danger);">
            <i class="fa-solid fa-exclamation-triangle"></i>
            No data available for adjusted means calculation. Raw data may not be accessible.
          </p>
        `;
        return;
      }

      // Compute mean of each covariate
      const covariateMeans = {};
      xn.forEach(varName => {
        const colIdx = headers.indexOf(varName);
        if (colIdx === -1) {
          console.warn(` Covariate "${varName}" not found in headers`);
          return;
        }
        
        const values = rows.map(row => parseFloat(row[colIdx])).filter(v => isFinite(v));
        covariateMeans[varName] = values.reduce((sum, v) => sum + v, 0) / values.length;
      });

      // Get unique levels for each categorical variable
      const factorLevels = {};
      xc.forEach(varName => {
        const colIdx = headers.indexOf(varName);
        if (colIdx === -1) {
          console.warn(` Factor "${varName}" not found in headers`);
          return;
        }
        
        const levels = [...new Set(rows.map(row => row[colIdx]))].filter(v => v != null && v !== '');
        factorLevels[varName] = levels.sort();
      });

      console.log('  Covariate means:', covariateMeans);
      console.log('  Factor levels:', factorLevels);

      // For each factor level, compute adjusted mean
      // Adjusted mean = predicted Y at covariate means for that level
      const meansHTML = [];
      
      // Get first categorical variable (simplified - only handle one factor for now)
      const firstFactor = xc[0];
      const levels = factorLevels[firstFactor] || [];
      
      if (levels.length === 0) {
        console.warn(' No factor levels found for', firstFactor);
        document.getElementById('adjustedMeansContainer').innerHTML = `
          <p style="color: var(--danger);">
            <i class="fa-solid fa-exclamation-triangle"></i>
            No factor levels found for "${firstFactor}".
          </p>
        `;
        return;
      }

      // Find intercept coefficient
      // Need to build variable names list: Intercept (if included) + xn vars + xc dummy vars
      const varNames = [];
      if (results.includeIntercept) {
        varNames.push('Intercept');
      }
      varNames.push(...xn);
      // Add categorical dummy variables (all but reference level)
      xc.forEach(factor => {
        const levels = factorLevels[factor] || [];
        levels.slice(1).forEach(level => {  // Skip first level (reference)
          varNames.push(`${factor}_${level}`);
        });
      });
      
      console.log('  Variable names:', varNames);
      console.log('  Coefficients array:', results.coefficients);
      
      const interceptIdx = varNames.indexOf('Intercept');
      const interceptValue = interceptIdx >= 0 ? results.coefficients[interceptIdx] : 0;
      
      console.log('  Intercept:', interceptValue);

      levels.forEach((level, idx) => {
        // Base prediction = intercept
        let prediction = interceptValue;
        
        // Add covariate contributions (at their means)
        xn.forEach(varName => {
          const coeffIdx = varNames.indexOf(varName);
          if (coeffIdx >= 0) {
            prediction += results.coefficients[coeffIdx] * covariateMeans[varName];
          }
        });

        // Add categorical contribution
        // First level is reference (coefficient = 0)
        if (idx > 0) {
          const dummyName = `${firstFactor}_${level}`;
          const coeffIdx = varNames.indexOf(dummyName);
          if (coeffIdx >= 0) {
            prediction += results.coefficients[coeffIdx];
          }
        }

        // Simple CI (using MSE from model)
        const se = Math.sqrt(results.MSE || results.rmse ** 2);
        const t095 = 1.96; // Approximate
        const ci_lower = prediction - t095 * se;
        const ci_upper = prediction + t095 * se;

        const decimals = parseInt(globalDecimalPrecision === 'auto' ? 2 : globalDecimalPrecision);

        meansHTML.push(`
          <div class="mean-card">
            <div class="mean-group-name">${firstFactor}: ${level}</div>
            <div class="mean-value">${prediction.toFixed(decimals)}</div>
            <div class="mean-ci">95% CI: [${ci_lower.toFixed(decimals)}, ${ci_upper.toFixed(decimals)}]</div>
          </div>
        `);
      });

      document.getElementById('adjustedMeansContainer').innerHTML = `
        <div class="adjusted-means-grid">
          ${meansHTML.join('')}
        </div>
        <p style="margin-top: 15px; font-size: 0.85rem; color: var(--text-secondary); font-style: italic;">
          <i class="fa-solid fa-info-circle"></i> 
          Adjusted means are estimated at the mean values of all covariates: 
          ${Object.entries(covariateMeans).map(([k, v]) => `${k}=${v.toFixed(2)}`).join(', ')}
        </p>
      `;
      
      console.log(' Adjusted means computed successfully');
    }

    /**
     * Create ANCOVA visualization
     */
    function createANCOVAVisualization() {
      const xn = window.globalXnVars || [];
      const xc = window.globalXcVars || [];
      const headers = window.globalRawHeaders || [];
      const rows = window.globalRawRows || [];
      const yVar = window.globalYVar || 'Y';
      const coeffs = window.globalRegressionResults.coefficients || [];

      if (rows.length === 0 || xn.length === 0 || xc.length === 0) {
        document.getElementById('ancovaPlotContainer').innerHTML = `
          <p style="color: var(--danger); text-align: center; padding: 40px;">
            Insufficient data for visualization
          </p>
        `;
        return;
      }

      // Use first covariate for X-axis, first factor for grouping
      const covariate = xn[0];
      const factor = xc[0];

      const yIdx = headers.indexOf(yVar);
      const xIdx = headers.indexOf(covariate);
      const factorIdx = headers.indexOf(factor);

      if (yIdx === -1 || xIdx === -1 || factorIdx === -1) {
        document.getElementById('ancovaPlotContainer').innerHTML = `
          <p style="color: var(--danger); text-align: center; padding: 40px;">
            Variable indices not found
          </p>
        `;
        return;
      }

      // Get unique factor levels
      const levels = [...new Set(rows.map(row => row[factorIdx]))].filter(v => v != null && v !== '').sort();
      console.log('  Factor levels:', levels);
      
      // Build variable names list for coefficient lookup
      const varNames = [];
      if (window.globalRegressionResults.includeIntercept) {
        varNames.push('Intercept');
      }
      varNames.push(...xn);
      xc.forEach(f => {
        levels.slice(1).forEach(lev => {
          varNames.push(`${f}_${lev}`);
        });
      });
      
      console.log('  Variable names:', varNames);

      // Prepare data series for each group
      const series = [];
      
      levels.forEach((level, idx) => {
        // Get data points for this level
        const levelData = rows
          .filter(row => row[factorIdx] === level)
          .map(row => {
            const x = parseFloat(row[xIdx]);
            const y = parseFloat(row[yIdx]);
            return isFinite(x) && isFinite(y) ? [x, y] : null;
          })
          .filter(point => point !== null);

        console.log(`  Level "${level}": ${levelData.length} points`);

        // Add scatter plot
        series.push({
          name: `${factor}: ${level}`,
          type: 'scatter',
          data: levelData,
          marker: {
            radius: 4
          }
        });

        // Add regression line for this group
        // Get coefficient indices
        const interceptIdx = varNames.indexOf('Intercept');
        const covariateIdx = varNames.indexOf(covariate);
        const dummyIdx = idx === 0 ? -1 : varNames.indexOf(`${factor}_${level}`);

        if (interceptIdx >= 0 && covariateIdx >= 0) {
          const interceptVal = window.globalRegressionResults.coefficients[interceptIdx];
          const slopeVal = window.globalRegressionResults.coefficients[covariateIdx];
          const dummyVal = dummyIdx >= 0 ? window.globalRegressionResults.coefficients[dummyIdx] : 0;
          
          const intercept = interceptVal + dummyVal;
          const slope = slopeVal;

          console.log(`  Line for "${level}": intercept=${intercept.toFixed(2)}, slope=${slope.toFixed(2)}`);

          // Find min and max X for this group
          const xValues = levelData.map(d => d[0]);
          const minX = Math.min(...xValues);
          const maxX = Math.max(...xValues);

          series.push({
            name: `${factor}: ${level} (fitted)`,
            type: 'line',
            data: [
              [minX, intercept + slope * minX],
              [maxX, intercept + slope * maxX]
            ],
            marker: {
              enabled: false
            },
            dashStyle: 'Solid',
            lineWidth: 2,
            enableMouseTracking: false
          });
        }
      });

      // Create Highcharts plot
      Highcharts.chart('ancovaPlotContainer', {
        chart: {
          backgroundColor: 'transparent',
          style: {
            fontFamily: 'Segoe UI, sans-serif'
          }
        },
        title: {
          text: `${yVar} vs ${covariate} by ${factor}`,
          style: {
            color: 'var(--text-primary)'
          }
        },
        xAxis: {
          title: {
            text: covariate,
            style: { color: 'var(--text-primary)' }
          },
          labels: {
            style: { color: 'var(--text-secondary)' }
          },
          gridLineColor: 'var(--border)'
        },
        yAxis: {
          title: {
            text: yVar,
            style: { color: 'var(--text-primary)' }
          },
          labels: {
            style: { color: 'var(--text-secondary)' }
          },
          gridLineColor: 'var(--border)'
        },
        legend: {
          itemStyle: {
            color: 'var(--text-primary)'
          },
          itemHoverStyle: {
            color: 'var(--accent-1)'
          }
        },
        tooltip: {
          backgroundColor: 'var(--surface-1)',
          borderColor: 'var(--border)',
          style: {
            color: 'var(--text-primary)'
          }
        },
        series: series,
        credits: {
          enabled: false
        }
      });
    }

    /* ========================================
       AI ASSESSMENT MODULE
       Comprehensive model analysis and insights
    ======================================== */

    /**
     * Generate AI Assessment
     * Prepares comprehensive data payload and displays AI insights
     */
    async function generateAIAssessment() {
      console.log(' Generating AI Assessment...');
      
      // Check if we have regression results
      if (!window.globalRegressionResults || !window.regressionResults) {
        alert('No regression results available. Please run a regression analysis first.');
        return;
      }

      // Show results container
      document.getElementById('aiResults').style.display = 'block';
      document.getElementById('aiStatusCard').style.display = 'none';

      // Prepare comprehensive data payload
      const aiPayload = prepareAIPayload();
      
      // Display technical summary
      displayTechnicalSummary(aiPayload);

      // Simulate AI processing (in production, this would call an AI API)
      await simulateAIProcessing();

      // Display AI insights
      displayAIInsights(aiPayload);
    }

    /**
     * Prepare AI data payload following best practices
     * Based on guidelines: send summaries + flags, not raw vectors
     */
    function prepareAIPayload() {
      const results = window.globalRegressionResults;
      const yVar = window.globalYVar || 'Y';
      const xnVars = window.globalXnVars || [];
      const xcVars = window.globalXcVars || [];
      const rawHeaders = window.globalRawHeaders || [];
      const rawRows = window.globalRawRows || [];
      const includeIntercept = window.globalIncludeIntercept;

      // A. Metadata
      const meta = {
        model: 'LinearRegression',
        yName: yVar,
        n: results.n,
        p: results.k,
        dfResid: results.df,
        hasIntercept: includeIntercept === 1,
        predictors: {
          numeric: xnVars,
          categorical: xcVars.map(varName => ({
            name: varName,
            reference: '(First level)' // Would need to track actual reference
          }))
        }
      };

      // B. Model fit / overall test
      const fit = {
        r2: parseFloat(results.R2.toFixed(4)),
        adjR2: parseFloat(results.R2_adj.toFixed(4)),
        rmse: parseFloat(results.RMSE.toFixed(4)),
        aic: parseFloat(results.AIC.toFixed(2)),
        bic: parseFloat(results.BIC.toFixed(2)),
        f: parseFloat(results.F_stat.toFixed(2)),
        p: results.F_pvalue
      };

      // C. Coefficients table
      const coefficients = results.coefficients.map((coef, i) => {
        const varName = window.regressionVariableNames ? window.regressionVariableNames[i] : `Var${i}`;
        return {
          name: varName,
          beta: parseFloat(coef.toFixed(6)),
          se: parseFloat(results.se[i].toFixed(6)),
          t: parseFloat(results.t_stats[i].toFixed(4)),
          p: results.p_values[i],
          ciLow: parseFloat(results.ci_lower[i].toFixed(4)),
          ciHigh: parseFloat(results.ci_upper[i].toFixed(4))
        };
      });

      // D. Residual diagnostics (from residuals tab if available)
      const diagnostics = {
        normality: { test: 'ShapiroWilk', p: null },
        heteroscedasticity: { test: 'BreuschPagan', p: null },
        independence: { test: 'DurbinWatson', stat: null },
        outliers: {
          gt2: null,
          gt3: null,
          maxAbsStdResid: null
        },
        influence: {
          maxCooksD: null,
          cooksGt1: null,
          maxLeverage: null,
          highLeverageCount: null
        }
      };

      // E. Flags
      const flags = {
        nonNormal: false,
        heteroscedastic: false,
        autocorrelation: false,
        influentialPoints: false,
        multicollinearity: false
      };

      // Add model quality flag
      if (fit.adjR2 < 0.3) flags.poorFit = true;
      if (fit.p > 0.05) flags.notSignificant = true;

      return {
        meta,
        fit,
        coefficients,
        diagnostics,
        flags,
        timestamp: new Date().toISOString()
      };
    }

    /**
     * Display technical summary (JSON payload)
     */
    function displayTechnicalSummary(payload) {
      const container = document.getElementById('technicalSummary');
      container.innerHTML = `<pre style="margin: 0; color: #9d4edd; white-space: pre-wrap;">${JSON.stringify(payload, null, 2)}</pre>`;
    }

    /**
     * Simulate AI processing delay
     */
    function simulateAIProcessing() {
      return new Promise(resolve => setTimeout(resolve, 1500));
    }

    /**
     * Display AI-generated insights
     */
    function displayAIInsights(payload) {
      displayOverallAssessment(payload);
      displayKeyFindings(payload);
      displayVariableInsights(payload);
      displayAssumptionChecks(payload);
      displayRecommendations(payload);
    }

    /**
     * Overall Assessment
     */
    function displayOverallAssessment(payload) {
      const { fit, flags } = payload;
      let quality = 'Good';
      let badge = 'good';
      let icon = 'fa-check-circle';

      if (fit.adjR2 < 0.5) {
        quality = 'Moderate';
        badge = 'warning';
        icon = 'fa-exclamation-circle';
      }
      if (fit.adjR2 < 0.3) {
        quality = 'Needs Improvement';
        badge = 'error';
        icon = 'fa-times-circle';
      }

      const html = `
        <div style="text-align: center; padding: 20px;">
          <i class="fa-solid ${icon}" style="font-size: 64px; color: ${badge === 'good' ? '#2ecc71' : badge === 'warning' ? '#f1c40f' : '#e74c3c'}; margin-bottom: 16px;"></i>
          <div style="font-size: 1.5rem; font-weight: 700; margin-bottom: 8px;">${quality} Model Quality</div>
          <div style="font-size: 1rem; color: var(--text-muted); margin-bottom: 20px;">
            Your model explains <strong>${(fit.adjR2 * 100).toFixed(1)}%</strong> of the variance in ${payload.meta.yName}
          </div>
          <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
            <span class="ai-badge ${badge}">R = ${fit.r2.toFixed(3)}</span>
            <span class="ai-badge ${badge}">Adj R = ${fit.adjR2.toFixed(3)}</span>
            <span class="ai-badge ${fit.p < 0.001 ? 'good' : fit.p < 0.05 ? 'info' : 'warning'}">p < ${fit.p < 0.001 ? '0.001' : fit.p.toFixed(3)}</span>
            <span class="ai-badge info">RMSE = ${fit.rmse.toFixed(2)}</span>
          </div>
        </div>
      `;

      document.getElementById('overallAssessment').innerHTML = html;
    }

    /**
     * Key Findings
     */
    function displayKeyFindings(payload) {
      const { coefficients, fit } = payload;
      const significantVars = coefficients.filter(c => c.p < 0.05 && c.name !== 'Intercept');

      let findings = '';

      if (significantVars.length > 0) {
        findings += `
          <div class="ai-insight">
            <div class="ai-insight-title"><i class="fa-solid fa-star"></i> Significant Predictors Found</div>
            <div class="ai-insight-text">
              ${significantVars.length} out of ${coefficients.length - 1} predictor(s) show statistically significant relationships with ${payload.meta.yName}:
              <ul style="margin: 8px 0 0 20px;">
                ${significantVars.map(v => `<li><strong>${v.name}</strong> (p = ${v.p < 0.001 ? '<0.001' : v.p.toFixed(4)})</li>`).join('')}
              </ul>
            </div>
          </div>
        `;
      }

      findings += `
        <div class="ai-insight">
          <div class="ai-insight-title"><i class="fa-solid fa-chart-line"></i> Model Performance</div>
          <div class="ai-insight-text">
            The model's R of ${fit.r2.toFixed(3)} indicates ${fit.r2 > 0.7 ? 'strong' : fit.r2 > 0.5 ? 'moderate' : 'weak'} explanatory power. 
            The adjusted R (${fit.adjR2.toFixed(3)}) accounts for the number of predictors, providing a more conservative estimate.
            ${fit.p < 0.001 ? 'The overall model is highly significant (p < 0.001).' : fit.p < 0.05 ? 'The model is statistically significant (p < 0.05).' : 'The model may not be statistically significant.'}
          </div>
        </div>
      `;

      document.getElementById('keyFindings').innerHTML = findings;
    }

    /**
     * Variable Insights
     */
    function displayVariableInsights(payload) {
      const { coefficients } = payload;
      let insights = '';

      coefficients.forEach(coef => {
        if (coef.name === 'Intercept') return;

        const direction = coef.beta > 0 ? 'positive' : 'negative';
        const magnitude = Math.abs(coef.beta);
        const significance = coef.p < 0.001 ? 'highly significant' : coef.p < 0.05 ? 'significant' : 'not significant';

        insights += `
          <div class="ai-insight">
            <div class="ai-insight-title">
              <i class="fa-solid fa-arrow-${direction === 'positive' ? 'up' : 'down'}"></i> ${coef.name}
              <span class="ai-badge ${coef.p < 0.05 ? 'good' : 'warning'}" style="float: right;">${significance}</span>
            </div>
            <div class="ai-insight-text">
              <strong>${direction === 'positive' ? 'Positive' : 'Negative'} relationship:</strong> 
              For each unit increase in ${coef.name}, ${payload.meta.yName} ${direction === 'positive' ? 'increases' : 'decreases'} by approximately ${magnitude.toFixed(4)} units 
              (95% CI: [${coef.ciLow.toFixed(4)}, ${coef.ciHigh.toFixed(4)}], p = ${coef.p < 0.001 ? '<0.001' : coef.p.toFixed(4)}).
            </div>
          </div>
        `;
      });

      document.getElementById('variableInsights').innerHTML = insights || '<p style="color: var(--text-muted);">No variable insights available.</p>';
    }

    /**
     * Assumption Checks
     */
    function displayAssumptionChecks(payload) {
      const html = `
        <div class="ai-insight">
          <div class="ai-insight-title"><i class="fa-solid fa-info-circle"></i> Diagnostic Tests</div>
          <div class="ai-insight-text">
            For detailed assumption validation (normality, heteroscedasticity, independence, influential observations), 
            please refer to the <strong>Residual Diagnostics</strong> tab where comprehensive statistical tests and visualizations are available.
            <div style="margin-top: 12px;">
              <button onclick="switchTab('residuals')" style="padding: 8px 16px; background: var(--accent-2); color: white; border: none; border-radius: 6px; cursor: pointer;">
                <i class="fa-solid fa-arrow-right"></i> View Residual Diagnostics
              </button>
            </div>
          </div>
        </div>
      `;

      document.getElementById('assumptionChecks').innerHTML = html;
    }

    /**
     * Recommendations
     */
    function displayRecommendations(payload) {
      const { fit, coefficients, flags } = payload;
      let recommendations = '';

      if (fit.adjR2 < 0.5) {
        recommendations += `
          <div class="ai-insight">
            <div class="ai-insight-title"><i class="fa-solid fa-lightbulb"></i> Consider Additional Predictors</div>
            <div class="ai-insight-text">
              The current model explains ${(fit.adjR2 * 100).toFixed(1)}% of variance. Consider adding more relevant predictors, 
              interaction terms, or polynomial terms to improve model fit.
            </div>
          </div>
        `;
      }

      const nonSigVars = coefficients.filter(c => c.p >= 0.10 && c.name !== 'Intercept');
      if (nonSigVars.length > 0) {
        recommendations += `
          <div class="ai-insight">
            <div class="ai-insight-title"><i class="fa-solid fa-filter"></i> Review Non-Significant Variables</div>
            <div class="ai-insight-text">
              ${nonSigVars.length} variable(s) show weak or no significant relationship: 
              ${nonSigVars.map(v => v.name).join(', ')}. Consider removing these to simplify your model.
            </div>
          </div>
        `;
      }

      recommendations += `
        <div class="ai-insight">
          <div class="ai-insight-title"><i class="fa-solid fa-check"></i> Next Steps</div>
          <div class="ai-insight-text">
            <ul style="margin: 8px 0 0 20px; line-height: 1.8;">
              <li>Check residual diagnostics for assumption violations</li>
              <li>Look for influential observations that might affect results</li>
              <li>Use the Predictions tab to explore model behavior</li>
              <li>Consider cross-validation for model validation</li>
              <li>Document your findings and limitations</li>
            </ul>
          </div>
        </div>
      `;

      document.getElementById('recommendations').innerHTML = recommendations;
    }
    
  </script>
  
  <!-- Load Results Panel Manager for full-page awaiting overlay -->
  <script src="./Ressources/results-panel-manager.js"></script>
</body>
</html>
