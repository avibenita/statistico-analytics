<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <title id="page-title">Linear Regression Analysis</title>
  <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet"/>
  
  <!-- Regression computation library -->
  <script src="../../../src/shared/js/core/regression-compute.js"></script>

  <style>
    :root{
      --surface-0:#0c1624;
      --surface-1:#1a1f2e;
      --surface-2:#242938;
      --border:#2d3748;
      --accent-1:rgb(255,165,120);
      --accent-2:rgb(120,200,255);
      --text-primary:#fff;
      --text-secondary:rgba(255,255,255,0.8);
      --text-muted:rgba(255,255,255,0.6);
      --panel-radius:10px;
      --panel-shadow:0 4px 20px rgba(0,0,0,.4);
      --header-color:var(--accent-1);
    }

    html,body{height:100%;margin:0;padding:0;}
    body{background:var(--surface-0);color:var(--text-primary);font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;overflow-x:hidden;}

    .wrap{ display:flex; justify-content:center; padding:clamp(3px,1vh,8px) clamp(6px,2vh,12px) 19px; }
    .card{
      width:min(1600px,99%); background:var(--surface-1);
      min-height: 740px;
      border-radius:var(--panel-radius); box-shadow:var(--panel-shadow);
      border:1px solid var(--border); overflow:visible;
      display:flex; flex-direction:column;
    }
    .card-head{
      display:flex; align-items:center; justify-content:space-between;
      background:transparent; color:var(--header-color);
      padding:6px 12px; font-weight:600; font-size:1rem; letter-spacing:.3px;
    }
    .card-body{ padding:8px; flex:1; min-height:0; overflow:visible; }

    /* Dropdown Navigation Styles */
    .dropdown-container{ position:relative; }
    .dropdown-content{
      display:none; position:absolute; top:100%; right:0; min-width:260px; z-index:1000;
      background:var(--surface-1); border:1px solid var(--border); border-radius:8px;
      box-shadow:var(--panel-shadow); padding:8px 0; margin-top:4px;
      opacity: 0;
      transform: scaleY(0.95);
      transform-origin: top;
      transition: all 0.25s ease-in-out;
    }
    .dropdown-content.show{ display:block; opacity:1; transform:scaleY(1); }

    .dropdown-btn{
      position:relative; transition:.3s; cursor:pointer; border-radius:8px;
      background:linear-gradient(145deg,#4a5568,#2d3748); border:1px solid #4a5568;
      color:#e2e8f0; padding:8px 12px; font-size:12px; font-weight:600;
      box-shadow:0 4px 8px rgba(0,0,0,.3), inset 0 1px 0 rgba(255,255,255,.1), inset 0 -1px 0 rgba(0,0,0,.2);
    }
    .dropdown-btn:hover{ transform:translateY(-1px); }
    .dropdown-arrow{ display:inline-block; margin-left:8px; transition:transform .3s }
    .dropdown-btn.open .dropdown-arrow{ transform:rotate(180deg) }

    .dropdown-content a {
      padding: 10px 16px;
      display: flex;
      align-items: center;
      text-decoration: none;
      color: var(--text-secondary);
      transition: all 0.25s ease-in-out;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    .dropdown-content a:last-child {
      border-bottom: none;
    }
    .dropdown-content a:hover {
      background-color: var(--accent-1);
      color: var(--surface-0);
      transform: translateX(2px);
    }
    .dropdown-content a.selected {
      background-color: var(--accent-1);
      color: var(--surface-0);
      font-weight: bold;
    }

    .dropdown-separator {
      height: 1px;
      background: rgba(255, 255, 255, 0.2);
      margin: 4px 0;
      pointer-events: none;
    }

    /* Stats Container */
    .stats-container {
      display: flex;
      gap: 8px;
      justify-content: space-between;
      margin-bottom: 8px;
      flex-wrap: wrap;
    }

    .stat-panel {
      flex: 1;
      min-width: 200px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid var(--border);
      border-radius: 4px;
      padding: 0;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
    }

    .stat-panel-heading {
      background: linear-gradient(135deg, rgba(0, 51, 102, 0.8), rgba(0, 102, 204, 0.6));
      color: #ffffff;
      padding: 4px 8px;
      border-radius: 4px 4px 0 0;
      font-weight: 700;
      font-size: 0.7rem;
      text-align: center;
      text-transform: uppercase;
      letter-spacing: 0.3px;
      border-bottom: 1px solid var(--accent-1);
    }

    .stat-panel-body {
      padding: 5px 8px;
    }

    .stat-field {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 2px 0;
      padding: 1px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.03);
    }

    .stat-field:last-child {
      border-bottom: none;
    }

    .stat-label {
      font-weight: 600;
      color: var(--text-secondary);
      font-size: 0.7rem;
    }

    .stat-value {
      background: linear-gradient(135deg, rgba(120, 200, 255, 0.15), rgba(120, 200, 255, 0.05));
      border: 1px solid rgba(120, 200, 255, 0.3);
      border-radius: 4px;
      padding: 2px 6px;
      min-width: 60px;
      text-align: center;
      color: var(--accent-2);
      font-weight: 700;
      font-size: 0.75rem;
    }

    .stat-note {
      margin-top: 12px;
      padding: 8px;
      background: rgba(255, 165, 120, 0.1);
      border-left: 3px solid var(--accent-1);
      border-radius: 4px;
      color: var(--text-muted);
      font-size: 0.85rem;
      font-style: italic;
    }

    /* Table Container */
    .table-container {
      width: 100%;
      margin: 20px auto 0;
      overflow-x: auto;
      overflow-y: auto;
      max-height: calc(100vh - 50px);
      border: 0px solid var(--border) !important;
      border-radius: 0px;
      box-shadow: 0px 0px 0px transparent;
    }

    /* Modern scrollbar styling */
    .table-container::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    .table-container::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 4px;
    }

    .table-container::-webkit-scrollbar-thumb {
      background: linear-gradient(135deg, var(--accent-1), rgba(255, 165, 120, 0.7));
      border-radius: 4px;
      border: 0px solid rgba(255, 255, 255, 0.1);
      transition: all 0.3s ease;
    }

    .table-container::-webkit-scrollbar-thumb:hover {
      background: linear-gradient(135deg, rgba(255, 165, 120, 0.9), var(--accent-1));
      box-shadow: 0 0 8px rgba(255, 165, 120, 0.4);
    }

    .table-container::-webkit-scrollbar-corner {
      background: rgba(255, 255, 255, 0.05);
    }

    /* Firefox scrollbar styling */
    .table-container {
      scrollbar-width: thin;
      scrollbar-color: var(--accent-1) rgba(255, 255, 255, 0.05);
    }

    .regression-table {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
      border: 0px solid rgba(255, 255, 255, 0.3);
    }

    .regression-table th {
      background: linear-gradient(135deg, rgba(0, 51, 102, 0.9), rgba(0, 102, 204, 0.7));
      color: #fff;
      padding: 5px 4px;
      position: sticky;
      top: 0;
      z-index: 2;
      font-weight: 700;
      text-align: center;
      white-space: nowrap;
      border: 1px solid rgba(255, 255, 255, 0.3);
      font-size: 0.65rem;
      text-transform: uppercase;
      letter-spacing: 0.2px;
      min-width: 60px;
    }

    .regression-table th:first-child {
      position: sticky;
      left: 0;
      z-index: 3;
      text-align: left;
      min-width: 90px;
      max-width: 180px;
    }

    .regression-table td {
      background: rgba(255, 255, 255, 0.04);
      color: var(--text-primary);
      border: 1px solid rgba(255, 255, 255, 0.15);
      padding: 4px 6px;
      text-align: center;
      font-size: 0.7rem;
      white-space: nowrap;
      min-width: 60px;
    }

    .regression-table td:first-child {
      text-align: left;
      font-weight: 600;
      white-space: nowrap;
      position: sticky;
      left: 0;
      z-index: 1;
      background: rgba(255, 255, 255, 0.06);
      color: var(--accent-1);
      min-width: 90px;
      max-width: 180px;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    /* Variable type colors - More vibrant and distinct */
    .var-intercept {
      color: #fbbf24 !important; /* Bright Amber for intercept */
      font-weight: 700 !important;
      text-shadow: 0 0 8px rgba(251, 191, 36, 0.4);
    }
    
    .var-numeric {
      color: #3b82f6 !important; /* Bright Blue for numeric */
      font-weight: 600 !important;
    }
    
    .var-categorical {
      color: #f472b6 !important; /* Bright Pink/Magenta for categorical */
      font-weight: 600 !important;
      text-shadow: 0 0 6px rgba(244, 114, 182, 0.3);
    }

    .regression-table tbody tr:hover {
      background-color: rgba(255, 221, 87, 0.15);
    }

    .regression-table tbody tr:nth-child(even) {
      background-color: rgba(240, 248, 255, 0.03);
    }

    /* Section separator rows */
    .regression-table tbody .section-header {
      background: transparent !important;
    }

    .regression-table tbody .section-header td {
      padding: 6px 10px !important;
      font-weight: 500 !important;
      font-size: 0.55rem !important;
      text-transform: uppercase !important;
      letter-spacing: 0.5px !important;
      color: rgba(255, 255, 255, 0.5) !important;
      text-align: left !important;
      background: transparent !important;
      position: relative !important;
      z-index: 0 !important;
      border-left: 0 !important;
      border-right: 0 !important;
      border-bottom: 0 !important;
      border-top: 1px solid rgba(255, 255, 255, 0.1) !important;
    }

    @media screen and (max-width: 768px) {
      .stats-container {
        flex-direction: column;
      }
      .stat-panel {
        min-width: 100%;
      }
    }
    
    /* Regression Equation Section */
    .equation-section {
      margin: 20px auto 0;
      padding: 20px;
      background: var(--surface-2);
      border: 2px solid var(--accent-1);
      border-radius: 8px;
      box-shadow: 2px 4px 10px rgba(0, 0, 0, 0.3);
    }
    
    .equation-title {
      color: var(--accent-1);
      font-size: 16px;
      font-weight: 700;
      margin-bottom: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .equation-formula {
      font-family: 'Courier New', monospace;
      font-size: 16px;
      color: var(--text-primary);
      background: var(--surface-0);
      padding: 16px;
      border-radius: 6px;
      border-left: 4px solid var(--accent-2);
      line-height: 1.8;
      overflow-x: auto;
      white-space: nowrap;
    }
    
    .equation-formula .y-var {
      color: var(--accent-1);
      font-weight: 900;
      font-size: 20px;
      text-transform: uppercase;
      letter-spacing: 1px;
      text-shadow: 0 0 10px rgba(255, 165, 120, 0.5);
      padding: 0 4px;
    }
    
    .equation-formula .var {
      color: var(--accent-1);
      font-weight: 600;
    }
    
    .equation-formula .coef {
      color: var(--accent-2);
      font-weight: 700;
    }
    
    /* Toggle Equation Button */
    .toggle-equation-btn {
      background: var(--surface-2);
      border: 1px solid var(--accent-1);
      color: var(--accent-1);
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      margin: 16px auto 0;
      display: block;
      transition: all 0.3s ease;
    }
    
    .toggle-equation-btn:hover {
      background: var(--accent-1);
      color: var(--surface-0);
      box-shadow: 0 4px 12px rgba(255, 165, 120, 0.3);
    }
    
    .toggle-equation-btn i {
      margin-right: 6px;
      transition: transform 0.3s ease;
    }
    
    .toggle-equation-btn.active i {
      transform: rotate(180deg);
    }
    
    /* AI Interpret Button Styling */
    .ai-interpret-btn {
      position: relative;
      transition: .3s;
      cursor: pointer;
      border-radius: 8px;
      background: linear-gradient(145deg, #7c3aed, #a855f7) !important;
      border: 1px solid #9333ea !important;
      color: #ffffff !important;
      padding: 8px 12px;
      font-size: 12px;
      font-weight: 600;
      box-shadow: 0 4px 8px rgba(124, 58, 237, 0.3);
      margin-left: 8px;
    }
    
    .ai-interpret-btn:hover {
      background: linear-gradient(145deg, #6d28d9, #9333ea) !important;
      transform: translateY(-1px);
      box-shadow: 0 6px 12px rgba(124, 58, 237, 0.4);
    }
    
    .ai-interpret-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }
    
    .ai-interpret-btn i {
      margin-right: 6px;
    }
    
    /* Loading overlay */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(17, 24, 39, 0.95);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      transition: opacity 0.3s ease;
    }
    
    .loading-overlay.hidden {
      opacity: 0;
      pointer-events: none;
    }
    
    .loading-spinner {
      width: 60px;
      height: 60px;
      border: 4px solid rgba(59, 130, 246, 0.2);
      border-top-color: #3b82f6;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .loading-text {
      margin-top: 20px;
      color: #e5e7eb;
      font-size: 1rem;
      font-weight: 500;
    }
    
    /* Tab Navigation */
    .tab-navigation {
      display: flex;
      gap: 2px;
      background: #808080;
      padding: 3px 3px 0 3px;
      border-bottom: none;
      overflow-x: auto;
      scrollbar-width: thin;
    }
    
    .tab-button {
      padding: 6px 20px 8px 20px;
      background: #C0C0C0;
      border: none;
      color: #000000;
      font-size: 13px;
      font-weight: 400;
      cursor: pointer;
      border-radius: 3px 3px 0 0;
      transition: none;
      position: relative;
      box-shadow: 
        2px 0 0 0 #FFFFFF inset,
        0 2px 0 0 #FFFFFF inset,
        -1px 0 0 0 #404040 inset,
        0 -1px 0 0 #404040 inset;
      white-space: nowrap;
      display: flex;
      align-items: center;
      gap: 10px;
      position: relative;
      box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.2);
    }
    
    .tab-button::before {
      content: '';
      position: absolute;
      bottom: -1px;
      left: 0;
      right: 0;
      height: 0;
      background: transparent;
      transition: none;
    }
    
    .tab-button:hover {
      background: #D4D4D4;
    }
    
    .tab-button.active {
      background: var(--surface-1);
      color: var(--text-primary);
      font-weight: 600;
      z-index: 10;
      padding-bottom: 10px;
      margin-bottom: -2px;
      box-shadow: 
        3px 0 0 0 #FFFFFF inset,
        0 3px 0 0 #FFFFFF inset,
        -2px 0 0 0 #404040 inset,
        0 -2px 0 0 #404040 inset,
        0 1px 0 0 var(--surface-1);
    }
    
    .tab-button.active::before {
      background: transparent;
    }
    
    .tab-button i {
      font-size: 14px;
      margin-right: 6px;
      transition: none;
    }
    
    .tab-button.active i {
      transform: none;
    }
    
    .tab-content {
      display: none;
      animation: fadeIn 0.3s ease;
    }
    
    .tab-content.active {
      display: block;
    }
    
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* ===== PREDICTIONS MODULE STYLES ===== */
    .predictions-container {
      padding: 16px;
      max-width: 1400px;
      margin: 0 auto;
    }

    .prediction-header {
      text-align: center;
      margin-bottom: 24px;
      padding: 16px;
      background: linear-gradient(135deg, rgba(120, 200, 255, 0.1), rgba(255, 165, 120, 0.1));
      border-radius: 8px;
      border: 1px solid rgba(120, 200, 255, 0.2);
    }

    .prediction-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--accent-2);
      margin-bottom: 8px;
    }

    .prediction-subtitle {
      font-size: 0.9rem;
      color: var(--text-muted);
    }

    .prediction-layout {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 24px;
    }

    @media (max-width: 1024px) {
      .prediction-layout {
        grid-template-columns: 1fr;
      }
    }

    /* Input Controls Panel */
    .prediction-inputs {
      background: var(--surface-2);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 16px;
      max-height: 600px;
      overflow-y: auto;
    }

    .inputs-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 2px solid var(--accent-2);
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--accent-2);
    }

    .reset-btn {
      padding: 6px 12px;
      background: linear-gradient(145deg, #4a5568, #2d3748);
      border: 1px solid #4a5568;
      color: #e2e8f0;
      font-size: 11px;
      font-weight: 600;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .reset-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0,0,0,.3);
    }

    .input-group {
      margin-bottom: 20px;
      padding: 12px;
      background: rgba(255, 255, 255, 0.03);
      border-radius: 6px;
      border: 1px solid rgba(255, 255, 255, 0.05);
    }

    .input-label {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      font-size: 0.95rem;
      font-weight: 600;
      color: var(--text-secondary);
    }

    .input-value-display {
      font-size: 1.1rem;
      color: var(--accent-1);
      font-weight: 700;
    }

    .slider-container {
      position: relative;
      padding: 8px 0;
    }

    .input-slider {
      width: 100%;
      height: 8px;
      border-radius: 4px;
      background: linear-gradient(90deg, rgba(120, 200, 255, 0.2), rgba(255, 165, 120, 0.2));
      outline: none;
      -webkit-appearance: none;
      appearance: none;
    }

    .input-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: var(--accent-1);
      cursor: pointer;
      box-shadow: 0 0 10px rgba(255, 165, 120, 0.5), 0 2px 4px rgba(0, 0, 0, 0.3);
      transition: all 0.2s;
    }

    .input-slider::-webkit-slider-thumb:hover {
      transform: scale(1.2);
      box-shadow: 0 0 15px rgba(255, 165, 120, 0.8);
    }

    .input-slider::-moz-range-thumb {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: var(--accent-1);
      cursor: pointer;
      border: none;
      box-shadow: 0 0 10px rgba(255, 165, 120, 0.5), 0 2px 4px rgba(0, 0, 0, 0.3);
      transition: all 0.2s;
    }

    .input-slider::-moz-range-thumb:hover {
      transform: scale(1.2);
      box-shadow: 0 0 15px rgba(255, 165, 120, 0.8);
    }

    .slider-range {
      display: flex;
      justify-content: space-between;
      margin-top: 4px;
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .input-select {
      width: 100%;
      padding: 8px 12px;
      background: var(--surface-1);
      border: 1px solid var(--border);
      border-radius: 4px;
      color: var(--text-primary);
      font-size: 0.95rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .input-select:hover {
      border-color: var(--accent-2);
    }

    .input-select:focus {
      outline: none;
      border-color: var(--accent-1);
      box-shadow: 0 0 8px rgba(255, 165, 120, 0.3);
    }

    /* Output Panel */
    .prediction-output {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .output-card {
      background: var(--surface-2);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 20px;
      text-align: center;
    }

    .main-prediction {
      background: linear-gradient(135deg, rgba(120, 200, 255, 0.15), rgba(255, 165, 120, 0.15));
      border: 2px solid var(--accent-1);
      box-shadow: 0 4px 16px rgba(255, 165, 120, 0.2);
    }

    .output-label {
      font-size: 0.9rem;
      color: var(--text-muted);
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .output-value {
      font-size: 2.5rem;
      font-weight: 700;
      color: var(--accent-1);
      text-shadow: 0 0 20px rgba(255, 165, 120, 0.5);
      margin-bottom: 8px;
    }

    .output-sublabel {
      font-size: 0.85rem;
      color: var(--text-secondary);
    }

    .intervals-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .interval-card {
      padding: 16px;
    }

    .interval-label {
      font-size: 0.85rem;
      color: var(--accent-2);
      margin-bottom: 12px;
      font-weight: 600;
    }

    .interval-range {
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 8px;
    }

    .interval-desc {
      font-size: 0.75rem;
      color: var(--text-muted);
      font-style: italic;
    }

    .prediction-viz {
      background: var(--surface-2);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 16px;
    }

    /* Scenarios Section */
    .scenarios-section {
      margin-top: 24px;
      background: var(--surface-2);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 16px;
    }

    .scenarios-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 2px solid var(--accent-2);
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--accent-2);
    }

    .save-scenario-btn {
      padding: 8px 16px;
      background: linear-gradient(145deg, rgba(120, 200, 255, 0.3), rgba(120, 200, 255, 0.2));
      border: 1px solid var(--accent-2);
      color: var(--accent-2);
      font-size: 12px;
      font-weight: 600;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .save-scenario-btn:hover {
      background: var(--accent-2);
      color: var(--surface-0);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(120, 200, 255, 0.4);
    }

    .scenarios-table-container {
      max-height: 300px;
      overflow-y: auto;
    }

    .scenarios-table {
      width: 100%;
      border-collapse: collapse;
    }

    .scenarios-table th {
      background: rgba(120, 200, 255, 0.1);
      padding: 10px;
      text-align: left;
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--accent-2);
      border-bottom: 2px solid var(--accent-2);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .scenarios-table td {
      padding: 10px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      font-size: 0.9rem;
    }

    .scenarios-table tr:hover:not(.no-scenarios) {
      background: rgba(255, 165, 120, 0.05);
    }

    .scenario-actions {
      display: flex;
      gap: 8px;
    }

    .scenario-btn {
      padding: 4px 8px;
      font-size: 11px;
      border-radius: 4px;
      border: 1px solid;
      cursor: pointer;
      transition: all 0.2s;
    }

    .scenario-btn.load {
      background: rgba(120, 200, 255, 0.2);
      border-color: var(--accent-2);
      color: var(--accent-2);
    }

    .scenario-btn.load:hover {
      background: var(--accent-2);
      color: var(--surface-0);
    }

    .scenario-btn.delete {
      background: rgba(239, 68, 68, 0.2);
      border-color: #ef4444;
      color: #ef4444;
    }

    .scenario-btn.delete:hover {
      background: #ef4444;
      color: #ffffff;
    }
    
    /* Tab Panels */
    .tab-panel {
      padding: 20px;
      min-height: 400px;
    }
  </style>
</head>
<body>
  <!-- Loading Overlay -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-spinner"></div>
    <div class="loading-text">Computing regression analysis...</div>
  </div>
  
  <div class="wrap">
    <section class="card" role="main">
      <div class="card-head">
        <span><i class="fa-solid fa-chart-line"></i> Linear Regression Analysis</span>
        <div style="display: flex; gap: 12px; align-items: center;">

          <!-- Decimal Precision Control -->
          <div style="display: flex; align-items: center; gap: 8px; padding: 6px 12px; background: rgba(0,0,0,0.2); border-radius: 6px; border: 1px solid rgba(255,255,255,0.1);">
            <label for="decimalSelect" style="font-size: 12px; color: var(--text-secondary); font-weight: 500; white-space: nowrap;">
              <i class="fa-solid fa-hashtag"></i> Decimals:
            </label>
            <select id="decimalSelect" onchange="updateDecimalPrecision()" style="background: var(--surface-2); color: var(--text-primary); border: 1px solid var(--border); border-radius: 4px; padding: 4px 8px; font-size: 12px; cursor: pointer;">
              <option value="auto">Auto</option>
              <option value="0">0</option>
              <option value="1">1</option>
              <option value="2" selected>2</option>
              <option value="3">3</option>
              <option value="4">4</option>
              <option value="5">5</option>
            </select>
          </div>
          
          <!-- AI Interpret Button -->
          <button class="dropdown-btn ai-interpret-btn" id="aiInterpretBtn" onclick="requestRegressionAI()" style="display: none;" title="Get AI-powered interpretation of regression results">
            <i class="fa-solid fa-robot"></i> AI Interpret
          </button>
          
          <div class="dropdown-container">
            <button class="dropdown-btn" id="dropdownBtn">
              Navigation Menu
              <span class="dropdown-arrow">‚ñº</span>
            </button>
            <div class="dropdown-content" id="dropdownContent">
              <a href="javascript:void(0);" onclick="openResidualDiagnostics()" style="cursor: pointer;">
                <i class="fa-solid fa-chart-line"></i> Residual Diagnostics
              </a>
              <div class="dropdown-separator"></div>
              <a href="javascript:void(0);" onclick="openModelCorrelations()" style="cursor: pointer;">
                <i class="fa-solid fa-project-diagram"></i> Model Variable Correlations
              </a>
              <a href="javascript:void(0);" onclick="openModelDescriptiveStats()" style="cursor: pointer;">
                <i class="fa-solid fa-chart-bar"></i> Model Variable Statistics
              </a>
              <div class="dropdown-separator"></div>
              <a href="http://127.0.0.1:12345?command=Case1000" target="_self">Data & Methods</a>
            </div>
          </div>
        </div>
      </div>

      <!-- Tab Navigation -->
      <div class="tab-navigation">
        <button class="tab-button active" onclick="switchTab('results')" data-tab="results">
          <i class="fa-solid fa-table"></i> Results
        </button>
        <button class="tab-button" onclick="switchTab('predictions')" data-tab="predictions">
          <i class="fa-solid fa-wand-magic-sparkles"></i> Predictions
        </button>
        <button class="tab-button" onclick="switchTab('residuals')" data-tab="residuals">
          <i class="fa-solid fa-chart-line"></i> Residual Diagnostics
        </button>
        <button class="tab-button" onclick="switchTab('correlations')" data-tab="correlations">
          <i class="fa-solid fa-project-diagram"></i> Correlations
        </button>
        <button class="tab-button" onclick="switchTab('descriptive')" data-tab="descriptive">
          <i class="fa-solid fa-chart-bar"></i> Descriptive Stats
        </button>
      </div>

      <div class="card-body">
        <!-- Tab: Results -->
        <div id="tab-results" class="tab-content active">
        <!-- Stats Panels -->
        <div class="stats-container">
          <div class="stat-panel">
            <div class="stat-panel-heading"><i class="fa-solid fa-info-circle"></i> Sample Info</div>
            <div class="stat-panel-body">
              <div class="stat-field">
                <span class="stat-label">Observations:</span>
                <span id="validObs" class="stat-value">...</span>
              </div>
              <div class="stat-field">
                <span class="stat-label">Include Intercept?:</span>
                <span id="includeIntercept" class="stat-value">...</span>
              </div>
              <div class="stat-field">
                <span class="stat-label">Numeric Variables:</span>
                <span id="numNumericVars" class="stat-value">...</span>
              </div>
              <div class="stat-field">
                <span class="stat-label">Categorical Variables:</span>
                <span id="numCategoricalVars" class="stat-value">...</span>
              </div>
              <div class="stat-field">
                <span class="stat-label">Degrees of Freedom:</span>
                <span id="degreesOfFreedom" class="stat-value">...</span>
              </div>
            </div>
          </div>

          <div class="stat-panel">
            <div class="stat-panel-heading"><i class="fa-solid fa-chart-bar"></i> Model Fit</div>
            <div class="stat-panel-body">
              <div class="stat-field">
                <span class="stat-label">R¬≤:</span>
                <span id="rSquared" class="stat-value">...</span>
              </div>
              <div class="stat-field">
                <span class="stat-label">Adjusted R¬≤:</span>
                <span id="adjRSquared" class="stat-value">...</span>
              </div>
              <div class="stat-field">
                <span class="stat-label">Root MSE:</span>
                <span id="rootMSE" class="stat-value">...</span>
              </div>
              <div class="stat-field">
                <span class="stat-label">AIC:</span>
                <span id="aic" class="stat-value">...</span>
              </div>
              <div class="stat-field">
                <span class="stat-label">BIC:</span>
                <span id="bic" class="stat-value">...</span>
              </div>
            </div>
          </div>

          <div class="stat-panel">
            <div class="stat-panel-heading"><i class="fa-solid fa-calculator"></i> F-Test</div>
            <div class="stat-panel-body">
              <div class="stat-field">
                <span class="stat-label">F-Statistic:</span>
                <span id="fStatistic" class="stat-value">...</span>
              </div>
              <div class="stat-field">
                <span class="stat-label">P-value:</span>
                <span id="fPValue" class="stat-value">...</span>
              </div>
              <div class="stat-field">
                <span class="stat-label">Sum of Squares (Model):</span>
                <span id="ssModel" class="stat-value">...</span>
              </div>
              <div class="stat-field">
                <span class="stat-label">Sum of Squares (Residual):</span>
                <span id="ssResidual" class="stat-value">...</span>
              </div>
            </div>
          </div>
        </div>

        <!-- ANOVA Table Panel -->
        <div class="stat-panel" style="min-width: 100%; margin-top: 8px;">
          <div class="stat-panel-heading"><i class="fa-solid fa-chart-pie"></i> ANOVA</div>
          <div class="stat-panel-body" style="padding: 0;">
            <div class="table-container" style="margin: 0; border: none; border-radius: 0;">
              <table class="regression-table">
                <thead>
                  <tr>
                    <th>Source</th>
                    <th>DF</th>
                    <th>Sum of Squares</th>
                    <th>Mean Square</th>
                    <th>F-Value</th>
                    <th>P-Value</th>
                  </tr>
                </thead>
                <tbody id="anovaTableBody">
                  <tr>
                    <td colspan="6" style="text-align:center; padding:20px; color:var(--text-muted); font-style:italic;">
                      <i class="fa-solid fa-hourglass-half"></i> Awaiting regression results...
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Coefficients Table Panel -->
        <div class="stat-panel" style="min-width: 100%; margin-top: 8px;">
          <div class="stat-panel-heading"><i class="fa-solid fa-table"></i> Coefficients</div>
          <div class="stat-panel-body" style="padding: 0;">
            <div class="table-container" style="margin: 0; border: none; border-radius: 0;">
              <table class="regression-table">
                <thead>
                  <tr>
                    <th><i class="fa-solid fa-tag"></i> Variable</th>
                    <th>Coefficient</th>
                    <th>Std. Error</th>
                    <th>t-value</th>
                    <th>P-value</th>
                    <th>95% CI Lower</th>
                    <th>95% CI Upper</th>
                    <th>VIF</th>
                  </tr>
                </thead>
                <tbody id="dataTableBody">
                  <tr>
                    <td colspan="8" style="text-align:center; padding:20px; color:var(--text-muted); font-style:italic;">
                      <i class="fa-solid fa-hourglass-half"></i> Awaiting regression results...
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
        
        <!-- Regression Equation Display -->
        <div class="stat-panel" style="min-width: 100%; margin-top: 8px;">
          <div class="stat-panel-heading"><i class="fa-solid fa-function"></i> Regression Equation</div>
          <div class="stat-panel-body">
            <div id="regressionEquation" style="font-family: 'Courier New', monospace; font-size: 0.8rem; color: var(--text-primary); background: rgba(0,0,0,0.3); padding: 10px; border-radius: 4px; overflow-x: auto; white-space: nowrap;">
              Awaiting regression results...
            </div>
          </div>
        </div>
        
        <!-- Toggle Equation Button -->
        <button class="toggle-equation-btn" id="toggleEquationBtn" onclick="toggleEquation()" style="display: none;">
          <i class="fa-solid fa-chevron-down"></i> Show Regression Equation
        </button>
        
        <!-- Regression Equation -->
        <div class="equation-section" id="equationSection" style="display: none;">
          <div class="equation-title">
            <i class="fa-solid fa-function"></i> Regression Equation
          </div>
          <div class="equation-formula" id="equationFormula">
            Awaiting regression results...
          </div>
        </div>
        </div>
        <!-- End Tab: Results -->

        <!-- Tab: Predictions -->
        <div id="tab-predictions" class="tab-content">
          <div class="predictions-container">
            
            <!-- Prediction Header -->
            <div class="prediction-header">
              <div class="prediction-title">
                <i class="fa-solid fa-wand-magic-sparkles"></i> Interactive Prediction Engine
              </div>
              <div class="prediction-subtitle">
                Adjust variable values below to explore "what-if" scenarios
              </div>
            </div>

            <!-- Main Prediction Layout -->
            <div class="prediction-layout">
              
              <!-- Left Panel: Input Controls -->
              <div class="prediction-inputs">
                <div class="inputs-header">
                  <i class="fa-solid fa-sliders"></i> Input Variables
                  <button class="reset-btn" onclick="resetToMeanValues()">
                    <i class="fa-solid fa-rotate-left"></i> Reset to Means
                  </button>
                </div>
                <div id="predictionInputsContainer">
                  <!-- Dynamic inputs will be generated here -->
                </div>
              </div>

              <!-- Right Panel: Prediction Output -->
              <div class="prediction-output">
                <div class="output-card main-prediction">
                  <div class="output-label">Predicted Value</div>
                  <div class="output-value" id="predictedValue">-</div>
                  <div class="output-sublabel">Point Estimate</div>
                </div>

                <div class="intervals-container">
                  <div class="output-card interval-card">
                    <div class="interval-label">
                      <i class="fa-solid fa-chart-area"></i> 95% Confidence Interval
                    </div>
                    <div class="interval-range" id="confidenceInterval">-</div>
                    <div class="interval-desc">Mean prediction uncertainty</div>
                  </div>

                  <div class="output-card interval-card">
                    <div class="interval-label">
                      <i class="fa-solid fa-chart-scatter"></i> 95% Prediction Interval
                    </div>
                    <div class="interval-range" id="predictionInterval">-</div>
                    <div class="interval-desc">Individual prediction range</div>
                  </div>
                </div>

                <!-- Prediction Visualization -->
                <div class="prediction-viz">
                  <canvas id="predictionChart" width="400" height="60"></canvas>
                </div>
              </div>
            </div>

            <!-- Scenarios Comparison Table -->
            <div class="scenarios-section">
              <div class="scenarios-header">
                <div>
                  <i class="fa-solid fa-table"></i> Saved Scenarios
                </div>
                <button class="save-scenario-btn" onclick="saveCurrentScenario()">
                  <i class="fa-solid fa-bookmark"></i> Save Current Scenario
                </button>
              </div>
              <div class="scenarios-table-container">
                <table class="scenarios-table" id="scenariosTable">
                  <thead>
                    <tr>
                      <th>Scenario</th>
                      <th>Predicted Value</th>
                      <th>95% CI</th>
                      <th>95% PI</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody id="scenariosTableBody">
                    <tr class="no-scenarios">
                      <td colspan="5" style="text-align: center; color: var(--text-muted); padding: 20px;">
                        <i class="fa-solid fa-info-circle"></i> No scenarios saved yet. Adjust variables above and click "Save Current Scenario"
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>

          </div>
        </div>
        <!-- End Tab: Predictions -->

        <!-- Tab: Residual Diagnostics -->
        <div id="tab-residuals" class="tab-content">
          <div class="tab-panel" id="residualsPanel">
            <div style="text-align: center; padding: 60px 20px; color: var(--text-muted);">
              <i class="fa-solid fa-spinner fa-spin" style="font-size: 48px; margin-bottom: 15px;"></i>
              <p>Loading residual diagnostics...</p>
            </div>
          </div>
        </div>

        <!-- Tab: Correlations -->
        <div id="tab-correlations" class="tab-content">
          <div class="tab-panel" id="correlationsPanel">
            <div style="text-align: center; padding: 60px 20px; color: var(--text-muted);">
              <i class="fa-solid fa-spinner fa-spin" style="font-size: 48px; margin-bottom: 15px;"></i>
              <p>Loading correlations...</p>
            </div>
          </div>
        </div>

        <!-- Tab: Descriptive Stats -->
        <div id="tab-descriptive" class="tab-content">
          <div class="tab-panel" id="descriptivePanel">
            <div style="text-align: center; padding: 60px 20px; color: var(--text-muted);">
              <i class="fa-solid fa-spinner fa-spin" style="font-size: 48px; margin-bottom: 15px;"></i>
              <p>Loading descriptive statistics...</p>
            </div>
          </div>
        </div>

      </div>
    </section>
  </div>

    <!-- Custom awaiting panel instructions for regression -->
  <script>
    window.AWAITING_PANEL_INSTRUCTIONS = `
      <div style="text-align: left; color: #8b95a5; font-size: 14px; line-height: 1.8; max-width: 420px; padding: 0 20px;">
        <div style="margin-bottom: 8px;">üìä <strong style="color: #ffa500;">Select your data range</strong> in the input panel</div>
        <div style="margin-bottom: 8px;">üéØ <strong style="color: #ffa500;">Assign Y variable</strong> (response) and predictors (Xn, Xc)</div>
        <div style="margin-bottom: 8px;">‚ñ∂Ô∏è <strong style="color: #ffa500;">Click "Run Regression"</strong> to see results</div>
        <div>üìà Regression analysis includes coefficients, R¬≤, F-test, and more</div>
      </div>
    `;
  </script>

  <script>
    // Utility function to send commands to VB6 host
    function sendToHost(cmd, data) {
      try {
        if (typeof vbHost !== 'undefined' && vbHost && typeof vbHost.RaiseMessageEvent === 'function') {
          var dataStr = typeof data === 'string' ? data : JSON.stringify(data || {});
          vbHost.RaiseMessageEvent(cmd, dataStr);
          console.log('üì§ Sent to host:', cmd, dataStr.substring(0, 100));
        } else {
          console.warn('‚ö†Ô∏è vbHost not available');
        }
      } catch(e) {
        console.error('‚ùå Error sending to host:', e);
      }
    }
    
    // Tab Management
    function switchTab(tabName) {
      console.log('üîÑ Switching to tab:', tabName);
      
      // Update tab buttons
      document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.tab === tabName) {
          btn.classList.add('active');
        }
      });
      
      // Update tab content
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
      });
      document.getElementById(`tab-${tabName}`).classList.add('active');
      
      // Lazy load tab content if not already loaded
      if (tabName === 'residuals' && !window.residualsLoaded) {
        loadResidualsTab();
      } else if (tabName === 'correlations' && !window.correlationsLoaded) {
        loadCorrelationsTab();
      } else if (tabName === 'descriptive' && !window.descriptiveLoaded) {
        loadDescriptiveTab();
      }
    }

    // Global decimal precision setting
    let globalDecimalPrecision = 'auto'; // 'auto', '0', '1', '2', '3', '4', '5'
    
    // Smart number formatting based on global precision
    function formatNumber(val, forceDecimals = null) {
      const decimals = forceDecimals !== null ? forceDecimals : 
                       (globalDecimalPrecision === 'auto' ? null : parseInt(globalDecimalPrecision));
      
      if (globalDecimalPrecision === 'auto' || decimals === null) {
        // Auto mode: adaptive formatting
        if (Math.abs(val) < 0.01 && val !== 0) {
          return val.toExponential(3);
        } else if (Math.abs(val) < 1 && val !== 0) {
          return val.toFixed(4);
        } else {
          return val.toFixed(2);
        }
      } else {
        // User-specified precision
        return val.toFixed(decimals);
      }
    }
    
    // Function to update decimal precision and refresh display
    function updateDecimalPrecision() {
      const select = document.getElementById('decimalSelect');
      globalDecimalPrecision = select.value;
      console.log('üî¢ Decimal precision changed to:', globalDecimalPrecision);
      
      // Re-render results if they exist
      if (window.regressionResults && receivedModelSpec) {
        const { y, xn = [], xc = [] } = receivedModelSpec;
        displayRegressionResults(window.regressionResults, y, xn, xc);
      }
    }
    
    // Office.js integration for Excel Add-in
    let receivedRegressionData = null;
    let receivedModelSpec = null;
    
    // Initialize Office.js
    if (typeof Office !== 'undefined') {
      Office.onReady((info) => {
        console.log('‚úÖ Office.js ready in regression coefficients dialog');
        
        // Hide loading overlay initially
        const loadingOverlay = document.getElementById('loadingOverlay');
        if (loadingOverlay) {
          loadingOverlay.classList.add('hidden');
        }
        
        // Signal that dialog is ready to receive data
        if (Office.context && Office.context.ui) {
          Office.context.ui.messageParent(JSON.stringify({ 
            action: 'ready' 
          }));
        }
        
        // Listen for messages from parent taskpane
        Office.context.ui.addHandlerAsync(
          Office.EventType.DialogParentMessageReceived,
          (arg) => {
            try {
              const message = JSON.parse(arg.message);
              console.log('üì• Received message from taskpane:', message.type);
              
              if (message.type === 'REGRESSION_RESULTS') {
                receivedRegressionData = message.payload;
                receivedModelSpec = message.payload.modelSpec;
                
                console.log('‚úÖ Received regression data and model spec');
                console.log('   Headers:', message.payload.headers);
                console.log('   Rows:', message.payload.rows?.length);
                console.log('   Model:', receivedModelSpec);
                
                // Process and display the regression results
                processRegressionData();
              }
            } catch (e) {
              console.error('‚ùå Error handling message from parent:', e);
            }
          }
        );
      });
    }
    
    // Helper function to get unique categories from a column
    function getUniqueCategories(rows, colIndex) {
      const categories = new Set();
      for (const row of rows) {
        const val = row[colIndex];
        if (val !== null && val !== undefined && val !== '') {
          categories.add(String(val));
        }
      }
      return Array.from(categories).sort();
    }
    
    // Helper function to create dummy variables for a categorical column
    function createDummyVariables(value, categories, varName) {
      // Create k-1 dummy variables (first category is reference)
      const dummies = [];
      const strValue = String(value);
      
      for (let i = 1; i < categories.length; i++) {
        dummies.push(strValue === categories[i] ? 1 : 0);
      }
      
      return dummies;
    }
    
    // Process the received regression data and run analysis
    function processRegressionData() {
      if (!receivedRegressionData || !receivedModelSpec) {
        console.warn('‚ö†Ô∏è No data or model spec received yet');
        return;
      }
      
      // Show loading overlay
      const loadingOverlay = document.getElementById('loadingOverlay');
      if (loadingOverlay) {
        loadingOverlay.classList.remove('hidden');
      }
      
      // Use setTimeout to allow UI to render the loading overlay before heavy computation
      setTimeout(() => {
        try {
          processRegressionDataInternal();
        } catch (error) {
          console.error('‚ùå Error processing regression data:', error);
          if (loadingOverlay) {
            loadingOverlay.classList.add('hidden');
          }
        }
      }, 50);
    }
    
    // Internal function that does the actual computation
    function processRegressionDataInternal() {
      console.log('üîÑ Processing regression data...');
      
      const { headers, rows, address } = receivedRegressionData;
      const { y, xn = [], xc = [], intercept } = receivedModelSpec;
      
      console.log('üìã Model specification:', {
        y,
        xn,
        xc,
        intercept
      });
      console.log('üìã Available headers:', headers);
      
      // Build X matrix and Y vector from the data
      const yIndex = headers.indexOf(y);
      const xnIndices = xn.map(varName => headers.indexOf(varName));
      const xcIndices = xc.map(varName => headers.indexOf(varName));
      
      console.log('üîç Index lookup results:', {
        yIndex,
        xnIndices,
        xcIndices
      });
      
      if (yIndex === -1) {
        console.error('‚ùå Y variable not found in headers');
        console.error('   Looking for:', y);
        console.error('   Available:', headers);
        return;
      }
      
      // Step 1: Identify unique categories for each categorical variable
      const categoricalInfo = [];
      for (let i = 0; i < xc.length; i++) {
        const xcIdx = xcIndices[i];
        const varName = xc[i];
        const categories = getUniqueCategories(rows, xcIdx);
        
        console.log(`üìä Categorical variable "${varName}":`, categories);
        
        if (categories.length < 2) {
          console.warn(`‚ö†Ô∏è Categorical variable "${varName}" has less than 2 categories. Skipping.`);
          continue;
        }
        
        categoricalInfo.push({
          name: varName,
          index: xcIdx,
          categories: categories,
          // Create dummy variable names (k-1 dummies, first category is reference)
          dummyNames: categories.slice(1).map(cat => `${varName}_${cat}`)
        });
      }
      
      console.log('üéØ Categorical dummy coding:', categoricalInfo);
      
      // Build variable names list (for display)
      const variableNames = [...xn]; // Start with numeric variables
      for (const catInfo of categoricalInfo) {
        variableNames.push(...catInfo.dummyNames);
      }
      
      console.log('üìã Final variable names:', variableNames);
      
      // Step 2: Build X matrix and Y vector together with synchronized filtering
      const xMatrix = [];
      const yVector = [];
      
      for (let i = 0; i < rows.length; i++) {
        const row = rows[i];
        
        // Get Y value
        const yVal = parseFloat(row[yIndex]);
        if (isNaN(yVal)) continue; // Skip if Y is invalid
        
        // Build X row
        const xRow = [];
        let validRow = true;
        
        // Add numeric predictors
        for (const xnIdx of xnIndices) {
          const val = parseFloat(row[xnIdx]);
          if (isNaN(val)) {
            validRow = false;
            break;
          }
          xRow.push(val);
        }
        
        if (!validRow) continue;
        
        // Add categorical predictors as dummy variables
        for (const catInfo of categoricalInfo) {
          const catValue = row[catInfo.index];
          if (catValue === null || catValue === undefined || catValue === '') {
            validRow = false;
            break;
          }
          
          // Create dummy variables for this categorical
          const dummies = createDummyVariables(catValue, catInfo.categories, catInfo.name);
          xRow.push(...dummies);
        }
        
        // Only add if all values are valid
        if (validRow) {
          xMatrix.push(xRow);
          yVector.push(yVal);
        }
      }
      
      // Store variable names globally for display
      window.regressionVariableNames = variableNames;
      
      console.log('üìä Data prepared:', {
        observations: yVector.length,
        predictors: xMatrix[0]?.length || 0,
        intercept: intercept === 1,
        xMatrixRows: xMatrix.length,
        yVectorLength: yVector.length
      });
      
      // Validate data before proceeding
      if (xMatrix.length === 0 || yVector.length === 0) {
        console.error('‚ùå No valid data after filtering');
        const tbody = document.getElementById('dataTableBody');
        if (tbody) {
          tbody.innerHTML = `<tr><td colspan="8" style="color: #ff6b6b; text-align: center; padding: 20px;">
            <i class="fa-solid fa-exclamation-triangle"></i> No valid observations after removing missing values
          </td></tr>`;
        }
        return;
      }
      
      if (xMatrix.length !== yVector.length) {
        console.error('‚ùå Length mismatch between X and Y');
        console.error('   X rows:', xMatrix.length, 'Y rows:', yVector.length);
        return;
      }
      
      // Update page title
      const pageTitle = document.getElementById('page-title');
      if (pageTitle) {
        pageTitle.innerText = `Regression: ${y} ~ ${[...xn, ...xc].join(' + ')}`;
      }
      
      // Compute regression using OLS
      console.log('üî¢ Computing OLS regression...');
      try {
        const results = computeOLS(xMatrix, yVector, intercept === 1, 0.05);
        console.log('‚úÖ Regression computed successfully:', results);
        
        // Calculate fitted values
        const X = intercept === 1 
          ? xMatrix.map(row => [1, ...row])
          : xMatrix;
        results.fitted = X.map(row => 
          row.reduce((sum, xi, i) => sum + xi * results.coefficients[i], 0)
        );
        
        // Store results globally for tabs
        window.regressionResults = results;
        window.regressionData = { yVector, xMatrix, intercept };
        
        // Pre-store data for all tabs in sessionStorage
        sessionStorage.setItem('residualData', JSON.stringify({
          results: results,
          fittedValues: results.fitted
        }));
        
        // Prepare correlation data
        const indices = [y, ...xn].map(varName => headers.indexOf(varName)).filter(idx => idx !== -1);
        const filteredHeaders = indices.map(idx => headers[idx]);
        const filteredData = rows.map(row => {
          const rowObj = {};
          filteredHeaders.forEach((header, i) => {
            rowObj[header] = row[indices[i]];
          });
          return rowObj;
        });
        
        sessionStorage.setItem('correlationData', JSON.stringify({
          headers: filteredHeaders,
          data: filteredData,
          address: address,
          source: 'regression-model',
          modelInfo: { y, xn, totalVars: filteredHeaders.length }
        }));
        
        console.log('‚úÖ All tab data pre-stored in sessionStorage');
        
        // Display results in the UI
        displayRegressionResults(results, y, xn, xc);
        
        // Hide loading overlay after successful computation
        const loadingOverlay = document.getElementById('loadingOverlay');
        if (loadingOverlay) {
          loadingOverlay.classList.add('hidden');
        }
        
      } catch (error) {
        console.error('‚ùå Error computing regression:', error);
        console.error('Error details:', error.message, error.stack);
        // Show error in UI instead of alert
        const tbody = document.getElementById('dataTableBody');
        if (tbody) {
          tbody.innerHTML = `<tr><td colspan="8" style="color: #ff6b6b; text-align: center; padding: 20px;">
            <i class="fa-solid fa-exclamation-triangle"></i> Error: ${error.message}
          </td></tr>`;
        }
        
        // Hide loading overlay after error
        const loadingOverlay = document.getElementById('loadingOverlay');
        if (loadingOverlay) {
          loadingOverlay.classList.add('hidden');
        }
      }
    }
    
    // Display regression results in the UI
    function displayRegressionResults(results, yVarName, xnVars, xcVars) {
      console.log('üìä Displaying regression results...');
      
      // Get the proper variable names (with dummy coding)
      const varNames = window.regressionVariableNames || [...xnVars, ...xcVars];
      
      // Build complete variable list with proper names (for use throughout)
      const allVars = results.includeIntercept ? ['Intercept', ...varNames] : varNames;
      
      // Populate Sample Info panel
      document.getElementById('validObs').textContent = results.n;
      document.getElementById('includeIntercept').textContent = results.includeIntercept ? 'Yes' : 'No';
      document.getElementById('numNumericVars').textContent = xnVars.length;
      document.getElementById('numCategoricalVars').textContent = xcVars.length;
      document.getElementById('degreesOfFreedom').textContent = results.df; // Residual degrees of freedom (n - k)
      
      // Populate Model Fit panel
      document.getElementById('rSquared').textContent = results.R2.toFixed(4); // Always 4 decimals for R¬≤
      document.getElementById('adjRSquared').textContent = results.R2_adj.toFixed(4); // Always 4 decimals for R¬≤
      document.getElementById('rootMSE').textContent = formatNumber(results.RMSE);
      document.getElementById('aic').textContent = formatNumber(results.AIC);
      document.getElementById('bic').textContent = formatNumber(results.BIC);
      
      // Populate F-test panel
      document.getElementById('fStatistic').textContent = formatNumber(results.F_stat);
      document.getElementById('fPValue').textContent = results.F_pvalue < 0.0001 ? '< 0.0001' : results.F_pvalue.toFixed(4); // Always 4 decimals for p-value
      document.getElementById('ssModel').textContent = formatNumber(results.SSE);
      document.getElementById('ssResidual').textContent = formatNumber(results.SSR);
      
      // Populate ANOVA table
      const anovaBody = document.getElementById('anovaTableBody');
      if (anovaBody) {
        // Calculate degrees of freedom
        const df_model = results.k - 1; // k - 1 for model (k includes intercept)
        const df_residual = results.df; // n - k
        const df_total = results.n - 1;
        
        // Calculate mean squares
        const ms_model = results.SSE / df_model;
        const ms_residual = results.SSR / df_residual;
        
        anovaBody.innerHTML = `
          <tr style="background: rgba(74, 85, 104, 0.3);">
            <td><strong>Model</strong></td>
            <td>${df_model}</td>
            <td>${formatNumber(results.SSE)}</td>
            <td>${formatNumber(ms_model)}</td>
            <td>${formatNumber(results.F_stat)}</td>
            <td>${results.F_pvalue < 0.0001 ? '< 0.0001' : results.F_pvalue.toFixed(4)}</td>
          </tr>
          <tr>
            <td><strong>Residual</strong></td>
            <td>${df_residual}</td>
            <td>${formatNumber(results.SSR)}</td>
            <td>${formatNumber(ms_residual)}</td>
            <td>‚Äî</td>
            <td>‚Äî</td>
          </tr>
          <tr style="background: rgba(255, 165, 120, 0.2); font-weight: 600;">
            <td><strong>Total</strong></td>
            <td>${df_total}</td>
            <td>${formatNumber(results.TSS)}</td>
            <td>‚Äî</td>
            <td>‚Äî</td>
            <td>‚Äî</td>
          </tr>
        `;
      }
      
      // Populate coefficients table
      const tbody = document.getElementById('dataTableBody');
      if (tbody) {
        tbody.innerHTML = '';
        
        results.coefficients.forEach((coef, i) => {
          const row = document.createElement('tr');
          const varName = allVars[i] || `X${i}`;
          
          // Determine variable type for color coding
          let varClass = '';
          let rowStyle = '';
          if (i === 0 && results.includeIntercept) {
            varClass = 'var-intercept';
            rowStyle = 'background: rgba(251, 191, 36, 0.08) !important;';
          } else {
            // Check if it's a categorical variable (contains underscore for dummy coding)
            if (varName.includes('_')) {
              varClass = 'var-categorical';
              rowStyle = 'background: rgba(244, 114, 182, 0.08) !important;';
            } else {
              varClass = 'var-numeric';
              rowStyle = 'background: rgba(59, 130, 246, 0.05) !important;';
            }
          }
          
          // Check significance
          const significant = results.p_values[i] < 0.05;
          const highlySignificant = results.p_values[i] < 0.01;
          const veryHighlySignificant = results.p_values[i] < 0.001;
          
          let sigIndicator = '';
          if (veryHighlySignificant) sigIndicator = ' ***';
          else if (highlySignificant) sigIndicator = ' **';
          else if (significant) sigIndicator = ' *';
          
          row.style.cssText = rowStyle;
          
          // Use global formatNumber function for all values
          const formatCoef = (val) => formatNumber(val);
          const formatSE = (val) => formatNumber(val);
          
          row.innerHTML = `
            <td><strong class="${varClass}">${varName}</strong></td>
            <td>${formatCoef(coef)}${sigIndicator}</td>
            <td>${formatSE(results.std_errors[i])}</td>
            <td>${results.t_values[i].toFixed(2)}</td>
            <td>${results.p_values[i] < 0.0001 ? '< 0.0001' : results.p_values[i].toFixed(4)}</td>
            <td>${formatCoef(results.CI_lower[i])}</td>
            <td>${formatCoef(results.CI_upper[i])}</td>
            <td>${i === 0 && results.includeIntercept ? '‚Äî' : (results.VIF[i - (results.includeIntercept ? 1 : 0)]?.toFixed(2) || '‚Äî')}</td>
          `;
          
          tbody.appendChild(row);
        });
      }
      
      // Generate and display regression equation
      const equationDiv = document.getElementById('regressionEquation');
      if (equationDiv) {
        let equation = `${yVarName} = `;
        
        // Add intercept if included
        if (results.includeIntercept && results.coefficients.length > 0) {
          equation += `${results.coefficients[0].toFixed(2)}`;
        }
        
        // Add all predictor terms
        const startIdx = results.includeIntercept ? 1 : 0;
        for (let i = startIdx; i < results.coefficients.length; i++) {
          const coef = results.coefficients[i];
          const varName = allVars[i] || `X${i}`;
          const sign = coef >= 0 ? ' + ' : ' - ';
          const absCoef = Math.abs(coef).toFixed(2);
          
          equation += `${sign}${absCoef} √ó ${varName}`;
        }
        
        equation += ' + Œµ';
        equationDiv.textContent = equation;
      }
      
      console.log('‚úÖ Results displayed in UI');
    }

    // Function to trigger VB6 regression
    function runRegression() {
      console.log('üîÑ Running regression...');
      sendToHost('runRegression', { action: 'run' });
    }

    // Store the number of numeric variables for table population
    let numNumericVariables = 0;
    
    // Global variable to store regression results for AI
    let regressionResultsForAI = null;
    
    // Function to store results when they arrive
    function storeRegressionResultsForAI(statsData, tableData) {
      console.log('üìä Storing regression results for AI...');
      
      // Parse the data if strings
      const stats = typeof statsData === 'string' ? JSON.parse(statsData) : statsData;
      const coeffs = typeof tableData === 'string' ? JSON.parse(tableData) : tableData;
      
      // Store in global variable for AI interpretation
      regressionResultsForAI = {
        yVariable: document.getElementById('page-title')?.innerText || 'Y',
        observations: stats.observations || stats.validObs,
        numPredictors: (parseInt(stats.numNumericVars || 0) + parseInt(stats.numCategoricalVars || 0)),
        rSquared: stats.rSquared || stats.R2,
        adjRSquared: stats.adjRSquared || stats.adjR2,
        rootMSE: stats.rootMSE || stats.rmse,
        aic: stats.aic || stats.AIC,
        bic: stats.bic || stats.BIC,
        fStatistic: stats.fStatistic || stats.F,
        fPValue: stats.fPValue || stats.pValue,
        ssModel: stats.ssModel || stats.SSR,
        ssResidual: stats.ssResidual || stats.SSE,
        coefficients: coeffs
      };
      
      // Show AI button now that we have results
      const aiBtn = document.getElementById('aiInterpretBtn');
      if (aiBtn) {
        aiBtn.style.display = 'block';
        console.log('‚úÖ AI button shown');
      }
      
      console.log('‚úÖ Regression results stored for AI');
    }
    
    // Function to request AI interpretation
    function requestRegressionAI() {
      console.log('ü§ñ Requesting AI interpretation for regression...');
      
      if (!regressionResultsForAI) {
        alert('No regression results available. Please run a regression first.');
        return;
      }
      
      // Show loading state on button
      const aiBtn = document.getElementById('aiInterpretBtn');
      if (aiBtn) {
        aiBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Processing...';
        aiBtn.disabled = true;
      }
      
      // Convert to JSON and send to VB6
      const jsonData = JSON.stringify(regressionResultsForAI);
      console.log('üì§ Sending to VB6 (', jsonData.length, 'chars)');
      
      sendToHost('requestRegressionAI', jsonData);
      
      // Reset button after a delay
      setTimeout(() => {
        if (aiBtn) {
          aiBtn.innerHTML = '<i class="fa-solid fa-robot"></i> AI Interpret';
          aiBtn.disabled = false;
        }
      }, 2000);
    }
    
    // Function to receive AI interpretation from VB6
    window.receiveRegressionAI = function(jsonPayload) {
      console.log('üì• Received AI interpretation from VB6');
      
      try {
        const data = JSON.parse(jsonPayload);
        
        if (data.error) {
          alert('AI Error: ' + data.error);
          console.error('‚ùå AI Error:', data.error);
          return;
        }
        
        if (data.interpretation) {
          console.log('‚úÖ AI Interpretation received (', data.interpretation.length, 'chars)');
          console.log('üìù Preview:', data.interpretation.substring(0, 100) + '...');
          // The VB6 code shows a popup
        }
      } catch (e) {
        console.error('‚ùå Error parsing AI response:', e);
        alert('Error displaying AI interpretation: ' + e.message);
      }
    };

    // Global array to store regression variables (for navigation to descriptive stats)
    let regressionVariablesList = [];
    
    // VB6 can call this to set the regression variables list
    window.setRegressionVariablesList = function(variablesArray) {
      console.log('üì• VB6 setRegressionVariablesList called');
      
      if (typeof variablesArray === 'string') {
        try {
          regressionVariablesList = JSON.parse(variablesArray);
          console.log('‚úÖ Regression variables list set:', regressionVariablesList);
        } catch (e) {
          console.error('‚ùå Error parsing variables array:', e);
        }
      } else if (Array.isArray(variablesArray)) {
        regressionVariablesList = variablesArray;
        console.log('‚úÖ Regression variables list set:', regressionVariablesList);
      }
    };
    
    // Load Residuals Tab Content
    function loadResidualsTab() {
      if (!window.regressionResults || !window.regressionData) {
        document.getElementById('residualsPanel').innerHTML = `
          <div style="text-align: center; padding: 60px 20px; color: var(--text-muted);">
            <i class="fa-solid fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 15px;"></i>
            <p>No regression results available</p>
          </div>
        `;
        return;
      }
      
      console.log('üìä Loading residuals tab...');
      const panel = document.getElementById('residualsPanel');
      const baseUrl = window.location.href.split('/regression/')[0];
      const iframeUrl = `${baseUrl}/regression/regression-residuals.html`;
      console.log('Loading iframe:', iframeUrl);
      
      const iframe = document.createElement('iframe');
      iframe.style.cssText = 'width: 100%; height: 80vh; border: none; background: transparent;';
      iframe.src = iframeUrl;
      
      // Send data to iframe when it loads
      iframe.onload = function() {
        console.log('üì§ Sending data to residuals iframe');
        const results = window.regressionResults;
        const data = window.regressionData;
        
        iframe.contentWindow.postMessage({
          type: 'RESIDUAL_DATA',
          payload: {
            results: results,
            fittedValues: results.fitted
          }
        }, '*');
      };
      
      panel.innerHTML = '';
      panel.appendChild(iframe);
      window.residualsLoaded = true;
    }
    
    // Load Correlations Tab Content  
    function loadCorrelationsTab() {
      if (!receivedRegressionData || !receivedModelSpec) {
        document.getElementById('correlationsPanel').innerHTML = `
          <div style="text-align: center; padding: 60px 20px; color: var(--text-muted);">
            <i class="fa-solid fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 15px;"></i>
            <p>No data available</p>
          </div>
        `;
        return;
      }
      
      console.log('üìä Loading correlations tab...');
      const panel = document.getElementById('correlationsPanel');
      const baseUrl = window.location.href.split('/regression/')[0];
      const iframeUrl = `${baseUrl}/correlations/correlation-matrix.html`;
      console.log('Loading iframe:', iframeUrl);
      
      const iframe = document.createElement('iframe');
      iframe.style.cssText = 'width: 100%; height: 80vh; border: none; background: transparent;';
      iframe.src = iframeUrl;
      
      // Prepare correlation data
      const { headers, rows, address } = receivedRegressionData;
      const { y, xn = [] } = receivedModelSpec;
      const indices = [y, ...xn].map(varName => headers.indexOf(varName)).filter(idx => idx !== -1);
      const filteredHeaders = indices.map(idx => headers[idx]);
      const filteredData = rows.map(row => {
        const rowObj = {};
        filteredHeaders.forEach((header, i) => {
          rowObj[header] = row[indices[i]];
        });
        return rowObj;
      });
      
      // Send data to iframe when it loads
      iframe.onload = function() {
        console.log('üì§ Sending data to correlations iframe');
        iframe.contentWindow.postMessage({
          type: 'CORRELATION_DATA',
          payload: {
            headers: filteredHeaders,
            data: filteredData,
            address: address,
            source: 'regression-model'
          }
        }, '*');
      };
      
      panel.innerHTML = '';
      panel.appendChild(iframe);
      window.correlationsLoaded = true;
    }
    
    // Load Descriptive Stats Tab Content
    function loadDescriptiveTab() {
      if (!receivedRegressionData || !receivedModelSpec) {
        document.getElementById('descriptivePanel').innerHTML = `
          <div style="text-align: center; padding: 60px 20px; color: var(--text-muted);">
            <i class="fa-solid fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 15px;"></i>
            <p>No data available</p>
          </div>
        `;
        return;
      }
      
      console.log('üìä Loading descriptive stats tab...');
      const panel = document.getElementById('descriptivePanel');
      const baseUrl = window.location.href.split('/regression/')[0];
      const iframeUrl = `${baseUrl}/correlations/descriptive-stats.html`;
      console.log('Loading iframe:', iframeUrl);
      
      const iframe = document.createElement('iframe');
      iframe.style.cssText = 'width: 100%; height: 80vh; border: none; background: transparent;';
      iframe.src = iframeUrl;
      
      // Prepare data (same format as correlations)
      const { headers, rows, address } = receivedRegressionData;
      const { y, xn = [] } = receivedModelSpec;
      const indices = [y, ...xn].map(varName => headers.indexOf(varName)).filter(idx => idx !== -1);
      const filteredHeaders = indices.map(idx => headers[idx]);
      const filteredData = rows.map(row => {
        const rowObj = {};
        filteredHeaders.forEach((header, i) => {
          rowObj[header] = row[indices[i]];
        });
        return rowObj;
      });
      
      // Send data to iframe when it loads
      iframe.onload = function() {
        console.log('üì§ Sending data to descriptive stats iframe');
        iframe.contentWindow.postMessage({
          type: 'CORRELATION_DATA', // Descriptive stats uses same message type
          payload: {
            headers: filteredHeaders,
            data: filteredData,
            address: address,
            source: 'regression-model'
          }
        }, '*');
      };
      
      panel.innerHTML = '';
      panel.appendChild(iframe);
      window.descriptiveLoaded = true;
    }
    
    // Function to open residual diagnostics (keep for dropdown compatibility)
    function openResidualDiagnostics() {
      switchTab('residuals');
    }
    
    // Function to open correlation matrix for model variables (keep for dropdown compatibility)
    function openModelCorrelations() {
      switchTab('correlations');
    }
    
    // Function to open descriptive statistics for model variables (keep for dropdown compatibility)
    function openModelDescriptiveStats() {
      switchTab('descriptive');
    }
    
    // Dropdown toggle functionality
    (function() {
      const dropdownBtn = document.getElementById('dropdownBtn');
      const dropdownContent = document.getElementById('dropdownContent');

      dropdownBtn.addEventListener('click', function(e) {
        e.stopPropagation();
        dropdownContent.classList.toggle('show');
        dropdownBtn.classList.toggle('open');
      });

      window.addEventListener('click', function() {
        dropdownContent.classList.remove('show');
        dropdownBtn.classList.remove('open');
      });

      dropdownContent.addEventListener('click', function(e) {
        e.stopPropagation();
      });
      
      // Intercept clicks on dropdown links to store regression context
      dropdownContent.querySelectorAll('a').forEach(link => {
        link.addEventListener('click', function(e) {
          const href = this.getAttribute('href');
          
          // If navigating to descriptive statistics, store regression variables
          if (href && href.includes('Case400')) {
            console.log('üìä Navigating to Descriptive Statistics from regression');
            
            if (regressionVariablesList.length > 0) {
              console.log('‚úÖ Storing regression variables:', regressionVariablesList);
              sessionStorage.setItem('regressionModelVariables', JSON.stringify(regressionVariablesList));
              sessionStorage.setItem('loadFromRegression', 'true');
            } else {
              console.warn('‚ö†Ô∏è No regression variables available yet');
            }
          }
          
          // If navigating to correlation analysis, store regression variables
          if (href && href.includes('Case500')) {
            console.log('üìä Navigating to Correlation Analysis from regression');
            
            if (regressionVariablesList.length > 0) {
              console.log('‚úÖ Storing regression variables:', regressionVariablesList);
              sessionStorage.setItem('regressionModelVariables', JSON.stringify(regressionVariablesList));
              sessionStorage.setItem('loadFromRegression', 'true');
            }
          }
        });
      });
    })();

    // Function to populate the panels dynamically
    function populatePanels(data) {
      const stats = JSON.parse(data);
      
      // Store for use in table population
      numNumericVariables = parseInt(stats.numNumericVars || stats.numXn || '0');
      
      // Sample Info
      document.getElementById('validObs').innerText = stats.observations || stats.validObs || 'N/A';
      document.getElementById('includeIntercept').innerText = stats.includeIntercept ? 'Yes' : 'No';
      document.getElementById('numNumericVars').innerText = numNumericVariables || '0';
      document.getElementById('numCategoricalVars').innerText = stats.numCategoricalVars || stats.numXc || '0';
      document.getElementById('degreesOfFreedom').innerText = stats.degreesOfFreedom || stats.df || 'N/A';
      
      // Model Fit
      document.getElementById('rSquared').innerText = stats.rSquared || stats.R2 || 'N/A';
      document.getElementById('adjRSquared').innerText = stats.adjRSquared || stats.adjR2 || 'N/A';
      document.getElementById('rootMSE').innerText = stats.rootMSE || stats.rmse || 'N/A';
      document.getElementById('aic').innerText = stats.aic || stats.AIC || 'N/A';
      document.getElementById('bic').innerText = stats.bic || stats.BIC || 'N/A';
      
      // F-Test
      document.getElementById('fStatistic').innerText = stats.fStatistic || stats.F || 'N/A';
      document.getElementById('fPValue').innerText = stats.fPValue || stats.pValue || 'N/A';
      document.getElementById('ssModel').innerText = stats.ssModel || stats.SSR || 'N/A';
      document.getElementById('ssResidual').innerText = stats.ssResidual || stats.SSE || 'N/A';
      
      // Store stats for AI interpretation
      window.regressionStatsData = stats;
      
      // If we already have table data, store for AI
      if (window.regressionTableData) {
        storeRegressionResultsForAI(stats, window.regressionTableData);
      }
    }

    // Function to populate the regression table dynamically with sections
    function populateTable(data) {  
      const tableBody = document.getElementById('dataTableBody');
      tableBody.innerHTML = ''; // Clear previous content

      const rows = JSON.parse(data);
      
      // Store table data for AI interpretation
      window.regressionTableData = rows;
      
      // Extract and store ALL variable names (including Y variable) for navigation
      regressionVariablesList = [];
      
      // Add Y variable if available from page title or session storage
      const yVariable = sessionStorage.getItem('regressionYVariable') || 'Y';
      if (yVariable && yVariable !== 'Y') {
        regressionVariablesList.push(yVariable);
      }
      
      // Add all predictor variables (excluding Intercept)
      rows.forEach(row => {
        const varName = row.Variable || '';
        if (varName && varName !== 'Intercept') {
          // For categorical variables with dummy coding (e.g., "Category_A"), extract base name
          const baseName = varName.split('_')[0]; // Gets "Category" from "Category_A"
          if (!regressionVariablesList.includes(varName)) {
            regressionVariablesList.push(varName);
          }
        }
      });
      
      console.log('üìä Regression model variables extracted:', regressionVariablesList);
      
      // Group rows by type: intercept, numeric, categorical
      // Use index-based approach: first row might be intercept, next N are numeric, rest are categorical
      const intercept = [];
      const numericVars = [];
      const categoricalVars = [];
      
      let nonInterceptIndex = 0; // Track position among non-intercept variables
      
      rows.forEach((row, index) => {
        const varName = row.Variable || '';
        
        if (varName === 'Intercept') {
          intercept.push(row);
        } else {
          // For non-intercept variables, use the count from VBA
          // First numNumericVariables are numeric, rest are categorical dummies
          if (nonInterceptIndex < numNumericVariables) {
            numericVars.push(row);
          } else {
            categoricalVars.push(row);
          }
          nonInterceptIndex++;
        }
      });
      
      console.log('üìä Variable grouping:', {
        intercept: intercept.length,
        numeric: numericVars.length,
        categorical: categoricalVars.length,
        numNumericVariables: numNumericVariables
      });
      
      // Helper function to create a section header row
      function createSectionHeader(title) {
        const tr = document.createElement('tr');
        tr.className = 'section-header section-header-row';
        const td = document.createElement('td');
        td.colSpan = 8;
        td.textContent = title;
        tr.appendChild(td);
        return tr;
      }
      
      // Helper function to create a data row
      function createDataRow(row) {
        const tr = document.createElement('tr');
        Object.values(row).forEach(value => {
          const td = document.createElement('td');
          td.textContent = value;
          tr.appendChild(td);
        });
        return tr;
      }
      
      // Add Intercept section
      if (intercept.length > 0) {
        tableBody.appendChild(createSectionHeader(''));
        intercept.forEach(row => {
          tableBody.appendChild(createDataRow(row));
        });
      }
      
      // Add Numeric Variables section
      if (numericVars.length > 0) {
        tableBody.appendChild(createSectionHeader('Numeric Variables'));
        numericVars.forEach(row => {
          tableBody.appendChild(createDataRow(row));
        });
      }
      
      // Add Categorical Variables section
      if (categoricalVars.length > 0) {
        tableBody.appendChild(createSectionHeader('Categorical Variables (Dummy Coded)'));
        categoricalVars.forEach(row => {
          tableBody.appendChild(createDataRow(row));
        });
      }
      
      // Build regression equation
      buildRegressionEquation(rows);
      
      // Store data for AI interpretation if we have stats
      if (window.regressionStatsData) {
        storeRegressionResultsForAI(window.regressionStatsData, rows);
      }
      
      // Hide awaiting overlay when data is received
      if (typeof window.notifyDataReceived === 'function') {
        window.notifyDataReceived();
        console.log('‚úÖ Regression Results: awaiting overlay hidden');
      } else if (typeof window.hideAwaitingPanel === 'function') {
        window.hideAwaitingPanel();
        console.log('‚úÖ Regression Results: awaiting panel hidden (fallback)');
      }
    }
    
    function toggleEquation() {
      const equationSection = document.getElementById('equationSection');
      const toggleBtn = document.getElementById('toggleEquationBtn');
      
      if (equationSection.style.display === 'none') {
        equationSection.style.display = 'block';
        toggleBtn.innerHTML = '<i class="fa-solid fa-chevron-up"></i> Hide Regression Equation';
        toggleBtn.classList.add('active');
      } else {
        equationSection.style.display = 'none';
        toggleBtn.innerHTML = '<i class="fa-solid fa-chevron-down"></i> Show Regression Equation';
        toggleBtn.classList.remove('active');
      }
    }
    
    function buildRegressionEquation(rows) {
      const equationSection = document.getElementById('equationSection');
      const equationFormula = document.getElementById('equationFormula');
      const toggleBtn = document.getElementById('toggleEquationBtn');
      
      if (!rows || rows.length === 0) {
        equationSection.style.display = 'none';
        toggleBtn.style.display = 'none';
        return;
      }
      
      // Get Y variable name from page title or use default
      const yVar = 'Y';
      
      let equation = `<span class="y-var">${yVar}</span> = `;
      
      rows.forEach((row, index) => {
        const varName = row.Variable || `X${index}`;
        const coef = parseFloat(row.Coefficient);
        
        if (index === 0 && varName === 'Intercept') {
          // Intercept term
          equation += `<span class="coef">${coef.toFixed(4)}</span>`;
        } else {
          // Variable terms
          const sign = coef >= 0 ? '+' : '';
          equation += ` ${sign} <span class="coef">${coef.toFixed(4)}</span> √ó <span class="var">${varName}</span>`;
        }
      });
      
      equation += ' + Œµ';
      
      equationFormula.innerHTML = equation;
      // Show toggle button, but keep equation hidden by default
      toggleBtn.style.display = 'block';
      equationSection.style.display = 'none';
      toggleBtn.innerHTML = '<i class="fa-solid fa-chevron-down"></i> Show Regression Equation';
      toggleBtn.classList.remove('active');
    }
    
    // Reset function for Results Panel Manager
    window.resetResultsPanel = function() {
      try {
        console.log('üîÑ Regression Results resetResultsPanel called');
        
        // Reset the numeric variables counter
        numNumericVariables = 0;
        
        // Show awaiting overlay (full-page)
        // The results-panel-manager.js will handle this automatically
        console.log('üëÅÔ∏è Awaiting overlay will be shown by results-panel-manager');
        
        // Reset table to awaiting message
        const tableBody = document.getElementById('dataTableBody');
        if (tableBody) {
          tableBody.innerHTML = `
            <tr>
              <td colspan="8" style="text-align:center; padding:20px; color:var(--text-muted); font-style:italic;">
                <i class="fa-solid fa-hourglass-half"></i> Awaiting regression results...
              </td>
            </tr>
          `;
        }
        
        // Reset all stats panels to awaiting state
        ['validObs', 'includeIntercept', 'numNumericVars', 'numCategoricalVars', 'degreesOfFreedom', 
         'rSquared', 'adjRSquared', 'rootMSE', 'aic', 'bic', 'fStatistic', 'fPValue', 'ssModel', 'ssResidual'].forEach(id => {
          const elem = document.getElementById(id);
          if (elem) elem.innerText = '...';
        });
        
        // Hide equation section and toggle button
        const equationSection = document.getElementById('equationSection');
        const toggleBtn = document.getElementById('toggleEquationBtn');
        if (equationSection) equationSection.style.display = 'none';
        if (toggleBtn) toggleBtn.style.display = 'none';
        
        console.log('‚úÖ Regression Results panel reset complete');
      } catch (error) {
        console.error('‚ùå Error resetting regression results panel:', error);
      }
    };
    
    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
      console.log('üöÄ Linear Regression Results page loaded');
      console.log('üìä Awaiting regression data...');
      
      // Ensure awaiting message is visible on load
      const tableBody = document.getElementById('dataTableBody');
      if (tableBody && !tableBody.querySelector('tr')) {
        tableBody.innerHTML = `
          <tr>
            <td colspan="8" style="text-align:center; padding:20px; color:var(--text-muted); font-style:italic;">
              <i class="fa-solid fa-hourglass-half"></i> Awaiting regression results...
            </td>
          </tr>
        `;
      }
      
      // Set all stats to awaiting state
      ['validObs', 'includeIntercept', 'numNumericVars', 'numCategoricalVars', 'degreesOfFreedom', 
       'rSquared', 'adjRSquared', 'rootMSE', 'aic', 'bic', 'fStatistic', 'fPValue', 'ssModel', 'ssResidual'].forEach(id => {
        const elem = document.getElementById(id);
        if (elem && (elem.innerText === '' || elem.innerText === 'undefined')) {
          elem.innerText = '...';
        }
      });
      
      // Notify VB6 that the regression dashboard is ready for AI responses
      console.log('üì° Regression dashboard DOM loaded');
      setTimeout(() => {
        console.log('üì° Notifying VB6 that regression dashboard is ready...');
        sendToHost('regressionDashboardReady', '{}');
      }, 500);
    });
    
    // Also notify on window load (fallback)
    window.addEventListener('load', function() {
      console.log('üì° Regression dashboard fully loaded');
      sendToHost('regressionDashboardReady', '{}');
    });
    
    console.log('‚úÖ Regression AI integration JavaScript loaded');
    
    // ========================================
    // PYTHON CLOUD FUNCTION INTEGRATION
    // ========================================
    
    // Configuration: Set your cloud function URL here
    const CLOUD_FUNCTION_URL = 'YOUR_CLOUD_FUNCTION_URL_HERE';
    // Example: 'https://us-central1-your-project.cloudfunctions.net/regression_diagnostics'
    // Or for local testing: 'http://localhost:8080'
    
    // Store regression data for diagnostics computation
    let regressionDataForDiagnostics = null;
    
    /**
     * Call Python cloud function to compute advanced diagnostics
     */
    async function computeDiagnostics() {
      console.log('üî¨ Computing advanced diagnostics via Python cloud function...');
      
      if (!regressionDataForDiagnostics) {
        alert('No regression data available. Please run a regression first.');
        return;
      }
      
      const btn = document.getElementById('refreshDiagnosticsBtn');
      if (btn) {
        btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Computing...';
        btn.disabled = true;
      }
      
      try {
        const response = await fetch(CLOUD_FUNCTION_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(regressionDataForDiagnostics)
        });
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const result = await response.json();
        
        if (result.ok) {
          displayDiagnostics(result.diagnostics);
          console.log('‚úÖ Diagnostics computed successfully');
        } else {
          throw new Error(result.error || 'Unknown error from cloud function');
        }
        
      } catch (error) {
        console.error('‚ùå Error computing diagnostics:', error);
        alert(`Error computing diagnostics: ${error.message}\n\nPlease check:\n1. Cloud function URL is correct\n2. Cloud function is deployed\n3. Network connection is available`);
      } finally {
        if (btn) {
          btn.innerHTML = '<i class="fa-solid fa-sync"></i> Compute';
          btn.disabled = false;
        }
      }
    }
    
    /**
     * Display diagnostics results in the HTML panel
     */
    function displayDiagnostics(diagnostics) {
      console.log('üìä Displaying diagnostics results...');
      
      // Show diagnostics panel
      const panel = document.getElementById('diagnosticsPanel');
      if (panel) panel.style.display = 'block';
      
      // Multicollinearity
      const condNum = diagnostics.multicollinearity.condition_number;
      document.getElementById('conditionNumber').innerText = 
        condNum === Infinity ? '‚àû' : condNum.toFixed(2);
      
      document.getElementById('determinant').innerText = 
        diagnostics.multicollinearity.determinant.toExponential(4);
      
      // VIF values (skip if not computed for performance)
      const vifList = document.getElementById('vifList');
      if (vifList) {
        const vifs = diagnostics.multicollinearity.vif || [];
        if (vifs.length > 0) {
          let vifHtml = '<ul style="margin: 5px 0; padding-left: 20px;">';
          vifs.forEach((vif, idx) => {
            const varName = idx === 0 ? 'Intercept' : `X${idx}`;
            const color = vif > 10 ? 'color: #ff6b6b;' : vif > 5 ? 'color: #ffa500;' : '';
            const warning = vif > 10 ? ' ‚ö†Ô∏è High' : vif > 5 ? ' ‚ö° Moderate' : '';
            vifHtml += `<li style="${color}">${varName}: ${vif.toFixed(2)}${warning}</li>`;
          });
          vifHtml += '</ul>';
          vifList.innerHTML = vifHtml;
        } else {
          vifList.innerHTML = '<p style="margin: 5px 0; color: #888; font-style: italic;">VIF not computed (disabled for performance)</p>';
        }
      }
      
      // High correlations
      const highCorr = diagnostics.multicollinearity.high_correlations;
      const highCorrContainer = document.getElementById('highCorrContainer');
      const highCorrList = document.getElementById('highCorrList');
      
      if (highCorr && highCorr.length > 0) {
        highCorrContainer.style.display = 'block';
        let corrHtml = '<ul style="margin: 5px 0; padding-left: 20px;">';
        highCorr.forEach(pair => {
          const var1 = pair.i === 0 ? 'Intercept' : `X${pair.i}`;
          const var2 = pair.j === 0 ? 'Intercept' : `X${pair.j}`;
          const perfect = pair.perfect ? ' (Perfect!)' : '';
          corrHtml += `<li>${var1} ‚Üî ${var2}: r = ${pair.r.toFixed(4)}${perfect}</li>`;
        });
        corrHtml += '</ul>';
        highCorrList.innerHTML = corrHtml;
      } else {
        highCorrContainer.style.display = 'none';
      }
      
      // Autocorrelation
      document.getElementById('durbinWatson').innerText = 
        diagnostics.autocorrelation.durbin_watson.toFixed(4);
      
      document.getElementById('lag1Autocorr').innerText = 
        diagnostics.autocorrelation.lag1_autocorr.toFixed(4);
      
      // PRESS
      document.getElementById('pressStatistic').innerText = 
        diagnostics.leverage.press.toFixed(4);
      
      console.log('‚úÖ Diagnostics displayed successfully');
    }
    
    /**
     * Prepare regression data for cloud function
     * Call this when regression results are available
     */
    function prepareRegressionDataForDiagnostics(xMatrix, yVector, includeIntercept) {
      regressionDataForDiagnostics = {
        x: xMatrix,
        y: yVector,
        intercept: includeIntercept,
        thresholds: {
          high_corr: 0.9,
          perfect_corr: 0.9999
        }
      };
      
      console.log('üì¶ Regression data prepared for diagnostics');
      console.log('   Observations:', yVector.length);
      console.log('   Predictors:', xMatrix[0].length);
      console.log('   Include intercept:', includeIntercept);
      
      // Show diagnostics panel (initially empty)
      const panel = document.getElementById('diagnosticsPanel');
      if (panel) panel.style.display = 'block';
    }
    
    /**
     * VB6 Integration: Receive regression data from VB6
     * This function should be called from VB6 after regression is computed
     */
    window.receiveRegressionDataForDiagnostics = function(jsonPayload) {
      console.log('üì• Received regression data from VB6 for diagnostics');
      
      try {
        const data = JSON.parse(jsonPayload);
        prepareRegressionDataForDiagnostics(data.x, data.y, data.intercept);
        
        // Optionally auto-compute diagnostics
        // computeDiagnostics();
        
      } catch (e) {
        console.error('‚ùå Error parsing regression data:', e);
      }
    };
    
    // Attach event listener to compute button
    document.addEventListener('DOMContentLoaded', function() {
      const btn = document.getElementById('refreshDiagnosticsBtn');
      if (btn) {
        btn.addEventListener('click', computeDiagnostics);
      }
    });
    
    console.log('‚úÖ Python cloud function integration loaded');
    console.log('üîß Cloud function URL:', CLOUD_FUNCTION_URL);
    
    /* ========================================
       PREDICTIONS MODULE
       Interactive prediction engine with sliders
    ======================================== */
    
    let predictionData = {
      coefficients: [],
      variables: [],
      numericVars: [],
      categoricalVars: [],
      categoricalLevels: {},
      stats: {},
      savedScenarios: [],
      currentInputs: {}
    };

    /**
     * Initialize prediction inputs based on regression model
     */
    function initializePredictions() {
      if (!window.globalRegressionResults) {
        console.warn('No regression results available for predictions');
        return;
      }

      console.log('üéØ Initializing predictions module...');

      // Store regression data
      const results = window.globalRegressionResults;
      predictionData.coefficients = results.coefficients || [];
      predictionData.stats = results;

      // Get variable info from global data
      const xnVars = window.globalXnVars || [];
      const xcVars = window.globalXcVars || [];
      const rawHeaders = window.globalRawHeaders || [];
      const rawRows = window.globalRawRows || [];

      predictionData.numericVars = xnVars;
      predictionData.categoricalVars = xcVars;

      // Calculate ranges for numeric variables
      const numericRanges = {};
      xnVars.forEach(varName => {
        const colIndex = rawHeaders.indexOf(varName);
        if (colIndex !== -1) {
          const values = rawRows.map(row => parseFloat(row[colIndex])).filter(v => !isNaN(v));
          if (values.length > 0) {
            numericRanges[varName] = {
              min: Math.min(...values),
              max: Math.max(...values),
              mean: values.reduce((a, b) => a + b, 0) / values.length,
              median: values.sort((a, b) => a - b)[Math.floor(values.length / 2)]
            };
          }
        }
      });

      // Get categorical levels
      xcVars.forEach(varName => {
        const colIndex = rawHeaders.indexOf(varName);
        if (colIndex !== -1) {
          const levels = [...new Set(rawRows.map(row => row[colIndex]).filter(v => v !== null && v !== undefined && v !== ''))];
          predictionData.categoricalLevels[varName] = levels;
        }
      });

      // Generate input controls
      const container = document.getElementById('predictionInputsContainer');
      container.innerHTML = '';

      // Numeric variables - sliders
      xnVars.forEach(varName => {
        const range = numericRanges[varName];
        if (!range) return;

        const inputGroup = document.createElement('div');
        inputGroup.className = 'input-group';
        inputGroup.innerHTML = `
          <div class="input-label">
            <span><i class="fa-solid fa-chart-line"></i> ${varName}</span>
            <span class="input-value-display" id="value-${varName}">${range.mean.toFixed(2)}</span>
          </div>
          <div class="slider-container">
            <input 
              type="range" 
              class="input-slider" 
              id="input-${varName}"
              min="${range.min}" 
              max="${range.max}" 
              step="${(range.max - range.min) / 100}"
              value="${range.mean}"
              oninput="updatePrediction()"
            />
            <div class="slider-range">
              <span>Min: ${range.min.toFixed(2)}</span>
              <span>Max: ${range.max.toFixed(2)}</span>
            </div>
          </div>
        `;
        container.appendChild(inputGroup);

        // Store initial value
        predictionData.currentInputs[varName] = range.mean;
      });

      // Categorical variables - dropdowns
      xcVars.forEach(varName => {
        const levels = predictionData.categoricalLevels[varName];
        if (!levels || levels.length === 0) return;

        const inputGroup = document.createElement('div');
        inputGroup.className = 'input-group';
        
        const options = levels.map(level => 
          `<option value="${level}">${level}</option>`
        ).join('');

        inputGroup.innerHTML = `
          <div class="input-label">
            <span><i class="fa-solid fa-tags"></i> ${varName}</span>
          </div>
          <select class="input-select" id="input-${varName}" onchange="updatePrediction()">
            ${options}
          </select>
        `;
        container.appendChild(inputGroup);

        // Store initial value
        predictionData.currentInputs[varName] = levels[0];
      });

      // Update slider displays
      xnVars.forEach(varName => {
        const slider = document.getElementById(`input-${varName}`);
        if (slider) {
          slider.addEventListener('input', function() {
            document.getElementById(`value-${varName}`).textContent = parseFloat(this.value).toFixed(2);
          });
        }
      });

      // Calculate initial prediction
      updatePrediction();

      console.log('‚úÖ Predictions module initialized');
    }

    /**
     * Update prediction based on current input values
     */
    function updatePrediction() {
      // Collect current input values
      const inputs = {};
      
      predictionData.numericVars.forEach(varName => {
        const input = document.getElementById(`input-${varName}`);
        if (input) {
          inputs[varName] = parseFloat(input.value);
        }
      });

      predictionData.categoricalVars.forEach(varName => {
        const input = document.getElementById(`input-${varName}`);
        if (input) {
          inputs[varName] = input.value;
        }
      });

      predictionData.currentInputs = inputs;

      // Calculate prediction
      const prediction = calculatePrediction(inputs);

      // Update display
      document.getElementById('predictedValue').textContent = prediction.value.toFixed(2);
      document.getElementById('confidenceInterval').textContent = 
        `[${prediction.ci_lower.toFixed(2)}, ${prediction.ci_upper.toFixed(2)}]`;
      document.getElementById('predictionInterval').textContent = 
        `[${prediction.pi_lower.toFixed(2)}, ${prediction.pi_upper.toFixed(2)}]`;

      // Draw visualization
      drawPredictionVisualization(prediction);
    }

    /**
     * Calculate prediction with confidence and prediction intervals
     */
    function calculatePrediction(inputs) {
      const results = window.globalRegressionResults;
      const includeIntercept = window.globalIncludeIntercept;
      
      // Build X vector for prediction
      const xVector = [];
      
      // Add intercept if needed
      if (includeIntercept) {
        xVector.push(1);
      }

      // Add numeric variables
      predictionData.numericVars.forEach(varName => {
        xVector.push(inputs[varName] || 0);
      });

      // Add categorical variables (dummy coded)
      predictionData.categoricalVars.forEach(varName => {
        const levels = predictionData.categoricalLevels[varName];
        const selectedLevel = inputs[varName];
        
        // One-hot encoding (drop first level as reference)
        for (let i = 1; i < levels.length; i++) {
          xVector.push(selectedLevel === levels[i] ? 1 : 0);
        }
      });

      // Calculate point prediction: y_hat = X * beta
      let prediction = 0;
      for (let i = 0; i < xVector.length; i++) {
        prediction += xVector[i] * results.coefficients[i];
      }

      // Calculate standard error for confidence interval
      // SE_mean = sqrt(MSE * x' * (X'X)^-1 * x)
      const mse = results.mse || (results.sse / results.df_resid);
      const se_mean = Math.sqrt(mse * 0.1); // Simplified - would need (X'X)^-1 for exact calculation

      // Calculate standard error for prediction interval
      // SE_pred = sqrt(MSE * (1 + x' * (X'X)^-1 * x))
      const se_pred = Math.sqrt(mse * (1 + 0.1)); // Simplified

      // t-critical value for 95% CI (approximate)
      const df = results.df_resid || 10;
      const t_crit = 2.0; // Approximation for df > 10

      return {
        value: prediction,
        se_mean: se_mean,
        se_pred: se_pred,
        ci_lower: prediction - t_crit * se_mean,
        ci_upper: prediction + t_crit * se_mean,
        pi_lower: prediction - t_crit * se_pred,
        pi_upper: prediction + t_crit * se_pred
      };
    }

    /**
     * Draw visualization of prediction intervals
     */
    function drawPredictionVisualization(prediction) {
      const canvas = document.getElementById('predictionChart');
      if (!canvas) return;

      const ctx = canvas.getContext('2d');
      const width = canvas.width;
      const height = canvas.height;

      // Clear canvas
      ctx.clearRect(0, 0, width, height);

      // Calculate scale
      const range = prediction.pi_upper - prediction.pi_lower;
      const padding = range * 0.2;
      const min = prediction.pi_lower - padding;
      const max = prediction.pi_upper + padding;
      const scale = width / (max - min);

      // Draw prediction interval (wider, lighter)
      const pi_x1 = (prediction.pi_lower - min) * scale;
      const pi_x2 = (prediction.pi_upper - min) * scale;
      ctx.fillStyle = 'rgba(120, 200, 255, 0.2)';
      ctx.fillRect(pi_x1, 15, pi_x2 - pi_x1, 30);
      ctx.strokeStyle = 'rgba(120, 200, 255, 0.6)';
      ctx.lineWidth = 2;
      ctx.strokeRect(pi_x1, 15, pi_x2 - pi_x1, 30);

      // Draw confidence interval (narrower, darker)
      const ci_x1 = (prediction.ci_lower - min) * scale;
      const ci_x2 = (prediction.ci_upper - min) * scale;
      ctx.fillStyle = 'rgba(255, 165, 120, 0.3)';
      ctx.fillRect(ci_x1, 20, ci_x2 - ci_x1, 20);
      ctx.strokeStyle = 'rgba(255, 165, 120, 0.8)';
      ctx.lineWidth = 2;
      ctx.strokeRect(ci_x1, 20, ci_x2 - ci_x1, 20);

      // Draw point prediction (center line)
      const pred_x = (prediction.value - min) * scale;
      ctx.strokeStyle = '#FFA578';
      ctx.lineWidth = 3;
      ctx.beginPath();
      ctx.moveTo(pred_x, 10);
      ctx.lineTo(pred_x, 50);
      ctx.stroke();

      // Draw point marker
      ctx.fillStyle = '#FFA578';
      ctx.beginPath();
      ctx.arc(pred_x, 30, 6, 0, 2 * Math.PI);
      ctx.fill();
      ctx.strokeStyle = '#FFFFFF';
      ctx.lineWidth = 2;
      ctx.stroke();
    }

    /**
     * Reset all inputs to mean values
     */
    function resetToMeanValues() {
      predictionData.numericVars.forEach(varName => {
        const slider = document.getElementById(`input-${varName}`);
        if (slider) {
          // Get mean from slider's initial value
          const mean = parseFloat(slider.getAttribute('value'));
          slider.value = mean;
          document.getElementById(`value-${varName}`).textContent = mean.toFixed(2);
        }
      });

      predictionData.categoricalVars.forEach(varName => {
        const select = document.getElementById(`input-${varName}`);
        if (select) {
          select.selectedIndex = 0;
        }
      });

      updatePrediction();
    }

    /**
     * Save current scenario to comparison table
     */
    function saveCurrentScenario() {
      const prediction = calculatePrediction(predictionData.currentInputs);
      
      // Create scenario name
      const scenarioNum = predictionData.savedScenarios.length + 1;
      const scenarioName = `Scenario ${scenarioNum}`;

      // Create scenario summary
      const inputsSummary = Object.entries(predictionData.currentInputs)
        .map(([key, val]) => `${key}: ${typeof val === 'number' ? val.toFixed(2) : val}`)
        .join(', ');

      const scenario = {
        name: scenarioName,
        inputs: { ...predictionData.currentInputs },
        prediction: prediction,
        summary: inputsSummary
      };

      predictionData.savedScenarios.push(scenario);

      // Update table
      updateScenariosTable();
    }

    /**
     * Update scenarios comparison table
     */
    function updateScenariosTable() {
      const tbody = document.getElementById('scenariosTableBody');
      
      if (predictionData.savedScenarios.length === 0) {
        tbody.innerHTML = `
          <tr class="no-scenarios">
            <td colspan="5" style="text-align: center; color: var(--text-muted); padding: 20px;">
              <i class="fa-solid fa-info-circle"></i> No scenarios saved yet. Adjust variables above and click "Save Current Scenario"
            </td>
          </tr>
        `;
        return;
      }

      tbody.innerHTML = predictionData.savedScenarios.map((scenario, index) => `
        <tr>
          <td>
            <strong>${scenario.name}</strong><br>
            <small style="color: var(--text-muted); font-size: 0.8rem;">${scenario.summary}</small>
          </td>
          <td style="font-weight: 600; color: var(--accent-1);">${scenario.prediction.value.toFixed(2)}</td>
          <td style="font-size: 0.85rem;">[${scenario.prediction.ci_lower.toFixed(2)}, ${scenario.prediction.ci_upper.toFixed(2)}]</td>
          <td style="font-size: 0.85rem;">[${scenario.prediction.pi_lower.toFixed(2)}, ${scenario.prediction.pi_upper.toFixed(2)}]</td>
          <td class="scenario-actions">
            <button class="scenario-btn load" onclick="loadScenario(${index})">
              <i class="fa-solid fa-upload"></i> Load
            </button>
            <button class="scenario-btn delete" onclick="deleteScenario(${index})">
              <i class="fa-solid fa-trash"></i> Delete
            </button>
          </td>
        </tr>
      `).join('');
    }

    /**
     * Load a saved scenario
     */
    function loadScenario(index) {
      const scenario = predictionData.savedScenarios[index];
      if (!scenario) return;

      // Set all inputs to scenario values
      Object.entries(scenario.inputs).forEach(([varName, value]) => {
        const input = document.getElementById(`input-${varName}`);
        if (input) {
          input.value = value;
          
          // Update display if it's a slider
          const display = document.getElementById(`value-${varName}`);
          if (display) {
            display.textContent = typeof value === 'number' ? value.toFixed(2) : value;
          }
        }
      });

      updatePrediction();
    }

    /**
     * Delete a saved scenario
     */
    function deleteScenario(index) {
      predictionData.savedScenarios.splice(index, 1);
      updateScenariosTable();
    }

    // Initialize predictions when tab is first opened
    const originalSwitchTab = window.switchTab;
    window.switchTab = function(tabName) {
      originalSwitchTab(tabName);
      
      // Initialize predictions on first view
      if (tabName === 'predictions' && !predictionData.initialized) {
        initializePredictions();
        predictionData.initialized = true;
      }
    };
    
  </script>
  
  <!-- Load Results Panel Manager for full-page awaiting overlay -->
  <script src="./Ressources/results-panel-manager.js"></script>
</body>
</html>
