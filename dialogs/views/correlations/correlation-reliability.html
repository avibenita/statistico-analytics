<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <title>Reliability Coefficients</title>
  
  <!-- Office.js -->
  <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
  
  <!-- Font Awesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet"/>
  
  <!-- numeric.js for PCA calculations -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/numeric/1.2.6/numeric.min.js"></script>
  
  <!-- Highcharts for gauge and scree plot -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highcharts/10.3.3/highcharts.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highcharts/10.3.3/highcharts-more.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highcharts/10.3.3/modules/solid-gauge.js"></script>
  
  <!-- Shared Header -->
  <link rel="stylesheet" href="../shared-header.css?v=20260206-reliability">
  <script src="../shared-header.js?v=20260206-reliability"></script>

  <style>
    :root {
      --surface-0: #0c1624;
      --surface-1: #1a1f2e;
      --surface-2: #242938;
      --border: #2d3748;
      --accent-1: rgb(255,165,120);
      --accent-2: rgb(120,200,255);
      --text-primary: #fff;
      --text-secondary: rgba(255,255,255,0.8);
      --text-muted: rgba(255,255,255,0.5);
      --pass-color: #2ecc71;
      --fail-color: #e74c3c;
      --panel-radius: 10px;
      --panel-shadow: 0px 4px 10px rgba(0, 0, 0, 0.3);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: linear-gradient(135deg, var(--surface-0) 0%, #1a2332 100%);
      color: var(--text-primary);
      line-height: 1.6;
      padding: 0;
      margin: 0;
      min-height: 100vh;
      overflow-x: hidden;
    }

    .container {
      max-width: 100%;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    .results-container {
      flex: 1;
      padding: 20px;
      overflow: auto;
    }

    .panel-row {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 20px;
      margin: 20px 0;
    }

    .panel {
      background-color: var(--surface-1);
      border-radius: var(--panel-radius);
      box-shadow: var(--panel-shadow);
      border: 2px solid var(--border);
      flex: 0 0 auto;
      min-width: 280px;
      max-width: 800px;
      display: flex;
      flex-direction: column;
    }

    .panel-heading {
      background-color: rgba(0,0,0,0.3);
      color: var(--accent-1);
      font-weight: 600;
      padding: 12px 15px;
      font-size: 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid var(--border);
    }

    .panel-body {
      padding: 15px;
    }

    .normality-dashboard {
      display: flex;
      flex-direction: column;
      gap: 15px;
      width: 100%;
    }

    .top-row {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      justify-content: space-between;
    }

    .summary-stats {
      flex: 1;
      min-width: 250px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      padding: 8px;
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
    }

    .stat-item {
      text-align: center;
    }

    .stat-value {
      font-size: clamp(18px, 2vw, 24px);
      font-weight: bold;
      color: var(--accent-1);
    }

    .stat-label {
      font-size: clamp(10px, 1vw, 12px);
      color: rgba(255, 255, 255, 0.7);
    }

    .gauge-container {
      flex: 1;
      min-width: 200px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      padding: 8px;
      height: 120px;
      position: relative;
    }

    .gauge-title {
      font-size: 14px;
      font-weight: bold;
      text-align: center;
      margin-bottom: 5px;
    }

    .gauge {
      width: 100%;
    }

    #item-stats {
      border-collapse: collapse;
      width: 100%;
      position: relative;
      font-size: 13px;
    }

    #item-stats thead {
      position: sticky;
      top: 0;
      z-index: 1;
      background-color: rgba(255, 255, 255, 0.1);
    }

    #item-stats th, #item-stats td {
      border: 1px solid rgba(255, 255, 255, 0.2);
      padding: 6px 10px;
      text-align: center;
    }

    #item-stats tbody tr:nth-child(even) {
      background-color: rgba(255, 255, 255, 0.05);
    }

    #item-stats tbody tr:hover {
      background-color: rgba(255, 165, 120, 0.1);
    }

    .table-scroll-wrapper {
      max-height: 300px;
      overflow-y: auto;
      position: relative;
    }

    select {
      background-color: var(--surface-2) !important;
      color: var(--text-primary) !important;
      font-size: 14px;
      border-radius: 4px;
      padding: 5px 8px;
      min-width: 160px;
      border: 1px solid var(--border);
    }

    option {
      background-color: var(--surface-2);
      color: var(--text-primary);
      font-size: 14px;
    }

    .pca-button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 8px;
      padding: 12px 24px;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
      margin: 10px 0;
      width: fit-content;
    }

    .pca-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
    }

    .pca-button:active {
      transform: translateY(0);
    }

    .modal {
      display: none;
      position: fixed;
      z-index: 10000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.8);
    }

    .modal-content {
      background-color: var(--surface-1);
      margin: 5% auto;
      padding: 0;
      border-radius: var(--panel-radius);
      width: 80%;
      max-width: 800px;
      max-height: 80vh;
      overflow: hidden;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
      border: 2px solid var(--border);
    }

    .modal-header {
      background-color: rgba(0,0,0,0.3);
      color: var(--accent-1);
      padding: 15px 20px;
      font-weight: bold;
      font-size: 18px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid var(--border);
    }

    .modal-close {
      color: #aaa;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      line-height: 1;
    }

    .modal-close:hover,
    .modal-close:focus {
      color: white;
    }

    .modal-body {
      padding: 20px;
      color: white;
      overflow-y: auto;
      max-height: calc(80vh - 80px);
    }

    .modal-chart-container {
      height: 300px;
      min-height: 300px;
      margin-bottom: 15px;
      width: 100%;
      position: relative;
    }

    .loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 60px 20px;
      gap: 20px;
    }

    .loading i {
      font-size: 48px;
      color: var(--accent-1);
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @media (max-width: 650px) {
      .summary-stats {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .panel-row {
        margin: 10px 0;
      }
    }
  </style>
</head>
<body>
  <div class="container" id="mainContainer" style="display:none;">
    <div id="header-container"></div>

    <div class="results-container">
      <!-- Main Reliability Panel -->
      <div class="panel-row">
        <div class="panel" style="width: 100%; max-width: 800px;">
          <div class="panel-heading">
            <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
              <span>Reliability Analysis</span>
              <label for="alpha-mode" style="font-size: 14px; font-weight: normal; display: flex; align-items: center; gap: 8px;">
                Mode:
                <select id="alpha-mode" style="font-size: 14px; padding: 4px 8px; min-width: 140px;">
                  <option value="raw">Regular</option>
                  <option value="standardized">Standardized</option>
                </select>
              </label>
            </div>
          </div>

          <div class="panel-body">
            <div class="normality-dashboard">
              <div class="top-row">
                <div class="summary-stats">
                  <div class="stat-item">
                    <div class="stat-value" id="alpha-value">‚Äî</div>
                    <div class="stat-label">Cronbach Œ±</div>
                  </div>
                  <div class="stat-item">
                    <div class="stat-value" id="omega-value">‚Äî</div>
                    <div class="stat-label">McDonald œâ</div>
                  </div>
                  <div class="stat-item">
                    <div class="stat-value" id="item-count">‚Äî</div>
                    <div class="stat-label">Items</div>
                  </div>
                  <div class="stat-item">
                    <div class="stat-value" id="subject-count">‚Äî</div>
                    <div class="stat-label">Subjects</div>
                  </div>
                </div>

                <div class="gauge-container">
                  <div class="gauge-title">Cronbach Œ±</div>
                  <div id="reliability-gauge" class="gauge"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Item Statistics Panel -->
      <div class="panel-row">
        <div class="panel" style="flex: 1;">
          <div class="panel-heading">
            Item Statistics
          </div>
          <div class="panel-body">
            <div class="stats-container">
              <div class="table-scroll-wrapper">
                <table id="item-stats" class="table table-striped">
                  <thead>
                    <tr style="border-bottom: 1px solid rgba(255, 255, 255, 0.3);">
                      <th>Item</th>
                      <th>Mean</th>
                      <th>SD</th>
                      <th>Item-Total Corr</th>
                      <th>Œ± if Deleted</th>
                      <th>N if Deleted</th>
                    </tr>
                  </thead>
                  <tbody id="stats-body"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- PCA Panel -->
      <div class="panel-row">
        <div class="panel" style="flex: 1;">
          <div class="panel-heading">
            Unidimensionality Check (PCA - Principal Components Analysis)
          </div>
          <div class="panel-body" style="padding: 10px 15px;">
            <button class="pca-button" id="show-pca-btn">
              <i class="fas fa-chart-line"></i>
              Show PCA Analysis
            </button>
            <div id="pca-summary" style="margin-top: 8px; font-size: 13px; color: rgba(255, 255, 255, 0.9);">
              Click the button above to view the scree plot and unidimensionality assessment.
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- PCA Modal -->
  <div id="pca-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <span>Principal Component Analysis - Scree Plot</span>
        <span class="modal-close">&times;</span>
      </div>
      <div class="modal-body">
        <div id="modal-scree-chart" class="modal-chart-container"></div>
        <div id="modal-uni-comment" style="font-size: 16px; text-align: center; margin-top: 15px;">
          Loading analysis...
        </div>
        <div style="margin-top: 20px; padding: 15px; background: rgba(255, 255, 255, 0.1); border-radius: 8px;">
          <h4 style="margin-top: 0; color: var(--accent-1);">Interpretation Guide:</h4>
          <ul style="margin-bottom: 0; color: rgba(255, 255, 255, 0.9);">
            <li><strong>‚â• 40% variance explained:</strong> Likely unidimensional scale</li>
            <li><strong>< 40% variance explained:</strong> Possible multidimensionality - consider subscales</li>
            <li><strong>Scree plot:</strong> Look for an "elbow" where eigenvalues level off</li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading Message -->
  <div id="loadingMessage" class="loading">
    <i class="fa-solid fa-spinner"></i>
    <p>Loading reliability data...</p>
  </div>

  <script>
    let lastData = [], lastVarNames = [];
    let originalRawData = [];
    let pcaData = null;

    // Office.js initialization
    Office.onReady(() => {
      console.log('‚úÖ Office.js ready for Reliability Analysis');
      
      // Send ready message
      Office.context.ui.messageParent(JSON.stringify({ action: 'ready' }));
      
      // Listen for data from parent
      Office.context.ui.addHandlerAsync(
        Office.EventType.DialogParentMessageReceived,
        (arg) => {
          try {
            const message = JSON.parse(arg.message);
            console.log('üì© Received message:', message.type);
            
            if (message.type === 'CORRELATION_DATA' && message.payload) {
              const data = message.payload;
              console.log('üìä Reliability data received:', data);
              
              // Store original data
              originalRawData = data.data;
              
              // Convert to array format and run analysis
              const dataArrays = data.data.map(row => 
                data.headers.map(header => row[header])
              );
              
              runReliabilityAnalysis(dataArrays, data.headers);
            }
          } catch (error) {
            console.error('‚ùå Error parsing message:', error);
          }
        }
      );
      
      // Try localStorage as fallback
      setTimeout(() => {
        checkLocalStorage();
      }, 500);
    });

    function checkLocalStorage() {
      const correlationData = localStorage.getItem('correlationResults');
      if (correlationData) {
        try {
          const data = JSON.parse(correlationData);
          console.log('üì¶ Found correlation data in localStorage');
          
          originalRawData = data.data;
          
          const dataArrays = data.data.map(row => 
            data.headers.map(header => row[header])
          );
          
          runReliabilityAnalysis(dataArrays, data.headers);
        } catch (error) {
          console.error('‚ùå Error loading from localStorage:', error);
        }
      }
    }

    function runReliabilityAnalysis(data, varnames) {
      console.log('üîÑ Running reliability analysis...');
      console.log(`üìä Data: ${data.length} rows √ó ${varnames.length} columns`);
      const isFiniteNumber = (value) => typeof value === 'number' && isFinite(value);
      
      // Remove rows with non-finite values (NaN/Infinity)
      const cleanedData = data.filter(row => row.every(isFiniteNumber));
      if (cleanedData.length !== data.length) {
        console.warn(`‚ö†Ô∏è Removed ${data.length - cleanedData.length} rows with non-finite values`);
      }

      lastData = cleanedData;
      lastVarNames = varnames;

      if (!Array.isArray(cleanedData) || cleanedData.length === 0 || !Array.isArray(cleanedData[0])) {
        console.error('‚ùå Invalid data structure');
        return;
      }

      const transpose = m => m[0].map((_, i) => m.map(row => row[i]));
      const mean = arr => arr.reduce((a, b) => a + b, 0) / arr.length;
      const sd = arr => {
        const avg = mean(arr);
        return Math.sqrt(arr.reduce((sum, v) => sum + Math.pow(v - avg, 2), 0) / (arr.length - 1));
      };
      const pearson = (x, y) => {
        const avgX = mean(x), avgY = mean(y);
        const num = x.reduce((sum, xi, i) => sum + (xi - avgX) * (y[i] - avgY), 0);
        const den = Math.sqrt(x.reduce((sum, xi) => sum + Math.pow(xi - avgX, 2), 0) * y.reduce((sum, yi) => sum + Math.pow(yi - avgY, 2), 0));
        return den === 0 ? NaN : num / den;
      };

      const numItems = varnames.length;
      const numSubjects = cleanedData.length;
      
      // Identify zero-variance items
      const allItems = transpose(cleanedData);
      const zeroVarianceIndices = [];
      allItems.forEach((item, idx) => {
        const itemSD = sd(item);
        if (itemSD === 0 || isNaN(itemSD) || !isFinite(itemSD)) {
          zeroVarianceIndices.push(idx);
          console.warn(`‚ö†Ô∏è Variable "${varnames[idx]}" has zero variance`);
        }
      });
      
      // Filter out zero-variance items
      const validIndices = allItems.map((_, idx) => idx).filter(idx => !zeroVarianceIndices.includes(idx));
      const filteredData = cleanedData.map(row => validIndices.map(idx => row[idx]));
      
      const alphaMode = document.getElementById("alpha-mode")?.value || "raw";
      const isStandardized = alphaMode === "standardized";
      
      const items = transpose(cleanedData);
      const itemMeans = [], itemSDs = [], itemTotalCorrs = [], alphaIfDeleted = [], nIfDeleted = [];
      
      if (isStandardized) {
        const standardizedItems = items.map(item => {
          const itemMean = mean(item);
          const itemSD = sd(item);
          if (!itemSD || !isFinite(itemSD)) {
            console.warn('‚ö†Ô∏è Standardization skipped due to zero variance');
            return item.map(() => 0);
          }
          return item.map(val => (val - itemMean) / itemSD);
        });
        
        const standardizedData = cleanedData.map((_, rowIdx) => 
          standardizedItems.map(item => item[rowIdx])
        );
        
        const standardizedTotalScores = standardizedData.map(row => row.reduce((a, b) => a + b, 0));
        
        for (let i = 0; i < numItems; i++) {
          const standardizedItem = standardizedItems[i];
          const totalWithoutItem = standardizedTotalScores.map((total, j) => total - standardizedItem[j]);
          
          itemMeans.push(0);
          itemSDs.push(1);
          itemTotalCorrs.push(pearson(standardizedItem, totalWithoutItem));
          
          const reduced = standardizedItems.slice(0, i).concat(standardizedItems.slice(i + 1));
          const reducedMatrix = standardizedData.map((_, j) => reduced.map(col => col[j]));
          alphaIfDeleted.push(cronbachAlphaStandardized(reducedMatrix));
          nIfDeleted.push(reducedMatrix.length);
        }
      } else {
        const totalScores = cleanedData.map(row => row.reduce((a, b) => a + b, 0));
        
        for (let i = 0; i < numItems; i++) {
          const item = items[i];
          const totalWithoutItem = totalScores.map((total, j) => total - item[j]);
          itemMeans.push(mean(item));
          itemSDs.push(sd(item));
          itemTotalCorrs.push(pearson(item, totalWithoutItem));
          
          const reduced = items.slice(0, i).concat(items.slice(i + 1));
          const reducedMatrix = cleanedData.map((_, j) => reduced.map(col => col[j]));
          if (reducedMatrix.length >= 2 && reducedMatrix[0].length >= 2) {
            alphaIfDeleted.push(cronbachAlpha(reducedMatrix));
            nIfDeleted.push(reducedMatrix.length);
          } else {
            alphaIfDeleted.push(NaN);
            nIfDeleted.push(reducedMatrix.length);
          }
        }
      }

      // Calculate alpha
      const alpha = validIndices.length > 1
        ? (isStandardized 
            ? cronbachAlphaStandardized(filteredData)
            : cronbachAlpha(filteredData))
        : NaN;

      const omega = calculateOmegaFromPCA(cleanedData);
      
      document.getElementById("alpha-value").textContent = validIndices.length > 1 ? alpha.toFixed(3) : "N/A";
      document.getElementById("omega-value").textContent = omega.toFixed(3);
      document.getElementById("item-count").textContent = validIndices.length;
      document.getElementById("subject-count").textContent = numSubjects;

      // Populate table
      const tableBody = document.getElementById("stats-body");
      tableBody.innerHTML = "";
      for (let i = 0; i < numItems; i++) {
        const nValue = nIfDeleted[i];
        const nDisplay = isNaN(nValue) ? 'N/A' : nValue;
        const nStyle = nValue > numSubjects ? 'color: #2ecc71; font-weight: bold;' : '';
        
        tableBody.innerHTML += `<tr style="border-bottom: 1px solid rgba(255, 255, 255, 0.1);">
          <td>${varnames[i]}</td>
          <td>${itemMeans[i].toFixed(2)}</td>
          <td>${itemSDs[i].toFixed(2)}</td>
          <td>${itemTotalCorrs[i].toFixed(2)}</td>
          <td>${alphaIfDeleted[i].toFixed(3)}</td>
          <td style="${nStyle}">${nDisplay}</td>
        </tr>`;
      }

      storePCAData(cleanedData);
      renderGauge(alpha);
      
      // Hide loading, show results
      document.getElementById('loadingMessage').style.display = 'none';
      document.getElementById('mainContainer').style.display = 'flex';
      
      // Initialize header
      const sampleSize = numSubjects;
      StatisticoHeader.init('correlation-reliability', 'Reliability Coefficients', sampleSize, 'correlations');
    }

    function cronbachAlpha(matrix) {
      const k = matrix[0].length;
      const transpose = m => m[0].map((_, i) => m.map(row => row[i]));
      const variance = arr => {
        const avg = arr.reduce((a, b) => a + b, 0) / arr.length;
        return arr.reduce((sum, x) => sum + Math.pow(x - avg, 2), 0) / (arr.length - 1);
      };
      const items = transpose(matrix);
      const itemVars = items.map(variance);
      const totalScores = matrix.map(row => row.reduce((a, b) => a + b));
      const totalVar = variance(totalScores);
      return (k / (k - 1)) * (1 - itemVars.reduce((a, b) => a + b) / totalVar);
    }

    function cronbachAlphaStandardized(matrix) {
      const k = matrix[0].length;
      const transpose = m => m[0].map((_, i) => m.map(row => row[i]));
      const correlation = (x, y) => {
        const mx = x.reduce((a, b) => a + b) / x.length;
        const my = y.reduce((a, b) => a + b) / y.length;
        const cov = x.map((xi, i) => (xi - mx) * (y[i] - my)).reduce((a, b) => a + b, 0);
        const sx = Math.sqrt(x.map(xi => (xi - mx) ** 2).reduce((a, b) => a + b, 0));
        const sy = Math.sqrt(y.map(yi => (yi - my) ** 2).reduce((a, b) => a + b, 0));
        return cov / (sx * sy);
      };
      const items = transpose(matrix);
      let rSum = 0, count = 0;
      for (let i = 0; i < k; i++) {
        for (let j = i + 1; j < k; j++) {
          rSum += correlation(items[i], items[j]);
          count++;
        }
      }
      const rBar = rSum / count;
      return (k * rBar) / (1 + (k - 1) * rBar);
    }

    function getEigenvaluesFromCov(cov) {
      try {
        const eig = numeric.eig(cov);
        return eig.lambda.x;
      } catch (error) {
        console.warn('‚ö†Ô∏è numeric.eig failed, falling back to SVD:', error);
        const svd = numeric.svd(cov);
        if (!svd || !svd.S) {
          throw error;
        }
        return svd.S;
      }
    }

    function calculateOmegaFromPCA(data) {
      try {
        const X = numeric.clone(data);
        const n = X.length, k = X[0].length;
        for (let j = 0; j < k; j++) {
          const mean = X.reduce((a, row) => a + row[j], 0) / n;
          for (let i = 0; i < n; i++) X[i][j] -= mean;
        }
        const Xt = numeric.transpose(X);
        const cov = numeric.dot(Xt, X);
        let vec = null;
        try {
          const eig = numeric.eig(cov);
          vec = eig.E.x.map(row => row[0]);
        } catch (error) {
          console.warn('‚ö†Ô∏è numeric.eig failed for omega, falling back to SVD:', error);
          const svd = numeric.svd(cov);
          if (svd && svd.V) {
            vec = svd.V.map(row => row[0]);
          }
        }
        if (!vec) {
          return NaN;
        }
        const norm = Math.sqrt(vec.reduce((s, x) => s + x * x, 0));
        const loadings = vec.map(x => x / norm);
        const sumLoad = loadings.reduce((a, b) => a + b, 0);
        const omega = Math.pow(sumLoad, 2) / (Math.pow(sumLoad, 2) + loadings.map(l => 1 - l * l).reduce((a, b) => a + b, 0));
        return omega;
      } catch (error) {
        console.error('Error calculating omega:', error);
        return NaN;
      }
    }

    function storePCAData(data) {
      console.log('üî¨ Calculating PCA...');
      
      try {
        // Check if numeric.js is loaded
        if (typeof numeric === 'undefined') {
          console.error('‚ùå numeric.js not loaded!');
          throw new Error('numeric.js library not available');
        }

        const alphaMode = document.getElementById("alpha-mode")?.value || "raw";
        console.log('Mode:', alphaMode);
        
        let X = numeric.clone(data);
        const n = X.length, k = X[0].length;
        console.log(`Data: ${n} rows √ó ${k} columns`);

        if (alphaMode === "standardized") {
          // Standardize
          console.log('Standardizing data...');
          for (let j = 0; j < k; j++) {
            const col = X.map(row => row[j]);
            const mean = col.reduce((a, b) => a + b, 0) / n;
            const sd = Math.sqrt(col.reduce((s, x) => s + Math.pow(x - mean, 2), 0) / (n - 1));
            if (sd > 0) {
              for (let i = 0; i < n; i++) {
                X[i][j] = (X[i][j] - mean) / sd;
              }
            }
          }
        } else {
          // Center
          console.log('Centering data...');
          for (let j = 0; j < k; j++) {
            const mean = X.reduce((a, row) => a + row[j], 0) / n;
            for (let i = 0; i < n; i++) X[i][j] -= mean;
          }
        }

        // Calculate covariance matrix
        console.log('Calculating covariance matrix...');
        const Xt = numeric.transpose(X);
        const cov = numeric.dot(Xt, X);
        
        // Scale by n-1
        for (let i = 0; i < cov.length; i++) {
          for (let j = 0; j < cov[i].length; j++) {
            cov[i][j] = cov[i][j] / (n - 1);
          }
        }
        
        // Calculate eigenvalues
        console.log('Calculating eigenvalues...');
        let eigenvalues = getEigenvaluesFromCov(cov);
        
        eigenvalues = eigenvalues.map(val => Math.max(0, Math.abs(val)));
        if (!eigenvalues.length || eigenvalues.some(val => !isFinite(val))) {
          throw new Error('Invalid eigenvalues from PCA');
        }
        eigenvalues.sort((a, b) => b - a);
        
        const totalVariance = eigenvalues.reduce((a, b) => a + b, 0);
        const explained = eigenvalues.map(e => totalVariance > 0 ? (e / totalVariance * 100) : 0);
        
        pcaData = {
          eigenvalues,
          explained,
          firstComponentVariance: explained[0] || 0
        };

        console.log("‚úÖ PCA Data calculated successfully:");
        console.log("  Eigenvalues:", eigenvalues);
        console.log("  Variance explained:", explained);
        console.log("  First component:", explained[0].toFixed(1) + "%");

        const summaryElement = document.getElementById("pca-summary");
        if (summaryElement) {
          const varianceText = `First component explains ${explained[0].toFixed(1)}% of variance`;
          const interpretationText = explained[0] > 40 ? 
            '<span style="color: #2ecc71;">‚úì Likely unidimensional</span>' : 
            '<span style="color: #f39c12;">‚ö† Possible multidimensionality</span>';
          summaryElement.innerHTML = `${varianceText} - ${interpretationText}`;
        }
        
      } catch (error) {
        console.error("‚ùå Error calculating PCA:", error);
        showPcaError(`‚ö† PCA calculation failed: ${error.message}`);
        
        // Don't set pcaData if calculation failed
        pcaData = null;
      }
    }

    function showPcaError(message) {
      const summaryElement = document.getElementById("pca-summary");
      if (summaryElement) {
        summaryElement.innerHTML = `<span style="color: #e74c3c;">${message}</span>`;
      }
      const commentElement = document.getElementById("modal-uni-comment");
      if (commentElement) {
        commentElement.innerHTML = `<span style="color: #e74c3c;">${message}</span>`;
      }
    }

    function showPCAModal() {
      console.log('üîç Opening PCA modal...');
      
      if (!pcaData && lastData.length > 0) {
        console.log("üìä PCA data not found, recalculating...");
        storePCAData(lastData);
      }
      
      if (!pcaData) {
        console.error('‚ùå No PCA data available');
        showPcaError("‚ö† No PCA data available. Please run the analysis first.");
        return;
      }

      console.log('‚úÖ PCA data found:', pcaData);

      // Check if Highcharts is loaded
      if (typeof Highcharts === 'undefined') {
        console.error('‚ùå Highcharts not loaded!');
        showPcaError('‚ö† Highcharts library not loaded. Please refresh the page.');
        return;
      }

      const modal = document.getElementById("pca-modal");
      if (!modal) {
        console.error('‚ùå Modal element not found!');
        return;
      }
      
      modal.style.display = "block";
      console.log('‚úÖ Modal displayed');

      // Longer timeout to ensure modal is fully rendered
      setTimeout(() => {
        try {
          const chartContainer = document.getElementById('modal-scree-chart');
          if (!chartContainer) {
            console.error('‚ùå Chart container not found!');
            return;
          }

          console.log('üìä Rendering Highcharts scree plot...');
          console.log('Eigenvalues:', pcaData.eigenvalues);
          
          const screeSeriesData = pcaData.eigenvalues.map((val, i) => ({
            y: val,
            variance: pcaData.explained[i] || 0
          }));

          Highcharts.chart('modal-scree-chart', {
            chart: { 
              type: 'line',
              backgroundColor: 'transparent',
              height: 300
            },
            title: { 
              text: 'Scree Plot',
              style: { color: '#fff', fontSize: '18px' }
            },
            xAxis: { 
              categories: pcaData.eigenvalues.map((_, i) => 'PC ' + (i + 1)),
              labels: { style: { color: '#fff' } },
              gridLineColor: 'rgba(255, 255, 255, 0.1)',
              lineColor: 'rgba(255, 255, 255, 0.2)'
            },
            yAxis: { 
              title: { 
                text: 'Eigenvalue',
                style: { color: '#fff' }
              },
              labels: { style: { color: '#fff' } },
              gridLineColor: 'rgba(255, 255, 255, 0.1)',
              lineColor: 'rgba(255, 255, 255, 0.2)',
              min: 0
            },
            legend: {
              itemStyle: { color: '#fff' }
            },
            tooltip: {
              backgroundColor: 'rgba(0, 0, 0, 0.8)',
              style: { color: '#fff' },
              formatter: function() {
                const pcIndex = this.point.index;
                const variance = pcaData.explained[pcIndex];
                return `<b>${this.x}</b><br/>Eigenvalue: ${this.y.toFixed(2)}<br/>Variance: ${variance.toFixed(1)}%`;
              }
            },
            plotOptions: {
              line: {
                marker: {
                  enabled: true
                },
                dataLabels: {
                  enabled: true,
                  formatter: function() {
                    return `${this.point.variance.toFixed(1)}%`;
                  },
                  style: {
                    color: '#fff',
                    fontSize: '11px',
                    textOutline: 'none'
                  },
                  y: -10
                }
              }
            },
            series: [{
              name: 'Eigenvalue', 
              data: screeSeriesData,
              color: 'rgb(255,165,120)',
              lineWidth: 3,
              marker: {
                enabled: true,
                radius: 6,
                fillColor: 'rgb(255,165,120)',
                lineColor: '#fff',
                lineWidth: 2
              }
            }],
            credits: { enabled: false }
          });

          console.log('‚úÖ Highcharts scree plot rendered');

          const commentElement = document.getElementById("modal-uni-comment");
          if (commentElement) {
            const varianceText = `First component explains <strong>${pcaData.firstComponentVariance.toFixed(1)}%</strong> of total variance.`;
            const interpretation = pcaData.firstComponentVariance > 40 ? 
              `<span style='color: #2ecc71; font-weight: bold;'>‚úì Likely unidimensional</span>` : 
              `<span style='color: #f39c12; font-weight: bold;'>‚ö† Possible multidimensionality</span>`;
            commentElement.innerHTML = `${varianceText} ${interpretation}`;
          }
        } catch (error) {
          console.error("‚ùå Error rendering PCA chart:", error);
          const commentElement = document.getElementById("modal-uni-comment");
          if (commentElement) {
            commentElement.innerHTML = `<span style='color: #e74c3c;'>Error rendering chart: ${error.message}<br/>First component: ${pcaData.firstComponentVariance.toFixed(1)}% variance</span>`;
          }
        }
      }, 300);
    }

    function renderGauge(value) {
      if (typeof Highcharts === 'undefined') {
        console.error('Highcharts not loaded');
        return;
      }

      try {
        Highcharts.chart('reliability-gauge', {
          chart: { 
            type: 'gauge',
            backgroundColor: 'transparent',
            plotBackgroundColor: null,
            plotBorderWidth: 0,
            plotShadow: false,
            height: 120
          },
          title: { text: null },
          credits: { enabled: false },
          pane: {
            startAngle: -90,
            endAngle: 90,
            center: ['50%', '75%'],
            size: '110%',
            background: null
          },
          tooltip: { enabled: false },
          yAxis: {
            min: 0,
            max: 1,
            tickPosition: 'inside',
            tickLength: 20,
            tickWidth: 2,
            tickColor: '#666',
            minorTickInterval: null,
            labels: {
              distance: 20,
              style: {
                fontSize: '14px',
                color: '#fff'
              }
            },
            lineWidth: 0,
            plotBands: [
              { from: 0.0, to: 0.5, color: '#DF5353', thickness: 20 },
              { from: 0.5, to: 0.7, color: '#DDDF0D', thickness: 20 },
              { from: 0.7, to: 0.8, color: '#55BF3B', thickness: 20 },
              { from: 0.8, to: 1.0, color: '#339933', thickness: 20 }
            ]
          },
          series: [{
            name: 'Reliability',
            data: [value],
            tooltip: {
              valueSuffix: ''
            },
            dataLabels: {
              format: '<div style="text-align:center"><span style="font-size:25px;color:#fff">{y:.3f}</span></div>',
              y: 10,
              borderWidth: 0
            },
            dial: {
              radius: '80%',
              backgroundColor: 'gray',
              baseWidth: 12,
              baseLength: '0%',
              rearLength: '10%'
            },
            pivot: {
              backgroundColor: 'gray',
              radius: 6
            }
          }]
        });
      } catch (error) {
        console.error('Error rendering gauge:', error);
      }
    }

    // Event listeners
    document.addEventListener("DOMContentLoaded", function () {
      const alphaMode = document.getElementById("alpha-mode");
      if (alphaMode) {
        alphaMode.addEventListener("change", () => {
          if (lastData.length > 0 && lastVarNames.length > 0) {
            runReliabilityAnalysis(lastData, lastVarNames);
          }
        });
      }

      const pcaButton = document.getElementById("show-pca-btn");
      if (pcaButton) {
        pcaButton.addEventListener("click", showPCAModal);
      }

      const modal = document.getElementById("pca-modal");
      const closeBtn = document.querySelector(".modal-close");
      
      if (closeBtn) {
        closeBtn.addEventListener("click", function() {
          modal.style.display = "none";
        });
      }

      window.addEventListener("click", function(event) {
        if (event.target === modal) {
          modal.style.display = "none";
        }
      });
    });
  </script>
</body>
</html>
