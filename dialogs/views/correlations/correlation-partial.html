<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <title>Partial Correlations</title>
  
  <!-- Office.js -->
  <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
  
  <!-- Font Awesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet"/>
  
  <!-- jStat for statistical functions -->
  <script src="https://cdn.jsdelivr.net/npm/jstat@1.9.6/dist/jstat.min.js"></script>
  
  <!-- Shared Header -->
  <link rel="stylesheet" href="../shared-header.css">
  <script src="../shared-header.js"></script>

  <style>
    :root{
      --surface-0:#0c1624;
      --surface-1:#1a1f2e;
      --surface-2:#242938;
      --border:#2d3748;
      --accent-1:rgb(255,165,120);
      --accent-2:rgb(120,200,255);
      --text-primary:#fff;
      --text-secondary:rgba(255,255,255,0.8);
      --text-muted:rgba(255,255,255,0.5);
    }

    *{
      margin:0;
      padding:0;
      box-sizing:border-box;
    }

    body{
      font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,sans-serif;
      background:linear-gradient(135deg, var(--surface-0) 0%, #1a2332 100%);
      color:var(--text-primary);
      line-height:1.6;
      padding:0;
      margin:0;
      min-height:100vh;
      overflow-x:hidden;
    }

    .container{
      max-width:100%;
      margin:0;
      padding:0;
      display:flex;
      flex-direction:column;
      min-height:100vh;
    }

    .results-container{
      flex:1;
      padding:20px;
      overflow:auto;
    }

    /* Control Variables Panel */
    .control-panel{
      background:var(--surface-1);
      padding:20px;
      border-radius:10px;
      border:2px solid var(--border);
      box-shadow:0 4px 20px rgba(0,0,0,0.3);
      margin-bottom:20px;
    }

    .control-panel h3{
      color:var(--accent-1);
      margin-bottom:15px;
      font-size:18px;
    }

    .control-checkboxes{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
    }

    .control-checkboxes label{
      display:flex;
      align-items:center;
      cursor:pointer;
      padding:8px 14px;
      border-radius:6px;
      border:1px solid var(--border);
      background:rgba(255,255,255,0.08);
      color:white;
      font-weight:500;
      font-size:13px;
      transition:all 0.2s ease;
    }

    .control-checkboxes label:hover{
      background:rgba(255,255,255,0.15);
      border-color:var(--accent-1);
    }

    .control-checkboxes label.checked{
      background:rgba(255,165,120,0.25);
      border-color:var(--accent-1);
      box-shadow:0 0 10px rgba(255,165,120,0.3);
    }

    .control-checkboxes label input{
      margin-right:8px;
      accent-color:var(--accent-1);
    }

    /* Matrix Panel */
    .matrix-panel{
      background:var(--surface-1);
      border-radius:10px;
      border:2px solid var(--border);
      box-shadow:0 4px 20px rgba(0,0,0,0.3);
      overflow:hidden;
    }

    .matrix-header{
      background:rgba(0,0,0,0.4);
      padding:15px 20px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      border-bottom:2px solid var(--border);
    }

    .matrix-header h3{
      color:var(--accent-1);
      font-size:16px;
      margin:0;
    }

    .matrix-controls{
      display:flex;
      gap:15px;
      align-items:center;
    }

    .matrix-controls label{
      display:flex;
      align-items:center;
      gap:6px;
      font-size:13px;
      color:var(--text-secondary);
      cursor:pointer;
    }

    .matrix-controls input[type="checkbox"]{
      accent-color:var(--accent-1);
    }

    /* Table Styles */
    .table-container{
      overflow:auto;
      max-height:calc(100vh - 300px);
    }

    table{
      width:100%;
      border-collapse:collapse;
    }

    th{
      background:rgba(0,0,0,0.3);
      color:white;
      padding:10px;
      text-align:center;
      font-size:12px;
      font-weight:600;
      border:1px solid var(--border);
      white-space:nowrap;
      position:sticky;
      top:0;
      z-index:10;
    }

    th:first-child{
      text-align:left;
      min-width:150px;
    }

    td{
      padding:8px;
      text-align:center;
      font-size:12px;
      border:1px solid var(--border);
      background:rgba(255,255,255,0.05);
    }

    td:first-child{
      text-align:left;
      font-weight:600;
      background:rgba(0,0,0,0.4);
      border-right:2px solid rgba(255,165,120,0.3);
    }

    tbody tr:nth-child(even){
      background:rgba(255,255,255,0.08);
    }

    tbody tr:hover{
      background:rgba(255,165,120,0.15);
    }

    .clickable-correlation{
      cursor:pointer;
      text-decoration:underline;
      color:#4cc9f0;
      font-weight:600;
      transition:all 0.2s ease;
      display:block;
    }

    .clickable-correlation:hover{
      color:var(--accent-1);
      transform:scale(1.05);
    }

    .corr-info{
      font-size:10px;
      color:var(--text-muted);
      margin-top:2px;
    }

    td.highlighted{
      background:linear-gradient(135deg, rgba(255,165,120,0.3), rgba(255,165,120,0.2))!important;
      border:2px solid var(--accent-1)!important;
      box-shadow:0 0 15px rgba(255,165,120,0.4);
    }

    /* Modal Styles */
    .correlation-modal{
      display:none;
      position:fixed;
      z-index:1000;
      left:0;
      top:0;
      width:100%;
      height:100%;
      background:rgba(0,0,0,0.6);
      backdrop-filter:blur(2px);
    }

    .modal-content{
      background:var(--surface-1);
      margin:5% auto;
      padding:25px;
      border-radius:12px;
      width:90%;
      max-width:500px;
      box-shadow:0 10px 40px rgba(0,0,0,0.5);
      position:absolute;
      animation:modalSlideIn 0.3s ease;
    }

    @keyframes modalSlideIn{
      from{
        opacity:0;
        transform:translateY(-50px);
      }
      to{
        opacity:1;
        transform:translateY(0);
      }
    }

    .modal-header{
      cursor:move;
      background:rgba(0,0,0,0.4);
      margin:-25px -25px 20px -25px;
      padding:15px 25px;
      border-radius:12px 12px 0 0;
      border-bottom:2px solid var(--border);
      position:relative;
      display:flex;
      align-items:center;
      justify-content:center;
    }

    .modal-header h3{
      margin:0;
      color:var(--text-primary);
      font-size:18px;
    }

    .close-modal{
      position:absolute;
      right:15px;
      top:15px;
      font-size:24px;
      font-weight:bold;
      color:var(--text-muted);
      cursor:pointer;
      line-height:1;
      transition:all 0.2s ease;
    }

    .close-modal:hover{
      color:var(--accent-1);
      transform:scale(1.1);
    }

    .correlation-section{
      margin-bottom:20px;
      padding:15px;
      border-radius:8px;
      background:rgba(255,255,255,0.08);
    }

    .correlation-section h4{
      margin-top:0;
      margin-bottom:10px;
      font-size:16px;
    }

    .regular-section{
      border-left:4px solid var(--accent-1);
    }

    .regular-section h4{
      color:var(--accent-1);
    }

    .partial-section{
      border-left:4px solid var(--accent-2);
    }

    .partial-section h4{
      color:var(--accent-2);
    }

    .correlation-stats{
      display:grid;
      grid-template-columns:1fr 1fr 1fr;
      gap:15px;
      text-align:center;
    }

    .stat-item{
      padding:10px;
      background:rgba(0,0,0,0.3);
      border-radius:6px;
      border:1px solid var(--border);
    }

    .stat-label{
      font-size:11px;
      color:var(--text-muted);
      font-weight:600;
      text-transform:uppercase;
      margin-bottom:5px;
    }

    .stat-value{
      font-size:16px;
      font-weight:600;
      color:white;
    }

    .tip-line{
      text-align:center;
      color:var(--text-muted);
      font-size:13px;
      font-style:italic;
      padding:10px 0;
      margin-bottom:15px;
    }

    /* Responsive Design */
    @media (max-width: 1024px){
      .results-container{
        padding:15px;
      }
      .control-panel{
        padding:15px;
      }
      .matrix-header{
        flex-direction:column;
        gap:10px;
        align-items:flex-start;
      }
    }

    @media (max-width: 768px){
      .results-container{
        padding:10px;
      }
      .control-checkboxes label{
        font-size:12px;
        padding:6px 10px;
      }
      table{
        font-size:11px;
      }
      th, td{
        padding:6px 4px;
      }
      .modal-content{
        width:95%;
        padding:20px;
      }
      .correlation-stats{
        gap:10px;
      }
    }

    @media (max-width: 480px){
      table{
        font-size:10px;
      }
      th, td{
        padding:4px 2px;
      }
      .correlation-stats{
        grid-template-columns:1fr;
      }
    }

    .loading{
      text-align:center;
      padding:60px 20px;
      color:var(--text-secondary);
    }

    .loading i{
      font-size:48px;
      color:var(--accent-1);
      animation:spin 1s linear infinite;
    }

    @keyframes spin{
      0%{transform:rotate(0deg);}
      100%{transform:rotate(360deg);}
    }
  </style>
</head>
<body>
  <div class="container" id="mainContainer" style="display:none;">
    <div id="header-container"></div>

    <div class="results-container">
      <!-- Control Variables Panel -->
      <div class="control-panel">
        <h3>üéõÔ∏è Select Control Variables</h3>
        <div id="controlCheckboxes" class="control-checkboxes"></div>
      </div>

      <div class="tip-line">
        üí° Click correlations to compare ‚Ä¢ Matrix auto-updates when control variables change
      </div>

      <!-- Matrix Panel -->
      <div class="matrix-panel">
        <div class="matrix-header">
          <h3>Partial Correlation Matrix</h3>
          <div class="matrix-controls">
            <label>
              <input id="togglePval" type="checkbox"/>
              <span>Show p-values</span>
            </label>
            <label>
              <input id="toggleN" type="checkbox"/>
              <span>Show df</span>
            </label>
          </div>
        </div>

        <div id="loadingMessage" class="loading">
          <i class="fa-solid fa-spinner"></i>
          <p>Loading partial correlations...</p>
        </div>

        <div class="table-container" id="tableContainer" style="display:none;">
          <table id="correlationTable">
            <thead>
              <tr id="headerRow"></tr>
            </thead>
            <tbody id="tableBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Correlation Details Modal -->
  <div id="correlationModal" class="correlation-modal">
    <div class="modal-content">
      <div class="modal-header" title="Click and drag to move">
        <h3 id="modalTitle">Correlation Details</h3>
        <span class="close-modal">&times;</span>
      </div>
      
      <div class="correlation-section regular-section">
        <h4>üîó Regular Correlation</h4>
        <div class="correlation-stats">
          <div class="stat-item">
            <div class="stat-label">Correlation</div>
            <div class="stat-value" id="regularR">-</div>
          </div>
          <div class="stat-item">
            <div class="stat-label">P-Value</div>
            <div class="stat-value" id="regularP">-</div>
          </div>
          <div class="stat-item">
            <div class="stat-label">DF</div>
            <div class="stat-value" id="regularDF">-</div>
          </div>
        </div>
      </div>
      
      <div class="correlation-section partial-section">
        <h4>üéõÔ∏è Partial Correlation</h4>
        <div class="correlation-stats">
          <div class="stat-item">
            <div class="stat-label">Correlation</div>
            <div class="stat-value" id="partialR">-</div>
          </div>
          <div class="stat-item">
            <div class="stat-label">P-Value</div>
            <div class="stat-value" id="partialP">-</div>
          </div>
          <div class="stat-item">
            <div class="stat-label">DF</div>
            <div class="stat-value" id="partialDF">-</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let correlationData = null;
    let variableNames = [];
    let precomputedCorrelationMatrix = null;
    let precomputedNMatrix = null;

    // Initialize Office.js
    Office.onReady(function(info) {
      console.log('Office initialized in partial correlations dialog');
      
      // Initialize shared header
      if (typeof StatisticoHeader !== 'undefined') {
        StatisticoHeader.init('partial-correlations', 'Partial Correlations', 0, 'correlations');
      }
      
      // Listen for messages from parent
      Office.context.ui.addHandlerAsync(
        Office.EventType.DialogParentMessageReceived,
        onMessageFromParent
      );
      
      // Notify parent that dialog is ready
      Office.context.ui.messageParent(JSON.stringify({
        action: 'ready'
      }));
    });

    /**
     * Handle messages from parent taskpane
     */
    function onMessageFromParent(arg) {
      try {
        const message = JSON.parse(arg.message);
        console.log('Received message from parent:', message);

        if (message.type === 'CORRELATION_DATA' && message.payload) {
          correlationData = message.payload;
          console.log('Correlation data received:', correlationData);
          
          // Extract data
          const { headers, data } = correlationData;
          variableNames = headers;
          
          // Calculate correlation matrix from raw data
          const { correlationMatrix, nMatrix } = calculateCorrelationMatrixFromData(data, headers);
          precomputedCorrelationMatrix = correlationMatrix;
          precomputedNMatrix = nMatrix;
          
          // Update header with correct sample size
          const sampleSize = data ? data.length : 0;
          if (typeof StatisticoHeader !== 'undefined') {
            StatisticoHeader.sampleSize = sampleSize;
            StatisticoHeader.variableName = `${headers.length} Variables`;
            StatisticoHeader.render();
          }
          
          // Initialize interface
          initializeInterface();
          
          // Auto-generate matrix with first variable as control
          setTimeout(() => generatePartialCorrelationMatrix(), 150);
        }
      } catch (error) {
        console.error('Error parsing message:', error);
      }
    }

    /**
     * Calculate correlation matrix from raw data
     */
    function calculateCorrelationMatrixFromData(data, headers) {
      const n = headers.length;
      const correlationMatrix = Array(n).fill(0).map(() => Array(n).fill(0));
      const nMatrix = Array(n).fill(0).map(() => Array(n).fill(0));
      
      for (let i = 0; i < n; i++) {
        for (let j = 0; j < n; j++) {
          if (i === j) {
            correlationMatrix[i][j] = 1.0;
            nMatrix[i][j] = data.length;
          } else {
            const col1 = data.map(row => row[headers[i]]);
            const col2 = data.map(row => row[headers[j]]);
            
            // Filter valid pairs
            const validPairs = [];
            for (let k = 0; k < col1.length; k++) {
              if (col1[k] != null && col2[k] != null && !isNaN(col1[k]) && !isNaN(col2[k])) {
                validPairs.push([col1[k], col2[k]]);
              }
            }
            
            nMatrix[i][j] = validPairs.length;
            
            if (validPairs.length < 2) {
              correlationMatrix[i][j] = 0;
              continue;
            }
            
            // Calculate Pearson correlation
            const x = validPairs.map(p => p[0]);
            const y = validPairs.map(p => p[1]);
            const meanX = x.reduce((a, b) => a + b, 0) / x.length;
            const meanY = y.reduce((a, b) => a + b, 0) / y.length;
            
            let numerator = 0, denomX = 0, denomY = 0;
            for (let k = 0; k < x.length; k++) {
              const dx = x[k] - meanX;
              const dy = y[k] - meanY;
              numerator += dx * dy;
              denomX += dx * dx;
              denomY += dy * dy;
            }
            
            const denom = Math.sqrt(denomX * denomY);
            correlationMatrix[i][j] = denom === 0 ? 0 : numerator / denom;
          }
        }
      }
      
      return { correlationMatrix, nMatrix };
    }

    /**
     * Initialize UI with control variable checkboxes
     */
    function initializeInterface() {
      const controlCheckboxes = document.getElementById('controlCheckboxes');
      if (!controlCheckboxes || !variableNames || variableNames.length === 0) {
        console.warn('Cannot initialize interface');
        return;
      }

      controlCheckboxes.innerHTML = "";
      
      variableNames.forEach((name, i) => {
        const label = document.createElement('label');
        label.innerHTML = `
          <input type="checkbox" value="${i}">
          <span>${name}</span>
        `;
        
        const checkbox = label.querySelector('input');
        checkbox.addEventListener('change', function() {
          const allCheckboxes = document.querySelectorAll('#controlCheckboxes input[type="checkbox"]');
          const checkedCount = Array.from(allCheckboxes).filter(cb => cb.checked).length;
          
          if (checkedCount === variableNames.length) {
            this.checked = false;
            alert('Cannot control for all variables. At least one variable must remain uncontrolled.');
            return;
          }
          
          updateControlVariableStyling();
          
          // Auto-update matrix
          clearTimeout(window.autoUpdateTimeout);
          window.autoUpdateTimeout = setTimeout(() => {
            console.log('üîÑ Control variables changed - auto-updating matrix...');
            generatePartialCorrelationMatrix();
          }, 300);
        });
        
        controlCheckboxes.appendChild(label);
      });
      
      // Auto-check first variable
      const firstCheckbox = controlCheckboxes.querySelector('input[type="checkbox"]');
      if (firstCheckbox) {
        firstCheckbox.checked = true;
        updateControlVariableStyling();
      }
      
      // Show container
      document.getElementById('mainContainer').style.display = 'flex';
    }

    /**
     * Update control variable styling
     */
    function updateControlVariableStyling() {
      const labels = document.querySelectorAll('#controlCheckboxes label');
      labels.forEach(label => {
        const checkbox = label.querySelector('input[type="checkbox"]');
        if (checkbox && checkbox.checked) {
          label.classList.add('checked');
        } else {
          label.classList.remove('checked');
        }
      });
    }

    /**
     * Calculate partial correlation
     */
    function calculatePartialCorrelation(var1Idx, var2Idx, controlIndices) {
      if (!precomputedCorrelationMatrix || !precomputedNMatrix) {
        return { correlation: null, pValue: null, n: 0, df: 0 };
      }
      
      if (controlIndices.length === 0) {
        // Simple correlation
        const r = precomputedCorrelationMatrix[var1Idx][var2Idx];
        const n = precomputedNMatrix[var1Idx][var2Idx];
        const df = n - 2;
        
        let pValue = null;
        if (n > 2 && Math.abs(r) < 0.999) {
          const t = r * Math.sqrt(df / (1 - r * r));
          pValue = 2 * (1 - jStat.studentt.cdf(Math.abs(t), df));
        }
        
        return { correlation: r, pValue, n, df };
      }
      
      // Build correlation submatrix
      const relevantIndices = [var1Idx, var2Idx, ...controlIndices];
      const numVars = relevantIndices.length;
      const n = precomputedNMatrix[var1Idx][var2Idx];
      const df = n - numVars;
      
      if (df <= 0) {
        return { correlation: null, pValue: null, n, df: 0 };
      }
      
      const R = [];
      for (let i = 0; i < numVars; i++) {
        R[i] = [];
        for (let j = 0; j < numVars; j++) {
          const actualIdx1 = relevantIndices[i];
          const actualIdx2 = relevantIndices[j];
          R[i][j] = precomputedCorrelationMatrix[actualIdx1][actualIdx2];
        }
      }
      
      try {
        const P = safeInvertMatrix(R);
        const partialCorr = -P[0][1] / Math.sqrt(P[0][0] * P[1][1]);
        
        let pValue = null;
        if (df > 0 && Math.abs(partialCorr) < 0.999) {
          const t = partialCorr * Math.sqrt(df / (1 - partialCorr * partialCorr));
          pValue = 2 * (1 - jStat.studentt.cdf(Math.abs(t), df));
        }
        
        return { correlation: partialCorr, pValue, n, df };
      } catch (e) {
        console.warn("Matrix inversion failed:", e);
        return { correlation: null, pValue: null, n, df: 0 };
      }
    }

    /**
     * Matrix inversion with Gauss-Jordan elimination
     */
    function invertMatrix(matrix) {
      const n = matrix.length;
      const augmented = [];
      
      for (let i = 0; i < n; i++) {
        augmented[i] = [];
        for (let j = 0; j < n; j++) {
          augmented[i][j] = matrix[i][j];
        }
        for (let j = 0; j < n; j++) {
          augmented[i][n + j] = (i === j) ? 1 : 0;
        }
      }
      
      for (let i = 0; i < n; i++) {
        let maxRow = i;
        for (let k = i + 1; k < n; k++) {
          if (Math.abs(augmented[k][i]) > Math.abs(augmented[maxRow][i])) {
            maxRow = k;
          }
        }
        
        [augmented[i], augmented[maxRow]] = [augmented[maxRow], augmented[i]];
        
        if (Math.abs(augmented[i][i]) < 1e-10) {
          throw new Error("Matrix is singular");
        }
        
        const pivot = augmented[i][i];
        for (let j = 0; j < 2 * n; j++) {
          augmented[i][j] /= pivot;
        }
        
        for (let k = 0; k < n; k++) {
          if (k !== i) {
            const factor = augmented[k][i];
            for (let j = 0; j < 2 * n; j++) {
              augmented[k][j] -= factor * augmented[i][j];
            }
          }
        }
      }
      
      const inverse = [];
      for (let i = 0; i < n; i++) {
        inverse[i] = [];
        for (let j = 0; j < n; j++) {
          inverse[i][j] = augmented[i][n + j];
        }
      }
      
      return inverse;
    }

    /**
     * Safe matrix inversion with regularization
     */
    function safeInvertMatrix(matrix) {
      const n = matrix.length;
      const eps = 1e-6;
      const regularized = [];
      for (let i = 0; i < n; i++) {
        regularized[i] = [];
        for (let j = 0; j < n; j++) {
          regularized[i][j] = matrix[i][j] + (i === j ? eps : 0);
        }
      }
      try {
        return invertMatrix(regularized);
      } catch (e) {
        const eps2 = 1e-4;
        for (let i = 0; i < n; i++) {
          for (let j = 0; j < n; j++) {
            regularized[i][j] = matrix[i][j] + (i === j ? eps2 : 0);
          }
        }
        return invertMatrix(regularized);
      }
    }

    /**
     * Generate partial correlation matrix table
     */
    function generatePartialCorrelationMatrix() {
      const loading = document.getElementById('loadingMessage');
      const tableContainer = document.getElementById('tableContainer');
      const tableHead = document.getElementById('headerRow');
      const tableBody = document.getElementById('tableBody');
      
      if (!precomputedCorrelationMatrix || !variableNames.length) {
        console.warn('No data to generate matrix');
        return;
      }
      
      // Get control indices
      const checkboxes = document.querySelectorAll('#controlCheckboxes input[type="checkbox"]:checked');
      const controlIndices = Array.from(checkboxes).map(cb => parseInt(cb.value));
      
      // Get non-control indices
      const nonControlIndices = variableNames.map((_, i) => i).filter(i => !controlIndices.includes(i));
      
      // Clear table
      tableHead.innerHTML = '';
      tableBody.innerHTML = '';
      
      // Build header
      tableHead.innerHTML = `
        <th></th>
        ${nonControlIndices.map(idx => `<th>${variableNames[idx]}</th>`).join('')}
      `;
      
      // Build rows
      for (let i = 0; i < nonControlIndices.length; i++) {
        const varIdx = nonControlIndices[i];
        const tr = document.createElement('tr');
        
        // Variable name cell
        const nameTd = document.createElement('td');
        nameTd.textContent = variableNames[varIdx];
        tr.appendChild(nameTd);
        
        // Data cells
        for (let j = 0; j < nonControlIndices.length; j++) {
          const var2Idx = nonControlIndices[j];
          const td = document.createElement('td');
          
          if (i === j) {
            td.textContent = '1.000';
          } else {
            const result = calculatePartialCorrelation(varIdx, var2Idx, controlIndices);
            
            // Correlation value (clickable)
            const corrSpan = document.createElement('span');
            corrSpan.className = 'clickable-correlation';
            corrSpan.textContent = result.correlation !== null ? result.correlation.toFixed(3) : '.';
            corrSpan.title = `Click to view details: ${variableNames[varIdx]} ‚Üî ${variableNames[var2Idx]}`;
            corrSpan.addEventListener('click', () => {
              showCorrelationModal(varIdx, var2Idx, variableNames[varIdx], variableNames[var2Idx], td);
            });
            td.appendChild(corrSpan);
            
            // Additional info
            const infoDiv = document.createElement('div');
            infoDiv.className = 'corr-info';
            
            const showPval = document.getElementById('togglePval').checked;
            const showN = document.getElementById('toggleN').checked;
            
            if (showPval && result.pValue !== null) {
              const pSpan = document.createElement('span');
              pSpan.textContent = result.pValue < 0.0001 ? 'p < .0001' : `p = ${result.pValue.toFixed(4)}`;
              pSpan.style.display = 'block';
              infoDiv.appendChild(pSpan);
            }
            
            if (showN) {
              const dfSpan = document.createElement('span');
              dfSpan.textContent = `df = ${result.df}`;
              dfSpan.style.display = 'block';
              infoDiv.appendChild(dfSpan);
            }
            
            td.appendChild(infoDiv);
          }
          
          tr.appendChild(td);
        }
        
        tableBody.appendChild(tr);
      }
      
      // Show table
      loading.style.display = 'none';
      tableContainer.style.display = 'block';
    }

    /**
     * Show correlation comparison modal
     */
    function showCorrelationModal(var1Idx, var2Idx, var1Name, var2Name, clickedCell) {
      const checkboxes = document.querySelectorAll('#controlCheckboxes input[type="checkbox"]:checked');
      const controlIndices = Array.from(checkboxes).map(cb => parseInt(cb.value));
      
      // Regular correlation (no controls)
      const regularCorr = calculatePartialCorrelation(var1Idx, var2Idx, []);
      
      // Partial correlation (with controls)
      const partialCorr = calculatePartialCorrelation(var1Idx, var2Idx, controlIndices);
      
      // Update modal
      document.getElementById('modalTitle').textContent = `${var1Name} ‚Üî ${var2Name}`;
      document.getElementById('regularR').textContent = regularCorr.correlation !== null ? regularCorr.correlation.toFixed(3) : '-';
      document.getElementById('regularP').textContent = regularCorr.pValue !== null ? (regularCorr.pValue < 0.001 ? '<.001' : regularCorr.pValue.toFixed(3)) : '-';
      document.getElementById('regularDF').textContent = regularCorr.df || '-';
      document.getElementById('partialR').textContent = partialCorr.correlation !== null ? partialCorr.correlation.toFixed(3) : '-';
      document.getElementById('partialP').textContent = partialCorr.pValue !== null ? (partialCorr.pValue < 0.001 ? '<.001' : partialCorr.pValue.toFixed(3)) : '-';
      document.getElementById('partialDF').textContent = partialCorr.df || '-';
      
      // Highlight cell
      document.querySelectorAll('.highlighted').forEach(el => el.classList.remove('highlighted'));
      if (clickedCell) {
        clickedCell.classList.add('highlighted');
      }
      
      // Show modal
      document.getElementById('correlationModal').style.display = 'block';
      setTimeout(centerModal, 10);
    }

    /**
     * Hide modal
     */
    function hideCorrelationModal() {
      document.getElementById('correlationModal').style.display = 'none';
      document.querySelectorAll('.highlighted').forEach(el => el.classList.remove('highlighted'));
    }

    /**
     * Center modal
     */
    function centerModal() {
      const modal = document.getElementById('correlationModal');
      const modalContent = document.querySelector('.modal-content');
      if (modal && modalContent) {
        const modalRect = modal.getBoundingClientRect();
        const centerX = (modalRect.width - modalContent.offsetWidth) / 2;
        const centerY = (modalRect.height - modalContent.offsetHeight) / 2;
        modalContent.style.left = centerX + 'px';
        modalContent.style.top = centerY + 'px';
        modalContent.style.transform = 'none';
        modalContent.style.margin = '0';
      }
    }

    // Event listeners
    document.addEventListener('DOMContentLoaded', function() {
      // Toggle checkboxes
      const togglePval = document.getElementById('togglePval');
      const toggleN = document.getElementById('toggleN');
      
      if (togglePval) {
        togglePval.addEventListener('change', () => generatePartialCorrelationMatrix());
      }
      if (toggleN) {
        toggleN.addEventListener('change', () => generatePartialCorrelationMatrix());
      }
      
      // Modal close
      const closeBtn = document.querySelector('.close-modal');
      if (closeBtn) {
        closeBtn.addEventListener('click', hideCorrelationModal);
      }
      
      const modal = document.getElementById('correlationModal');
      if (modal) {
        modal.addEventListener('click', function(e) {
          if (e.target === modal) {
            hideCorrelationModal();
          }
        });
      }
      
      // Escape key
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && modal && modal.style.display === 'block') {
          hideCorrelationModal();
        }
      });
    });

    console.log('‚úÖ Partial Correlations Dialog loaded');
  </script>
</body>
</html>
