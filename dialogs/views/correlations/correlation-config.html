<!DOCTYPE html>
<html lang="en">
<head>
  <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Correlation Analysis - Configuration</title>
  <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
  <style>
    :root{
      --surface-0: #f3f4f6;
      --surface-1: #ffffff;
      --surface-2: #f9fafb;
      --border: #e5e7eb;
      --accent-1: #2563eb;
      --text-primary: #111827;
      --text-secondary: #4b5563;
      --text-muted: #6b7280;
    }
    *{ box-sizing:border-box }
    html,body{height:100%;margin:0;padding:0}
    body{background:var(--surface-0);color:var(--text-primary);font:14px/1.45 'Segoe UI',Arial,sans-serif}
    
    .wrap{ 
      display:flex; 
      justify-content:center; 
      padding:12px;
      height:100vh;
    }
    
    .card{
      width:min(700px, 100%);
      background:var(--surface-1);
      border-radius:10px;
      box-shadow:0px 4px 20px rgba(0, 0, 0, 0.08);
      border: 1px solid var(--border);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      height:100%;
    }
    
    .card-head{ 
      background: var(--surface-2); 
      color:var(--accent-1); 
      padding:12px 16px; 
      font-weight:600; 
      font-size:1.1rem; 
      border-bottom: 2px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink:0;
    }
    
    .card-body{ 
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    
    .section {
      background: var(--surface-2);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 12px;
    }
    
    .section-title {
      font-weight: 600;
      font-size: 13px;
      color: var(--text-secondary);
      margin-bottom: 10px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    /* Variables Table */
    .variables-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }
    
    .variables-table thead {
      background: var(--surface-0);
      position: sticky;
      top: 0;
      z-index: 1;
    }
    
    .variables-table th {
      padding: 8px;
      text-align: left;
      color: var(--text-secondary);
      font-weight: 700;
      border-bottom: 2px solid var(--border);
      font-size: 11px;
      text-transform: uppercase;
    }
    
    .variables-table th.center {
      text-align: center;
    }
    
    .variables-table tbody tr {
      border-bottom: 1px solid var(--border);
    }
    
    .variables-table tbody tr:hover {
      background: var(--surface-0);
    }
    
    .variables-table td {
      padding: 8px;
    }
    
    .variables-table td.center {
      text-align: center;
    }
    
    .checkbox {
      width: 18px;
      height: 18px;
      cursor: pointer;
      accent-color: var(--accent-1);
    }
    
    .select-all-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      padding: 8px;
      background: var(--surface-0);
      border-radius: 6px;
    }
    
    .btn-group {
      display: flex;
      gap: 6px;
    }
    
    .btn-small {
      padding: 4px 10px;
      font-size: 11px;
      background: var(--surface-1);
      border: 1px solid var(--border);
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .btn-small:hover {
      background: var(--surface-2);
      border-color: var(--accent-1);
    }
    
    select {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid var(--border);
      border-radius: 6px;
      background: var(--surface-1);
      font-size: 13px;
    }
    
    .btn-run {
      width: 100%;
      padding: 14px 20px;
      font-size: 15px;
      font-weight: 600;
      color: white;
      background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 2px 8px rgba(37, 99, 235, 0.3);
    }
    
    .btn-run:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4);
    }
    
    .btn-run:disabled {
      background: #cbd5e1;
      cursor: not-allowed;
      transform: none;
    }
    
    .summary {
      font-size: 12px;
      color: var(--text-secondary);
      padding: 8px;
      background: #eff6ff;
      border: 1px solid #bfdbfe;
      border-radius: 6px;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <section class="card" role="main">
      <div class="card-head">
        <span><i class="fa-solid fa-chart-line"></i> Correlation Analysis Configuration</span>
        <span id="rangeInfo" style="font-size: 12px; font-weight: normal; color: var(--text-secondary);">â€”</span>
      </div>
      
      <div class="card-body">
        <!-- Variables Section -->
        <div class="section">
          <div class="section-title">
            <i class="fa-solid fa-table-columns"></i> Select Variables
          </div>
          
          <div class="select-all-row">
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
              <input type="checkbox" id="selectAll" class="checkbox" checked onchange="toggleAll(this.checked)">
              <span style="font-weight: 600; font-size: 12px;">Select All</span>
            </label>
            <div class="btn-group">
              <button class="btn-small" onclick="selectNumericOnly()">
                <i class="fa-solid fa-hashtag"></i> Numeric Only
              </button>
            </div>
          </div>
          
          <div style="max-height: 300px; overflow-y: auto; border: 1px solid var(--border); border-radius: 6px;">
            <table class="variables-table">
              <thead>
                <tr>
                  <th style="width: 40px;" class="center">Include</th>
                  <th>Variable Name</th>
                  <th class="center">n Numeric</th>
                  <th class="center">n String</th>
                  <th class="center">n Missing</th>
                </tr>
              </thead>
              <tbody id="variablesTableBody">
                <tr>
                  <td colspan="5" style="text-align: center; color: var(--text-muted); padding: 20px;">
                    Loading variables...
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
          
          <div class="summary" id="selectionSummary">
            Selected: <strong>0</strong> variables
          </div>
        </div>
        
        <!-- Method Section -->
        <div class="section">
          <div class="section-title">
            <i class="fa-solid fa-calculator"></i> Correlation Method
          </div>
          <select id="corrMethod">
            <option value="pearson" selected>Pearson (parametric)</option>
            <option value="spearman">Spearman (rank-based)</option>
            <option value="kendall">Kendall Tau (rank-based)</option>
            <option value="biweight">Biweight Midcorrelation (robust)</option>
          </select>
        </div>
        
        <!-- View Type Section -->
        <div class="section">
          <div class="section-title">
            <i class="fa-solid fa-eye"></i> View Type
          </div>
          <select id="viewType">
            <option value="matrix" selected>Correlation Matrix</option>
            <option value="network">Network Diagram</option>
            <option value="taylor">Taylor Diagram</option>
          </select>
        </div>
        
        <!-- Run Button -->
        <button id="btnRun" class="btn-run" onclick="runAnalysis()">
          <i class="fa-solid fa-play"></i> Run Correlation Analysis
        </button>
      </div>
    </section>
  </div>

  <script>
    var correlationData = null;
    var variableStats = {};
    
    Office.onReady(function(info) {
      console.log('Correlation Config Dialog Ready');
      
      // Load data from sessionStorage
      var storedData = sessionStorage.getItem('correlationRawData');
      if (storedData) {
        try {
          correlationData = JSON.parse(storedData);
          console.log('Loaded data from sessionStorage:', correlationData);
          processData();
        } catch (e) {
          console.error('Error loading data:', e);
        }
      }
      
      // Also listen for data from parent
      Office.context.ui.addHandlerAsync(
        Office.EventType.DialogParentMessageReceived,
        function(arg) {
          try {
            var message = JSON.parse(arg.message);
            if (message.type === 'CORRELATION_DATA' && message.payload) {
              correlationData = message.payload;
              console.log('Received data from parent:', correlationData);
              processData();
            }
          } catch (e) {
            console.error('Error processing message:', e);
          }
        }
      );
      
      // Signal ready
      Office.context.ui.messageParent(JSON.stringify({ action: 'ready' }));
    });
    
    function processData() {
      if (!correlationData || !correlationData.values) {
        console.error('No data available');
        return;
      }
      
      var values = correlationData.values;
      var address = correlationData.address || 'Selection';
      
      // Update range info
      document.getElementById('rangeInfo').textContent = address;
      
      // Extract headers and data
      var headers = values[0];
      var dataRows = values.slice(1);
      
      // Analyze each variable
      variableStats = {};
      headers.forEach(function(header, colIdx) {
        var numeric = 0, string = 0, missing = 0;
        
        dataRows.forEach(function(row) {
          var value = row[colIdx];
          if (value === null || value === undefined || value === '') {
            missing++;
          } else if (typeof value === 'number' && !isNaN(value)) {
            numeric++;
          } else {
            var num = parseFloat(value);
            if (!isNaN(num)) {
              numeric++;
            } else {
              string++;
            }
          }
        });
        
        variableStats[header] = {
          name: header,
          numeric: numeric,
          string: string,
          missing: missing,
          selected: true
        };
      });
      
      renderVariablesTable();
      updateSelectionSummary();
    }
    
    function renderVariablesTable() {
      var tbody = document.getElementById('variablesTableBody');
      tbody.innerHTML = '';
      
      for (var varName in variableStats) {
        if (variableStats.hasOwnProperty(varName)) {
          var stats = variableStats[varName];
          var tr = document.createElement('tr');
          
          tr.innerHTML = 
            '<td class="center">' +
              '<input type="checkbox" class="checkbox var-checkbox" data-var="' + varName + '" ' +
              (stats.selected ? 'checked' : '') + ' onchange="updateSelectionSummary()">' +
            '</td>' +
            '<td><strong>' + varName + '</strong></td>' +
            '<td class="center">' + stats.numeric + '</td>' +
            '<td class="center">' + stats.string + '</td>' +
            '<td class="center">' + stats.missing + '</td>';
          
          tbody.appendChild(tr);
        }
      }
    }
    
    function toggleAll(checked) {
      document.querySelectorAll('.var-checkbox').forEach(function(cb) {
        cb.checked = checked;
        variableStats[cb.dataset.var].selected = checked;
      });
      updateSelectionSummary();
    }
    
    function selectNumericOnly() {
      document.querySelectorAll('.var-checkbox').forEach(function(cb) {
        var varName = cb.dataset.var;
        var isNumeric = variableStats[varName].numeric >= 5;
        cb.checked = isNumeric;
        variableStats[varName].selected = isNumeric;
      });
      updateSelectAllCheckbox();
      updateSelectionSummary();
    }
    
    function updateSelectAllCheckbox() {
      var allChecked = Array.from(document.querySelectorAll('.var-checkbox')).every(cb => cb.checked);
      document.getElementById('selectAll').checked = allChecked;
    }
    
    function updateSelectionSummary() {
      var selected = Array.from(document.querySelectorAll('.var-checkbox:checked')).length;
      document.getElementById('selectionSummary').innerHTML = 
        'Selected: <strong>' + selected + '</strong> variables';
      
      // Enable/disable run button
      document.getElementById('btnRun').disabled = selected < 2;
      
      updateSelectAllCheckbox();
    }
    
    function runAnalysis() {
      // Get selected variables
      var selectedVars = [];
      document.querySelectorAll('.var-checkbox:checked').forEach(function(cb) {
        selectedVars.push(cb.dataset.var);
      });
      
      if (selectedVars.length < 2) {
        alert('Please select at least 2 variables for correlation analysis.');
        return;
      }
      
      // Get method and view type
      var method = document.getElementById('corrMethod').value;
      var viewType = document.getElementById('viewType').value;
      
      // Send configuration back to parent
      var config = {
        variables: selectedVars,
        method: method,
        viewType: viewType,
        data: correlationData
      };
      
      Office.context.ui.messageParent(JSON.stringify({
        action: 'runAnalysis',
        data: config
      }));
      
      console.log('Sent config to parent:', config);
    }
  </script>
</body>
</html>
