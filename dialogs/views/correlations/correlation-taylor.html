<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <title>Taylor Diagram</title>
  
  <!-- Office.js -->
  <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
  
  <!-- Highcharts -->
  <script src="https://code.highcharts.com/highcharts.js"></script>
  <script src="https://code.highcharts.com/highcharts-more.js"></script>
  <script src="https://code.highcharts.com/modules/exporting.js"></script>
  <script src="https://code.highcharts.com/modules/export-data.js"></script>
  
  <!-- Font Awesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet"/>
  
  <!-- Shared Header -->
  <link rel="stylesheet" href="../shared-header.css?v=20260206-003">
  <script src="../shared-header.js?v=20260206-003"></script>

  <style>
    :root{
      --surface-0:#0c1624;
      --surface-1:#1a1f2e;
      --surface-2:#242938;
      --border:#2d3748;
      --accent-1:rgb(255,165,120);
      --accent-2:rgb(120,200,255);
      --text-primary:#fff;
      --text-secondary:rgba(255,255,255,0.8);
      --text-muted:rgba(255,255,255,0.6);
      --panel-radius:10px;
      --panel-shadow:0 4px 20px rgba(0,0,0,.4);
    }

    *{
      box-sizing:border-box;
    }

    body{
      margin:0;
      padding:0;
      background:linear-gradient(135deg, var(--surface-0) 0%, #1a2332 100%);
      color:var(--text-primary);
      font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      min-height:100vh;
      display:flex;
      flex-direction:column;
    }

    .container{
      display:flex;
      flex-direction:column;
      min-height:100vh;
    }

    .results-container{
      flex:1;
      padding:16px;
      display:flex;
      gap:12px;
      overflow:hidden;
    }

    .left-panel{
      width:280px;
      min-width:280px;
      background:var(--surface-1);
      border-radius:var(--panel-radius);
      border:1px solid var(--border);
      box-shadow:var(--panel-shadow);
      display:flex;
      flex-direction:column;
      overflow:hidden;
    }

    .panel-header{
      padding:12px 14px;
      background:var(--surface-2);
      border-bottom:1px solid var(--border);
      font-weight:600;
      color:var(--accent-2);
      font-size:0.95rem;
    }

    .panel-content{
      flex:1;
      overflow-y:auto;
      padding:12px;
    }

    .section-title{
      font-size:0.8rem;
      color:var(--text-secondary);
      margin-bottom:6px;
      font-weight:600;
      display:flex;
      align-items:center;
      gap:6px;
    }

    select{
      width:100%;
      background:var(--surface-2);
      color:var(--text-primary);
      border:1px solid var(--border);
      border-radius:6px;
      padding:6px 8px;
      margin-bottom:10px;
    }

    .variable-list{
      display:flex;
      flex-direction:column;
      gap:6px;
      max-height:320px;
      overflow-y:auto;
      padding:6px;
      background:var(--surface-0);
      border-radius:6px;
      border:1px solid var(--border);
    }

    .variable-item{
      display:flex;
      align-items:center;
      gap:8px;
      padding:6px 8px;
      background:var(--surface-2);
      border-radius:4px;
      cursor:pointer;
      font-size:0.85rem;
    }

    .variable-item input{
      accent-color:var(--accent-1);
    }

    .chart-container{
      flex:1;
      background:var(--surface-1);
      border-radius:var(--panel-radius);
      border:1px solid var(--border);
      box-shadow:var(--panel-shadow);
      display:flex;
      flex-direction:column;
      overflow:hidden;
    }

    .chart-header{
      padding:12px 14px;
      background:var(--surface-2);
      border-bottom:1px solid var(--border);
      font-weight:600;
      color:var(--accent-1);
      font-size:1rem;
      display:flex;
      align-items:center;
      gap:8px;
    }

    .chart-body{
      flex:1;
      padding:8px;
    }

    #taylorChart{
      width:100%;
      height:100%;
      min-height:520px;
    }

    .loading{
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      padding:60px 20px;
      gap:20px;
      color:var(--text-secondary);
    }

    .loading i{
      font-size:48px;
      color:var(--accent-1);
      animation:spin 1s linear infinite;
    }

    @keyframes spin{
      0%{transform:rotate(0deg);}
      100%{transform:rotate(360deg);}
    }
  </style>
</head>
<body>
  <div class="container" id="mainContainer" style="display:none;">
    <div id="header-container"></div>
    <div class="results-container">
      <div class="left-panel">
        <div class="panel-header">Taylor Diagram Setup</div>
        <div class="panel-content">
          <div class="section-title"><i class="fas fa-bullseye"></i>Reference Variable</div>
          <select id="referenceSelect" onchange="updateTaylor()"></select>

          <div class="section-title"><i class="fas fa-layer-group"></i>Variables to Compare</div>
          <div class="variable-list" id="variableList"></div>
        </div>
      </div>

      <div class="chart-container">
        <div class="chart-header"><i class="fas fa-chart-pie"></i> Taylor Diagram</div>
        <div class="chart-body">
          <div id="taylorChart"></div>
        </div>
      </div>
    </div>
  </div>

  <div id="loadingMessage" class="loading">
    <i class="fa-solid fa-spinner"></i>
    <p>Loading taylor diagram data...</p>
  </div>

  <script>
    let correlationData = null;
    let chart = null;

    Office.onReady(function() {
      if (typeof StatisticoHeader !== 'undefined') {
        StatisticoHeader.init('taylor-diagram', 'Taylor Diagram', 0, 'correlations');
      }

      Office.context.ui.addHandlerAsync(
        Office.EventType.DialogParentMessageReceived,
        onMessageFromParent
      );

      Office.context.ui.messageParent(JSON.stringify({ action: 'ready' }));
    });

    function onMessageFromParent(arg) {
      try {
        const message = JSON.parse(arg.message);
        if (message.type === 'CORRELATION_DATA') {
          correlationData = message.payload;
          initTaylor();
        }
      } catch (error) {
        console.error('Error parsing message:', error);
      }
    }

    function initTaylor() {
      const headers = correlationData.headers || [];
      const referenceSelect = document.getElementById('referenceSelect');
      const variableList = document.getElementById('variableList');

      referenceSelect.innerHTML = '';
      variableList.innerHTML = '';

      headers.forEach((header, idx) => {
        const option = document.createElement('option');
        option.value = header;
        option.textContent = header;
        if (idx === 0) option.selected = true;
        referenceSelect.appendChild(option);

        const item = document.createElement('label');
        item.className = 'variable-item';
        item.innerHTML = `<input type="checkbox" value="${header}" ${idx > 0 ? 'checked' : ''}> ${header}`;
        variableList.appendChild(item);
      });

      variableList.querySelectorAll('input[type="checkbox"]').forEach(box => {
        box.addEventListener('change', updateTaylor);
      });

      updateTaylor();

      document.getElementById('loadingMessage').style.display = 'none';
      document.getElementById('mainContainer').style.display = 'flex';
    }

    function updateTaylor() {
      if (!correlationData) return;
      const reference = document.getElementById('referenceSelect').value;
      const selected = Array.from(document.querySelectorAll('#variableList input[type="checkbox"]:checked'))
        .map(el => el.value)
        .filter(name => name !== reference);

      const points = buildTaylorPoints(reference, selected);
      renderTaylorChart(reference, points);
    }

    function buildTaylorPoints(referenceVar, compareVars) {
      const data = correlationData.data || [];
      const refValues = data.map(row => row[referenceVar]);
      const refStats = computeStats(refValues, refValues);
      const stdRef = refStats.std || 1;

      return compareVars.map(varName => {
        const candidate = data.map(row => row[varName]);
        const stats = computeStats(refValues, candidate);
        const stdNorm = stats.std / stdRef;
        const corr = stats.corr;
        return {
          name: varName,
          corr,
          std: stdNorm
        };
      }).filter(p => isFinite(p.corr) && isFinite(p.std));
    }

    function computeStats(ref, cand) {
      const pairs = ref.map((r, i) => [r, cand[i]])
        .filter(([r, c]) => typeof r === 'number' && typeof c === 'number' && isFinite(r) && isFinite(c));
      const xs = pairs.map(p => p[0]);
      const ys = pairs.map(p => p[1]);
      const corr = pearson(xs, ys);
      return {
        corr,
        std: stdDev(ys)
      };
    }

    function pearson(x, y) {
      if (x.length < 2) return NaN;
      const meanX = x.reduce((a, b) => a + b, 0) / x.length;
      const meanY = y.reduce((a, b) => a + b, 0) / y.length;
      let num = 0, denX = 0, denY = 0;
      for (let i = 0; i < x.length; i++) {
        const dx = x[i] - meanX;
        const dy = y[i] - meanY;
        num += dx * dy;
        denX += dx * dx;
        denY += dy * dy;
      }
      return denX === 0 || denY === 0 ? NaN : num / Math.sqrt(denX * denY);
    }

    function stdDev(arr) {
      if (arr.length < 2) return NaN;
      const mean = arr.reduce((a, b) => a + b, 0) / arr.length;
      const sumSq = arr.reduce((s, v) => s + Math.pow(v - mean, 2), 0);
      return Math.sqrt(sumSq / (arr.length - 1));
    }

    function renderTaylorChart(referenceVar, points) {
      const seriesPoints = points.map(p => ({
        x: Math.acos(Math.max(-1, Math.min(1, p.corr))) * (180 / Math.PI),
        y: p.std,
        name: p.name
      }));

      const rmsContours = [0.5, 1.0, 1.5].map(level => {
        const data = [];
        for (let angle = 0; angle <= 180; angle += 2) {
          const corr = Math.cos(angle * Math.PI / 180);
          const r = Math.sqrt(level * level + 1 - 2 * level * corr);
          data.push([angle, r]);
        }
        return {
          type: 'line',
          name: `RMSD ${level}`,
          data,
          dashStyle: 'ShortDot',
          color: 'rgba(255,255,255,0.35)',
          marker: { enabled: false },
          enableMouseTracking: false
        };
      });

      const refPoint = {
        x: 0,
        y: 1,
        name: referenceVar,
        marker: { symbol: 'circle', radius: 6 }
      };

      chart = Highcharts.chart('taylorChart', {
        chart: {
          polar: true,
          backgroundColor: 'transparent'
        },
        title: { text: '' },
        pane: {
          startAngle: 0,
          endAngle: 180
        },
        xAxis: {
          min: 0,
          max: 180,
          tickInterval: 30,
          gridLineColor: 'rgba(255,255,255,0.08)',
          labels: {
            formatter: function() {
              return Math.cos(this.value * Math.PI / 180).toFixed(2);
            },
            style: { color: '#fff' }
          },
          title: { text: 'Correlation', style: { color: '#fff' } }
        },
        yAxis: {
          min: 0,
          gridLineColor: 'rgba(255,255,255,0.08)',
          labels: { style: { color: '#fff' } },
          title: { text: 'Normalized Std Dev', style: { color: '#fff' } }
        },
        tooltip: {
          formatter: function() {
            const corr = Math.cos(this.x * Math.PI / 180);
            return `<b>${this.point.name}</b><br/>Corr: ${corr.toFixed(3)}<br/>Std: ${this.y.toFixed(3)}`;
          }
        },
        legend: { itemStyle: { color: '#fff' } },
        credits: { enabled: false },
        series: [
          { type: 'scatter', name: 'Reference', data: [refPoint], color: 'rgba(120,200,255,0.9)' },
          { type: 'scatter', name: 'Variables', data: seriesPoints, color: 'rgba(255,165,120,0.9)' },
          ...rmsContours
        ]
      });
    }
  </script>
</body>
</html>
