<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Taylor Diagram - Dataset Comparison</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
  <script src="https://code.highcharts.com/highcharts.js"></script>
  <script src="https://code.highcharts.com/highcharts-more.js"></script>
  <script src="https://code.highcharts.com/modules/exporting.js"></script>
  <script src="https://code.highcharts.com/modules/export-data.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet">
  <link rel="stylesheet" href="../shared-header.css">
  <script src="../shared-header.js"></script>
  
  <style>
    :root {
      --surface-0: #0c1624;
      --surface-1: #1a1f2e;
      --surface-2: #242938;
      --border: #2d3748;
      --accent-1: rgb(255,165,120);
      --accent-2: rgb(120,200,255);
      --text-primary: #fff;
      --text-secondary: rgba(255,255,255,0.8);
      --text-muted: rgba(255,255,255,0.6);
      --panel-radius: 10px;
      --panel-shadow: 0 4px 20px rgba(0,0,0,.4);
    }
    
    * {
      box-sizing: border-box;
    }
    
    body {
      margin: 0;
      padding: 0;
      background: var(--surface-0);
      color: var(--text-primary);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    
    .panel-toolbar {
      background: var(--surface-1);
      padding: 8px 15px;
      border-bottom: 1px solid var(--border);
      box-shadow: var(--panel-shadow);
      display: flex;
      align-items: center;
      gap: 15px;
    }
    
    .panel-toolbar h1 {
      margin: 0;
      font-size: 1.3rem;
      color: var(--accent-1);
      font-weight: 600;
    }
    
    .panel-toolbar .toolbar-spacer {
      flex: 1;
    }
    
    .toggle-panel-btn {
      background: var(--surface-2);
      border: 1px solid var(--border);
      color: var(--text-secondary);
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.85rem;
      transition: all 0.3s;
    }
    
    .toggle-panel-btn:hover {
      background: var(--border);
      color: var(--accent-1);
    }
    
    .main-container {
      display: flex;
      flex: 1;
      overflow: hidden;
      gap: 8px;
      padding: 8px;
    }
    
    .left-panel {
      width: 280px;
      min-width: 280px;
      background: var(--surface-1);
      border-radius: var(--panel-radius);
      border: 1px solid var(--border);
      box-shadow: var(--panel-shadow);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      transition: all 0.3s ease;
      height:780px;
    }
    
    .left-panel.collapsed {
      width: 0;
      min-width: 0;
      padding: 0;
      border: none;
      opacity: 0;
      overflow: hidden;
    }
    
    .chart-container {
      flex: 1;
      background: var(--surface-1);
      border-radius: var(--panel-radius);
      border: 1px solid var(--border);
      box-shadow: var(--panel-shadow);
      overflow: hidden;
       height:780px;
    }
    
    .panel-header {
      padding: 12px 15px;
      background: var(--surface-2);
      border-bottom: 1px solid var(--border);
      font-weight: 600;
      color: var(--accent-2);
      font-size: 1rem;
    }
    
    .panel-content {
      flex: 1;
      overflow-y: auto;
      padding: 12px;
    }
    
    .left-panel.collapsed .panel-content {
      display: none;
    }
    
    /* Variable Selection */
    .variable-section {
      margin-bottom: 15px;
    }
    
    .section-title {
      font-size: 0.85rem;
      color: var(--text-secondary);
      margin-bottom: 8px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .variable-list {
      display: flex;
      flex-direction: column;
      gap: 4px;
      max-height: 220px;
      overflow-y: auto;
      padding: 6px;
      background: var(--surface-0);
      border-radius: 6px;
      border: 1px solid var(--border);
    }
    
    .variable-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      background: var(--surface-2);
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 0.85rem;
    }
    
    .variable-item:hover {
      background: var(--border);
      transform: translateX(2px);
    }
    
    .variable-item input[type="checkbox"] {
      cursor: pointer;
      accent-color: var(--accent-1);
    }
    
    .variable-item.selected {
      background: rgba(255,165,120,0.15);
      border: 1px solid var(--accent-1);
    }
    
    .variable-item.in-dataset {
      background: linear-gradient(135deg, rgba(120,200,255,0.25), rgba(120,200,255,0.15));
      border: 2px solid rgba(120,200,255,0.7);
      box-shadow: 0 0 10px rgba(120,200,255,0.4), inset 0 1px 2px rgba(255,255,255,0.1);
      opacity: 1;
      pointer-events: auto;
    }
    
    .variable-item.in-dataset label {
      color: rgb(120,200,255);
      font-weight: 600;
      text-decoration: none;
      text-shadow: 0 0 8px rgba(120,200,255,0.5);
    }
    
    .variable-item.in-dataset:hover {
      background: linear-gradient(135deg, rgba(120,200,255,0.35), rgba(120,200,255,0.25));
      border-color: rgb(120,200,255);
      box-shadow: 0 0 15px rgba(120,200,255,0.6), inset 0 1px 2px rgba(255,255,255,0.2);
      transform: translateX(2px);
    }
    
    .variable-item.in-dataset.selected {
      background: rgba(255,165,120,0.2);
      border: 1px solid var(--accent-1);
    }
    
    /* Dataset Creation */
    .dataset-controls {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    .dataset-input-group {
      display: flex;
      gap: 8px;
    }
    
    .dataset-input {
      flex: 1;
      padding: 8px 12px;
      background: var(--surface-0);
      border: 1px solid var(--border);
      border-radius: 4px;
      color: var(--text-primary);
      font-size: 0.85rem;
    }
    
    .dataset-input:focus {
      outline: none;
      border-color: var(--accent-1);
    }
    
    /* Global select dropdown option styling */
    select option {
      background: var(--surface-1);
      color: var(--text-primary);
      padding: 8px;
    }
    
    .btn {
      padding: 8px 16px;
      background: linear-gradient(145deg, #4a5568, #2d3748);
      border: 1px solid #4a5568;
      border-radius: 6px;
      color: var(--text-primary);
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    
    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    }
    
    .btn:active {
      transform: translateY(0);
    }
    
    .btn-primary {
      background: linear-gradient(145deg, var(--accent-1), rgba(255,165,120,0.8));
      border-color: var(--accent-1);
    }
    
    .btn-sm {
      padding: 4px 10px;
      font-size: 0.75rem;
    }
    
    /* Dataset List */
    .dataset-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .dataset-card {
      background: var(--surface-0);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 10px;
      transition: all 0.2s;
    }
    
    .dataset-card.active {
      border-color: var(--accent-1);
      box-shadow: 0 0 10px rgba(255,165,120,0.2);
    }
    
    .dataset-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
    }
    
    .dataset-name {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 600;
      font-size: 0.9rem;
    }
    
    .dataset-color {
      width: 16px;
      height: 16px;
      border-radius: 3px;
      border: 1px solid rgba(255,255,255,0.3);
    }
    
    .dataset-actions {
      display: flex;
      gap: 6px;
      align-items: center;
    }
    
    .icon-btn {
      background: none;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      padding: 4px;
      font-size: 0.9rem;
      transition: all 0.2s;
    }
    
    .icon-btn:hover {
      color: var(--accent-1);
      transform: scale(1.1);
    }
    
    .dataset-variables {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-top: 4px;
      padding-top: 6px;
      border-top: 1px solid var(--border);
    }
    
    .dataset-stats {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 6px;
      margin-top: 8px;
      font-size: 0.75rem;
    }
    
    .stat-box {
      background: var(--surface-2);
      padding: 4px 6px;
      border-radius: 3px;
    }
    
    .stat-label {
      color: var(--text-muted);
    }
    
    .stat-value {
      color: var(--accent-2);
      font-weight: 600;
    }
    
    /* Reference Configuration Panel */
    .reference-panel {
      margin-top: 15px;
      background: rgba(76, 175, 80, 0.05);
      border: 1px solid rgba(76, 175, 80, 0.2);
      border-radius: 8px;
      overflow: hidden;
    }
    
    .reference-panel-header {
      background: rgba(76, 175, 80, 0.1);
      padding: 8px 12px;
      display: flex;
      align-items: center;
      gap: 8px;
      color: #4CAF50;
      font-size: 0.85rem;
      font-weight: 600;
      border-bottom: 1px solid rgba(76, 175, 80, 0.2);
    }
    
    .reference-panel-header i {
      font-size: 0.9rem;
    }
    
    .reference-panel-content {
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .ref-section {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    
    .ref-label {
      font-size: 0.75rem;
      color: rgba(255, 255, 255, 0.6);
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .ref-select {
      width: 100%;
      padding: 6px 10px;
      background: var(--surface-0);
      border: 1px solid rgba(76, 175, 80, 0.3);
      border-radius: 4px;
      color: var(--text-primary);
      font-size: 0.85rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .ref-select option {
      background: var(--surface-1);
      color: var(--text-primary);
      padding: 8px;
    }
    
    .ref-select option:hover {
      background: var(--surface-2);
    }
    
    .ref-select:hover {
      border-color: rgba(76, 175, 80, 0.5);
      background: rgba(76, 175, 80, 0.05);
    }
    
    .ref-select:focus {
      outline: none;
      border-color: #4CAF50;
      box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.1);
    }
    
    .ref-hint {
      font-size: 0.7rem;
      color: rgba(255, 255, 255, 0.5);
      font-style: italic;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    .ref-stat-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }
    
    .ref-stat-item {
      background: rgba(0, 0, 0, 0.2);
      padding: 6px 8px;
      border-radius: 4px;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    
    .ref-stat-label {
      font-size: 0.7rem;
      color: rgba(255, 255, 255, 0.5);
    }
    
    .ref-stat-value {
      font-size: 0.9rem;
      color: #4CAF50;
      font-weight: 600;
      font-family: 'Courier New', monospace;
    }
    
    .ref-toggle-label {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      padding: 6px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 4px;
      transition: all 0.2s;
    }
    
    .ref-toggle-label:hover {
      background: rgba(0, 0, 0, 0.3);
    }
    
    .ref-toggle-label input[type="checkbox"] {
      accent-color: #4CAF50;
      cursor: pointer;
      width: 16px;
      height: 16px;
    }
    
    .ref-toggle-text {
      flex: 1;
      font-size: 0.85rem;
      color: var(--text-secondary);
    }
    
    .ref-badge {
      display: none;
      background: #4CAF50;
      color: var(--surface-0);
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 0.65rem;
      font-weight: 700;
      letter-spacing: 0.5px;
    }
    
    /* Awaiting data message */
    .await-message {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100%;
      font-size: 1.2rem;
      color: var(--text-muted);
    }
    
    .await-message.hidden {
      display: none;
    }
    
    /* Scrollbar styling */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    
    ::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb {
      background: linear-gradient(135deg, var(--accent-1), rgba(255, 165, 120, 0.7));
      border-radius: 4px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: linear-gradient(135deg, rgba(255, 165, 120, 0.9), var(--accent-1));
    }
    
    /* Toggle switch */
    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 36px;
      height: 20px;
    }
    
    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    
    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 20px;
    }
    
    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 14px;
      width: 14px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }
    
    input:checked + .toggle-slider {
      background-color: var(--accent-1);
    }
    
    input:checked + .toggle-slider:before {
      transform: translateX(16px);
    }
    
    .color-picker-wrapper {
      position: relative;
    }
    
    .color-picker {
      width: 30px;
      height: 30px;
      border: 2px solid var(--border);
      border-radius: 4px;
      cursor: pointer;
    }
    
    /* Info Button */
    .info-btn {
      background: rgba(120,200,255,0.2);
      border: 1px solid rgba(120,200,255,0.4);
      color: var(--accent-2);
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s;
      font-size: 16px;
      font-weight: bold;
      margin-left: auto;
    }
    
    .info-btn:hover {
      background: rgba(120,200,255,0.3);
      border-color: var(--accent-2);
      transform: scale(1.1);
    }
    
    /* Modal/Popup */
    .modal {
      display: none;
      position: fixed;
      z-index: 10000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.7);
      animation: fadeIn 0.3s;
    }
    
    .modal.show {
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .modal-content {
      background: linear-gradient(135deg, var(--surface-1), var(--surface-2));
      padding: 30px;
      border: 2px solid var(--border);
      border-radius: 12px;
      max-width: 800px;
      max-height: 85vh;
      overflow-y: auto;
      box-shadow: 0 8px 32px rgba(0,0,0,0.5);
      animation: slideIn 0.3s;
      position: relative;
    }
    
    .modal-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid var(--accent-2);
    }
    
    .modal-header h2 {
      margin: 0;
      color: var(--accent-2);
      font-size: 1.5rem;
    }
    
    .modal-close {
      position: absolute;
      right: 20px;
      top: 20px;
      background: rgba(255,255,255,0.1);
      border: 1px solid var(--border);
      color: var(--text-primary);
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 20px;
      transition: all 0.3s;
    }
    
    .modal-close:hover {
      background: var(--danger-color);
      transform: rotate(90deg);
    }
    
    .modal-section {
      margin-bottom: 25px;
    }
    
    .modal-section h3 {
      color: var(--accent-1);
      margin: 0 0 10px 0;
      font-size: 1.1rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .modal-section p {
      margin: 8px 0;
      line-height: 1.6;
      color: var(--text-secondary);
    }
    
    .modal-section ul {
      margin: 10px 0;
      padding-left: 25px;
    }
    
    .modal-section li {
      margin: 6px 0;
      line-height: 1.5;
      color: var(--text-secondary);
    }
    
    .example-box {
      background: rgba(120,200,255,0.1);
      border-left: 3px solid var(--accent-2);
      padding: 15px;
      border-radius: 6px;
      margin: 15px 0;
    }
    
    .ui-reference {
      background: rgba(255,165,120,0.1);
      border-left: 3px solid var(--accent-1);
      padding: 12px;
      border-radius: 6px;
      margin: 10px 0;
      font-size: 0.9rem;
    }
    
    .formula {
      background: rgba(255,255,255,0.05);
      padding: 10px 15px;
      border-radius: 6px;
      font-family: 'Courier New', monospace;
      margin: 10px 0;
      text-align: center;
      font-size: 1.05rem;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    @keyframes slideIn {
      from {
        transform: translateY(-30px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }
  </style>
</head>
<body>
  <div id="header-container"></div>
  <div class="panel-toolbar">
    <button class="toggle-panel-btn" onclick="toggleLeftPanel()" title="Toggle control panel (Press 'P')">
      <i class="fas fa-bars"></i> <span id="toggle-text">Hide Panel</span>
    </button>
    <div class="toolbar-spacer"></div>
    <button class="info-btn" onclick="openInfoModal()" title="Learn about Taylor Diagrams">
      <i class="fas fa-info"></i>
    </button>
  </div>
  
  <!-- Info Modal -->
  <div id="info-modal" class="modal" onclick="closeInfoModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
      <button class="modal-close" onclick="closeInfoModal()">&times;</button>
      
      <div class="modal-header">
        <i class="fas fa-graduation-cap" style="font-size:2rem;color:var(--accent-2);"></i>
        <h2>Understanding Taylor Diagrams</h2>
      </div>
      
      <div class="modal-section">
        <h3><i class="fas fa-lightbulb"></i> What is a Taylor Diagram?</h3>
        <p>
          A <strong>Taylor Diagram</strong> is a specialized polar plot that provides a concise statistical summary 
          of how well patterns match each other. It's particularly useful for comparing multiple models or datasets 
          against a reference (observed) dataset.
        </p>
        <p>
          The diagram displays three key statistics simultaneously:
        </p>
        <ul>
          <li><strong>Correlation Coefficient (r)</strong> - Shown as the angle from the x-axis (0¬∞ = perfect correlation)</li>
          <li><strong>Standard Deviation (œÉ)</strong> - Shown as the radial distance from the origin</li>
          <li><strong>RMSE</strong> - The distance from the reference point</li>
        </ul>
      </div>
      
      <div class="modal-section">
        <h3><i class="fas fa-calculator"></i> The Mathematics</h3>
        <p>Each point on the diagram represents a variable's relationship with the reference:</p>
        <div class="formula">
          r = Œ£(M·µ¢ - MÃÑ)(O·µ¢ - ≈å) / (œÉ‚Çò √ó œÉ‚Çí √ó n)
        </div>
        <p style="text-align:center;font-size:0.85rem;color:var(--text-muted);margin-top:-5px;">
          where M = model values, O = observed/reference values
        </p>
        <p>
          <strong>Angle (Œ∏)</strong> = arccos(|r|) ‚Äî closer to 0¬∞ means higher correlation<br>
          <strong>Radius</strong> = Standard Deviation ‚Äî distance from origin
        </p>
      </div>
      
      <div class="modal-section">
        <h3><i class="fas fa-flask"></i> Example Scenario</h3>
        <div class="example-box">
          <p><strong>Scenario:</strong> You want to compare different measurement methods for blood pressure.</p>
          <p><strong>Your data:</strong></p>
          <ul style="margin-top:8px;">
            <li><strong>Reference:</strong> Manual measurements (gold standard)</li>
            <li><strong>Variable A:</strong> Digital Device A</li>
            <li><strong>Variable B:</strong> Digital Device B</li>
            <li><strong>Variable C:</strong> Wearable Device</li>
          </ul>
          <p style="margin-top:12px;">
            <strong>Results on the diagram:</strong>
          </p>
          <ul>
            <li><strong>Device A</strong> appears at ~10¬∞ with SD=0.95 ‚Üí Excellent correlation (r‚âà0.98), similar variability</li>
            <li><strong>Device B</strong> appears at ~25¬∞ with SD=1.10 ‚Üí Good correlation (r‚âà0.91), slightly higher variability</li>
            <li><strong>Wearable</strong> appears at ~45¬∞ with SD=1.30 ‚Üí Moderate correlation (r‚âà0.71), higher variability</li>
          </ul>
          <p style="margin-top:12px;font-weight:600;color:var(--accent-2);">
            ‚ûú Device A is the most accurate alternative to manual measurement!
          </p>
        </div>
      </div>
      
      <div class="modal-section">
        <h3><i class="fas fa-mouse-pointer"></i> How to Use This Interface</h3>
        
        <div class="ui-reference">
          <strong>1. Load Your Data</strong><br>
          Data is injected from VB6 using: <code>injectDataFromVB6(jsonData)</code>
        </div>
        
        <div class="ui-reference">
          <strong>2. Select Reference Variable</strong> <i class="fas fa-crosshairs" style="color:var(--accent-2);"></i><br>
          Choose which variable represents your "observed" or "gold standard" data from the 
          <strong>Reference Variable</strong> dropdown in the left panel.
        </div>
        
        <div class="ui-reference">
          <strong>3. Add Variables to Chart</strong> <i class="fas fa-list" style="color:var(--accent-1);"></i><br>
          Click <strong>"+ Add"</strong> next to each variable in the <strong>Available Variables</strong> section. 
          Each variable gets a letter (A, B, C...) shown on the chart.
        </div>
        
        <div class="ui-reference">
          <strong>4. Interpret the Chart</strong><br>
          ‚Ä¢ <strong>Closer to origin vertically</strong> = smaller variability<br>
          ‚Ä¢ <strong>Closer to 0¬∞ horizontally</strong> = higher correlation<br>
          ‚Ä¢ <strong>Red point</strong> = reference<br>
          ‚Ä¢ <strong>‚óè Circle</strong> = positive correlation<br>
          ‚Ä¢ <strong>‚óÜ Diamond</strong> = negative correlation<br>
          ‚Ä¢ <strong>Dashed lines</strong> = RMSE from reference
        </div>
        
        <div class="ui-reference">
          <strong>5. Adjust View</strong> <i class="fas fa-sliders-h" style="color:var(--accent-2);"></i><br>
          Use the <strong>"Normalize to SD=1.0"</strong> toggle to switch between actual and normalized 
          standard deviations for easier comparison.
        </div>
        
        <div class="ui-reference">
          <strong>6. View Statistics</strong> <i class="fas fa-chart-line" style="color:var(--accent-1);"></i><br>
          Check the <strong>Variables on Chart</strong> section to see detailed stats (r, SD, mean) for each variable.
        </div>
      </div>
      
      <div class="modal-section">
        <h3><i class="fas fa-trophy"></i> Ideal Points</h3>
        <p>
          The <strong>best performing variable</strong> will be:
        </p>
        <ul>
          <li>Very close to 0¬∞ (high correlation, r ‚âà 1.0)</li>
          <li>At the same radius as the reference point (similar standard deviation)</li>
          <li>With the shortest dashed line to the reference (low RMSE)</li>
        </ul>
        <p style="margin-top:12px;color:var(--accent-2);font-weight:600;">
          üí° In a perfect match, the variable point would overlap exactly with the reference point!
        </p>
      </div>
    </div>
  </div>
  
  <div class="main-container">
    <!-- Left Panel: Variable Selection & Dataset Management -->
    <div class="left-panel">
      <div class="panel-header">
        <i class="fas fa-layer-group"></i> Dataset Configuration
      </div>
      <div class="panel-content">
        
        <!-- Variable Selection -->
        <div class="variable-section">
          <div class="section-title">
            <i class="fas fa-list"></i> Available Variables
            <span id="var-count" style="font-size:0.75rem;color:var(--text-muted);">(0)</span>
          </div>
          <div id="variable-list" class="variable-list">
            <div style="text-align:center;color:var(--text-muted);font-size:0.85rem;padding:20px;">
              Awaiting data injection...
            </div>
          </div>
        </div>
        
        <!-- Reference Configuration Panel -->
        <div class="reference-panel">
          <div class="reference-panel-header">
            <i class="fas fa-crosshairs"></i>
            <span>Reference Configuration</span>
          </div>
          
          <div class="reference-panel-content">
            <!-- Reference Variable Selection -->
            <div class="ref-section">
              <label class="ref-label">Reference Variable</label>
              <select id="reference-variable-select" class="ref-select" onchange="setReferenceVariable()">
                <option value="">-- Select Reference --</option>
              </select>
              <div class="ref-hint">
                Select the observed/gold standard variable
              </div>
            </div>
            
            <!-- Reference Statistics -->
            <div class="ref-section">
              <label class="ref-label">Statistics</label>
              <div class="ref-stat-grid">
                <div class="ref-stat-item">
                  <span class="ref-stat-label">Actual SD:</span>
                  <span class="ref-stat-value" id="ref-sd-actual">‚Äî</span>
                </div>
                <div class="ref-stat-item">
                  <span class="ref-stat-label">Display SD:</span>
                  <span class="ref-stat-value" id="ref-sd-display">‚Äî</span>
                </div>
              </div>
            </div>
            
            <!-- Normalization Toggle -->
            <div class="ref-section">
              <label class="ref-toggle-label">
                <input type="checkbox" id="normalize-toggle" onchange="toggleNormalization()">
                <span class="ref-toggle-text">Normalize to SD=1.0</span>
                <span id="norm-badge" class="ref-badge">ACTIVE</span>
              </label>
              <div class="ref-hint">
                <i class="fas fa-info-circle"></i> Scales all SD values relative to reference
              </div>
            </div>
          </div>
        </div>
<br>
        <!-- Active Variables on Chart -->
        <div class="variable-section">
          <div class="section-title">
            <i class="fas fa-chart-line"></i> Variables on Chart
            <span id="dataset-count" style="font-size:0.75rem;color:var(--text-muted);">(0)</span>
          </div>
          <div id="dataset-list" class="dataset-list">
            <div style="text-align:center;color:var(--text-muted);font-size:0.85rem;padding:20px;">
              Variables will appear here when data is loaded
            </div>
          </div>
        </div>
        

        
      </div>
    </div>
    
    <!-- Chart Container -->
    <div class="chart-container">
      <div id="await-chart" class="await-message">
        <div>
          <i class="fas fa-chart-scatter" style="font-size:3rem;margin-bottom:15px;opacity:0.5;"></i>
          <div style="font-size:1.2rem;font-weight:600;margin-bottom:8px;">Taylor Diagram</div>
          <div style="font-size:0.9rem;opacity:0.7;">Load data and add variables to display chart</div>
        </div>
      </div>
      <div id="chart" style="width: 100%; height: 80%; display:none;"></div>
      <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 8px; padding: 6px; background: rgba(120,200,255,0.1); border-left: 2px solid var(--accent-2); border-radius: 3px; line-height: 1.4;">
              <b>Correlation Display:</b><br>
              ‚Ä¢ All r values use absolute values for positioning<br>
              ‚Ä¢ ‚óè Circle = Positive correlation<br>
              ‚Ä¢ ‚óÜ Diamond = Negative correlation<br>
              ‚Ä¢ Sign shown in legend and tooltips
            </div>

</div>


<script>
    /* ============================================
     * TAYLOR DIAGRAM - VB6 DATA INJECTION GUIDE
     * ============================================
     * 
     * PRIMARY METHOD: injectDataFromVB6()
     * ------------------------------------
     * Use this single function to load all variables at once.
     * 
     * VB6 EXAMPLE (Recommended - Format 1):
     * -------------------------------------
     * Dim json As String
     * json = "{"
     * json = json & """Height"":[170,165,180,175,168],"
     * json = json & """Weight"":[70,65,82,78,72],"
     * json = json & """Age"":[25,30,28,35,27]"
     * json = json & "}"
     * OrdoWebView1.ExecuteScript "injectDataFromVB6('" & json & "')"
     * 
     * VB6 EXAMPLE (Format 2 - with varnames):
     * ----------------------------------------
     * Dim json As String
     * json = "{"
     * json = json & """varnames"":[""Height"",""Weight"",""Age""],"
     * json = json & """Height"":[170,165,180,175,168],"
     * json = json & """Weight"":[70,65,82,78,72],"
     * json = json & """Age"":[25,30,28,35,27]"
     * json = json & "}"
     * OrdoWebView1.ExecuteScript "injectDataFromVB6('" & json & "')"
     * 
     * VB6 EXAMPLE (Format 3 - array format):
     * ---------------------------------------
     * Dim json As String
     * json = "["
     * json = json & "[""Height"",""Weight"",""Age""],"
     * json = json & "[[170,165,180,175,168],[70,65,82,78,72],[25,30,28,35,27]]"
     * json = json & "]"
     * OrdoWebView1.ExecuteScript "injectDataFromVB6('" & json & "')"
     * 
     * WORKFLOW:
     * ---------
     * 1. Call injectDataFromVB6() with all variable data
     * 2. User selects a reference variable from dropdown
     * 3. User clicks "+ Add" to add variables to chart
     * 4. Chart displays correlation (r) vs standard deviation
     * 
     * HOW CORRELATION (r) IS CALCULATED:
     * ----------------------------------
     * Pearson correlation between each variable and the reference:
     *   r = cov(M, O) / (œÉ_M √ó œÉ_O)
     * Where:
     *   M = Model/Variable values [M‚ÇÅ, M‚ÇÇ, ..., M‚Çô]
     *   O = Reference values [O‚ÇÅ, O‚ÇÇ, ..., O‚Çô]
     *   Œ∏ = arccos(|r|)  [angle on polar plot]
     * 
     * ============================================
     */
    
    // ============================================
    // Global Variables
    // ============================================
    let allVariables = [];  // All variable names from VB injection
    let referenceData = [];  // Reference (observed) data: [O1, O2, ..., On]
    let variableData = {};  // Data for each variable: { varName: { modelValues: [], r: X, sd: X, mean: X } }
    let datasets = [];      // Created datasets: { name, color, variables[], visible, stats }
    let chart = null;
    let datasetIdCounter = 0;
    let isNormalized = false;  // Toggle between normalized (SD=1.0) and actual values
    let referenceSDActual = 1.0;  // Actual calculated SD of reference data
    let selectedReferenceVariable = null;  // Currently selected reference variable name
    window.allVariableData = window.allVariableData || {};
    // High-contrast color palette for maximum discrimination
    const DEFAULT_COLORS = [
      '#FF5733', // Vibrant red-orange
      '#33FF57', // Bright green
      '#3357FF', // Vivid blue
      '#FF33F5', // Magenta
      '#FFD433', // Golden yellow
      '#33FFF5', // Cyan
      '#FF8C33', // Orange
      '#8C33FF', // Purple
      '#FF3364', // Pink-red
      '#64FF33', // Lime green
      '#3364FF', // Royal blue
      '#FFB833'  // Amber
    ];
    
    // ============================================
    // Statistical Calculations
    // ============================================
    
    /**
     * Calculate Pearson correlation coefficient between two arrays
     * Formula: r = cov(M,O) / (œÉ_M * œÉ_O)
     * Where: cov(M,O) = Œ£(Mi - MÃÑ)(Oi - ≈å) / n
     */
    function calculatePearsonCorrelation(modelValues, observedValues) {
  const pairs = [];
  const len = Math.min(modelValues.length, observedValues.length);

  for (let i = 0; i < len; i++) {
    const m = modelValues[i];
    const o = observedValues[i];
    if (typeof m === 'number' && typeof o === 'number' && isFinite(m) && isFinite(o)) {
      pairs.push([m, o]);
    }
  }

  const n = pairs.length;
  if (n < 2) return 0;

  const meanM = pairs.reduce((sum, p) => sum + p[0], 0) / n;
  const meanO = pairs.reduce((sum, p) => sum + p[1], 0) / n;

  let cov = 0;
  let sumM2 = 0;
  let sumO2 = 0;

  for (let i = 0; i < n; i++) {
    const diffM = pairs[i][0] - meanM;
    const diffO = pairs[i][1] - meanO;
    cov += diffM * diffO;
    sumM2 += diffM * diffM;
    sumO2 += diffO * diffO;
  }

  const sdM = Math.sqrt(sumM2 / n);
  const sdO = Math.sqrt(sumO2 / n);
  if (sdM === 0 || sdO === 0) return 0;

  return cov / (n * sdM * sdO);
}
    
    /**
     * Calculate standard deviation of an array
     */
    function calculateStdDev(values) {
  const cleaned = values.filter(val => typeof val === 'number' && isFinite(val));
  const n = cleaned.length;
  if (n === 0) return 0;

  const mean = cleaned.reduce((sum, val) => sum + val, 0) / n;
  const sumSquares = cleaned.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0);

  return Math.sqrt(sumSquares / n);
}
    
    /**
     * Calculate mean of an array
     */
    function calculateMean(values) {
  const cleaned = values.filter(val => typeof val === 'number' && isFinite(val));
  if (cleaned.length === 0) return 0;
  return cleaned.reduce((sum, val) => sum + val, 0) / cleaned.length;
}
    
    // ============================================
    // Data Injection Functions (Called from VB)
    // ============================================
    
    /**
     * Set the reference (observed) data
     * @param {Array|String} data - Array of reference values or JSON string
     */
    function setReferenceData(data) {
      console.log('üì• Received reference data:', data);
      
      // Mark that data has been injected from VB6
      window.__INJECTED_FROM_VB6__ = true;
      
      try {
        if (typeof data === 'string') {
          data = JSON.parse(data);
        }
        
        if (!Array.isArray(data)) {
          console.error('Reference data must be an array');
          return;
        }
        
        referenceData = data.map(val => parseFloat(val));
        
        // Calculate actual reference SD
        referenceSDActual = calculateStdDev(referenceData);
        
        console.log('‚úÖ Reference data set:', referenceData.length, 'observations');
        console.log('üìä Reference SD (actual):', referenceSDActual.toFixed(4));
        
        // Update UI displays
        updateReferenceDisplay();
        
        // Recalculate correlations for existing variables
        Object.keys(variableData).forEach(varName => {
          if (variableData[varName].modelValues) {
            recalculateVariableStats(varName);
          }
        });
        
      } catch (error) {
        console.error('Error setting reference data:', error);
      }
    }
    
    /**
     * Update the reference SD display in the UI
     */
    function updateReferenceDisplay() {
      const actualSpan = document.getElementById('ref-sd-actual');
      const displaySpan = document.getElementById('ref-sd-display');
      
      if (actualSpan) {
        actualSpan.textContent = referenceSDActual > 0 ? referenceSDActual.toFixed(4) : '‚Äî';
      }
      
      if (displaySpan) {
        const displayValue = isNormalized ? 1.0 : referenceSDActual;
        displaySpan.textContent = referenceSDActual > 0 ? displayValue.toFixed(4) : '‚Äî';
      }
    }
    
    /**
     * Toggle between normalized (SD=1.0) and actual values
     */
    function toggleNormalization() {
      const checkbox = document.getElementById('normalize-toggle');
      const badge = document.getElementById('norm-badge');
      
      isNormalized = checkbox.checked;
      
      // Update badge visibility
      if (badge) {
        badge.style.display = isNormalized ? 'inline-block' : 'none';
      }
      
      console.log(`üîÑ Normalization ${isNormalized ? 'ENABLED' : 'DISABLED'}`);
      
      // Update display
      updateReferenceDisplay();
      
      // Recalculate all dataset stats
      datasets.forEach(dataset => {
        updateDatasetStats(dataset);
      });
      
      // Render dataset list to update displayed SDs
      renderDatasetList();
      
      // Update chart
      updateChart();
    }
    
    /**
     * Receives variable names from VB
     * @param {Array|String} vars - Array of variable names or JSON string
     */
    function updateVariableList(vars) {
      console.log('üì• Received variable list:', vars);
      
      // Mark that data has been injected from VB6
      window.__INJECTED_FROM_VB6__ = true;
      
      try {
        // Parse if string
        if (typeof vars === 'string') {
          vars = JSON.parse(vars);
        }
        
        if (!Array.isArray(vars)) {
          console.error('Invalid variable list format');
          return;
        }
        
        allVariables = vars;
        renderVariableList();
        updateVarCount();
        
      } catch (error) {
        console.error('Error updating variable list:', error);
      }
    }
    
    /**
     * Receives model data for a variable (will calculate r vs reference)
     * @param {String} varName - Variable name
     * @param {Array|String} modelValues - Array of model values [M1, M2, ..., Mn]
     */
    function updateVariableData(varName, modelValues) {
      console.log('üì• Received data for variable:', varName, modelValues);
      
      // Mark that data has been injected from VB6
      window.__INJECTED_FROM_VB6__ = true;
      
      try {
        // Parse if string
        if (typeof modelValues === 'string') {
          modelValues = JSON.parse(modelValues);
        }
        
        if (!Array.isArray(modelValues)) {
          console.error('Model values must be an array');
          return;
        }
        
        // Store model values
        if (!variableData[varName]) {
          variableData[varName] = {};
        }
        variableData[varName].modelValues = modelValues.map(val => parseFloat(val));
        
        // Calculate statistics if reference data is available
        recalculateVariableStats(varName);
        
        // Update any datasets that include this variable
        updateDatasetsWithVariable(varName);
        syncAllVariableDataStore();
        
      } catch (error) {
        console.error('Error updating variable data:', error);
      }
    }
    
    /**
     * Recalculate statistics for a variable (r, sd, mean) using reference data
     * @param {String} varName - Variable name
     */
    function recalculateVariableStats(varName) {
      if (!variableData[varName] || !variableData[varName].modelValues) {
        return;
      }
      
      const modelValues = variableData[varName].modelValues;
      
      // Calculate mean and SD
      variableData[varName].mean = calculateMean(modelValues);
      variableData[varName].sd = calculateStdDev(modelValues);
      // Calculate correlation if reference data is available
      if (referenceData.length > 0) {
        variableData[varName].r = calculatePearsonCorrelation(modelValues, referenceData);
        console.log(`‚úÖ Calculated r for ${varName}: ${variableData[varName].r.toFixed(3)}`);
      } else {
        variableData[varName].r = 0;
      }
    }

    function syncAllVariableDataStore() {
      try {
        const store = {};
        Object.keys(variableData).forEach(varName => {
          const entry = variableData[varName];
          if (entry && Array.isArray(entry.modelValues)) {
            store[varName] = entry.modelValues.slice();
          }
        });
        window.allVariableData = store;
        console.log(`üóÇÔ∏è Cached ${Object.keys(store).length} variables for navigation hand-off`);
      } catch (error) {
        console.warn('‚ö†Ô∏è Unable to cache variable data for navigation:', error);
      }
    }
    
    /**
     * Receives bulk data for all variables
     * @param {Object|String} data - { varName1: [M1,M2,...], varName2: [M1,M2,...], ... }
     *                            or { varName1: {modelValues:[...], r, sd, mean}, ... }
     */
    function updateAllVariableData(data) {
      console.log('üì• Received bulk variable data:', data);
      
      // Mark that data has been injected from VB6
      window.__INJECTED_FROM_VB6__ = true;
      
      try {
        // Parse if string
        if (typeof data === 'string') {
          data = JSON.parse(data);
        }
        
        // Extract variable names if not already set
        if (allVariables.length === 0) {
          allVariables = Object.keys(data);
          renderVariableList();
          updateVarCount();
        }
        
        // Process each variable
        Object.keys(data).forEach(varName => {
          const varData = data[varName];
          
          // Check if it's an array (model values) or object (with stats)
          if (Array.isArray(varData)) {
            // Array of model values
            variableData[varName] = {
              modelValues: varData.map(val => parseFloat(val))
            };
            recalculateVariableStats(varName);
          } else if (varData.modelValues) {
            // Object with modelValues array
            variableData[varName] = {
              modelValues: varData.modelValues.map(val => parseFloat(val))
            };
            recalculateVariableStats(varName);
          } else {
            // Object with pre-calculated stats (backwards compatibility)
            variableData[varName] = varData;
          }
        });
        
        // Update all datasets
        datasets.forEach(dataset => {
          updateDatasetStats(dataset);
        });
        
        updateChart();
        syncAllVariableDataStore();
        
      } catch (error) {
        console.error('Error updating all variable data:', error);
      }
    }
    
    /**
     * Main data injection function from VB6
     * 
     * Accepts two formats:
     * 
     * Format 1 (Recommended): Direct variable-to-values mapping
     * {"Variable1": [val1, val2, ...], "Variable2": [val1, val2, ...], ...}
     * 
     * Format 2: Separate names and data arrays
     * {"varnames": ["Var1", "Var2", ...], "Var1": [values...], "Var2": [values...], ...}
     * OR
     * [["Var1", "Var2", ...], [[vals...], [vals...], ...]]
     * 
     * @param {String} jsonData - JSON string with variable data
     */
    function injectDataFromVB6(jsonData) {
      console.log('üì• Received data from VB6');
      
      // Mark that data has been injected from VB6
      window.__INJECTED_FROM_VB6__ = true;
      
      try {
        let data = typeof jsonData === 'string' ? JSON.parse(jsonData) : jsonData;
        
        // Detect and normalize data format
        let processedData = {};
        
        // Format detection
        if (Array.isArray(data)) {
          // Format: [["Var1", "Var2"], [[vals1...], [vals2...]]]
          if (data.length === 2 && Array.isArray(data[0]) && Array.isArray(data[1])) {
            const varNames = data[0];
            const varValues = data[1];
            
            if (varNames.length !== varValues.length) {
              throw new Error(`Mismatch: ${varNames.length} variable names but ${varValues.length} data arrays`);
            }
            
            varNames.forEach((name, idx) => {
              processedData[name] = varValues[idx];
            });
            
            console.log(`üìä Format detected: Array of [names, values]. Loaded ${varNames.length} variables`);
          } else {
            throw new Error('Invalid array format. Expected: [["Var1", "Var2"], [[vals1...], [vals2...]]]');
          }
        } 
        else if (data.varnames && Array.isArray(data.varnames)) {
          // Format: {"varnames": ["Var1", "Var2"], "Var1": [...], "Var2": [...]}
          const varNames = data.varnames;
          
          varNames.forEach(name => {
            if (data[name] && Array.isArray(data[name])) {
              processedData[name] = data[name];
            } else {
              console.warn(`‚ö†Ô∏è No data found for variable: ${name}`);
            }
          });
          
          console.log(`üìä Format detected: Object with varnames array. Loaded ${Object.keys(processedData).length} variables`);
        }
        else {
          // Format: {"Variable1": [...], "Variable2": [...]}
          // Use data as-is, filtering out non-array properties
          Object.keys(data).forEach(key => {
            if (Array.isArray(data[key])) {
              processedData[key] = data[key];
            }
          });
          
          console.log(`üìä Format detected: Direct variable mapping. Loaded ${Object.keys(processedData).length} variables`);
        }
        
        // Validate we have data
        const varNames = Object.keys(processedData);
        if (varNames.length === 0) {
          throw new Error('No valid variable data found');
        }
        
        console.log(`   Variables: ${varNames.join(', ')}`);
        
        // Update variable list
        allVariables = varNames;
        renderVariableList();
        updateVarCount();
        
        // Store each variable's data
        varNames.forEach(varName => {
          const values = processedData[varName];
          if (Array.isArray(values)) {
            variableData[varName] = {
              modelValues: values.map(val => parseFloat(val))
            };
            console.log(`   ${varName}: ${values.length} observations`);
          }
        });
        
        console.log('‚úÖ Data injection complete. Select a reference variable to begin.');
        syncAllVariableDataStore();
        
      } catch (error) {
        console.error('‚ùå Error injecting data from VB6:', error);
        alert('Error loading data: ' + error.message);
      }
    }
    
    /**
     * Set reference variable from dropdown selection
     */
    function setReferenceVariable() {
      const select = document.getElementById('reference-variable-select');
      const varName = select.value;
      
      if (!varName) {
        selectedReferenceVariable = null;
        referenceData = [];
        console.log('‚ö†Ô∏è No reference variable selected');
        renderVariableList();
        updateChart();
        return;
      }
      
      if (!variableData[varName] || !variableData[varName].modelValues) {
        alert(`No data available for variable "${varName}"`);
        select.value = '';
        return;
      }
      
      selectedReferenceVariable = varName;
      referenceData = variableData[varName].modelValues;
      
      // Calculate actual reference SD
      referenceSDActual = calculateStdDev(referenceData);
      
      console.log(`üìç Reference variable set to: ${varName}`);
      console.log(`   Reference SD (actual): ${referenceSDActual.toFixed(4)}`);
      
      // Update reference display
      updateReferenceDisplay();
      
      // Recalculate all variable stats against new reference
      Object.keys(variableData).forEach(vName => {
        if (vName !== varName && variableData[vName].modelValues) {
          recalculateVariableStats(vName);
        }
      });
      
      // Update datasets
      datasets.forEach(dataset => {
        updateDatasetStats(dataset);
      });
      
      // Update UI
      renderVariableList();
      updateChart();
    }
    
    /**
     * Update the reference variable dropdown
     */
    function updateReferenceDropdown() {
      const select = document.getElementById('reference-variable-select');
      if (!select) return;
      
      // Clear existing options except first
      select.innerHTML = '<option value="">-- Select Reference --</option>';
      
      // Add all variables
      allVariables.forEach(varName => {
        const option = document.createElement('option');
        option.value = varName;
        option.textContent = varName;
        if (varName === selectedReferenceVariable) {
          option.selected = true;
        }
        select.appendChild(option);
      });
    }
    
    /**
     * Remove a variable from the chart
     */
    function removeVariableFromChart(varName) {
      console.log(`üóëÔ∏è Attempting to remove variable "${varName}" from chart`);
      
      const index = datasets.findIndex(d => d.variables[0] === varName || d.variableNames[0] === varName);
      
      if (index === -1) {
        console.warn(`‚ö†Ô∏è Variable "${varName}" not found on chart. Current datasets:`, datasets.map(d => d.name));
        return;
      }
      
      const removedDataset = datasets[index];
      datasets.splice(index, 1);
      
      console.log(`   Removed dataset with letter ${removedDataset.letter}`);
      
      // Reassign letters to remaining datasets
      datasets.forEach((ds, idx) => {
        ds.letter = String.fromCharCode(65 + idx);
        console.log(`   Reassigned ${ds.name} to letter ${ds.letter}`);
      });
      
      // Update UI
      renderVariableList();
      renderDatasetList();
      updateChart();
      
      console.log(`‚úÖ Successfully removed variable "${varName}" from chart`);
    }
    
    // Expose functions to global scope for VB6
    window.injectDataFromVB6 = injectDataFromVB6;
    window.setReferenceVariable = setReferenceVariable;
    
    // ============================================
    // UI Controls
    // ============================================
    
    function toggleLeftPanel() {
      const panel = document.querySelector('.left-panel');
      const toggleText = document.getElementById('toggle-text');
      
      panel.classList.toggle('collapsed');
      
      if (panel.classList.contains('collapsed')) {
        toggleText.textContent = 'Show Panel';
      } else {
        toggleText.textContent = 'Hide Panel';
      }
      
      // Trigger chart resize after animation completes
      setTimeout(() => {
        if (chart) {
          chart.reflow();
        }
      }, 350);
    }
    
    /**
     * Open the info modal
     */
    function openInfoModal() {
      const modal = document.getElementById('info-modal');
      modal.classList.add('show');
      document.body.style.overflow = 'hidden'; // Prevent background scrolling
    }
    
    /**
     * Close the info modal
     */
    function closeInfoModal(event) {
      // Only close if clicking the backdrop or close button
      if (!event || event.target.id === 'info-modal' || event.target.classList.contains('modal-close')) {
        const modal = document.getElementById('info-modal');
        modal.classList.remove('show');
        document.body.style.overflow = ''; // Restore scrolling
      }
    }
    
    // Close modal on Escape key
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        closeInfoModal();
      }
    });
    
    // ============================================
    // Variable Selection UI
    // ============================================
    
    function renderVariableList() {
      const container = document.getElementById('variable-list');
      
      if (allVariables.length === 0) {
        container.innerHTML = '<div style="text-align:center;color:var(--text-muted);font-size:0.85rem;padding:20px;">No variables available</div>';
        return;
      }
      
      container.innerHTML = '';
      
      allVariables.forEach((varName, index) => {
        const item = document.createElement('div');
        item.className = 'variable-item';
        item.id = `var-item-${index}`;
        item.style.display = 'flex';
        item.style.alignItems = 'center';
        item.style.justifyContent = 'space-between';
        item.style.padding = '8px';
        item.style.borderRadius = '4px';
        item.style.marginBottom = '4px';
        
        // Check if this variable is already on chart or is reference
        const dataset = datasets.find(d => {
          return (d.variableNames && d.variableNames[0] === varName) || 
                 (d.variables && d.variables[0] === varName);
        });
        const isOnChart = !!dataset;
        const isReference = varName === selectedReferenceVariable;
        
        if (isOnChart) {
          item.classList.add('in-dataset');
          item.setAttribute('data-on-chart', 'true');
        }
        
        const label = document.createElement('label');
        
        // Add icon for variables on chart
        let labelText = '';
        let suffix = '';
        if (isReference) {
          labelText = 'üìç ';
          suffix = ' (Reference)';
        } else if (isOnChart) {
          labelText = '‚úì ';
          suffix = ' (On Chart)';
        }
        
        label.innerHTML = labelText + '<span>' + varName + '</span>' + suffix;
        label.style.flex = '1';
        label.style.cursor = 'default';
        label.style.userSelect = 'none';
        
        if (isReference) {
          label.style.fontWeight = 'bold';
          label.style.color = '#4CAF50';
        }
        
        item.appendChild(label);
        
        // Add button only if not reference
        if (!isReference) {
          const btn = document.createElement('button');
          btn.className = 'btn btn-sm';
          btn.style.padding = '4px 10px';
          btn.style.fontSize = '0.75rem';
          
          if (isOnChart) {
            btn.textContent = '‚úï Remove';
            btn.style.background = 'var(--danger-color)';
            btn.title = 'Remove from chart';
          } else {
            btn.textContent = '+ Add';
            btn.title = 'Add to chart';
          }
          
          btn.onclick = () => {
            if (isOnChart) {
              removeVariableFromChart(varName);
            } else {
              addVariableToChart(varName);
            }
          };
          item.appendChild(btn);
        }
        
        // Visual indicator for variables on chart
        if (isOnChart && !isReference) {
          const badge = document.createElement('span');
          const chartDataset = datasets.find(d => d.variableNames[0] === varName);
          if (chartDataset) {
            badge.textContent = chartDataset.letter;
            badge.style.cssText = `
              background: ${chartDataset.color};
              color: #000;
              padding: 2px 8px;
              border-radius: 4px;
              font-weight: 900;
              font-size: 0.7rem;
              margin-left: 8px;
            `;
            item.insertBefore(badge, btn);
          }
        }
        
        container.appendChild(item);
      });
      
      // Update reference dropdown
      updateReferenceDropdown();
    }
    
    function updateVarCount() {
      document.getElementById('var-count').textContent = `(${allVariables.length})`;
    }
    
    function isVariableInAnyDataset(varName) {
      return datasets.some(dataset => dataset.variables.includes(varName));
    }
    
    // Legacy function - no longer needed but kept for compatibility
    function updateVariableCheckboxes() {
      // Now handled by renderVariableList()
      renderVariableList();
    }
    
    // ============================================
    // Dataset Management
    // ============================================
    
    /**
     * Add a single variable to the chart as its own point
     */
    function addVariableToChart(varName) {
      // Check if variable already exists
      if (datasets.find(d => d.variables[0] === varName)) {
        console.log(`‚ö†Ô∏è Variable "${varName}" already on chart`);
        return;
      }
      
      // Auto-assign letter (A, B, C, ...)
      const letter = String.fromCharCode(65 + datasets.length); // A=65
      const color = DEFAULT_COLORS[datasets.length % DEFAULT_COLORS.length];
      
      const dataset = {
        id: ++datasetIdCounter,
        letter: letter,
        name: varName,  // Use variable name directly
        variableNames: [varName],  // Single variable
        color: color,
        variables: [varName],  // Single variable
        visible: true,
        stats: {}
      };
      
      // Calculate stats if data available
      updateDatasetStats(dataset);
      
      datasets.push(dataset);
      
      renderDatasetList();
      updateChart();
      
      console.log(`‚úÖ Added variable "${varName}" as ${letter}:`, dataset);
    }
    
    /**
     * Add all variables to chart (each as individual point)
     */
    function addAllVariablesAsModels() {
      if (allVariables.length === 0) {
        alert('No variables available. Load data first.');
        return;
      }
      
      // Clear existing
      datasets = [];
      datasetIdCounter = 0;
      
      // Add each variable individually
      allVariables.forEach(varName => {
        addVariableToChart(varName);
      });
      
      console.log(`‚úÖ Added all ${allVariables.length} variables to chart`);
    }
    
    // Legacy function for backward compatibility
    function addDataset() {
      addAllVariablesAsModels();
    }
    
    function updateDatasetStats(dataset) {
      // Calculate average statistics across all variables in the dataset
      const stats = {
        r: 0,
        sd: 0,
        n: 0
      };
      
      let count = 0;
      let rSum = 0;
      let sdSum = 0;
      
      dataset.variables.forEach(varName => {
        if (variableData[varName]) {
          const varR = variableData[varName].r || 0;
          let varSD = variableData[varName].sd || 0;
          
          // Apply normalization if enabled
          if (isNormalized && referenceSDActual > 0) {
            varSD = varSD / referenceSDActual;
          }
          
          rSum += varR;
          sdSum += varSD;
          count++;
          
          console.log(`  ${varName}: r=${varR.toFixed(3)}, SD=${varSD.toFixed(3)}${isNormalized ? ' (normalized)' : ' (actual)'}`);
        }
      });
      
      if (count > 0) {
        stats.r = rSum / count;
        stats.sd = sdSum / count;
        stats.n = count;
        
        console.log(`‚úÖ ${dataset.name} (${dataset.letter}) stats: r=${stats.r.toFixed(3)}, SD=${stats.sd.toFixed(3)}`);
        
        // Validate stats
        if (isNaN(stats.r) || isNaN(stats.sd)) {
          console.error(`‚ùå Invalid stats for dataset "${dataset.name}": r=${stats.r}, SD=${stats.sd}`);
          stats.r = 0;
          stats.sd = 0;
        }
        
        if (stats.r < -1 || stats.r > 1) {
          console.warn(`‚ö†Ô∏è Correlation out of range for "${dataset.name}": r=${stats.r}, clamping...`);
          stats.r = Math.max(-1, Math.min(1, stats.r));
        }
      } else {
        console.warn(`‚ö†Ô∏è Dataset "${dataset.name}" has no valid variables`);
      }
      
      dataset.stats = stats;
    }
    
    function updateDatasetsWithVariable(varName) {
      datasets.forEach(dataset => {
        if (dataset.variables.includes(varName)) {
          updateDatasetStats(dataset);
        }
      });
      renderDatasetList();
      updateChart();
    }
    
    function toggleDatasetVisibility(datasetId) {
      const dataset = datasets.find(d => d.id === datasetId);
      if (dataset) {
        dataset.visible = !dataset.visible;
        renderDatasetList();
        updateChart();
      }
    }
    
    function removeDataset(datasetId) {
      console.log(`üóëÔ∏è Removing dataset with id: ${datasetId}`);
      
      const datasetToRemove = datasets.find(d => d.id === datasetId);
      if (datasetToRemove) {
        console.log(`   Removing: ${datasetToRemove.name} (${datasetToRemove.letter})`);
      }
      
      datasets = datasets.filter(d => d.id !== datasetId);
      
      console.log(`   Remaining datasets: ${datasets.length}`);
      
      // Reassign letters after removal
      datasets.forEach((ds, idx) => {
        ds.letter = String.fromCharCode(65 + idx);
        console.log(`   Reassigned ${ds.name} to letter ${ds.letter}`);
      });
      
      // Update UI
      renderVariableList();  // Update variable list to reflect changes
      renderDatasetList();
      updateChart();
      
      console.log(`‚úÖ Dataset removed successfully`);
    }
    
    function renderDatasetList() {
      const container = document.getElementById('dataset-list');
      document.getElementById('dataset-count').textContent = `(${datasets.length})`;
      
      if (datasets.length === 0) {
        container.innerHTML = '<div style="text-align:center;color:var(--text-muted);font-size:0.85rem;padding:20px;">No variables on chart yet</div>';
        return;
      }
      
      container.innerHTML = '';
      
      datasets.forEach(dataset => {
        const card = document.createElement('div');
        card.className = 'dataset-card';
        if (dataset.visible) card.classList.add('active');
        
        // Header
        const header = document.createElement('div');
        header.className = 'dataset-header';
        
        const nameDiv = document.createElement('div');
        nameDiv.className = 'dataset-name';
        
        const colorBox = document.createElement('div');
        colorBox.className = 'dataset-color';
        colorBox.style.backgroundColor = dataset.color;
        
        // Model letter badge
        const letterBadge = document.createElement('span');
        letterBadge.textContent = dataset.letter;
        letterBadge.style.cssText = `
          background: ${dataset.color};
          color: #000;
          font-weight: 900;
          font-size: 0.9rem;
          padding: 2px 8px;
          border-radius: 4px;
          margin-left: 4px;
          box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        `;
        
        const nameSpan = document.createElement('span');
        nameSpan.textContent = dataset.name;
        
        nameDiv.appendChild(colorBox);
        nameDiv.appendChild(letterBadge);
        nameDiv.appendChild(nameSpan);
        
        // Actions
        const actions = document.createElement('div');
        actions.className = 'dataset-actions';
        
        // Toggle visibility
        const toggleLabel = document.createElement('label');
        toggleLabel.className = 'toggle-switch';
        toggleLabel.title = 'Toggle visibility';
        
        const toggleInput = document.createElement('input');
        toggleInput.type = 'checkbox';
        toggleInput.checked = dataset.visible;
        toggleInput.addEventListener('change', () => toggleDatasetVisibility(dataset.id));
        
        const toggleSlider = document.createElement('span');
        toggleSlider.className = 'toggle-slider';
        
        toggleLabel.appendChild(toggleInput);
        toggleLabel.appendChild(toggleSlider);
        
        // Delete button
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'icon-btn';
        deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
        deleteBtn.title = 'Remove dataset';
        deleteBtn.onclick = () => {
          if (confirm(`Remove dataset "${dataset.name}"?`)) {
            removeDataset(dataset.id);
          }
        };
        
        actions.appendChild(toggleLabel);
        actions.appendChild(deleteBtn);
        
        header.appendChild(nameDiv);
        header.appendChild(actions);
        
        // Variables list
        const varsDiv = document.createElement('div');
        varsDiv.className = 'dataset-variables';
        varsDiv.textContent = `Variables (${dataset.variables.length}): ${dataset.variables.join(', ')}`;
        
        // Stats
        const statsDiv = document.createElement('div');
        statsDiv.className = 'dataset-stats';
        
        if (dataset.stats.n > 0) {
          const displaySD = dataset.stats.sd;
          const r = dataset.stats.r;
          const rSign = r >= 0 ? '+' : '-';
          const rAbs = Math.abs(r);
          statsDiv.innerHTML = `
            <div class="stat-box">
              <span class="stat-label">Avg r:</span>
              <span class="stat-value" style="color:${r >= 0 ? '#33FF57' : '#FF5733'}">${rSign}${rAbs.toFixed(3)}</span>
            </div>
            <div class="stat-box">
              <span class="stat-label">Avg SD:</span>
              <span class="stat-value">${displaySD.toFixed(3)}</span>
            </div>
          `;
        }
        
        card.appendChild(header);
        card.appendChild(varsDiv);
        if (dataset.stats.n > 0) {
          card.appendChild(statsDiv);
        }
        
        container.appendChild(card);
      });
    }
    
    // ============================================
    // Chart Rendering
    // ============================================
    
    /**
     * Initialize an empty Taylor Diagram chart on page load
     */
    function initializeEmptyChart() {
      console.log('üìä Initializing empty Taylor Diagram...');
      
      chart = Highcharts.chart('chart', {
        chart: {
          polar: true,
          type: 'scatter',
          backgroundColor: 'transparent',
          height: '100%',
          width: null,
          spacingTop: 20,
          spacingBottom: 60,
          spacingLeft: 20,
          spacingRight: 20
        },
        
        title: {
          text: 'Taylor Diagram',
          style: {
            color: '#fff',
            fontSize: '1.1rem',
            fontWeight: '600'
          }
        },
        
        subtitle: {
          text: 'Select a reference variable and add variables to begin',
          style: {
            color: 'rgba(255,255,255,0.6)',
            fontSize: '0.85rem'
          }
        },
        
        pane: {
          startAngle: 0,
          endAngle: 90,
          size: '85%'
        },
        
        xAxis: {
          tickInterval: 15,
          min: 0,
          max: 90,
          labels: {
            formatter: function() {
              const r = Math.cos(this.value * Math.PI / 180).toFixed(2);
              return `<span style="font-weight:600;">r=${r}</span>`;
            },
            style: { 
              color: '#fff',
              fontSize: '11px'
            },
            distance: 15
          },
          title: {
            text: '',
            style: { 
              color: 'rgb(120,200,255)',
              fontSize: '14px',
              fontWeight: '700',
              textShadow: '2px 2px 3px rgba(0,0,0,0.7)',
              letterSpacing: '0.5px'
            },
            align: 'middle',
            offset: 0,
            rotation: -50,
            y: -5,
            x: 70
          },
          gridLineColor: 'rgba(255,255,255,0.15)',
          gridLineWidth: 1
        },
        
        yAxis: {
          min: 0,
          max: 1.5,
          tickInterval: 0.25,
          title: {
            text: 'Standard Deviation (œÉ)',
            style: { 
              color: 'rgb(120,200,255)',
              fontSize: '13px',
              fontWeight: '600',
              textShadow: '1px 1px 2px rgba(0,0,0,0.5)'
            },
            align: 'middle',
            offset: 0,
            rotation: 90,
            y: 0,
            x: -45
          },
          labels: {
            style: { 
              color: '#fff',
              fontSize: '11px'
            },
            format: '{value:.2f}',
            distance: 10
          },
          gridLineColor: 'rgba(255,255,255,0.15)',
          gridLineWidth: 1
        },
        
        tooltip: {
          backgroundColor: 'rgba(26, 31, 46, 0.95)',
          borderColor: '#2d3748',
          style: { color: '#fff' },
          enabled: true
        },
        
        legend: {
          align: 'center',
          verticalAlign: 'bottom',
          layout: 'horizontal',
          y: -20,
          itemStyle: { 
            color: '#fff',
            fontSize: '12px'
          },
          itemHoverStyle: { 
            color: 'rgb(255,165,120)'
          },
          itemMarginTop: 5,
          itemMarginBottom: 5,
          itemDistance: 20
        },
        
        exporting: {
          enabled: true,
          buttons: {
            contextButton: {
              menuItems: [
                'viewFullscreen',
                'separator',
                'downloadPNG',
                'downloadJPEG',
                'downloadPDF',
                'downloadSVG',
                'separator',
                'downloadCSV',
                'downloadXLS'
              ],
              theme: {
                fill: 'rgba(255,255,255,0.1)',
                stroke: 'rgba(255,255,255,0.3)',
                states: {
                  hover: {
                    fill: 'rgba(255,255,255,0.2)'
                  },
                  select: {
                    fill: 'rgba(255,255,255,0.25)'
                  }
                }
              }
            }
          },
          chartOptions: {
            chart: {
              backgroundColor: '#1a1f2e'
            }
          }
        },
        
        series: [],
        
        credits: { enabled: false }
      });
      
      console.log('‚úÖ Empty chart initialized');
    }
    
    function updateChart() {
      console.log('üìä updateChart() called');
      
      // Check if we have datasets to display
      const visibleDatasets = datasets.filter(d => d.visible && d.stats.n > 0);
      
      console.log(`  Total variables: ${datasets.length}, Visible with data: ${visibleDatasets.length}`);
      
      // If no data, show await message and hide chart
      if (visibleDatasets.length === 0 || referenceData.length === 0) {
        console.log('  ‚ö†Ô∏è No visible variables with data - showing await message');
        document.getElementById('await-chart').classList.remove('hidden');
        document.getElementById('chart').style.display = 'none';
        if (chart) {
          chart.destroy();
          chart = null;
        }
        return;
      }
      
      // Show chart, hide await message
      document.getElementById('await-chart').classList.add('hidden');
      document.getElementById('chart').style.display = 'block';
      
      // Use normalized or actual reference SD based on toggle
      const referenceSD = isNormalized ? 1.0 : referenceSDActual;
      console.log(`  Reference SD: ${referenceSD} ${isNormalized ? '(normalized)' : '(actual)'}`);
      
      // Prepare series data
      const series = [];
      
      // Add reference point
      series.push({
        name: 'Reference',
        type: 'scatter',
        data: [{
          x: 0,
          y: referenceSD,
          name: 'Reference',
          marker: {
            fillColor: 'red',
            radius: 8,
            symbol: 'circle'
          }
        }],
        marker: {
          fillColor: 'red',
          radius: 8,
          symbol: 'circle'
        },
        showInLegend: true,
        zIndex: 10
      });
      
      // Add each visible dataset
      visibleDatasets.forEach(dataset => {
        // Ensure r is valid and clamped between -1 and 1
        let correlation = dataset.stats.r || 0;
        correlation = Math.max(-1, Math.min(1, correlation)); // Clamp to [-1, 1]
        
        // Use absolute value for angle calculation, but keep sign for display
        const correlationSign = correlation >= 0 ? '+' : '-';
        const absCorrelation = Math.abs(correlation);
        const theta = Math.acos(absCorrelation) * (180 / Math.PI);
        const stdDev = dataset.stats.sd || 0;
        
        console.log(`üìä Plotting ${dataset.name} (${dataset.letter}): r=${correlationSign}${absCorrelation.toFixed(3)}, Œ∏=${theta.toFixed(1)}¬∞, SD=${stdDev.toFixed(3)}`);
        
        // Skip if stdDev is 0 or invalid
        if (stdDev <= 0 || isNaN(stdDev) || isNaN(theta)) {
          console.warn(`‚ö†Ô∏è Skipping ${dataset.name} (${dataset.letter}): invalid data (SD=${stdDev}, theta=${theta})`);
          return;
        }
        
        // Determine marker style based on correlation sign
        const markerSymbol = correlation >= 0 ? 'circle' : 'diamond';
        const markerRadius = correlation >= 0 ? 8 : 9;
        
        series.push({
          name: `${dataset.name} (${dataset.letter}) r=${correlationSign}${absCorrelation.toFixed(2)}`,
          type: 'scatter',
          data: [{
    x: theta,
            y: stdDev,
            name: dataset.name,
            modelLetter: dataset.letter,
            r: correlation,
            rAbs: absCorrelation,
            rSign: correlationSign,
            sd: stdDev,
            varCount: dataset.variables.length,
            variableNames: dataset.variableNames.join(', '),
            color: dataset.color
          }],
          color: dataset.color,
          marker: {
            fillColor: dataset.color,
            radius: markerRadius,
            symbol: markerSymbol,
            lineWidth: 2.5,
            lineColor: correlation >= 0 ? '#fff' : '#333'
          },
          dataLabels: {
            enabled: true,
            format: dataset.letter,
            style: {
              color: '#fff',
              fontSize: '14px',
              fontWeight: 'bold',
              textOutline: '2px contrast'
            },
            y: -15,
            x: 0
          },
          showInLegend: true
        });
        
        // Add RMSE line
        series.push({
    type: 'line',
          name: `${dataset.name} RMSE`,
          color: dataset.color,
    dashStyle: 'Dash',
    marker: { enabled: false },
    enableMouseTracking: false,
    data: [
      { x: 0, y: referenceSD },
            { x: theta, y: stdDev }
          ],
          linkedTo: ':previous',
          showInLegend: false,
          zIndex: 1,
          opacity: 0.6
  });
});

      console.log(`  ‚úÖ Created ${series.length} series (${visibleDatasets.length} variables + reference + RMSE lines)`);
      
      // Calculate appropriate axis max
      const maxSD = Math.max(
        referenceSD,
        ...visibleDatasets.map(d => d.stats.sd)
      );
      const axisMax = Math.ceil(maxSD * 1.3 * 4) / 4; // Round up to nearest 0.25
      
      console.log(`  Max SD: ${maxSD.toFixed(2)}, Axis max: ${axisMax.toFixed(2)}`);
      
      // If chart exists, update it dynamically
      if (chart) {
        console.log('  üîÑ Updating existing chart...');
        
        // Update y-axis
        chart.yAxis[0].update({
          max: axisMax,
          tickInterval: axisMax > 2 ? 0.5 : 0.25,
          title: {
            text: isNormalized ? 'Standard Deviation (œÉ) - Normalized' : 'Standard Deviation (œÉ)'
          }
        }, false);
        
        // Update subtitle
        chart.setTitle(null, {
          text: `${visibleDatasets.length} variable${visibleDatasets.length > 1 ? 's' : ''} ‚Ä¢ Reference SD: ${referenceSD.toFixed(3)} ${isNormalized ? '(normalized)' : '(actual)'} ‚Ä¢ ‚óè Positive r  ‚óÜ Negative r`
        }, false);
        
        // Remove all existing series
        while(chart.series.length > 0) {
          chart.series[0].remove(false);
        }
        
        // Add new series
        series.forEach(s => {
          chart.addSeries(s, false);
        });
        
        // Redraw chart once with all changes
        chart.redraw();
        
        console.log(`  ‚úÖ Chart updated with ${series.length} series`);
        return;
      }
      
      // Create new chart
      console.log('  üé® Creating new Highcharts Taylor diagram...');
      
      chart = Highcharts.chart('chart', {
  chart: {
    polar: true,
          type: 'scatter',
          backgroundColor: 'transparent',
          height: '100%',
          width: null,
          spacingTop: 20,
          spacingBottom: 60,
          spacingLeft: 20,
          spacingRight: 20
  },

  title: {
          text: 'Taylor Diagram',
          style: {
            color: '#fff',
            fontSize: '1.1rem',
            fontWeight: '600'
          }
        },
        
        subtitle: {
          text: `${visibleDatasets.length} variable${visibleDatasets.length > 1 ? 's' : ''} ‚Ä¢ Reference SD: ${referenceSD.toFixed(3)} ${isNormalized ? '(normalized)' : '(actual)'} ‚Ä¢ ‚óè Positive r  ‚óÜ Negative r`,
          style: {
            color: 'rgba(255,255,255,0.6)',
            fontSize: '0.85rem'
          }
  },

  pane: {
    startAngle: 0,
          endAngle: 90,
          size: '85%'
  },

  xAxis: {
    tickInterval: 15,
    min: 0,
    max: 90,
    labels: {
            formatter: function() {
        const r = Math.cos(this.value * Math.PI / 180).toFixed(2);
              return `<span style="font-weight:600;">r=${r}</span>`;
            },
            style: { 
              color: '#fff',
              fontSize: '11px'
            },
            distance: 15
    },
    title: {
            text: '',
            style: { 
              color: 'rgb(120,200,255)',
              fontSize: '14px',
              fontWeight: '700',
              textShadow: '2px 2px 3px rgba(0,0,0,0.7)',
              letterSpacing: '0.5px'
            },
            align: 'middle',
            offset: 0,
            rotation: -50,
            y: -5,
            x: 70
          },
          gridLineColor: 'rgba(255,255,255,0.15)',
          gridLineWidth: 1
  },

  yAxis: {
    min: 0,
          max: axisMax,
          tickInterval: axisMax > 2 ? 0.5 : 0.25,
    title: {
            text: isNormalized ? 'Standard Deviation (œÉ) - Normalized' : 'Standard Deviation (œÉ)',
            style: { 
              color: 'rgb(120,200,255)',
              fontSize: '13px',
              fontWeight: '600',
              textShadow: '1px 1px 2px rgba(0,0,0,0.5)'
            },
            align: 'middle',
            offset: 0,
            rotation: 90,
            y: 0,
            x: -45
          },
          labels: {
            style: { 
              color: '#fff',
              fontSize: '11px'
            },
            format: '{value:.2f}',
            distance: 10
          },
          gridLineColor: 'rgba(255,255,255,0.15)',
          gridLineWidth: 1
  },

  tooltip: {
          backgroundColor: 'rgba(26, 31, 46, 0.95)',
          borderColor: '#2d3748',
          style: { color: '#fff' },
          formatter: function() {
      if (this.point.name === 'Reference') {
              return `<b>Reference Point</b><br>SD = ${this.point.y.toFixed(3)}`;
      }

      const theta = this.point.x * Math.PI / 180;
      const sd = this.point.y;
            const r = this.point.r;
            const rSign = this.point.rSign || (r >= 0 ? '+' : '-');
            const rAbs = this.point.rAbs || Math.abs(r);
      const rmse = Math.sqrt(
        referenceSD ** 2 + sd ** 2 - 2 * referenceSD * sd * Math.cos(theta)
      ).toFixed(3);

            return `<b style="font-size:14px;">${this.point.name}</b> <span style="background:${this.point.color};color:#000;padding:2px 6px;border-radius:3px;font-weight:900;">${this.point.modelLetter}</span><br>
                    <span style="color:${this.point.color};font-size:16px;">‚óè</span> <b>r = ${rSign}${rAbs.toFixed(3)}</b> ${rSign === '-' ? '(negative)' : '(positive)'}<br>
                    SD = ${sd.toFixed(3)}<br>
              Œ∏ = ${this.point.x.toFixed(1)}¬∞<br>
                    RMSE = ${rmse}`;
          }
  },

        legend: {
          align: 'center',
          verticalAlign: 'bottom',
          layout: 'horizontal',
          y: -20,
          itemStyle: { 
            color: '#fff',
            fontSize: '12px'
          },
          itemHoverStyle: { 
            color: 'rgb(255,165,120)'
          },
          itemMarginTop: 5,
          itemMarginBottom: 5,
          itemDistance: 20
        },
        
        exporting: {
          enabled: true,
          buttons: {
            contextButton: {
              menuItems: [
                'viewFullscreen',
                'separator',
                'downloadPNG',
                'downloadJPEG',
                'downloadPDF',
                'downloadSVG',
                'separator',
                'downloadCSV',
                'downloadXLS'
              ],
              theme: {
                fill: 'rgba(255,255,255,0.1)',
                stroke: 'rgba(255,255,255,0.3)',
                states: {
                  hover: {
                    fill: 'rgba(255,255,255,0.2)'
                  },
                  select: {
                    fill: 'rgba(255,255,255,0.25)'
                  }
                }
              }
            }
          },
          chartOptions: {
            chart: {
              backgroundColor: '#1a1f2e'
            }
          }
        },
        
        series: series,
        
        credits: { enabled: false }
      });
      
      console.log('  ‚úÖ Taylor diagram chart created successfully');
    }
    
    // ============================================
    // VB Communication Helpers
    // ============================================
    
    function sendMessageToVB6(action, data) {
      try {
        console.log('üì§ Sending to VB6:', action, data);
        
        if (typeof vbH !== 'undefined' && vbH && typeof vbH === 'function') {
          try {
            vbH().RaiseMessageEvent(action, data || action);
            console.log('‚úÖ Message sent via vbH().RaiseMessageEvent');
            return true;
          } catch (bridgeErr) {
            console.warn('‚ùå vbH bridge failed:', bridgeErr);
          }
        }
        
        if (window.external && window.external.OrdoWebView1_JSMessage) {
          const message = data ? `${action}|${typeof data === 'string' ? data : JSON.stringify(data)}` : action;
          window.external.OrdoWebView1_JSMessage(message);
          console.log('‚úÖ Message sent via OrdoWebView1_JSMessage');
          return true;
        }
        
        if (window.chrome && window.chrome.webview && window.chrome.webview.postMessage) {
          window.chrome.webview.postMessage(JSON.stringify({ action, data }));
          console.log('‚úÖ Message sent via chrome.webview.postMessage');
          return true;
        }
        
        if (window.external && typeof window.external.sendMessageToVB6 === 'function') {
          window.external.sendMessageToVB6(action, typeof data === 'string' ? data : JSON.stringify(data || {}));
          console.log('‚úÖ Message sent via window.external.sendMessageToVB6');
          return true;
        }
        
        console.warn('‚ö†Ô∏è No VB6 bridge available');
        return false;
      } catch (error) {
        console.error('Error sending message to VB6:', error);
        return false;
      }
    }
    
    function requestDataForVariable(varName) {
      sendMessageToVB6('RequestVariableData', { variable: varName });
    }
    
    function requestAllData() {
      sendMessageToVB6('RequestAllVariableData');
    }
    
    // ============================================
    // Initialization
    // ============================================
    
    // Set current page for navigation
    window.currentAnalysisPage = 'taylor-diagram';

    window.addEventListener('DOMContentLoaded', function() {
      console.log('üöÄ Taylor Diagram initialized');
      
      // Keyboard shortcut: Press 'P' to toggle panel
      document.addEventListener('keydown', function(e) {
        if (e.key === 'p' || e.key === 'P') {
          if (!e.target.matches('input, textarea')) {
            toggleLeftPanel();
          }
        }
      });
      
      // Try to load from sessionStorage first
      const storedData = sessionStorage.getItem('analysisData');
      if (storedData) {
        try {
          const { data, headers } = JSON.parse(storedData);
          console.log('‚úÖ Found data in sessionStorage');
          console.log(`üìä Data: ${data.length} rows, ${headers.length} columns`);
          
          // Check InputsXL panel for selected variables (SOURCE OF TRUTH)
          let selectedHeaders = headers;
          
          // Try localStorage first (works across separate WebViews)
          try {
              const storedSelection = localStorage.getItem('inputsXL_selectedVariables');
              if (storedSelection) {
                  const selectedVars = JSON.parse(storedSelection);
                  const filteredSelection = selectedVars.filter(v => headers.includes(v));
                  if (filteredSelection.length >= 2) {
                      selectedHeaders = filteredSelection;
                      console.log('‚úÖ Using InputsXL selection from localStorage:', selectedHeaders);
                  } else {
                      console.log('‚ÑπÔ∏è Not enough selected variables in localStorage (need 2+), using all');
                  }
              }
          } catch (e) {
              console.log('‚ÑπÔ∏è No localStorage selection available');
          }
          
          // Fallback: Try window.parent
          if (selectedHeaders === headers) {
              try {
                  if (window.parent && window.parent !== window && window.parent.getSelectedVariables) {
                      const parentSelected = window.parent.getSelectedVariables();
                      if (Array.isArray(parentSelected) && parentSelected.length >= 2) {
                          selectedHeaders = parentSelected;
                          console.log('‚úÖ Using selected variables from InputsXL panel (window.parent):', selectedHeaders);
                      }
                  } else if (window.parent && window.parent !== window && window.parent.selectedVariables) {
                      const parentSelected = window.parent.selectedVariables;
                      if (Array.isArray(parentSelected) && parentSelected.length >= 2) {
                          selectedHeaders = parentSelected;
                          console.log('‚úÖ Using selectedVariables from InputsXL panel:', selectedHeaders);
                      }
                  }
              } catch (e) {
                  console.log('‚ÑπÔ∏è Could not access InputsXL panel via window.parent');
              }
          }
          
          console.log('üìä Showing Taylor Diagram for', selectedHeaders.length, 'variables:', selectedHeaders);
          
          // Convert array of objects to object of arrays (format expected by Taylor Diagram)
          // Use only selected variables
          const convertedData = {};
          selectedHeaders.forEach(header => {
            convertedData[header] = data.map(row => row[header]);
          });
          
          console.log('üîÑ Converting data for Taylor Diagram...');
          injectDataFromVB6(convertedData);
          
          // Auto-select first variable as reference (use selectedHeaders)
          setTimeout(() => {
            if (selectedHeaders.length > 0) {
              selectedReferenceVariable = selectedHeaders[0];
              const refSelect = document.getElementById('reference-variable-select');
              if (refSelect) {
                refSelect.value = selectedHeaders[0];
                setReferenceVariable();
                console.log(`‚úÖ Auto-selected '${selectedHeaders[0]}' as reference variable`);
              }
            }
          }, 100);
          
          return; // Skip demo data if we loaded from sessionStorage
        } catch (error) {
          console.error('‚ùå Error loading from sessionStorage:', error);
        }
      }
      
      // Demo data for testing (disabled by default - enable by setting window.ENABLE_DEMO_DATA = true)
      if (!window.__INJECTED_FROM_VB6__ && window.ENABLE_DEMO_DATA) {
        console.log('üß™ Loading demo data...');
        setTimeout(function() {
          const demoData = {
            'Var1': [5.3, 4.9, 5.6, 5.0, 5.2, 5.4, 4.8, 5.5, 5.1, 5.3,
                     5.0, 5.2, 5.4, 5.1, 4.9, 5.3, 5.2, 5.0, 5.4, 5.1],
            'Var2': [5.1, 4.7, 5.4, 4.8, 5.0, 5.2, 4.6, 5.3, 4.9, 5.1, 
                     4.8, 5.0, 5.2, 4.9, 4.7, 5.1, 5.0, 4.8, 5.2, 4.9],
            'Var3': [5.4, 4.6, 5.7, 5.1, 5.3, 5.5, 4.5, 5.6, 5.2, 5.4, 
                     5.1, 5.3, 5.5, 5.2, 5.0, 5.4, 5.3, 5.1, 5.5, 5.2],
            'Var4': [5.0, 5.2, 5.3, 4.7, 4.9, 5.1, 5.0, 5.2, 4.8, 5.0, 
                     5.1, 4.9, 5.2, 4.8, 5.0, 5.1, 4.9, 5.1, 5.0, 4.9],
            'Reference': [5.2, 4.8, 5.5, 4.9, 5.1, 5.3, 4.7, 5.4, 5.0, 5.2,
                         4.9, 5.1, 5.3, 5.0, 4.8, 5.2, 5.1, 4.9, 5.3, 5.0]
          };
          
          injectDataFromVB6(demoData);
          
          // Auto-select 'Reference' as reference variable
          setTimeout(() => {
            selectedReferenceVariable = 'Reference';
            document.getElementById('reference-variable-select').value = 'Reference';
            setReferenceVariable();
            console.log('‚úÖ Demo data loaded');
          }, 100);
        }, 500);
      } else if (!window.__INJECTED_FROM_VB6__ && !storedData) {
        console.log('‚ÑπÔ∏è Waiting for data from VB6... (Use injectDataFromVB6 function)');
      }
    });
    
    // Make functions globally accessible for VB calls
    window.setReferenceData = setReferenceData;
    window.updateVariableList = updateVariableList;
    window.updateVariableData = updateVariableData;
    window.updateAllVariableData = updateAllVariableData;
    window.addDataset = addDataset;
    window.addAllVariablesAsModels = addAllVariablesAsModels;
    window.addVariableToChart = addVariableToChart;
    window.updateChart = updateChart;
    window.requestDataForVariable = requestDataForVariable;
    window.requestAllData = requestAllData;
    window.toggleLeftPanel = toggleLeftPanel;
    window.toggleNormalization = toggleNormalization;
    
</script>
<script>
  Office.onReady(function() {
    if (typeof StatisticoHeader !== 'undefined') {
      StatisticoHeader.init('taylor-diagram', 'Taylor Diagram', 0, 'correlations');
    }

    Office.context.ui.addHandlerAsync(
      Office.EventType.DialogParentMessageReceived,
      onMessageFromParent
    );

    Office.context.ui.messageParent(JSON.stringify({ action: 'ready' }));
  });

  function onMessageFromParent(arg) {
    try {
      const message = JSON.parse(arg.message);
      if (message.type === 'CORRELATION_DATA' && message.payload) {
        const correlationData = message.payload;
        const headers = correlationData.headers || [];
        const rows = correlationData.data || [];
        const payload = buildTaylorPayload(headers, rows);
        injectDataFromVB6(payload);

        if (typeof StatisticoHeader !== 'undefined') {
          StatisticoHeader.sampleSize = rows.length;
          StatisticoHeader.variableName = `${headers.length} Variables`;
          StatisticoHeader.render();
        }
      }
    } catch (error) {
      console.error('Error parsing message:', error);
    }
  }

  function buildTaylorPayload(headers, rows) {
    const payload = {};
    headers.forEach(header => {
      payload[header] = [];
    });
    rows.forEach(row => {
      headers.forEach(header => {
        const raw = row[header];
        const value = typeof raw === 'number' ? raw : parseFloat(raw);
        payload[header].push(Number.isFinite(value) ? value : NaN);
      });
    });
    return payload;
  }
</script>
</body>
</html>














