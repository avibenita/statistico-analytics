<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <title>Correlation Matrix</title>
  
  <!-- Office.js -->
  <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
  
  <!-- Font Awesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet"/>
  
  <!-- Shared Header -->
  <link rel="stylesheet" href="../shared-header.css">
  <script src="../shared-header.js"></script>

  <style>
    :root{
      --surface-0:#0c1624;
      --surface-1:#1a1f2e;
      --surface-2:#242938;
      --border:#2d3748;
      --accent-1:rgb(255,165,120);
      --accent-2:rgb(120,200,255);
      --text-primary:#fff;
      --text-secondary:rgba(255,255,255,0.8);
      --text-muted:rgba(255,255,255,0.5);
    }

    *{
      margin:0;
      padding:0;
      box-sizing:border-box;
    }

    body{
      font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,sans-serif;
      background:linear-gradient(135deg, var(--surface-0) 0%, #1a2332 100%);
      color:var(--text-primary);
      line-height:1.6;
      padding:0;
      margin:0;
      min-height:100vh;
      overflow-x:hidden;
    }

    .container{
      max-width:100%;
      margin:0;
      padding:0;
      display:flex;
      flex-direction:column;
      min-height:100vh;
    }

    .results-container{
      flex:1;
      padding:20px;
      overflow:auto;
    }

    h1{
      font-size:28px;
      color:var(--accent-1);
      margin-bottom:25px;
      text-align:center;
      font-weight:600;
    }

    /* Control Group */
    .controls{
      background:var(--surface-1);
      padding:20px;
      border-radius:10px;
      margin-bottom:25px;
      border:2px solid var(--border);
      box-shadow:0 4px 20px rgba(0,0,0,0.3);
      display:flex;
      align-items:center;
      gap:16px;
      flex-wrap:nowrap;
      overflow-x:auto;
    }

    .control-group{
      margin-bottom:0;
      flex:0 0 auto;
    }

    .type-group{
      min-width:320px;
    }

    .control-group label{
      font-size:14px;
      color:var(--text-secondary);
      font-weight:600;
      margin-bottom:8px;
      display:block;
    }

    /* Radio Bar */
    .radio-bar{
      display:flex;
      gap:8px;
      flex-wrap:nowrap;
      align-items:center;
    }

    .radio-bar label{
      flex:0 0 auto;
      min-width:90px;
      background:var(--surface-2);
      border:2px solid var(--border);
      border-radius:8px;
      padding:8px 12px;
      cursor:pointer;
      transition:all 0.3s ease;
      display:flex;
      align-items:center;
      justify-content:center;
      white-space:nowrap;
      flex-shrink:0;
      font-size:13px;
    }

    .radio-bar label:hover{
      border-color:var(--accent-1);
      transform:translateY(-2px);
    }

    .radio-bar input[type="radio"]{
      display:none;
    }

    .radio-bar input[type="radio"]:checked + span{
      color:var(--accent-1);
      font-weight:700;
    }

    .radio-bar label:has(input:checked){
      background:linear-gradient(135deg, rgba(255,165,120,0.2), rgba(120,200,255,0.2));
      border-color:var(--accent-1);
      box-shadow:0 0 15px rgba(255,165,120,0.3);
    }

    /* Filter Controls Frame */
    .filter-controls-frame{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:20px;
      margin-top:20px;
      padding-top:20px;
      border-top:1px solid var(--border);
      flex-wrap:nowrap;
    }

    .slider-center{
      flex:1;
      display:flex;
      justify-content:center;
    }

    .checkbox-right{
      flex-shrink:0;
    }

    .slider-container{
      display:flex;
      align-items:center;
      gap:12px;
      margin-bottom:0;
      flex:1;
      min-width:260px;
    }

    .slider-label{
      font-size:14px;
      color:var(--text-secondary);
      font-weight:600;
      white-space:nowrap;
    }

    input[type="range"]{
      flex:1;
      min-width:200px;
      height:8px;
      border-radius:5px;
      background:linear-gradient(90deg, var(--surface-2) 0%, var(--accent-1) 100%);
      outline:none;
      -webkit-appearance:none;
    }

    input[type="range"]::-webkit-slider-thumb{
      -webkit-appearance:none;
      appearance:none;
      width:20px;
      height:20px;
      border-radius:50%;
      background:linear-gradient(135deg, var(--accent-1), var(--accent-2));
      cursor:pointer;
      box-shadow:0 2px 10px rgba(255,165,120,0.5);
      transition:all 0.3s ease;
    }

    input[type="range"]::-webkit-slider-thumb:hover{
      transform:scale(1.2);
      box-shadow:0 4px 15px rgba(255,165,120,0.7);
    }

    input[type="range"]::-moz-range-thumb{
      width:20px;
      height:20px;
      border-radius:50%;
      background:linear-gradient(135deg, var(--accent-1), var(--accent-2));
      cursor:pointer;
      border:none;
      box-shadow:0 2px 10px rgba(255,165,120,0.5);
      transition:all 0.3s ease;
    }

    input[type="range"]::-moz-range-thumb:hover{
      transform:scale(1.2);
      box-shadow:0 4px 15px rgba(255,165,120,0.7);
    }

    .slider-value{
      font-size:16px;
      color:var(--accent-1);
      font-weight:700;
      min-width:50px;
      text-align:right;
    }

    /* Checkbox Group */
    .checkbox-group{
      display:flex;
      gap:15px;
      flex-wrap:nowrap;
      margin-bottom:0;
      align-items:center;
      white-space:nowrap;
    }

    .checkbox-label{
      display:flex;
      align-items:center;
      gap:8px;
      cursor:pointer;
      font-size:14px;
      color:var(--text-secondary);
      transition:color 0.3s ease;
    }

    .checkbox-label:hover{
      color:var(--text-primary);
    }

    .checkbox-label input[type="checkbox"]{
      width:18px;
      height:18px;
      cursor:pointer;
      accent-color:var(--accent-1);
    }

    .checkbox-label:has(input:checked){
      color:var(--accent-1);
      font-weight:600;
    }

    .table-container{
      width:100%;
      border:2px solid var(--border);
      border-radius:8px;
      overflow:auto;
      max-height:70vh;
      position:relative;
      scroll-behavior:smooth;
      background:
        linear-gradient(90deg, var(--surface-1) 30%, rgba(26,31,46,0)),
        linear-gradient(90deg, rgba(26,31,46,0), var(--surface-1) 70%) 100% 0,
        radial-gradient(farthest-side at 0 50%, rgba(0,0,0,.3), rgba(0,0,0,0)),
        radial-gradient(farthest-side at 100% 50%, rgba(0,0,0,.3), rgba(0,0,0,0)) 100% 0;
      background-repeat:no-repeat;
      background-color:var(--surface-1);
      background-size:40px 100%, 40px 100%, 14px 100%, 14px 100%;
      background-attachment:local, local, scroll, scroll;
    }

    .table-container::-webkit-scrollbar{
      height:12px;
      width:12px;
    }

    .table-container::-webkit-scrollbar-track{
      background:var(--surface-2);
      border-radius:6px;
    }

    .table-container::-webkit-scrollbar-thumb{
      background:linear-gradient(135deg, var(--accent-1), var(--accent-2));
      border-radius:6px;
      border:2px solid var(--surface-2);
    }

    .table-container::-webkit-scrollbar-thumb:hover{
      background:linear-gradient(135deg, #ffb890, #90d0ff);
    }

    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      background:var(--surface-1);
    }

    thead{
      position:sticky;
      top:0;
      z-index:10;
      background:var(--surface-2);
    }

    thead th{
      position:sticky;
      top:0;
      background:linear-gradient(135deg, var(--surface-2), #2d3545);
      padding:12px 10px;
      text-align:center;
      font-weight:700;
      font-size:13px;
      color:var(--accent-1);
      border-bottom:2px solid var(--accent-1);
      border-right:1px solid var(--border);
      white-space:nowrap;
    }

    thead th:first-child{
      position:sticky;
      left:0;
      z-index:11;
      text-align:left;
      min-width:150px;
    }

    tbody tr:nth-child(even){
      background:rgba(36,41,56,0.5);
    }

    tbody tr:hover{
      background:rgba(255,165,120,0.05);
    }

    tbody td{
      padding:10px;
      text-align:center;
      font-size:12px;
      border-right:1px solid var(--border);
      border-bottom:1px solid var(--border);
    }

    tbody td:first-child{
      position:sticky;
      left:0;
      background:inherit;
      font-weight:700;
      text-align:left;
      color:var(--accent-2);
      z-index:2;
      min-width:150px;
    }

    tbody tr:nth-child(even) td:first-child{
      background:rgba(36,41,56,0.5);
    }

    tbody tr:hover td:first-child{
      background:rgba(255,165,120,0.05);
    }

    .corr-value{
      font-weight:700;
      font-size:14px;
    }

    .p-value{
      font-size:11px;
      color:var(--text-muted);
    }

    .n-value{
      font-size:10px;
      color:var(--text-muted);
      font-style:italic;
    }

    .diagonal-cell{
      background:linear-gradient(135deg, rgba(120,200,255,0.15), rgba(255,165,120,0.15))!important;
      position:relative;
    }

    .diagonal-cell::after{
      content:'';
      position:absolute;
      top:0;
      left:0;
      right:0;
      bottom:0;
      border:1px solid rgba(120,200,255,0.3);
      pointer-events:none;
    }

    .threshold-highlight{
      background:linear-gradient(135deg, rgba(255,165,120,0.25), rgba(120,200,255,0.25))!important;
      box-shadow:inset 0 0 8px rgba(255,165,120,0.4);
      animation:pulse-highlight 2s ease-in-out infinite;
    }

    @keyframes pulse-highlight{
      0%, 100%{
        box-shadow:inset 0 0 8px rgba(255,165,120,0.4);
      }
      50%{
        box-shadow:inset 0 0 15px rgba(255,165,120,0.6);
      }
    }

    .loading{
      text-align:center;
      padding:60px 20px;
      color:var(--text-secondary);
    }

    .loading i{
      font-size:48px;
      color:var(--accent-1);
      animation:spin 1s linear infinite;
    }

    @keyframes spin{
      0%{transform:rotate(0deg);}
      100%{transform:rotate(360deg);}
    }

    .loading p{
      margin-top:20px;
      font-size:18px;
    }

    .scroll-hint{
      background:linear-gradient(135deg, rgba(255,165,120,0.15), rgba(120,200,255,0.15));
      padding:12px 20px;
      border-radius:8px;
      text-align:center;
      margin-bottom:15px;
      font-size:14px;
      color:var(--text-secondary);
      border:1px solid rgba(255,165,120,0.3);
    }

    .scroll-hint i{
      color:var(--accent-1);
      margin-right:8px;
    }

    /* Responsive Design */
    @media (max-width: 1200px){
      .filter-controls-frame{
        flex-direction:column;
        align-items:flex-start;
      }
      .slider-center{
        width:100%;
        justify-content:flex-start;
      }
      input[type="range"]{
        min-width:150px;
      }
    }

    @media (max-width: 768px){
      .results-container{
        padding:15px;
      }
      h1{
        font-size:22px;
      }
      .controls{
        padding:15px;
      }
      .radio-bar{
        flex-direction:column;
      }
      .radio-bar label{
        min-width:unset;
      }
      tbody td{
        font-size:11px;
        padding:8px;
      }
      .corr-value{
        font-size:12px;
      }
    }

    @media (max-width: 480px){
      .results-container{
        padding:10px;
      }
      h1{
        font-size:18px;
      }
      .controls{
        padding:12px;
      }
      input[type="range"]{
        min-width:100px;
      }
    }
  </style>
</head>
<body>
  <div class="container" id="mainContainer" style="display:none;">
    <div id="header-container"></div>

    <div class="results-container">
      <div class="controls">
        <div class="control-group type-group">
          <label>Correlation Type:</label>
          <div class="radio-bar">
            <label>
              <input type="radio" name="corrType" value="Pearson" checked onchange="recalculate()">
              <span>Pearson</span>
            </label>
            <label>
              <input type="radio" name="corrType" value="Spearman" onchange="recalculate()">
              <span>Spearman</span>
            </label>
            <label>
              <input type="radio" name="corrType" value="Kendall" onchange="recalculate()">
              <span>Kendall</span>
            </label>
          </div>
        </div>
        <div class="control-group slider-container">
          <span class="slider-label">Highlight r ≥</span>
          <input type="range" id="thresholdSlider" min="0" max="1" step="0.05" value="0" oninput="updateThreshold(this.value)">
          <span class="slider-value" id="thresholdValue">0.00</span>
        </div>
        <div class="control-group checkbox-group">
          <label class="checkbox-label">
            <input type="checkbox" id="showPValue" checked onchange="toggleDisplay()">
            <span>Show p-value</span>
          </label>
          <label class="checkbox-label">
            <input type="checkbox" id="showN" checked onchange="toggleDisplay()">
            <span>Show n</span>
          </label>
        </div>
      </div>

      <div id="loadingMessage" class="loading">
        <i class="fa-solid fa-spinner"></i>
        <p>Loading correlation data...</p>
      </div>

      <div id="resultsContainer" style="display:none;">
        <div class="scroll-hint">
          <i class="fa-solid fa-arrows-left-right"></i>
          Scroll horizontally to view all variables • First column stays fixed
        </div>
        
        <div class="table-container">
          <table id="correlationTable">
            <thead id="tableHead"></thead>
            <tbody id="tableBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script>
    let correlationData = null;
    let currentType = 'Pearson';

    // Initialize Office.js
    Office.onReady(function(info) {
      console.log('Office initialized in correlation matrix dialog');
      
      // Initialize shared header
      if (typeof StatisticoHeader !== 'undefined') {
        StatisticoHeader.init('correlation-matrix', 'Correlation Matrix', 0, 'correlations');
      }
      
      // Listen for messages from parent
      Office.context.ui.addHandlerAsync(
        Office.EventType.DialogParentMessageReceived,
        onMessageFromParent
      );
      
      // Notify parent that dialog is ready
      Office.context.ui.messageParent(JSON.stringify({
        action: 'ready'
      }));
    });

    /**
     * Handle messages from parent taskpane
     */
    function onMessageFromParent(arg) {
      try {
        const message = JSON.parse(arg.message);
        console.log('Received message from parent:', message);

        if (message.type === 'CORRELATION_DATA' && message.payload) {
          correlationData = message.payload;
          console.log('Correlation data received:', correlationData);
          renderMatrix();
        }
      } catch (error) {
        console.error('Error parsing message:', error);
      }
    }

    /**
     * Render correlation matrix
     */
    function renderMatrix() {
      const container = document.getElementById('mainContainer');
      const loading = document.getElementById('loadingMessage');
      const results = document.getElementById('resultsContainer');

      if (!correlationData || !correlationData.headers || correlationData.headers.length === 0) {
        console.error('Invalid correlation data');
        loading.innerHTML = '<i class="fa-solid fa-exclamation-triangle"></i><p>No correlation data available</p>';
        container.style.display = 'flex';
        return;
      }

      console.log('Rendering matrix with data:', correlationData);
      
      // Calculate sample size
      const sampleSize = correlationData.data ? correlationData.data.length : 0;
      
      // Update header with correct sample size
      if (typeof StatisticoHeader !== 'undefined') {
        StatisticoHeader.sampleSize = sampleSize;
        StatisticoHeader.variableName = `${correlationData.headers.length} Variables`;
        StatisticoHeader.render();
      }
      
      // Hide loading, show results
      loading.style.display = 'none';
      results.style.display = 'block';
      container.style.display = 'flex';

      // Build correlation matrix
      buildCorrelationMatrix();
    }

    /**
     * Build correlation table
     */
    function buildCorrelationMatrix() {
      const { headers, data, types } = correlationData;
      console.log('Building matrix for headers:', headers);

      // Calculate correlations
      const matrix = calculateCorrelationMatrix(data, headers, currentType);
      
      // Build table
      const thead = document.getElementById('tableHead');
      const tbody = document.getElementById('tableBody');
      
      // Clear existing content
      thead.innerHTML = '';
      tbody.innerHTML = '';

      // Create header row
      const headerRow = document.createElement('tr');
      const cornerTh = document.createElement('th');
      cornerTh.textContent = 'Variable';
      headerRow.appendChild(cornerTh);

      headers.forEach(col => {
        const th = document.createElement('th');
        th.textContent = col;
        headerRow.appendChild(th);
      });

      thead.appendChild(headerRow);

      // Create data rows
      headers.forEach((rowCol, i) => {
        const row = document.createElement('tr');
        
        // Row header
        const rowTh = document.createElement('td');
        rowTh.textContent = rowCol;
        row.appendChild(rowTh);

        // Correlation cells
        headers.forEach((colCol, j) => {
          const td = document.createElement('td');
          const corrData = matrix[i][j];

          // Check if diagonal
          const isDiagonal = i === j;
          if (isDiagonal) {
            td.classList.add('diagonal-cell');
          }

          // Correlation value
          const corrValue = document.createElement('div');
          corrValue.className = 'corr-value';
          corrValue.textContent = corrData.r.toFixed(3);
          corrValue.setAttribute('data-corr', corrData.r);
          td.appendChild(corrValue);

          // P-value
          if (corrData.p !== null) {
            const pValue = document.createElement('div');
            pValue.className = 'p-value';
            pValue.textContent = `p = ${corrData.p.toFixed(4)}`;
            td.appendChild(pValue);
          }

          // N value
          const nValue = document.createElement('div');
          nValue.className = 'n-value';
          nValue.textContent = `N = ${corrData.n}`;
          td.appendChild(nValue);

          row.appendChild(td);
        });

        tbody.appendChild(row);
      });

      // Apply display settings
      toggleDisplay();
      applyThresholdFilter();
    }

    /**
     * Calculate correlation matrix
     */
    function calculateCorrelationMatrix(data, headers, type) {
      const n = headers.length;
      const matrix = Array(n).fill(null).map(() => Array(n));

      for (let i = 0; i < n; i++) {
        for (let j = 0; j < n; j++) {
          const col1Data = data.map(row => row[headers[i]]);
          const col2Data = data.map(row => row[headers[j]]);

          let r, p, validN;

          // Force diagonal to 1.000 for all correlation types
          if (i === j) {
            validN = col1Data.filter(v => typeof v === 'number' && !isNaN(v)).length;
            r = 1;
            p = 0;
          } else if (type === 'Pearson') {
            ({ r, p, n: validN } = calculatePearsonCorrelation(col1Data, col2Data));
          } else if (type === 'Spearman') {
            ({ r, p, n: validN } = calculateSpearmanCorrelation(col1Data, col2Data));
          } else if (type === 'Kendall') {
            ({ r, p, n: validN } = calculateKendallCorrelation(col1Data, col2Data));
          }

          matrix[i][j] = { r, p, n: validN };
        }
      }

      return matrix;
    }

    /**
     * Calculate Pearson correlation
     */
    function calculatePearsonCorrelation(x, y) {
      const pairs = x.map((xi, i) => [xi, y[i]]).filter(([xi, yi]) => 
        typeof xi === 'number' && typeof yi === 'number' && !isNaN(xi) && !isNaN(yi)
      );

      const n = pairs.length;
      if (n < 2) return { r: 0, p: null, n: 0 };

      const xVals = pairs.map(p => p[0]);
      const yVals = pairs.map(p => p[1]);

      const meanX = xVals.reduce((a, b) => a + b, 0) / n;
      const meanY = yVals.reduce((a, b) => a + b, 0) / n;

      let num = 0, denX = 0, denY = 0;
      for (let i = 0; i < n; i++) {
        const dx = xVals[i] - meanX;
        const dy = yVals[i] - meanY;
        num += dx * dy;
        denX += dx * dx;
        denY += dy * dy;
      }

      const r = denX === 0 || denY === 0 ? 0 : num / Math.sqrt(denX * denY);

      // Calculate p-value using t-distribution approximation
      const t = r * Math.sqrt(n - 2) / Math.sqrt(1 - r * r);
      const p = 2 * (1 - tDistCDF(Math.abs(t), n - 2));

      return { r, p, n };
    }

    /**
     * Calculate Spearman correlation
     */
    function calculateSpearmanCorrelation(x, y) {
      const pairs = x.map((xi, i) => [xi, y[i]]).filter(([xi, yi]) => 
        typeof xi === 'number' && typeof yi === 'number' && !isNaN(xi) && !isNaN(yi)
      );

      const n = pairs.length;
      if (n < 2) return { r: 0, p: null, n: 0 };

      const xRanks = getRanks(pairs.map(p => p[0]));
      const yRanks = getRanks(pairs.map(p => p[1]));

      return calculatePearsonCorrelation(xRanks, yRanks);
    }

    /**
     * Calculate Kendall correlation
     */
    function calculateKendallCorrelation(x, y) {
      const pairs = x.map((xi, i) => [xi, y[i]]).filter(([xi, yi]) => 
        typeof xi === 'number' && typeof yi === 'number' && !isNaN(xi) && !isNaN(yi)
      );

      const n = pairs.length;
      if (n < 2) return { r: 0, p: null, n: 0 };

      let concordant = 0;
      let discordant = 0;

      for (let i = 0; i < n - 1; i++) {
        for (let j = i + 1; j < n; j++) {
          const dx = pairs[j][0] - pairs[i][0];
          const dy = pairs[j][1] - pairs[i][1];

          if (dx * dy > 0) concordant++;
          else if (dx * dy < 0) discordant++;
        }
      }

      const tau = (concordant - discordant) / (n * (n - 1) / 2);

      // Approximate p-value
      const z = tau * Math.sqrt(n * (n - 1) / (2 * (2 * n + 5) / 9));
      const p = 2 * (1 - normalCDF(Math.abs(z)));

      return { r: tau, p, n };
    }

    /**
     * Get ranks for Spearman
     */
    function getRanks(arr) {
      const sorted = arr.map((val, idx) => ({ val, idx })).sort((a, b) => a.val - b.val);
      const ranks = new Array(arr.length);

      for (let i = 0; i < sorted.length; i++) {
        let j = i;
        while (j < sorted.length - 1 && sorted[j].val === sorted[j + 1].val) {
          j++;
        }

        const avgRank = (i + j + 2) / 2;
        for (let k = i; k <= j; k++) {
          ranks[sorted[k].idx] = avgRank;
        }

        i = j;
      }

      return ranks;
    }

    /**
     * T-distribution CDF approximation
     */
    function tDistCDF(t, df) {
      const x = df / (df + t * t);
      return 1 - 0.5 * betaIncomplete(df / 2, 0.5, x);
    }

    /**
     * Normal CDF approximation
     */
    function normalCDF(x) {
      return 0.5 * (1 + erf(x / Math.sqrt(2)));
    }

    /**
     * Error function approximation
     */
    function erf(x) {
      const sign = x >= 0 ? 1 : -1;
      x = Math.abs(x);

      const a1 = 0.254829592;
      const a2 = -0.284496736;
      const a3 = 1.421413741;
      const a4 = -1.453152027;
      const a5 = 1.061405429;
      const p = 0.3275911;

      const t = 1 / (1 + p * x);
      const y = 1 - (((((a5 * t + a4) * t) + a3) * t + a2) * t + a1) * t * Math.exp(-x * x);

      return sign * y;
    }

    /**
     * Incomplete beta function approximation
     */
    function betaIncomplete(a, b, x) {
      if (x === 0) return 0;
      if (x === 1) return 1;
      
      // Simplified approximation
      return Math.pow(x, a) * Math.pow(1 - x, b);
    }

    /**
     * Recalculate with new correlation type
     */
    function recalculate() {
      const selected = document.querySelector('input[name="corrType"]:checked');
      currentType = selected ? selected.value : 'Pearson';
      console.log('Recalculating with type:', currentType);
      buildCorrelationMatrix();
    }

    /**
     * Toggle display of p-values and n-values
     */
    function toggleDisplay() {
      const showPValue = document.getElementById('showPValue').checked;
      const showN = document.getElementById('showN').checked;

      const pValues = document.querySelectorAll('.p-value');
      const nValues = document.querySelectorAll('.n-value');

      pValues.forEach(el => el.style.display = showPValue ? 'block' : 'none');
      nValues.forEach(el => el.style.display = showN ? 'block' : 'none');
    }

    /**
     * Update threshold slider
     */
    function updateThreshold(value) {
      document.getElementById('thresholdValue').textContent = parseFloat(value).toFixed(2);
      applyThresholdFilter();
    }

    /**
     * Apply threshold filter (highlight cells)
     */
    function applyThresholdFilter() {
      const threshold = parseFloat(document.getElementById('thresholdSlider').value);
      const allCells = document.querySelectorAll('tbody td');

      allCells.forEach(cell => {
        const corrValueEl = cell.querySelector('.corr-value');
        if (corrValueEl) {
          const corrValue = parseFloat(corrValueEl.getAttribute('data-corr'));
          
          // Highlight if abs(r) >= threshold, but exclude diagonal and perfect correlations
          const isDiagonal = cell.parentElement.rowIndex === Array.from(cell.parentElement.parentElement.children).indexOf(cell.parentElement);
          const isPerfect = Math.abs(Math.abs(corrValue) - 1.0) < 0.001;
          
          if (Math.abs(corrValue) >= threshold && !isDiagonal && !isPerfect && threshold > 0) {
            cell.classList.add('threshold-highlight');
          } else {
            cell.classList.remove('threshold-highlight');
          }
        }
      });
    }
  </script>
</body>
</html>
