<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Independent Means Results</title>
  <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet"/>
  <style>
    :root{--surface-0:#0c1624;--surface-1:#1a1f2e;--surface-2:#242938;--border:#2d3748;--accent-1:rgb(255,165,120);--accent-2:rgb(120,200,255);--text-primary:#fff;--text-secondary:rgba(255,255,255,.82);--text-muted:rgba(255,255,255,.62);--panel-radius:10px;--panel-shadow:0 4px 20px rgba(0,0,0,.4);}
    html,body{height:100%;margin:0;background:var(--surface-0);color:var(--text-primary);font-family:Segoe UI,Tahoma,sans-serif;}
    .wrap{display:flex;justify-content:center;padding:8px 12px 20px;}
    .card{width:min(1600px,99%);background:var(--surface-1);min-height:760px;border-radius:var(--panel-radius);box-shadow:var(--panel-shadow);border:1px solid var(--border);display:flex;flex-direction:column;}
    .hero-section{background:linear-gradient(180deg,#0a1118,#0c1620);border-bottom:1px solid rgba(255,255,255,.06);padding:16px 20px;border-radius:var(--panel-radius) var(--panel-radius) 0 0;}
    .hero-content{display:flex;justify-content:space-between;align-items:center;gap:12px;}
    .hero-title{display:flex;align-items:center;gap:12px;font-size:1.28rem;font-weight:800;letter-spacing:.4px;text-transform:uppercase;}
    .hero-controls{display:flex;align-items:center;gap:10px;}
    .hero-action-btn{border-radius:8px;border:1px solid rgba(148,163,184,.45);background:linear-gradient(145deg,rgba(148,163,184,.18),rgba(100,116,139,.16));color:#fff;padding:10px 16px;font-size:12px;font-weight:650;cursor:pointer;display:flex;align-items:center;gap:8px;}
    .tab-navigation{display:flex;align-items:flex-end;gap:16px;background:transparent;padding:12px 0 0;border-bottom:1px solid rgba(255,255,255,.08);overflow-x:auto;scrollbar-width:none;margin-top:10px;}
    .tab-button{height:36px;padding:0 4px;background:transparent;border:none;color:rgba(255,255,255,.55);font-size:12px;font-weight:600;cursor:pointer;display:flex;align-items:center;gap:7px;position:relative;}
    .tab-button.active{color:#fff;font-weight:700;}
    .tab-button.active::before{content:'';position:absolute;left:0;right:0;bottom:-9px;height:2px;background:linear-gradient(90deg,var(--accent-1),var(--accent-2));}
    .tab-controls-right{margin-left:auto;display:inline-flex;align-items:center;gap:8px;padding-bottom:8px;}
    .tab-decimal-select{height:36px;padding:0 10px;border-radius:8px;border:1px solid rgba(148,163,184,.45);background:rgba(15,23,42,.82);color:#fff;}
    .view-container{padding:14px 16px;}
    .tab-panel{display:none;} .tab-panel.active{display:block;}
    .stats-container{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:12px;}
    .stat-panel{background:rgba(255,255,255,.04);border:1px solid var(--border);border-radius:10px;overflow:hidden;}
    .stat-panel-heading{padding:9px 12px;background:#164e8d;color:#fff;font-weight:700;text-transform:uppercase;letter-spacing:.3px;border-bottom:2px solid rgba(255,165,120,.7);}
    .stat-panel-body{padding:8px 12px;}
    .stat-field{display:grid;grid-template-columns:1fr auto;align-items:center;gap:12px;padding:8px 0;border-bottom:1px solid rgba(255,255,255,.06);}
    .stat-field:last-child{border-bottom:none;}
    .stat-label{color:var(--text-secondary);font-weight:600;}
    .stat-value{font-variant-numeric:tabular-nums;color:var(--accent-2);font-weight:700;background:rgba(120,200,255,.12);border:1px solid rgba(120,200,255,.32);padding:6px 10px;border-radius:8px;min-width:110px;text-align:center;}
    .table-container{margin-top:10px;overflow:auto;max-height:420px;}
    .analysis-table{width:100%;border-collapse:collapse;}
    .analysis-table th{position:sticky;top:0;background:#164e8d;color:#fff;padding:8px;border:1px solid rgba(255,255,255,.2);}
    .analysis-table td{padding:8px;border:1px solid rgba(255,255,255,.14);color:var(--text-secondary);}
    .section-note{margin-top:10px;padding:9px;border-left:3px solid var(--accent-1);background:rgba(255,165,120,.1);color:var(--text-muted);}
    .framework-select{height:34px;padding:0 10px;border-radius:8px;border:1px solid rgba(148,163,184,.45);background:rgba(15,23,42,.82);color:#fff;}
    .agreement-good{color:#4ade80;font-weight:700;}
    .agreement-warn{color:#fbbf24;font-weight:700;}
    .settings-bar{margin-top:12px;background:rgba(255,255,255,.04);border:1px solid var(--border);border-radius:10px;padding:10px 12px;}
    .settings-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(170px,1fr));gap:8px;}
    .settings-grid label{font-size:11px;color:var(--text-muted);display:block;margin-bottom:3px;font-weight:700;text-transform:uppercase;}
    .settings-grid select,.settings-grid input{width:100%;height:34px;border-radius:8px;border:1px solid rgba(148,163,184,.45);background:rgba(15,23,42,.82);color:#fff;padding:0 10px;}
    .inference-row{display:flex;align-items:flex-end;justify-content:center;gap:42px;flex-wrap:wrap;}
    .inference-card{display:flex;align-items:flex-end;gap:10px;flex-wrap:wrap;justify-content:center;padding:8px 10px;border:1px solid rgba(120,200,255,.22);border-radius:12px;background:rgba(7,25,45,.52);}
    .inference-title{font-size:11px;color:var(--text-muted);font-weight:800;text-transform:uppercase;letter-spacing:.3px;min-width:130px;padding-bottom:8px;}
    .fw-radio-group{display:flex;border:1px solid rgba(120,200,255,.35);border-radius:10px;overflow:hidden;min-width:360px;}
    .fw-radio-group input{display:none;}
    .fw-radio{padding:10px 14px;background:rgba(22,78,141,.35);color:#dff3ff;font-size:13px;font-weight:700;cursor:pointer;user-select:none;border-right:1px solid rgba(120,200,255,.25);}
    .fw-radio:last-of-type{border-right:none;}
    .fw-radio.active{background:#1f678a;color:#fff;box-shadow:inset 0 0 0 1px rgba(135,214,255,.65);}
    .primary-test-wrap{display:flex;align-items:center;gap:8px;min-width:280px;}
    .primary-test-wrap label{font-size:11px;color:var(--text-muted);font-weight:800;text-transform:uppercase;}
    .primary-test-wrap select{height:36px;min-width:220px;border-radius:8px;border:1px solid rgba(148,163,184,.45);background:rgba(15,23,42,.82);color:#fff;padding:0 10px;}
    .hbox{border:1px solid rgba(148,163,184,.38);border-radius:10px;padding:8px;background:rgba(6,16,30,.55);}
    .hbox-title{font-size:11px;color:var(--text-muted);text-transform:uppercase;font-weight:700;margin-bottom:6px;}
    .hbox-row{display:flex;align-items:center;gap:10px;flex-wrap:wrap;color:#e5eefc;}
    .h-radio{display:inline-flex;align-items:center;gap:6px;font-size:12px;color:#d6e7ff;}
    .hdr-row{display:flex;justify-content:center;align-items:center;gap:10px;flex-wrap:wrap;}
    .stat-chip{display:inline-flex;align-items:center;gap:6px;background:rgba(30,58,138,.35);border:1px solid rgba(120,200,255,.4);border-radius:999px;padding:6px 10px;font-size:12px;color:#dbeafe;}
    .design-badge{font-weight:800;}
    .design-ok{background:rgba(16,185,129,.16);border-color:rgba(16,185,129,.55);color:#d1fae5;}
    .design-warn{background:rgba(245,158,11,.15);border-color:rgba(245,158,11,.55);color:#fde68a;}
    .design-bad{background:rgba(239,68,68,.15);border-color:rgba(239,68,68,.55);color:#fecaca;}
    .test-chip{display:inline-flex;align-items:center;background:rgba(16,185,129,.16);border:1px solid rgba(16,185,129,.55);color:#d1fae5;border-radius:8px;padding:8px 12px;font-size:12px;font-weight:700;}
    .hyp-card{border:1px solid rgba(120,200,255,.35);border-radius:12px;padding:10px;background:rgba(4,18,38,.6);}
    .hyp-head{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;}
    .hyp-title{font-size:11px;font-weight:800;color:var(--text-muted);text-transform:uppercase;letter-spacing:.3px;}
    .hyp-main{margin-top:6px;font-size:15px;font-weight:700;color:#e5eefc;}
    .hyp-alt{margin-top:8px;display:flex;align-items:center;gap:16px;flex-wrap:wrap;}
    .hyp-delta{font-weight:800;color:#93c5fd;}
    .alpha-wrap{min-width:220px;}
    .alpha-wrap label{font-size:11px;color:var(--text-muted);font-weight:800;text-transform:uppercase;}
  </style>
</head>
<body>
  <div class="wrap">
    <section class="card">
      <div class="hero-section">
        <div class="hero-content">
          <div class="hero-title"><i class="fa-solid fa-not-equal"></i><span>Independent Means Module</span></div>
          <div class="hero-controls">
            <button class="hero-action-btn" onclick="saveCurrentModel()"><i class="fa-solid fa-floppy-disk"></i> Save Model</button>
            <button class="hero-action-btn" onclick="exportHtml()"><i class="fa-solid fa-file-code"></i> Save HTML</button>
          </div>
        </div>
        <div class="tab-navigation">
          <button class="tab-button active" data-tab="explore"><i class="fa-solid fa-chart-column"></i> Explore</button>
          <button class="tab-button" data-tab="assumptions"><i class="fa-solid fa-shield-halved"></i> Assumptions</button>
          <button class="tab-button" data-tab="results"><i class="fa-solid fa-square-poll-vertical"></i> Results</button>
          <button class="tab-button" data-tab="effects"><i class="fa-solid fa-wave-square"></i> Effects</button>
          <button class="tab-button" data-tab="power"><i class="fa-solid fa-bolt"></i> Power</button>
          <button class="tab-button" data-tab="report"><i class="fa-solid fa-file-lines"></i> Report</button>
          <div class="tab-controls-right">
            <label for="decimalSelect">Decimals:</label>
            <select id="decimalSelect" class="tab-decimal-select" onchange="setDecimalPrecision()">
              <option value="auto">Auto</option><option value="0">0</option><option value="1">1</option><option value="2" selected>2</option><option value="3">3</option><option value="4">4</option>
            </select>
          </div>
        </div>
        <div class="settings-bar">
          <div class="settings-grid">
            <div style="grid-column:1/-1;">
              <div class="hdr-row" id="compareStatsRow"></div>
              <div id="designMessageRow" style="margin-top:6px;text-align:center;color:var(--text-muted);font-size:12px;"></div>
            </div>
            <div style="grid-column:1/-1;">
              <div class="hdr-row">
                <div class="inference-row">
                  <div class="inference-card">
                    <div class="inference-title">Inference Framework</div>
                    <div class="fw-radio-group" role="radiogroup" aria-label="Inference framework">
                      <input id="fwParametric" type="radio" name="frameworkMode" value="parametric" checked/>
                      <label for="fwParametric" id="setFrameworkParam" class="fw-radio active">Parametric (means)</label>
                      <input id="fwNonparametric" type="radio" name="frameworkMode" value="nonparametric"/>
                      <label for="fwNonparametric" id="setFrameworkNon" class="fw-radio">Non-parametric (ranks)</label>
                    </div>
                  </div>
                  <div class="primary-test-wrap" id="primaryTestWrap">
                    <label for="setPrimaryTest">Primary test</label>
                    <select id="setPrimaryTest">
                      <option value="welch">Welch t-test</option>
                      <option value="student">Student t-test (equal var)</option>
                      <option value="permutation">Permutation t-test</option>
                    </select>
                  </div>
                </div>
              </div>
            </div>
            <div id="setPosthocWrap" style="display:none;"><label for="setPosthocMethod">Post-hoc method</label><select id="setPosthocMethod"><option value="games-howell">Games-Howell</option><option value="tukey">Tukey HSD</option><option value="dunn">Dunn</option><option value="conover">Conover</option></select></div>
            <div id="setCorrectionWrap" style="display:none;"><label for="setPosthocCorrection">p correction</label><select id="setPosthocCorrection"><option value="holm">Holm</option><option value="bh">Benjamini-Hochberg</option><option value="bonferroni">Bonferroni</option><option value="none">None</option></select></div>
            <div id="setHypWrap" style="grid-column:1/-1;">
              <div class="hyp-card">
                <div class="hyp-head">
                  <div class="hyp-title">Hypothesis</div>
                  <div class="alpha-wrap">
                    <label for="setAlpha">Significance level</label>
                    <input id="setAlpha" type="range" min="0.001" max="0.2" step="0.001" value="0.05"/>
                    <div style="text-align:center;font-size:11px;color:var(--text-muted);">alpha = <span id="alphaVal">0.050</span></div>
                  </div>
                </div>
                <div class="hyp-main"><strong>H0:</strong> <span id="h0Text">&#916; = 0</span></div>
                <div class="hyp-alt">
                  <span><strong>Alternative:</strong> <span class="hyp-delta" id="deltaToken">&#956;2-&#956;1</span></span>
                  <div class="hbox-row" id="h1Row">
                    <label class="h-radio"><input type="radio" name="h1Orientation" value="less"/> &#916; &lt; 0</label>
                    <label class="h-radio"><input type="radio" name="h1Orientation" value="two-sided" checked/> &#916; != 0</label>
                    <label class="h-radio"><input type="radio" name="h1Orientation" value="greater"/> &#916; &gt; 0</label>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="view-container">
        <section id="tab-setup" class="tab-panel">
          <div class="stats-container">
            <div class="stat-panel"><div class="stat-panel-heading">Model Setup</div><div class="stat-panel-body">
              <div class="stat-field"><span class="stat-label">Mode</span><span class="stat-value" id="setupMode">...</span></div>
              <div class="stat-field"><span class="stat-label">Hypothesis</span><span class="stat-value" id="setupHypothesis">...</span></div>
              <div class="stat-field"><span class="stat-label">Confidence</span><span class="stat-value" id="setupConfidence">...</span></div>
            </div></div>
          </div>
        </section>
        <section id="tab-explore" class="tab-panel active">
          <div class="stats-container">
            <div class="stat-panel"><div class="stat-panel-heading">Group Summaries</div><div class="stat-panel-body">
              <div class="stat-field"><span class="stat-label">n1 / n2</span><span class="stat-value" id="expN">...</span></div>
              <div class="stat-field"><span class="stat-label">Mean A / Mean B</span><span class="stat-value" id="expMean">...</span></div>
              <div class="stat-field"><span class="stat-label">Median A / Median B</span><span class="stat-value" id="expMed">...</span></div>
              <div class="stat-field"><span class="stat-label">SD A / SD B</span><span class="stat-value" id="expSd">...</span></div>
              <div class="stat-field"><span class="stat-label">IQR A / IQR B</span><span class="stat-value" id="expIqr">...</span></div>
            </div></div>
          </div>
        </section>
        <section id="tab-assumptions" class="tab-panel">
          <div class="stats-container"><div class="stat-panel"><div class="stat-panel-heading">Diagnostics</div><div class="stat-panel-body">
            <div class="stat-field"><span class="stat-label">Normality A</span><span class="stat-value" id="asNormA">...</span></div>
            <div class="stat-field"><span class="stat-label">Normality B</span><span class="stat-value" id="asNormB">...</span></div>
            <div class="stat-field"><span class="stat-label">Equal Variance</span><span class="stat-value" id="asEqVar">...</span></div>
            <div class="stat-field"><span class="stat-label">Recommendation</span><span class="stat-value" id="asReco">...</span></div>
          </div></div></div>
        </section>
        <section id="tab-results" class="tab-panel">
          <div class="stats-container">
            <div class="stat-panel"><div class="stat-panel-heading">Primary Results</div><div class="stat-panel-body">
              <div class="stat-field">
                <span class="stat-label">Primary Framework</span><span class="stat-value" id="resPrimaryFramework">...</span>
              </div>
              <div class="stat-field"><span class="stat-label">Primary Test</span><span class="stat-value" id="resPrimaryTest">...</span></div>
              <div class="stat-field"><span class="stat-label">Statistic</span><span class="stat-value" id="resPrimaryStat">...</span></div>
              <div class="stat-field"><span class="stat-label">p-value</span><span class="stat-value" id="resPrimaryP">...</span></div>
              <div class="stat-field"><span class="stat-label">Primary Estimate + CI</span><span class="stat-value" id="resPrimaryEstimate">...</span></div>
            </div></div>
            <div class="stat-panel"><div class="stat-panel-heading">Robustness Check (Secondary)</div><div class="stat-panel-body">
              <div class="stat-field"><span class="stat-label">Secondary Test</span><span class="stat-value" id="resSecondaryTest">...</span></div>
              <div class="stat-field"><span class="stat-label">Statistic</span><span class="stat-value" id="resSecondaryStat">...</span></div>
              <div class="stat-field"><span class="stat-label">p-value</span><span class="stat-value" id="resSecondaryP">...</span></div>
              <div class="stat-field"><span class="stat-label">Agreement</span><span class="stat-value" id="resAgreement">...</span></div>
              <div class="stat-field"><span class="stat-label">Diagnostic Hint</span><span class="stat-value" id="resHint">...</span></div>
            </div></div>
          </div>
          <div class="stat-panel" id="posthocPanel" style="margin-top:12px; display:none;">
            <div class="stat-panel-heading">Post-hoc Pairwise</div>
            <div class="stat-panel-body" style="padding:0;">
              <div class="table-container" style="margin:0;">
                <table class="analysis-table">
                  <thead><tr><th>Comparison</th><th>Statistic</th><th>Raw p</th><th>Adj p</th><th>Estimate</th></tr></thead>
                  <tbody id="posthocBody"><tr><td colspan="5">No post-hoc rows</td></tr></tbody>
                </table>
              </div>
            </div>
          </div>
        </section>
        <section id="tab-effects" class="tab-panel">
          <div class="stats-container"><div class="stat-panel"><div class="stat-panel-heading">Effect Sizes</div><div class="stat-panel-body">
            <div class="stat-field"><span class="stat-label">Hedges g</span><span class="stat-value" id="efG">...</span></div>
            <div class="stat-field"><span class="stat-label">Cliff's delta</span><span class="stat-value" id="efDelta">...</span></div>
            <div class="stat-field"><span class="stat-label">Rank-biserial</span><span class="stat-value" id="efRrb">...</span></div>
            <div class="stat-field"><span class="stat-label">P(X>Y)</span><span class="stat-value" id="efPs">...</span></div>
          </div></div></div>
        </section>
        <section id="tab-power" class="tab-panel">
          <div class="stats-container"><div class="stat-panel"><div class="stat-panel-heading">Power & Sample Size (Python)</div><div class="stat-panel-body">
            <div class="stat-field"><span class="stat-label">Status</span><span class="stat-value" id="powNote">...</span></div>
            <div class="stat-field"><span class="stat-label">Endpoint</span><span class="stat-value" id="powEndpoint">...</span></div>
            <div class="stat-field"><span class="stat-label">Placeholder Power</span><span class="stat-value" id="powVal">...</span></div>
          </div></div></div>
          <div class="section-note">Power is designed to call a Python service endpoint with exact/simulation routines.</div>
        </section>
        <section id="tab-report" class="tab-panel">
          <div class="stat-panel"><div class="stat-panel-heading">APA-ready Report</div><div class="stat-panel-body">
            <div id="repWelch"></div><br/><div id="repMw"></div><br/><div id="repCons"></div>
          </div></div>
        </section>
      </div>
    </section>
  </div>
  <script>
    let globalDecimalPrecision = "auto";
    let lastBundle = null;
    let primaryFramework = "parametric";
    let availableHeaders = [];
    let currentCompareMode = "two-vars";
    let currentHypothesis = "two-sided";
    let currentPrimaryTest = "welch";
    let persistedColumns = { groupA: "", groupB: "", valueColumn: "", groupColumn: "" };
    function parseMaybeNumber(v){ if(v===undefined||v===null) return NaN; const n=Number(String(v).replace(",",".")); return isFinite(n)?n:NaN; }
    function fmt(v){ const n=parseMaybeNumber(v); if(!isFinite(n)) return v==null?"...":String(v); if(globalDecimalPrecision==="auto"){ if(Math.abs(n)<1&&n!==0) return n.toFixed(4); return n.toFixed(2);} return n.toFixed(parseInt(globalDecimalPrecision,10)); }
    function fmtP(v){ const n=parseMaybeNumber(v); if(!isFinite(n)) return v==null?"...":String(v); if(n < 0.001) return "< 0.001"; return globalDecimalPrecision === "auto" ? n.toFixed(4) : n.toFixed(Math.max(3, parseInt(globalDecimalPrecision,10))); }
    function setDecimalPrecision(){ globalDecimalPrecision=(document.getElementById("decimalSelect")||{value:"auto"}).value; if(lastBundle) populateBundle(lastBundle); }
    function setText(id,val){ const el=document.getElementById(id); if(el) el.textContent = (val!==undefined&&val!==null&&val!=="")?val:"..."; }
    function switchTab(tab){ document.querySelectorAll(".tab-button").forEach(b=>b.classList.toggle("active",b.getAttribute("data-tab")===tab)); document.querySelectorAll(".tab-panel").forEach(p=>p.classList.toggle("active",p.id==="tab-"+tab)); }
    function sendToHost(cmd,data){ if(Office&&Office.context&&Office.context.ui&&Office.context.ui.messageParent) Office.context.ui.messageParent(JSON.stringify({action:"HOST_EVENT",cmd:cmd,data:data||{}})); }
    function fillSelect(id, options, selected){
      const el = document.getElementById(id);
      if (!el) return;
      el.innerHTML = (options || []).map(function(v){ return '<option value="' + v + '">' + v + '</option>'; }).join("");
      if (selected !== undefined && selected !== null && String(selected) !== "") el.value = String(selected);
    }
    function currentSettingsSpec(){
      var hChecked = document.querySelector('input[name="h1Orientation"]:checked');
      var h = hChecked ? hChecked.value : "two-sided";
      currentHypothesis = h;
      var alpha = Number((document.getElementById("setAlpha") || { value: "0.05" }).value || 0.05);
      if (!isFinite(alpha) || alpha <= 0 || alpha >= 1) alpha = 0.05;
      return {
        compareMode: currentCompareMode,
        primaryFramework: primaryFramework,
        hypothesis: h,
        confidence: 1 - alpha,
        groupA: persistedColumns.groupA || "",
        groupB: persistedColumns.groupB || "",
        valueColumn: persistedColumns.valueColumn || "",
        groupColumn: persistedColumns.groupColumn || "",
        primaryTest: (document.getElementById("setPrimaryTest") || {}).value || currentPrimaryTest || "welch",
        posthocMethod: (document.getElementById("setPosthocMethod") || {}).value || "games-howell",
        posthocCorrection: (document.getElementById("setPosthocCorrection") || {}).value || "holm"
      };
    }
    function refreshHypothesisFrames(){
      var h0 = document.getElementById("h0Text");
      var h1Row = document.getElementById("h1Row");
      var deltaToken = document.getElementById("deltaToken");
      if (!h0 || !h1Row) return;
      if (currentCompareMode === "k-plus") {
        h0.textContent = "All groups are equal";
        if (deltaToken) deltaToken.textContent = "Omnibus";
        h1Row.innerHTML = '<span style="color:#e5eefc;font-weight:700;">At least one group differs.</span>';
      } else {
        h0.textContent = "Î” = 0";
        if (deltaToken) deltaToken.textContent = primaryFramework === "nonparametric" ? "PS-0.5" : "Î¼2-Î¼1";
        h1Row.innerHTML = '' +
          '<label class="h-radio"><input type="radio" name="h1Orientation" value="less"/> Î” &lt; 0</label>' +
          '<label class="h-radio"><input type="radio" name="h1Orientation" value="two-sided" checked/> Î” != 0</label>' +
          '<label class="h-radio"><input type="radio" name="h1Orientation" value="greater"/> Î” &gt; 0</label>';
        var checkedVal = currentHypothesis || "two-sided";
        var checked = h1Row.querySelector('input[name="h1Orientation"][value="' + checkedVal + '"]');
        if (checked) checked.checked = true;
        h1Row.querySelectorAll('input[name="h1Orientation"]').forEach(function(el){ el.addEventListener("change", notifySettingsChanged); });
      }
    }
    function refreshSettingsVisibility(){
      const mode = currentCompareMode || "two-vars";
      const two = mode === "two-vars";
      const setDisplay = (id, show) => { const el = document.getElementById(id); if (el) el.style.display = show ? "" : "none"; };
      setDisplay("setPosthocWrap", !two); setDisplay("setCorrectionWrap", !two);
      setDisplay("setHypWrap", true);
      refreshHypothesisFrames();
    }
    function setFrameworkButtons(mode){
      primaryFramework = mode === "nonparametric" ? "nonparametric" : "parametric";
      var p = document.getElementById("setFrameworkParam");
      var n = document.getElementById("setFrameworkNon");
      if (p) p.classList.toggle("active", primaryFramework === "parametric");
      if (n) n.classList.toggle("active", primaryFramework === "nonparametric");
      var rp = document.getElementById("fwParametric");
      var rn = document.getElementById("fwNonparametric");
      if (rp) rp.checked = primaryFramework === "parametric";
      if (rn) rn.checked = primaryFramework === "nonparametric";
      var primaryTestWrap = document.getElementById("primaryTestWrap");
      if (primaryTestWrap) primaryTestWrap.style.display = (currentCompareMode === "two-vars" && primaryFramework === "parametric") ? "flex" : "none";
      var testChip = document.getElementById("selectedTestChip");
      var compareMode = currentCompareMode || "two-vars";
      if (testChip) testChip.textContent = "";
      refreshHypothesisFrames();
    }
    function notifySettingsChanged(){
      const spec = currentSettingsSpec();
      refreshSettingsVisibility();
      var alphaVal = document.getElementById("alphaVal");
      if (alphaVal) alphaVal.textContent = (1 - (spec.confidence || 0.95)).toFixed(3);
      sendToHost("independentSettingsChanged", spec);
    }
    function renderCompareStatsRow(s, e){
      var host = document.getElementById("compareStatsRow");
      var msgHost = document.getElementById("designMessageRow");
      if (!host) return;
      host.innerHTML = "";
      if (msgHost) msgHost.textContent = "";
      var mode = s.compareMode || "two-vars";
      if (mode === "two-vars") {
        var aName = s.groupA || "u1";
        var bName = s.groupB || "u2";
        var chips = [
          "Comparison",
          "Group A: " + aName + " (n=" + (e.n1 || 0) + ", Î¼=" + fmt(e.mean1) + ")",
          "Group B: " + bName + " (n=" + (e.n2 || 0) + ", Î¼=" + fmt(e.mean2) + ")"
        ];
        chips.forEach(function(txt){
          var sp = document.createElement("span");
          sp.className = "stat-chip";
          sp.textContent = txt;
          host.appendChild(sp);
        });
      } else {
        var levels = (s.groupLevels || []).slice(0, 6);
        levels.forEach(function(lv){
          var sp = document.createElement("span");
          sp.className = "stat-chip";
          sp.textContent = lv;
          host.appendChild(sp);
        });
      }
      var design = s.designValidation || {};
      var badge = document.createElement("span");
      badge.className = "stat-chip design-badge " + (design.status === "independent" ? "design-ok" : (design.status === "invalid" ? "design-bad" : "design-warn"));
      var statusText = design.status === "independent" ? "ðŸŸ¢ Independent" : (design.status === "invalid" ? "ðŸ”´ Invalid" : "ðŸŸ¡ Paired");
      badge.textContent = "Design validation: " + statusText;
      host.appendChild(badge);
      if (msgHost && design.message) msgHost.textContent = design.message;
    }
    function updateResultsPanels(r, fx, s, a){
      setText("resPrimaryFramework", primaryFramework === "nonparametric" ? "Nonparametric (ranks)" : "Parametric (means)");
      const alpha = isFinite(parseMaybeNumber(a)) ? parseMaybeNumber(a) : (1 - (parseMaybeNumber(s && s.confidence) || 0.95));
      if (s && s.compareMode === "k-plus" && r && r.omnibus) {
        const ob = r.omnibus;
        const paramPrimary = primaryFramework !== "nonparametric";
        if (paramPrimary) {
          setText("resPrimaryTest", "One-way ANOVA");
          setText("resPrimaryStat", "F(" + fmt(ob.anovaDf1) + ", " + fmt(ob.anovaDf2) + ") = " + fmt(ob.anovaF));
          setText("resPrimaryP", fmtP(ob.anovaP));
          setText("resPrimaryEstimate", "Omnibus effect across " + fmt(ob.levels ? ob.levels.length : 0) + " groups");
          setText("resSecondaryTest", "Kruskal-Wallis");
          setText("resSecondaryStat", "H(" + fmt(ob.kwDf) + ") = " + fmt(ob.kwH));
          setText("resSecondaryP", fmtP(ob.kwP));
        } else {
          setText("resPrimaryTest", "Kruskal-Wallis");
          setText("resPrimaryStat", "H(" + fmt(ob.kwDf) + ") = " + fmt(ob.kwH));
          setText("resPrimaryP", fmtP(ob.kwP));
          setText("resPrimaryEstimate", "Distribution shift across " + fmt(ob.levels ? ob.levels.length : 0) + " groups");
          setText("resSecondaryTest", "One-way ANOVA");
          setText("resSecondaryStat", "F(" + fmt(ob.anovaDf1) + ", " + fmt(ob.anovaDf2) + ") = " + fmt(ob.anovaF));
          setText("resSecondaryP", fmtP(ob.anovaP));
        }
        const agreeElK = document.getElementById("resAgreement");
        const aSig = parseMaybeNumber(ob.anovaP) < alpha;
        const kSig = parseMaybeNumber(ob.kwP) < alpha;
        if (aSig === kSig) {
          setText("resAgreement", "Agree at alpha");
          if (agreeElK) agreeElK.className = "stat-value agreement-good";
          setText("resHint", "Omnibus conclusions are consistent across frameworks.");
        } else {
          setText("resAgreement", "Disagree at alpha");
          if (agreeElK) agreeElK.className = "stat-value agreement-warn";
          setText("resHint", "Consider non-normality/heteroscedasticity and run post-hoc with correction.");
        }
        return;
      }
      const welchSig = parseMaybeNumber(r.welchP) < alpha;
      const mwSig = parseMaybeNumber(r.mwP) < alpha;
      const primaryParametric = primaryFramework !== "nonparametric";

      if (primaryParametric) {
        const chosen = currentPrimaryTest || "welch";
        if (chosen === "student") {
          setText("resPrimaryTest", "Student t-test (equal var)");
          setText("resPrimaryStat", "t(" + fmt(r.studentDf) + ") = " + fmt(r.studentT));
          setText("resPrimaryP", fmtP(r.studentP));
          setText("resPrimaryEstimate", "Mean diff " + fmt(r.meanDiff) + " [" + fmt(r.ciLow) + ", " + fmt(r.ciHigh) + "]");
        } else if (chosen === "permutation") {
          setText("resPrimaryTest", "Permutation t-test");
          setText("resPrimaryStat", "Permutation B=" + fmt(r.permutationIterations || 1200));
          setText("resPrimaryP", fmtP(r.permutationP));
          setText("resPrimaryEstimate", "Mean diff " + fmt(r.meanDiff));
        } else {
          setText("resPrimaryTest", "Welch t-test");
          setText("resPrimaryStat", "t(" + fmt(r.welchDf) + ") = " + fmt(r.welchT));
          setText("resPrimaryP", fmtP(r.welchP));
          setText("resPrimaryEstimate", "Mean diff " + fmt(r.meanDiff) + " [" + fmt(r.ciLow) + ", " + fmt(r.ciHigh) + "]");
        }
        setText("resSecondaryTest", "Mann-Whitney U");
        setText("resSecondaryStat", "U = " + fmt(r.u));
        setText("resSecondaryP", fmtP(r.mwP));
      } else {
        setText("resPrimaryTest", "Mann-Whitney U");
        setText("resPrimaryStat", "U = " + fmt(r.u));
        setText("resPrimaryP", fmtP(r.mwP));
        setText("resPrimaryEstimate", "Rank-biserial " + fmt(fx.rankBiserial) + " | P(X>Y) " + fmt(fx.probabilitySuperiority));
        setText("resSecondaryTest", "Welch t-test");
        setText("resSecondaryStat", "t(" + fmt(r.welchDf) + ") = " + fmt(r.welchT));
        setText("resSecondaryP", fmtP(r.welchP));
      }

      const agreeEl = document.getElementById("resAgreement");
      if (welchSig === mwSig) {
        setText("resAgreement", "Agree at alpha");
        if (agreeEl) agreeEl.className = "stat-value agreement-good";
        setText("resHint", "Both frameworks lead to the same significance decision.");
      } else {
        setText("resAgreement", "Disagree at alpha");
        if (agreeEl) agreeEl.className = "stat-value agreement-warn";
        setText("resHint", "Inspect skew, outliers, and unequal variance/shape differences.");
      }
    }
    function renderPosthoc(posthoc, compareMode){
      const panel = document.getElementById("posthocPanel");
      const body = document.getElementById("posthocBody");
      if (!panel || !body) return;
      if (compareMode !== "k-plus" || !posthoc || !posthoc.enabled) {
        panel.style.display = "none";
        body.innerHTML = '<tr><td colspan="5">No post-hoc rows</td></tr>';
        return;
      }
      panel.style.display = "block";
      const rows = posthoc.rows || [];
      if (!rows.length) {
        body.innerHTML = '<tr><td colspan="5">No post-hoc rows</td></tr>';
        return;
      }
      body.innerHTML = "";
      rows.forEach(function(r){
        const tr = document.createElement("tr");
        [r.comparison, r.statistic, fmtP(r.rawP), fmtP(r.adjP), fmt(r.estimate)].forEach(function(v){
          const td = document.createElement("td");
          td.textContent = v;
          tr.appendChild(td);
        });
        body.appendChild(tr);
      });
    }

    function populateBundle(b){
      lastBundle = b || {};
      const s=b.setup||{}, e=b.explore||{}, a=b.assumptions||{}, r=b.results||{}, fx=b.effects||{}, p=b.power||{}, rep=b.report||{};
      availableHeaders = Array.isArray(s.headers) ? s.headers.slice() : availableHeaders;
      persistedColumns.groupA = s.groupA || persistedColumns.groupA;
      persistedColumns.groupB = s.groupB || persistedColumns.groupB;
      persistedColumns.valueColumn = s.valueColumn || persistedColumns.valueColumn;
      persistedColumns.groupColumn = s.groupColumn || persistedColumns.groupColumn;
      currentCompareMode = s.compareMode || currentCompareMode || "two-vars";
      currentPrimaryTest = s.primaryTest || currentPrimaryTest || "welch";
      var testSel = document.getElementById("setPrimaryTest");
      if (testSel) testSel.value = currentPrimaryTest;
      setFrameworkButtons(s.primaryFramework || primaryFramework);
      var alphaEl = document.getElementById("setAlpha");
      if (alphaEl) alphaEl.value = String(1 - (parseMaybeNumber(s.confidence) || 0.95));
      var orientation = s.hypothesis || "two-sided";
      currentHypothesis = orientation;
      var radio = document.querySelector('input[name="h1Orientation"][value="' + orientation + '"]');
      if (radio) radio.checked = true;
      const phm = document.getElementById("setPosthocMethod"); if (phm) phm.value = s.posthocMethod || "games-howell";
      const phc = document.getElementById("setPosthocCorrection"); if (phc) phc.value = s.posthocCorrection || "holm";
      renderCompareStatsRow(s, e);
      refreshSettingsVisibility();
      setText("setupMode", s.mode); setText("setupHypothesis", s.hypothesis); setText("setupConfidence", (s.confidence?fmt(100*s.confidence):"...")+"%");
      setText("expN", `${e.n1||0} / ${e.n2||0}`); setText("expMean", `${fmt(e.mean1)} / ${fmt(e.mean2)}`); setText("expMed", `${fmt(e.med1)} / ${fmt(e.med2)}`); setText("expSd", `${fmt(e.sd1)} / ${fmt(e.sd2)}`); setText("expIqr", `${fmt(e.iqr1)} / ${fmt(e.iqr2)}`);
      setText("asNormA", a.normalityA); setText("asNormB", a.normalityB); setText("asEqVar", a.equalVariance); setText("asReco", a.recommendation);
      updateResultsPanels(r, fx, s, 1 - (parseMaybeNumber(s.confidence) || 0.95));
      renderPosthoc(r.posthoc || {}, s.compareMode || "two-vars");
      setText("efG", fmt(fx.hedgesG)); setText("efDelta", fmt(fx.cliffsDelta)); setText("efRrb", fmt(fx.rankBiserial)); setText("efPs", fmt(fx.probabilitySuperiority));
      setText("powNote", p.note); setText("powEndpoint", p.suggestedEndpoint); setText("powVal", fmt(p.placeholderPower));
      setText("repWelch", "Welch: t(" + fmt(r.welchDf) + ")=" + fmt(r.welchT) + ", p " + fmtP(r.welchP) + ", mean diff " + fmt(r.meanDiff) + " [" + fmt(r.ciLow) + ", " + fmt(r.ciHigh) + "].");
      setText("repMw", "Mann-Whitney: U=" + fmt(r.u) + ", p " + fmtP(r.mwP) + ", rank-biserial " + fmt(fx.rankBiserial) + ".");
      setText("repCons", rep.consistency);
    }
    function saveCurrentModel(){ sendToHost("saveIndependentModel", lastBundle||{}); }
    function exportHtml(){
      const blob = new Blob([document.documentElement.outerHTML], {type:"text/html"});
      const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = "independent-means-report.html"; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),500);
    }
    document.addEventListener("DOMContentLoaded", function(){
      document.querySelectorAll(".tab-button").forEach(btn=>btn.addEventListener("click",()=>switchTab(btn.getAttribute("data-tab"))));
      ["setAlpha","setPosthocMethod","setPosthocCorrection","setPrimaryTest"].forEach(function(id){
        const el = document.getElementById(id);
        if (el) el.addEventListener("change", function(){ if (id === "setPrimaryTest") currentPrimaryTest = el.value || "welch"; notifySettingsChanged(); });
      });
      document.querySelectorAll('input[name="h1Orientation"]').forEach(function(el){ el.addEventListener("change", notifySettingsChanged); });
      var rp = document.getElementById("fwParametric");
      var rn = document.getElementById("fwNonparametric");
      if (rp) rp.addEventListener("change", function(){ if (rp.checked) { setFrameworkButtons("parametric"); notifySettingsChanged(); } });
      if (rn) rn.addEventListener("change", function(){ if (rn.checked) { setFrameworkButtons("nonparametric"); notifySettingsChanged(); } });
      setFrameworkButtons(primaryFramework);
      refreshSettingsVisibility();
      Office.onReady(function(){
        Office.context.ui.addHandlerAsync(Office.EventType.DialogParentMessageReceived, function(arg){
          const msg = JSON.parse(arg.message||"{}");
          if(msg.type==="INDEPENDENT_BUNDLE") populateBundle(msg.payload||{});
        });
        sendToHost("independentDashboardReady",{});
        setTimeout(()=>sendToHost("independentDashboardReady",{}),500);
      });
    });
  </script>
</body>
</html>
