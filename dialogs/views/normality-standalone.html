<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Tests of Normality Dashboard - Statistico</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet">
  <script src="https://code.highcharts.com/highcharts.js"></script>
  <script src="https://code.highcharts.com/highcharts-more.js"></script>
  <script src="https://code.highcharts.com/modules/solid-gauge.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jstat/1.9.4/jstat.min.js"></script>
  <link rel="stylesheet" href="./shared-header.css">
  <script src="./shared-header.js"></script>
  
  <style>
    :root {
      --surface-0: #0c1624;
      --surface-1: #1a1f2e;
      --surface-2: #242938;
      --border: #2d3748;
      --accent-1: rgb(255,165,120);
      --accent-2: rgb(120,200,255);
      --text-primary: #ffffff;
      --text-secondary: rgba(255,255,255,0.8);
      --text-muted: rgba(255,255,255,0.6);
      --pass-color: #4ade80;
      --fail-color: #f87171;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      background-color: var(--surface-0);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      color: var(--text-primary);
    }

    .results-container {
      padding: 10px;
      max-width: 100%;
    }

    .panel {
      background: var(--surface-1);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 10px;
    }

    /* Summary Stats */
    .summary-stats {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      padding: 10px;
      background: #000;
      border-radius: 6px;
      margin-bottom: 10px;
    }

    .stat-item {
      text-align: center;
    }

    .stat-value {
      font-size: 22px;
      font-weight: 700;
      color: var(--text-primary);
    }

    .stat-label {
      font-size: 10px;
      color: var(--text-muted);
      margin-top: 2px;
    }

    /* Gauge */
    .gauge-panel {
      background: #000;
      border-radius: 6px;
      padding: 10px;
      margin-bottom: 10px;
    }

    .gauge-title {
      text-align: center;
      font-size: 13px;
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: 5px;
    }

    .gauge-container {
      height: 180px;
    }

    /* Tests Grid */
    .tests-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
    }

    .test-card {
      background: grey;
      border-radius: 6px;
      padding: 12px;
    }

    .test-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .test-name {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .test-badge {
      padding: 3px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 700;
      background: ghostwhite;
    }

    .test-badge.pass {
      color: var(--pass-color);
    }

    .test-badge.fail {
      color: var(--fail-color);
    }

    .test-details {
      font-size: 12px;
    }

    .detail-row {
      display: flex;
      justify-content: space-between;
      padding: 3px 0;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    .detail-label {
      color: var(--text-muted);
    }

    .detail-value {
      color: var(--text-primary);
      font-weight: 600;
    }

    @media (max-width: 768px) {
      .tests-grid {
        grid-template-columns: 1fr;
      }
      .summary-stats {
        grid-template-columns: repeat(2, 1fr);
      }
    }
  </style>
</head>
<body>
  <statistico-header view-name="Tests of Normality" module-name="Univariate Analysis"></statistico-header>
  
  <div class="results-container">
    <!-- Summary Stats -->
    <div class="summary-stats">
      <div class="stat-item">
        <div class="stat-value" id="pass-count">0</div>
        <div class="stat-label">Tests Passed</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="fail-count">0</div>
        <div class="stat-label">Tests Failed</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="sample-size">‚Äî</div>
        <div class="stat-label">Sample Size</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="significance">0.05</div>
        <div class="stat-label">Significance</div>
      </div>
    </div>

    <!-- NSI Gauge -->
    <div class="gauge-panel">
      <div class="gauge-title">
        NSI<sup style="font-size:8px;">‚Ñ¢</sup> -Normality Strength Index
      </div>
      <div id="normalityGauge" class="gauge-container"></div>
    </div>

    <!-- Test Cards -->
    <div class="panel">
      <div class="tests-grid">
        <!-- Shapiro-Wilk -->
        <div class="test-card">
          <div class="test-header">
            <div class="test-name">Shapiro-Wilk</div>
            <div class="test-badge" id="sw-badge">‚Äî</div>
          </div>
          <div class="test-details">
            <div class="detail-row">
              <span class="detail-label">Statistic:</span>
              <span class="detail-value" id="sw-stat">‚Äî</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">p-value:</span>
              <span class="detail-value" id="sw-p">‚Äî</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Critical:</span>
              <span class="detail-value" id="sw-crit">‚Äî</span>
            </div>
          </div>
        </div>

        <!-- Anderson-Darling -->
        <div class="test-card">
          <div class="test-header">
            <div class="test-name">Anderson-Darling</div>
            <div class="test-badge" id="ad-badge">‚Äî</div>
          </div>
          <div class="test-details">
            <div class="detail-row">
              <span class="detail-label">Statistic:</span>
              <span class="detail-value" id="ad-stat">‚Äî</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">p-value:</span>
              <span class="detail-value" id="ad-p">‚Äî</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Critical:</span>
              <span class="detail-value" id="ad-crit">‚Äî</span>
            </div>
          </div>
        </div>

        <!-- Kolmogorov-Smirnov -->
        <div class="test-card">
          <div class="test-header">
            <div class="test-name">Kolmogorov-Smirnov</div>
            <div class="test-badge" id="ks-badge">‚Äî</div>
          </div>
          <div class="test-details">
            <div class="detail-row">
              <span class="detail-label">Statistic:</span>
              <span class="detail-value" id="ks-stat">‚Äî</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">p-value:</span>
              <span class="detail-value" id="ks-p">‚Äî</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Critical:</span>
              <span class="detail-value" id="ks-crit">‚Äî</span>
            </div>
          </div>
        </div>

        <!-- Cramer-von Mises -->
        <div class="test-card">
          <div class="test-header">
            <div class="test-name">Cramer-von Mises</div>
            <div class="test-badge" id="cvm-badge">‚Äî</div>
          </div>
          <div class="test-details">
            <div class="detail-row">
              <span class="detail-label">Statistic:</span>
              <span class="detail-value" id="cvm-stat">‚Äî</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">p-value:</span>
              <span class="detail-value" id="cvm-p">‚Äî</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Critical:</span>
              <span class="detail-value" id="cvm-crit">‚Äî</span>
            </div>
          </div>
        </div>

        <!-- D'Agostino-Pearson -->
        <div class="test-card">
          <div class="test-header">
            <div class="test-name">D'Agostino-Pearson</div>
            <div class="test-badge" id="dp-badge">‚Äî</div>
          </div>
          <div class="test-details">
            <div class="detail-row">
              <span class="detail-label">Statistic:</span>
              <span class="detail-value" id="dp-stat">‚Äî</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">p-value:</span>
              <span class="detail-value" id="dp-p">‚Äî</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Critical:</span>
              <span class="detail-value" id="dp-crit">‚Äî</span>
            </div>
          </div>
        </div>

        <!-- Jarque-Bera -->
        <div class="test-card">
          <div class="test-header">
            <div class="test-name">Jarque-Bera</div>
            <div class="test-badge" id="jb-badge">‚Äî</div>
          </div>
          <div class="test-details">
            <div class="detail-row">
              <span class="detail-label">Statistic:</span>
              <span class="detail-value" id="jb-stat">‚Äî</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">p-value:</span>
              <span class="detail-value" id="jb-p">‚Äî</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Critical:</span>
              <span class="detail-value" id="jb-crit">‚Äî</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let originalData = [];
    let varName = 'Variable';
    let librariesLoaded = false;
    let dataReady = false;
    let gaugeChart = null;
    const ALPHA = 0.05;

    function checkLibraries() {
      librariesLoaded = typeof Highcharts !== 'undefined' && typeof jStat !== 'undefined';
      return librariesLoaded;
    }

    // ===========================================
    // 6 NORMALITY TESTS (VB6-compatible)
    // ===========================================

    // 1. Shapiro-Wilk Test
    function shapiroWilkTest(data) {
      const n = data.length;
      const sorted = [...data].sort((a, b) => a - b);
      const mean = sorted.reduce((a, b) => a + b, 0) / n;
      
      let a = [];
      for (let i = 0; i < Math.floor(n / 2); i++) {
        const p = (i + 1 - 0.375) / (n + 0.25);
        const invNorm = jStat.normal.inv(p, 0, 1);
        a.push(invNorm);
      }
      
      const sumA2 = a.reduce((acc, val) => acc + val * val, 0);
      const normFactor = 1 / Math.sqrt(sumA2);
      a = a.map(val => val * normFactor);
      
      let b = 0;
      for (let i = 0; i < a.length; i++) {
        b += a[i] * (sorted[n - 1 - i] - sorted[i]);
      }
      
      const variance = sorted.reduce((acc, val) => acc + Math.pow(val - mean, 2), 0);
      const W = (b * b) / variance;
      
      let pValue;
      if (n < 50) {
        const logW = Math.log(1 - W);
        const logN = Math.log(n);
        const z = -logW - 2.27 + 0.8 * logN;
        pValue = 1 - jStat.normal.cdf(z, 0, 1);
      } else {
        const mu = 0.0038915 * Math.pow(Math.log(n) - 3, 3) + 0.37872 * Math.pow(Math.log(n) - 3, 2) - 0.08928 * (Math.log(n) - 3);
        const sigma = Math.exp(-0.0015395 * Math.pow(Math.log(n) - 3, 3) + 0.13186 * Math.pow(Math.log(n) - 3, 2) - 0.27791 * (Math.log(n) - 3) - 1.0063);
        const z = (Math.log(1 - W) - mu) / sigma;
        pValue = 1 - jStat.normal.cdf(z, 0, 1);
      }
      
      return { statistic: W, pValue, critical: 0.95 };
    }

    // 2. Jarque-Bera Test
    function jarqueBeraTest(data) {
      const n = data.length;
      const mean = data.reduce((a, b) => a + b, 0) / n;
      const variance = data.reduce((acc, val) => acc + Math.pow(val - mean, 2), 0) / n;
      const stdDev = Math.sqrt(variance);
      
      const m3 = data.reduce((acc, val) => acc + Math.pow((val - mean) / stdDev, 3), 0) / n;
      const m4 = data.reduce((acc, val) => acc + Math.pow((val - mean) / stdDev, 4), 0) / n;
      
      const skewness = m3;
      const kurtosis = m4;
      
      const JB = (n / 6) * (Math.pow(skewness, 2) + Math.pow(kurtosis - 3, 2) / 4);
      const pValue = 1 - jStat.chisquare.cdf(JB, 2);
      const critical = jStat.chisquare.inv(1 - ALPHA, 2);
      
      return { statistic: JB, pValue, critical };
    }

    // 3. Kolmogorov-Smirnov Test
    function kolmogorovSmirnovTest(data) {
      const n = data.length;
      const sorted = [...data].sort((a, b) => a - b);
      const mean = data.reduce((a, b) => a + b, 0) / n;
      const stdDev = Math.sqrt(data.reduce((acc, val) => acc + Math.pow(val - mean, 2), 0) / n);
      
      let maxD = 0;
      for (let i = 0; i < n; i++) {
        const z = (sorted[i] - mean) / stdDev;
        const empirical = (i + 1) / n;
        const theoretical = jStat.normal.cdf(z, 0, 1);
        const d = Math.abs(empirical - theoretical);
        maxD = Math.max(maxD, d);
      }
      
      const pValue = 1 - Math.exp(-2 * Math.pow(maxD * Math.sqrt(n), 2));
      const critical = 1.36 / Math.sqrt(n); // Approx at 95%
      
      return { statistic: maxD, pValue, critical };
    }

    // 4. Anderson-Darling Test
    function andersonDarlingTest(data) {
      const n = data.length;
      const sorted = [...data].sort((a, b) => a - b);
      const mean = data.reduce((a, b) => a + b, 0) / n;
      const stdDev = Math.sqrt(data.reduce((acc, val) => acc + Math.pow(val - mean, 2), 0) / n);
      
      let sum = 0;
      for (let i = 0; i < n; i++) {
        const z = (sorted[i] - mean) / stdDev;
        const Fi = jStat.normal.cdf(z, 0, 1);
        const F_ni = jStat.normal.cdf((sorted[n - 1 - i] - mean) / stdDev, 0, 1);
        sum += (2 * i + 1) * (Math.log(Fi) + Math.log(1 - F_ni));
      }
      
      const A2 = -n - sum / n;
      const A2Modified = A2 * (1 + 0.75 / n + 2.25 / (n * n));
      
      let pValue;
      if (A2Modified < 0.2) pValue = 1 - Math.exp(-13.436 + 101.14 * A2Modified - 223.73 * A2Modified * A2Modified);
      else if (A2Modified < 0.34) pValue = 1 - Math.exp(-8.318 + 42.796 * A2Modified - 59.938 * A2Modified * A2Modified);
      else if (A2Modified < 0.6) pValue = Math.exp(0.9177 - 4.279 * A2Modified - 1.38 * A2Modified * A2Modified);
      else pValue = Math.exp(1.2937 - 5.709 * A2Modified + 0.0186 * A2Modified * A2Modified);
      
      const critical = andersonDarlingCritical(ALPHA);
      
      return { statistic: A2Modified, pValue: Math.max(0, Math.min(1, pValue)), critical };
    }

    function andersonDarlingCritical(alpha) {
      const table = [
        [0.10, 0.631],
        [0.05, 0.752],
        [0.025, 0.873],
        [0.01, 1.035]
      ];
      for (let [a, c] of table) {
        if (alpha >= a) return c;
      }
      return 1.035;
    }

    // 5. Cramer-von Mises Test
    function cramerVonMisesTest(data) {
      const n = data.length;
      const sorted = [...data].sort((a, b) => a - b);
      const mean = data.reduce((a, b) => a + b, 0) / n;
      const stdDev = Math.sqrt(data.reduce((acc, val) => acc + Math.pow(val - mean, 2), 0) / n);
      
      let sum = 0;
      for (let i = 0; i < n; i++) {
        const z = (sorted[i] - mean) / stdDev;
        const Fi = jStat.normal.cdf(z, 0, 1);
        sum += Math.pow(Fi - (2 * i + 1) / (2 * n), 2);
      }
      
      const W2 = sum + 1 / (12 * n);
      
      // Approximate p-value
      let pValue;
      if (W2 < 0.1) pValue = 1 - Math.exp(-0.5 * W2);
      else if (W2 < 0.5) pValue = 1 - Math.exp(-W2 * (1 + 0.5 * W2));
      else pValue = 0.001;
      
      const critical = cramerVonMisesCritical(ALPHA);
      
      return { statistic: W2, pValue, critical };
    }

    function cramerVonMisesCritical(alpha) {
      const table = [
        [0.10, 0.347],
        [0.05, 0.461],
        [0.025, 0.743],
        [0.01, 1.167]
      ];
      for (let [a, c] of table) {
        if (alpha >= a) return c;
      }
      return 1.167;
    }

    // 6. D'Agostino-Pearson Test (Omnibus) - Simplified robust version
    function dagostinoPearsonTest(data) {
      const n = data.length;
      
      // Need at least 8 observations
      if (n < 8) {
        console.warn('‚ö†Ô∏è D\'Agostino-Pearson requires n >= 8, got n =', n);
        return { statistic: NaN, pValue: NaN, critical: 5.991 };
      }
      
      const mean = data.reduce((a, b) => a + b, 0) / n;
      const variance = data.reduce((acc, val) => acc + Math.pow(val - mean, 2), 0) / n;
      const stdDev = Math.sqrt(variance);
      
      if (stdDev === 0) {
        console.warn('‚ö†Ô∏è D\'Agostino-Pearson: zero variance');
        return { statistic: NaN, pValue: NaN, critical: 5.991 };
      }
      
      // Calculate standardized moments
      const m3 = data.reduce((acc, val) => acc + Math.pow((val - mean) / stdDev, 3), 0) / n;
      const m4 = data.reduce((acc, val) => acc + Math.pow((val - mean) / stdDev, 4), 0) / n;
      
      // Sample skewness and kurtosis
      const skewness = m3;
      const kurtosis = m4 - 3; // Excess kurtosis
      
      // Z-score for skewness (simplified)
      const varSkew = 6 * (n - 2) / ((n + 1) * (n + 3));
      const zSkew = skewness / Math.sqrt(varSkew);
      
      // Z-score for kurtosis (simplified)
      const varKurt = 24 * n * (n - 2) * (n - 3) / (Math.pow(n + 1, 2) * (n + 3) * (n + 5));
      const zKurt = kurtosis / Math.sqrt(varKurt);
      
      // Combined K¬≤ statistic
      const K2 = Math.pow(zSkew, 2) + Math.pow(zKurt, 2);
      
      // Check for invalid values
      if (!isFinite(K2)) {
        console.warn('‚ö†Ô∏è D\'Agostino-Pearson: Invalid K¬≤ =', K2);
        return { statistic: NaN, pValue: NaN, critical: 5.991 };
      }
      
      // p-value from chi-square distribution (2 df)
      const pValue = 1 - jStat.chisquare.cdf(K2, 2);
      const critical = jStat.chisquare.inv(1 - ALPHA, 2); // ~5.991 at Œ±=0.05
      
      return { statistic: K2, pValue, critical };
    }

    // ===========================================
    // RUN ALL TESTS & UPDATE UI
    // ===========================================
    function runNormalityTests() {
      console.log('üß™ runNormalityTests called');
      console.log('   dataReady:', dataReady);
      console.log('   librariesLoaded:', librariesLoaded);
      console.log('   originalData.length:', originalData.length);
      
      if (!dataReady || !librariesLoaded || originalData.length === 0) {
        console.warn('‚ö†Ô∏è Cannot run tests - missing requirements');
        return;
      }
      
      console.log('‚úÖ Running all 6 normality tests on', originalData.length, 'values...');
      
      const sw = shapiroWilkTest(originalData);
      const jb = jarqueBeraTest(originalData);
      const ks = kolmogorovSmirnovTest(originalData);
      const ad = andersonDarlingTest(originalData);
      const cvm = cramerVonMisesTest(originalData);
      const dp = dagostinoPearsonTest(originalData);
      
      console.log('‚úÖ All tests completed:', {
        'Shapiro-Wilk': sw.pValue,
        'Jarque-Bera': jb.pValue,
        'Kolmogorov-Smirnov': ks.pValue,
        'Anderson-Darling': ad.pValue,
        'Cramer-von Mises': cvm.pValue,
        "D'Agostino-Pearson": dp.pValue
      });
      
      const tests = [
        { name: 'Shapiro-Wilk', id: 'sw', ...sw, weight: 1.0 },
        { name: 'Anderson-Darling', id: 'ad', ...ad, weight: 0.9 },
        { name: 'Kolmogorov-Smirnov', id: 'ks', ...ks, weight: 0.8 },
        { name: 'Cramer-von Mises', id: 'cvm', ...cvm, weight: 0.7 },
        { name: "D'Agostino-Pearson", id: 'dp', ...dp, weight: 1.0 },
        { name: 'Jarque-Bera', id: 'jb', ...jb, weight: 0.9 }
      ];
      
      displayResults(tests);
      calculateNSI(tests);
      console.log('‚úÖ Results displayed and NSI calculated');
    }

    function displayResults(tests) {
      let passCount = 0;
      let failCount = 0;
      
      tests.forEach(test => {
        const pass = test.pValue >= ALPHA;
        if (pass) passCount++; else failCount++;
        
        document.getElementById(`${test.id}-stat`).textContent = test.statistic.toFixed(4);
        document.getElementById(`${test.id}-p`).textContent = test.pValue.toFixed(4);
        document.getElementById(`${test.id}-crit`).textContent = test.critical.toFixed(4);
        
        const badge = document.getElementById(`${test.id}-badge`);
        badge.textContent = pass ? 'PASS' : 'FAIL';
        badge.className = pass ? 'test-badge pass' : 'test-badge fail';
      });
      
      document.getElementById('pass-count').textContent = passCount;
      document.getElementById('fail-count').textContent = failCount;
      document.getElementById('sample-size').textContent = originalData.length;
    }

    // ===========================================
    // NSI (Normality Strength Index) - VB6 version
    // ===========================================
    function calculateNSI(tests) {
      let totalWeight = 0;
      let weightedScore = 0;
      
      tests.forEach(test => {
        const p = test.pValue;
        const w = test.weight;
        let score = 0;
        
        if (p === null || isNaN(p)) return;
        
        // Scoring algorithm from VB6 HTML
        if (p < 0.001) {
          score = 0;
        } else if (p < 0.05) {
          const logScale = Math.log10(p) - Math.log10(0.001);
          const maxLogScale = Math.log10(0.05) - Math.log10(0.001);
          score = 10 + (30 * logScale / maxLogScale);
        } else if (p < 0.5) {
          const logScale = Math.log10(p) - Math.log10(0.05);
          const maxLogScale = Math.log10(0.5) - Math.log10(0.05);
          score = 40 + (40 * logScale / maxLogScale);
        } else {
          score = 80 + (20 * (p - 0.5) / 0.5);
        }
        
        weightedScore += score * w;
        totalWeight += w;
      });
      
      const finalScore = Math.round(totalWeight > 0 ? weightedScore / totalWeight : 50);
      updateGauge(finalScore);
      console.log('üìä NSI Score:', finalScore);
    }

    function updateGauge(score) {
      if (!gaugeChart) {
        gaugeChart = Highcharts.chart('normalityGauge', {
          chart: {
            type: 'solidgauge',
            backgroundColor: 'transparent',
            height: 180
          },
          title: null,
          pane: {
            startAngle: -90,
            endAngle: 90,
            background: {
              backgroundColor: '#1a1f2e',
              innerRadius: '60%',
              outerRadius: '100%',
              shape: 'arc'
            }
          },
          yAxis: {
            min: 0,
            max: 100,
            stops: [
              [0.3, '#ef4444'],
              [0.6, '#f59e0b'],
              [1, '#22c55e']
            ],
            lineWidth: 0,
            tickWidth: 0,
            minorTickInterval: null,
            tickAmount: 2,
            labels: {
              y: 16,
              style: { fontSize: '10px', color: '#fff' }
            }
          },
          plotOptions: {
            solidgauge: {
              dataLabels: {
                y: -25,
                borderWidth: 0,
                useHTML: true
              }
            }
          },
          credits: { enabled: false },
          series: [{
            name: 'NSI',
            data: [score],
            dataLabels: {
              format: '<div style="text-align:center">' +
                '<span style="font-size:32px;color:#fff;font-weight:700">{y}</span><br/>' +
                '<span style="font-size:11px;opacity:0.7">Normality Score</span>' +
                '</div>'
            }
          }]
        });
      } else {
        gaugeChart.series[0].points[0].update(score);
      }
    }

    // ===========================================
    // OFFICE.JS & DATA HANDLING
    // ===========================================
    Office.initialize = function (reason) {
      console.log('‚úÖ Normality Tests - Office.js initialized:', reason);
      
      // Add message handler
      Office.context.ui.addHandlerAsync(
        Office.EventType.DialogParentMessageReceived,
        onMessageReceived,
        (result) => {
          if (result.status === Office.AsyncResultStatus.Succeeded) {
            console.log('‚úÖ Message handler added successfully');
          } else {
            console.error('‚ùå Failed to add message handler:', result.error);
          }
        }
      );
      
      // Send ready status to parent
      setTimeout(() => {
        sendMessageToParent({ status: 'ready' });
        console.log('üì§ Sent ready status to parent');
      }, 500);
      
      // Fallback to sample data after 5 seconds if no real data
      setTimeout(() => { 
        if (!dataReady) {
          console.log('‚ö†Ô∏è No data received after 5s, loading sample data');
          loadSampleData();
        }
      }, 5000);
    };

    window.addEventListener('DOMContentLoaded', function() {
      console.log('üöÄ DOM Content Loaded');
      const initHeader = () => {
        if (typeof StatisticoHeader !== 'undefined') {
          StatisticoHeader.init('normality', 'Variable', 0);
        } else {
          setTimeout(initHeader, 100);
        }
      };
      initHeader();
      
      const checkAndInit = () => {
        if (checkLibraries()) {
          if (typeof Office === 'undefined') {
            loadSampleData();
          }
        } else {
          setTimeout(checkAndInit, 100);
        }
      };
      setTimeout(checkAndInit, 100);
    });

    function onMessageReceived(arg) {
      try {
        const message = JSON.parse(arg.message);
        console.log('üì© Normality received message:', message);
        if ((message.action === 'sendData' || message.action === 'loadData') && message.data) {
          console.log('‚úÖ Data message received, handling data...');
          handleDataReceived(message.data);
        }
      } catch (e) {
        console.error('‚ùå Error handling message:', e);
      }
    }

    function sendMessageToParent(message) {
      if (typeof Office !== 'undefined' && Office.context && Office.context.ui) {
        Office.context.ui.messageParent(JSON.stringify(message));
      }
    }

    function loadSampleData() {
      console.log('üìä Loading sample data...');
      if (!checkLibraries()) {
        setTimeout(loadSampleData, 200);
        return;
      }
      
      const sampleData = [];
      for (let i = 0; i < 100; i++) {
        const u1 = Math.random();
        const u2 = Math.random();
        const z = Math.sqrt(-2 * Math.log(u1)) * Math.cos(2 * Math.PI * u2);
        sampleData.push(50 + z * 10);
      }
      
      originalData = sampleData;
      varName = 'Sample Data';
      dataReady = true;
      
      const updateHeader = () => {
        if (typeof StatisticoHeader !== 'undefined') {
          StatisticoHeader.updateVariable(varName, originalData.length);
        } else {
          setTimeout(updateHeader, 100);
        }
      };
      updateHeader();
      
      runNormalityTests();
    }

    function handleDataReceived(data) {
      try {
        console.log('üìä handleDataReceived called with data:', data);
        
        if (!checkLibraries()) {
          console.log('‚ö†Ô∏è Libraries not ready, retrying...');
          setTimeout(() => handleDataReceived(data), 200);
          return;
        }
        
        originalData = data.values || data.data || [];
        varName = data.variableName || data.column || 'Variable';
        dataReady = true;
        
        console.log('‚úÖ Data loaded:', {
          varName,
          dataLength: originalData.length,
          firstFewValues: originalData.slice(0, 5)
        });
        
        const updateHeader = () => {
          if (typeof StatisticoHeader !== 'undefined') {
            StatisticoHeader.updateVariable(varName, originalData.length);
            console.log('‚úÖ Header updated:', varName, 'n=' + originalData.length);
          } else {
            setTimeout(updateHeader, 100);
          }
        };
        updateHeader();
        
        runNormalityTests();
      } catch (e) {
        console.error('‚ùå Error in handleDataReceived:', e);
      }
    }
  </script>
</body>
</html>
