<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Tests of Normality Dashboard - Statistico</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet">
  <script src="https://code.highcharts.com/highcharts.js"></script>
  <script src="https://code.highcharts.com/highcharts-more.js"></script>
  <script src="https://code.highcharts.com/modules/solid-gauge.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jstat/1.9.4/jstat.min.js"></script>
  <link rel="stylesheet" href="./shared-header.css">
  <script src="./shared-header.js"></script>
  
  <style>
    :root {
      --surface-0: #0c1624;
      --surface-1: #1a1f2e;
      --surface-2: #242938;
      --border: #2d3748;
      --accent-1: rgb(255,165,120);
      --accent-2: rgb(120,200,255);
      --text-primary: #ffffff;
      --text-secondary: rgba(255,255,255,0.8);
      --text-muted: rgba(255,255,255,0.6);
      --pass-color: #4ade80;
      --fail-color: #f87171;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      background-color: var(--surface-0);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      color: var(--text-primary);
    }

    .results-container {
      padding: 10px;
      max-width: 100%;
    }

    .panel {
      background: var(--surface-1);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 10px;
    }

    /* Dashboard (VB6 layout) */
    .dashboard {
      background: #0b0b0b;
      border-radius: 8px;
      border: 1px solid #1e2533;
      overflow: hidden;
      margin-bottom: 12px;
    }

    .dashboard-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: #0b0b0b;
      padding: 8px 12px;
      border-bottom: 1px solid #1e2533;
      font-size: 13px;
      font-weight: 600;
      color: var(--accent-1);
    }

    .dashboard-actions {
      display: flex;
      gap: 10px;
      color: #e5e7eb;
      font-size: 12px;
    }

    .dashboard-actions i {
      opacity: 0.8;
    }

    .dashboard-body {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      padding: 12px;
      background: #0b0b0b;
    }

    /* Summary panel */
    .summary-panel {
      background: #000;
      border-radius: 6px;
      padding: 10px;
      min-height: 120px;
      border: 1px solid #1e2533;
    }

    .summary-stats {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
    }

    .stat-item {
      text-align: center;
    }

    .stat-value {
      font-size: 22px;
      font-weight: 700;
      color: var(--text-primary);
    }

    .stat-label {
      font-size: 10px;
      color: var(--text-muted);
      margin-top: 2px;
    }

    .alpha-slider {
      margin-top: 4px;
    }

    /* Gauge panel */
    .gauge-panel {
      background: #000;
      border-radius: 6px;
      padding: 10px;
      border: 1px solid #1e2533;
    }

    .gauge-title {
      text-align: center;
      font-size: 13px;
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: 5px;
    }

    .gauge-container {
      height: 180px;
    }

    /* Tests Grid */
    .tests-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
    }

    .test-card {
      background: #7a7a7a;
      border-radius: 6px;
      padding: 12px;
    }

    .test-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .test-name {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .test-badge {
      padding: 3px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 700;
      background: ghostwhite;
    }

    .test-badge.pass {
      color: var(--pass-color);
    }

    .test-badge.fail {
      color: var(--fail-color);
    }

    .test-details {
      font-size: 12px;
    }

    .detail-row {
      display: flex;
      justify-content: space-between;
      padding: 3px 0;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    .detail-label {
      color: var(--text-muted);
    }

    .detail-value {
      color: var(--text-primary);
      font-weight: 600;
    }

    @media (max-width: 1100px) {
      .tests-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 768px) {
      .dashboard-body {
        grid-template-columns: 1fr;
      }
      .tests-grid {
        grid-template-columns: 1fr;
      }
      .summary-stats {
        grid-template-columns: repeat(2, 1fr);
      }
    }
  </style>
</head>
<body>
  <statistico-header view-name="Tests of Normality" module-name="Univariate Analysis"></statistico-header>
  
  <div class="results-container">
    <div class="dashboard">
      <div class="dashboard-header">
        Tests of Normality Dashboard
        <div class="dashboard-actions">
          <i class="fa-solid fa-expand"></i>
          <i class="fa-solid fa-rotate-right"></i>
          <i class="fa-solid fa-xmark"></i>
        </div>
      </div>
      <div class="dashboard-body">
        <div class="summary-panel">
          <div class="summary-stats">
            <div class="stat-item">
              <div class="stat-value" id="pass-count">0</div>
              <div class="stat-label">Tests Passed</div>
            </div>
            <div class="stat-item">
              <div class="stat-value" id="fail-count">0</div>
              <div class="stat-label">Tests Failed</div>
            </div>
            <div class="stat-item">
              <div class="stat-value" id="sample-size">‚Äî</div>
              <div class="stat-label">Sample Size</div>
            </div>
            <div class="stat-item" style="position: relative;">
              <div class="stat-value" id="significance">0.05</div>
              <div class="stat-label">Significance</div>
              <input class="alpha-slider" type="range" id="alpha-slider" min="0.01" max="0.15" step="0.01" value="0.05" 
                     style="width: 100%; margin-top: 5px; accent-color: #ffd700;"
                     oninput="updateAlpha(this.value)">
              <div style="font-size: 9px; color: rgba(255,255,255,0.5); margin-top: 2px;">Adjust</div>
            </div>
          </div>
        </div>
        <div class="gauge-panel">
          <div class="gauge-title">
            NSI<sup style="font-size:8px;">‚Ñ¢</sup> -Normality Strength Index
          </div>
          <div id="normalityGauge" class="gauge-container"></div>
        </div>
      </div>
    </div>

    <!-- Test Cards -->
    <div class="panel">
      <div class="tests-grid">
        <!-- Shapiro-Wilk -->
        <div class="test-card">
          <div class="test-header">
            <div class="test-name">Shapiro-Wilk</div>
            <div class="test-badge" id="sw-badge">‚Äî</div>
          </div>
          <div class="test-details">
            <div class="detail-row">
              <span class="detail-label">Statistic:</span>
              <span class="detail-value" id="sw-stat">‚Äî</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">p-value:</span>
              <span class="detail-value" id="sw-p">‚Äî</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Critical:</span>
              <span class="detail-value" id="sw-crit">‚Äî</span>
            </div>
          </div>
        </div>

        <!-- Anderson-Darling -->
        <div class="test-card">
          <div class="test-header">
            <div class="test-name">Anderson-Darling</div>
            <div class="test-badge" id="ad-badge">‚Äî</div>
          </div>
          <div class="test-details">
            <div class="detail-row">
              <span class="detail-label">Statistic:</span>
              <span class="detail-value" id="ad-stat">‚Äî</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">p-value:</span>
              <span class="detail-value" id="ad-p">‚Äî</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Critical:</span>
              <span class="detail-value" id="ad-crit">‚Äî</span>
            </div>
          </div>
        </div>

        <!-- Kolmogorov-Smirnov -->
        <div class="test-card">
          <div class="test-header">
            <div class="test-name">Kolmogorov-Smirnov</div>
            <div class="test-badge" id="ks-badge">‚Äî</div>
          </div>
          <div class="test-details">
            <div class="detail-row">
              <span class="detail-label">Statistic:</span>
              <span class="detail-value" id="ks-stat">‚Äî</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">p-value:</span>
              <span class="detail-value" id="ks-p">‚Äî</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Critical:</span>
              <span class="detail-value" id="ks-crit">‚Äî</span>
            </div>
          </div>
        </div>

        <!-- Cramer-von Mises -->
        <div class="test-card">
          <div class="test-header">
            <div class="test-name">Cramer-von Mises</div>
            <div class="test-badge" id="cvm-badge">‚Äî</div>
          </div>
          <div class="test-details">
            <div class="detail-row">
              <span class="detail-label">Statistic:</span>
              <span class="detail-value" id="cvm-stat">‚Äî</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">p-value:</span>
              <span class="detail-value" id="cvm-p">‚Äî</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Critical:</span>
              <span class="detail-value" id="cvm-crit">‚Äî</span>
            </div>
          </div>
        </div>

        <!-- D'Agostino-Pearson -->
        <div class="test-card">
          <div class="test-header">
            <div class="test-name">D'Agostino-Pearson</div>
            <div class="test-badge" id="dp-badge">‚Äî</div>
          </div>
          <div class="test-details">
            <div class="detail-row">
              <span class="detail-label">Statistic:</span>
              <span class="detail-value" id="dp-stat">‚Äî</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">p-value:</span>
              <span class="detail-value" id="dp-p">‚Äî</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Critical:</span>
              <span class="detail-value" id="dp-crit">‚Äî</span>
            </div>
          </div>
        </div>

        <!-- Jarque-Bera -->
        <div class="test-card">
          <div class="test-header">
            <div class="test-name">Jarque-Bera</div>
            <div class="test-badge" id="jb-badge">‚Äî</div>
          </div>
          <div class="test-details">
            <div class="detail-row">
              <span class="detail-label">Statistic:</span>
              <span class="detail-value" id="jb-stat">‚Äî</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">p-value:</span>
              <span class="detail-value" id="jb-p">‚Äî</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Critical:</span>
              <span class="detail-value" id="jb-crit">‚Äî</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let originalData = [];
    let varName = 'Variable';
    let librariesLoaded = false;
    let dataReady = false;
    let gaugeChart = null;
    let currentAlpha = 0.05;
    
    window.updateAlpha = function(value) {
      currentAlpha = parseFloat(value);
      document.getElementById('significance').textContent = currentAlpha.toFixed(2);
      if (dataReady && librariesLoaded && originalData.length > 0) {
        runNormalityTests();
      }
    };

    function checkLibraries() {
      librariesLoaded = typeof Highcharts !== 'undefined' && typeof jStat !== 'undefined';
      return librariesLoaded;
    }

    // ===========================================
    // 6 NORMALITY TESTS (VB6-compatible)
    // ===========================================

    // 1. Shapiro-Wilk Test (Fixed, proper algorithm)
    function shapiroWilkTest(data) {
      const n = data.length;
      
      if (n < 3 || n > 5000) {
        return { statistic: NaN, pValue: NaN, critical: 0.95 };
      }
      
      const sorted = [...data].sort((a, b) => a - b);
      const mean = sorted.reduce((a, b) => a + b, 0) / n;
      const variance = sorted.reduce((acc, val) => acc + Math.pow(val - mean, 2), 0);
      
      if (variance === 0) {
        return { statistic: NaN, pValue: NaN, critical: 0.95 };
      }
      
      // Calculate a-coefficients properly
      const k = Math.floor(n / 2);
      const a = [];
      let sumSqA = 0;
      
      for (let i = 0; i < k; i++) {
        const p = (i + 1 - 0.375) / (n + 0.25);
        const quantile = jStat.normal.inv(p, 0, 1);
        a.push(quantile);
        sumSqA += quantile * quantile;
      }
      
      // Normalize coefficients
      const normFactor = 1 / Math.sqrt(2 * sumSqA);
      
      // Calculate b = sum of a[i] * (x[n-i] - x[i+1])
      let b = 0;
      for (let i = 0; i < k; i++) {
        b += a[i] * (sorted[n - 1 - i] - sorted[i]);
      }
      b *= normFactor;
      
      // W statistic = b¬≤ / variance
      const W = (b * b) / variance;
      
      console.log('Shapiro-Wilk debug:', { n, W, b, variance, mean });
      
      // Ensure W is in valid range [0, 1]
      if (W > 1 || W < 0 || !isFinite(W)) {
        console.warn('‚ö†Ô∏è Invalid W statistic:', W);
        return { statistic: NaN, pValue: NaN, critical: 0.95 };
      }
      
      // Calculate p-value using improved approximation
      let pValue;
      if (W >= 0.9999) {
        pValue = 1.0;
      } else if (W < 0.01) {
        pValue = 0.0;
      } else {
        // Use log transformation: ln(1-W)
        const lnW = Math.log(1 - W);
        const lnN = Math.log(n);
        
        // Better approximation based on empirical studies
        // When W is small, p-value should be small (reject normality)
        let z;
        if (n <= 11) {
          // Small sample approximation
          z = (-lnW - 0.8 - 0.15 * lnN) / (0.6 + 0.12 * lnN);
        } else {
          // Larger sample approximation (Royston 1992)
          const mu = -1.5861 - 0.31082 * lnN - 0.083751 * lnN * lnN;
          const sigma = Math.exp(-0.4803 - 0.082676 * lnN + 0.0030302 * lnN * lnN);
          z = (lnW - mu) / sigma;
        }
        
        // p-value from standard normal
        // We want: smaller W => smaller p-value
        pValue = 1 - jStat.normal.cdf(z, 0, 1);
        
        // Ensure valid range
        pValue = Math.max(0.0001, Math.min(0.9999, pValue));
      }
      
      console.log('Shapiro-Wilk:', { n, W: W.toFixed(4), lnW: Math.log(1-W).toFixed(4), pValue: pValue.toFixed(4) });
      
      return { statistic: W, pValue, critical: 0.95 };
    }

    // 2. Jarque-Bera Test
    function jarqueBeraTest(data) {
      const n = data.length;
      const mean = data.reduce((a, b) => a + b, 0) / n;
      const variance = data.reduce((acc, val) => acc + Math.pow(val - mean, 2), 0) / n;
      const stdDev = Math.sqrt(variance);
      
      const m3 = data.reduce((acc, val) => acc + Math.pow((val - mean) / stdDev, 3), 0) / n;
      const m4 = data.reduce((acc, val) => acc + Math.pow((val - mean) / stdDev, 4), 0) / n;
      
      const skewness = m3;
      const kurtosis = m4;
      
      const JB = (n / 6) * (Math.pow(skewness, 2) + Math.pow(kurtosis - 3, 2) / 4);
      const pValue = 1 - jStat.chisquare.cdf(JB, 2);
      const critical = jStat.chisquare.inv(1 - currentAlpha, 2);
      
      return { statistic: JB, pValue, critical };
    }

    // 3. Kolmogorov-Smirnov Test (Fixed calculation)
    function kolmogorovSmirnovTest(data) {
      const n = data.length;
      const sorted = [...data].sort((a, b) => a - b);
      const mean = data.reduce((a, b) => a + b, 0) / n;
      const stdDev = Math.sqrt(data.reduce((acc, val) => acc + Math.pow(val - mean, 2), 0) / (n - 1));
      
      if (stdDev === 0) {
        return { statistic: NaN, pValue: NaN, critical: 1.36 / Math.sqrt(n) };
      }
      
      let maxD = 0;
      for (let i = 0; i < n; i++) {
        const z = (sorted[i] - mean) / stdDev;
        const empiricalAfter = (i + 1) / n;
        const empiricalBefore = i / n;
        const theoretical = jStat.normal.cdf(z, 0, 1);
        
        // KS statistic is max of both distances
        const d1 = Math.abs(empiricalAfter - theoretical);
        const d2 = Math.abs(empiricalBefore - theoretical);
        maxD = Math.max(maxD, d1, d2);
      }
      
      // Improved p-value approximation (Marsaglia, Tsang, Wang 2003)
      const sqrtN = Math.sqrt(n);
      const lambda = (sqrtN + 0.12 + 0.11 / sqrtN) * maxD;
      
      let pValue;
      if (lambda < 0.2) {
        pValue = 1.0;
      } else if (lambda > 4) {
        pValue = 0.0;
      } else {
        // Approximation: 1 - KScdf(lambda)
        pValue = 2 * Math.exp(-2 * lambda * lambda);
        pValue = Math.max(0, Math.min(1, pValue));
      }
      
      const critical = 1.36 / sqrtN; // Critical value at Œ±=0.05
      
      return { statistic: maxD, pValue, critical };
    }

    // 4. Anderson-Darling Test
    function andersonDarlingTest(data) {
      const n = data.length;
      const sorted = [...data].sort((a, b) => a - b);
      const mean = data.reduce((a, b) => a + b, 0) / n;
      const stdDev = Math.sqrt(data.reduce((acc, val) => acc + Math.pow(val - mean, 2), 0) / n);
      
      let sum = 0;
      for (let i = 0; i < n; i++) {
        const z = (sorted[i] - mean) / stdDev;
        const Fi = jStat.normal.cdf(z, 0, 1);
        const F_ni = jStat.normal.cdf((sorted[n - 1 - i] - mean) / stdDev, 0, 1);
        sum += (2 * i + 1) * (Math.log(Fi) + Math.log(1 - F_ni));
      }
      
      const A2 = -n - sum / n;
      const A2Modified = A2 * (1 + 0.75 / n + 2.25 / (n * n));
      
      let pValue;
      if (A2Modified < 0.2) pValue = 1 - Math.exp(-13.436 + 101.14 * A2Modified - 223.73 * A2Modified * A2Modified);
      else if (A2Modified < 0.34) pValue = 1 - Math.exp(-8.318 + 42.796 * A2Modified - 59.938 * A2Modified * A2Modified);
      else if (A2Modified < 0.6) pValue = Math.exp(0.9177 - 4.279 * A2Modified - 1.38 * A2Modified * A2Modified);
      else pValue = Math.exp(1.2937 - 5.709 * A2Modified + 0.0186 * A2Modified * A2Modified);
      
      const critical = andersonDarlingCritical(currentAlpha);
      
      return { statistic: A2Modified, pValue: Math.max(0, Math.min(1, pValue)), critical };
    }

    function andersonDarlingCritical(alpha) {
      const table = [
        [0.10, 0.631],
        [0.05, 0.752],
        [0.025, 0.873],
        [0.01, 1.035]
      ];
      for (let [a, c] of table) {
        if (alpha >= a) return c;
      }
      return 1.035;
    }

    // 5. Cramer-von Mises Test
    function cramerVonMisesTest(data) {
      const n = data.length;
      const sorted = [...data].sort((a, b) => a - b);
      const mean = data.reduce((a, b) => a + b, 0) / n;
      const stdDev = Math.sqrt(data.reduce((acc, val) => acc + Math.pow(val - mean, 2), 0) / n);
      
      let sum = 0;
      for (let i = 0; i < n; i++) {
        const z = (sorted[i] - mean) / stdDev;
        const Fi = jStat.normal.cdf(z, 0, 1);
        sum += Math.pow(Fi - (2 * i + 1) / (2 * n), 2);
      }
      
      const W2 = sum + 1 / (12 * n);
      
      // Approximate p-value
      let pValue;
      if (W2 < 0.1) pValue = 1 - Math.exp(-0.5 * W2);
      else if (W2 < 0.5) pValue = 1 - Math.exp(-W2 * (1 + 0.5 * W2));
      else pValue = 0.001;
      
      const critical = cramerVonMisesCritical(currentAlpha);
      
      return { statistic: W2, pValue, critical };
    }

    function cramerVonMisesCritical(alpha) {
      const table = [
        [0.10, 0.347],
        [0.05, 0.461],
        [0.025, 0.743],
        [0.01, 1.167]
      ];
      for (let [a, c] of table) {
        if (alpha >= a) return c;
      }
      return 1.167;
    }

    // 6. D'Agostino-Pearson Test (Omnibus) - VB6 exact port
    function dagostinoPearsonTest(data) {
      const n = data.length;
      if (n < 8) {
        console.warn('‚ö†Ô∏è D\'Agostino-Pearson requires n >= 8, got n =', n);
        return { statistic: NaN, pValue: NaN, critical: andersonDarlingCritical(currentAlpha) };
      }

      // VB6 sktest implementation (uses absolute deviations)
      function sktest(vec, N) {
        let xbar = 0;
        for (let i = 0; i < N; i++) xbar += vec[i];
        xbar = xbar / N;

        const datad = new Array(N);
        let m2 = 0;
        for (let i = 0; i < N; i++) {
          const di = Math.abs(vec[i]) - xbar;
          datad[i] = di;
          m2 += di * di;
        }
        m2 = m2 / N;

        const np1 = N + 1;
        const nm2 = N - 2;
        const np3 = N + 3;
        const np5 = N + 5;
        const np7 = N + 7;
        const np9 = N + 9;

        // Skewness z-score (zb1)
        let m3 = 0;
        for (let i = 0; i < N; i++) m3 += Math.pow(datad[i], 3);
        m3 = m3 / N;
        const sqb1 = m3 / Math.sqrt(Math.pow(m2, 3));
        const y = sqb1 * Math.sqrt((np1 * np3) / (6 * nm2));
        const term1b2 = 3 * (N * N + 27 * N - 70) * np1 * np3;
        const term2b2 = nm2 * np5 * np7 * np9;
        const beta2 = term1b2 / term2b2;
        const w = Math.sqrt(-1 + Math.sqrt(2 * (beta2 - 1)));
        const delta = 1 / Math.sqrt(Math.log(w));
        const alpha = Math.sqrt(2 / (w * w - 1));
        const zb1 = delta * Math.log(y / alpha + Math.sqrt(Math.pow(y / alpha, 2) + 1));

        // Kurtosis z-score (zb2)
        let m4 = 0;
        for (let i = 0; i < N; i++) m4 += Math.pow(datad[i], 4);
        m4 = m4 / N;
        const b2 = m4 / (m2 * m2);
        const meanb2 = 3 * (N - 1) / np1;
        const term1v = 24 * N * nm2 * (N - 3);
        const term2v = np1 * np1 * np3 * np5;
        const varb2 = term1v / term2v;
        const x = (b2 - meanb2) / Math.sqrt(varb2);
        const term1beta1 = 6 * (N * N - 5 * N + 2);
        const term2beta1 = Math.sqrt(6 * np3 * np5);
        const numerator = term1beta1 * term2beta1;
        const term3beta1 = np7 * np9 * Math.sqrt(N * nm2 * (N - 3));
        const beta1 = numerator / term3beta1;
        const a = 6 + (8 / beta1) * ((2 / beta1) + Math.sqrt((4 / (beta1 * beta1)) + 1));
        const t1 = 2 / (9 * a);
        const t2 = 1 + x * Math.sqrt(2 / (a - 4));
        const aa = 1 - t1;
        const bb1 = (1 - 2 / a) / t2;
        const bb2 = bb1 < 0 ? -bb1 : bb1;
        const bb = Math.pow(bb2, 0.3);
        const zb2 = (aa - bb) / Math.sqrt(t1);

        return { zb1, zb2 };
      }

      const { zb1, zb2 } = sktest(data, n);
      let Ksq = zb1 * zb1 + zb2 * zb2;

      // Royston adjustment (adjust = True in VB6)
      // Guard against underflow when Ksq is huge
      const expTerm = Math.exp(-0.5 * Ksq);
      const boundedExp = Math.min(Math.max(expTerm, 1e-300), 1 - 1e-16);
      const Zc = -jStat.normal.inv(boundedExp, 0, 1);
      const Zt = 0.55 * Math.pow(n, 0.2) - 0.21;
      const lnn = Math.log(n);
      const a1 = (-5 + 3.46 * lnn) * Math.exp(-1.37 * lnn);
      const b1 = 1 + (0.854 - 0.148 * lnn) * Math.exp(-0.55 * lnn);
      const a2 = a1 - (2.13 / (1 - 2.37 * lnn)) * Zt;
      const b2 = 2.13 / (1 - 2.37 * lnn) + b1;

      let z;
      if (Zc < -1) z = Zc;
      else if (Zc < Zt) z = a1 + b1 * Zc;
      else z = a2 + b2 * Zc;

      // Guard against 0/1 to avoid Infinity/NaN
      const Praw = 1 - jStat.normal.cdf(z, 0, 1);
      const P = Math.min(Math.max(Praw, 1e-300), 1 - 1e-16);
      Ksq = -2 * Math.log(P);

      // VB6: Pval = 1 - probchi(Ksq, df, lower_tail:=False)
      // probchi with lower_tail=False returns upper tail, so Pval becomes lower tail
      const pValue = jStat.chisquare.cdf(Ksq, 2);

      // VB6 sets critical using Anderson-Darling interpolation
      const critical = andersonDarlingCritical(currentAlpha);

      return { statistic: Ksq, pValue, critical };
    }

    // ===========================================
    // RUN ALL TESTS & UPDATE UI
    // ===========================================
    function runNormalityTests() {
      console.log('üß™ runNormalityTests called');
      console.log('   dataReady:', dataReady);
      console.log('   librariesLoaded:', librariesLoaded);
      console.log('   originalData.length:', originalData.length);
      
      if (!dataReady || !librariesLoaded || originalData.length === 0) {
        console.warn('‚ö†Ô∏è Cannot run tests - missing requirements');
        return;
      }
      
      console.log('‚úÖ Running all 6 normality tests on', originalData.length, 'values...');
      
      const sw = shapiroWilkTest(originalData);
      const jb = jarqueBeraTest(originalData);
      const ks = kolmogorovSmirnovTest(originalData);
      const ad = andersonDarlingTest(originalData);
      const cvm = cramerVonMisesTest(originalData);
      const dp = dagostinoPearsonTest(originalData);
      
      console.log('‚úÖ All tests completed:', {
        'Shapiro-Wilk': sw.pValue,
        'Jarque-Bera': jb.pValue,
        'Kolmogorov-Smirnov': ks.pValue,
        'Anderson-Darling': ad.pValue,
        'Cramer-von Mises': cvm.pValue,
        "D'Agostino-Pearson": dp.pValue
      });
      
      const tests = [
        { name: 'Shapiro-Wilk', id: 'sw', ...sw, weight: 1.0 },
        { name: 'Anderson-Darling', id: 'ad', ...ad, weight: 0.9 },
        { name: 'Kolmogorov-Smirnov', id: 'ks', ...ks, weight: 0.8 },
        { name: 'Cramer-von Mises', id: 'cvm', ...cvm, weight: 0.7 },
        { name: "D'Agostino-Pearson", id: 'dp', ...dp, weight: 1.0 },
        { name: 'Jarque-Bera', id: 'jb', ...jb, weight: 0.9 }
      ];
      
      displayResults(tests);
      calculateNSI(tests);
      console.log('‚úÖ Results displayed and NSI calculated');
    }

    function displayResults(tests) {
      let passCount = 0;
      let failCount = 0;
      
      tests.forEach(test => {
        const pass = test.pValue >= currentAlpha;
        if (pass) passCount++; else failCount++;
        
        document.getElementById(`${test.id}-stat`).textContent = test.statistic.toFixed(4);
        document.getElementById(`${test.id}-p`).textContent = test.pValue.toFixed(4);
        document.getElementById(`${test.id}-crit`).textContent = test.critical.toFixed(4);
        
        const badge = document.getElementById(`${test.id}-badge`);
        badge.textContent = pass ? 'PASS' : 'FAIL';
        badge.className = pass ? 'test-badge pass' : 'test-badge fail';
      });
      
      document.getElementById('pass-count').textContent = passCount;
      document.getElementById('fail-count').textContent = failCount;
      document.getElementById('sample-size').textContent = originalData.length;
    }

    // ===========================================
    // NSI (Normality Strength Index) - VB6 version
    // ===========================================
    function calculateNSI(tests) {
      let totalWeight = 0;
      let weightedScore = 0;
      
      tests.forEach(test => {
        const p = test.pValue;
        const w = test.weight;
        let score = 0;
        
        if (p === null || isNaN(p)) return;
        
        // Scoring algorithm from VB6 HTML
        if (p < 0.001) {
          score = 0;
        } else if (p < 0.05) {
          const logScale = Math.log10(p) - Math.log10(0.001);
          const maxLogScale = Math.log10(0.05) - Math.log10(0.001);
          score = 10 + (30 * logScale / maxLogScale);
        } else if (p < 0.5) {
          const logScale = Math.log10(p) - Math.log10(0.05);
          const maxLogScale = Math.log10(0.5) - Math.log10(0.05);
          score = 40 + (40 * logScale / maxLogScale);
        } else {
          score = 80 + (20 * (p - 0.5) / 0.5);
        }
        
        weightedScore += score * w;
        totalWeight += w;
      });
      
      const finalScore = Math.round(totalWeight > 0 ? weightedScore / totalWeight : 50);
      updateGauge(finalScore);
      console.log('üìä NSI Score:', finalScore);
    }

    function updateGauge(score) {
      if (!gaugeChart) {
        gaugeChart = Highcharts.chart('normalityGauge', {
          chart: {
            type: 'solidgauge',
            backgroundColor: 'transparent',
            height: 180
          },
          title: null,
          pane: {
            startAngle: -90,
            endAngle: 90,
            background: {
              backgroundColor: '#1a1f2e',
              innerRadius: '60%',
              outerRadius: '100%',
              shape: 'arc'
            }
          },
          yAxis: {
            min: 0,
            max: 100,
            lineWidth: 0,
            tickWidth: 0,
            minorTickInterval: null,
            tickAmount: 3,
            labels: {
              y: 16,
              style: { fontSize: '10px', color: '#fff' }
            },
            plotBands: [
              { from: 0, to: 33.33, color: '#ef4444' },
              { from: 33.33, to: 66.66, color: '#f59e0b' },
              { from: 66.66, to: 100, color: '#22c55e' }
            ]
          },
          plotOptions: {
            solidgauge: {
              dataLabels: {
                y: -20,
                borderWidth: 0,
                useHTML: true
              }
            }
          },
          credits: { enabled: false },
          series: [{
            name: 'NSI',
            data: [score],
            dataLabels: {
              format: '<div style="text-align:center">' +
                '<span style="font-size:30px;color:#fff;font-weight:700">{y}</span><br/>' +
                '<span style="font-size:11px;opacity:0.7">NSI</span>' +
                '</div>'
            }
          }]
        });
      } else {
        gaugeChart.series[0].points[0].update(score);
      }
    }

    // ===========================================
    // OFFICE.JS & DATA HANDLING
    // ===========================================
    Office.initialize = function (reason) {
      console.log('‚úÖ Normality Tests - Office.js initialized:', reason);
      
      // Add message handler
      Office.context.ui.addHandlerAsync(
        Office.EventType.DialogParentMessageReceived,
        onMessageReceived,
        (result) => {
          if (result.status === Office.AsyncResultStatus.Succeeded) {
            console.log('‚úÖ Message handler added successfully');
          } else {
            console.error('‚ùå Failed to add message handler:', result.error);
          }
        }
      );
      
      // Send ready status to parent
      setTimeout(() => {
        sendMessageToParent({ status: 'ready' });
        console.log('üì§ Sent ready status to parent');
      }, 500);
      
      // Fallback to sample data after 5 seconds if no real data
      setTimeout(() => { 
        if (!dataReady) {
          console.log('‚ö†Ô∏è No data received after 5s, loading sample data');
          loadSampleData();
        }
      }, 5000);
    };

    window.addEventListener('DOMContentLoaded', function() {
      console.log('üöÄ DOM Content Loaded');
      const initHeader = () => {
        if (typeof StatisticoHeader !== 'undefined') {
          StatisticoHeader.init('normality', 'Variable', 0);
        } else {
          setTimeout(initHeader, 100);
        }
      };
      initHeader();
      
      const checkAndInit = () => {
        if (checkLibraries()) {
          if (typeof Office === 'undefined') {
            loadSampleData();
          }
        } else {
          setTimeout(checkAndInit, 100);
        }
      };
      setTimeout(checkAndInit, 100);
    });

    function onMessageReceived(arg) {
      try {
        const message = JSON.parse(arg.message);
        console.log('üì© Normality received message:', message);
        if ((message.action === 'sendData' || message.action === 'loadData') && message.data) {
          console.log('‚úÖ Data message received, handling data...');
          handleDataReceived(message.data);
        }
      } catch (e) {
        console.error('‚ùå Error handling message:', e);
      }
    }

    function sendMessageToParent(message) {
      if (typeof Office !== 'undefined' && Office.context && Office.context.ui) {
        Office.context.ui.messageParent(JSON.stringify(message));
      }
    }

    function loadSampleData() {
      console.log('üìä Loading sample data...');
      if (!checkLibraries()) {
        setTimeout(loadSampleData, 200);
        return;
      }
      
      const sampleData = [];
      for (let i = 0; i < 100; i++) {
        const u1 = Math.random();
        const u2 = Math.random();
        const z = Math.sqrt(-2 * Math.log(u1)) * Math.cos(2 * Math.PI * u2);
        sampleData.push(50 + z * 10);
      }
      
      originalData = sampleData;
      varName = 'Sample Data';
      dataReady = true;
      
      const updateHeader = () => {
        if (typeof StatisticoHeader !== 'undefined') {
          StatisticoHeader.updateVariable(varName, originalData.length);
        } else {
          setTimeout(updateHeader, 100);
        }
      };
      updateHeader();
      
      runNormalityTests();
    }

    function handleDataReceived(data) {
      try {
        console.log('üìä handleDataReceived called with data:', data);
        
        if (!checkLibraries()) {
          console.log('‚ö†Ô∏è Libraries not ready, retrying...');
          setTimeout(() => handleDataReceived(data), 200);
          return;
        }
        
        originalData = data.values || data.data || [];
        varName = data.variableName || data.column || 'Variable';
        dataReady = true;
        
        console.log('‚úÖ Data loaded:', {
          varName,
          dataLength: originalData.length,
          firstFewValues: originalData.slice(0, 5)
        });
        
        const updateHeader = () => {
          if (typeof StatisticoHeader !== 'undefined') {
            StatisticoHeader.updateVariable(varName, originalData.length);
            console.log('‚úÖ Header updated:', varName, 'n=' + originalData.length);
          } else {
            setTimeout(updateHeader, 100);
          }
        };
        updateHeader();
        
        runNormalityTests();
      } catch (e) {
        console.error('‚ùå Error in handleDataReceived:', e);
      }
    }
  </script>
</body>
</html>
