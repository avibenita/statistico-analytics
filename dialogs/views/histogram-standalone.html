<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Histogram Analysis - Statistico</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <!-- Office.js -->
  <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
  
  <!-- Font Awesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet">
  
  <!-- Highcharts -->
  <script src="https://code.highcharts.com/highcharts.js"></script>
  <script src="https://code.highcharts.com/modules/histogram-bellcurve.js"></script>
  
  <style>
    /* EXACT COPY OF ORIGINAL HISTOGRAM STYLES */
    :root {
      --surface-0: #0c1624;
      --surface-1: #1a1f2e;
      --surface-2: #242938;
      --border: #2d3748;
      --accent-1: rgb(255,165,120);
      --accent-2: rgb(120,200,255);
      --text-primary: #ffffff;
      --text-secondary: rgba(255,255,255,0.8);
      --text-muted: rgba(255,255,255,0.6);
      --panel-radius: 10px;
      --panel-shadow: 0px 4px 20px rgba(0, 0, 0, 0.4);
      --header-color: var(--accent-1);
    }

    body {
      background-color: var(--surface-0);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      color: var(--text-primary);
      overflow-x: hidden;
      overflow-y: auto;
      height: 100vh;
    }

    /* Scrollbar styling */
    body::-webkit-scrollbar {
      width: 12px;
    }

    body::-webkit-scrollbar-track {
      background: rgba(255,255,255,0.08);
      border-radius: 6px;
    }

    body::-webkit-scrollbar-thumb {
      background: rgba(120,200,255,0.4);
      border-radius: 6px;
      border: 2px solid var(--surface-0);
    }

    body::-webkit-scrollbar-thumb:hover {
      background: rgba(120,200,255,0.6);
    }

    /* Results container - EXACT match */
    .results-container {
      display: none;
      margin: 20px;
    }

    .results-container.show {
      display: block !important;
    }

    /* Panel styling - EXACT match */
    .panel {
      background-color: var(--surface-1);
      border-radius: var(--panel-radius);
      box-shadow: var(--panel-shadow);
      border: 1px solid var(--border);
      margin-bottom: 20px;
    }

    .panel-heading {
      background: transparent;
      color: var(--header-color);
      font-weight: 600;
      padding: 12px 16px;
      font-size: 1.2rem;
      letter-spacing: .3px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .panel-body {
      padding: 16px;
    }

    /* Table styling - EXACT match */
    table {
      width: 100%;
      text-align: center;
      background: var(--surface-2);
      border-radius: 4px;
      overflow: hidden;
      border: 1px solid var(--border);
      border-collapse: collapse;
    }

    table th {
      padding: 5px 8px;
      font-weight: 600;
      font-size: 13px;
      background: var(--surface-0);
      color: var(--accent-1);
    }

    table th.highlight {
      background: rgba(255, 165, 120, 0.3);
      color: var(--text-primary);
    }

    table td {
      padding: 8px 10px;
      font-size: 14px;
      font-weight: 500;
      color: var(--text-primary);
    }

    table td.highlight {
      color: var(--accent-1);
      font-weight: 700;
      background: rgba(255,165,120,0.1);
    }

    /* Controls - EXACT match */
    .controls {
      display: flex;
      gap: 15px;
      margin-bottom: 10px;
      font-size: 12px;
      flex-wrap: wrap;
      align-items: center;
    }

    .control-group {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .control-group label {
      color: var(--text-secondary);
      font-size: 12px;
    }

    .control-group select,
    .control-group input[type="number"] {
      padding: 4px 8px;
      font-size: 12px;
      background: var(--surface-1);
      color: var(--text-primary);
      border: 1px solid var(--border);
      border-radius: 4px;
    }

    .control-group input[type="range"] {
      width: 100px;
    }

    .control-group input[type="checkbox"] {
      width: 16px;
      height: 16px;
      cursor: pointer;
    }

    /* Chart container - EXACT match */
    #histogram-chart {
      min-height: 400px;
      width: 100%;
    }

    /* Range slider styling - EXACT match */
    .range-control {
      display: flex;
      align-items: center;
      gap: 8px;
      flex: 1;
      min-width: 300px;
    }

    .range-sliders {
      position: relative;
      flex: 1;
      height: 20px;
    }

    .range-sliders input[type="range"] {
      position: absolute;
      width: 100%;
      pointer-events: none;
      -webkit-appearance: none;
      background: transparent;
    }

    .range-sliders input[type="range"]::-webkit-slider-thumb {
      pointer-events: all;
      -webkit-appearance: none;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: var(--accent-2);
      cursor: pointer;
    }

    .range-track {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      width: 100%;
      height: 4px;
      background: rgba(255,255,255,0.2);
      border-radius: 2px;
    }

    .range-active {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      height: 4px;
      background: var(--accent-1);
      border-radius: 2px;
    }

    .value-display {
      min-width: 40px;
      font-size: 11px;
      color: var(--accent-2);
      font-weight: 600;
      text-align: center;
    }

    .reset-button {
      background: var(--accent-2);
      color: white;
      border: none;
      padding: 4px 10px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 11px;
      font-weight: 600;
    }

    .reset-button:hover {
      opacity: 0.9;
    }

    /* Icon buttons */
    .panel-heading i {
      cursor: pointer;
      margin-left: 10px;
      transition: color 0.3s;
    }

    .panel-heading i:hover {
      color: var(--accent-2);
    }
  </style>
</head>
<body>
  
  <!-- Simple Header -->
  <div style="background: var(--surface-1); padding: 16px; border-bottom: 2px solid var(--border);">
    <h1 style="margin: 0; font-size: 1.5rem; color: var(--accent-1);">Interactive Histogram</h1>
    <p style="margin: 4px 0 0 0; font-size: 0.95rem; color: var(--text-secondary);">
      <span id="headerVariableName">Variable</span> <span id="headerSampleSize">(n=0)</span>
    </p>
  </div>

  <!-- RESULTS CONTAINER - Initially hidden, shown when data loads -->
  <div class="results-container" id="results-container">

    <!-- STATISTICS PANEL - EXACT COPY -->
    <div class="panel table-panel" id="statistics-panel">
      <div class="panel-heading">
        <span id="statistics-title">Variable - Descriptive Statistics</span>
        <span style="margin-left: auto;">
          <select id="decimalsSelect" onchange="updateDecimals(this.value)">
            <option value="0">0</option>
            <option value="1">1</option>
            <option value="2" selected>2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5</option>
          </select>
        </span>
      </div>
      <div class="panel-body" style="padding: 6px;">
        <!-- First Table: Central Tendency & Distribution Shape -->
        <table style="margin-bottom: 8px;">
          <tr>
            <th class="highlight">Count</th>
            <th class="highlight">Average</th>
            <th class="highlight">Std Dev</th>
            <th>Variance</th>
            <th>Kurtosis</th>
            <th>Skewness</th>
          </tr>
          <tr>
            <td id="stat-n" class="highlight">--</td>
            <td id="stat-mean" class="highlight">--</td>
            <td id="stat-stddev" class="highlight">--</td>
            <td id="stat-variance">--</td>
            <td id="stat-kurtosis">--</td>
            <td id="stat-skewness">--</td>
          </tr>
        </table>

        <!-- Second Table: Range & Quartiles -->
        <table>
          <tr>
            <th>Range</th>
            <th>Minimum</th>
            <th>Q25</th>
            <th class="highlight">Median</th>
            <th>Q75</th>
            <th>Maximum</th>
          </tr>
          <tr>
            <td id="stat-range">--</td>
            <td id="stat-min">--</td>
            <td id="stat-q25">--</td>
            <td id="stat-median" class="highlight">--</td>
            <td id="stat-q75">--</td>
            <td id="stat-max">--</td>
          </tr>
        </table>
      </div>
    </div>

    <!-- HISTOGRAM PANEL - EXACT COPY -->
    <div class="panel chart-panel" id="histogram-panel">
      <div class="panel-heading">
        <span id="histogram-title">Variable - Interactive Histogram</span>
        <span style="margin-left: auto;">
          <i class="fas fa-redo" title="Reload" onclick="createHistogram()"></i>
          <i class="fas fa-times" title="Close" onclick="closeView()"></i>
        </span>
      </div>

      <div class="panel-body" style="padding: 6px;">
        <!-- Controls - EXACT COPY -->
        <div class="controls">
          <div class="control-group">
            <label for="binningMethod">Method:</label>
            <select id="binningMethod" onchange="updateBinningMethod()">
              <option value="manual">Manual</option>
              <option value="sturges">Sturges</option>
              <option value="scott">Scott</option>
              <option value="fd">Freedman-Diaconis</option>
            </select>
          </div>

          <div class="control-group" id="manualBinsControl">
            <label for="numBins">Bins:</label>
            <span id="numBinsValue" class="value-display">10</span>
            <input type="range" id="numBins" min="1" max="50" value="10" step="1" oninput="updateBins()">
          </div>

          <div class="control-group">
            <input type="checkbox" id="showNormalCurve" checked onchange="createHistogram()">
            <label for="showNormalCurve">Normal Curve</label>
          </div>

          <!-- Range Control - EXACT COPY -->
          <div class="range-control">
            <label>Data Range:</label>
            <span class="value-display" id="leftRangeValue">0</span>
            <div class="range-sliders" style="flex: 1;">
              <div class="range-track"></div>
              <div class="range-active" id="activeRangeIndicator"></div>
              <input type="range" id="leftTruncation" min="0" max="100" value="0" step="1" oninput="updateRangeSliders()">
              <input type="range" id="rightTruncation" min="0" max="100" value="100" step="1" oninput="updateRangeSliders()">
            </div>
            <span class="value-display" id="rightRangeValue">100</span>
            <button class="reset-button" onclick="resetRangeSliders()">Reset</button>
            <span class="value-display" style="margin-left: 8px;">n=<span id="remainingN">--</span></span>
          </div>
        </div>

        <!-- Chart -->
        <div id="histogram-chart"></div>
      </div>
    </div>

  </div>

  <!-- JAVASCRIPT - EXACT COPY OF ORIGINAL LOGIC -->
  <script>
    // Global variables
    let histogramChart = null;
    let originalData = [];
    let currentData = [];
    let originalMin = 0;
    let originalMax = 100;
    let currentDecimals = 2;

    // Office.js initialization
    Office.initialize = function (reason) {
      console.log('‚úÖ Office.js initialized:', reason);
      
      // Listen for messages from parent
      Office.context.ui.addHandlerAsync(
        Office.EventType.DialogParentMessageReceived,
        onMessageReceived
      );
      
      // For testing, load sample data
      loadSampleData();
    };
    
    // Fallback: If Office.js doesn't load (browser testing), load sample data anyway
    window.addEventListener('DOMContentLoaded', function() {
      console.log('üöÄ DOM Content Loaded');
      
      // Try immediately
      setTimeout(() => {
        console.log('‚è∞ Checking Office.js availability...');
        console.log('typeof Office:', typeof Office);
        
        // Check if Office.js loaded
        if (typeof Office === 'undefined' || !Office.context) {
          console.log('‚ö†Ô∏è Office.js not available - loading sample data for browser testing');
          loadSampleData();
        } else {
          console.log('‚úÖ Office.js is available');
        }
      }, 100);
      
      // Backup fallback - just load data after 1 second regardless
      setTimeout(() => {
        const resultsContainer = document.getElementById('results-container');
        if (!resultsContainer.classList.contains('show')) {
          console.log('üîÑ Force loading sample data (backup)');
          loadSampleData();
        }
      }, 1000);
    });

    // Handle messages from parent window
    function onMessageReceived(arg) {
      console.log('üì® Message received:', arg);
      const message = JSON.parse(arg.message);
      
      if (message.action === 'loadData') {
        handleDataReceived(message.data);
      }
    }

    // Handle data received
    function handleDataReceived(data) {
      try {
        console.log('üìä Data received:', data);
        
        originalData = data.values || data.data || [];
        currentData = [...originalData];
        console.log('‚úÖ Data arrays set, length:', originalData.length);
        
        // Update stats
        populateStatistics(data.descriptive);
        console.log('‚úÖ Statistics populated');
        
        // Update variable name
        const varName = data.column || data.variableName || 'Variable';
        document.getElementById('statistics-title').textContent = `${varName} - Descriptive Statistics`;
        document.getElementById('histogram-title').textContent = `${varName} - Interactive Histogram`;
        console.log('‚úÖ Titles updated');
        
        // Update simple header
        document.getElementById('headerVariableName').textContent = varName;
        document.getElementById('headerSampleSize').textContent = `(n=${originalData.length})`;
        console.log('‚úÖ Header updated');
        
        // Initialize range
        originalMin = Math.min(...originalData);
        originalMax = Math.max(...originalData);
        console.log('‚úÖ Range initialized:', originalMin, '-', originalMax);
        
        // Show results
        const resultsContainer = document.getElementById('results-container');
        resultsContainer.classList.add('show');
        console.log('‚úÖ Results container shown');
        
        // Create histogram
        console.log('üé® Creating histogram...');
        createHistogram();
        console.log('‚úÖ Histogram created');
      } catch (error) {
        console.error('‚ùå Error in handleDataReceived:', error);
        alert('Error handling data: ' + error.message);
      }
    }

    // Load sample data for testing
    function loadSampleData() {
      try {
        console.log('üìä Loading sample data for testing...');
        
        // Generate realistic sample data (Horsepower-like)
        const sampleData = [];
        for (let i = 0; i < 369; i++) {
          const u1 = Math.random();
          const u2 = Math.random();
          const z = Math.sqrt(-2 * Math.log(u1)) * Math.cos(2 * Math.PI * u2);
          sampleData.push(201.17 + z * 60.64);
        }
        
        console.log('‚úÖ Generated', sampleData.length, 'data points');
        
        // Calculate descriptive stats
        const descriptive = calculateDescriptiveStats(sampleData);
        console.log('‚úÖ Calculated descriptive stats:', descriptive);
        
        handleDataReceived({
          values: sampleData,
          descriptive: descriptive,
          column: 'Horsepower',
          n: sampleData.length
        });
        
        console.log('‚úÖ Sample data loaded successfully');
      } catch (error) {
        console.error('‚ùå Error loading sample data:', error);
        alert('Error loading sample data: ' + error.message);
      }
    }

    // Calculate descriptive statistics
    function calculateDescriptiveStats(data) {
      const n = data.length;
      const sorted = [...data].sort((a, b) => a - b);
      const mean = data.reduce((a, b) => a + b, 0) / n;
      const variance = data.reduce((acc, val) => acc + Math.pow(val - mean, 2), 0) / (n - 1);
      const stdDev = Math.sqrt(variance);
      
      const q1 = sorted[Math.floor(n * 0.25)];
      const median = sorted[Math.floor(n * 0.5)];
      const q3 = sorted[Math.floor(n * 0.75)];
      
      // Kurtosis
      const m4 = data.reduce((acc, val) => acc + Math.pow((val - mean) / stdDev, 4), 0) / n;
      const kurtosis = m4 - 3;
      
      // Skewness
      const m3 = data.reduce((acc, val) => acc + Math.pow((val - mean) / stdDev, 3), 0) / n;
      const skewness = m3;
      
      return {
        n: n,
        mean: mean,
        stdDev: stdDev,
        variance: variance,
        kurtosis: kurtosis,
        skewness: skewness,
        range: sorted[n - 1] - sorted[0],
        min: sorted[0],
        q1: q1,
        median: median,
        q3: q3,
        max: sorted[n - 1]
      };
    }

    // Populate statistics table
    function populateStatistics(stats) {
      const d = currentDecimals;
      document.getElementById('stat-n').textContent = stats.n;
      document.getElementById('stat-mean').textContent = stats.mean.toFixed(d);
      document.getElementById('stat-stddev').textContent = stats.stdDev.toFixed(d);
      document.getElementById('stat-variance').textContent = stats.variance.toFixed(d);
      document.getElementById('stat-kurtosis').textContent = stats.kurtosis.toFixed(d);
      document.getElementById('stat-skewness').textContent = stats.skewness.toFixed(d);
      document.getElementById('stat-range').textContent = stats.range.toFixed(d);
      document.getElementById('stat-min').textContent = stats.min.toFixed(d);
      document.getElementById('stat-q25').textContent = stats.q1.toFixed(d);
      document.getElementById('stat-median').textContent = stats.median.toFixed(d);
      document.getElementById('stat-q75').textContent = stats.q3.toFixed(d);
      document.getElementById('stat-max').textContent = stats.max.toFixed(d);
    }

    // Update decimals
    function updateDecimals(value) {
      currentDecimals = parseInt(value);
      const stats = calculateDescriptiveStats(currentData);
      populateStatistics(stats);
    }

    // Update binning method
    function updateBinningMethod() {
      const method = document.getElementById('binningMethod').value;
      document.getElementById('manualBinsControl').style.display = 
        method === 'manual' ? 'flex' : 'none';
      createHistogram();
    }

    // Update bins slider
    function updateBins() {
      const value = document.getElementById('numBins').value;
      document.getElementById('numBinsValue').textContent = value;
      createHistogram();
    }

    // Create histogram - EXACT COPY of original logic
    function createHistogram() {
      const numBinsInput = document.getElementById('numBins');
      const showNormal = document.getElementById('showNormalCurve').checked;
      
      let numBins = parseInt(numBinsInput.value);
      const method = document.getElementById('binningMethod').value;
      
      // Calculate bins based on method
      if (method !== 'manual') {
        numBins = calculateOptimalBins(method, currentData);
        numBinsInput.value = numBins;
        document.getElementById('numBinsValue').textContent = numBins;
      }
      
      const min = Math.min(...currentData);
      const max = Math.max(...currentData);
      const binWidth = (max - min) / numBins;
      
      const bins = new Array(numBins).fill(0);
      const categories = [];
      
      // Calculate histogram bins
      for (let i = 0; i < numBins; i++) {
        const binStart = min + i * binWidth;
        const binEnd = binStart + binWidth;
        categories.push(`${binStart.toFixed(0)}-${binEnd.toFixed(0)}`);
        bins[i] = currentData.filter(v => v >= binStart && (i === numBins - 1 ? v <= binEnd : v < binEnd)).length;
      }
      
      const series = [{
        name: 'Frequency',
        type: 'column',
        data: bins,
        color: '#4a90e2',
        borderColor: '#2a5f9e',
        borderWidth: 1
      }];
      
      // Add normal curve if checked
      if (showNormal) {
        const mean = currentData.reduce((a, b) => a + b, 0) / currentData.length;
        const stdDev = Math.sqrt(currentData.reduce((sum, v) => sum + Math.pow(v - mean, 2), 0) / currentData.length);
        
        const normalData = [];
        const step = (max - min) / 100;
        for (let x = min; x <= max; x += step) {
          const y = (1 / (stdDev * Math.sqrt(2 * Math.PI))) * 
                    Math.exp(-0.5 * Math.pow((x - mean) / stdDev, 2));
          normalData.push([x, y * currentData.length * binWidth]);
        }
        
        series.push({
          name: 'Normal Distribution',
          type: 'spline',
          data: normalData,
          color: '#ffa578',
          lineWidth: 2,
          marker: { enabled: false }
        });
      }
      
      // Create chart
      histogramChart = Highcharts.chart('histogram-chart', {
        chart: {
          backgroundColor: '#242938',
          style: { fontFamily: 'Segoe UI' }
        },
        title: {
          text: 'Distribution',
          style: { color: '#ffffff' }
        },
        xAxis: {
          categories: categories,
          labels: {
            rotation: -45,
            style: { color: '#ffffff' }
          }
        },
        yAxis: {
          title: {
            text: 'Frequency',
            style: { color: '#78c8ff' }
          },
          labels: { style: { color: '#ffffff' } },
          gridLineColor: '#2d3748'
        },
        legend: {
          itemStyle: { color: '#ffffff' }
        },
        plotOptions: {
          column: {
            groupPadding: 0,
            pointPadding: 0,
            borderWidth: 1
          }
        },
        series: series,
        credits: { enabled: false }
      });
    }

    // Calculate optimal bins
    function calculateOptimalBins(method, data) {
      const n = data.length;
      
      switch(method) {
        case 'sturges':
          return Math.ceil(Math.log2(n) + 1);
        case 'scott':
          const sorted = [...data].sort((a, b) => a - b);
          const stdDev = Math.sqrt(data.reduce((sum, v) => sum + Math.pow(v - data.reduce((a,b)=>a+b,0)/n, 2), 0) / n);
          const binWidth = 3.49 * stdDev / Math.pow(n, 1/3);
          return Math.ceil((sorted[n-1] - sorted[0]) / binWidth);
        case 'fd':
          const sortedFD = [...data].sort((a, b) => a - b);
          const q1 = sortedFD[Math.floor(n * 0.25)];
          const q3 = sortedFD[Math.floor(n * 0.75)];
          const iqr = q3 - q1;
          const binWidthFD = 2 * iqr / Math.pow(n, 1/3);
          return Math.ceil((sortedFD[n-1] - sortedFD[0]) / binWidthFD);
        default:
          return 10;
      }
    }

    // Range sliders - EXACT COPY
    function updateRangeSliders() {
      const leftSlider = document.getElementById('leftTruncation');
      const rightSlider = document.getElementById('rightTruncation');
      
      let leftVal = parseInt(leftSlider.value);
      let rightVal = parseInt(rightSlider.value);
      
      // Prevent crossing
      if (leftVal >= rightVal) {
        leftSlider.value = rightVal - 1;
        leftVal = rightVal - 1;
      }
      
      // Update active indicator
      const activeIndicator = document.getElementById('activeRangeIndicator');
      activeIndicator.style.left = leftVal + '%';
      activeIndicator.style.right = (100 - rightVal) + '%';
      
      // Calculate actual values
      const range = originalMax - originalMin;
      const leftValue = originalMin + (leftVal / 100) * range;
      const rightValue = originalMin + (rightVal / 100) * range;
      
      document.getElementById('leftRangeValue').textContent = leftValue.toFixed(0);
      document.getElementById('rightRangeValue').textContent = rightValue.toFixed(0);
      
      // Filter data
      currentData = originalData.filter(v => v >= leftValue && v <= rightValue);
      document.getElementById('remainingN').textContent = currentData.length;
      
      // Update stats and chart
      const stats = calculateDescriptiveStats(currentData);
      populateStatistics(stats);
      createHistogram();
    }

    // Reset range sliders
    function resetRangeSliders() {
      document.getElementById('leftTruncation').value = 0;
      document.getElementById('rightTruncation').value = 100;
      currentData = [...originalData];
      updateRangeSliders();
    }

    // Close view
    function closeView() {
      if (typeof Office !== 'undefined' && Office.context && Office.context.ui) {
        Office.context.ui.messageParent('close');
      } else {
        alert('Close button clicked. In real Office dialog, this closes the popup.');
      }
    }

    console.log('‚úÖ Histogram view script loaded');
  </script>
</body>
</html>
