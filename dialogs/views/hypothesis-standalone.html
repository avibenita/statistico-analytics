<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Hypothesis Testing - Statistico</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jstat/1.9.4/jstat.min.js"></script>
  <link rel="stylesheet" href="./shared-header.css">
  <script src="./shared-header.js"></script>
  
  <style>
    :root {
      --surface-0: #0c1624;
      --surface-1: #1a1f2e;
      --surface-2: #242938;
      --border: #2d3748;
      --accent-1: rgb(255,165,120);
      --accent-2: rgb(120,200,255);
      --text-primary: #ffffff;
      --text-secondary: rgba(255,255,255,0.8);
      --text-muted: rgba(255,255,255,0.6);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      background-color: var(--surface-0);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      color: var(--text-primary);
      overflow-x: hidden;
    }

    .results-container {
      padding: 8px;
      max-width: 100%;
    }

    /* Configuration Section */
    .config-section {
      margin-bottom: 10px;
    }

    .section-header {
      font-size: 15px;
      font-weight: 700;
      color: var(--accent-1);
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .popsize-control {
      display: flex;
      align-items: center;
      gap: 8px;
      background: var(--surface-1);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 4px 10px;
      transition: opacity 0.3s ease;
    }

    .popsize-control.disabled {
      opacity: 0.4;
      pointer-events: none;
    }

    .popsize-control label {
      font-size: 11px;
      color: var(--text-muted);
    }

    .popsize-control input {
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 4px;
      color: white;
      padding: 3px 6px;
      width: 80px;
      font-size: 11px;
      text-align: center;
    }

    .config-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 10px;
    }

    .config-panel {
      background: var(--surface-1);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 10px;
    }

    .panel-label {
      font-size: 11px;
      font-weight: 700;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }

    .radio-group {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .radio-label {
      display: flex;
      align-items: center;
      gap: 5px;
      cursor: pointer;
      color: var(--text-secondary);
      font-size: 13px;
    }

    .radio-label input[type="radio"] {
      cursor: pointer;
      width: 16px;
      height: 16px;
      accent-color: var(--accent-2);
    }

    .radio-label.disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    /* Hypothesis Section */
    .hypothesis-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 10px;
    }

    .h0-panel, .h1-panel {
      background: var(--surface-1);
      border-radius: 6px;
      padding: 10px;
    }

    .h0-panel {
      border: 2px solid var(--accent-1);
    }

    .h1-panel {
      border: 2px solid var(--accent-2);
    }

    .h-label {
      font-size: 13px;
      font-weight: 700;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .h0-panel .h-label {
      color: var(--accent-1);
    }

    .h1-panel .h-label {
      color: var(--accent-2);
    }

    .h0-input {
      background: rgba(0,0,0,0.3);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 4px;
      color: white;
      padding: 6px 10px;
      width: 90px;
      font-size: 15px;
      font-weight: 600;
      text-align: center;
    }

    .h1-options {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .run-button {
      background: linear-gradient(135deg, var(--accent-1), rgb(255,140,90));
      border: none;
      color: white;
      padding: 10px 25px;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      margin: 0 auto;
      transition: all 0.3s ease;
    }

    .run-button:hover {
      transform: scale(1.05);
      box-shadow: 0 0 20px rgba(255,165,120,0.5);
    }

    /* Results Section */
    .results-section {
      margin-top: 12px;
    }

    .results-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .results-actions {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    /* Alpha Slider in Header */
    .alpha-slider-control {
      display: flex;
      align-items: center;
      gap: 8px;
      background: var(--surface-1);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 4px 12px;
    }

    .alpha-slider-control label {
      font-size: 11px;
      color: var(--text-muted);
      font-weight: 600;
      white-space: nowrap;
    }

    .alpha-slider-control input[type="range"] {
      width: 100px;
      height: 4px;
      border-radius: 2px;
      background: rgba(255,255,255,0.2);
      outline: none;
      -webkit-appearance: none;
      appearance: none;
    }

    .alpha-slider-control input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: var(--accent-1);
      cursor: pointer;
    }

    .alpha-slider-control input[type="range"]::-moz-range-thumb {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: var(--accent-1);
      cursor: pointer;
      border: none;
    }

    .alpha-value {
      font-size: 12px;
      font-weight: 700;
      color: var(--accent-1);
      min-width: 35px;
    }

    .action-btn {
      background: var(--accent-2);
      border: none;
      color: white;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 5px;
      transition: all 0.3s ease;
    }

    .action-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 0 15px rgba(120,200,255,0.5);
    }

    .results-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-bottom: 10px;
    }

    .result-card {
      background: var(--surface-2);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 10px;
      text-align: center;
    }

    .result-card.highlight {
      border: 2px solid var(--accent-1);
    }

    .card-icon {
      font-size: 10px;
      color: var(--text-muted);
      margin-bottom: 3px;
    }

    .card-label {
      font-size: 10px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 5px;
    }

    .card-value {
      font-size: 16px;
      font-weight: 700;
      color: var(--accent-1);
    }

    .stats-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 10px;
    }

    .stat-box {
      background: linear-gradient(135deg, var(--surface-2), var(--surface-1));
      border: 2px solid var(--accent-1);
      border-radius: 8px;
      padding: 15px;
      text-align: center;
      box-shadow: 0 4px 15px rgba(255,165,120,0.2);
    }

    .stat-label {
      font-size: 12px;
      color: var(--text-muted);
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      font-weight: 600;
    }

    .stat-value {
      font-size: 28px;
      font-weight: 700;
      color: var(--accent-1);
      text-shadow: 0 0 10px rgba(255,165,120,0.3);
    }

    /* Decision Card */
    .decision-card {
      background: var(--surface-2);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 12px;
      text-align: center;
    }

    .decision-label {
      font-size: 10px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 5px;
    }

    .decision-result {
      color: white;
      padding: 12px 20px;
      border-radius: 6px;
      font-size: 15px;
      font-weight: 700;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: linear-gradient(135deg, rgba(248,113,113,0.2), rgba(239,68,68,0.2));
      border: 2px solid #f87171;
    }

    .decision-result.fail-to-reject {
      background: linear-gradient(135deg, rgba(74,222,128,0.2), rgba(34,197,94,0.2));
      border: 2px solid #4ade80;
    }

    /* Awaiting State */
    .awaiting-state {
      text-align: center;
      padding: 30px 20px;
      color: var(--text-muted);
      font-size: 13px;
    }

    .awaiting-state i {
      font-size: 40px;
      color: var(--accent-2);
      margin-bottom: 12px;
      opacity: 0.5;
    }

    /* Alpha Control (removed old button version) */
    .alpha-control {
      display: none;
    }

    @media (max-width: 768px) {
      .config-grid {
        grid-template-columns: 1fr;
      }
      .hypothesis-row {
        grid-template-columns: 1fr;
      }
      .results-grid {
        grid-template-columns: 1fr;
      }
      .stats-row {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <statistico-header view-name="Hypothesis Testing" module-name="Univariate Analysis"></statistico-header>
  
  <div class="results-container">
    <!-- Configuration Section -->
    <div class="config-section">
      <div class="section-header">
        Hypothesis Test Configuration
        <div class="popsize-control">
          <label>Pop. Size:</label>
          <input type="text" id="pop-size" placeholder="‚àû" value="‚àû">
        </div>
      </div>

      <div class="config-grid">
        <!-- METHOD Panel -->
        <div class="config-panel">
          <div class="panel-label">METHOD:</div>
          <div class="radio-group">
            <label class="radio-label">
              <input type="radio" name="method" value="classical" checked onchange="selectMethod('classical')">
              <span>Classical</span>
            </label>
            <label class="radio-label">
              <input type="radio" name="method" value="bootstrap" onchange="selectMethod('bootstrap')">
              <span>Bootstrap</span>
            </label>
          </div>
        </div>

        <!-- PARAMETER Panel -->
        <div class="config-panel">
          <div class="panel-label">PARAMETER:</div>
          <div class="radio-group">
            <label class="radio-label">
              <input type="radio" name="parameter" value="mean" checked onchange="selectParameter('mean')">
              <span>Mean</span>
            </label>
            <label class="radio-label">
              <input type="radio" name="parameter" value="variance" onchange="selectParameter('variance')">
              <span>Variance</span>
            </label>
          </div>
        </div>
      </div>

      <!-- Hypotheses Row -->
      <div class="hypothesis-row">
        <!-- H0 Panel -->
        <div class="h0-panel">
          <div class="h-label">
            <span>H‚ÇÄ: <span id="h0-param">mean</span> =</span>
            <input type="number" id="h0-value" class="h0-input" value="0" step="any" oninput="updateH1Values()">
          </div>
        </div>

        <!-- H1 Panel -->
        <div class="h1-panel">
          <div class="h-label">H‚ÇÅ: <span id="h1-param">mean</span></div>
          <div class="h1-options">
            <label class="radio-label">
              <input type="radio" name="h1-type" value="less" onchange="setAwaitingState()">
              <span>< <span id="h1-value-less">0</span></span>
            </label>
            <label class="radio-label">
              <input type="radio" name="h1-type" value="not-equal" checked onchange="setAwaitingState()">
              <span>‚â† <span id="h1-value-ne">0</span></span>
            </label>
            <label class="radio-label">
              <input type="radio" name="h1-type" value="greater" onchange="setAwaitingState()">
              <span>> <span id="h1-value-greater">0</span></span>
            </label>
          </div>
        </div>
      </div>

      <!-- Run Button -->
      <button class="run-button" onclick="runTest()">
        <i class="fa-solid fa-play"></i> Run the Test
      </button>
    </div>

    <!-- Results Section -->
    <div class="results-section" id="results-section" style="display: none;">
      <div class="results-header">
        <div class="section-header" style="margin: 0;">Hypothesis Test Results</div>
        <div class="results-actions">
          <div class="alpha-slider-control">
            <label>Œ±:</label>
            <input type="range" id="alpha-slider" min="0.01" max="0.15" step="0.01" value="0.05" oninput="updateAlpha()">
            <span class="alpha-value" id="alpha-value">0.05</span>
          </div>
          <button class="action-btn">
            <i class="fa-solid fa-chart-line"></i> Power
          </button>
          <button class="action-btn">
            <i class="fa-solid fa-chart-area"></i> Visualize
          </button>
        </div>
      </div>

      <!-- Awaiting State (shown initially) -->
      <div id="awaiting-results" class="awaiting-state">
        <i class="fa-solid fa-flask"></i>
        <p>Configure parameters and click "Run the Test" to see results.</p>
      </div>

      <!-- Actual Results (hidden initially) -->
      <div id="actual-results" style="display: none;">

      <div class="results-grid">
        <div class="result-card highlight">
          <div class="card-icon"><i class="fa-solid fa-flask"></i> TEST PARAMETER</div>
          <div class="card-value" id="result-parameter">Mean</div>
        </div>
        <div class="result-card">
          <div class="card-icon"><i class="fa-solid fa-vial"></i> TEST TYPE</div>
          <div class="card-label">One-Sample t-Test</div>
          <div class="card-value" id="result-test-type" style="font-size: 14px;">‚Äî</div>
        </div>
        <div class="result-card">
          <div class="card-icon"><i class="fa-solid fa-arrows-left-right"></i> TEST ORIENTATION</div>
          <div class="card-value" id="result-orientation">Two-tailed</div>
        </div>
      </div>

      <div class="stats-row">
        <div class="stat-box">
          <div class="stat-label">Test Statistic</div>
          <div class="stat-value" id="result-stat-value">‚Äî</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">P-Value</div>
          <div class="stat-value" id="result-pvalue">‚Äî</div>
        </div>
      </div>

      <div class="decision-card">
        <div class="decision-label">
          <i class="fa-solid fa-gavel"></i> TEST DECISION
        </div>
        <div class="decision-result" id="decision-result">
          <i class="fa-solid fa-xmark"></i> Reject H‚ÇÄ
        </div>
      </div>
      </div> <!-- end actual-results -->
    </div> <!-- end results-section -->
  </div>

  <script>
    let resultsData = null;
    let currentMethod = 'classical';
    let currentParameter = 'mean';
    let currentH0 = 0;
    let currentH1Type = 'not-equal';
    let currentAlpha = 0.05;
    let headerInitialized = false;
    let librariesLoaded = false;
    
    // Initialize
    window.addEventListener('DOMContentLoaded', function() {
      console.log('‚úÖ Hypothesis Testing loaded');
      updatePopSizeState();  // Set initial pop size state
      pollForDependencies();
    });

    function pollForDependencies() {
      if (!headerInitialized && typeof StatisticoHeader !== 'undefined') {
        StatisticoHeader.init('hypothesis', 'Variable', 0);
        headerInitialized = true;
        console.log('‚úÖ Shared header initialized');
      }
      
      if (!librariesLoaded && typeof jStat !== 'undefined') {
        librariesLoaded = true;
        console.log('‚úÖ jStat library loaded');
      }
      
      if (headerInitialized && librariesLoaded) {
        console.log('üé® All dependencies ready.');
        return;
      }
      
      setTimeout(pollForDependencies, 100);
    }

    // Method selection
    window.selectMethod = function(method) {
      currentMethod = method;
      console.log('Method changed to:', method);
      
      updatePopSizeState();
      setAwaitingState();
    };

    // Parameter selection
    window.selectParameter = function(param) {
      currentParameter = param;
      console.log('Parameter changed to:', param);
      
      // Update H0 and H1 labels
      document.getElementById('h0-param').textContent = param;
      document.getElementById('h1-param').textContent = param;
      document.getElementById('result-parameter').textContent = param.charAt(0).toUpperCase() + param.slice(1);
      
      updatePopSizeState();
      setAwaitingState();
    };

    // Update alpha from slider
    window.updateAlpha = function() {
      const slider = document.getElementById('alpha-slider');
      currentAlpha = parseFloat(slider.value);
      document.getElementById('alpha-value').textContent = currentAlpha.toFixed(2);
      console.log('Alpha changed to:', currentAlpha);
      
      // If results are showing, recalculate
      if (document.getElementById('actual-results').style.display !== 'none' && resultsData) {
        const result = performHypothesisTest();
        displayResults(result);
      }
    };

    // Update pop size state (enable/disable)
    function updatePopSizeState() {
      const popSizeControl = document.querySelector('.popsize-control');
      const popSizeInput = document.getElementById('pop-size');
      
      // Enable only for Classical + Mean
      if (currentMethod === 'classical' && currentParameter === 'mean') {
        popSizeControl.classList.remove('disabled');
        popSizeInput.disabled = false;
      } else {
        popSizeControl.classList.add('disabled');
        popSizeInput.disabled = true;
      }
    }

    // Update H1 values when H0 changes
    window.updateH1Values = function() {
      const h0Value = document.getElementById('h0-value').value || '0';
      document.getElementById('h1-value-less').textContent = h0Value;
      document.getElementById('h1-value-ne').textContent = h0Value;
      document.getElementById('h1-value-greater').textContent = h0Value;
      setAwaitingState();
    };

    // Set awaiting state (hide results, show awaiting message)
    function setAwaitingState() {
      const resultsSection = document.getElementById('results-section');
      if (resultsSection.style.display !== 'none') {
        document.getElementById('awaiting-results').style.display = 'block';
        document.getElementById('actual-results').style.display = 'none';
      }
    }

    // Run test
    window.runTest = function() {
      currentH0 = parseFloat(document.getElementById('h0-value').value) || 0;
      currentH1Type = document.querySelector('input[name="h1-type"]:checked').value;
      
      console.log('üß™ Running test:', {
        method: currentMethod,
        parameter: currentParameter,
        h0: currentH0,
        h1Type: currentH1Type
      });
      
      if (!resultsData || !resultsData.values || resultsData.values.length === 0) {
        alert('No data available. Please load data first.');
        return;
      }
      
      // Perform test
      const result = performHypothesisTest();
      displayResults(result);
      
      // Show results section
      document.getElementById('results-section').style.display = 'block';
    };

    // Perform hypothesis test
    function performHypothesisTest() {
      const data = resultsData.values;
      const n = data.length;
      const mean = data.reduce((a, b) => a + b, 0) / n;
      const variance = data.reduce((acc, val) => acc + Math.pow(val - mean, 2), 0) / (n - 1);
      const stdev = Math.sqrt(variance);
      
      let testStat, pValue, testType;
      
      if (currentParameter === 'mean') {
        // One-sample t-test
        testStat = (mean - currentH0) / (stdev / Math.sqrt(n));
        
        if (currentH1Type === 'not-equal') {
          pValue = 2 * (1 - jStat.studentt.cdf(Math.abs(testStat), n - 1));
        } else if (currentH1Type === 'greater') {
          pValue = 1 - jStat.studentt.cdf(testStat, n - 1);
        } else { // less
          pValue = jStat.studentt.cdf(testStat, n - 1);
        }
        
        testType = 'One-Sample t-Test';
      } else if (currentParameter === 'variance') {
        // Chi-square test for variance
        testStat = (n - 1) * variance / (currentH0 || 1);
        
        if (currentH1Type === 'not-equal') {
          const pLower = jStat.chisquare.cdf(testStat, n - 1);
          const pUpper = 1 - jStat.chisquare.cdf(testStat, n - 1);
          pValue = 2 * Math.min(pLower, pUpper);
        } else if (currentH1Type === 'greater') {
          pValue = 1 - jStat.chisquare.cdf(testStat, n - 1);
        } else { // less
          pValue = jStat.chisquare.cdf(testStat, n - 1);
        }
        
        testType = 'Chi-Square Test';
      }
      
      const reject = pValue < currentAlpha;
      
      return {
        testStat,
        pValue,
        testType,
        reject,
        orientation: currentH1Type === 'not-equal' ? 'Two-tailed' : (currentH1Type === 'greater' ? 'Right-tailed' : 'Left-tailed')
      };
    }

    // Display results
    function displayResults(result) {
      document.getElementById('result-test-type').textContent = result.testType;
      document.getElementById('result-orientation').textContent = result.orientation;
      document.getElementById('result-stat-value').textContent = result.testStat.toFixed(4);
      document.getElementById('result-pvalue').textContent = result.pValue.toFixed(4);
      
      const decisionEl = document.getElementById('decision-result');
      if (result.reject) {
        decisionEl.innerHTML = '<i class="fa-solid fa-xmark"></i> Reject H‚ÇÄ';
        decisionEl.className = 'decision-result';
      } else {
        decisionEl.innerHTML = '<i class="fa-solid fa-check"></i> Fail to Reject H‚ÇÄ';
        decisionEl.className = 'decision-result fail-to-reject';
      }
      
      // Show actual results, hide awaiting
      document.getElementById('awaiting-results').style.display = 'none';
      document.getElementById('actual-results').style.display = 'block';
    }

    // Office.js initialization
    Office.initialize = function (reason) {
      console.log('‚úÖ Hypothesis Testing - Office.js initialized:', reason);
      
      Office.context.ui.addHandlerAsync(
        Office.EventType.DialogParentMessageReceived,
        onMessageReceived
      );
      
      setTimeout(() => {
        sendMessageToParent({ status: 'ready' });
      }, 500);
      
      // Fallback to sample data
      setTimeout(() => {
        if (!resultsData) {
          console.log('‚ö†Ô∏è No data received, loading sample data');
          loadSampleData();
        }
      }, 5000);
    };

    function onMessageReceived(arg) {
      try {
        const message = JSON.parse(arg.message);
        console.log('üì© Message from parent:', message);
        if (message.action === 'loadData') {
          handleDataReceived(message.data);
        }
      } catch (e) {
        console.error('Error handling dialog message:', e);
      }
    }

    function handleDataReceived(data) {
      if (!librariesLoaded || !headerInitialized) {
        console.warn('‚ö†Ô∏è Libraries or header not ready, deferring data handling.');
        setTimeout(() => handleDataReceived(data), 100);
        return;
      }
      
      console.log('üìä Data received:', data);
      resultsData = {
        values: data.values || data.data || [],
        column: data.column || 'Variable',
        n: data.n || (data.values ? data.values.length : 0)
      };
      
      // Update header with variable name and sample size
      const variableName = resultsData.column || 'Variable';
      StatisticoHeader.updateVariable(variableName, resultsData.n);
      console.log('‚úÖ Header updated with data:', variableName, 'n=', resultsData.n);
    }

    function loadSampleData() {
      console.log('üìä Loading sample data...');
      const sampleData = [];
      for (let i = 0; i < 100; i++) {
        const u1 = Math.random();
        const u2 = Math.random();
        const z = Math.sqrt(-2 * Math.log(u1)) * Math.cos(2 * Math.PI * u2);
        sampleData.push(50 + z * 10);
      }
      handleDataReceived({
        values: sampleData,
        column: 'Sample Data',
        n: sampleData.length
      });
    }

    function sendMessageToParent(message) {
      if (typeof Office !== 'undefined' && Office.context && Office.context.ui) {
        Office.context.ui.messageParent(JSON.stringify(message));
      }
    }
  </script>
</body>
</html>
