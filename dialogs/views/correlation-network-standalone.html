<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Correlation Network - Statistico</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <!-- Office.js -->
  <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
  
  <!-- Font Awesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet"/>
  
  <!-- D3.js for network visualization -->
  <script src="https://d3js.org/d3.v7.min.js"></script>
  
  <!-- Shared Header -->
  <link rel="stylesheet" href="shared-header.css">
  <script src="shared-header.js"></script>
  
  <style>
    :root {
      --surface-0: #0c1624;
      --surface-1: #1a1f2e;
      --surface-2: #242938;
      --border: #6b7280;
      --accent-1: rgb(255,165,120);
      --accent-2: rgb(120,200,255);
      --text-primary: #fff;
      --text-secondary: rgba(255,255,255,0.8);
      --text-muted: rgba(255,255,255,0.6);
    }

    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%;overflow:hidden}
    body{
      background:var(--surface-0);
      color:var(--text-primary);
      font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;
      margin:0;
      display:flex;
      flex-direction:column;
    }

    .results-container{
      flex:1;
      display:flex;
      flex-direction:column;
      overflow:hidden;
    }

    .controls{
      display:flex;
      gap:20px;
      padding:15px 20px;
      background:var(--surface-2);
      border-bottom:1px solid var(--border);
      align-items:center;
      flex-wrap:wrap;
    }

    .control-group{
      display:flex;
      align-items:center;
      gap:10px;
    }

    .control-label{
      font-size:12px;
      font-weight:600;
      color:var(--text-secondary);
      white-space:nowrap;
    }

    .threshold-value{
      font-size:14px;
      font-weight:700;
      color:var(--accent-1);
      min-width:45px;
      text-align:center;
    }

    input[type="range"]{
      width:180px;
      height:6px;
      border-radius:3px;
      background:linear-gradient(90deg, var(--surface-0) 0%, var(--accent-1) 100%);
      outline:none;
      -webkit-appearance:none;
    }

    input[type="range"]::-webkit-slider-thumb{
      -webkit-appearance:none;
      width:18px;
      height:18px;
      border-radius:50%;
      background:linear-gradient(135deg, var(--accent-1), var(--accent-2));
      cursor:pointer;
      border:2px solid var(--surface-0);
      box-shadow:0 2px 6px rgba(0,0,0,0.3);
      transition:transform .2s;
    }

    input[type="range"]::-webkit-slider-thumb:hover{
      transform:scale(1.15);
    }

    input[type="range"]::-moz-range-thumb{
      width:18px;
      height:18px;
      border-radius:50%;
      background:linear-gradient(135deg, var(--accent-1), var(--accent-2));
      cursor:pointer;
      border:2px solid var(--surface-0);
      box-shadow:0 2px 6px rgba(0,0,0,0.3);
    }

    .checkbox-label{
      display:flex;
      align-items:center;
      gap:8px;
      cursor:pointer;
      font-size:13px;
      font-weight:500;
      color:var(--text-secondary);
      padding:6px 12px;
      border-radius:6px;
      transition:all .2s;
    }

    .checkbox-label:hover{
      background:rgba(255,165,120,0.1);
    }

    .checkbox-label input[type="checkbox"]{
      width:18px;
      height:18px;
      cursor:pointer;
      accent-color:var(--accent-1);
    }

    .checkbox-label:has(input:checked){
      color:var(--accent-1);
    }

    .network-container{
      flex:1;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:20px;
      overflow:hidden;
    }

    #networkSVG{
      width:100%;
      height:100%;
      background:var(--surface-1);
      border-radius:8px;
      border:1px solid var(--border);
    }

    #loadingMessage{
      text-align:center;
      padding:40px;
      color:var(--text-secondary);
      font-size:16px;
    }

    .loading-spinner{
      display:inline-block;
      width:40px;
      height:40px;
      border:4px solid rgba(255,165,120,0.3);
      border-top-color:var(--accent-1);
      border-radius:50%;
      animation:spin 1s linear infinite;
      margin:20px auto;
    }

    @keyframes spin{
      to{transform:rotate(360deg)}
    }

    /* Network link styles */
    .network-link{
      stroke-opacity:0.6;
      transition:stroke-opacity 0.2s;
    }

    .network-link:hover{
      stroke-opacity:1;
    }

    .network-link.dimmed{
      stroke-opacity:0.1;
    }

    /* Network node styles */
    .network-node{
      cursor:pointer;
      transition:all 0.2s;
    }

    .network-node:hover{
      filter:brightness(1.3);
    }

    .network-label{
      font-size:12px;
      font-weight:600;
      fill:var(--text-primary);
      pointer-events:none;
      text-anchor:middle;
      user-select:none;
    }

    .network-corr-label{
      font-size:10px;
      fill:var(--text-secondary);
      pointer-events:none;
      text-anchor:middle;
    }
  </style>
</head>
<body>
  
  <!-- Shared Header will be inserted here by JavaScript -->

  <div class="results-container">
    <div class="controls">
      <div class="control-group">
        <span class="control-label">Highlight r â‰¥</span>
        <input type="range" id="thresholdSlider" min="0" max="1" step="0.05" value="0" oninput="updateThreshold(this.value)">
        <span class="threshold-value" id="thresholdValue">0.00</span>
      </div>

      <div class="control-group">
        <label class="checkbox-label">
          <input type="checkbox" id="showCorrValues" checked onchange="toggleCorrValues()">
          <span>Show r</span>
        </label>
      </div>
    </div>

    <div id="loadingMessage">
      <div class="loading-spinner"></div>
      <p>Loading correlation network...</p>
    </div>

    <div class="network-container" id="networkContainer" style="display:none;">
      <svg id="networkSVG"></svg>
    </div>
  </div>

  <script>
    let correlationData = null;
    let currentThreshold = 0;
    let showCorr = true;
    let simulation = null;

    // Initialize Office.js
    Office.onReady(function(info) {
      console.log('Office initialized in correlation network dialog', info);
      
      // Initialize shared header
      if (typeof StatisticoHeader !== 'undefined') {
        StatisticoHeader.init('correlation-network', 'Correlation Network', 0);
      }
      
      // Listen for messages from parent
      Office.context.ui.addHandlerAsync(
        Office.EventType.DialogParentMessageReceived,
        onMessageFromParent
      );
      
      // Notify parent that dialog is ready
      Office.context.ui.messageParent(JSON.stringify({
        action: 'ready'
      }));
    });

    function onMessageFromParent(arg) {
      try {
        const message = JSON.parse(arg.message);
        console.log('ðŸ“¨ Received message from parent:', message);
        
        if (message.type === 'CORRELATION_DATA') {
          correlationData = message.payload;
          console.log('âœ… Correlation data received:', correlationData);
          renderNetwork();
        }
      } catch (e) {
        console.error('Error processing message:', e);
      }
    }

    function renderNetwork() {
      if (!correlationData || !correlationData.headers || !correlationData.data) {
        console.error('Invalid correlation data');
        return;
      }

      const headers = correlationData.headers;
      const data = correlationData.data;

      // Update header with variable info
      if (typeof StatisticoHeader !== 'undefined') {
        const varCount = headers.length;
        const varList = headers.slice(0, 3).join(', ') + (headers.length > 3 ? '...' : '');
        StatisticoHeader.updateVariable(`${varCount} Variables: ${varList}`, data.length);
      }

      // Hide loading, show network
      document.getElementById('loadingMessage').style.display = 'none';
      document.getElementById('networkContainer').style.display = 'flex';

      // Calculate correlation matrix
      const matrix = calculateCorrelationMatrix(data, headers);

      // Draw network
      drawNetwork(headers, matrix);
    }

    function calculateCorrelationMatrix(data, headers) {
      const n = headers.length;
      const matrix = [];

      for (let i = 0; i < n; i++) {
        matrix[i] = [];
        for (let j = 0; j < n; j++) {
          if (i === j) {
            matrix[i][j] = 1.000;
          } else {
            const result = calculatePearson(data, headers[i], headers[j]);
            matrix[i][j] = result.r;
          }
        }
      }

      return matrix;
    }

    function calculatePearson(data, var1, var2) {
      const pairs = [];
      data.forEach(row => {
        const x = row[var1];
        const y = row[var2];
        if (typeof x === 'number' && typeof y === 'number' && !isNaN(x) && !isNaN(y)) {
          pairs.push([x, y]);
        }
      });

      if (pairs.length < 2) {
        return { r: null, n: 0 };
      }

      const xValues = pairs.map(p => p[0]);
      const yValues = pairs.map(p => p[1]);
      const n = pairs.length;

      const sumX = xValues.reduce((a, b) => a + b, 0);
      const sumY = yValues.reduce((a, b) => a + b, 0);
      const sumXY = xValues.reduce((sum, x, i) => sum + x * yValues[i], 0);
      const sumX2 = xValues.reduce((sum, x) => sum + x * x, 0);
      const sumY2 = yValues.reduce((sum, y) => sum + y * y, 0);

      const numerator = n * sumXY - sumX * sumY;
      const denominator = Math.sqrt((n * sumX2 - sumX * sumX) * (n * sumY2 - sumY * sumY));

      if (denominator === 0) return { r: null, n: n };

      return { r: numerator / denominator, n: n };
    }

    function drawNetwork(varNames, corrMatrix) {
      const svg = d3.select("#networkSVG");
      svg.selectAll("*").remove();

      const container = document.getElementById('networkSVG');
      const width = container.clientWidth;
      const height = container.clientHeight;

      // Create nodes
      const nodes = varNames.map((name, i) => ({ 
        id: name, 
        index: i,
        x: width / 2,
        y: height / 2
      }));

      // Create links (only for correlations above a minimum threshold to avoid clutter)
      const links = [];
      for (let i = 0; i < varNames.length; i++) {
        for (let j = i + 1; j < varNames.length; j++) {
          const value = corrMatrix[i][j];
          if (value !== null && !isNaN(value) && Math.abs(value) >= 0.3) {
            links.push({
              source: varNames[i],
              target: varNames[j],
              value: value
            });
          }
        }
      }

      console.log(`ðŸ“Š Network: ${nodes.length} nodes, ${links.length} links`);

      // Create force simulation
      simulation = d3.forceSimulation(nodes)
        .force("link", d3.forceLink(links).id(d => d.id).distance(d => 150 * (1 - Math.abs(d.value))))
        .force("charge", d3.forceManyBody().strength(-500))
        .force("center", d3.forceCenter(width / 2, height / 2))
        .force("collision", d3.forceCollide().radius(40));

      // Create SVG elements
      const g = svg.append("g");

      // Add zoom behavior
      const zoom = d3.zoom()
        .scaleExtent([0.5, 3])
        .on("zoom", (event) => {
          g.attr("transform", event.transform);
        });
      
      svg.call(zoom);

      // Draw links
      const link = g.append("g")
        .selectAll("line")
        .data(links)
        .enter().append("line")
        .attr("class", "network-link")
        .attr("stroke", d => d.value > 0 ? "var(--accent-2)" : "var(--accent-1)")
        .attr("stroke-width", d => Math.abs(d.value) * 5)
        .attr("data-value", d => Math.abs(d.value));

      // Draw correlation value labels on links
      const linkLabels = g.append("g")
        .selectAll("text")
        .data(links)
        .enter().append("text")
        .attr("class", "network-corr-label")
        .text(d => d.value.toFixed(2))
        .style("display", showCorr ? "block" : "none");

      // Draw nodes
      const node = g.append("g")
        .selectAll("circle")
        .data(nodes)
        .enter().append("circle")
        .attr("class", "network-node")
        .attr("r", 20)
        .attr("fill", "var(--accent-1)")
        .call(d3.drag()
          .on("start", dragstarted)
          .on("drag", dragged)
          .on("end", dragended));

      // Draw node labels
      const labels = g.append("g")
        .selectAll("text")
        .data(nodes)
        .enter().append("text")
        .attr("class", "network-label")
        .text(d => d.id)
        .attr("dy", 35);

      // Update positions on tick
      simulation.on("tick", () => {
        link
          .attr("x1", d => d.source.x)
          .attr("y1", d => d.source.y)
          .attr("x2", d => d.target.x)
          .attr("y2", d => d.target.y);

        linkLabels
          .attr("x", d => (d.source.x + d.target.x) / 2)
          .attr("y", d => (d.source.y + d.target.y) / 2);

        node
          .attr("cx", d => d.x)
          .attr("cy", d => d.y);

        labels
          .attr("x", d => d.x)
          .attr("y", d => d.y);
      });

      // Store references for threshold updates
      window.networkElements = { link, linkLabels };
      
      // Apply initial threshold
      applyThresholdHighlight(currentThreshold);
    }

    function dragstarted(event, d) {
      if (!event.active) simulation.alphaTarget(0.3).restart();
      d.fx = d.x;
      d.fy = d.y;
    }

    function dragged(event, d) {
      d.fx = event.x;
      d.fy = event.y;
    }

    function dragended(event, d) {
      if (!event.active) simulation.alphaTarget(0);
      d.fx = null;
      d.fy = null;
    }

    function updateThreshold(value) {
      currentThreshold = parseFloat(value);
      document.getElementById('thresholdValue').textContent = value;
      applyThresholdHighlight(currentThreshold);
      updateSliderBackground(currentThreshold);
    }

    function applyThresholdHighlight(threshold) {
      if (!window.networkElements) return;
      
      const { link, linkLabels } = window.networkElements;
      
      link.classed("dimmed", d => Math.abs(d.value) < threshold);
      linkLabels.classed("dimmed", d => Math.abs(d.value) < threshold);
    }

    function toggleCorrValues() {
      showCorr = document.getElementById('showCorrValues').checked;
      if (window.networkElements) {
        window.networkElements.linkLabels.style("display", showCorr ? "block" : "none");
      }
    }

    function updateSliderBackground(value) {
      const slider = document.getElementById('thresholdSlider');
      if (slider) {
        const percentage = (value / slider.max) * 100;
        slider.style.background = `linear-gradient(to right, var(--accent-1) ${percentage}%, var(--surface-0) ${percentage}%)`;
      }
    }

    function closeDialog() {
      Office.context.ui.messageParent(JSON.stringify({
        action: 'close'
      }));
    }

    console.log('âœ… Correlation Network view script loaded');
  </script>
</body>
</html>
