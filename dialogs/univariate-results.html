<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Univariate Analysis Results</title>
  
  <!-- Office.js -->
  <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
  
  <!-- Font Awesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet" />
  
  <!-- Highcharts for Histogram -->
  <script src="https://code.highcharts.com/highcharts.js"></script>
  <script src="https://code.highcharts.com/modules/histogram-bellcurve.js"></script>
  
  <style>
    :root {
      --surface-0: #ffffff;
      --surface-1: #f8f9fa;
      --surface-2: #f1f3f5;
      --border: #e9ecef;
      --accent-1: #f97316;
      --accent-2: #3b82f6;
      --text-primary: #1e293b;
      --text-secondary: #475569;
      --text-muted: #94a3b8;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--surface-0);
      color: var(--text-primary);
      font-size: 13px;
    }

    /* Header */
    .header {
      background: var(--surface-1);
      border-bottom: 1px solid var(--border);
      padding: 16px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header h1 {
      font-size: 20px;
      font-weight: 700;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .header-controls {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .dropdown-btn {
      padding: 8px 16px;
      background: var(--surface-0);
      border: 1.5px solid var(--border);
      border-radius: 6px;
      color: var(--text-primary);
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.2s;
    }

    .dropdown-btn:hover {
      border-color: var(--accent-1);
      box-shadow: 0 2px 4px rgba(249, 115, 22, 0.1);
    }

    .dropdown-content {
      position: absolute;
      top: calc(100% + 8px);
      right: 0;
      background: var(--surface-0);
      border: 1.5px solid var(--border);
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      min-width: 250px;
      display: none;
      z-index: 1000;
    }

    .dropdown-content.show { display: block; }

    .analysis-option {
      padding: 12px 16px;
      cursor: pointer;
      transition: background 0.2s;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .analysis-option:hover {
      background: var(--surface-1);
    }

    .analysis-option.active {
      background: var(--surface-1);
      color: var(--accent-1);
      font-weight: 600;
    }

    .close-btn {
      padding: 8px 16px;
      background: var(--surface-0);
      border: 1.5px solid var(--border);
      border-radius: 6px;
      color: var(--text-secondary);
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      transition: all 0.2s;
    }

    .close-btn:hover {
      border-color: #dc2626;
      color: #dc2626;
    }

    /* Content */
    .content {
      padding: 20px;
      max-width: 1200px;
      margin: 0 auto;
    }

    /* Statistics Panel */
    .stats-panel {
      background: var(--surface-0);
      border: 1.5px solid var(--border);
      border-radius: 8px;
      margin-bottom: 20px;
      overflow: hidden;
    }

    .panel-heading {
      background: var(--surface-1);
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: 600;
      font-size: 15px;
    }

    .stats-table {
      width: 100%;
      border-collapse: collapse;
    }

    .stats-table th {
      background: var(--surface-1);
      padding: 10px;
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
      border-bottom: 1px solid var(--border);
    }

    .stats-table th.highlight {
      background: rgba(249, 115, 22, 0.1);
      color: var(--accent-1);
      font-weight: 700;
    }

    .stats-table td {
      padding: 12px;
      text-align: center;
      font-size: 13px;
      border-bottom: 1px solid var(--border);
    }

    .stats-table td.highlight {
      background: rgba(249, 115, 22, 0.05);
      color: var(--accent-1);
      font-weight: 700;
      font-size: 15px;
    }

    .stats-table tr:last-child td {
      border-bottom: none;
    }

    /* Histogram Panel */
    .histogram-panel {
      background: var(--surface-0);
      border: 1.5px solid var(--border);
      border-radius: 8px;
      overflow: hidden;
    }

    .histogram-controls {
      padding: 12px 16px;
      background: var(--surface-1);
      border-bottom: 1px solid var(--border);
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
      align-items: center;
      font-size: 12px;
    }

    .control-group {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .control-group label {
      font-weight: 600;
      color: var(--text-secondary);
    }

    .control-group select {
      padding: 6px 10px;
      border: 1px solid var(--border);
      border-radius: 4px;
      font-size: 12px;
      background: var(--surface-0);
    }

    .control-group input[type="range"] {
      width: 100px;
    }

    .control-group input[type="checkbox"] {
      width: 16px;
      height: 16px;
      accent-color: var(--accent-1);
    }

    #histogram-chart {
      padding: 16px;
      min-height: 400px;
    }

    /* Loading */
    .loading {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-muted);
    }

    .spinner {
      border: 3px solid var(--border);
      border-top: 3px solid var(--accent-1);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 0.8s linear infinite;
      margin: 0 auto 16px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <div class="header">
    <h1>
      <i class="fa-solid fa-chart-simple"></i>
      <span id="pageTitle">Interactive Histogram</span>
    </h1>
    <div style="font-size: 16px; color: var(--text-secondary); font-weight: 500;">
      <span id="variableName">Variable</span> <span id="sampleSize">(n=--)</span>
    </div>
    <div class="header-controls">
      <div style="position: relative;">
        <button class="dropdown-btn" onclick="toggleDropdown()">
          <i class="fa-solid fa-bars"></i>
          Analysis Views
          <i class="fa-solid fa-chevron-down"></i>
        </button>
        <div class="dropdown-content" id="dropdownMenu">
          <div class="analysis-option active" onclick="showView('histogram')">
            <i class="fa-solid fa-chart-column"></i>
            Histogram & Stats
          </div>
          <div class="analysis-option" onclick="showView('boxplot')">
            <i class="fa-solid fa-box"></i>
            Box Plot
          </div>
          <div class="analysis-option" onclick="showView('qqplot')">
            <i class="fa-solid fa-chart-scatter"></i>
            Q-Q Plot
          </div>
        </div>
      </div>
      <button class="close-btn" onclick="closeDialog()">
        <i class="fa-solid fa-times"></i> Close
      </button>
    </div>
  </div>

  <!-- Content -->
  <div class="content" id="resultsContent">
    <div class="loading">
      <div class="spinner"></div>
      <div>Loading results...</div>
    </div>
  </div>

  <script>
    let resultsData = null;
    let histogramChart = null;
    let currentData = [];

    // Load results when page is ready
    if (typeof Office !== 'undefined') {
      Office.onReady(() => {
        loadResults();
      });
    } else {
      // Fallback if Office.js not available
      window.addEventListener('DOMContentLoaded', () => {
        loadResults();
      });
    }

    function loadResults() {
      const dataJSON = localStorage.getItem('univariateResults');
      if (dataJSON) {
        resultsData = JSON.parse(dataJSON);
        displayHistogramView();
      } else {
        document.getElementById('resultsContent').innerHTML = `
          <div class="loading">
            <i class="fa-solid fa-exclamation-triangle" style="font-size: 40px; color: #dc2626; margin-bottom: 16px;"></i>
            <div style="color: #dc2626;">No results data found</div>
          </div>
        `;
      }
    }

    function displayHistogramView() {
      const { descriptive, n, column, dataSource } = resultsData;
      
      // Update header with variable info
      document.getElementById('variableName').textContent = column || 'Variable';
      document.getElementById('sampleSize').textContent = `(n=${n})`;
      
      document.getElementById('resultsContent').innerHTML = `
        <!-- Statistics Panel -->
        <div class="stats-panel">
          <div class="panel-heading">
            <span>Descriptive Statistics</span>
            <span style="font-size: 12px; color: var(--text-muted);">n = ${n}</span>
          </div>
          <div style="padding: 12px;">
            <!-- Table 1: Central Tendency -->
            <table class="stats-table" style="margin-bottom: 12px;">
              <thead>
                <tr>
                  <th class="highlight">Count</th>
                  <th class="highlight">Mean</th>
                  <th class="highlight">Std Dev</th>
                  <th>Variance</th>
                  <th>Kurtosis</th>
                  <th>Skewness</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td class="highlight">${n}</td>
                  <td class="highlight">${descriptive.mean}</td>
                  <td class="highlight">${descriptive.stdDev}</td>
                  <td>${descriptive.variance}</td>
                  <td>${descriptive.kurtosis}</td>
                  <td>${descriptive.skewness}</td>
                </tr>
              </tbody>
            </table>

            <!-- Table 2: Range & Quartiles -->
            <table class="stats-table">
              <thead>
                <tr>
                  <th>Range</th>
                  <th>Minimum</th>
                  <th>Q25</th>
                  <th class="highlight">Median</th>
                  <th>Q75</th>
                  <th>Maximum</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>${descriptive.range}</td>
                  <td>${descriptive.min}</td>
                  <td>${descriptive.q1}</td>
                  <td class="highlight">${descriptive.median}</td>
                  <td>${descriptive.q3}</td>
                  <td>${descriptive.max}</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Histogram Panel -->
        <div class="histogram-panel">
          <div class="panel-heading">
            Interactive Histogram
          </div>
          <div class="histogram-controls">
            <div class="control-group">
              <label>Bins:</label>
              <input type="range" id="numBins" min="5" max="50" value="15" oninput="updateHistogram()">
              <span id="binsValue">15</span>
            </div>
            <div class="control-group">
              <label>Normal Curve:</label>
              <input type="checkbox" id="showNormal" checked onchange="updateHistogram()">
            </div>
          </div>
          <div id="histogram-chart"></div>
        </div>
      `;

      createHistogram();
    }

    function createHistogram() {
      // For now, create a simple chart - in real implementation, use actual data
      Highcharts.chart('histogram-chart', {
        chart: { type: 'column', backgroundColor: 'transparent' },
        title: { text: null },
        xAxis: { title: { text: 'Value' } },
        yAxis: { title: { text: 'Frequency' } },
        legend: { enabled: false },
        series: [{
          name: 'Frequency',
          data: [2, 5, 8, 15, 20, 18, 12, 8, 5, 2],
          color: '#3b82f6'
        }],
        credits: { enabled: false }
      });
    }

    function updateHistogram() {
      const bins = document.getElementById('numBins').value;
      document.getElementById('binsValue').textContent = bins;
      // Update chart with new bins
      createHistogram();
    }

    function showView(viewName) {
      // Update active state
      document.querySelectorAll('.analysis-option').forEach(opt => opt.classList.remove('active'));
      event.target.closest('.analysis-option').classList.add('active');
      
      // Close dropdown
      document.getElementById('dropdownMenu').classList.remove('show');
      
      // Show view (for now just histogram)
      if (viewName === 'histogram') {
        displayHistogramView();
      } else {
        document.getElementById('resultsContent').innerHTML = `
          <div style="text-align: center; padding: 60px 20px; color: var(--text-muted);">
            <i class="fa-solid fa-info-circle" style="font-size: 48px; margin-bottom: 16px;"></i>
            <div>${viewName} view coming soon!</div>
          </div>
        `;
      }
    }

    function toggleDropdown() {
      document.getElementById('dropdownMenu').classList.toggle('show');
    }

    function closeDialog() {
      try {
        if (typeof Office !== 'undefined' && Office.context && Office.context.ui) {
          Office.context.ui.messageParent('close');
        }
      } catch (e) {
        console.log('Could not message parent:', e);
      }
      window.close();
    }

    // Close dropdown when clicking outside
    document.addEventListener('click', (e) => {
      const dropdown = document.getElementById('dropdownMenu');
      if (dropdown && !e.target.closest('.dropdown-btn') && !e.target.closest('.dropdown-content')) {
        dropdown.classList.remove('show');
      }
    });
  </script>
</body>
</html>
