<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Univariate Analysis Results</title>
  
  <!-- Office.js -->
  <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
  
  <!-- Font Awesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet" />
  
  <!-- Highcharts for Histogram -->
  <script src="https://code.highcharts.com/highcharts.js"></script>
  <script src="https://code.highcharts.com/modules/histogram-bellcurve.js"></script>
  
  <style>
    :root {
      --surface-0: #ffffff;
      --surface-1: #f8f9fa;
      --surface-2: #f1f3f5;
      --border: #e9ecef;
      --accent-1: #f97316;
      --accent-2: #3b82f6;
      --text-primary: #1e293b;
      --text-secondary: #475569;
      --text-muted: #94a3b8;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--surface-0);
      color: var(--text-primary);
      font-size: 13px;
    }

    /* Header - 3 parts layout */
    .header {
      background: var(--surface-1);
      border-bottom: 1px solid var(--border);
      padding: 16px 20px;
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      align-items: center;
      gap: 20px;
    }

    /* Part 1: Logo + Module */
    .header-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .header-logo {
      width: 36px;
      height: 36px;
      background: linear-gradient(135deg, var(--accent-1), var(--accent-2));
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 18px;
    }

    .header-module {
      display: flex;
      flex-direction: column;
    }

    .header-brand {
      font-size: 11px;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .header-module-name {
      font-size: 15px;
      font-weight: 700;
      color: var(--text-primary);
    }

    /* Part 2: Center - View Name + Variable */
    .header-center {
      text-align: center;
    }

    .header-view-name {
      font-size: 18px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 4px;
    }

    .header-variable {
      font-size: 14px;
      font-style: italic;
      color: var(--text-secondary);
    }

    /* Part 3: Right - Dropdown */
    .header-right {
      display: flex;
      justify-content: flex-end;
      align-items: center;
      gap: 12px;
    }

    .dropdown-btn {
      padding: 8px 16px;
      background: var(--surface-0);
      border: 1.5px solid var(--border);
      border-radius: 6px;
      color: var(--text-primary);
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.2s;
    }

    .dropdown-btn:hover {
      border-color: var(--accent-1);
      box-shadow: 0 2px 4px rgba(249, 115, 22, 0.1);
    }

    .dropdown-content {
      position: absolute;
      top: calc(100% + 8px);
      right: 0;
      background: var(--surface-0);
      border: 1.5px solid var(--border);
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      min-width: 250px;
      display: none;
      z-index: 1000;
    }

    .dropdown-content.show { display: block; }

    .analysis-option {
      padding: 12px 16px;
      cursor: pointer;
      transition: background 0.2s;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .analysis-option:hover {
      background: var(--surface-1);
    }

    .analysis-option.active {
      background: var(--surface-1);
      color: var(--accent-1);
      font-weight: 600;
    }

    .close-btn {
      padding: 8px 16px;
      background: var(--surface-0);
      border: 1.5px solid var(--border);
      border-radius: 6px;
      color: var(--text-secondary);
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      transition: all 0.2s;
    }

    .close-btn:hover {
      border-color: #dc2626;
      color: #dc2626;
    }

    /* Content */
    .content {
      padding: 20px;
      max-width: 1200px;
      margin: 0 auto;
    }

    /* Statistics Panel */
    .stats-panel {
      background: var(--surface-0);
      border: 1.5px solid var(--border);
      border-radius: 8px;
      margin-bottom: 20px;
      overflow: hidden;
    }

    .panel-heading {
      background: var(--surface-1);
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: 600;
      font-size: 15px;
    }

    .stats-table {
      width: 100%;
      border-collapse: collapse;
    }

    .stats-table th {
      background: var(--surface-1);
      padding: 10px;
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
      border-bottom: 1px solid var(--border);
    }

    .stats-table th.highlight {
      background: rgba(249, 115, 22, 0.1);
      color: var(--accent-1);
      font-weight: 700;
    }

    .stats-table td {
      padding: 12px;
      text-align: center;
      font-size: 13px;
      border-bottom: 1px solid var(--border);
    }

    .stats-table td.highlight {
      background: rgba(249, 115, 22, 0.05);
      color: var(--accent-1);
      font-weight: 700;
      font-size: 15px;
    }

    .stats-table tr:last-child td {
      border-bottom: none;
    }

    /* Histogram Panel */
    .histogram-panel {
      background: var(--surface-0);
      border: 1.5px solid var(--border);
      border-radius: 8px;
      overflow: hidden;
    }

    .histogram-controls {
      padding: 12px 16px;
      background: var(--surface-1);
      border-bottom: 1px solid var(--border);
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
      align-items: center;
      font-size: 12px;
    }

    .control-group {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .control-group label {
      font-weight: 600;
      color: var(--text-secondary);
    }

    .control-group select {
      padding: 6px 10px;
      border: 1px solid var(--border);
      border-radius: 4px;
      font-size: 12px;
      background: var(--surface-0);
    }

    .control-group input[type="range"] {
      width: 100px;
    }

    .control-group input[type="checkbox"] {
      width: 16px;
      height: 16px;
      accent-color: var(--accent-1);
    }

    .value-display {
      min-width: 40px;
      text-align: center;
      font-weight: 600;
      color: var(--text-primary);
      font-size: 12px;
    }

    /* Range Controls for Data Cropping */
    .range-controls {
      padding: 16px;
      background: var(--surface-1);
      border-top: 1px solid var(--border);
    }

    .range-slider-row {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 12px;
      color: var(--text-secondary);
      font-weight: 600;
    }

    .slider-container {
      position: relative;
      flex: 1;
      height: 30px;
      display: flex;
      align-items: center;
    }

    .slider-track {
      position: absolute;
      width: 100%;
      height: 6px;
      background: var(--surface-2);
      border-radius: 3px;
      pointer-events: none;
    }

    .active-range {
      position: absolute;
      height: 6px;
      background: var(--accent-1);
      border-radius: 3px;
      pointer-events: none;
      left: 0%;
      width: 100%;
      z-index: 0;
    }

    .slider-container input[type="range"] {
      position: absolute;
      width: 100%;
      background: transparent;
      pointer-events: all;
      -webkit-appearance: none;
      appearance: none;
      margin: 0;
    }

    .slider-container input[type="range"]::-webkit-slider-runnable-track {
      height: 6px;
      background: transparent;
      border-radius: 3px;
    }

    .slider-container input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: var(--accent-2);
      cursor: pointer;
      border: 3px solid white;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      margin-top: -6px;
    }

    .slider-container input[type="range"]::-moz-range-track {
      height: 6px;
      background: transparent;
      border-radius: 3px;
    }

    .slider-container input[type="range"]::-moz-range-thumb {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: var(--accent-2);
      cursor: pointer;
      border: 3px solid white;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }

    /* Remove z-index from CSS - will be set inline in HTML */

    .reset-button {
      background: var(--surface-0);
      color: var(--text-secondary);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 4px 12px;
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .reset-button:hover {
      border-color: var(--accent-1);
      color: var(--accent-1);
      background: var(--surface-2);
    }

    .range-display {
      margin-top: 8px;
      text-align: center;
    }

    #histogram-chart {
      padding: 16px;
      min-height: 400px;
    }

    /* Loading */
    .loading {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-muted);
    }

    .spinner {
      border: 3px solid var(--border);
      border-top: 3px solid var(--accent-1);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 0.8s linear infinite;
      margin: 0 auto 16px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Floating Close Button */
    .close-btn-floating {
      position: fixed;
      bottom: 24px;
      right: 24px;
      width: 54px;
      height: 54px;
      background: #dc2626;
      color: white;
      border: none;
      border-radius: 50%;
      font-size: 22px;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .close-btn-floating:hover {
      background: #b91c1c;
      box-shadow: 0 6px 16px rgba(220, 38, 38, 0.4);
      transform: scale(1.08);
    }

    .close-btn-floating:active {
      transform: scale(0.95);
    }
  </style>
</head>
<body>
  <!-- Header - 3 Parts -->
  <div class="header">
    <!-- Part 1: Logo + Module Name -->
    <div class="header-left">
      <div class="header-logo">
        <i class="fa-solid fa-chart-line"></i>
      </div>
      <div class="header-module">
        <div class="header-brand">Statistico Analytics</div>
        <div class="header-module-name">Univariate Analysis</div>
      </div>
    </div>

    <!-- Part 2: Center - View Name + Variable -->
    <div class="header-center">
      <div class="header-view-name" id="viewName">Interactive Histogram</div>
      <div class="header-variable">
        <span id="variableName">Variable</span> <span id="sampleSize">(n=--)</span>
      </div>
    </div>

    <!-- Part 3: Right - Dropdown -->
    <div class="header-right">
      <div style="position: relative;">
        <button class="dropdown-btn" onclick="toggleDropdown()">
          <i class="fa-solid fa-bars"></i>
          Advanced Results
          <i class="fa-solid fa-chevron-down"></i>
        </button>
        <div class="dropdown-content" id="dropdownMenu">
          <div class="analysis-option active" onclick="showView('histogram')">
            <i class="fa-solid fa-chart-column"></i>
            Histogram & Stats
          </div>
          <div class="analysis-option" onclick="showView('boxplot')">
            <i class="fa-solid fa-box"></i>
            Box Plot
          </div>
          <div class="analysis-option" onclick="showView('qqplot')">
            <i class="fa-solid fa-chart-scatter"></i>
            Q-Q Plot
          </div>
          <div class="analysis-option" onclick="showView('normality')">
            <i class="fa-solid fa-vial"></i>
            Normality Tests
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Content -->
  <div class="content" id="resultsContent">
    <div class="loading">
      <div class="spinner"></div>
      <div>Loading results...</div>
    </div>
  </div>

  <script>
    let resultsData = null;
    let histogramChart = null;
    let currentData = [];

    // Load results when page is ready
    if (typeof Office !== 'undefined') {
      Office.onReady(() => {
        loadResults();
      });
    } else {
      // Fallback if Office.js not available
      window.addEventListener('DOMContentLoaded', () => {
        loadResults();
      });
    }

    function loadResults() {
      const dataJSON = localStorage.getItem('univariateResults');
      if (dataJSON) {
        resultsData = JSON.parse(dataJSON);
        displayHistogramView();
      } else {
        document.getElementById('resultsContent').innerHTML = `
          <div class="loading">
            <i class="fa-solid fa-exclamation-triangle" style="font-size: 40px; color: #dc2626; margin-bottom: 16px;"></i>
            <div style="color: #dc2626;">No results data found</div>
          </div>
        `;
      }
    }

    function displayHistogramView() {
      const { descriptive, n, column, dataSource } = resultsData;
      
      // Update header with variable info
      document.getElementById('variableName').textContent = column || 'Variable';
      document.getElementById('sampleSize').textContent = `(n=${n})`;
      
      document.getElementById('resultsContent').innerHTML = `
        <!-- Statistics Panel -->
        <div class="stats-panel">
          <div class="panel-heading">
            <span>Descriptive Statistics</span>
            <span style="font-size: 12px; color: var(--text-muted);">n = ${n}</span>
          </div>
          <div style="padding: 12px;">
            <!-- Table 1: Central Tendency -->
            <table class="stats-table" style="margin-bottom: 12px;">
              <thead>
                <tr>
                  <th class="highlight">Count</th>
                  <th class="highlight">Mean</th>
                  <th class="highlight">Std Dev</th>
                  <th>Variance</th>
                  <th>Kurtosis</th>
                  <th>Skewness</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td class="highlight">${n}</td>
                  <td class="highlight">${descriptive.mean}</td>
                  <td class="highlight">${descriptive.stdDev}</td>
                  <td>${descriptive.variance}</td>
                  <td>${descriptive.kurtosis}</td>
                  <td>${descriptive.skewness}</td>
                </tr>
              </tbody>
            </table>

            <!-- Table 2: Range & Quartiles -->
            <table class="stats-table">
              <thead>
                <tr>
                  <th>Range</th>
                  <th>Minimum</th>
                  <th>Q25</th>
                  <th class="highlight">Median</th>
                  <th>Q75</th>
                  <th>Maximum</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>${descriptive.range}</td>
                  <td>${descriptive.min}</td>
                  <td>${descriptive.q1}</td>
                  <td class="highlight">${descriptive.median}</td>
                  <td>${descriptive.q3}</td>
                  <td>${descriptive.max}</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Histogram Panel -->
        <div class="histogram-panel">
          <div class="panel-heading">
            Interactive Histogram
          </div>
          <!-- Histogram Controls -->
          <div class="histogram-controls">
            <!-- Binning Method -->
            <div class="control-group">
              <label for="binningMethod">Method:</label>
              <select id="binningMethod" onchange="updateBinningMethod()">
                <option value="manual">Manual (User-defined)</option>
                <option value="sturges">Sturges (log₂)</option>
                <option value="scott">Scott (Normal optimal)</option>
                <option value="fd">Freedman-Diaconis (Robust)</option>
                <option value="sqrt">Square Root (√n)</option>
                <option value="rice">Rice (2n^(1/3))</option>
              </select>
              <i class="fa-solid fa-info-circle" style="color: var(--accent-2); cursor: help;" title="Binning Methods&#10;• Manual: Choose bins yourself&#10;• Sturges: Good for normal distributions&#10;• Scott: Optimal for minimizing error&#10;• Freedman-Diaconis: Robust to outliers"></i>
            </div>

            <!-- Bins Slider (Manual mode) -->
            <div class="control-group" id="manualBinsControl">
              <label for="numBins">Bins:</label>
              <span id="binsValue">15</span>
              <input type="range" id="numBins" min="5" max="50" value="15" step="1" oninput="updateHistogram()">
            </div>

            <!-- Normal Curve Toggle -->
            <div class="control-group">
              <label for="showNormalCurve">Normal:</label>
              <input type="checkbox" id="showNormalCurve" checked onchange="updateHistogram()">
            </div>
          </div>

          <!-- Histogram Chart -->
          <div id="histogram-chart"></div>

          <!-- Range Sliders for Cropping Data -->
          <div class="range-controls">
            <div class="range-slider-row">
              <span>Min</span>
              <span id="leftRangeValue" class="value-display">0</span>
              
              <!-- Dual Sliders -->
              <div class="slider-container">
                <div class="slider-track"></div>
                <div id="activeRangeIndicator" class="active-range"></div>
                <input type="range" id="leftTruncation" min="0" max="100" value="0" step="1" style="position: absolute; width: 100%; background: transparent; z-index: 2;">
                <input type="range" id="rightTruncation" min="0" max="100" value="100" step="1" style="position: absolute; width: 100%; background: transparent; z-index: 1;">
              </div>
              
              <span id="rightRangeValue" class="value-display">100</span>
              <span>Max</span>
              <button id="resetRanges" class="reset-button" onclick="resetRangeSliders()">Reset</button>
              <span style="margin-left: 10px; color: var(--text-muted); font-size: 12px;">n: <span id="remainingN">--</span></span>
            </div>
            
            <!-- Data Range Display -->
            <div class="range-display" style="display: flex; justify-content: center; gap: 20px; margin-top: 8px; font-size: 11px; color: var(--text-muted);">
              <span id="data-min-value">Min: --</span>
              <span id="data-max-value">Max: --</span>
            </div>
          </div>
        </div>
      `;

      // Wait for DOM to be ready before initializing
      setTimeout(() => {
        initializeRangeSliders();
        createHistogram();
      }, 100);
    }

    function createHistogram() {
      if (!resultsData || !resultsData.rawData) {
        console.error('No data available for histogram');
        return;
      }

      // Check if elements exist
      const numBinsEl = document.getElementById('numBins');
      const showNormalCurveEl = document.getElementById('showNormalCurve');
      const chartContainer = document.getElementById('histogram-chart');
      
      if (!numBinsEl || !showNormalCurveEl || !chartContainer) {
        console.error('Histogram elements not found in DOM');
        return;
      }

      // Use filtered data from range sliders
      const data = getFilteredData();
      if (data.length === 0) {
        console.error('No data after filtering');
        return;
      }

      const numBins = parseInt(numBinsEl.value);
      const showNormalCurve = showNormalCurveEl.checked;
      const totalCount = data.length;
      
      // Update remaining N display
      const remainingNEl = document.getElementById('remainingN');
      if (remainingNEl) remainingNEl.textContent = totalCount;
      
      // Calculate statistics for normal curve
      const mean = data.reduce((a, b) => a + b, 0) / data.length;
      const variance = data.reduce((acc, val) => acc + Math.pow(val - mean, 2), 0) / (data.length - 1);
      const stdDev = Math.sqrt(variance);
      const min = Math.min(...data);
      const max = Math.max(...data);
      
      // Create bins with ranges as categories
      const binWidth = (max - min) / numBins;
      
      // Handle edge case where all data points are the same
      if (binWidth === 0 || !isFinite(binWidth)) {
        console.warn('Data range is zero or invalid');
        return;
      }
      
      const counts = [];
      const categories = [];
      const binCenters = [];
      
      for (let i = 0; i < numBins; i++) {
        const binStart = min + i * binWidth;
        const binEnd = min + (i + 1) * binWidth;
        const binCenter = (binStart + binEnd) / 2;
        
        // Format bin range for x-axis (remove extra decimals)
        const startStr = binStart.toFixed(1);
        const endStr = binEnd.toFixed(1);
        categories.push(`${startStr}-\n${endStr}`);
        binCenters.push(binCenter);
        counts.push(0);
      }
      
      // Count data points in each bin
      data.forEach(value => {
        let binIndex = Math.floor((value - min) / binWidth);
        // Handle edge case for maximum value
        if (binIndex >= numBins) binIndex = numBins - 1;
        if (binIndex < 0) binIndex = 0;
        counts[binIndex]++;
      });
      
      // Create series array with dataLabels showing percentages
      const series = [{
        name: 'Frequency',
        type: 'column',
        data: counts,
        color: '#74b9ff',
        borderColor: '#0984e3',
        borderWidth: 1,
        dataLabels: {
          enabled: true,
          formatter: function() {
            const percentage = ((this.y / totalCount) * 100).toFixed(1);
            return `${percentage}%`;
          },
          style: {
            color: '#3b82f6',
            fontSize: '11px',
            fontWeight: '700',
            textOutline: 'none'
          },
          y: -5
        }
      }];
      
      // Add normal curve if checked (yellow dashed line)
      if (showNormalCurve && stdDev > 0) {
        const normalCurveData = [];
        const totalArea = totalCount * binWidth; // Total area of histogram
        
        for (let i = 0; i < categories.length; i++) {
          const x = binCenters[i];
          // Normal distribution PDF
          const z = (x - mean) / stdDev;
          const pdf = (1 / (stdDev * Math.sqrt(2 * Math.PI))) * Math.exp(-0.5 * z * z);
          const y = pdf * totalArea; // Scale to match histogram
          normalCurveData.push(y);
        }
        
        series.push({
          name: 'Normal Curve',
          type: 'line',
          data: normalCurveData,
          color: '#f1c40f',
          lineWidth: 3,
          dashStyle: 'Dash',
          marker: { enabled: false },
          enableMouseTracking: true
        });
      }
      
      // Create chart
      histogramChart = Highcharts.chart('histogram-chart', {
        chart: {
          backgroundColor: 'transparent',
          height: 400
        },
        title: { text: null },
        xAxis: {
          categories: categories,
          title: { 
            text: resultsData.column || 'Value',
            style: { color: '#475569', fontWeight: '600' }
          },
          labels: {
            style: {
              color: '#475569',
              fontSize: '10px'
            },
            rotation: -45,
            align: 'right'
          },
          gridLineWidth: 1,
          gridLineColor: '#e9ecef',
          lineColor: '#999'
        },
        yAxis: {
          title: { 
            text: 'Frequency',
            style: { color: '#475569', fontWeight: '600' }
          },
          gridLineColor: '#e9ecef',
          gridLineWidth: 1
        },
        legend: {
          enabled: false
        },
        tooltip: {
          enabled: false
        },
        plotOptions: {
          column: {
            pointPadding: 0,
            groupPadding: 0.1,
            borderWidth: 1
          }
        },
        series: series,
        credits: { enabled: false }
      });
    }

    function updateHistogram() {
      const bins = document.getElementById('numBins').value;
      document.getElementById('binsValue').textContent = bins;
      createHistogram();
    }

    // Binning method calculations
    function calculateBinsSturges(n) {
      return Math.max(1, Math.ceil(Math.log2(n) + 1));
    }

    function calculateBinsScott(data) {
      const n = data.length;
      if (n < 2) return 5;
      const mean = data.reduce((a, b) => a + b, 0) / n;
      const variance = data.reduce((acc, val) => acc + Math.pow(val - mean, 2), 0) / (n - 1);
      const stdDev = Math.sqrt(variance);
      if (stdDev === 0) return 5;
      const h = 3.5 * stdDev / Math.pow(n, 1/3);
      const range = Math.max(...data) - Math.min(...data);
      return Math.max(1, Math.ceil(range / h));
    }

    function calculateBinsFD(data) {
      const n = data.length;
      if (n < 2) return 5;
      const sorted = [...data].sort((a, b) => a - b);
      const q1Index = Math.floor(n * 0.25);
      const q3Index = Math.floor(n * 0.75);
      const q1 = sorted[q1Index];
      const q3 = sorted[q3Index];
      const iqr = q3 - q1;
      if (iqr === 0) return calculateBinsSturges(n);
      const h = 2 * iqr / Math.pow(n, 1/3);
      const range = sorted[n - 1] - sorted[0];
      return Math.max(1, Math.ceil(range / h));
    }

    function calculateBinsSqrt(n) {
      return Math.max(1, Math.ceil(Math.sqrt(n)));
    }

    function calculateBinsRice(n) {
      return Math.max(1, Math.ceil(2 * Math.pow(n, 1/3)));
    }

    function updateBinningMethod() {
      const method = document.getElementById('binningMethod').value;
      const numBinsInput = document.getElementById('numBins');
      const binsValue = document.getElementById('binsValue');
      
      if (method === 'manual') {
        numBinsInput.disabled = false;
        createHistogram();
      } else {
        const data = getFilteredData();
        let calculatedBins = 5;
        
        switch(method) {
          case 'sturges':
            calculatedBins = calculateBinsSturges(data.length);
            break;
          case 'scott':
            calculatedBins = calculateBinsScott(data);
            break;
          case 'fd':
            calculatedBins = calculateBinsFD(data);
            break;
          case 'sqrt':
            calculatedBins = calculateBinsSqrt(data.length);
            break;
          case 'rice':
            calculatedBins = calculateBinsRice(data.length);
            break;
        }
        
        numBinsInput.value = calculatedBins;
        binsValue.textContent = calculatedBins;
        numBinsInput.disabled = true;
        createHistogram();
      }
    }

    // Get filtered data based on range sliders
    let originalDataMin, originalDataMax;
    let prevLeftPercent = 0;
    let prevRightPercent = 100;
    let updateTimeout = null;
    
    function getFilteredData() {
      if (!resultsData || !resultsData.rawData) return [];
      
      const leftPercent = parseFloat(document.getElementById('leftTruncation')?.value || 0);
      const rightPercent = parseFloat(document.getElementById('rightTruncation')?.value || 100);
      
      const leftValue = originalDataMin + (originalDataMax - originalDataMin) * (leftPercent / 100);
      const rightValue = originalDataMin + (originalDataMax - originalDataMin) * (rightPercent / 100);
      
      return resultsData.rawData.filter(d => d >= leftValue && d <= rightValue);
    }

    function showView(viewName) {
      // View names mapping
      const viewTitles = {
        'histogram': 'Interactive Histogram',
        'boxplot': 'Box Plot Analysis',
        'qqplot': 'Q-Q Plot Analysis',
        'normality': 'Normality Tests'
      };
      
      // Update view name in header
      document.getElementById('viewName').textContent = viewTitles[viewName] || 'Analysis';
      
      // Update active state
      document.querySelectorAll('.analysis-option').forEach(opt => opt.classList.remove('active'));
      event.target.closest('.analysis-option').classList.add('active');
      
      // Close dropdown
      document.getElementById('dropdownMenu').classList.remove('show');
      
      // Show view (for now just histogram)
      if (viewName === 'histogram') {
        displayHistogramView();
      } else {
        document.getElementById('resultsContent').innerHTML = `
          <div style="text-align: center; padding: 60px 20px; color: var(--text-muted);">
            <i class="fa-solid fa-info-circle" style="font-size: 48px; margin-bottom: 16px;"></i>
            <div>${viewTitles[viewName]} coming soon!</div>
          </div>
        `;
      }
    }

    function toggleDropdown() {
      document.getElementById('dropdownMenu').classList.toggle('show');
    }

    // Initialize range sliders
    function initializeRangeSliders() {
      if (!resultsData || !resultsData.rawData) return;
      
      originalDataMin = Math.min(...resultsData.rawData);
      originalDataMax = Math.max(...resultsData.rawData);
      
      // Update display labels
      document.getElementById('data-min-value').textContent = `Min: ${originalDataMin.toFixed(2)}`;
      document.getElementById('data-max-value').textContent = `Max: ${originalDataMax.toFixed(2)}`;
      document.getElementById('leftRangeValue').textContent = originalDataMin.toFixed(2);
      document.getElementById('rightRangeValue').textContent = originalDataMax.toFixed(2);
      document.getElementById('remainingN').textContent = resultsData.rawData.length;
      
      // Setup slider event listeners
      const leftSlider = document.getElementById('leftTruncation');
      const rightSlider = document.getElementById('rightTruncation');
      
      // Left slider event handlers (VB6 mechanism)
      if (leftSlider) {
        // Bring left slider to front while dragging; temporarily disable right slider hit-testing
        const bringLeftFront = () => {
          if (leftSlider) leftSlider.style.zIndex = '3';
          if (rightSlider) rightSlider.style.zIndex = '2';
          if (rightSlider) rightSlider.style.pointerEvents = 'none';
        };
        const releaseLeftFront = () => {
          if (rightSlider) rightSlider.style.pointerEvents = '';
          if (leftSlider) leftSlider.style.zIndex = '';
          if (rightSlider) rightSlider.style.zIndex = '';
        };
        
        leftSlider.addEventListener('mousedown', bringLeftFront);
        leftSlider.addEventListener('touchstart', bringLeftFront, { passive: true });
        window.addEventListener('mouseup', releaseLeftFront);
        window.addEventListener('touchend', releaseLeftFront, { passive: true });
        
        leftSlider.addEventListener('input', function() {
          const leftPercent = +this.value;
          const rightPercent = rightSlider ? +rightSlider.value : 100;
          
          if (leftPercent >= rightPercent - 1 && rightSlider) {
            rightSlider.value = Math.min(100, leftPercent + 1);
          }
          
          updateRangeSliders();
        });
      }
      
      // Right slider event handlers (VB6 mechanism)
      if (rightSlider) {
        // Bring right slider to front while dragging; temporarily disable left slider hit-testing
        const bringRightFront = () => {
          if (rightSlider) rightSlider.style.zIndex = '3';
          if (leftSlider) leftSlider.style.zIndex = '2';
          if (leftSlider) leftSlider.style.pointerEvents = 'none';
        };
        const releaseRightFront = () => {
          if (leftSlider) leftSlider.style.pointerEvents = '';
          if (rightSlider) rightSlider.style.zIndex = '';
          if (leftSlider) leftSlider.style.zIndex = '';
        };
        
        rightSlider.addEventListener('mousedown', bringRightFront);
        rightSlider.addEventListener('touchstart', bringRightFront, { passive: true });
        window.addEventListener('mouseup', releaseRightFront);
        window.addEventListener('touchend', releaseRightFront, { passive: true });
        
        rightSlider.addEventListener('input', function() {
          const rightPercent = +this.value;
          const leftPercent = leftSlider ? +leftSlider.value : 0;
          
          if (rightPercent <= leftPercent + 1 && leftSlider) {
            leftSlider.value = Math.max(0, rightPercent - 1);
          }
          
          updateRangeSliders();
        });
      }
    }

    // Update range sliders and filter data
    function updateRangeSliders() {
      const leftPercent = parseFloat(document.getElementById('leftTruncation').value);
      const rightPercent = parseFloat(document.getElementById('rightTruncation').value);
      
      // Prevent sliders from crossing
      if (leftPercent >= rightPercent - 1) {
        document.getElementById('rightTruncation').value = Math.min(100, leftPercent + 1);
        return;
      }
      if (rightPercent <= leftPercent + 1) {
        document.getElementById('leftTruncation').value = Math.max(0, rightPercent - 1);
        return;
      }
      
      // Calculate actual values
      const leftValue = originalDataMin + (originalDataMax - originalDataMin) * (leftPercent / 100);
      const rightValue = originalDataMin + (originalDataMax - originalDataMin) * (rightPercent / 100);
      
      // Check filtered data count BEFORE updating (use 5% of total or minimum 5)
      const filteredData = resultsData.rawData.filter(d => d >= leftValue && d <= rightValue);
      const minRequired = Math.max(5, Math.ceil(resultsData.rawData.length * 0.05));
      
      if (filteredData.length < minRequired) {
        // Revert to previous valid positions
        document.getElementById('leftTruncation').value = prevLeftPercent;
        document.getElementById('rightTruncation').value = prevRightPercent;
        
        // Show warning in UI (not alert - not supported in Office dialogs)
        const remainingNEl = document.getElementById('remainingN');
        if (remainingNEl) {
          remainingNEl.textContent = `min ${minRequired}`;
          remainingNEl.style.color = '#dc2626';
          setTimeout(() => {
            remainingNEl.style.color = '';
            remainingNEl.textContent = filteredData.length;
          }, 1500);
        }
        return;
      }
      
      // Update previous positions (valid state)
      prevLeftPercent = leftPercent;
      prevRightPercent = rightPercent;
      
      // Update display
      document.getElementById('leftRangeValue').textContent = leftValue.toFixed(2);
      document.getElementById('rightRangeValue').textContent = rightValue.toFixed(2);
      document.getElementById('remainingN').textContent = filteredData.length;
      
      // Update active range indicator
      const activeRange = document.getElementById('activeRangeIndicator');
      if (activeRange) {
        activeRange.style.left = leftPercent + '%';
        activeRange.style.width = (rightPercent - leftPercent) + '%';
      }
      
      // Re-create histogram with filtered data
      createHistogram();
    }

    // Reset range sliders
    function resetRangeSliders() {
      document.getElementById('leftTruncation').value = 0;
      document.getElementById('rightTruncation').value = 100;
      prevLeftPercent = 0;
      prevRightPercent = 100;
      
      document.getElementById('leftRangeValue').textContent = originalDataMin.toFixed(2);
      document.getElementById('rightRangeValue').textContent = originalDataMax.toFixed(2);
      
      const activeRange = document.getElementById('activeRangeIndicator');
      if (activeRange) {
        activeRange.style.left = '0%';
        activeRange.style.width = '100%';
      }
      
      document.getElementById('remainingN').textContent = resultsData.rawData.length;
      createHistogram();
    }

    function closeDialog() {
      try {
        if (typeof Office !== 'undefined' && Office.context && Office.context.ui) {
          Office.context.ui.messageParent('close');
        }
      } catch (e) {
        console.log('Could not message parent:', e);
      }
      window.close();
    }

    // Close dropdown when clicking outside
    document.addEventListener('click', (e) => {
      const dropdown = document.getElementById('dropdownMenu');
      if (dropdown && !e.target.closest('.dropdown-btn') && !e.target.closest('.dropdown-content')) {
        dropdown.classList.remove('show');
      }
    });
  </script>

  <!-- Floating Close Button -->
  <button class="close-btn-floating" onclick="closeDialog()" title="Close Dialog">
    <i class="fa-solid fa-times"></i>
  </button>
</body>
</html>
