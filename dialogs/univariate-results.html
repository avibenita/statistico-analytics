<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Univariate Analysis Results</title>
  
  <!-- Office.js -->
  <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
  
  <!-- Font Awesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet" />
  
  <!-- Highcharts for Histogram -->
  <script src="https://code.highcharts.com/highcharts.js"></script>
  <script src="https://code.highcharts.com/modules/histogram-bellcurve.js"></script>
  
  <style>
    :root {
      --surface-0: #ffffff;
      --surface-1: #f8f9fa;
      --surface-2: #f1f3f5;
      --border: #e9ecef;
      --accent-1: #f97316;
      --accent-2: #3b82f6;
      --text-primary: #1e293b;
      --text-secondary: #475569;
      --text-muted: #94a3b8;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--surface-0);
      color: var(--text-primary);
      font-size: 13px;
    }

    /* Header - 3 parts layout */
    .header {
      background: var(--surface-1);
      border-bottom: 1px solid var(--border);
      padding: 16px 20px;
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      align-items: center;
      gap: 20px;
    }

    /* Part 1: Logo + Module */
    .header-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .header-logo {
      width: 36px;
      height: 36px;
      background: linear-gradient(135deg, var(--accent-1), var(--accent-2));
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 18px;
    }

    .header-module {
      display: flex;
      flex-direction: column;
    }

    .header-brand {
      font-size: 11px;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .header-module-name {
      font-size: 15px;
      font-weight: 700;
      color: var(--text-primary);
    }

    /* Part 2: Center - View Name + Variable */
    .header-center {
      text-align: center;
    }

    .header-view-name {
      font-size: 18px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 4px;
    }

    .header-variable {
      font-size: 14px;
      font-style: italic;
      color: var(--text-secondary);
    }

    /* Part 3: Right - Dropdown */
    .header-right {
      display: flex;
      justify-content: flex-end;
      align-items: center;
      gap: 12px;
    }

    .dropdown-btn {
      padding: 8px 16px;
      background: var(--surface-0);
      border: 1.5px solid var(--border);
      border-radius: 6px;
      color: var(--text-primary);
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.2s;
    }

    .dropdown-btn:hover {
      border-color: var(--accent-1);
      box-shadow: 0 2px 4px rgba(249, 115, 22, 0.1);
    }

    .dropdown-content {
      position: absolute;
      top: calc(100% + 8px);
      right: 0;
      background: var(--surface-0);
      border: 1.5px solid var(--border);
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      min-width: 250px;
      display: none;
      z-index: 1000;
    }

    .dropdown-content.show { display: block; }

    .analysis-option {
      padding: 12px 16px;
      cursor: pointer;
      transition: background 0.2s;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .analysis-option:hover {
      background: var(--surface-1);
    }

    .analysis-option.active {
      background: var(--surface-1);
      color: var(--accent-1);
      font-weight: 600;
    }

    .close-btn {
      padding: 8px 16px;
      background: var(--surface-0);
      border: 1.5px solid var(--border);
      border-radius: 6px;
      color: var(--text-secondary);
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      transition: all 0.2s;
    }

    .close-btn:hover {
      border-color: #dc2626;
      color: #dc2626;
    }

    /* Content */
    .content {
      padding: 20px;
      max-width: 1200px;
      margin: 0 auto;
    }

    /* Statistics Panel */
    .stats-panel {
      background: var(--surface-0);
      border: 1.5px solid var(--border);
      border-radius: 8px;
      margin-bottom: 20px;
      overflow: hidden;
    }

    .panel-heading {
      background: var(--surface-1);
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: 600;
      font-size: 15px;
    }

    .stats-table {
      width: 100%;
      border-collapse: collapse;
    }

    .stats-table th {
      background: var(--surface-1);
      padding: 10px;
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
      border-bottom: 1px solid var(--border);
    }

    .stats-table th.highlight {
      background: rgba(249, 115, 22, 0.1);
      color: var(--accent-1);
      font-weight: 700;
    }

    .stats-table td {
      padding: 12px;
      text-align: center;
      font-size: 13px;
      border-bottom: 1px solid var(--border);
    }

    .stats-table td.highlight {
      background: rgba(249, 115, 22, 0.05);
      color: var(--accent-1);
      font-weight: 700;
      font-size: 15px;
    }

    .stats-table tr:last-child td {
      border-bottom: none;
    }

    /* Histogram Panel */
    .histogram-panel {
      background: var(--surface-0);
      border: 1.5px solid var(--border);
      border-radius: 8px;
      overflow: hidden;
    }

    .histogram-controls {
      padding: 12px 16px;
      background: var(--surface-1);
      border-bottom: 1px solid var(--border);
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
      align-items: center;
      font-size: 12px;
    }

    .control-group {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .control-group label {
      font-weight: 600;
      color: var(--text-secondary);
    }

    .control-group select {
      padding: 6px 10px;
      border: 1px solid var(--border);
      border-radius: 4px;
      font-size: 12px;
      background: var(--surface-0);
    }

    .control-group input[type="range"] {
      width: 100px;
    }

    .control-group input[type="checkbox"] {
      width: 16px;
      height: 16px;
      accent-color: var(--accent-1);
    }

    #histogram-chart {
      padding: 16px;
      min-height: 400px;
    }

    /* Loading */
    .loading {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-muted);
    }

    .spinner {
      border: 3px solid var(--border);
      border-top: 3px solid var(--accent-1);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 0.8s linear infinite;
      margin: 0 auto 16px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Floating Close Button */
    .close-btn-floating {
      position: fixed;
      bottom: 24px;
      right: 24px;
      width: 54px;
      height: 54px;
      background: #dc2626;
      color: white;
      border: none;
      border-radius: 50%;
      font-size: 22px;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .close-btn-floating:hover {
      background: #b91c1c;
      box-shadow: 0 6px 16px rgba(220, 38, 38, 0.4);
      transform: scale(1.08);
    }

    .close-btn-floating:active {
      transform: scale(0.95);
    }
  </style>
</head>
<body>
  <!-- Header - 3 Parts -->
  <div class="header">
    <!-- Part 1: Logo + Module Name -->
    <div class="header-left">
      <div class="header-logo">
        <i class="fa-solid fa-chart-line"></i>
      </div>
      <div class="header-module">
        <div class="header-brand">Statistico Analytics</div>
        <div class="header-module-name">Univariate Analysis</div>
      </div>
    </div>

    <!-- Part 2: Center - View Name + Variable -->
    <div class="header-center">
      <div class="header-view-name" id="viewName">Interactive Histogram</div>
      <div class="header-variable">
        <span id="variableName">Variable</span> <span id="sampleSize">(n=--)</span>
      </div>
    </div>

    <!-- Part 3: Right - Dropdown -->
    <div class="header-right">
      <div style="position: relative;">
        <button class="dropdown-btn" onclick="toggleDropdown()">
          <i class="fa-solid fa-bars"></i>
          Advanced Results
          <i class="fa-solid fa-chevron-down"></i>
        </button>
        <div class="dropdown-content" id="dropdownMenu">
          <div class="analysis-option active" onclick="showView('histogram')">
            <i class="fa-solid fa-chart-column"></i>
            Histogram & Stats
          </div>
          <div class="analysis-option" onclick="showView('boxplot')">
            <i class="fa-solid fa-box"></i>
            Box Plot
          </div>
          <div class="analysis-option" onclick="showView('qqplot')">
            <i class="fa-solid fa-chart-scatter"></i>
            Q-Q Plot
          </div>
          <div class="analysis-option" onclick="showView('normality')">
            <i class="fa-solid fa-vial"></i>
            Normality Tests
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Content -->
  <div class="content" id="resultsContent">
    <div class="loading">
      <div class="spinner"></div>
      <div>Loading results...</div>
    </div>
  </div>

  <script>
    let resultsData = null;
    let histogramChart = null;
    let currentData = [];

    // Load results when page is ready
    if (typeof Office !== 'undefined') {
      Office.onReady(() => {
        loadResults();
      });
    } else {
      // Fallback if Office.js not available
      window.addEventListener('DOMContentLoaded', () => {
        loadResults();
      });
    }

    function loadResults() {
      const dataJSON = localStorage.getItem('univariateResults');
      if (dataJSON) {
        resultsData = JSON.parse(dataJSON);
        displayHistogramView();
      } else {
        document.getElementById('resultsContent').innerHTML = `
          <div class="loading">
            <i class="fa-solid fa-exclamation-triangle" style="font-size: 40px; color: #dc2626; margin-bottom: 16px;"></i>
            <div style="color: #dc2626;">No results data found</div>
          </div>
        `;
      }
    }

    function displayHistogramView() {
      const { descriptive, n, column, dataSource } = resultsData;
      
      // Update header with variable info
      document.getElementById('variableName').textContent = column || 'Variable';
      document.getElementById('sampleSize').textContent = `(n=${n})`;
      
      document.getElementById('resultsContent').innerHTML = `
        <!-- Statistics Panel -->
        <div class="stats-panel">
          <div class="panel-heading">
            <span>Descriptive Statistics</span>
            <span style="font-size: 12px; color: var(--text-muted);">n = ${n}</span>
          </div>
          <div style="padding: 12px;">
            <!-- Table 1: Central Tendency -->
            <table class="stats-table" style="margin-bottom: 12px;">
              <thead>
                <tr>
                  <th class="highlight">Count</th>
                  <th class="highlight">Mean</th>
                  <th class="highlight">Std Dev</th>
                  <th>Variance</th>
                  <th>Kurtosis</th>
                  <th>Skewness</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td class="highlight">${n}</td>
                  <td class="highlight">${descriptive.mean}</td>
                  <td class="highlight">${descriptive.stdDev}</td>
                  <td>${descriptive.variance}</td>
                  <td>${descriptive.kurtosis}</td>
                  <td>${descriptive.skewness}</td>
                </tr>
              </tbody>
            </table>

            <!-- Table 2: Range & Quartiles -->
            <table class="stats-table">
              <thead>
                <tr>
                  <th>Range</th>
                  <th>Minimum</th>
                  <th>Q25</th>
                  <th class="highlight">Median</th>
                  <th>Q75</th>
                  <th>Maximum</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>${descriptive.range}</td>
                  <td>${descriptive.min}</td>
                  <td>${descriptive.q1}</td>
                  <td class="highlight">${descriptive.median}</td>
                  <td>${descriptive.q3}</td>
                  <td>${descriptive.max}</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Histogram Panel -->
        <div class="histogram-panel">
          <div class="panel-heading">
            Interactive Histogram
          </div>
          <div class="histogram-controls">
            <div class="control-group">
              <label>Bins:</label>
              <input type="range" id="numBins" min="5" max="50" value="15" oninput="updateHistogram()">
              <span id="binsValue">15</span>
            </div>
            <div class="control-group">
              <label>Normal Curve:</label>
              <input type="checkbox" id="showNormalCurve" checked onchange="updateHistogram()">
            </div>
          </div>
          <div id="histogram-chart"></div>
        </div>
      `;

      // Wait for DOM to be ready before creating histogram
      setTimeout(() => {
        createHistogram();
      }, 100);
    }

    function createHistogram() {
      if (!resultsData || !resultsData.rawData) {
        console.error('No data available for histogram');
        return;
      }

      // Check if elements exist
      const numBinsEl = document.getElementById('numBins');
      const showNormalCurveEl = document.getElementById('showNormalCurve');
      const chartContainer = document.getElementById('histogram-chart');
      
      if (!numBinsEl || !showNormalCurveEl || !chartContainer) {
        console.error('Histogram elements not found in DOM');
        return;
      }

      const data = resultsData.rawData;
      const numBins = parseInt(numBinsEl.value);
      const showNormalCurve = showNormalCurveEl.checked;
      
      // Calculate statistics for normal curve
      const n = data.length;
      const mean = parseFloat(resultsData.descriptive.mean);
      const stdDev = parseFloat(resultsData.descriptive.stdDev);
      const min = Math.min(...data);
      const max = Math.max(...data);
      
      // Create bins
      const binWidth = (max - min) / numBins;
      const bins = [];
      const binCenters = [];
      
      for (let i = 0; i < numBins; i++) {
        const binStart = min + i * binWidth;
        const binEnd = binStart + binWidth;
        const binCenter = (binStart + binEnd) / 2;
        
        bins.push({
          x: binCenter,
          y: 0,
          binStart: binStart,
          binEnd: binEnd
        });
        binCenters.push(binCenter);
      }
      
      // Count data points in each bin
      data.forEach(value => {
        const binIndex = Math.min(Math.floor((value - min) / binWidth), numBins - 1);
        bins[binIndex].y++;
      });
      
      // Create series array
      const series = [{
        name: 'Frequency',
        type: 'column',
        data: bins.map(bin => ({
          x: bin.x,
          y: bin.y,
          custom: {
            range: `${bin.binStart.toFixed(2)} - ${bin.binEnd.toFixed(2)}`
          }
        })),
        color: '#3b82f6',
        pointPadding: 0,
        groupPadding: 0,
        borderWidth: 1,
        borderColor: '#2563eb'
      }];
      
      // Add normal curve if checked
      if (showNormalCurve) {
        const normalCurveData = [];
        const totalArea = n * binWidth; // Total area of histogram
        
        for (let i = 0; i <= 100; i++) {
          const x = min + (max - min) * (i / 100);
          // Normal distribution PDF
          const z = (x - mean) / stdDev;
          const pdf = (1 / (stdDev * Math.sqrt(2 * Math.PI))) * Math.exp(-0.5 * z * z);
          const y = pdf * totalArea; // Scale to match histogram
          normalCurveData.push([x, y]);
        }
        
        series.push({
          name: 'Normal Curve',
          type: 'line',
          data: normalCurveData,
          color: '#f97316',
          lineWidth: 3,
          marker: { enabled: false },
          enableMouseTracking: true
        });
      }
      
      // Create chart
      Highcharts.chart('histogram-chart', {
        chart: {
          backgroundColor: 'transparent',
          height: 400
        },
        title: { text: null },
        xAxis: {
          title: { 
            text: resultsData.column || 'Value',
            style: { color: '#475569', fontWeight: '600' }
          },
          gridLineWidth: 1,
          gridLineColor: '#e9ecef'
        },
        yAxis: {
          title: { 
            text: 'Frequency',
            style: { color: '#475569', fontWeight: '600' }
          },
          gridLineColor: '#e9ecef'
        },
        legend: {
          enabled: showNormalCurve,
          align: 'right',
          verticalAlign: 'top',
          itemStyle: { color: '#475569' }
        },
        tooltip: {
          shared: false,
          useHTML: true,
          backgroundColor: '#ffffff',
          borderColor: '#e9ecef',
          formatter: function() {
            if (this.series.name === 'Frequency') {
              return `<div style="padding: 8px;">
                <strong>Range:</strong> ${this.point.custom.range}<br/>
                <strong>Frequency:</strong> ${this.y}
              </div>`;
            } else {
              return `<div style="padding: 8px;">
                <strong>Value:</strong> ${this.x.toFixed(2)}<br/>
                <strong>Density:</strong> ${this.y.toFixed(4)}
              </div>`;
            }
          }
        },
        plotOptions: {
          column: {
            pointPadding: 0,
            groupPadding: 0,
            borderWidth: 1
          }
        },
        series: series,
        credits: { enabled: false }
      });
    }

    function updateHistogram() {
      const bins = document.getElementById('numBins').value;
      document.getElementById('binsValue').textContent = bins;
      createHistogram();
    }

    function showView(viewName) {
      // View names mapping
      const viewTitles = {
        'histogram': 'Interactive Histogram',
        'boxplot': 'Box Plot Analysis',
        'qqplot': 'Q-Q Plot Analysis',
        'normality': 'Normality Tests'
      };
      
      // Update view name in header
      document.getElementById('viewName').textContent = viewTitles[viewName] || 'Analysis';
      
      // Update active state
      document.querySelectorAll('.analysis-option').forEach(opt => opt.classList.remove('active'));
      event.target.closest('.analysis-option').classList.add('active');
      
      // Close dropdown
      document.getElementById('dropdownMenu').classList.remove('show');
      
      // Show view (for now just histogram)
      if (viewName === 'histogram') {
        displayHistogramView();
      } else {
        document.getElementById('resultsContent').innerHTML = `
          <div style="text-align: center; padding: 60px 20px; color: var(--text-muted);">
            <i class="fa-solid fa-info-circle" style="font-size: 48px; margin-bottom: 16px;"></i>
            <div>${viewTitles[viewName]} coming soon!</div>
          </div>
        `;
      }
    }

    function toggleDropdown() {
      document.getElementById('dropdownMenu').classList.toggle('show');
    }

    function closeDialog() {
      try {
        if (typeof Office !== 'undefined' && Office.context && Office.context.ui) {
          Office.context.ui.messageParent('close');
        }
      } catch (e) {
        console.log('Could not message parent:', e);
      }
      window.close();
    }

    // Close dropdown when clicking outside
    document.addEventListener('click', (e) => {
      const dropdown = document.getElementById('dropdownMenu');
      if (dropdown && !e.target.closest('.dropdown-btn') && !e.target.closest('.dropdown-content')) {
        dropdown.classList.remove('show');
      }
    });
  </script>

  <!-- Floating Close Button -->
  <button class="close-btn-floating" onclick="closeDialog()" title="Close Dialog">
    <i class="fa-solid fa-times"></i>
  </button>
</body>
</html>
