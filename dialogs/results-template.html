<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Analysis Results</title>
  
  <!-- Office.js for dialog communication -->
  <script type="text/javascript" src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
  
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"/>
  
  <!-- Shared CSS -->
  <link rel="stylesheet" href="../src/shared/css/main.css" />
  <link rel="stylesheet" href="../src/shared/css/results-popup.css" />
  
  <style>
    /* Dialog-specific styles */
    body {
      margin: 0;
      padding: 0;
      overflow: auto;
    }

    .dialog-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    .dialog-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px;
      background: var(--surface-0);
      border-bottom: 1px solid var(--border);
      margin: -20px -20px 20px;
    }

    .dialog-title {
      font-size: 24px;
      font-weight: 600;
      color: var(--accent-1);
      margin: 0;
    }

    .dialog-actions {
      display: flex;
      gap: 12px;
    }

    .dialog-actions .btn {
      padding: 10px 20px;
      font-size: 14px;
    }

    .loading-state {
      text-align: center;
      padding: 60px 20px;
    }

    .loading-state i {
      font-size: 48px;
      color: var(--accent-1);
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="dialog-container">
    <div class="dialog-header">
      <h1 class="dialog-title" id="dialogTitle">Analysis Results</h1>
      <div class="dialog-actions">
        <button class="btn btn-primary" onclick="exportToExcel()">
          <i class="fa fa-file-excel"></i>
          Export to Excel
        </button>
        <button class="btn" onclick="closeDialog()">
          <i class="fa fa-times"></i>
          Close
        </button>
      </div>
    </div>

    <div id="resultsContent">
      <div class="loading-state">
        <i class="fa fa-spinner"></i>
        <p style="margin-top: 16px; color: var(--text-muted);">Loading results...</p>
      </div>
    </div>
  </div>

  <script type="module">
    let currentResults = null;

    // Initialize dialog when Office.js is ready
    Office.onReady(() => {
      console.log('‚úÖ Dialog Office.js ready');
      
      // Notify parent that dialog is ready
      notifyParent('DIALOG_READY');
      
      // Load results from sessionStorage
      loadResults();
    });

    function loadResults() {
      try {
        // Get results from sessionStorage (set by parent taskpane)
        const resultsJSON = sessionStorage.getItem('analysisResults');
        
        if (!resultsJSON) {
          showError('No results data available');
          return;
        }

        const data = JSON.parse(resultsJSON);
        currentResults = data.results;
        
        // Update title
        document.getElementById('dialogTitle').textContent = 
          `${data.moduleName} Results`;
        
        // Display results
        displayResults(data);
        
        console.log('‚úÖ Results loaded successfully');
      } catch (error) {
        console.error('‚ùå Error loading results:', error);
        showError('Error loading results: ' + error.message);
      }
    }

    function displayResults(data) {
      const container = document.getElementById('resultsContent');
      
      // Build results HTML
      let html = '<div class="results-container">';
      
      // Summary section
      html += buildSummarySection(data);
      
      // Main results section
      html += buildMainResults(data.results);
      
      html += '</div>';
      
      container.innerHTML = html;
    }

    function buildSummarySection(data) {
      return `
        <div class="results-section">
          <div class="results-section-title">
            <i class="fa fa-info-circle"></i>
            Analysis Summary
          </div>
          <div class="table-wrap">
            <table>
              <tr>
                <td><strong>Module:</strong></td>
                <td>${data.moduleName}</td>
              </tr>
              <tr>
                <td><strong>Timestamp:</strong></td>
                <td>${new Date(data.timestamp).toLocaleString()}</td>
              </tr>
              <tr>
                <td><strong>Decimal Places:</strong></td>
                <td>${data.decimalPlaces}</td>
              </tr>
            </table>
          </div>
        </div>
      `;
    }

    function buildMainResults(results) {
      // This is a template - override in specific result pages
      return `
        <div class="results-section">
          <div class="results-section-title">
            <i class="fa fa-chart-bar"></i>
            Results
          </div>
          <pre style="background: var(--surface-2); padding: 20px; border-radius: 8px; overflow: auto;">
${JSON.stringify(results, null, 2)}
          </pre>
        </div>
      `;
    }

    function showError(message) {
      const container = document.getElementById('resultsContent');
      container.innerHTML = `
        <div class="message error">
          <i class="fa fa-exclamation-circle"></i>
          <span>${message}</span>
        </div>
      `;
    }

    function exportToExcel() {
      console.log('üìä Export to Excel requested');
      
      // Send message to parent taskpane
      notifyParent('EXPORT_TO_EXCEL', currentResults);
      
      // Show confirmation
      alert('Results will be exported to a new Excel worksheet');
    }

    function closeDialog() {
      console.log('‚ùå Close dialog requested');
      notifyParent('CLOSE_DIALOG');
      
      // Close dialog using Office.js
      if (Office && Office.context && Office.context.ui) {
        Office.context.ui.messageParent(JSON.stringify({
          type: 'CLOSE_DIALOG'
        }));
      }
    }

    function notifyParent(messageType, data = null) {
      try {
        const message = {
          type: messageType,
          data: data,
          timestamp: new Date().toISOString()
        };
        
        // Send message to parent taskpane
        if (Office && Office.context && Office.context.ui) {
          Office.context.ui.messageParent(JSON.stringify(message));
        }
      } catch (error) {
        console.error('‚ùå Error sending message to parent:', error);
      }
    }

    // Make functions available globally
    window.exportToExcel = exportToExcel;
    window.closeDialog = closeDialog;
  </script>
</body>
</html>
